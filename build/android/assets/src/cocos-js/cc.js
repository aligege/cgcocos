System.register([],(function(e,t){"use strict";return{execute:function(){e({BitMask:Ne,CCClass:wt,CacheMode:void 0,DebugMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:Le,Eventify:Ht,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:zS,WorldNode3DToWorldNodeUI:FS,absMax:Ii,absMaxComponent:Ri,approx:pi,assert:f,assertID:A,bezier:hp,bezierByTime:gp,ccenum:Fe,clamp:di,clamp01:fi,color:Ni,computeRatioByType:qM,createDefaultPipeline:kC,debug:m,deserialize:vu,earcut:UY,enumerableProps:Mi,equals:_i,error:d,errorID:C,find:JE,fragmentText:Gk,getBaselineOffset:function(){return 0},getError:R,getPathFromRoot:function(e,t){let i=e,n="";for(;null!==i&&i!==t;)n=`${i.name}/${n}`,i=i.parent;return n.slice(0,-1)},getSerializationMetadata:function(e){return e[$c]},getWorldTransformUntilRoot:uN,instantiate:Eu,inverseLerp:Pi,isCustomTargetModifier:TN,isDisplayStats:I,isElementModifier:bN,isPropertyModifier:SN,isUnicodeCJK:Bk,isUnicodeSpace:zk,isValid:Nt,lerp:mi,log:_,logID:S,markAsWarning:void 0,mat4:tn,murmurhash2_32_gc:Vr,nextPow2:Ci,pingPong:Ai,pseudoRandom:bi,pseudoRandomRange:Ti,pseudoRandomRangeInt:Ei,quat:$i,randomRange:xi,randomRangeInt:Si,rect:pn,removeProperty:void 0,repeat:wi,replaceProperty:void 0,safeMeasureText:Fk,sampleAnimationCurve:WM,setDefaultLogTimes:function(e){e>0&&(ri=e)},setDisplayStats:M,size:un,toDegree:vi,toRadian:gi,tween:Sve,tweenUtil:bve,v2:rn,v3:Gi,v4:cn,warn:p,warnID:T});const i="undefined"==typeof window?global:window,n=e("cclegacy",{_global:i});n.internal={},i.CC_BUILD=!0,i.CC_TEST=!1,i.CC_EDITOR=false,i.CC_PREVIEW=!1,i.CC_DEV=!1,i.CC_DEBUG=!1,i.CC_JSB=!0,i.CC_BYTEDANCE=!1,i.CC_WECHAT=!1,i.CC_ALIPAY=!1,i.CC_XIAOMI=!1,i.CC_BAIDU=!1,i.CC_COCOSPLAY=!1,i.CC_HUAWEI=!1,i.CC_OPPO=!1,i.CC_VIVO=!1,i.CC_MINIGAME=!1,i.CC_RUNTIME_BASED=!1,i.CC_SUPPORT_JIT=!0;const s=e("VERSION","3.3.2");i.CocosEngine=n.ENGINE_VERSION=s,i.cc=n;let o=null,r=console.log.bind(console),a=r,c=r,l=(e,t,...i)=>{e||console.log(`ASSERT: ${u(t,...i)}`)},h=r;function u(e,...t){return n.js.formatStr.apply(null,[e].concat(t))}function _(e,...t){return r(e,...t)}function p(e,...t){return a(e,...t)}function d(e,...t){return c(e,...t)}function f(e,t,...i){return l(e,t,...i)}function m(...e){return h(...e)}function g(e){if(r=a=c=l=h=()=>{},e!==P.NONE){if(e>P.ERROR){const t=e=>{if(n.game.canvas){if(!o){const e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",n.game.canvas.height);const t=e.style;t.zIndex="99999",t.position="absolute",t.top=t.left="0",o=document.createElement("textarea"),o.setAttribute("rows","20"),o.setAttribute("cols","30"),o.setAttribute("disabled","true");const i=o.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",e.appendChild(o),n.game.canvas.parentNode.appendChild(e)}o.value=`${o.value+e}\r\n`,o.scrollTop=o.scrollHeight}};c=(e,...i)=>{t(`ERROR :  ${u(e,...i)}`)},l=(e,i,...n)=>{e||t(`ASSERT: ${u(i,...n)}`)},e!==P.ERROR_FOR_WEB_PAGE&&(a=(e,...i)=>{t(`WARN :  ${u(e,...i)}`)}),e===P.INFO_FOR_WEB_PAGE&&(r=(e,...i)=>{t(u(e,...i))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),c=console.error.bind?console.error.bind(console):console.error,l=(e,t,...i)=>{if(!e){const e=u(t,...i);throw new Error(e)}});if(e!==P.ERROR&&(a=console.warn.bind?console.warn.bind(console):console.warn),e===P.INFO&&(r="JavaScriptCore"===scriptEngineType?(e,...t)=>console.log.apply(console,[e,...t]):console.log),e<=P.VERBOSE&&"function"==typeof console.debug){const e=console.debug.bind(console);h=(...t)=>e(...t)}}}function v(e){{const t=e.stack;return void d(t?`${e}\n${t}`:e)}}function y(e){return(t,...i)=>{const n=`${e} ${t}, please go to https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md#${t} to see details.`;return 0===i.length?n:`${n} Arguments: ${i.join(", ")}`}}const x=y("Log");function S(e,...t){_(x(e,...t))}const b=y("Warning");function T(e,...t){p(b(e,...t))}const E=y("Error");function C(e,...t){d(E(e,...t))}const w=y("Assert");function A(e,t,...i){e||f(!1,w(t,...i))}let P;function R(e,...t){return E(e,...t)}function I(){return!!n.profiler&&n.profiler.isShowingStats()}function M(e){n.profiler&&(e?n.profiler.showStats():n.profiler.hideStats(),n.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(P||(P=e("DebugMode",{})));var O=Object.freeze({__proto__:null,log:_,warn:p,error:d,assert:f,debug:m,_resetDebugSetting:g,_throw:v,logID:S,warnID:T,errorID:C,assertID:A,get DebugMode(){return P},getError:R,isDisplayStats:I,setDisplayStats:M});let D,N,L,B,z;!function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(D||(D={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(N||(N={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(L||(L={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(B||(B={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(z||(z={}));class F{constructor(e,t){this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=e,this._elementsPerBatch=Math.max(t,1),this._nextAvail=this._elementsPerBatch-1;for(let t=0;t<this._elementsPerBatch;++t)this._freepool.push(e())}alloc(){if(this._nextAvail<0){const e=this._elementsPerBatch;for(let t=0;t<e;t++)this._freepool.push(this._ctor());this._nextAvail=e-1}const e=this._freepool[this._nextAvail--];return this._freepool.length--,e}free(e){this._freepool.push(e),this._nextAvail++}freeArray(e){Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length}destroy(e){if(e)for(let t=0;t<=this._nextAvail;t++)e(this._freepool[t]);this._freepool.length=0,this._nextAvail=-1}}e("Pool",F);class U{constructor(e,t){this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(let i=0;i<t;++i)this._data[i]=e()}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(e){if(e>this._data.length)for(let t=this._data.length;t<e;++t)this._data[t]=this._fn()}add(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}removeAt(e){if(e>=this._count)return;const t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}e("RecyclePool",U);class G{constructor(e,t){this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(e),this.length=0,this._compareFn=void 0!==t?t:(e,t)=>e-t}push(e){this.array[this.length++]=e}pop(){return this.array[--this.length]}get(e){return this.array[e]}clear(){this.length=0}destroy(){this.length=0,this.array.length=0}sort(){this.array.length=this.length,this.array.sort(this._compareFn)}concat(e){for(let t=0;t<e.length;++t)this.array[this.length++]=e[t]}fastRemove(e){if(e>=this.length||e<0)return;const t=--this.length;this.array[e]=this.array[t]}indexOf(e){return this.array.indexOf(e)}}e("CachedArray",G),e("memop",Object.freeze({__proto__:null,Pool:F,RecyclePool:U,CachedArray:G}));class k{constructor(e){this.i=0,this.array=e}get length(){return this.array.length}set length(e){this.array.length=e,this.i>=e&&(this.i=e-1)}remove(e){const t=this.array.indexOf(e);t>=0&&this.removeAt(t)}removeAt(e){this.array.splice(e,1),e<=this.i&&--this.i}fastRemove(e){const t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)}fastRemoveAt(e){const t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}push(e){this.array.push(e)}}function H(e,t){e.splice(t,1)}function V(e,t){const i=e.length;t<0||t>=i||(e[t]=e[i-1],e.length=i-1)}function j(e,t){const i=e.indexOf(t);return i>=0&&(H(e,i),!0)}function W(e,t){return e.indexOf(t)>=0}var q=Object.freeze({__proto__:null,removeAt:H,fastRemoveAt:V,remove:j,fastRemove:function(e,t){const i=e.indexOf(t);i>=0&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){const i=e.findIndex(t);if(i>=0){const t=e[i];return H(e,i),t}},verifyType:function(e,t){if(e&&e.length>0)for(const i of e)if(!(i instanceof t))return S(1300),!1;return!0},removeArray:function(e,t){for(let i=0,n=t.length;i<n;i++)j(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0,...t]),e},contains:W,copy:function(e){const t=e.length,i=new Array(t);for(let n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:k});class X{constructor(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}getNewId(){return this.prefix+ ++this.id}}X.global=new X("global");const Y=new X("TmpCId."),K="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),$="__cid__";function Q(e){return"number"==typeof e||e instanceof Number}function Z(e){return"string"==typeof e||e instanceof String}function J(e){for(const t in e)return!1;return!0}const ee=(()=>{const e={value:void 0,enumerable:!1,writable:!1,configurable:!0};return(t,i,n,s,o)=>{e.value=n,e.writable=s,e.enumerable=o,Object.defineProperty(t,i,e),e.value=void 0}})(),te=(()=>{const e={get:void 0,set:void 0,enumerable:!1};return(t,i,n,s,o=!1,r=!1)=>{"boolean"==typeof s&&(o=s,s=void 0),e.get=n,e.set=s,e.enumerable=o,e.configurable=r,Object.defineProperty(t,i,e),e.get=void 0,e.set=void 0}})(),ie=(()=>{const e={get:void 0,enumerable:!1,configurable:!1};return(t,i,n,s,o)=>{e.get=n,e.enumerable=s,e.configurable=o,Object.defineProperty(t,i,e),e.get=void 0}})(),ne=(()=>{const e={set:void 0,enumerable:!1,configurable:!1};return(t,i,n,s,o)=>{e.set=n,e.enumerable=s,e.configurable=o,Object.defineProperty(t,i,e),e.set=void 0}})();function se(e){const t=Object.create(null);if(e){const e=".",i="/";t[e]=1,t[i]=1,delete t[e],delete t[i]}return t}function oe(e){if("function"==typeof e){const t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;let i="";if(e.name&&(i=e.name),e.toString){let t;const n=e.toString();t="["===n.charAt(0)?n.match(/\[\w+\s*(\w+)\]/):n.match(/function\s*(\w+)/),t&&2===t.length&&(i=t[1])}return"Object"!==i?i:""}return e&&e.constructor?oe(e.constructor):""}function re(e,t,i,n){const s=/([^.]+)$/,o=s.exec(t)[0],r=s.exec(i)[0];function a(){return this[r]}n?te(e,o,a,(function(e){this[r]=e})):ie(e,o,a)}function ae(e,t,i,n){for(const s in i)re(e,`${t}.${s}`,i[s],n)}const ce=/(%d)|(%s)/,le=/%s/;function he(e,...t){if(0===arguments.length)return"";if(0===t.length)return`${e}`;const i="string"==typeof e&&ce.test(e);if(i)for(const i of t){const t="number"==typeof i?ce:le;if(t.test(e)){const n=`${i}`;e=e.replace(t,n)}else e+=` ${i}`}else for(const i of t)e+=` ${i}`;return e}function ue(){const e=arguments.length-1,t=new Array(e);for(let i=0;i<e;++i)t[i]=arguments[i+1];return t}function _e(e,t){for(;e;){const i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function pe(e,t,i){const n=_e(t,e);n&&Object.defineProperty(i,e,n)}function de(e,...t){e=e||{};for(const i of t)if(i){if("object"!=typeof i){C(5402,i);continue}for(const t in i)t in e||pe(t,i,e)}return e}function fe(e,...t){e=e||{};for(const i of t)if(i){if("object"!=typeof i){C(5403,i);continue}for(const t in i)pe(t,i,e)}return e}function me(e,t){for(const i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function ge(e){const t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function ve(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=ge(e)))return!1;if(e===t)return!0}}return!1}function ye(e){for(const t of Object.keys(e))delete e[t]}const xe=se(!0),Se=se(!0);function be(e,t){return function(i,n){if(n.prototype.hasOwnProperty(e)&&delete t[n.prototype[e]],ee(n.prototype,e,i),i){const s=t[i];s&&s!==n?d(`A Class already exists with the same ${e} : "${i}".`):t[i]=n}}}const Te=be("__cid__",xe),Ee=be("__classname__",Se);function Ce(e,t){if(Ee(e,t),!t.prototype.hasOwnProperty($)){const i=e||Y.getNewId();i&&Te(i,t)}}function we(e,t){const i=Se[t],n=xe[t];let s=!0;if(i&&i!==e&&(d(`"${t}" has already been set as name or alias of another class.`),s=!1),n&&n!==e&&(d(`"${t}" has already been set as id or alias of another class.`),s=!1),s){let i=e[K];i||(i=[],e[K]=i),i.push(t),Se[t]=e,xe[t]=e}}function Ae(...e){for(const t of e){const e=t.prototype,i=e.__cid__;i&&delete xe[i];const n=e.__classname__;n&&delete Se[n];const s=e[K];if(s)for(let e=0;e<s.length;++e){const t=s[e];delete Se[t],delete xe[t]}}}function Pe(e){return xe[e]}function Re(e){return Se[e]}function Ie(e,t){let i;if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty($))return i=e.prototype.__cid__,i;if(e&&e.constructor){const t=e.constructor.prototype;if(t&&t.hasOwnProperty($))return i=e.__cid__,i}return""}class Me{get(){return this._get()}constructor(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;const i=void 0===t?e:t,n=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=n}_get(){if(this.count>0){--this.count;const e=this._pool[this.count];return this._pool[this.count]=null,e}return null}put(e){const t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}resize(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))}}const Oe=q,De={IDGenerator:X,Pool:Me,array:q,isNumber:Q,isString:Z,isEmptyObject:J,getPropertyDescriptor:_e,addon:de,mixin:fe,extend:me,getSuper:ge,isChildClassOf:ve,clear:ye,value:ee,getset:te,get:ie,set:ne,unregisterClass:Ae,getClassName:oe,setClassName:Ce,setClassAlias:we,getClassByName:Re,get _registeredClassNames(){return{...Se}},set _registeredClassNames(e){ye(Se),Object.assign(Se,e)},get _registeredClassIds(){return{...xe}},set _registeredClassIds(e){ye(xe),Object.assign(xe,e)},_getClassId:Ie,_setClassId:Te,_getClassById:Pe,obsolete:re,obsoletes:ae,formatStr:he,shiftArguments:ue,createMap:se};function Ne(e){if("__bitmask__"in e)return e;ee(e,"__bitmask__",null,!0);let t=-1;const i=Object.keys(e);for(let n=0;n<i.length;n++){const s=i[n];let o=e[s];if(-1===o)o=++t,e[s]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(s)))continue;const r=`${o}`;s!==r&&ee(e,r,s)}return e}function Le(e){return"__enums__"in e?e:(ee(e,"__enums__",null,!0),Le.update(e))}function Be(e){e.hasOwnProperty("__enums__")}function ze(e){Be(e);const t=e.__enums__||[];t.length=0;for(const i in e){const n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(((e,t)=>e.value-t.value)),e.__enums__=t,t}function Fe(e){"__enums__"in e||ee(e,"__enums__",null,!0)}n.js=De,e("js",Object.freeze({__proto__:null,array:Oe,js:De,IDGenerator:X,Pool:Me,isNumber:Q,isString:Z,isEmptyObject:J,value:ee,getset:te,get:ie,set:ne,createMap:se,getClassName:oe,obsolete:re,obsoletes:ae,formatStr:he,shiftArguments:ue,getPropertyDescriptor:_e,addon:de,mixin:fe,extend:me,getSuper:ge,isChildClassOf:ve,clear:ye,_idToClass:xe,_nameToClass:Se,_setClassId:Te,setClassName:Ce,setClassAlias:we,unregisterClass:Ae,_getClassById:Pe,getClassByName:Re,_getClassId:Ie})),Ne.isBitMask=e=>e&&e.hasOwnProperty("__bitmask__"),Ne.getList=e=>{if(e.__bitmask__)return e.__bitmask__;const t=e.__bitmask__=[];for(const i in e){const n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(((e,t)=>e.value-t.value)),t},n.BitMask=Ne,Le.update=e=>{let t=-1;const i=Object.keys(e);for(let n=0;n<i.length;n++){const s=i[n];let o=e[s];if(-1===o)o=++t,e[s]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(s)))continue;const r=`${o}`;s!==r&&ee(e,r,s)}return Array.isArray(e.__enums__)&&ze(e),e},Le||(Le=e("Enum",{})),Le.isEnum=e=>e&&e.hasOwnProperty("__enums__"),Le.getList=e=>(Be(e),e.__enums__?e.__enums__:ze(e)),n.Enum=Le;class Ue{clone(){return C(100,`${oe(this)}.clone`),this}equals(e){return!1}set(e){C(100,`${oe(this)}.set`)}toString(){return`${{}}`}}e("ValueType",Ue),Ce("cc.ValueType",Ue),n.ValueType=Ue;const Ge=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});n.macro=Ge;const ke=/^(?:cc|dragonBones|sp|ccsg)\..+/,He=new Array(123);for(let e=0;e<123;++e)He[e]=64;for(let e=0;e<64;++e)He["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(e)]=e;const Ve=He;function je(e,t,i){function n(e,t,i,n){const s=Object.getOwnPropertyDescriptor(e,t);if(s)s.get&&(e[i]=s.get),s.set&&n&&(e[n]=s.set);else{const s=e[i];te(e,t,s,e[n])}}let s;const o=e.prototype;for(let e=0;e<t.length;e++){s=t[e];const i=s[0].toUpperCase()+s.slice(1);n(o,s,`get${i}`,`set${i}`)}for(s in i){const e=i[s];n(o,s,e[0],e[1])}}function We(e,t,i,n){const s=e[t];s?Array.isArray(s)?n?(s.push(s[0]),s[0]=i):s.push(i):e[t]=n?[i,s]:[s,i]:e[t]=i}function qe(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));{let i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}}function Xe(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function Ye(e,t,i){e&&setTimeout((()=>{e(t,i)}),0)}function Ke(e){return!(!e||e.constructor!==Object)&&J(e)}function $e(e,t,i){if(t>i){const e=t;t=i,i=e}return e<t?t:e<i?e:i}function Qe(e){return e*Ge.RAD}function Ze(e){return e*Ge.DEG}n.misc={BUILTIN_CLASSID_RE:ke,BASE64_VALUES:Ve,propertyDefine:je,pushToMap:We,contains:qe,isDomNode:Xe,callInNextTick:Ye,isPlainEmptyObj_DEV:Ke,clampf:$e,degreesToRadians:Qe,radiansToDegrees:Ze},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:ke,BASE64_VALUES:Ve,propertyDefine:je,pushToMap:We,contains:qe,isDomNode:Xe,callInNextTick:Ye,tryCatchFunctor_EDITOR:function(e){return Function("target",`try {\n  target.${e}();\n}\ncatch (e) {\n  cc._throw(e);\n}`)},isPlainEmptyObj_DEV:Ke,clampf:$e,degreesToRadians:Qe,radiansToDegrees:Ze}));const Je="$_$";function et(e,t){const i=t?Object.create(t):{};return ee(e,"__attrs__",i),i}function tt(e){if("function"!=typeof e)return et(e,nt(e.constructor));let t;const i=n.Class.getInheritanceChain(e);for(let e=i.length-1;e>=0;e--){const n=i[e];n.hasOwnProperty("__attrs__")&&n.__attrs__||(t=i[e+1],et(n,t&&t.__attrs__))}return t=i[0],et(e,t&&t.__attrs__),e.__attrs__}function it(e,t){const i=nt(e),n=t+Je,s={};for(const e in i)e.startsWith(n)&&(s[e.slice(n.length)]=i[e]);return s}function nt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||tt(e)}function st(e,t,i,n){nt(e)[t+Je+i]=n}class ot{constructor(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}toString(){return this.name}}const rt=e("CCInteger",new ot("Integer",0));n.Integer=rt,n.CCInteger=rt;const at=e("CCFloat",new ot("Float",0));n.Float=at,n.CCFloat=at;const ct=e("CCBoolean",new ot("Boolean",!1));n.Boolean=ct,n.CCBoolean=ct;const lt=e("CCString",new ot("String",""));function ht(e,t){return function(i,n){const s=`"${oe(i)}.${n}"`,o=it(i,n);let r=o.type;if(r===rt||r===at?r="Number":r!==lt&&r!==ct||(r=`${r}`),r!==e)return void T(3604,s);if(!o.hasOwnProperty("default"))return;const a=o.default;if(void 0===a)return;if(Array.isArray(a)||Ke(a))return;const c=typeof a,l=e.toLowerCase();if(c===l)if("object"===l){if(!a||a instanceof o.ctor)return;T(3605,s,oe(o.ctor))}else"Number"!==e&&T(3606,t,s,e);else{if("function"===c)return;e===lt.default&&null==a?T(3607,s):T(3611,t,s,c)}delete o.type}}n.String=lt,n.CCString=lt;var ut=Object.freeze({__proto__:null,DELIMETER:Je,createAttrsSingle:et,createAttrs:tt,attr:it,getClassAttrs:nt,setClassAttr:st,PrimitiveType:ot,CCInteger:rt,CCFloat:at,CCBoolean:ct,CCString:lt,getTypeChecker_ET:ht,getObjTypeChecker_ET:function(e){return function(t,i){ht("Object","type")(t,i);const s=nt(t)[`${i+Je}default`],o=n.Class.getDefault(s);if(!Array.isArray(o)&&ve(e,n.ValueType)){const n=oe(e),o=he('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',oe(t),i,n);s?_(o):T(3612,o,n,oe(t),i,n)}}}});const _t={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function pt(e,t,i,n){if(!e.get&&!e.set&&e.hasOwnProperty("default")){const s=`_N$${t}`;e.get=function(){return this[s]},e.set=function(e){const t=this[s];this[s]=e,i.call(this,t)};const o={};n[s]=o;for(const t in _t){const i=_t[t];e.hasOwnProperty(t)&&(o[t]=e[t],i.canUsedInGet||delete e[t])}}}function dt(e,t,i,s){if(Array.isArray(t)){if(!(t.length>0))return C(5508,i,s);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=n.String:t===Boolean?e.type=n.Boolean:t===Number&&(e.type=n.Float))}function ft(e,t,i){const n=e?{_short:!0}:{_short:!0,default:t};return i&&(n.type=i),n}function mt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return ft(t,[],e);if("function"==typeof e){const i=e;return ft(t,ve(i,n.ValueType)?new i:null,i)}return ft(t,e instanceof ot?e.default:e)}return null}let gt=[];function vt(){return gt[gt.length-1]}n._RF={push:function(e,t,i,n){void 0===i&&(i=t,t=""),gt.push({uuid:t,script:i,module:e,exports:e.exports,beh:null,importMeta:n})},pop:function(){const e=gt.pop(),t=e.module;let i=t.exports;if(i===e.exports){for(const e in i)return;t.exports=i=e.cls}},peek:vt};const yt=Je,xt={datas:null,push(e){if(this.datas)this.datas.push(e);else{this.datas=[e];const t=this;setTimeout((()=>{t.init()}),0)}},init(){const e=this.datas;if(e){for(let t=0;t<e.length;++t){const i=e[t],n=i.cls;let s=i.props;"function"==typeof s&&(s=s());const o=oe(n);s?Ct(n,o,s,n.$super,i.mixins):C(3633,o)}this.datas=null}}};function St(e,t,i,n){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,i),Pt(e,n,t,i)}function bt(e,t,i,n){const s=n.get;n.set,s&&(Pt(e,n,t,i),st(e,i,"serializable",!1))}function Tt(e){return"function"==typeof e?e():e}function Et(e,t,i){for(const n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,_e(t,n))}function Ct(e,t,i,n,s){if(e.__props__=[],n&&n.__props__&&(e.__props__=n.__props__.slice()),s)for(let t=0;t<s.length;++t){const i=s[t];i.__props__&&(e.__props__=e.__props__.concat(i.__props__.filter((t=>e.__props__.indexOf(t)<0))))}if(i){!function(e,t){for(const i in e){let n=e[i];const s=mt(n,!1);if(s&&(n=e[i]=s),n){const s=n.notify;s&&pt(n,i,s,e),"type"in n&&dt(n,n.type,t,i)}}}(i,t);for(const n in i){const s=i[n];s.get||s.set?bt(e,t,n,s):St(e,t,n,s)}}const o=nt(e);e.__values__=e.__props__.filter((e=>!1!==o[`${e+yt}serializable`]))}function wt(e){let t=e.name;const i=e.extends,s=e.mixins,o=function(e,t,i,s){const o=n.Component,r=vt();if(r&&ve(t,o)){if(ve(r.cls,o))return C(3615),null;e=e||r.script}const a=function(e,t,i,n){const s=n.ctor,o=[s],r=s;ee(r,"__ctors__",o.length>0?o:null,!0);const a=r.prototype;if(t&&(r.$super=t),i){for(let e=i.length-1;e>=0;e--){const t=i[e];Et(a,t.prototype),wt._isCCClass(t)&&Et(nt(r),nt(t))}a.constructor=r}return Ce(e,r),r}(e,t,i,s);if(r)if(ve(t,o)){const e=r.uuid;e&&Te(e,a),r.cls=a}else ve(r.cls,o)||(r.cls=a);return a}(t,i,s,e);t||(t=n.js.getClassName(o)),o._sealed=!0,i&&(i._sealed=!1);const r=e.properties;"function"==typeof r||i&&null===i.__props__||s&&s.some((e=>null===e.__props__))?(xt.push({cls:o,props:r,mixins:s}),o.__props__=o.__values__=null):Ct(o,t,r,i,e.mixins);const a=e.editor;return a&&ve(i,n.Component)&&n.Component._registerEditorProps(o,a),o}wt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},wt.fastDefine=function(e,t,i){Ce(e,t);const n=t.__props__=t.__values__=Object.keys(i),s=nt(t);for(let e=0;e<n.length;e++){const t=n[e];s[`${t+yt}visible`]=!1,s[`${t+yt}default`]=i[t]}},wt.Attr=ut,wt.attr=it,wt.getInheritanceChain=function(e){const t=[];for(;e=ge(e);)e!==Object&&t.push(e);return t};const At={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Pt(e,t,i,n){let s=null,o="";function r(){return o=n+yt,s=nt(e)}"type"in t&&void 0===t.type&&T(3660,n,i);const a=t.type;a&&(At[a]?(s||r())[`${o}type`]=a:"Object"===a||("object"==typeof a?Le.isEnum(a)?((s||r())[`${o}type`]="Enum",s[`${o}enumList`]=Le.getList(a)):Ne.isBitMask(a)&&((s||r())[`${o}type`]="BitMask",s[`${o}bitmaskList`]=Ne.getList(a)):"function"==typeof a&&((s||r())[`${o}type`]="Object",s[`${o}ctor`]=a))),"default"in t&&((s||r())[`${o}default`]=t.default);const c=(e,i)=>{if(e in t){const n=t[e];typeof n===i&&((s||r())[o+e]=n)}};var l;t.editorOnly&&((s||r())[`${o}editorOnly`]=!0),t.__noImplicit?(s||r())[`${o}serializable`]=null!==(l=t.serializable)&&void 0!==l&&l:!1===t.serializable&&((s||r())[`${o}serializable`]=!1),c("formerlySerializedAs","string");const h=t.range;h&&Array.isArray(h)&&h.length>=2&&((s||r())[`${o}min`]=h[0],s[`${o}max`]=h[1],h.length>2&&(s[`${o}step`]=h[2])),c("min","number"),c("max","number"),c("step","number")}wt.isArray=function(e){return e=Tt(e),Array.isArray(e)},wt.getDefault=Tt,wt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},wt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,wt.getNewValueTypeCode=function(e){const t=oe(e),i=e.constructor;let n=`new ${t}(`;for(let t=0;t<i.__props__.length;t++)n+=e[i.__props__[t]],t<i.__props__.length-1&&(n+=",");return`${n})`},n.Class=wt;const Rt=e("editorExtrasTag","__editorExtras__"),It=1<<22,Mt=[];class Ot{static _deferredDestroy(){const e=Mt.length;for(let t=0;t<e;++t){const e=Mt[t];1&e._objFlags||e._destroyImmediate()}e===Mt.length?Mt.length=0:Mt.splice(0,e)}constructor(e=""){this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}get name(){return this._name}set name(e){this._name=e}set hideFlags(e){const t=e&Ot.Flags.AllHideMasks;this._objFlags=this._objFlags&~Ot.Flags.AllHideMasks|t}get hideFlags(){return this._objFlags&Ot.Flags.AllHideMasks}set replicated(e){e?this._objFlags|=It:this._objFlags&=-4194305}get replicated(){return!!(this._objFlags&It)}get isValid(){return!(1&this._objFlags)}destroy(){return 1&this._objFlags?(T(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Mt.push(this),0))}_destruct(){const e=this.constructor;let t=e.__destruct__;t||(t=function(e,t){const i=e instanceof n._BaseNode||e instanceof n.Component,s=i?"_id":null;let o;const r={};for(o in e)if(e.hasOwnProperty(o)){if(o===s)continue;switch(typeof e[o]){case"string":r[o]="";break;case"object":case"function":r[o]=null}}if(wt._isCCClass(t)){const e=n.Class.Attr.getClassAttrs(t),s=t.__props__;for(let t=0;t<s.length;t++){o=s[t];const a=`${o+n.Class.Attr.DELIMETER}default`;if(a in e){if(i&&"_id"===o)continue;switch(typeof e[a]){case"string":r[o]="";break;case"object":case"function":r[o]=null;break;case"undefined":r[o]=void 0}}}}{let e="";for(o in r){let t;t=wt.IDENTIFIER_RE.test(o)?`o.${o}=`:`o[${wt.escapeForJS(o)}]=`;let i=r[o];""===i&&(i='""'),e+=`${t+i};\n`}return Function("o",e)}}(this,e),ee(e,"__destruct__",t,!0)),t(this)}_destroyImmediate(){1&this._objFlags?C(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}e("CCObject",Ot);const Dt=Ot.prototype;function Nt(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}Dt._deserialize=null,Dt._onPreDestroy=null,wt.fastDefine("cc.Object",Ot,{_name:"",_objFlags:0,[Rt]:{}}),wt.Attr.setClassAttr(Ot,Rt,"editorOnly",!0),ee(Ot,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),n.isValid=Nt,n.Object=Ot;const Lt=Oe.fastRemoveAt;function Bt(){}class zt{constructor(){this.callback=Bt,this.target=void 0,this.once=!1}set(e,t,i){this.callback=e||Bt,this.target=t,this.once=!!i}reset(){this.target=void 0,this.callback=Bt,this.once=!1}check(){return!(this.target instanceof Ot&&!Nt(this.target,!0))}}const Ft=new F((()=>new zt),32);class Ut{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(e){for(let t=0;t<this.callbackInfos.length;++t){const i=this.callbackInfos[t];i&&i.callback===e&&(i.reset(),Ft.free(i),Lt(this.callbackInfos,t),--t)}}removeByTarget(e){for(let t=0;t<this.callbackInfos.length;++t){const i=this.callbackInfos[t];i&&i.target===e&&(i.reset(),Ft.free(i),Lt(this.callbackInfos,t),--t)}}cancel(e){const t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Lt(this.callbackInfos,e),Ft.free(t)),this.containCanceled=!0}cancelAll(){for(let e=0;e<this.callbackInfos.length;e++){const t=this.callbackInfos[e];t&&(t.reset(),Ft.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}purgeCanceled(){for(let e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Lt(this.callbackInfos,e);this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const Gt=new F((()=>new Ut),16);class kt{constructor(){this._callbackTable=se(!0)}on(e,t,i,n){if(!this.hasEventListener(e,t,i)){let s=this._callbackTable[e];s||(s=this._callbackTable[e]=Gt.alloc());const o=Ft.alloc();o.set(t,i,n),s.callbackInfos.push(o)}return t}hasEventListener(e,t,i){const n=this._callbackTable&&this._callbackTable[e];if(!n)return!1;const s=n.callbackInfos;if(!t){if(n.isInvoking){for(let e=0;e<s.length;++e)if(s[e])return!0;return!1}return s.length>0}for(let e=0;e<s.length;++e){const n=s[e];if(n&&n.check()&&n.callback===t&&n.target===i)return!0}return!1}removeAll(e){const t=typeof e;if("string"===t||"number"===t){const t=this._callbackTable&&this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),Gt.free(t),delete this._callbackTable[e]))}else if(e)for(const t in this._callbackTable){const i=this._callbackTable[t];if(i.isInvoking){const t=i.callbackInfos;for(let n=0;n<t.length;++n){const s=t[n];s&&s.target===e&&i.cancel(n)}}else i.removeByTarget(e)}}off(e,t,i){const n=this._callbackTable&&this._callbackTable[e];if(n){const s=n.callbackInfos;if(t)for(let e=0;e<s.length;++e){const o=s[e];if(o&&o.callback===t&&o.target===i){n.cancel(e);break}}else this.removeAll(e)}}emit(e,t,i,n,s,o){const r=this._callbackTable&&this._callbackTable[e];if(r){const a=!r.isInvoking;r.isInvoking=!0;const c=r.callbackInfos;for(let r=0,a=c.length;r<a;++r){const a=c[r];if(a){const r=a.callback,c=a.target;a.once&&this.off(e,r,c),a.check()?c?r.call(c,t,i,n,s,o):r(t,i,n,s,o):this.off(e,r,c)}}a&&(r.isInvoking=!1,r.containCanceled&&r.purgeCanceled())}}clear(){for(const e in this._callbackTable){const t=this._callbackTable[e];t&&(t.clear(),Gt.free(t),delete this._callbackTable[e])}}}function Ht(e){class t extends e{constructor(...e){super(...e),this._callbackTable=se(!0)}once(e,t,i){return this.on(e,t,i,!0)}targetOff(e){this.removeAll(e)}}const i=kt.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i));for(let e=0;e<n.length;++e){const s=n[e];if(!(s in t.prototype)){const e=Object.getOwnPropertyDescriptor(i,s);e&&Object.defineProperty(t.prototype,s,e)}}return t}const Vt=e("EventTarget",Ht(class{}));n.EventTarget=Vt;const jt={0:L.NONE,1:L.LAN,2:L.WWAN},Wt={0:z.WIN32,2:z.MACOS,3:z.ANDROID,4:z.IOS,5:z.IOS,6:z.OHOS},qt=new class extends Vt{get networkType(){return jt[jsb.device.getNetworkType()]}constructor(){super(),this.isNative=void 0,this.isBrowser=void 0,this.isMobile=void 0,this.isLittleEndian=void 0,this.platform=void 0,this.language=void 0,this.nativeLanguage=void 0,this.os=void 0,this.osVersion=void 0,this.osMainVersion=void 0,this.browserType=void 0,this.browserVersion=void 0,this.pixelRatio=void 0,this.supportCapability=void 0,this.isNative=!0,this.isBrowser=!1,this.platform=Wt[__getPlatform()],this.isMobile=this.platform===z.ANDROID||this.platform===z.IOS||this.platform===z.OHOS,this.isLittleEndian=(()=>{const e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]})();const e=__getCurrentLanguageCode();this.nativeLanguage=e?e.toLowerCase():N.UNKNOWN,this.language=__getCurrentLanguage(),this.os=__getOS(),this.osVersion=__getOSVersion(),this.osMainVersion=parseInt(this.osVersion),this.browserType=D.UNKNOWN,this.browserVersion="",this.pixelRatio=jsb.device.getDevicePixelRatio()||1,this.supportCapability={webp:!0,gl:!0,canvas:!0,imageBitmap:!1},this._registerEvent()}_registerEvent(){jsb.onPause=()=>{this.emit("hide")},jsb.onResume=()=>{this.emit("show")},jsb.onClose=()=>{this.emit("close")}}getBatteryLevel(){return jsb.device.getBatteryLevel()}triggerGC(){jsb.garbageCollect()}openURL(e){jsb.openURL(e)}now(){return Date.now?Date.now():+new Date}restartJSVM(){__restartVM()}close(){__close()}},Xt=2147483647;function Yt(e){return(e>0)-(e<0)}function Kt(e){let t,i;return t=(e>65535)<<4,i=((e>>>=t)>255)<<3,t|=i,i=((e>>>=i)>15)<<2,t|=i,i=((e>>>=i)>3)<<1,t|=i,t|(e>>>=i)>>1}function $t(e){let t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function Qt(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}const Zt=new Array(256);(e=>{for(let t=0;t<256;++t){let i=t,n=t,s=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--s;e[t]=n<<s&255}})(Zt);var Jt=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:Xt,INT_MIN:-2147483648,sign:Yt,abs:function(e){const t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:Kt,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:$t,nextPow2:Qt,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return Zt[255&e]<<24|Zt[e>>>8&255]<<16|Zt[e>>>16&255]<<8|Zt[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){const t=e|e-1;return t+1|(~t&-~t)-1>>>$t(e)+1}});e("bits",Jt);let ei,ti,ii,ni,si,oi,ri=10,ai=0;const ci=new Map;ni=(e,t,i,n,s,o,r)=>{const a=ci.get(o);a&&a.logTimes>a.count&&(s(`'%s' is deprecated, please use '%s' instead. ${r}`,`${e}.${t}`,`${i}.${n}`),a.count++)},ei=e("replaceProperty",((e,t,i)=>{null!=e&&i.forEach((i=>{const n=ai++;ci.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:ri});const s=null!=i.target?i.target:e,o=null!=i.newName?i.newName:i.name,r=null!=i.targetName?i.targetName:t,a=s===e,c=i.suggest?`(${i.suggest})`:"";if(null!=i.customFunction)e[i.name]=function(){return ni(t,i.name,r,o,p,n,c),i.customFunction.call(this,...arguments)};else if(null!=i.customSetter||null!=i.customGetter){const s=null!=i.customSetter,a=null!=i.customGetter;s&&a?Object.defineProperty(e,i.name,{get(){return ni(t,i.name,r,o,p,n,c),i.customGetter.call(this)},set(e){ni(t,i.name,r,o,p,n,c),i.customSetter.call(this,e)},enumerable:!1}):s?Object.defineProperty(e,i.name,{set(e){ni(t,i.name,r,o,p,n,c),i.customSetter.call(this,e)},enumerable:!1}):a&&Object.defineProperty(e,i.name,{get(){return ni(t,i.name,r,o,p,n,c),i.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,i.name,{get(){return ni(t,i.name,r,o,p,n,c),a?this[o]:s[o]},set(e){ni(t,i.name,r,o,p,n,c),a?this[o]=e:s[o]=e},enumerable:!1})}))})),oi=(e,t,i,n,s)=>{const o=ci.get(n);o&&o.logTimes>o.count&&(i(`'%s' has been removed. ${s}`,`${e}.${t}`),o.count++)},ti=e("removeProperty",((e,t,i)=>{null!=e&&i.forEach((i=>{const n=ai++;ci.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:ri});const s=i.suggest?`(${i.suggest})`:"";Object.defineProperty(e,i.name,{get:()=>oi(t,i.name,d,n,s),set(){oi(t,i.name,d,n,s)},enumerable:!1})}))})),si=(e,t,i,n,s)=>{const o=ci.get(n);o&&o.logTimes>o.count&&(i(`'%s' is deprecated. ${s}`,`${e}.${t}`),o.count++)},ii=e("markAsWarning",((e,t,i)=>{if(null==e)return;const n=(t,i,n,s,o,r)=>{if(t.get){const e=t.get;t.get=function(){return si(i,n,s,o,r),e.call(this)}}if(t.set){const e=t.set;t.set=function(t){si(i,n,s,o,r),e.call(this,t)}}Object.defineProperty(e,n,t)};i.forEach((i=>{const s=i.name,o=Object.getOwnPropertyDescriptor(e,s);if(!o||!o.configurable)return;const r=ai++;ci.set(r,{id:r,count:0,logTimes:void 0!==i.logTimes?i.logTimes:ri});const a=i.suggest?`(${i.suggest})`:"";if(void 0!==o.value)if("function"==typeof o.value){const i=o.value;e[s]=function(){return si(t,s,p,r,a),i.call(this,...arguments)}}else{let i=o.value;Object.defineProperty(e,s,{configurable:!0,get:()=>(si(t,s,p,r,a),i)}),o.writable&&Object.defineProperty(e,s,{set(e){si(t,s,p,r,a),i=e}})}else n(o,t,s,p,r,a);Object.defineProperty(e,s,{enumerable:!1})}))}));const li=Math.PI/180,hi=180/Math.PI,ui=e("EPSILON",1e-6);function _i(e,t){return Math.abs(e-t)<=ui*Math.max(1,Math.abs(e),Math.abs(t))}function pi(e,t,i){return i=i||ui,Math.abs(e-t)<=i}function di(e,t,i){if(t>i){const e=t;t=i,i=e}return e<t?t:e>i?i:e}function fi(e){return e<0?0:e>1?1:e}function mi(e,t,i){return e+(t-e)*i}function gi(e){return e*li}function vi(e){return e*hi}const yi=e("random",Math.random);function xi(e,t){return Math.random()*(t-e)+e}function Si(e,t){return Math.floor(xi(e,t))}function bi(e){return(e=(9301*e+49297)%233280)/233280}function Ti(e,t,i){return bi(e)*(i-t)+t}function Ei(e,t,i){return Math.floor(Ti(e,t,i))}function Ci(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function wi(e,t){return e-Math.floor(e/t)*t}function Ai(e,t){return e=wi(e,2*t),t-Math.abs(e-t)}function Pi(e,t,i){return(i-e)/(t-e)}function Ri(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function Ii(e,t){return Math.abs(e)>Math.abs(t)?e:t}function Mi(e,t){t.forEach((t=>{Object.defineProperty(e,t,{enumerable:!0})}))}const Oi=1/255;class Di extends Ue{static clone(e){const t=new Di;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}static copy(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}static set(e,t,i,n,s){return e.r=t,e.g=i,e.b=n,e.a=s,e}static fromHEX(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16)||255,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e}static add(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}static subtract(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}static multiply(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}static divide(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}static scale(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}static lerp(e,t,i,n){let s=t.r,o=t.g,r=t.b,a=t.a;return s+=(i.r-s)*n,o+=(i.g-o)*n,r+=(i.b-r)*n,a+=(i.a-a)*n,e._val=Math.floor((a<<24>>>0)+(r<<16)+(o<<8)+s),e}static toArray(e,t,i=0){const n=t instanceof Di||t.a>1?1/255:1;return e[i+0]=t.r*n,e[i+1]=t.g*n,e[i+2]=t.b*n,e[i+3]=t.a*n,e}static fromArray(e,t,i=0){return t.r=255*e[i+0],t.g=255*e[i+1],t.b=255*e[i+2],t.a=255*e[i+3],t}static strictEquals(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}static equals(e,t,i=ui){return Math.abs(e.r-t.r)<=i*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=i*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=i*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=i*Math.max(1,Math.abs(e.a),Math.abs(t.a))}static hex(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}get r(){return 255&this._val}set r(e){e=~~di(e,0,255),this._val=(4294967040&this._val|e)>>>0}get g(){return(65280&this._val)>>8}set g(e){e=~~di(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}get b(){return(16711680&this._val)>>16}set b(e){e=~~di(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}get a(){return(4278190080&this._val)>>>24}set a(e){e=~~di(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}get x(){return this.r*Oi}set x(e){this.r=255*e}get y(){return this.g*Oi}set y(e){this.g=255*e}get z(){return this.b*Oi}set z(e){this.b=255*e}get w(){return this.a*Oi}set w(e){this.a=255*e}constructor(e,t,i,n){super(),this._val=0,"string"==typeof e?this.fromHEX(e):void 0!==t?this.set(e,t,i,n):this.set(e)}clone(){const e=new Di;return e._val=this._val,e}equals(e){return e&&this._val===e._val}lerp(e,t){let i=this.r,n=this.g,s=this.b,o=this.a;return i+=(e.r-i)*t,n+=(e.g-n)*t,s+=(e.b-s)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(s<<16)+(n<<8)+i),this}toString(){return`rgba(${this.r.toFixed()}, ${this.g.toFixed()}, ${this.b.toFixed()}, ${this.a.toFixed()})`}toCSS(e="rgba"){return"rgba"===e?`rgba(${this.r},${this.g},${this.b},${(this.a*Oi).toFixed(2)})`:"rgb"===e?`rgb(${this.r},${this.g},${this.b})`:`#${this.toHEX(e)}`}fromHEX(e){e=0===e.indexOf("#")?e.substring(1):e;const t=parseInt(e.substr(0,2),16)||0,i=parseInt(e.substr(2,2),16)||0,n=parseInt(e.substr(4,2),16)||0,s=parseInt(e.substr(6,2),16)||255;return this._val=(s<<24>>>0)+(n<<16)+(i<<8)+(0|t),this}toHEX(e="#rrggbb"){const t="0",i=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(i[0]=i[0][0],i[1]=i[1][0],i[2]=i[2][0]):"#rrggbbaa"===e&&i.push((this.a<16?t:"")+this.a.toString(16)),i.join("")}toRGBValue(){return 16777215&this._val}fromHSV(e,t,i){let n=0,s=0,o=0;if(0===t)n=s=o=i;else if(0===i)n=s=o=0;else{1===e&&(e=0),e*=6;const r=Math.floor(e),a=e-r,c=i*(1-t),l=i*(1-t*a),h=i*(1-t*(1-a));switch(r){case 0:n=i,s=h,o=c;break;case 1:n=l,s=i,o=c;break;case 2:n=c,s=i,o=h;break;case 3:n=c,s=l,o=i;break;case 4:n=h,s=c,o=i;break;case 5:n=i,s=c,o=l}}return n*=255,s*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(s<<8)+(0|n),this}toHSV(){const e=this.r*Oi,t=this.g*Oi,i=this.b*Oi,n={h:0,s:0,v:0},s=Math.max(e,t,i),o=Math.min(e,t,i);let r=0;return n.v=s,n.s=s?(s-o)/s:0,n.s?(r=s-o,n.h=e===s?(t-i)/r:t===s?2+(i-e)/r:4+(e-t)/r,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}set(e,t,i,n){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,i=e.b||0,n="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+(0|e)),this}multiply(e){const t=(255&this._val)*e.r>>8,i=(65280&this._val)*e.g>>8,n=(16711680&this._val)*e.b>>8,s=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&s|16711680&n|65280&i|255&t,this}_set_r_unsafe(e){return this._val=(4294967040&this._val|e)>>>0,this}_set_g_unsafe(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}_set_b_unsafe(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}_set_a_unsafe(e){return this._val=(16777215&this._val|e<<24)>>>0,this}}function Ni(e,t,i,n){return new Di(e,t,i,n)}e("Color",Di),Di.WHITE=Object.freeze(new Di(255,255,255,255)),Di.GRAY=Object.freeze(new Di(127,127,127,255)),Di.BLACK=Object.freeze(new Di(0,0,0,255)),Di.TRANSPARENT=Object.freeze(new Di(0,0,0,0)),Di.RED=Object.freeze(new Di(255,0,0,255)),Di.GREEN=Object.freeze(new Di(0,255,0,255)),Di.BLUE=Object.freeze(new Di(0,0,255,255)),Di.CYAN=Object.freeze(new Di(0,255,255,255)),Di.MAGENTA=Object.freeze(new Di(255,0,255,255)),Di.YELLOW=Object.freeze(new Di(255,255,0,255)),wt.fastDefine("cc.Color",Di,{r:0,g:0,b:0,a:255}),n.Color=Di,n.color=Ni;const Li=e("MATH_FLOAT_ARRAY",Float32Array);class Bi extends Ue{static createFloatArray(e){return new Li(e)}get array(){return this._array}}e("MathBase",Bi);class zi extends Bi{static zero(e){return e.x=0,e.y=0,e.z=0,e}static clone(e){return new zi(e.x,e.y,e.z)}static copy(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}static set(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}static add(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}static subtract(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}static multiply(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}static divide(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}static ceil(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}static floor(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}static min(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}static max(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}static round(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}static multiplyScalar(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}static scaleAndAdd(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}static distance(e,t){const i=t.x-e.x,n=t.y-e.y,s=t.z-e.z;return Math.sqrt(i*i+n*n+s*s)}static squaredDistance(e,t){const i=t.x-e.x,n=t.y-e.y,s=t.z-e.z;return i*i+n*n+s*s}static len(e){const t=e.x,i=e.y,n=e.z;return Math.sqrt(t*t+i*i+n*n)}static lengthSqr(e){const t=e.x,i=e.y,n=e.z;return t*t+i*i+n*n}static negate(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}static invert(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}static invertSafe(e,t){const i=t.x,n=t.y,s=t.z;return Math.abs(i)<ui?e.x=0:e.x=1/i,Math.abs(n)<ui?e.y=0:e.y=1/n,Math.abs(s)<ui?e.z=0:e.z=1/s,e}static normalize(e,t){const i=t.x,n=t.y,s=t.z;let o=i*i+n*n+s*s;return o>0&&(o=1/Math.sqrt(o),e.x=i*o,e.y=n*o,e.z=s*o),e}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static cross(e,t,i){const{x:n,y:s,z:o}=t,{x:r,y:a,z:c}=i;return e.x=s*c-o*a,e.y=o*r-n*c,e.z=n*a-s*r,e}static lerp(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}static random(e,t){t=t||1;const i=2*yi()*Math.PI,n=2*yi()-1,s=Math.sqrt(1-n*n);return e.x=s*Math.cos(i)*t,e.y=s*Math.sin(i)*t,e.z=n*t,e}static transformMat4(e,t,i){const n=t.x,s=t.y,o=t.z;let r=i.m03*n+i.m07*s+i.m11*o+i.m15;return r=r?Math.abs(1/r):1,e.x=(i.m00*n+i.m04*s+i.m08*o+i.m12)*r,e.y=(i.m01*n+i.m05*s+i.m09*o+i.m13)*r,e.z=(i.m02*n+i.m06*s+i.m10*o+i.m14)*r,e}static transformMat4Normal(e,t,i){const n=t.x,s=t.y,o=t.z;let r=i.m03*n+i.m07*s+i.m11*o;return r=r?Math.abs(1/r):1,e.x=(i.m00*n+i.m04*s+i.m08*o)*r,e.y=(i.m01*n+i.m05*s+i.m09*o)*r,e.z=(i.m02*n+i.m06*s+i.m10*o)*r,e}static transformMat3(e,t,i){const n=t.x,s=t.y,o=t.z;return e.x=n*i.m00+s*i.m03+o*i.m06,e.y=n*i.m01+s*i.m04+o*i.m07,e.z=n*i.m02+s*i.m05+o*i.m08,e}static transformAffine(e,t,i){const n=t.x,s=t.y,o=t.z;return e.x=i.m00*n+i.m04*s+i.m08*o+i.m12,e.y=i.m01*n+i.m05*s+i.m09*o+i.m13,e.x=i.m02*n+i.m06*s+i.m10*o+i.m14,e}static transformQuat(e,t,i){const n=i.w*t.x+i.y*t.z-i.z*t.y,s=i.w*t.y+i.z*t.x-i.x*t.z,o=i.w*t.z+i.x*t.y-i.y*t.x,r=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+r*-i.x+s*-i.z-o*-i.y,e.y=s*i.w+r*-i.y+o*-i.x-n*-i.z,e.z=o*i.w+r*-i.z+n*-i.y-s*-i.x,e}static transformRTS(e,t,i,n,s){const o=t.x*s.x,r=t.y*s.y,a=t.z*s.z,c=i.w*o+i.y*a-i.z*r,l=i.w*r+i.z*o-i.x*a,h=i.w*a+i.x*r-i.y*o,u=-i.x*o-i.y*r-i.z*a;return e.x=c*i.w+u*-i.x+l*-i.z-h*-i.y+n.x,e.y=l*i.w+u*-i.y+h*-i.x-c*-i.z+n.y,e.z=h*i.w+u*-i.z+c*-i.y-l*-i.x+n.z,e}static transformInverseRTS(e,t,i,n,s){const o=t.x-n.x,r=t.y-n.y,a=t.z-n.z,c=i.w*o-i.y*a+i.z*r,l=i.w*r-i.z*o+i.x*a,h=i.w*a-i.x*r+i.y*o,u=i.x*o+i.y*r+i.z*a;return e.x=(c*i.w+u*i.x+l*i.z-h*i.y)/s.x,e.y=(l*i.w+u*i.y+h*i.x-c*i.z)/s.y,e.z=(h*i.w+u*i.z+c*i.y-l*i.x)/s.z,e}static rotateX(e,t,i,n){const s=t.x-i.x,o=t.y-i.y,r=t.z-i.z,a=Math.cos(n),c=Math.sin(n),l=s,h=o*a-r*c,u=o*c+r*a;return e.x=l+i.x,e.y=h+i.y,e.z=u+i.z,e}static rotateY(e,t,i,n){const s=t.x-i.x,o=t.y-i.y,r=t.z-i.z,a=Math.cos(n),c=Math.sin(n),l=r*c+s*a,h=o,u=r*a-s*c;return e.x=l+i.x,e.y=h+i.y,e.z=u+i.z,e}static rotateZ(e,t,i,n){const s=t.x-i.x,o=t.y-i.y,r=t.z-i.z,a=Math.cos(n),c=Math.sin(n),l=s*a-o*c,h=s*c+o*a,u=r;return e.x=l+i.x,e.y=h+i.y,e.z=u+i.z,e}static toArray(e,t,i=0){return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e}static fromArray(e,t,i=0){return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e}static strictEquals(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}static equals(e,t,i=ui){const{x:n,y:s,z:o}=e,{x:r,y:a,z:c}=t;return Math.abs(n-r)<=i*Math.max(1,Math.abs(n),Math.abs(r))&&Math.abs(s-a)<=i*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(o-c)<=i*Math.max(1,Math.abs(o),Math.abs(c))}static angle(e,t){zi.normalize(Fi,e),zi.normalize(Ui,t);const i=zi.dot(Fi,Ui);return i>1?0:i<-1?Math.PI:Math.acos(i)}static projectOnPlane(e,t,i){return zi.subtract(e,t,zi.project(e,t,i))}static project(e,t,i){const n=zi.lengthSqr(i);return n<1e-6?zi.set(e,0,0,0):zi.multiplyScalar(e,i,zi.dot(t,i)/n)}get x(){return this._array[0]}set x(e){this._array[0]=e}get y(){return this._array[1]}set y(e){this._array[1]=e}get z(){return this._array[2]}set z(e){this._array[2]=e}constructor(e,t,i){if(super(),e&&"object"==typeof e)if(ArrayBuffer.isView(e))this._array=e,this._array.fill(0);else{const t=e.array;this._array=Bi.createFloatArray(3),this._array[0]=t[0],this._array[1]=t[1],this._array[2]=t[2]}else this._array=Bi.createFloatArray(3),this._array[0]=e||0,this._array[1]=t||0,this._array[2]=i||0}clone(){return new zi(this._array[0],this._array[1],this._array[2])}set(e,t,i){return e&&"object"==typeof e?(this._array[0]=e.x,this._array[1]=e.y,this._array[2]=e.z):(this._array[0]=e||0,this._array[1]=t||0,this._array[2]=i||0),this}equals(e,t=ui){const i=e.array;return Math.abs(this._array[0]-i[0])<=t*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=t*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=t*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))}equals3f(e,t,i,n=ui){return Math.abs(this._array[0]-e)<=n*Math.max(1,Math.abs(this._array[0]),Math.abs(e))&&Math.abs(this._array[1]-t)<=n*Math.max(1,Math.abs(this._array[1]),Math.abs(t))&&Math.abs(this._array[2]-i)<=n*Math.max(1,Math.abs(this._array[2]),Math.abs(i))}strictEquals(e){const t=e.array;return this._array[0]===t[0]&&this._array[1]===t[1]&&this._array[2]===t[2]}strictEquals3f(e,t,i){return this._array[0]===e&&this._array[1]===t&&this._array[2]===i}toString(){return`(${this._array[0].toFixed(2)}, ${this._array[1].toFixed(2)}, ${this._array[2].toFixed(2)})`}lerp(e,t){return this._array[0]+=t*(e.x-this._array[0]),this._array[1]+=t*(e.y-this._array[1]),this._array[2]+=t*(e.z-this._array[2]),this}add(e){const t=e.array;return this._array[0]+=t[0],this._array[1]+=t[1],this._array[2]+=t[2],this}add3f(e,t,i){return this._array[0]+=e,this._array[1]+=t,this._array[2]+=i,this}subtract(e){const t=e.array;return this._array[0]-=t[0],this._array[1]-=t[1],this._array[2]-=t[2],this}subtract3f(e,t,i){return this._array[0]-=e,this._array[1]-=t,this._array[2]-=i,this}multiplyScalar(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this._array[0]*=e,this._array[1]*=e,this._array[2]*=e,this}multiply(e){"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation");const t=e.array;return this._array[0]*=t[0],this._array[1]*=t[1],this._array[2]*=t[2],this}multiply3f(e,t,i){return this._array[0]*=e,this._array[1]*=t,this._array[2]*=i,this}divide(e){const t=e.array;return this._array[0]/=t[0],this._array[1]/=t[1],this._array[2]/=t[2],this}divide3f(e,t,i){return this._array[0]/=e,this._array[1]/=t,this._array[2]/=i,this}negative(){return this._array[0]=-this._array[0],this._array[1]=-this._array[1],this._array[2]=-this._array[2],this}clampf(e,t){const i=e.array,n=t.array;return this._array[0]=di(this._array[0],i[0],n[0]),this._array[1]=di(this._array[1],i[1],n[1]),this._array[2]=di(this._array[2],i[2],n[2]),this}dot(e){const t=e.array;return this._array[0]*t[0]+this._array[1]*t[1]+this._array[2]*t[2]}cross(e){const t=this._array[0],i=this._array[1],n=this._array[2],s=e.array[0],o=e.array[1],r=e.array[2];return this._array[0]=i*r-n*o,this._array[1]=n*s-t*r,this._array[2]=t*o-i*s,this}length(){return Math.sqrt(this._array[0]*this._array[0]+this._array[1]*this._array[1]+this._array[2]*this._array[2])}lengthSqr(){return this._array[0]*this._array[0]+this._array[1]*this._array[1]+this._array[2]*this._array[2]}normalize(){const e=this._array[0],t=this._array[1],i=this._array[2];let n=e*e+t*t+i*i;return n>0&&(n=1/Math.sqrt(n),this._array[0]=e*n,this._array[1]=t*n,this._array[2]=i*n),this}transformMat4(e){const t=this._array[0],i=this._array[1],n=this._array[2],s=e.array;let o=s[3]*t+s[7]*i+s[11]*n+s[15];return o=o?1/o:1,this._array[0]=(s[0]*t+s[4]*i+s[8]*n+s[12])*o,this._array[1]=(s[1]*t+s[5]*i+s[9]*n+s[13])*o,this._array[2]=(s[2]*t+s[6]*i+s[10]*n+s[14])*o,this}}e("Vec3",zi),zi.UNIT_X=Object.freeze(new zi(1,0,0)),zi.UNIT_Y=Object.freeze(new zi(0,1,0)),zi.UNIT_Z=Object.freeze(new zi(0,0,1)),zi.RIGHT=Object.freeze(new zi(1,0,0)),zi.UP=Object.freeze(new zi(0,1,0)),zi.FORWARD=Object.freeze(new zi(0,0,-1)),zi.ZERO=Object.freeze(new zi(0,0,0)),zi.ONE=Object.freeze(new zi(1,1,1)),zi.NEG_ONE=Object.freeze(new zi(-1,-1,-1));const Fi=new zi,Ui=new zi;function Gi(e,t,i){return new zi(e,t,i)}Mi(zi.prototype,["x","y","z"]),wt.fastDefine("cc.Vec3",zi,{x:0,y:0,z:0}),n.Vec3=zi,n.v3=Gi;class ki extends Bi{static clone(e){return new ki(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}static copy(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}static set(e,t,i,n,s,o,r,a,c,l){return e.m00=t,e.m01=i,e.m02=n,e.m03=s,e.m04=o,e.m05=r,e.m06=a,e.m07=c,e.m08=l,e}static identity(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}static transpose(e,t){if(e===t){const i=t.m01,n=t.m02,s=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=i,e.m05=t.m07,e.m06=n,e.m07=s}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e}static invert(e,t){const i=t.m00,n=t.m01,s=t.m02,o=t.m03,r=t.m04,a=t.m05,c=t.m06,l=t.m07,h=t.m08,u=h*r-a*l,_=-h*o+a*c,p=l*o-r*c;let d=i*u+n*_+s*p;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=u*d,e.m01=(-h*n+s*l)*d,e.m02=(a*n-s*r)*d,e.m03=_*d,e.m04=(h*i-s*c)*d,e.m05=(-a*i+s*o)*d,e.m06=p*d,e.m07=(-l*i+n*c)*d,e.m08=(r*i-n*o)*d,e)}static determinant(e){const t=e.m00,i=e.m01,n=e.m02,s=e.m03,o=e.m04,r=e.m05,a=e.m06,c=e.m07,l=e.m08;return t*(l*o-r*c)+i*(-l*s+r*a)+n*(c*s-o*a)}static multiply(e,t,i){const n=t.m00,s=t.m01,o=t.m02,r=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=i.m00,p=i.m01,d=i.m02,f=i.m03,m=i.m04,g=i.m05,v=i.m06,y=i.m07,x=i.m08;return e.m00=_*n+p*r+d*l,e.m01=_*s+p*a+d*h,e.m02=_*o+p*c+d*u,e.m03=f*n+m*r+g*l,e.m04=f*s+m*a+g*h,e.m05=f*o+m*c+g*u,e.m06=v*n+y*r+x*l,e.m07=v*s+y*a+x*h,e.m08=v*o+y*c+x*u,e}static multiplyMat4(e,t,i){const n=t.m00,s=t.m01,o=t.m02,r=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=i.m00,p=i.m01,d=i.m02,f=i.m04,m=i.m05,g=i.m06,v=i.m08,y=i.m09,x=i.m10;return e.m00=_*n+p*r+d*l,e.m01=_*s+p*a+d*h,e.m02=_*o+p*c+d*u,e.m03=f*n+m*r+g*l,e.m04=f*s+m*a+g*h,e.m05=f*o+m*c+g*u,e.m06=v*n+y*r+x*l,e.m07=v*s+y*a+x*h,e.m08=v*o+y*c+x*u,e}static transform(e,t,i){const n=t.m00,s=t.m01,o=t.m02,r=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=i.x,p=i.y;return e.m00=n,e.m01=s,e.m02=o,e.m03=r,e.m04=a,e.m05=c,e.m06=_*n+p*r+l,e.m07=_*s+p*a+h,e.m08=_*o+p*c+u,e}static scale(e,t,i){const n=i.x,s=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=s*t.m03,e.m04=s*t.m04,e.m05=s*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}static rotate(e,t,i){const n=t.m00,s=t.m01,o=t.m02,r=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=Math.sin(i),p=Math.cos(i);return e.m00=p*n+_*r,e.m01=p*s+_*a,e.m02=p*o+_*c,e.m03=p*r-_*n,e.m04=p*a-_*s,e.m05=p*c-_*o,e.m06=l,e.m07=h,e.m08=u,e}static fromMat4(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}static fromViewUp(e,t,i){return zi.lengthSqr(t)<ui*ui?(ki.identity(e),e):(zi.normalize(Hi,zi.cross(Hi,i||zi.UNIT_Y,t)),zi.lengthSqr(Hi)<ui*ui?(ki.identity(e),e):(zi.cross(Vi,t,Hi),ki.set(e,Hi.x,Hi.y,Hi.z,Vi.x,Vi.y,Vi.z,t.x,t.y,t.z),e))}static fromTranslation(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}static fromScaling(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}static fromRotation(e,t){const i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}static fromQuat(e,t){const i=t.x,n=t.y,s=t.z,o=t.w,r=i+i,a=n+n,c=s+s,l=i*r,h=n*r,u=n*a,_=s*r,p=s*a,d=s*c,f=o*r,m=o*a,g=o*c;return e.m00=1-u-d,e.m03=h-g,e.m06=_+m,e.m01=h+g,e.m04=1-l-d,e.m07=p-f,e.m02=_-m,e.m05=p+f,e.m08=1-l-u,e}static inverseTransposeMat4(e,t){const i=t.m00,n=t.m01,s=t.m02,o=t.m03,r=t.m04,a=t.m05,c=t.m06,l=t.m07,h=t.m08,u=t.m09,_=t.m10,p=t.m11,d=t.m12,f=t.m13,m=t.m14,g=t.m15,v=i*a-n*r,y=i*c-s*r,x=i*l-o*r,S=n*c-s*a,b=n*l-o*a,T=s*l-o*c,E=h*f-u*d,C=h*m-_*d,w=h*g-p*d,A=u*m-_*f,P=u*g-p*f,R=_*g-p*m;let I=v*R-y*P+x*A+S*w-b*C+T*E;return I?(I=1/I,e.m00=(a*R-c*P+l*A)*I,e.m01=(c*w-r*R-l*C)*I,e.m02=(r*P-a*w+l*E)*I,e.m03=(s*P-n*R-o*A)*I,e.m04=(i*R-s*w+o*C)*I,e.m05=(n*w-i*P-o*E)*I,e.m06=(f*T-m*b+g*S)*I,e.m07=(m*x-d*T-g*y)*I,e.m08=(d*b-f*x+g*v)*I,e):null}static toArray(e,t,i=0){return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e}static fromArray(e,t,i=0){return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e}static add(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}static subtract(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}static multiplyScalar(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}static multiplyScalarAndAdd(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}static strictEquals(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}static equals(e,t,i=ui){return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}get m00(){return this._array[0]}set m00(e){this._array[0]=e}get m01(){return this._array[1]}set m01(e){this._array[1]=e}get m02(){return this._array[2]}set m02(e){this._array[2]=e}get m03(){return this._array[3]}set m03(e){this._array[3]=e}get m04(){return this._array[4]}set m04(e){this._array[4]=e}get m05(){return this._array[5]}set m05(e){this._array[5]=e}get m06(){return this._array[6]}set m06(e){this._array[6]=e}get m07(){return this._array[7]}set m07(e){this._array[7]=e}get m08(){return this._array[8]}set m08(e){this._array[8]=e}constructor(e=1,t=0,i=0,n=0,s=1,o=0,r=0,a=0,c=1){if(super(),e&&"object"==typeof e)if(ArrayBuffer.isView(e))this._array=e,this._array.set([1,0,0,0,1,0,0,0,1]);else{const t=e.array;this._array=Bi.createFloatArray(9),this._array[0]=t[0],this._array[1]=t[1],this._array[2]=t[2],this._array[3]=t[3],this._array[4]=t[4],this._array[5]=t[5],this._array[6]=t[6],this._array[7]=t[7],this._array[8]=t[8]}else this._array=Bi.createFloatArray(9),this._array[0]=e,this._array[1]=t,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=o,this._array[6]=r,this._array[7]=a,this._array[8]=c}clone(){const e=this._array;return new ki(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}set(e=1,t=0,i=0,n=0,s=1,o=0,r=0,a=0,c=1){if(e&&"object"==typeof e){const t=e.array;this._array[0]=t[0],this._array[1]=t[1],this._array[2]=t[2],this._array[3]=t[3],this._array[4]=t[4],this._array[5]=t[5],this._array[6]=t[6],this._array[7]=t[7],this._array[8]=t[8]}else this._array[0]=e,this._array[1]=t,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=o,this._array[6]=r,this._array[7]=a,this._array[8]=c;return this}equals(e,t=ui){const i=e.array;return Math.abs(this._array[0]-i[0])<=t*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=t*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=t*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=t*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))&&Math.abs(this._array[4]-i[4])<=t*Math.max(1,Math.abs(this._array[4]),Math.abs(i[4]))&&Math.abs(this._array[5]-i[5])<=t*Math.max(1,Math.abs(this._array[5]),Math.abs(i[5]))&&Math.abs(this._array[6]-i[6])<=t*Math.max(1,Math.abs(this._array[6]),Math.abs(i[6]))&&Math.abs(this._array[7]-i[7])<=t*Math.max(1,Math.abs(this._array[7]),Math.abs(i[7]))&&Math.abs(this._array[8]-i[8])<=t*Math.max(1,Math.abs(this._array[8]),Math.abs(i[8]))}strictEquals(e){const t=e.array;return this._array[0]===t[0]&&this._array[1]===t[1]&&this._array[2]===t[2]&&this._array[3]===t[3]&&this._array[4]===t[4]&&this._array[5]===t[5]&&this._array[6]===t[6]&&this._array[7]===t[7]&&this._array[8]===t[8]}toString(){return`[\n${this._array[0]}, ${this._array[1]}, ${this._array[2]},\n${this._array[3]},\n${this._array[4]}, ${this._array[5]},\n${this._array[6]}, ${this._array[7]},\n${this._array[8]}\n]`}identity(){return this._array[0]=1,this._array[1]=0,this._array[2]=0,this._array[3]=0,this._array[4]=1,this._array[5]=0,this._array[6]=0,this._array[7]=0,this._array[8]=1,this}transpose(){const e=this._array[1],t=this._array[2],i=this._array[5];return this._array[1]=this._array[3],this._array[2]=this._array[6],this._array[3]=e,this._array[5]=this._array[7],this._array[6]=t,this._array[7]=i,this}invert(){const e=this._array[0],t=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],o=this._array[5],r=this._array[6],a=this._array[7],c=this._array[8],l=c*s-o*a,h=-c*n+o*r,u=a*n-s*r;let _=e*l+t*h+i*u;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this._array[0]=l*_,this._array[1]=(-c*t+i*a)*_,this._array[2]=(o*t-i*s)*_,this._array[3]=h*_,this._array[4]=(c*e-i*r)*_,this._array[5]=(-o*e+i*n)*_,this._array[6]=u*_,this._array[7]=(-a*e+t*r)*_,this._array[8]=(s*e-t*n)*_,this)}determinant(){const e=this._array[0],t=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],o=this._array[5],r=this._array[6],a=this._array[7],c=this._array[8];return e*(c*s-o*a)+t*(-c*n+o*r)+i*(a*n-s*r)}add(e){const t=e.array;return this._array[0]+=t[0],this._array[1]+=t[1],this._array[2]+=t[2],this._array[3]+=t[3],this._array[4]+=t[4],this._array[5]+=t[5],this._array[6]+=t[6],this._array[7]+=t[7],this._array[8]+=t[8],this}subtract(e){const t=e.array;return this._array[0]-=t[0],this._array[1]-=t[1],this._array[2]-=t[2],this._array[3]-=t[3],this._array[4]-=t[4],this._array[5]-=t[5],this._array[6]-=t[6],this._array[7]-=t[7],this._array[8]-=t[8],this}multiply(e){const t=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],o=this._array[4],r=this._array[5],a=this._array[6],c=this._array[7],l=this._array[8],h=e.array,u=h[0],_=h[1],p=h[2],d=h[3],f=h[4],m=h[5],g=h[6],v=h[7],y=h[8];return this._array[0]=u*t+_*s+p*a,this._array[1]=u*i+_*o+p*c,this._array[2]=u*n+_*r+p*l,this._array[3]=d*t+f*s+m*a,this._array[4]=d*i+f*o+m*c,this._array[5]=d*n+f*r+m*l,this._array[6]=g*t+v*s+y*a,this._array[7]=g*i+v*o+y*c,this._array[8]=g*n+v*r+y*l,this}multiplyScalar(e){return this._array[0]*=e,this._array[1]*=e,this._array[2]*=e,this._array[3]*=e,this._array[4]*=e,this._array[5]*=e,this._array[6]*=e,this._array[7]*=e,this._array[8]*=e,this}scale(e){const t=e.array[0],i=e.array[1];return this._array[0]*=t,this._array[1]*=t,this._array[2]*=t,this._array[3]*=i,this._array[4]*=i,this._array[5]*=i,this}rotate(e){const t=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],o=this._array[4],r=this._array[5],a=this._array[6],c=this._array[7],l=this._array[8],h=Math.sin(e),u=Math.cos(e);return this._array[0]=u*t+h*s,this._array[1]=u*i+h*o,this._array[2]=u*n+h*r,this._array[3]=u*s-h*t,this._array[4]=u*o-h*i,this._array[5]=u*r-h*n,this._array[6]=a,this._array[7]=c,this._array[8]=l,this}fromQuat(e){const t=e.x,i=e.y,n=e.z,s=e.w,o=t+t,r=i+i,a=n+n,c=t*o,l=i*o,h=i*r,u=n*o,_=n*r,p=n*a,d=s*o,f=s*r,m=s*a;return this._array[0]=1-h-p,this._array[3]=l-m,this._array[6]=u+f,this._array[1]=l+m,this._array[4]=1-c-p,this._array[7]=_-d,this._array[2]=u-f,this._array[5]=_+d,this._array[8]=1-c-h,this}}e("Mat3",ki),ki.IDENTITY=Object.freeze(new ki);const Hi=new zi,Vi=new zi;Mi(ki.prototype,["m00","m01","m02","m03","m04","m05","m06","m07","m08"]),wt.fastDefine("cc.Mat3",ki,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),n.Mat3=ki;class ji extends Bi{static clone(e){return new ji(e.x,e.y,e.z,e.w)}static copy(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}static set(e,t,i,n,s){return e.x=t,e.y=i,e.z=n,e.w=s,e}static identity(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}static rotationTo(e,t,i){const n=zi.dot(t,i);return n<-.999999?(zi.cross(Xi,zi.UNIT_X,t),Xi.length()<1e-6&&zi.cross(Xi,zi.UNIT_Y,t),zi.normalize(Xi,Xi),ji.fromAxisAngle(e,Xi,Math.PI),e):n>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(zi.cross(Xi,t,i),e.x=Xi.x,e.y=Xi.y,e.z=Xi.z,e.w=1+n,ji.normalize(e,e))}static getAxisAngle(e,t){const i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}static multiply(e,t,i){const n=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,s=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,o=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,r=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z;return e.x=n,e.y=s,e.z=o,e.w=r,e}static multiplyScalar(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}static scaleAndAdd(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}static rotateX(e,t,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:o,y:r,z:a,w:c}=t;return e.x=o*s+c*n,e.y=r*s+a*n,e.z=a*s-r*n,e.w=c*s-o*n,e}static rotateY(e,t,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:o,y:r,z:a,w:c}=t;return e.x=o*s-a*n,e.y=r*s+c*n,e.z=a*s+o*n,e.w=c*s-r*n,e}static rotateZ(e,t,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:o,y:r,z:a,w:c}=t;return e.x=o*s+r*n,e.y=r*s-o*n,e.z=a*s+c*n,e.w=c*s-a*n,e}static rotateAround(e,t,i,n){return ji.invert(Wi,t),zi.transformQuat(Xi,i,Wi),ji.fromAxisAngle(Wi,Xi,n),ji.multiply(e,t,Wi),e}static rotateAroundLocal(e,t,i,n){return ji.fromAxisAngle(Wi,i,n),ji.multiply(e,t,Wi),e}static calculateW(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static lerp(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}static slerp(e,t,i,n){let s=0,o=0,r=i.x,a=i.y,c=i.z,l=i.w,h=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(h<0&&(h=-h,r=-r,a=-a,c=-c,l=-l),1-h>1e-6){const e=Math.acos(h),t=Math.sin(e);s=Math.sin((1-n)*e)/t,o=Math.sin(n*e)/t}else s=1-n,o=n;return e.x=s*t.x+o*r,e.y=s*t.y+o*a,e.z=s*t.z+o*c,e.w=s*t.w+o*l,e}static sqlerp(e,t,i,n,s,o){return ji.slerp(Wi,t,s,o),ji.slerp(qi,i,n,o),ji.slerp(e,Wi,qi,2*o*(1-o)),e}static invert(e,t){const i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}static conjugate(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}static len(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}static lengthSqr(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}static normalize(e,t){let i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return i>0&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}static fromAxes(e,t,i,n){return ki.set(Yi,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),ji.normalize(e,ji.fromMat3(e,Yi))}static fromViewUp(e,t,i){return ki.fromViewUp(Yi,t,i),ji.normalize(e,ji.fromMat3(e,Yi))}static fromAxisAngle(e,t,i){i*=.5;const n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}static fromMat3(e,t){const{m00:i,m03:n,m06:s,m01:o,m04:r,m07:a,m02:c,m05:l,m08:h}=t,u=i+r+h;if(u>0){const t=.5/Math.sqrt(u+1);e.w=.25/t,e.x=(l-a)*t,e.y=(s-c)*t,e.z=(o-n)*t}else if(i>r&&i>h){const t=2*Math.sqrt(1+i-r-h);e.w=(l-a)/t,e.x=.25*t,e.y=(n+o)/t,e.z=(s+c)/t}else if(r>h){const t=2*Math.sqrt(1+r-i-h);e.w=(s-c)/t,e.x=(n+o)/t,e.y=.25*t,e.z=(a+l)/t}else{const t=2*Math.sqrt(1+h-i-r);e.w=(o-n)/t,e.x=(s+c)/t,e.y=(a+l)/t,e.z=.25*t}return e}static fromEuler(e,t,i,n){t*=Ki,i*=Ki,n*=Ki;const s=Math.sin(t),o=Math.cos(t),r=Math.sin(i),a=Math.cos(i),c=Math.sin(n),l=Math.cos(n);return e.x=s*a*l+o*r*c,e.y=o*r*l+s*a*c,e.z=o*a*c-s*r*l,e.w=o*a*l-s*r*c,e}static fromAngleZ(e,t){return t*=Ki,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e}static toAxisX(e,t){const i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}static toAxisY(e,t){const i=2*t.x,n=2*t.y,s=2*t.z;return e.x=n*t.x-s*t.w,e.y=1-i*t.x-s*t.z,e.z=s*t.y+i*t.w,e}static toAxisZ(e,t){const i=2*t.x,n=2*t.y,s=2*t.z;return e.x=s*t.x-n*t.w,e.y=s*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}static toEuler(e,t,i){const{x:n,y:s,z:o,w:r}=t;let a=0,c=0,l=0;const h=n*s+o*r;if(h>.499999)a=0,c=vi(2*Math.atan2(n,r)),l=90;else if(h<-.499999)a=0,c=-vi(2*Math.atan2(n,r)),l=-90;else{const e=n*n,t=s*s,u=o*o;a=vi(Math.atan2(2*n*r-2*s*o,1-2*e-2*u)),c=vi(Math.atan2(2*s*r-2*n*o,1-2*t-2*u)),l=vi(Math.asin(2*h)),i&&(a=-180*Math.sign(a+1e-6)+a,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=a,e.y=c,e.z=l,e}static toArray(e,t,i=0){return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}static fromArray(e,t,i=0){return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}static strictEquals(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}static equals(e,t,i=ui){return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}get x(){return this._array[0]}set x(e){this._array[0]=e}get y(){return this._array[1]}set y(e){this._array[1]=e}get z(){return this._array[2]}set z(e){this._array[2]=e}get w(){return this._array[3]}set w(e){this._array[3]=e}constructor(e,t,i,n){if(super(),e&&"object"==typeof e)if(ArrayBuffer.isView(e))this._array=e,this._array.fill(0),this._array[3]=1;else{const t=e.array;this._array=Bi.createFloatArray(4),this._array[0]=t[0],this._array[1]=t[1],this._array[2]=t[2],this._array[3]=t[3]}else this._array=Bi.createFloatArray(4),this._array[0]=e||0,this._array[1]=t||0,this._array[2]=i||0,this._array[3]=null!=n?n:1}clone(){return new ji(this._array[0],this._array[1],this._array[2],this._array[3])}set(e,t,i,n){if(e&&"object"==typeof e){const t=e.array;this._array[0]=t[0],this._array[1]=t[1],this._array[2]=t[2],this._array[3]=t[3]}else this._array[0]=e||0,this._array[1]=t||0,this._array[2]=i||0,this._array[3]=null!=n?n:1;return this}equals(e,t=ui){const i=e.array;return Math.abs(this._array[0]-i[0])<=t*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=t*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=t*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=t*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))}strictEquals(e){const t=e.array;return e&&this._array[0]===t[0]&&this._array[1]===t[1]&&this._array[2]===t[2]&&this._array[3]===t[3]}getEulerAngles(e){return ji.toEuler(e,this)}lerp(e,t){const i=e.array;return this._array[0]+=t*(i[0]-this._array[0]),this._array[1]+=t*(i[1]-this._array[1]),this._array[2]+=t*(i[2]-this._array[2]),this._array[3]+=t*(i[3]-this._array[3]),this}slerp(e,t){return ji.slerp(this,this,e,t)}length(){const e=this._array;return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3])}lengthSqr(){const e=this._array;return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]}}e("Quat",ji),ji.IDENTITY=Object.freeze(new ji),Mi(ji.prototype,["x","y","z","w"]);const Wi=new ji,qi=new ji,Xi=new zi,Yi=new ki,Ki=.5*Math.PI/180;function $i(e=0,t=0,i=0,n=1){return new ji(e,t,i,n)}wt.fastDefine("cc.Quat",ji,{x:0,y:0,z:0,w:1}),n.Quat=ji,n.quat=$i;const Qi=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]);class Zi extends Bi{static clone(e){return new Zi(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}static copy(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}static set(e,t,i,n,s,o,r,a,c,l,h,u,_,p,d,f,m){return e.m00=t,e.m01=i,e.m02=n,e.m03=s,e.m04=o,e.m05=r,e.m06=a,e.m07=c,e.m08=l,e.m09=h,e.m10=u,e.m11=_,e.m12=p,e.m13=d,e.m14=f,e.m15=m,e}static identity(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static transpose(e,t){if(e===t){const i=t.m01,n=t.m02,s=t.m03,o=t.m06,r=t.m07,a=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=o,e.m11=t.m14,e.m12=s,e.m13=r,e.m14=a}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}static invert(e,t){const i=t.m00,n=t.m01,s=t.m02,o=t.m03,r=t.m04,a=t.m05,c=t.m06,l=t.m07,h=t.m08,u=t.m09,_=t.m10,p=t.m11,d=t.m12,f=t.m13,m=t.m14,g=t.m15,v=i*a-n*r,y=i*c-s*r,x=i*l-o*r,S=n*c-s*a,b=n*l-o*a,T=s*l-o*c,E=h*f-u*d,C=h*m-_*d,w=h*g-p*d,A=u*m-_*f,P=u*g-p*f,R=_*g-p*m;let I=v*R-y*P+x*A+S*w-b*C+T*E;return 0===I?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(I=1/I,e.m00=(a*R-c*P+l*A)*I,e.m01=(s*P-n*R-o*A)*I,e.m02=(f*T-m*b+g*S)*I,e.m03=(_*b-u*T-p*S)*I,e.m04=(c*w-r*R-l*C)*I,e.m05=(i*R-s*w+o*C)*I,e.m06=(m*x-d*T-g*y)*I,e.m07=(h*T-_*x+p*y)*I,e.m08=(r*P-a*w+l*E)*I,e.m09=(n*w-i*P-o*E)*I,e.m10=(d*b-f*x+g*v)*I,e.m11=(u*x-h*b-p*v)*I,e.m12=(a*C-r*A-c*E)*I,e.m13=(i*A-n*C+s*E)*I,e.m14=(f*y-d*S-m*v)*I,e.m15=(h*S-u*y+_*v)*I,e)}static determinant(e){const t=e.m00,i=e.m01,n=e.m02,s=e.m03,o=e.m04,r=e.m05,a=e.m06,c=e.m07,l=e.m08,h=e.m09,u=e.m10,_=e.m11,p=e.m12,d=e.m13,f=e.m14,m=e.m15;return(t*r-i*o)*(u*m-_*f)-(t*a-n*o)*(h*m-_*d)+(t*c-s*o)*(h*f-u*d)+(i*a-n*r)*(l*m-_*p)-(i*c-s*r)*(l*f-u*p)+(n*c-s*a)*(l*d-h*p)}static multiply(e,t,i){const n=t.m00,s=t.m01,o=t.m02,r=t.m03,a=t.m04,c=t.m05,l=t.m06,h=t.m07,u=t.m08,_=t.m09,p=t.m10,d=t.m11,f=t.m12,m=t.m13,g=t.m14,v=t.m15;let y=i.m00,x=i.m01,S=i.m02,b=i.m03;return e.m00=y*n+x*a+S*u+b*f,e.m01=y*s+x*c+S*_+b*m,e.m02=y*o+x*l+S*p+b*g,e.m03=y*r+x*h+S*d+b*v,y=i.m04,x=i.m05,S=i.m06,b=i.m07,e.m04=y*n+x*a+S*u+b*f,e.m05=y*s+x*c+S*_+b*m,e.m06=y*o+x*l+S*p+b*g,e.m07=y*r+x*h+S*d+b*v,y=i.m08,x=i.m09,S=i.m10,b=i.m11,e.m08=y*n+x*a+S*u+b*f,e.m09=y*s+x*c+S*_+b*m,e.m10=y*o+x*l+S*p+b*g,e.m11=y*r+x*h+S*d+b*v,y=i.m12,x=i.m13,S=i.m14,b=i.m15,e.m12=y*n+x*a+S*u+b*f,e.m13=y*s+x*c+S*_+b*m,e.m14=y*o+x*l+S*p+b*g,e.m15=y*r+x*h+S*d+b*v,e}static transform(e,t,i){const n=i.x,s=i.y,o=i.z;if(t===e)e.m12=t.m00*n+t.m04*s+t.m08*o+t.m12,e.m13=t.m01*n+t.m05*s+t.m09*o+t.m13,e.m14=t.m02*n+t.m06*s+t.m10*o+t.m14,e.m15=t.m03*n+t.m07*s+t.m11*o+t.m15;else{const i=t.m00,r=t.m01,a=t.m02,c=t.m03,l=t.m04,h=t.m05,u=t.m06,_=t.m07,p=t.m08,d=t.m09,f=t.m10,m=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=i,e.m01=r,e.m02=a,e.m03=c,e.m04=l,e.m05=h,e.m06=u,e.m07=_,e.m08=p,e.m09=d,e.m10=f,e.m11=m,e.m12=i*n+l*s+p*o+t.m12,e.m13=r*n+h*s+d*o+t.m13,e.m14=a*n+u*s+f*o+t.m14,e.m15=c*n+_*s+m*o+t.m15}return e}static translate(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}static scale(e,t,i){const n=i.x,s=i.y,o=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*s,e.m05=t.m05*s,e.m06=t.m06*s,e.m07=t.m07*s,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}static rotate(e,t,i,n){let s=n.x,o=n.y,r=n.z,a=Math.sqrt(s*s+o*o+r*r);if(Math.abs(a)<ui)return null;a=1/a,s*=a,o*=a,r*=a;const c=Math.sin(i),l=Math.cos(i),h=1-l,u=t.m00,_=t.m01,p=t.m02,d=t.m03,f=t.m04,m=t.m05,g=t.m06,v=t.m07,y=t.m08,x=t.m09,S=t.m10,b=t.m11,T=s*s*h+l,E=o*s*h+r*c,C=r*s*h-o*c,w=s*o*h-r*c,A=o*o*h+l,P=r*o*h+s*c,R=s*r*h+o*c,I=o*r*h-s*c,M=r*r*h+l;return e.m00=u*T+f*E+y*C,e.m01=_*T+m*E+x*C,e.m02=p*T+g*E+S*C,e.m03=d*T+v*E+b*C,e.m04=u*w+f*A+y*P,e.m05=_*w+m*A+x*P,e.m06=p*w+g*A+S*P,e.m07=d*w+v*A+b*P,e.m08=u*R+f*I+y*M,e.m09=_*R+m*I+x*M,e.m10=p*R+g*I+S*M,e.m11=d*R+v*I+b*M,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}static rotateX(e,t,i){const n=Math.sin(i),s=Math.cos(i),o=t.m04,r=t.m05,a=t.m06,c=t.m07,l=t.m08,h=t.m09,u=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*s+l*n,e.m05=r*s+h*n,e.m06=a*s+u*n,e.m07=c*s+_*n,e.m08=l*s-o*n,e.m09=h*s-r*n,e.m10=u*s-a*n,e.m11=_*s-c*n,e}static rotateY(e,t,i){const n=Math.sin(i),s=Math.cos(i),o=t.m00,r=t.m01,a=t.m02,c=t.m03,l=t.m08,h=t.m09,u=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*s-l*n,e.m01=r*s-h*n,e.m02=a*s-u*n,e.m03=c*s-_*n,e.m08=o*n+l*s,e.m09=r*n+h*s,e.m10=a*n+u*s,e.m11=c*n+_*s,e}static rotateZ(e,t,i){const n=Math.sin(i),s=Math.cos(i),o=t.m00,r=t.m01,a=t.m02,c=t.m03,l=t.m04,h=t.m05,u=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*s+l*n,e.m01=r*s+h*n,e.m02=a*s+u*n,e.m03=c*s+_*n,e.m04=l*s-o*n,e.m05=h*s-r*n,e.m06=u*s-a*n,e.m07=_*s-c*n,e}static fromTranslation(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}static fromScaling(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromRotation(e,t,i){let n=i.x,s=i.y,o=i.z,r=Math.sqrt(n*n+s*s+o*o);if(Math.abs(r)<ui)return null;r=1/r,n*=r,s*=r,o*=r;const a=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=n*n*l+c,e.m01=s*n*l+o*a,e.m02=o*n*l-s*a,e.m03=0,e.m04=n*s*l-o*a,e.m05=s*s*l+c,e.m06=o*s*l+n*a,e.m07=0,e.m08=n*o*l+s*a,e.m09=s*o*l-n*a,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromXRotation(e,t){const i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromYRotation(e,t){const i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromZRotation(e,t){const i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static fromRT(e,t,i){const n=t.x,s=t.y,o=t.z,r=t.w,a=n+n,c=s+s,l=o+o,h=n*a,u=n*c,_=n*l,p=s*c,d=s*l,f=o*l,m=r*a,g=r*c,v=r*l;return e.m00=1-(p+f),e.m01=u+v,e.m02=_-g,e.m03=0,e.m04=u-v,e.m05=1-(h+f),e.m06=d+m,e.m07=0,e.m08=_+g,e.m09=d-m,e.m10=1-(h+p),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}static getTranslation(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}static getScaling(e,t){const i=en.m00=t.m00,n=en.m01=t.m01,s=en.m02=t.m02,o=en.m03=t.m04,r=en.m04=t.m05,a=en.m05=t.m06,c=en.m06=t.m08,l=en.m07=t.m09,h=en.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+s*s),e.y=Math.sqrt(o*o+r*r+a*a),e.z=Math.sqrt(c*c+l*l+h*h),ki.determinant(en)<0&&(e.x*=-1),e}static getRotation(e,t){const i=t.m00+t.m05+t.m10;let n=0;return i>0?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}static toRTS(e,t,i,n){n.x=zi.set(Ji,e.m00,e.m01,e.m02).length(),en.m00=e.m00/n.x,en.m01=e.m01/n.x,en.m02=e.m02/n.x,n.y=zi.set(Ji,e.m04,e.m05,e.m06).length(),en.m03=e.m04/n.y,en.m04=e.m05/n.y,en.m05=e.m06/n.y,n.z=zi.set(Ji,e.m08,e.m09,e.m10).length(),en.m06=e.m08/n.z,en.m07=e.m09/n.z,en.m08=e.m10/n.z,ki.determinant(en)<0&&(n.x*=-1,en.m00*=-1,en.m01*=-1,en.m02*=-1),ji.fromMat3(t,en),zi.set(i,e.m12,e.m13,e.m14)}static fromRTS(e,t,i,n){const s=t.x,o=t.y,r=t.z,a=t.w,c=s+s,l=o+o,h=r+r,u=s*c,_=s*l,p=s*h,d=o*l,f=o*h,m=r*h,g=a*c,v=a*l,y=a*h,x=n.x,S=n.y,b=n.z;return e.m00=(1-(d+m))*x,e.m01=(_+y)*x,e.m02=(p-v)*x,e.m03=0,e.m04=(_-y)*S,e.m05=(1-(u+m))*S,e.m06=(f+g)*S,e.m07=0,e.m08=(p+v)*b,e.m09=(f-g)*b,e.m10=(1-(u+d))*b,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}static fromRTSOrigin(e,t,i,n,s){const o=t.x,r=t.y,a=t.z,c=t.w,l=o+o,h=r+r,u=a+a,_=o*l,p=o*h,d=o*u,f=r*h,m=r*u,g=a*u,v=c*l,y=c*h,x=c*u,S=n.x,b=n.y,T=n.z,E=s.x,C=s.y,w=s.z;return e.m00=(1-(f+g))*S,e.m01=(p+x)*S,e.m02=(d-y)*S,e.m03=0,e.m04=(p-x)*b,e.m05=(1-(_+g))*b,e.m06=(m+v)*b,e.m07=0,e.m08=(d+y)*T,e.m09=(m-v)*T,e.m10=(1-(_+f))*T,e.m11=0,e.m12=i.x+E-(e.m00*E+e.m04*C+e.m08*w),e.m13=i.y+C-(e.m01*E+e.m05*C+e.m09*w),e.m14=i.z+w-(e.m02*E+e.m06*C+e.m10*w),e.m15=1,e}static fromQuat(e,t){const i=t.x,n=t.y,s=t.z,o=t.w,r=i+i,a=n+n,c=s+s,l=i*r,h=n*r,u=n*a,_=s*r,p=s*a,d=s*c,f=o*r,m=o*a,g=o*c;return e.m00=1-u-d,e.m01=h+g,e.m02=_-m,e.m03=0,e.m04=h-g,e.m05=1-l-d,e.m06=p+f,e.m07=0,e.m08=_+m,e.m09=p-f,e.m10=1-l-u,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}static frustum(e,t,i,n,s,o,r){const a=1/(i-t),c=1/(s-n),l=1/(o-r);return e.m00=2*o*a,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(i+t)*a,e.m09=(s+n)*c,e.m10=(r+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*o*2*l,e.m15=0,e}static perspective(e,t,i,n,s,o=!0,r=-1,a=1,c=0){const l=1/Math.tan(t/2),h=1/(n-s),u=o?l/i:l,_=(o?l:l*i)*a,p=Qi[c];return e.m00=u*p[0],e.m01=u*p[1],e.m02=0,e.m03=0,e.m04=_*p[2],e.m05=_*p[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(s-r*n)*h,e.m11=-1,e.m12=0,e.m13=0,e.m14=s*n*h*(1-r),e.m15=0,e}static ortho(e,t,i,n,s,o,r,a=-1,c=1,l=0){const h=1/(t-i),u=1/(n-s)*c,_=1/(o-r),p=-2*h,d=-2*u,f=(t+i)*h,m=(s+n)*u,g=Qi[l];return e.m00=p*g[0],e.m01=p*g[1],e.m02=0,e.m03=0,e.m04=d*g[2],e.m05=d*g[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-a),e.m11=0,e.m12=f*g[0]+m*g[2],e.m13=f*g[1]+m*g[3],e.m14=(o-a*r)*_,e.m15=1,e}static lookAt(e,t,i,n){const s=t.x,o=t.y,r=t.z,a=n.x,c=n.y,l=n.z;let h=s-i.x,u=o-i.y,_=r-i.z,p=1/Math.sqrt(h*h+u*u+_*_);h*=p,u*=p,_*=p;let d=c*_-l*u,f=l*h-a*_,m=a*u-c*h;p=1/Math.sqrt(d*d+f*f+m*m),d*=p,f*=p,m*=p;const g=u*m-_*f,v=_*d-h*m,y=h*f-u*d;return e.m00=d,e.m01=g,e.m02=h,e.m03=0,e.m04=f,e.m05=v,e.m06=u,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(d*s+f*o+m*r),e.m13=-(g*s+v*o+y*r),e.m14=-(h*s+u*o+_*r),e.m15=1,e}static inverseTranspose(e,t){const i=t.m00,n=t.m01,s=t.m02,o=t.m03,r=t.m04,a=t.m05,c=t.m06,l=t.m07,h=t.m08,u=t.m09,_=t.m10,p=t.m11,d=t.m12,f=t.m13,m=t.m14,g=t.m15,v=i*a-n*r,y=i*c-s*r,x=i*l-o*r,S=n*c-s*a,b=n*l-o*a,T=s*l-o*c,E=h*f-u*d,C=h*m-_*d,w=h*g-p*d,A=u*m-_*f,P=u*g-p*f,R=_*g-p*m;let I=v*R-y*P+x*A+S*w-b*C+T*E;return I?(I=1/I,e.m00=(a*R-c*P+l*A)*I,e.m01=(c*w-r*R-l*C)*I,e.m02=(r*P-a*w+l*E)*I,e.m03=0,e.m04=(s*P-n*R-o*A)*I,e.m05=(i*R-s*w+o*C)*I,e.m06=(n*w-i*P-o*E)*I,e.m07=0,e.m08=(f*T-m*b+g*S)*I,e.m09=(m*x-d*T-g*y)*I,e.m10=(d*b-f*x+g*v)*I,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}static toArray(e,t,i=0){return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e}static fromArray(e,t,i=0){return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e.m09=t[i+9],e.m10=t[i+10],e.m11=t[i+11],e.m12=t[i+12],e.m13=t[i+13],e.m14=t[i+14],e.m15=t[i+15],e}static add(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}static subtract(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}static multiplyScalar(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}static multiplyScalarAndAdd(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}static strictEquals(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}static equals(e,t,i=ui){return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=i*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=i*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=i*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=i*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=i*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=i*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=i*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}get m00(){return this._array[0]}set m00(e){this._array[0]=e}get m01(){return this._array[1]}set m01(e){this._array[1]=e}get m02(){return this._array[2]}set m02(e){this._array[2]=e}get m03(){return this._array[3]}set m03(e){this._array[3]=e}get m04(){return this._array[4]}set m04(e){this._array[4]=e}get m05(){return this._array[5]}set m05(e){this._array[5]=e}get m06(){return this._array[6]}set m06(e){this._array[6]=e}get m07(){return this._array[7]}set m07(e){this._array[7]=e}get m08(){return this._array[8]}set m08(e){this._array[8]=e}get m09(){return this._array[9]}set m09(e){this._array[9]=e}get m10(){return this._array[10]}set m10(e){this._array[10]=e}get m11(){return this._array[11]}set m11(e){this._array[11]=e}get m12(){return this._array[12]}set m12(e){this._array[12]=e}get m13(){return this._array[13]}set m13(e){this._array[13]=e}get m14(){return this._array[14]}set m14(e){this._array[14]=e}get m15(){return this._array[15]}set m15(e){this._array[15]=e}constructor(e=1,t=0,i=0,n=0,s=0,o=1,r=0,a=0,c=0,l=0,h=1,u=0,_=0,p=0,d=0,f=1){if(super(),e&&"object"==typeof e)if(ArrayBuffer.isView(e))this._array=e,this._array.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);else{const t=e.array;this._array=Bi.createFloatArray(16),this._array[0]=t[0],this._array[1]=t[1],this._array[2]=t[2],this._array[3]=t[3],this._array[4]=t[4],this._array[5]=t[5],this._array[6]=t[6],this._array[7]=t[7],this._array[8]=t[8],this._array[9]=t[9],this._array[10]=t[10],this._array[11]=t[11],this._array[12]=t[12],this._array[13]=t[13],this._array[14]=t[14],this._array[15]=t[15]}else this._array=Bi.createFloatArray(16),this._array[0]=e,this._array[1]=t,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=o,this._array[6]=r,this._array[7]=a,this._array[8]=c,this._array[9]=l,this._array[10]=h,this._array[11]=u,this._array[12]=_,this._array[13]=p,this._array[14]=d,this._array[15]=f}clone(){const e=this._array;return new Zi(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}set(e=1,t=0,i=0,n=0,s=0,o=1,r=0,a=0,c=0,l=0,h=1,u=0,_=0,p=0,d=0,f=1){if(e&&"object"==typeof e){const t=e.array;this._array[1]=t[1],this._array[2]=t[2],this._array[3]=t[3],this._array[4]=t[4],this._array[5]=t[5],this._array[6]=t[6],this._array[7]=t[7],this._array[8]=t[8],this._array[9]=t[9],this._array[10]=t[10],this._array[11]=t[11],this._array[12]=t[12],this._array[13]=t[13],this._array[14]=t[14],this._array[15]=t[15],this._array[0]=t[0]}else this._array[1]=t,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=o,this._array[6]=r,this._array[7]=a,this._array[8]=c,this._array[9]=l,this._array[10]=h,this._array[11]=u,this._array[12]=_,this._array[13]=p,this._array[14]=d,this._array[15]=f,this._array[0]=e;return this}equals(e,t=ui){const i=e.array;return Math.abs(this._array[0]-i[0])<=t*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=t*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=t*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=t*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))&&Math.abs(this._array[4]-i[4])<=t*Math.max(1,Math.abs(this._array[4]),Math.abs(i[4]))&&Math.abs(this._array[5]-i[5])<=t*Math.max(1,Math.abs(this._array[5]),Math.abs(i[5]))&&Math.abs(this._array[6]-i[6])<=t*Math.max(1,Math.abs(this._array[6]),Math.abs(i[6]))&&Math.abs(this._array[7]-i[7])<=t*Math.max(1,Math.abs(this._array[7]),Math.abs(i[7]))&&Math.abs(this._array[8]-i[8])<=t*Math.max(1,Math.abs(this._array[8]),Math.abs(i[8]))&&Math.abs(this._array[9]-i[9])<=t*Math.max(1,Math.abs(this._array[9]),Math.abs(i[9]))&&Math.abs(this._array[10]-i[10])<=t*Math.max(1,Math.abs(this._array[10]),Math.abs(i[10]))&&Math.abs(this._array[11]-i[11])<=t*Math.max(1,Math.abs(this._array[11]),Math.abs(i[11]))&&Math.abs(this._array[12]-i[12])<=t*Math.max(1,Math.abs(this._array[12]),Math.abs(i[12]))&&Math.abs(this._array[13]-i[13])<=t*Math.max(1,Math.abs(this._array[13]),Math.abs(i[13]))&&Math.abs(this._array[14]-i[14])<=t*Math.max(1,Math.abs(this._array[14]),Math.abs(i[14]))&&Math.abs(this._array[15]-i[15])<=t*Math.max(1,Math.abs(this._array[15]),Math.abs(i[15]))}strictEquals(e){const t=e.array;return this._array[0]===e.m00&&this._array[1]===t[1]&&this._array[2]===t[2]&&this._array[3]===t[3]&&this._array[4]===t[4]&&this._array[5]===t[5]&&this._array[6]===t[6]&&this._array[7]===t[7]&&this._array[8]===t[8]&&this._array[9]===t[9]&&this._array[10]===t[10]&&this._array[11]===t[11]&&this._array[12]===t[12]&&this._array[13]===t[13]&&this._array[14]===t[14]&&this._array[15]===t[15]}toString(){return`[\n${this._array[0]}, ${this._array[1]}, ${this._array[2]}, ${this._array[3]},\n${this._array[4]}, ${this._array[5]}, ${this._array[6]}, ${this._array[7]},\n${this._array[8]}, ${this._array[9]}, ${this._array[10]}, ${this._array[11]},\n${this._array[12]}, ${this._array[13]}, ${this._array[14]}, ${this._array[15]}\n]`}identity(){return this._array[0]=1,this._array[1]=0,this._array[2]=0,this._array[3]=0,this._array[4]=0,this._array[5]=1,this._array[6]=0,this._array[7]=0,this._array[8]=0,this._array[9]=0,this._array[10]=1,this._array[11]=0,this._array[12]=0,this._array[13]=0,this._array[14]=0,this._array[15]=1,this}zero(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this}transpose(){const e=this._array[1],t=this._array[2],i=this._array[3],n=this._array[6],s=this._array[7],o=this._array[11];return this._array[1]=this._array[4],this._array[2]=this._array[8],this._array[3]=this._array[12],this._array[4]=e,this._array[6]=this._array[9],this._array[7]=this._array[13],this._array[8]=t,this._array[9]=n,this._array[11]=this._array[14],this._array[12]=i,this._array[13]=s,this._array[14]=o,this}invert(){const e=this._array[0],t=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],o=this._array[5],r=this._array[6],a=this._array[7],c=this._array[8],l=this._array[9],h=this._array[10],u=this._array[11],_=this._array[12],p=this._array[13],d=this._array[14],f=this._array[15],m=e*o-t*s,g=e*r-i*s,v=e*a-n*s,y=t*r-i*o,x=t*a-n*o,S=i*a-n*r,b=c*p-l*_,T=c*d-h*_,E=c*f-u*_,C=l*d-h*p,w=l*f-u*p,A=h*f-u*d;let P=m*A-g*w+v*C+y*E-x*T+S*b;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this._array[0]=(o*A-r*w+a*C)*P,this._array[1]=(i*w-t*A-n*C)*P,this._array[2]=(p*S-d*x+f*y)*P,this._array[3]=(h*x-l*S-u*y)*P,this._array[4]=(r*E-s*A-a*T)*P,this._array[5]=(e*A-i*E+n*T)*P,this._array[6]=(d*v-_*S-f*g)*P,this._array[7]=(c*S-h*v+u*g)*P,this._array[8]=(s*w-o*E+a*b)*P,this._array[9]=(t*E-e*w-n*b)*P,this._array[10]=(_*x-p*v+f*m)*P,this._array[11]=(l*v-c*x-u*m)*P,this._array[12]=(o*T-s*C-r*b)*P,this._array[13]=(e*C-t*T+i*b)*P,this._array[14]=(p*g-_*y-d*m)*P,this._array[15]=(c*y-l*g+h*m)*P,this)}determinant(){const e=this._array[0],t=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],o=this._array[5],r=this._array[6],a=this._array[7],c=this._array[8],l=this._array[9],h=this._array[10],u=this._array[11],_=this._array[12],p=this._array[13],d=this._array[14],f=this._array[15];return(e*o-t*s)*(h*f-u*d)-(e*r-i*s)*(l*f-u*p)+(e*a-n*s)*(l*d-h*p)+(t*r-i*o)*(c*f-u*_)-(t*a-n*o)*(c*d-h*_)+(i*a-n*r)*(c*p-l*_)}add(e){const t=e.array;return this._array[0]+=t[0],this._array[1]+=t[1],this._array[2]+=t[2],this._array[3]+=t[3],this._array[4]+=t[4],this._array[5]+=t[5],this._array[6]+=t[6],this._array[7]+=t[7],this._array[8]+=t[8],this._array[9]+=t[9],this._array[10]+=t[10],this._array[11]+=t[11],this._array[12]+=t[12],this._array[13]+=t[13],this._array[14]+=t[14],this._array[15]+=t[15],this}subtract(e){const t=e.array;return this._array[0]-=t[0],this._array[1]-=t[1],this._array[2]-=t[2],this._array[3]-=t[3],this._array[4]-=t[4],this._array[5]-=t[5],this._array[6]-=t[6],this._array[7]-=t[7],this._array[8]-=t[8],this._array[9]-=t[9],this._array[10]-=t[10],this._array[11]-=t[11],this._array[12]-=t[12],this._array[13]-=t[13],this._array[14]-=t[14],this._array[15]-=t[15],this}multiply(e){const t=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],o=this._array[4],r=this._array[5],a=this._array[6],c=this._array[7],l=this._array[8],h=this._array[9],u=this._array[10],_=this._array[11],p=this._array[12],d=this._array[13],f=this._array[14],m=this._array[15],g=e.array;let v=g[0],y=g[1],x=g[2],S=g[3];return this._array[0]=v*t+y*o+x*l+S*p,this._array[1]=v*i+y*r+x*h+S*d,this._array[2]=v*n+y*a+x*u+S*f,this._array[3]=v*s+y*c+x*_+S*m,v=g[4],y=g[5],x=g[6],S=g[7],this._array[4]=v*t+y*o+x*l+S*p,this._array[5]=v*i+y*r+x*h+S*d,this._array[6]=v*n+y*a+x*u+S*f,this._array[7]=v*s+y*c+x*_+S*m,v=g[8],y=g[9],x=g[10],S=g[11],this._array[8]=v*t+y*o+x*l+S*p,this._array[9]=v*i+y*r+x*h+S*d,this._array[10]=v*n+y*a+x*u+S*f,this._array[11]=v*s+y*c+x*_+S*m,v=g[12],y=g[13],x=g[14],S=g[15],this._array[12]=v*t+y*o+x*l+S*p,this._array[13]=v*i+y*r+x*h+S*d,this._array[14]=v*n+y*a+x*u+S*f,this._array[15]=v*s+y*c+x*_+S*m,this}multiplyScalar(e){return this._array[0]*=e,this._array[1]*=e,this._array[2]*=e,this._array[3]*=e,this._array[4]*=e,this._array[5]*=e,this._array[6]*=e,this._array[7]*=e,this._array[8]*=e,this._array[9]*=e,this._array[10]*=e,this._array[11]*=e,this._array[12]*=e,this._array[13]*=e,this._array[14]*=e,this._array[15]*=e,this}translate(e){console.warn("function changed");const t=e.array;return this._array[12]+=t[0],this._array[13]+=t[1],this._array[14]+=t[2],this}scale(e){const t=e.array,i=t[0],n=t[1],s=t[2];return this._array[0]*=i,this._array[1]*=i,this._array[2]*=i,this._array[3]*=i,this._array[4]*=n,this._array[5]*=n,this._array[6]*=n,this._array[7]*=n,this._array[8]*=s,this._array[9]*=s,this._array[10]*=s,this._array[11]*=s,this}rotate(e,t){let i=t.x,n=t.y,s=t.z,o=Math.sqrt(i*i+n*n+s*s);if(Math.abs(o)<ui)return null;o=1/o,i*=o,n*=o,s*=o;const r=Math.sin(e),a=Math.cos(e),c=1-a,l=this._array[0],h=this._array[1],u=this._array[2],_=this._array[3],p=this._array[4],d=this._array[5],f=this._array[6],m=this._array[7],g=this._array[8],v=this._array[9],y=this._array[10],x=this._array[11],S=i*i*c+a,b=n*i*c+s*r,T=s*i*c-n*r,E=i*n*c-s*r,C=n*n*c+a,w=s*n*c+i*r,A=i*s*c+n*r,P=n*s*c-i*r,R=s*s*c+a;return this._array[0]=l*S+p*b+g*T,this._array[1]=h*S+d*b+v*T,this._array[2]=u*S+f*b+y*T,this._array[3]=_*S+m*b+x*T,this._array[4]=l*E+p*C+g*w,this._array[5]=h*E+d*C+v*w,this._array[6]=u*E+f*C+y*w,this._array[7]=_*E+m*C+x*w,this._array[8]=l*A+p*P+g*R,this._array[9]=h*A+d*P+v*R,this._array[10]=u*A+f*P+y*R,this._array[11]=_*A+m*P+x*R,this}getTranslation(e){return e.x=this._array[12],e.y=this._array[13],e.z=this._array[14],e}getScale(e){const t=e.array,i=en.array,n=i[0]=this._array[0],s=i[1]=this._array[1],o=i[2]=this._array[2],r=i[3]=this._array[4],a=i[4]=this._array[5],c=i[5]=this._array[6],l=i[6]=this._array[8],h=i[7]=this._array[9],u=i[8]=this._array[10];return t[0]=Math.sqrt(n*n+s*s+o*o),t[1]=Math.sqrt(r*r+a*a+c*c),t[2]=Math.sqrt(l*l+h*h+u*u),ki.determinant(en)<0&&(e.x*=-1),e}getRotation(e){const t=this._array[0]+this._array[5]+this._array[10];let i=0;return t>0?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this._array[6]-this._array[9])/i,e.y=(this._array[8]-this._array[2])/i,e.z=(this._array[1]-this._array[4])/i):this._array[0]>this._array[5]&&this._array[0]>this._array[10]?(i=2*Math.sqrt(1+this._array[0]-this._array[5]-this._array[10]),e.w=(this._array[6]-this._array[9])/i,e.x=.25*i,e.y=(this._array[1]+this._array[4])/i,e.z=(this._array[8]+this._array[2])/i):this._array[5]>this._array[10]?(i=2*Math.sqrt(1+this._array[5]-this._array[0]-this._array[10]),e.w=(this._array[8]-this._array[2])/i,e.x=(this._array[1]+this._array[4])/i,e.y=.25*i,e.z=(this._array[6]+this._array[9])/i):(i=2*Math.sqrt(1+this._array[10]-this._array[0]-this._array[5]),e.w=(this._array[1]-this._array[4])/i,e.x=(this._array[8]+this._array[2])/i,e.y=(this._array[6]+this._array[9])/i,e.z=.25*i),e}fromRTS(e,t,i){const n=e.x,s=e.y,o=e.z,r=e.w,a=n+n,c=s+s,l=o+o,h=n*a,u=n*c,_=n*l,p=s*c,d=s*l,f=o*l,m=r*a,g=r*c,v=r*l,y=i.x,x=i.y,S=i.z;return this._array[0]=(1-(p+f))*y,this._array[1]=(u+v)*y,this._array[2]=(_-g)*y,this._array[3]=0,this._array[4]=(u-v)*x,this._array[5]=(1-(h+f))*x,this._array[6]=(d+m)*x,this._array[7]=0,this._array[8]=(_+g)*S,this._array[9]=(d-m)*S,this._array[10]=(1-(h+p))*S,this._array[11]=0,this._array[12]=t.x,this._array[13]=t.y,this._array[14]=t.z,this._array[15]=1,this}fromQuat(e){const t=e.x,i=e.y,n=e.z,s=e.w,o=t+t,r=i+i,a=n+n,c=t*o,l=i*o,h=i*r,u=n*o,_=n*r,p=n*a,d=s*o,f=s*r,m=s*a;return this._array[0]=1-h-p,this._array[1]=l+m,this._array[2]=u-f,this._array[3]=0,this._array[4]=l-m,this._array[5]=1-c-p,this._array[6]=_+d,this._array[7]=0,this._array[8]=u+f,this._array[9]=_-d,this._array[10]=1-c-h,this._array[11]=0,this._array[12]=0,this._array[13]=0,this._array[14]=0,this._array[15]=1,this}}e("Mat4",Zi),Zi.IDENTITY=Object.freeze(new Zi);const Ji=new zi,en=new ki;function tn(e,t,i,n,s,o,r,a,c,l,h,u,_,p,d,f){return new Zi(e,t,i,n,s,o,r,a,c,l,h,u,_,p,d,f)}Mi(Zi.prototype,["m00","m01","m02","m03","m04","m05","m06","m07","m08","m09","m10","m11","m12","m13","m14","m15"]),wt.fastDefine("cc.Mat4",Zi,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),n.Mat4=Zi,n.mat4=tn;class nn extends Ue{static clone(e){return new nn(e.x,e.y)}static copy(e,t){return e.x=t.x,e.y=t.y,e}static set(e,t,i){return e.x=t,e.y=i,e}static add(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}static subtract(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}static multiply(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}static divide(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}static ceil(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}static floor(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}static min(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}static max(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}static round(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}static multiplyScalar(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}static scaleAndAdd(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}static distance(e,t){const i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}static squaredDistance(e,t){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}static len(e){const t=e.x,i=e.y;return Math.sqrt(t*t+i*i)}static lengthSqr(e){const t=e.x,i=e.y;return t*t+i*i}static negate(e,t){return e.x=-t.x,e.y=-t.y,e}static inverse(e,t){return e.x=1/t.x,e.y=1/t.y,e}static inverseSafe(e,t){const i=t.x,n=t.y;return Math.abs(i)<ui?e.x=0:e.x=1/i,Math.abs(n)<ui?e.y=0:e.y=1/n,e}static normalize(e,t){const i=t.x,n=t.y;let s=i*i+n*n;return s>0&&(s=1/Math.sqrt(s),e.x=i*s,e.y=n*s),e}static dot(e,t){return e.x*t.x+e.y*t.y}static cross(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}static lerp(e,t,i,n){const s=t.x,o=t.y;return e.x=s+n*(i.x-s),e.y=o+n*(i.y-o),e}static random(e,t){t=t||1;const i=2*yi()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}static transformMat3(e,t,i){const n=t.x,s=t.y;return e.x=i.m00*n+i.m03*s+i.m06,e.y=i.m01*n+i.m04*s+i.m07,e}static transformMat4(e,t,i){const n=t.x,s=t.y;return e.x=i.m00*n+i.m04*s+i.m12,e.y=i.m01*n+i.m05*s+i.m13,e}static str(e){return`Vec2(${e.x}, ${e.y})`}static toArray(e,t,i=0){return e[i+0]=t.x,e[i+1]=t.y,e}static fromArray(e,t,i=0){return e.x=t[i+0],e.y=t[i+1],e}static strictEquals(e,t){return e.x===t.x&&e.y===t.y}static equals(e,t,i=ui){return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))}static angle(e,t){nn.normalize(sn,e),nn.normalize(on,t);const i=nn.dot(sn,on);return i>1?0:i<-1?Math.PI:Math.acos(i)}constructor(e,t){super(),e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0)}clone(){return new nn(this.x,this.y)}set(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}equals(e,t=ui){return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))}equals2f(e,t,i=ui){return Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))}strictEquals(e){return e&&this.x===e.x&&this.y===e.y}strictEquals2f(e,t){return this.x===e&&this.y===t}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}lerp(e,t){const i=this.x,n=this.y;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this}clampf(e,t){return this.x=di(this.x,e.x,t.x),this.y=di(this.y,e.y,t.y),this}add(e){return this.x+=e.x,this.y+=e.y,this}add2f(e,t){return this.x+=e,this.y+=t,this}subtract(e){return this.x-=e.x,this.y-=e.y,this}subtract2f(e,t){return this.x-=e,this.y-=t,this}multiplyScalar(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this}multiply(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this}multiply2f(e,t){return this.x*=e,this.y*=t,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divide2f(e,t){return this.x/=e,this.y/=t,this}negative(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqr(){return this.x*this.x+this.y*this.y}normalize(){const e=this.x,t=this.y;let i=e*e+t*t;return i>0&&(i=1/Math.sqrt(i),this.x*=i,this.y*=i),this}angle(e){const t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;let n=this.dot(e)/Math.sqrt(t*i);return n=di(n,-1,1),Math.acos(n)}signAngle(e){const t=this.angle(e);return this.cross(e)<0?-t:t}rotate(e){const t=this.x,i=this.y,n=Math.sin(e),s=Math.cos(e);return this.x=s*t-n*i,this.y=n*t+s*i,this}project(e){const t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}transformMat4(e){const t=this.x,i=this.y;return this.x=e.m00*t+e.m04*i+e.m12,this.y=e.m01*t+e.m05*i+e.m13,this}}e("Vec2",nn),nn.ZERO=Object.freeze(new nn(0,0)),nn.ONE=Object.freeze(new nn(1,1)),nn.NEG_ONE=Object.freeze(new nn(-1,-1)),nn.UNIT_X=Object.freeze(new nn(1,0)),nn.UNIT_Y=Object.freeze(new nn(0,1));const sn=new nn,on=new nn;function rn(e,t){return new nn(e,t)}wt.fastDefine("cc.Vec2",nn,{x:0,y:0}),n.Vec2=nn,n.v2=rn;class an extends Ue{static clone(e){return new an(e.x,e.y,e.z,e.w)}static copy(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}static set(e,t,i,n,s){return e.x=t,e.y=i,e.z=n,e.w=s,e}static add(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}static subtract(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}static multiply(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}static divide(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}static ceil(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}static floor(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}static min(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}static max(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}static round(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}static multiplyScalar(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}static scaleAndAdd(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}static distance(e,t){const i=t.x-e.x,n=t.y-e.y,s=t.z-e.z,o=t.w-e.w;return Math.sqrt(i*i+n*n+s*s+o*o)}static squaredDistance(e,t){const i=t.x-e.x,n=t.y-e.y,s=t.z-e.z,o=t.w-e.w;return i*i+n*n+s*s+o*o}static len(e){const t=e.x,i=e.y,n=e.z,s=e.w;return Math.sqrt(t*t+i*i+n*n+s*s)}static lengthSqr(e){const t=e.x,i=e.y,n=e.z,s=e.w;return t*t+i*i+n*n+s*s}static negate(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}static inverse(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}static inverseSafe(e,t){const i=t.x,n=t.y,s=t.z,o=t.w;return Math.abs(i)<ui?e.x=0:e.x=1/i,Math.abs(n)<ui?e.y=0:e.y=1/n,Math.abs(s)<ui?e.z=0:e.z=1/s,Math.abs(o)<ui?e.w=0:e.w=1/o,e}static normalize(e,t){const i=t.x,n=t.y,s=t.z,o=t.w;let r=i*i+n*n+s*s+o*o;return r>0&&(r=1/Math.sqrt(r),e.x=i*r,e.y=n*r,e.z=s*r,e.w=o*r),e}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static lerp(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}static random(e,t){t=t||1;const i=2*yi()*Math.PI,n=2*yi()-1,s=Math.sqrt(1-n*n);return e.x=s*Math.cos(i)*t,e.y=s*Math.sin(i)*t,e.z=n*t,e.w=0,e}static transformMat4(e,t,i){const n=t.x,s=t.y,o=t.z,r=t.w;return e.x=i.m00*n+i.m04*s+i.m08*o+i.m12*r,e.y=i.m01*n+i.m05*s+i.m09*o+i.m13*r,e.z=i.m02*n+i.m06*s+i.m10*o+i.m14*r,e.w=i.m03*n+i.m07*s+i.m11*o+i.m15*r,e}static transformAffine(e,t,i){const n=t.x,s=t.y,o=t.z,r=t.w;return e.x=i.m00*n+i.m01*s+i.m02*o+i.m03*r,e.y=i.m04*n+i.m05*s+i.m06*o+i.m07*r,e.x=i.m08*n+i.m09*s+i.m10*o+i.m11*r,e.w=t.w,e}static transformQuat(e,t,i){const{x:n,y:s,z:o}=t,r=i.x,a=i.y,c=i.z,l=i.w,h=l*n+a*o-c*s,u=l*s+c*n-r*o,_=l*o+r*s-a*n,p=-r*n-a*s-c*o;return e.x=h*l+p*-r+u*-c-_*-a,e.y=u*l+p*-a+_*-r-h*-c,e.z=_*l+p*-c+h*-a-u*-r,e.w=t.w,e}static toArray(e,t,i=0){return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}static fromArray(e,t,i=0){return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}static strictEquals(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}static equals(e,t,i=ui){return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}constructor(e,t,i,n){super(),e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0)}clone(){return new an(this.x,this.y,this.z,this.w)}set(e,t,i,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0),this}equals(e,t=ui){return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}equals4f(e,t,i,n,s=ui){return Math.abs(this.x-e)<=s*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=s*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=s*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=s*Math.max(1,Math.abs(this.w),Math.abs(n))}strictEquals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}strictEquals4f(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}lerp(e,t){const i=this.x,n=this.y,s=this.z,o=this.w;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this.z=s+t*(e.z-s),this.w=o+t*(e.w-o),this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)}, ${this.w.toFixed(2)})`}clampf(e,t){return this.x=di(this.x,e.x,t.x),this.y=di(this.y,e.y,t.y),this.z=di(this.z,e.z,t.z),this.w=di(this.w,e.w,t.w),this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add4f(e,t,i,n){return this.x+=e,this.y+=t,this.z+=i,this.w+=n,this}subtract(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract4f(e,t,i,n){return this.x-=e,this.y-=t,this.z-=i,this.w-=n,this}multiplyScalar(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}multiply(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply4f(e,t,i,n){return this.x*=e,this.y*=t,this.z*=i,this.w*=n,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divide4f(e,t,i,n){return this.x/=e,this.y/=t,this.z/=i,this.w/=n,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}cross(e){const{x:t,y:i,z:n}=this,{x:s,y:o,z:r}=e;return this.x=i*r-n*o,this.y=n*s-t*r,this.z=t*o-i*s,this}length(){const e=this.x,t=this.y,i=this.z,n=this.w;return Math.sqrt(e*e+t*t+i*i+n*n)}lengthSqr(){const e=this.x,t=this.y,i=this.z,n=this.w;return e*e+t*t+i*i+n*n}normalize(){const e=this.x,t=this.y,i=this.z,n=this.w;let s=e*e+t*t+i*i+n*n;return s>0&&(s=1/Math.sqrt(s),this.x=e*s,this.y=t*s,this.z=i*s,this.w=n*s),this}transformMat4(e){const t=this.x,i=this.y,n=this.z,s=this.w;return this.x=e.m00*t+e.m04*i+e.m08*n+e.m12*s,this.y=e.m01*t+e.m05*i+e.m09*n+e.m13*s,this.z=e.m02*t+e.m06*i+e.m10*n+e.m14*s,this.w=e.m03*t+e.m07*i+e.m11*n+e.m15*s,this}}function cn(e,t,i,n){return new an(e,t,i,n)}e("Vec4",an),an.ZERO=Object.freeze(new an(0,0,0,0)),an.ONE=Object.freeze(new an(1,1,1,1)),an.NEG_ONE=Object.freeze(new an(-1,-1,-1,-1)),wt.fastDefine("cc.Vec4",an,{x:0,y:0,z:0,w:0}),n.Vec4=an,n.v4=cn,ei(nn,"Vec2",[{name:"sub",newName:"subtract",target:nn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:nn,targetName:"Vec2"},{name:"div",newName:"divide",target:nn,targetName:"Vec2"},{name:"dist",newName:"distance",target:nn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:nn,targetName:"Vec2"},{name:"mag",newName:"len",target:nn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:nn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:nn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:nn,targetName:"Vec2"}]),ei(nn.prototype,"Vec2",[{name:"mag",newName:"length",target:nn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:nn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:nn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:nn.prototype,targetName:"Vec2"}]),ei(zi,"Vec3",[{name:"sub",newName:"subtract",target:zi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:zi,targetName:"Vec3"},{name:"div",newName:"divide",target:zi,targetName:"Vec3"},{name:"dist",newName:"distance",target:zi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:zi,targetName:"Vec3"},{name:"mag",newName:"len",target:zi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:zi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:zi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:zi,targetName:"Vec3"}]),ei(zi.prototype,"Vec3",[{name:"mag",newName:"length",target:zi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:zi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:zi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:zi.prototype,targetName:"Vec3"}]),ei(an,"Vec4",[{name:"sub",newName:"subtract",target:an,targetName:"Vec4"},{name:"mul",newName:"multiply",target:an,targetName:"Vec4"},{name:"div",newName:"divide",target:an,targetName:"Vec4"},{name:"dist",newName:"distance",target:an,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:an,targetName:"Vec4"},{name:"mag",newName:"len",target:an,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:an,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:an,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:an,targetName:"Vec4"}]),ei(an.prototype,"Vec4",[{name:"mag",newName:"length",target:an.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:an.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:an.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:an.prototype,targetName:"Vec4"}]),ei(ji,"Quat",[{name:"mag",newName:"len",target:ji,targetName:"Quat"},{name:"mul",newName:"multiply",target:ji,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:ji,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:ji,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:ji,targetName:"Quat"}]),ei(ji.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:ji.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:ji.prototype,targetName:"Quat"}]),ei(Di,"Color",[{name:"sub",newName:"subtract",target:Di,targetName:"Color"},{name:"mul",newName:"multiply",target:Di,targetName:"Color"},{name:"div",newName:"divide",target:Di,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Di,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction(...e){const t=e[1].toString(16);return n.Color.fromHEX(e[0],t)}}]),ei(ki,"Mat3",[{name:"sub",newName:"subtract",target:ki,targetName:"Mat3"},{name:"mul",newName:"multiply",target:ki,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:ki,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:ki,targetName:"Mat3"}]),ei(ki.prototype,"Mat3",[{name:"sub",newName:"subtract",target:ki.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:ki.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:ki.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:ki.prototype,targetName:"Mat3"}]),ei(Zi,"Mat4",[{name:"sub",newName:"subtract",target:Zi,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Zi,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Zi,targetName:"Mat4"}]),ei(Zi.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Zi.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Zi.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Zi.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Zi.prototype,targetName:"Mat4"}]);class ln{static identity(){return new ln}static clone(e){return new ln(e.a,e.b,e.c,e.d,e.tx,e.ty)}static concat(e,t,i){const n=t.a,s=t.b,o=t.c,r=t.d,a=t.tx,c=t.ty;e.a=n*i.a+s*i.c,e.b=n*i.b+s*i.d,e.c=o*i.a+r*i.c,e.d=o*i.b+r*i.d,e.tx=a*i.a+c*i.c+i.tx,e.ty=a*i.b+c*i.d+i.ty}static invert(e,t){const i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}static fromMat4(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}static transformVec2(e,t,i,n){let s,o;void 0===n?(n=i,s=t.x,o=t.y):(s=t,o=i),e.x=n.a*s+n.c*o+n.tx,e.y=n.b*s+n.d*o+n.ty}static transformSize(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}static transformRect(e,t,i){const n=t.x+t.width,s=t.y+t.height,o=i.a*t.x+i.c*t.y+i.tx,r=i.b*t.x+i.d*t.y+i.ty,a=i.a*n+i.c*t.y+i.tx,c=i.b*n+i.d*t.y+i.ty,l=i.a*t.x+i.c*s+i.tx,h=i.b*t.x+i.d*s+i.ty,u=i.a*n+i.c*s+i.tx,_=i.b*n+i.d*s+i.ty,p=Math.min(o,a,l,u),d=Math.max(o,a,l,u),f=Math.min(r,c,h,_),m=Math.max(r,c,h,_);e.x=p,e.y=f,e.width=d-p,e.height=m-f}static transformObb(e,t,i,n,s,o){const r=o.a*s.x+o.c*s.y+o.tx,a=o.b*s.x+o.d*s.y+o.ty,c=o.a*s.width,l=o.b*s.width,h=o.c*s.height,u=o.d*s.height;t.x=r,t.y=a,i.x=c+r,i.y=l+a,e.x=h+r,e.y=u+a,n.x=c+h+r,n.y=l+u+a}constructor(e=1,t=0,i=0,n=1,s=0,o=0){this.a=e,this.b=t,this.c=i,this.d=n,this.tx=s,this.ty=o}}e("AffineTransform",ln),n.AffineTransform=ln;class hn extends Ue{static lerp(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}set x(e){this.width=e}get x(){return this.width}set y(e){this.height=e}get y(){return this.height}constructor(e,t){super(),e&&"object"==typeof e?(this.width=e.width,this.height=e.height):(this.width=e||0,this.height=t||0)}clone(){return new hn(this.width,this.height)}set(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}equals(e){return this.width===e.width&&this.height===e.height}lerp(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this}toString(){return`(${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}}function un(e=0,t=0){return new hn(e,t)}e("Size",hn),hn.ZERO=Object.freeze(new hn(0,0)),hn.ONE=Object.freeze(new hn(1,1)),wt.fastDefine("cc.Size",hn,{width:0,height:0}),n.size=un,n.Size=hn;class _n extends Ue{static fromMinMax(e,t,i){const n=Math.min(t.x,i.x),s=Math.min(t.y,i.y),o=Math.max(t.x,i.x),r=Math.max(t.y,i.y);return e.x=n,e.y=s,e.width=o-n,e.height=r-s,e}static lerp(e,t,i,n){const s=t.x,o=t.y,r=t.width,a=t.height;return e.x=s+(i.x-s)*n,e.y=o+(i.y-o)*n,e.width=r+(i.width-r)*n,e.height=a+(i.height-a)*n,e}static intersection(e,t,i){const n=t.x,s=t.y,o=t.x+t.width,r=t.y+t.height,a=i.x,c=i.y,l=i.x+i.width,h=i.y+i.height;return e.x=Math.max(n,a),e.y=Math.max(s,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(r,h)-e.y,e}static union(e,t,i){const n=t.x,s=t.y,o=t.width,r=t.height,a=i.x,c=i.y,l=i.width,h=i.height;return e.x=Math.min(n,a),e.y=Math.min(s,c),e.width=Math.max(n+o,a+l)-e.x,e.height=Math.max(s+r,c+h)-e.y,e}get xMin(){return this.x}set xMin(e){this.width+=this.x-e,this.x=e}get yMin(){return this.y}set yMin(e){this.height+=this.y-e,this.y=e}get xMax(){return this.x+this.width}set xMax(e){this.width=e-this.x}get yMax(){return this.y+this.height}set yMax(e){this.height=e-this.y}get center(){return new nn(this.x+.5*this.width,this.y+.5*this.height)}set center(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}get origin(){return new nn(this.x,this.y)}set origin(e){this.x=e.x,this.y=e.y}get size(){return new hn(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}set z(e){this.width=e}get z(){return this.width}set w(e){this.height=e}get w(){return this.height}constructor(e,t,i,n){super(),e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0)}clone(){return new _n(this.x,this.y,this.width,this.height)}set(e,t,i,n){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0),this}equals(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}lerp(e,t){const i=this.x,n=this.y,s=this.width,o=this.height;return this.x=i+(e.x-i)*t,this.y=n+(e.y-n)*t,this.width=s+(e.width-s)*t,this.height=o+(e.height-o)*t,this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}intersects(e){const t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,s=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||s<this.y)}contains(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}containsRect(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}transformMat4(e){const t=this.x,i=this.y,n=t+this.width,s=i+this.height,o=e.m00*t+e.m04*i+e.m12,r=e.m01*t+e.m05*i+e.m13,a=e.m00*n+e.m04*i+e.m12,c=e.m01*n+e.m05*i+e.m13,l=e.m00*t+e.m04*s+e.m12,h=e.m01*t+e.m05*s+e.m13,u=e.m00*n+e.m04*s+e.m12,_=e.m01*n+e.m05*s+e.m13,p=Math.min(o,a,l,u),d=Math.max(o,a,l,u),f=Math.min(r,c,h,_),m=Math.max(r,c,h,_);return this.x=p,this.y=f,this.width=d-p,this.height=m-f,this}transformMat4ToPoints(e,t,i,n,s){const o=this.x,r=this.y,a=o+this.width,c=r+this.height;t.x=e.m00*o+e.m04*r+e.m12,t.y=e.m01*o+e.m05*r+e.m13,s.x=e.m00*a+e.m04*r+e.m12,s.y=e.m01*a+e.m05*r+e.m13,i.x=e.m00*o+e.m04*c+e.m12,i.y=e.m01*o+e.m05*c+e.m13,n.x=e.m00*a+e.m04*c+e.m12,n.y=e.m01*a+e.m05*c+e.m13}}function pn(e=0,t=0,i=0,n=0){return new _n(e,t,i,n)}e("Rect",_n),wt.fastDefine("cc.Rect",_n,{x:0,y:0,width:0,height:0}),n.Rect=_n,n.rect=pn;var dn=Object.freeze({__proto__:null,bits:Jt,Vec2:nn,v2:rn,Vec3:zi,v3:Gi,Vec4:an,v4:cn,Quat:ji,quat:$i,Mat3:ki,Mat4:Zi,mat4:tn,AffineTransform:ln,Size:hn,size:un,Rect:_n,rect:pn,Color:Di,color:Ni,EPSILON:ui,equals:_i,approx:pi,clamp:di,clamp01:fi,lerp:mi,toRadian:gi,toDegree:vi,random:yi,randomRange:xi,randomRangeInt:Si,pseudoRandom:bi,pseudoRandomRange:Ti,pseudoRandomRangeInt:Ei,nextPow2:Ci,repeat:wi,pingPong:Ai,inverseLerp:Pi,absMaxComponent:Ri,absMax:Ii,enumerableProps:Mi,MATH_FLOAT_ARRAY:Li,MathBase:Bi});let fn;e("math",dn),function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE"}(fn||(fn={}));const mn={0:fn.PORTRAIT,"-90":fn.LANDSCAPE_LEFT,90:fn.LANDSCAPE_RIGHT,180:fn.PORTRAIT_UPSIDE_DOWN},gn=new class extends Vt{constructor(){super(),this._registerEvent()}_registerEvent(){jsb.onResize=e=>{0!==e.width&&0!==e.height&&(e.width/=qt.pixelRatio,e.height/=qt.pixelRatio,window.resize(e.width,e.height),this.emit("window-resize"))},jsb.onOrientationChanged=()=>{this.emit("orientation-change")}}get supportFullScreen(){return!1}get isFullScreen(){return!1}get windowSize(){return new hn(window.innerWidth,window.innerHeight)}set windowSize(e){console.warn("Setting window size is not supported yet.")}get orientation(){return mn[jsb.device.getDeviceOrientation()]}get safeAreaEdge(){const e=jsb.device.getSafeAreaEdge();let t=e.x,i=e.z,n=e.y,s=e.w;return this.orientation===fn.PORTRAIT?t<i?t=i:i=t:n<s?n=s:s=n,{top:t,bottom:i,left:n,right:s}}requestFullScreen(){return Promise.reject(new Error("request fullscreen has not been supported yet on this platform."))}exitFullScreen(){return Promise.reject(new Error("exit fullscreen has not been supported yet on this platform."))}},vn=gn.windowSize,yn=qt.pixelRatio,xn=e("sys",{NetworkType:L,Language:N,OS:B,Platform:z,BrowserType:D,isNative:qt.isNative,isBrowser:qt.isBrowser,isMobile:qt.isMobile,isLittleEndian:qt.isLittleEndian,platform:qt.platform,language:qt.language,languageCode:qt.nativeLanguage,os:qt.os,osVersion:qt.osVersion,osMainVersion:qt.osMainVersion,browserType:qt.browserType,browserVersion:qt.browserVersion,windowPixelResolution:{width:vn.width*yn,height:vn.height*yn},capabilities:{canvas:qt.supportCapability.canvas,opengl:qt.supportCapability.gl,webp:qt.supportCapability.webp,imageBitmap:qt.supportCapability.imageBitmap,touches:!1,mouse:!1,keyboard:!1,accelerometer:!1},localStorage:{},getNetworkType:()=>qt.networkType,getBatteryLevel:()=>qt.getBatteryLevel(),garbageCollect(){qt.triggerGC()},isObjectValid:e=>null!=e,dump(){let e="";e+=`isMobile : ${this.isMobile}\r\n`,e+=`language : ${this.language}\r\n`,e+=`browserType : ${this.browserType}\r\n`,e+=`browserVersion : ${this.browserVersion}\r\n`,e+=`capabilities : ${JSON.stringify(this.capabilities)}\r\n`,e+=`os : ${this.os}\r\n`,e+=`osVersion : ${this.osVersion}\r\n`,e+=`platform : ${this.platform}\r\n`,e+=`Using ${n.game.renderType===n.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"} renderer.\r\n`,_(e)},openURL(e){qt.openURL(e)},now:()=>qt.now(),restartVM(){qt.restartJSVM()},getSafeAreaRect(){const e=n.view,t=gn.safeAreaEdge,i=gn.windowSize,s=new nn(t.left,i.height-t.bottom),o=new nn(i.width-t.right,t.top),r={left:0,top:0,width:i.width,height:i.height};e.convertToLocationInView(s.x,s.y,r,s),e.convertToLocationInView(o.x,o.y,r,o),e._convertPointWithScale(s),e._convertPointWithScale(o);const a=s.x,c=s.y,l=o.x-s.x,h=o.y-s.y;return new _n(a,c,l,h)}});!function(){try{let e=xn.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){const t=function(){T(5200)};xn.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}const e=window,t=e.navigator,i=document,n=i.documentElement,s=xn.capabilities;(void 0!==n.ontouchstart||void 0!==i.ontouchstart||t.msPointerEnabled)&&(s.touches=!0),void 0!==n.onmouseup&&(s.mouse=!0),void 0!==n.onkeyup&&(s.keyboard=!0),(e.DeviceMotionEvent||e.DeviceOrientationEvent)&&(s.accelerometer=!0),xn.__isWebIOS14OrIPadOS14Env=(xn.os===B.IOS||xn.os===B.OSX)&&qt.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent),gn.on("window-resize",(()=>{const e=gn.windowSize;xn.windowPixelResolution={width:Math.round(e.width*yn),height:Math.round(e.height*yn)}}))}(),n.sys=xn;const Sn=/(\.[^\.\/\?\\]*)(\?.*)?$/,bn=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Tn=/[^\.\/]+\/\.\.\//;function En(...e){let t="";for(const i of e)t=(t+(""===t?"":"/")+i).replace(/(\/|\\\\)$/,"");return t}function Cn(e){const t=Sn.exec(e);return t?t[1]:""}function wn(e){if(e){const t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function An(e,t){const i=e.indexOf("?");i>0&&(e=e.substring(0,i));const n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return e;const s=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?s.substring(0,s.length-t.length):s}function Pn(e){const t=bn.exec(e);return t?t[2]:""}function Rn(e,t){t=t||"";let i=e.indexOf("?"),n="";return i>0&&(n=e.substring(i),e=e.substring(0,i)),i=e.lastIndexOf("."),i<0?e+t+n:e.substring(0,i)+t+n}function In(e,t,i){if(0===t.indexOf("."))return Rn(e,t);let n=e.indexOf("?"),s="";const o=i?Cn(e):"";return n>0&&(s=e.substring(n),e=e.substring(0,n)),n=e.lastIndexOf("/"),n=n<=0?0:n+1,e.substring(0,n)+t+o+s}function Mn(e){let t=e=String(e);do{t=e,e=e.replace(Tn,"")}while(t.length!==e.length);return e}function On(e){return e.replace(/[\/\\]$/,"")}function Dn(){return xn.os===B.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:En,extname:Cn,mainFileName:wn,basename:An,dirname:Pn,changeExtname:Rn,changeBasename:In,_normalize:Mn,stripSep:On,getSeperator:Dn})),n.log=_,n.warn=p,n.error=d,n.assert=f,n._throw=v,n.logID=S,n.warnID=T,n.errorID=C,n.assertID=A,n.debug=O,n.path={join:En,extname:Cn,mainFileName:wn,basename:An,dirname:Pn,changeExtname:Rn,changeBasename:In,_normalize:Mn,stripSep:On,get sep(){return Dn()}};let Nn=0;const Ln={};var Bn={addStage(e){if(void 0!==Ln[e])return;const t=1<<Nn;Ln[e]=t,Nn+=1},stageID(e){const t=Ln[e];return void 0===t?-1:t},stageIDs(e){let t=0;for(const i of e){const e=Ln[i];void 0!==e&&(t|=e)}return t}};const zn=ns.Node,Fn=ns.Scene,Un=ns.Model,Gn=ns.SkinningModel,kn=ns.BakedSkinningModel,Hn=ns.light,Vn=ns.DirectionalLight,jn=ns.SpotLight,Wn=ns.SphereLight,qn=ns.Skybox,Xn=ns.Fog,Yn=ns.Ambient,Kn=ns.Shadow,$n=ns.Camera,Qn=ns.RenderWindow,Zn=ns.RenderScene,Jn=ns.DrawBatch2D,es=ns.Pass,ts=ns.SubModel,is=ns.Root,ss=ns.PipelineSharedSceneData,os=ns.AABB;class rs{get colorArray(){return this._colorArray}get albedoArray(){return this._albedoArray}set enabled(e){this._enabled=e,this._nativeObj.enabled=e}get enabled(){return this._enabled}get skyColor(){return this._skyColor}set skyColor(e){this._skyColor.set(e),Di.toArray(this._colorArray,this._skyColor),this._nativeObj.skyColor=this._skyColor}get skyIllum(){return this._skyIllum}set skyIllum(e){this._skyIllum=e,this._nativeObj.skyIllum=e}get groundAlbedo(){return this._groundAlbedo}set groundAlbedo(e){this._groundAlbedo.set(e),zi.toArray(this._albedoArray,this._groundAlbedo),this._nativeObj.groundAlbedo=this._groundAlbedo}get native(){return this._nativeObj}constructor(){this._skyColor=new Di(51,128,204,1),this._groundAlbedo=new Di(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._enabled=!1,this._skyIllum=0,this._nativeObj=new Yn}initialize(e){this.skyColor=e.skyColor,this.groundAlbedo=e.groundAlbedo,this.skyIllum=e.skyIllum}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}rs.SUN_ILLUM=65e3,rs.SKY_ILLUM=2e4,n.Ambient=rs;const as=new zi,cs=new zi,ls=new zi,hs=new zi,us=new zi,_s=new zi,ps=new Array(3),ds=new Array(3);function fs(e,t){return zi.dot(t.n,e)-t.d}function ms(e,t,i){return zi.copy(e,t),zi.subtract(us,i.center,i.halfExtents),zi.add(_s,i.center,i.halfExtents),e.x=e.x<us.x?us.x:e.x,e.y=e.y<us.y?us.y:e.y,e.z=e.z<us.z?us.z:e.z,e.x=e.x>_s.x?_s.x:e.x,e.y=e.y>_s.y?_s.y:e.y,e.z=e.z>_s.z?_s.z:e.z,e}function gs(e,t,i){zi.set(as,i.orientation.m00,i.orientation.m01,i.orientation.m02),zi.set(cs,i.orientation.m03,i.orientation.m04,i.orientation.m05),zi.set(ls,i.orientation.m06,i.orientation.m07,i.orientation.m08),ps[0]=as,ps[1]=cs,ps[2]=ls,ds[0]=i.halfExtents.x,ds[1]=i.halfExtents.y,ds[2]=i.halfExtents.z,zi.subtract(hs,t,i.center),zi.set(e,i.center.x,i.center.y,i.center.z);for(let t=0;t<3;t++){let i=zi.dot(hs,ps[t]);i>ds[t]&&(i=ds[t]),i<-ds[t]&&(i=-ds[t]),e.x+=i*ps[t].x,e.y+=i*ps[t].y,e.z+=i*ps[t].z}return e}var vs=Object.freeze({__proto__:null,point_plane:fs,pt_point_plane:function(e,t,i){const n=fs(t,i);return zi.subtract(e,t,zi.multiplyScalar(e,i.n,n))},pt_point_aabb:ms,pt_point_obb:gs,pt_point_line:function(e,t,i,n){zi.subtract(as,i,n);const s=as,o=zi.lengthSqr(s);if(0==o)zi.copy(e,i);else{zi.subtract(as,t,i);const r=zi.dot(as,s)/o;r<0?zi.copy(e,i):r>1?zi.copy(e,n):zi.scaleAndAdd(e,i,s,r)}}}),ys={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};class xs{static create(e,t,i,n,s,o){return new xs(e,t,i,n,s,o)}static clone(e){return new xs(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}static copy(e,t){return zi.copy(e.s,t.s),zi.copy(e.e,t.e),e}static fromPoints(e,t,i){return zi.copy(e.s,t),zi.copy(e.e,i),e}static set(e,t,i,n,s,o,r){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=s,e.e.y=o,e.e.z=r,e}static len(e){return zi.distance(e.s,e.e)}get type(){return this._type}constructor(e=0,t=0,i=0,n=0,s=0,o=-1){this.s=void 0,this.e=void 0,this._type=void 0,this._type=ys.SHAPE_LINE,this.s=new zi(e,t,i),this.e=new zi(n,s,o)}length(){return zi.distance(this.s,this.e)}}class Ss{static create(e=0,t=0,i=0,n=0,s=0,o=1){return new Ss(e,t,i,n,s,o)}static clone(e){return new Ss(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)}static copy(e,t){return zi.copy(e.o,t.o),zi.copy(e.d,t.d),e}static fromPoints(e,t,i){return zi.copy(e.o,t),zi.normalize(e.d,zi.subtract(e.d,i,t)),e}static set(e,t,i,n,s,o,r){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=s,e.d.y=o,e.d.z=r,e}get type(){return this._type}constructor(e=0,t=0,i=0,n=0,s=0,o=-1){this.o=void 0,this.d=void 0,this._type=void 0,this._type=ys.SHAPE_RAY,this.o=new zi(e,t,i),this.d=new zi(n,s,o)}computeHit(e,t){zi.normalize(e,this.d),zi.scaleAndAdd(e,this.o,e,t)}}const bs=new zi,Ts=new zi,Es=new zi,Cs=new zi;function ws(e){return Math.max(Math.max(e.x,e.y),e.z)}class As{static create(e,t,i,n){return new As(e,t,i,n)}static clone(e){return new As(e.center.x,e.center.y,e.center.z,e.radius)}static copy(e,t){return zi.copy(e.center,t.center),e.radius=t.radius,e}static fromPoints(e,t,i){return zi.multiplyScalar(e.center,zi.add(bs,t,i),.5),e.radius=.5*zi.subtract(bs,i,t).length(),e}static set(e,t,i,n,s){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=s,e}get center(){return this._center}set center(e){this._center=e}get radius(){return this._radius}set radius(e){this._radius=e}get type(){return this._type}constructor(e=0,t=0,i=0,n=1){this._center=new zi(0,0,0),this._radius=0,this._type=void 0,this._type=ys.SHAPE_SPHERE,this._center=new zi(e,t,i),this._radius=n}destroy(){}clone(){return As.clone(this)}copy(e){return As.copy(this,e)}getBoundary(e,t){zi.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),zi.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}transform(e,t,i,n,s){zi.transformMat4(s.center,this.center,e),s.radius=this.radius*ws(n)}translateAndRotate(e,t,i){zi.transformMat4(i.center,this.center,e)}setScale(e,t){t.radius=this.radius*ws(e)}mergePoint(e){this.radius<0&&(this.center.set(e),this.radius=0),zi.subtract(Ts,e,this.center);const t=Ts.length();if(t>this.radius){const e=.5*(t-this.radius);this.radius+=e,zi.multiplyScalar(Ts,Ts,e/t),zi.add(this.center,this.center,Ts)}}mergePoints(e){const t=e.length;if(!(t<1)){this.radius=-1;for(let i=0;i<t;i++)this.mergePoint(e[i])}}mergeAABB(e){e.getBoundary(Es,Cs),this.mergePoint(Es),this.mergePoint(Cs)}}class Ps{static create(e=1,t=0,i=0,n=0,s=0,o=0,r=0,a=0,c=1){return new Ps(e,t,i,n,s,o,r,a,c)}static clone(e){return new Ps(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)}static copy(e,t){return zi.copy(e.a,t.a),zi.copy(e.b,t.b),zi.copy(e.c,t.c),e}static fromPoints(e,t,i,n){return zi.copy(e.a,t),zi.copy(e.b,i),zi.copy(e.c,n),e}static set(e,t,i,n,s,o,r,a,c,l){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=s,e.b.y=o,e.b.z=r,e.c.x=a,e.c.y=c,e.c.z=l,e}get type(){return this._type}constructor(e=0,t=0,i=0,n=1,s=0,o=0,r=0,a=1,c=0){this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=ys.SHAPE_TRIANGLE,this.a=new zi(e,t,i),this.b=new zi(n,s,o),this.c=new zi(r,a,c)}}const Rs=(e,t,i)=>{for(let n=0;n<t.length;++n)e.length<=n&&e.push(new i),e[n].copy(t[n]);e.length=t.length};let Is,Ms,Os,Ds,Ns,Ls,Bs,zs,Fs,Us,Gs,ks,Hs,Vs,js,Ws,qs,Xs,Ys,Ks,$s,Qs,Zs,Js,eo,to,io,no,so,oo,ro,ao,co,lo,ho,uo,_o,po,fo,mo;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.RENDER_PASS=3]="RENDER_PASS",e[e.FRAMEBUFFER=4]="FRAMEBUFFER",e[e.SAMPLER=5]="SAMPLER",e[e.SHADER=6]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=12]="COMMAND_BUFFER",e[e.QUEUE=13]="QUEUE",e[e.GLOBAL_BARRIER=14]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=15]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=16]="BUFFER_BARRIER"}(Is||(Is={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(Ms||(Ms={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(Os||(Os={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(Ds||(Ds={})),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_SRGB=7]="FORMAT_SRGB",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.FORMAT_RGB8=13]="FORMAT_RGB8",e[e.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=17]="BLEND_MINMAX",e[e.COMPUTE_SHADER=18]="COMPUTE_SHADER",e[e.COUNT=19]="COUNT"}(Ns||(Ns={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.D16=54]="D16",e[e.D16S8=55]="D16S8",e[e.D24=56]="D24",e[e.D24S8=57]="D24S8",e[e.D32F=58]="D32F",e[e.D32F_S8=59]="D32F_S8",e[e.BC1=60]="BC1",e[e.BC1_ALPHA=61]="BC1_ALPHA",e[e.BC1_SRGB=62]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",e[e.BC2=64]="BC2",e[e.BC2_SRGB=65]="BC2_SRGB",e[e.BC3=66]="BC3",e[e.BC3_SRGB=67]="BC3_SRGB",e[e.BC4=68]="BC4",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5=70]="BC5",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.BC6H_UF16=72]="BC6H_UF16",e[e.BC6H_SF16=73]="BC6H_SF16",e[e.BC7=74]="BC7",e[e.BC7_SRGB=75]="BC7_SRGB",e[e.ETC_RGB8=76]="ETC_RGB8",e[e.ETC2_RGB8=77]="ETC2_RGB8",e[e.ETC2_SRGB8=78]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=81]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",e[e.EAC_R11=83]="EAC_R11",e[e.EAC_R11SN=84]="EAC_R11SN",e[e.EAC_RG11=85]="EAC_RG11",e[e.EAC_RG11SN=86]="EAC_RG11SN",e[e.PVRTC_RGB2=87]="PVRTC_RGB2",e[e.PVRTC_RGBA2=88]="PVRTC_RGBA2",e[e.PVRTC_RGB4=89]="PVRTC_RGB4",e[e.PVRTC_RGBA4=90]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=91]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=92]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=93]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=94]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=95]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=96]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=97]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=98]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=99]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=100]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=101]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=102]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=103]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=104]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=105]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=106]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=107]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=108]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=109]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=110]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=111]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=112]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=113]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=114]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=115]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=116]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=117]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=118]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=119]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=120]="ASTC_SRGBA_12X12",e[e.COUNT=121]="COUNT"}(Ls||(Ls={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Bs||(Bs={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(zs||(zs={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(Fs||(Fs={})),function(e){e[e.NONE=0]="NONE"}(Us||(Us={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(Gs||(Gs={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(ks||(ks={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Hs||(Hs={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Vs||(Vs={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.IMMUTABLE=2]="IMMUTABLE",e[e.GENERAL_LAYOUT=4]="GENERAL_LAYOUT"}(js||(js={})),function(e){e[e.X1=1]="X1",e[e.X2=2]="X2",e[e.X4=4]="X4",e[e.X8=8]="X8",e[e.X16=16]="X16",e[e.X32=32]="X32",e[e.X64=64]="X64"}(Ws||(Ws={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(qs||(qs={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Xs||(Xs={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Ys||(Ys={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Ks||(Ks={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}($s||($s={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Qs||(Qs={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Zs||(Zs={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Js||(Js={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(eo||(eo={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(to||(to={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(io||(io={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(no||(no={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(so||(so={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(oo||(oo={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(ro||(ro={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(ao||(ao={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(co||(co={})),function(e){e[e.NONE=0]="NONE",e[e.VIEWPORT=1]="VIEWPORT",e[e.SCISSOR=2]="SCISSOR",e[e.LINE_WIDTH=4]="LINE_WIDTH",e[e.DEPTH_BIAS=8]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(lo||(lo={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(ho||(ho={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(uo||(uo={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(_o||(_o={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(po||(po={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(fo||(fo={}));class go{constructor(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}}class vo{constructor(e=0,t=0,i=0,n=0,s=0,o=0,r=0,a=0,c=0,l=0,h=0,u=0,_=0,p=0,d=0,f=1,m=0,g=0,v=new go,y=new go,x=-1,S=1,b=1){this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=i,this.maxTextureUnits=n,this.maxImageUnits=s,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=r,this.maxShaderStorageBufferBindings=a,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=h,this.maxTextureSize=u,this.maxCubeMapTextureSize=_,this.depthBits=p,this.stencilBits=d,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=m,this.maxComputeWorkGroupInvocations=g,this.maxComputeWorkGroupSize=v,this.maxComputeWorkGroupCount=y,this.clipSpaceMinZ=x,this.screenSpaceSignY=S,this.clipSpaceSignY=b}copy(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.depthBits=e.depthBits,this.stencilBits=e.stencilBits,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this}}class yo{constructor(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}}class xo{constructor(e=0,t=0,i=0,n=0){this.x=e,this.y=t,this.width=i,this.height=n}copy(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}}class So{constructor(e=0,t=0,i=1){this.width=e,this.height=t,this.depth=i}copy(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this}}class bo{constructor(e=0,t=0,i=1){this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=i}copy(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this}}class To{constructor(e=0,t=1,i=0,n=1){this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=i,this.layerCount=n}copy(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this}}class Eo{constructor(e=new bo,t=new yo,i=new bo,n=new yo,s=new So){this.srcSubres=e,this.srcOffset=t,this.dstSubres=i,this.dstOffset=n,this.extent=s}copy(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this}}class Co{constructor(e=new bo,t=new yo,i=new So,n=new bo,s=new yo,o=new So){this.srcSubres=e,this.srcOffset=t,this.srcExtent=i,this.dstSubres=n,this.dstOffset=s,this.dstExtent=o}copy(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this}}class wo{constructor(e=0,t=0,i=new yo,n=new So,s=new bo){this.buffStride=e,this.buffTexHeight=t,this.texOffset=i,this.texExtent=n,this.texSubres=s}copy(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this}}class Ao{constructor(e=0,t=0,i=0,n=0,s=0,o=1){this.left=e,this.top=t,this.width=i,this.height=n,this.minDepth=s,this.maxDepth=o}copy(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this}}class Po{constructor(e=0,t=0,i=0,n=0){this.x=e,this.y=t,this.z=i,this.w=n}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}}class Ro{constructor(e=[],t=[],i=0){this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=i}copy(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this}}class Io{constructor(e=Fs.NONE,t=ks.NONE,i=0,n=0,s=Us.NONE){this.usage=e,this.memUsage=t,this.size=i,this.stride=n,this.flags=s}copy(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this}}class Mo{constructor(e=null,t=0,i=0){this.buffer=e,this.offset=t,this.range=i}copy(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this}}class Oo{constructor(e=0,t=0,i=0,n=0,s=0,o=0,r=0){this.vertexCount=e,this.firstVertex=t,this.indexCount=i,this.firstIndex=n,this.vertexOffset=s,this.instanceCount=o,this.firstInstance=r}copy(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this}}class Do{constructor(e=0,t=0,i=0,n=null,s=0){this.groupCountX=e,this.groupCountY=t,this.groupCountZ=i,this.indirectBuffer=n,this.indirectOffset=s}copy(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this}}class No{constructor(e=[]){this.drawInfos=e}copy(e){return Rs(this.drawInfos,e.drawInfos,Oo),this}}class Lo{constructor(e=Hs.TEX2D,t=Vs.NONE,i=Ls.UNKNOWN,n=0,s=0,o=js.NONE,r=1,a=1,c=Ws.X1,l=1){this.type=e,this.usage=t,this.format=i,this.width=n,this.height=s,this.flags=o,this.layerCount=r,this.levelCount=a,this.samples=c,this.depth=l}copy(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this}}class Bo{constructor(e=null,t=Hs.TEX2D,i=Ls.UNKNOWN,n=0,s=1,o=0,r=1){this.texture=e,this.type=t,this.format=i,this.baseLevel=n,this.levelCount=s,this.baseLayer=o,this.layerCount=r}copy(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this}}class zo{constructor(e=qs.LINEAR,t=qs.LINEAR,i=qs.NONE,n=Xs.WRAP,s=Xs.WRAP,o=Xs.WRAP,r=0,a=Ys.ALWAYS,c=new Po,l=0){this.minFilter=e,this.magFilter=t,this.mipFilter=i,this.addressU=n,this.addressV=s,this.addressW=o,this.maxAnisotropy=r,this.cmpFunc=a,this.borderColor=c,this.mipLODBias=l}copy(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this.borderColor.copy(e.borderColor),this.mipLODBias=e.mipLODBias,this}}class Fo{constructor(e="",t=zs.UNKNOWN,i=0){this.name=e,this.type=t,this.count=i}copy(e){return this.name=e.name,this.type=e.type,this.count=e.count,this}}class Uo{constructor(e=0,t=0,i="",n=[],s=0){this.set=e,this.binding=t,this.name=i,this.members=n,this.count=s}copy(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,Rs(this.members,e.members,Fo),this.count=e.count,this}}class Go{constructor(e=0,t=0,i="",n=zs.UNKNOWN,s=0){this.set=e,this.binding=t,this.name=i,this.type=n,this.count=s}copy(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this}}class ko{constructor(e=0,t=0,i="",n=0){this.set=e,this.binding=t,this.name=i,this.count=n}copy(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this}}class Ho{constructor(e=0,t=0,i="",n=zs.UNKNOWN,s=0){this.set=e,this.binding=t,this.name=i,this.type=n,this.count=s}copy(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this}}class Vo{constructor(e=0,t=0,i="",n=zs.UNKNOWN,s=0,o=Gs.READ_WRITE){this.set=e,this.binding=t,this.name=i,this.type=n,this.count=s,this.memoryAccess=o}copy(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this}}class jo{constructor(e=0,t=0,i="",n=0,s=Gs.READ_WRITE){this.set=e,this.binding=t,this.name=i,this.count=n,this.memoryAccess=s}copy(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this}}class Wo{constructor(e=0,t=0,i="",n=0){this.set=e,this.binding=t,this.name=i,this.count=n}copy(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this}}class qo{constructor(e=Js.NONE,t=""){this.stage=e,this.source=t}copy(e){return this.stage=e.stage,this.source=e.source,this}}class Xo{constructor(e="",t=Ls.UNKNOWN,i=!1,n=0,s=!1,o=0){this.name=e,this.format=t,this.isNormalized=i,this.stream=n,this.isInstanced=s,this.location=o}copy(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this}}class Yo{constructor(e="",t=[],i=[],n=[],s=[],o=[],r=[],a=[],c=[],l=[]){this.name=e,this.stages=t,this.attributes=i,this.blocks=n,this.buffers=s,this.samplerTextures=o,this.samplers=r,this.textures=a,this.images=c,this.subpassInputs=l}copy(e){return this.name=e.name,Rs(this.stages,e.stages,qo),Rs(this.attributes,e.attributes,Xo),Rs(this.blocks,e.blocks,Uo),Rs(this.buffers,e.buffers,jo),Rs(this.samplerTextures,e.samplerTextures,Go),Rs(this.samplers,e.samplers,ko),Rs(this.textures,e.textures,Ho),Rs(this.images,e.images,Vo),Rs(this.subpassInputs,e.subpassInputs,Wo),this}}class Ko{constructor(e=[],t=[],i=null,n=null){this.attributes=e,this.vertexBuffers=t,this.indexBuffer=i,this.indirectBuffer=n}copy(e){return Rs(this.attributes,e.attributes,Xo),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this}}class $o{constructor(e=Ls.UNKNOWN,t=Ws.X1,i=eo.CLEAR,n=to.STORE,s=[],o=[io.PRESENT],r=!1){this.format=e,this.sampleCount=t,this.loadOp=i,this.storeOp=n,this.beginAccesses=s,this.endAccesses=o,this.isGeneralLayout=r}copy(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this}}class Qo{constructor(e=Ls.UNKNOWN,t=Ws.X1,i=eo.CLEAR,n=to.STORE,s=eo.CLEAR,o=to.STORE,r=[],a=[io.DEPTH_STENCIL_ATTACHMENT_WRITE],c=!1){this.format=e,this.sampleCount=t,this.depthLoadOp=i,this.depthStoreOp=n,this.stencilLoadOp=s,this.stencilStoreOp=o,this.beginAccesses=r,this.endAccesses=a,this.isGeneralLayout=c}copy(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this}}class Zo{constructor(e=[],t=[],i=[],n=[],s=-1,o=-1,r=no.NONE,a=no.NONE){this.inputs=e,this.colors=t,this.resolves=i,this.preserves=n,this.depthStencil=s,this.depthStencilResolve=o,this.depthResolveMode=r,this.stencilResolveMode=a}copy(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this}}class Jo{constructor(e=0,t=0,i=[],n=[]){this.srcSubpass=e,this.dstSubpass=t,this.srcAccesses=i,this.dstAccesses=n}copy(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this}}class er{constructor(e=[],t=new Qo,i=[],n=[]){this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=i,this.dependencies=n}copy(e){return Rs(this.colorAttachments,e.colorAttachments,$o),this.depthStencilAttachment.copy(e.depthStencilAttachment),Rs(this.subpasses,e.subpasses,Zo),Rs(this.dependencies,e.dependencies,Jo),this}}class tr{constructor(e=[],t=[]){this.prevAccesses=e,this.nextAccesses=t}copy(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this}}class ir{constructor(e=[],t=[],i=!1,n=null,s=null){this.prevAccesses=e,this.nextAccesses=t,this.discardContents=i,this.srcQueue=n,this.dstQueue=s}copy(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this}}class sr{constructor(e=null,t=[],i=null){this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=i}copy(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this}}class or{constructor(e=-1,t=uo.UNKNOWN,i=0,n=Js.NONE,s=[]){this.binding=e,this.descriptorType=t,this.count=i,this.stageFlags=n,this.immutableSamplers=s}copy(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this}}class rr{constructor(e=[]){this.bindings=e}copy(e){return Rs(this.bindings,e.bindings,or),this}}class ar{constructor(e=null){this.layout=e}copy(e){return this.layout=e.layout,this}}class cr{constructor(e=[]){this.setLayouts=e}copy(e){return this.setLayouts=e.setLayouts.slice(),this}}class lr{constructor(e=[]){this.attributes=e}copy(e){return Rs(this.attributes,e.attributes,Xo),this}}class hr{constructor(e=null,t=po.PRIMARY){this.queue=e,this.type=t}copy(e){return this.queue=e.queue,this.type=e.type,this}}class ur{constructor(e=_o.GRAPHICS){this.type=e}copy(e){return this.type=e.type,this}}class _r{constructor(e="",t=0,i=0,n=Bs.NONE,s=!1,o=!1,r=!1,a=!1){this.name=e,this.size=t,this.count=i,this.type=n,this.hasAlpha=s,this.hasDepth=o,this.hasStencil=r,this.isCompressed=a}}class pr{constructor(e=0,t=0){this.bufferSize=e,this.textureSize=t}copy(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this}}class dr{constructor(e=0,t=0,i=0){this.writeMask=e,this.compareMask=t,this.reference=i}copy(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this}}class fr{constructor(e=new Ao,t=new xo,i=new Po,n=1,s=0,o=0,r=0,a=0,c=0,l=new dr,h=new dr){this.viewport=e,this.scissor=t,this.blendConstant=i,this.lineWidth=n,this.depthBiasConstant=s,this.depthBiasClamp=o,this.depthBiasSlope=r,this.depthMinBounds=a,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=h}copy(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this}}class mr{get gfxType(){return this._gfxType}constructor(e){this._gfxType=Is.UNKNOWN,this._gfxType=e}}class gr{constructor(e,t=!0,i=!0,n=1,s=1,o=1,r=new Ro){this.canvasElm=e,this.isAntialias=t,this.isPremultipliedAlpha=i,this.devicePixelRatio=n,this.width=s,this.height=o,this.bindingMappingInfo=r}}!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(mo||(mo={}));const vr=Object.freeze([new _r("UNKNOWN",0,0,Bs.NONE,!1,!1,!1,!1),new _r("A8",1,1,Bs.UNORM,!0,!1,!1,!1),new _r("L8",1,1,Bs.UNORM,!1,!1,!1,!1),new _r("LA8",1,2,Bs.UNORM,!0,!1,!1,!1),new _r("R8",1,1,Bs.UNORM,!1,!1,!1,!1),new _r("R8SN",1,1,Bs.SNORM,!1,!1,!1,!1),new _r("R8UI",1,1,Bs.UINT,!1,!1,!1,!1),new _r("R8I",1,1,Bs.INT,!1,!1,!1,!1),new _r("R16F",2,1,Bs.FLOAT,!1,!1,!1,!1),new _r("R16UI",2,1,Bs.UINT,!1,!1,!1,!1),new _r("R16I",2,1,Bs.INT,!1,!1,!1,!1),new _r("R32F",4,1,Bs.FLOAT,!1,!1,!1,!1),new _r("R32UI",4,1,Bs.UINT,!1,!1,!1,!1),new _r("R32I",4,1,Bs.INT,!1,!1,!1,!1),new _r("RG8",2,2,Bs.UNORM,!1,!1,!1,!1),new _r("RG8SN",2,2,Bs.SNORM,!1,!1,!1,!1),new _r("RG8UI",2,2,Bs.UINT,!1,!1,!1,!1),new _r("RG8I",2,2,Bs.INT,!1,!1,!1,!1),new _r("RG16F",4,2,Bs.FLOAT,!1,!1,!1,!1),new _r("RG16UI",4,2,Bs.UINT,!1,!1,!1,!1),new _r("RG16I",4,2,Bs.INT,!1,!1,!1,!1),new _r("RG32F",8,2,Bs.FLOAT,!1,!1,!1,!1),new _r("RG32UI",8,2,Bs.UINT,!1,!1,!1,!1),new _r("RG32I",8,2,Bs.INT,!1,!1,!1,!1),new _r("RGB8",3,3,Bs.UNORM,!1,!1,!1,!1),new _r("SRGB8",3,3,Bs.UNORM,!1,!1,!1,!1),new _r("RGB8SN",3,3,Bs.SNORM,!1,!1,!1,!1),new _r("RGB8UI",3,3,Bs.UINT,!1,!1,!1,!1),new _r("RGB8I",3,3,Bs.INT,!1,!1,!1,!1),new _r("RGB16F",6,3,Bs.FLOAT,!1,!1,!1,!1),new _r("RGB16UI",6,3,Bs.UINT,!1,!1,!1,!1),new _r("RGB16I",6,3,Bs.INT,!1,!1,!1,!1),new _r("RGB32F",12,3,Bs.FLOAT,!1,!1,!1,!1),new _r("RGB32UI",12,3,Bs.UINT,!1,!1,!1,!1),new _r("RGB32I",12,3,Bs.INT,!1,!1,!1,!1),new _r("RGBA8",4,4,Bs.UNORM,!0,!1,!1,!1),new _r("BGRA8",4,4,Bs.UNORM,!0,!1,!1,!1),new _r("SRGB8_A8",4,4,Bs.UNORM,!0,!1,!1,!1),new _r("RGBA8SN",4,4,Bs.SNORM,!0,!1,!1,!1),new _r("RGBA8UI",4,4,Bs.UINT,!0,!1,!1,!1),new _r("RGBA8I",4,4,Bs.INT,!0,!1,!1,!1),new _r("RGBA16F",8,4,Bs.FLOAT,!0,!1,!1,!1),new _r("RGBA16UI",8,4,Bs.UINT,!0,!1,!1,!1),new _r("RGBA16I",8,4,Bs.INT,!0,!1,!1,!1),new _r("RGBA32F",16,4,Bs.FLOAT,!0,!1,!1,!1),new _r("RGBA32UI",16,4,Bs.UINT,!0,!1,!1,!1),new _r("RGBA32I",16,4,Bs.INT,!0,!1,!1,!1),new _r("R5G6B5",2,3,Bs.UNORM,!1,!1,!1,!1),new _r("R11G11B10F",4,3,Bs.FLOAT,!1,!1,!1,!1),new _r("RGB5A1",2,4,Bs.UNORM,!0,!1,!1,!1),new _r("RGBA4",2,4,Bs.UNORM,!0,!1,!1,!1),new _r("RGB10A2",2,4,Bs.UNORM,!0,!1,!1,!1),new _r("RGB10A2UI",2,4,Bs.UINT,!0,!1,!1,!1),new _r("RGB9E5",2,4,Bs.FLOAT,!0,!1,!1,!1),new _r("D16",2,1,Bs.UINT,!1,!0,!1,!1),new _r("D16S8",3,2,Bs.UINT,!1,!0,!0,!1),new _r("D24",3,1,Bs.UINT,!1,!0,!1,!1),new _r("D24S8",4,2,Bs.UINT,!1,!0,!0,!1),new _r("D32F",4,1,Bs.FLOAT,!1,!0,!1,!1),new _r("D32FS8",5,2,Bs.FLOAT,!1,!0,!0,!1),new _r("BC1",1,3,Bs.UNORM,!1,!1,!1,!0),new _r("BC1_ALPHA",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("BC1_SRGB",1,3,Bs.UNORM,!1,!1,!1,!0),new _r("BC1_SRGB_ALPHA",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("BC2",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("BC2_SRGB",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("BC3",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("BC3_SRGB",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("BC4",1,1,Bs.UNORM,!1,!1,!1,!0),new _r("BC4_SNORM",1,1,Bs.SNORM,!1,!1,!1,!0),new _r("BC5",1,2,Bs.UNORM,!1,!1,!1,!0),new _r("BC5_SNORM",1,2,Bs.SNORM,!1,!1,!1,!0),new _r("BC6H_UF16",1,3,Bs.UFLOAT,!1,!1,!1,!0),new _r("BC6H_SF16",1,3,Bs.FLOAT,!1,!1,!1,!0),new _r("BC7",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("BC7_SRGB",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ETC_RGB8",1,3,Bs.UNORM,!1,!1,!1,!0),new _r("ETC2_RGB8",1,3,Bs.UNORM,!1,!1,!1,!0),new _r("ETC2_SRGB8",1,3,Bs.UNORM,!1,!1,!1,!0),new _r("ETC2_RGB8_A1",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ETC2_SRGB8_A1",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ETC2_RGBA8",2,4,Bs.UNORM,!0,!1,!1,!0),new _r("ETC2_SRGB8_A8",2,4,Bs.UNORM,!0,!1,!1,!0),new _r("EAC_R11",1,1,Bs.UNORM,!1,!1,!1,!0),new _r("EAC_R11SN",1,1,Bs.SNORM,!1,!1,!1,!0),new _r("EAC_RG11",2,2,Bs.UNORM,!1,!1,!1,!0),new _r("EAC_RG11SN",2,2,Bs.SNORM,!1,!1,!1,!0),new _r("PVRTC_RGB2",2,3,Bs.UNORM,!1,!1,!1,!0),new _r("PVRTC_RGBA2",2,4,Bs.UNORM,!0,!1,!1,!0),new _r("PVRTC_RGB4",2,3,Bs.UNORM,!1,!1,!1,!0),new _r("PVRTC_RGBA4",2,4,Bs.UNORM,!0,!1,!1,!0),new _r("PVRTC2_2BPP",2,4,Bs.UNORM,!0,!1,!1,!0),new _r("PVRTC2_4BPP",2,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_4x4",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_5x4",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_5x5",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_6x5",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_6x6",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_8x5",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_8x6",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_8x8",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_10x5",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_10x6",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_10x8",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_10x10",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_12x10",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_RGBA_12x12",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_4x4",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_5x4",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_5x5",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_6x5",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_6x6",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_8x5",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_8x6",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_8x8",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_10x5",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_10x6",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_10x8",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_10x10",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_12x10",1,4,Bs.UNORM,!0,!1,!1,!0),new _r("ASTC_SRGBA_12x12",1,4,Bs.UNORM,!0,!1,!1,!0)]),yr=uo.UNIFORM_BUFFER|uo.DYNAMIC_UNIFORM_BUFFER|uo.STORAGE_BUFFER|uo.DYNAMIC_STORAGE_BUFFER,xr=uo.SAMPLER_TEXTURE|uo.SAMPLER|uo.TEXTURE|uo.STORAGE_IMAGE|uo.INPUT_ATTACHMENT,Sr=uo.DYNAMIC_STORAGE_BUFFER|uo.DYNAMIC_UNIFORM_BUFFER,br=28;function Tr(e){return e>0&&0==(e&e-1)}function Er(e,t,i,n){if(!vr[e].isCompressed)return t*i*n*vr[e].size;switch(e){case Ls.BC1:case Ls.BC1_ALPHA:case Ls.BC1_SRGB:case Ls.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Ls.BC2:case Ls.BC2_SRGB:case Ls.BC3:case Ls.BC3_SRGB:case Ls.BC4:case Ls.BC4_SNORM:case Ls.BC6H_SF16:case Ls.BC6H_UF16:case Ls.BC7:case Ls.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Ls.BC5:case Ls.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case Ls.ETC_RGB8:case Ls.ETC2_RGB8:case Ls.ETC2_SRGB8:case Ls.ETC2_RGB8_A1:case Ls.EAC_R11:case Ls.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Ls.ETC2_RGBA8:case Ls.ETC2_SRGB8_A1:case Ls.EAC_RG11:case Ls.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Ls.PVRTC_RGB2:case Ls.PVRTC_RGBA2:case Ls.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case Ls.PVRTC_RGB4:case Ls.PVRTC_RGBA4:case Ls.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(i,8)/2)*n;case Ls.ASTC_RGBA_4X4:case Ls.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Ls.ASTC_RGBA_5X4:case Ls.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(i/4)*16*n;case Ls.ASTC_RGBA_5X5:case Ls.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(i/5)*16*n;case Ls.ASTC_RGBA_6X5:case Ls.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(i/5)*16*n;case Ls.ASTC_RGBA_6X6:case Ls.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(i/6)*16*n;case Ls.ASTC_RGBA_8X5:case Ls.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(i/5)*16*n;case Ls.ASTC_RGBA_8X6:case Ls.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(i/6)*16*n;case Ls.ASTC_RGBA_8X8:case Ls.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(i/8)*16*n;case Ls.ASTC_RGBA_10X5:case Ls.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(i/5)*16*n;case Ls.ASTC_RGBA_10X6:case Ls.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(i/6)*16*n;case Ls.ASTC_RGBA_10X8:case Ls.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(i/8)*16*n;case Ls.ASTC_RGBA_10X10:case Ls.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(i/10)*16*n;case Ls.ASTC_RGBA_12X10:case Ls.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(i/10)*16*n;case Ls.ASTC_RGBA_12X12:case Ls.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(i/12)*16*n;default:return 0}}function Cr(e,t,i,n,s){let o=0;for(let r=0;r<s;++r)o+=Er(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return o}const wr=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Ar(e){return wr[e]||0}function Pr(e){const t=e.size/e.count;switch(e.type){case Bs.UNORM:case Bs.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Bs.SNORM:case Bs.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Bs.FLOAT:return Float32Array}return Float32Array}var Rr=Object.freeze({__proto__:null,get ObjectType(){return Is},get Status(){return Ms},get API(){return Os},get SurfaceTransform(){return Ds},get Feature(){return Ns},get Format(){return Ls},get FormatType(){return Bs},get Type(){return zs},get BufferUsageBit(){return Fs},get BufferFlagBit(){return Us},get MemoryAccessBit(){return Gs},get MemoryUsageBit(){return ks},get TextureType(){return Hs},get TextureUsageBit(){return Vs},get TextureFlagBit(){return js},get SampleCount(){return Ws},get Filter(){return qs},get Address(){return Xs},get ComparisonFunc(){return Ys},get StencilOp(){return Ks},get BlendFactor(){return $s},get BlendOp(){return Qs},get ColorMask(){return Zs},get ShaderStageFlagBit(){return Js},get LoadOp(){return eo},get StoreOp(){return to},get AccessType(){return io},get ResolveMode(){return no},get PipelineBindPoint(){return so},get PrimitiveMode(){return oo},get PolygonMode(){return ro},get ShadeModel(){return ao},get CullMode(){return co},get DynamicStateFlagBit(){return lo},get StencilFace(){return ho},get DescriptorType(){return uo},get QueueType(){return _o},get CommandBufferType(){return po},get ClearFlagBit(){return fo},Size:go,DeviceCaps:vo,Offset:yo,Rect:xo,Extent:So,TextureSubresLayers:bo,TextureSubresRange:To,TextureCopy:Eo,TextureBlit:Co,BufferTextureCopy:wo,Viewport:Ao,Color:Po,BindingMappingInfo:Ro,BufferInfo:Io,BufferViewInfo:Mo,DrawInfo:Oo,DispatchInfo:Do,IndirectBuffer:No,TextureInfo:Lo,TextureViewInfo:Bo,SamplerInfo:zo,Uniform:Fo,UniformBlock:Uo,UniformSamplerTexture:Go,UniformSampler:ko,UniformTexture:Ho,UniformStorageImage:Vo,UniformStorageBuffer:jo,UniformInputAttachment:Wo,ShaderStage:qo,Attribute:Xo,ShaderInfo:Yo,InputAssemblerInfo:Ko,ColorAttachment:$o,DepthStencilAttachment:Qo,SubpassInfo:Zo,SubpassDependency:Jo,RenderPassInfo:er,GlobalBarrierInfo:tr,TextureBarrierInfo:ir,FramebufferInfo:sr,DescriptorSetLayoutBinding:or,DescriptorSetLayoutInfo:rr,DescriptorSetInfo:ar,PipelineLayoutInfo:cr,InputState:lr,CommandBufferInfo:hr,QueueInfo:ur,FormatInfo:_r,MemoryStatus:pr,DynamicStencilStates:dr,DynamicStates:fr,Obj:mr,DeviceInfo:gr,get AttributeName(){return mo},FormatInfos:vr,DESCRIPTOR_BUFFER_TYPE:yr,DESCRIPTOR_SAMPLER_TYPE:xr,DESCRIPTOR_DYNAMIC_TYPE:Sr,DRAW_INFO_SIZE:br,IsPowerOf2:Tr,FormatSize:Er,FormatSurfaceSize:Cr,GetTypeSize:Ar,getTypedArrayConstructor:Pr});class Ir{constructor(e=!1,t=ro.FILL,i=ao.GOURAND,n=co.BACK,s=!0,o=!1,r=0,a=0,c=0,l=!0,h=!1,u=1){this._nativeObj=void 0,this._isDiscard=!1,this._polygonMode=ro.FILL,this._shadeModel=ao.GOURAND,this._cullMode=co.BACK,this._isFrontFaceCCW=!0,this._depthBiasEnabled=!1,this._depthBias=0,this._depthBiasClamp=0,this._depthBiasSlop=0,this._isDepthClip=!0,this._isMultisample=!1,this._lineWidth=1,this._nativeObj=new gfx.RasterizerState,this.assignProperties(e,t,i,n,s,o,r,a,c,l,h,u)}get native(){return this._nativeObj}get isDiscard(){return this._isDiscard}set isDiscard(e){this._isDiscard=e,this._nativeObj.isDiscard=e}get polygonMode(){return this._polygonMode}set polygonMode(e){this._polygonMode=e,this._nativeObj.polygonMode=e}get shadeModel(){return this._shadeModel}set shadeModel(e){this._shadeModel=e,this._nativeObj.shadeModel=e}get cullMode(){return this._cullMode}set cullMode(e){this._cullMode=e,this._nativeObj.cullMode=e}get isFrontFaceCCW(){return this._isFrontFaceCCW}set isFrontFaceCCW(e){this._isFrontFaceCCW=e,this._nativeObj.isFrontFaceCCW=e}get depthBiasEnabled(){return this._depthBiasEnabled}set depthBiasEnabled(e){this._depthBiasEnabled=e,this._nativeObj.depthBiasEnabled=e}get depthBias(){return this._depthBias}set depthBias(e){this._depthBias=e,this._nativeObj.depthBias=e}get depthBiasClamp(){return this._depthBiasClamp}set depthBiasClamp(e){this._depthBiasClamp=e,this._nativeObj.depthBiasClamp=e}get depthBiasSlop(){return this._depthBiasSlop}set depthBiasSlop(e){this._depthBiasSlop=e,this._nativeObj.depthBiasSlop=e}get isDepthClip(){return this._isDepthClip}set isDepthClip(e){this._isDepthClip=e,this._nativeObj.isDepthClip=e}get isMultisample(){return this._isMultisample}set isMultisample(e){this._isMultisample=e,this._nativeObj.isMultisample=e}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._nativeObj.lineWidth=e}reset(){this.assignProperties(!1,ro.FILL,ao.GOURAND,co.BACK,!0,!1,0,0,0,!0,!1,1)}assign(e){e&&this.assignProperties(e.isDiscard,e.polygonMode,e.shadeModel,e.cullMode,e.isFrontFaceCCW,e.depthBiasEnabled,e.depthBias,e.depthBiasClamp,e.depthBiasSlop,e.isDepthClip,e.isMultisample,e.lineWidth)}destroy(){this._nativeObj=null}assignProperties(e,t,i,n,s,o,r,a,c,l,h,u){void 0!==e&&(this.isDiscard=e),void 0!==t&&(this.polygonMode=t),void 0!==i&&(this.shadeModel=i),void 0!==n&&(this.cullMode=n),void 0!==s&&(this.isFrontFaceCCW=s),void 0!==o&&(this.depthBiasEnabled=o),void 0!==r&&(this.depthBias=r),void 0!==a&&(this.depthBiasClamp=a),void 0!==c&&(this.depthBiasSlop=c),void 0!==l&&(this.isDepthClip=l),void 0!==h&&(this.isMultisample=h),void 0!==u&&(this.lineWidth=u)}}class Mr{constructor(e=!0,t=!0,i=Ys.LESS,n=!1,s=Ys.ALWAYS,o=65535,r=65535,a=Ks.KEEP,c=Ks.KEEP,l=Ks.KEEP,h=1,u=!1,_=Ys.ALWAYS,p=65535,d=65535,f=Ks.KEEP,m=Ks.KEEP,g=Ks.KEEP,v=1){this._nativeObj=void 0,this._depthTest=!0,this._depthWrite=!0,this._depthFunc=Ys.LESS,this._stencilTestFront=!1,this._stencilFuncFront=Ys.ALWAYS,this._stencilReadMaskFront=65535,this._stencilWriteMaskFront=65535,this._stencilFailOpFront=Ks.KEEP,this._stencilZFailOpFront=Ks.KEEP,this._stencilPassOpFront=Ks.KEEP,this._stencilRefFront=1,this._stencilTestBack=!1,this._stencilFuncBack=Ys.ALWAYS,this._stencilReadMaskBack=65535,this._stencilWriteMaskBack=65535,this._stencilFailOpBack=Ks.KEEP,this._stencilZFailOpBack=Ks.KEEP,this._stencilPassOpBack=Ks.KEEP,this._stencilRefBack=1,this._nativeObj=new gfx.DepthStencilState,this.assignProperties(e,t,i,n,s,o,r,a,c,l,h,u,_,p,d,f,m,g,v)}get native(){return this._nativeObj}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest=e,this._nativeObj.depthTest=e}get depthWrite(){return this._depthWrite}set depthWrite(e){this._depthWrite=e,this._nativeObj.depthWrite=e}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc=e,this._nativeObj.depthFunc=e}get stencilTestFront(){return this._stencilTestFront}set stencilTestFront(e){this._stencilTestFront=e,this._nativeObj.stencilTestFront=e}get stencilFuncFront(){return this._stencilFuncFront}set stencilFuncFront(e){this._stencilFuncFront=e,this._nativeObj.stencilFuncFront=e}get stencilReadMaskFront(){return this._stencilReadMaskFront}set stencilReadMaskFront(e){this._stencilReadMaskFront=e,this._nativeObj.stencilReadMaskFront=e}get stencilWriteMaskFront(){return this._stencilWriteMaskFront}set stencilWriteMaskFront(e){this._stencilWriteMaskFront=e,this._nativeObj.stencilWriteMaskFront=e}get stencilFailOpFront(){return this._stencilFailOpFront}set stencilFailOpFront(e){this._stencilFailOpFront=e,this._nativeObj.stencilFailOpFront=e}get stencilZFailOpFront(){return this._stencilZFailOpFront}set stencilZFailOpFront(e){this._stencilZFailOpFront=e,this._nativeObj.stencilZFailOpFront=e}get stencilPassOpFront(){return this._stencilPassOpFront}set stencilPassOpFront(e){this._stencilPassOpFront=e,this._nativeObj.stencilPassOpFront=e}get stencilRefFront(){return this._stencilRefFront}set stencilRefFront(e){this._stencilRefFront=e,this._nativeObj.stencilRefFront=e}get stencilTestBack(){return this._stencilTestBack}set stencilTestBack(e){this._stencilTestBack=e,this._nativeObj.stencilTestBack=e}get stencilFuncBack(){return this._stencilFuncBack}set stencilFuncBack(e){this._stencilFuncBack=e,this._nativeObj.stencilFuncBack=e}get stencilReadMaskBack(){return this._stencilReadMaskBack}set stencilReadMaskBack(e){this._stencilReadMaskBack=e,this._nativeObj.stencilReadMaskBack=e}get stencilWriteMaskBack(){return this._stencilWriteMaskBack}set stencilWriteMaskBack(e){this._stencilWriteMaskBack=e,this._nativeObj.stencilWriteMaskBack=e}get stencilFailOpBack(){return this._stencilFailOpBack}set stencilFailOpBack(e){this._stencilFailOpBack=e,this._nativeObj.stencilFailOpBack=e}get stencilZFailOpBack(){return this._stencilZFailOpBack}set stencilZFailOpBack(e){this._stencilZFailOpBack=e,this._nativeObj.stencilZFailOpBack=e}get stencilPassOpBack(){return this._stencilPassOpBack}set stencilPassOpBack(e){this._stencilPassOpBack=e,this._nativeObj.stencilPassOpBack=e}get stencilRefBack(){return this._stencilRefBack}set stencilRefBack(e){this._stencilRefBack=e,this._nativeObj.stencilRefBack=e}reset(){this.assignProperties(!0,!0,Ys.LESS,!1,Ys.ALWAYS,65535,65535,Ks.KEEP,Ks.KEEP,Ks.KEEP,1,!1,Ys.ALWAYS,65535,65535,Ks.KEEP,Ks.KEEP,Ks.KEEP,1)}assign(e){e&&this.assignProperties(e.depthTest,e.depthWrite,e.depthFunc,e.stencilTestFront,e.stencilFuncFront,e.stencilReadMaskFront,e.stencilWriteMaskFront,e.stencilFailOpFront,e.stencilZFailOpFront,e.stencilPassOpFront,e.stencilRefFront,e.stencilTestBack,e.stencilFuncBack,e.stencilReadMaskBack,e.stencilWriteMaskBack,e.stencilFailOpBack,e.stencilZFailOpBack,e.stencilPassOpBack,e.stencilRefBack)}destroy(){this._nativeObj=null}assignProperties(e,t,i,n,s,o,r,a,c,l,h,u,_,p,d,f,m,g,v){void 0!==e&&(this.depthTest=e),void 0!==t&&(this.depthWrite=t),void 0!==i&&(this.depthFunc=i),void 0!==n&&(this.stencilTestFront=n),void 0!==s&&(this.stencilFuncFront=s),void 0!==o&&(this.stencilReadMaskFront=o),void 0!==r&&(this.stencilWriteMaskFront=r),void 0!==a&&(this.stencilFailOpFront=a),void 0!==c&&(this.stencilZFailOpFront=c),void 0!==l&&(this.stencilPassOpFront=l),void 0!==h&&(this.stencilRefFront=h),void 0!==u&&(this.stencilTestBack=u),void 0!==_&&(this.stencilFuncBack=_),void 0!==p&&(this.stencilReadMaskBack=p),void 0!==d&&(this.stencilWriteMaskBack=d),void 0!==f&&(this.stencilFailOpBack=f),void 0!==m&&(this.stencilZFailOpBack=m),void 0!==g&&(this.stencilPassOpBack=g),void 0!==v&&(this.stencilRefBack=v)}}class Or{get native(){return this._nativeObj}constructor(e=!1,t=$s.ONE,i=$s.ZERO,n=Qs.ADD,s=$s.ONE,o=$s.ZERO,r=Qs.ADD,a=Zs.ALL){this._nativeObj=void 0,this._blend=!1,this._blendSrc=$s.ONE,this._blendDst=$s.ZERO,this._blendEq=Qs.ADD,this._blendSrcAlpha=$s.ONE,this._blendDstAlpha=$s.ZERO,this._blendAlphaEq=Qs.ADD,this._blendColorMask=Zs.ALL,this._nativeObj=new gfx.BlendTarget,this.assignProperties(e,t,i,n,s,o,r,a)}get blend(){return this._blend}set blend(e){this._blend=e,this._nativeObj.blend=e}get blendSrc(){return this._blendSrc}set blendSrc(e){this._blendSrc=e,this._nativeObj.blendSrc=e}get blendDst(){return this._blendDst}set blendDst(e){this._blendDst=e,this._nativeObj.blendDst=e}get blendEq(){return this._blendEq}set blendEq(e){this._blendEq=e,this._nativeObj.blendEq=e}get blendSrcAlpha(){return this._blendSrcAlpha}set blendSrcAlpha(e){this._blendSrcAlpha=e,this._nativeObj.blendSrcAlpha=e}get blendDstAlpha(){return this._blendDstAlpha}set blendDstAlpha(e){this._blendDstAlpha=e,this._nativeObj.blendDstAlpha=e}get blendAlphaEq(){return this._blendAlphaEq}set blendAlphaEq(e){this._blendAlphaEq=e,this._nativeObj.blendAlphaEq=e}get blendColorMask(){return this._blendColorMask}set blendColorMask(e){this._blendColorMask=e,this._nativeObj.blendColorMask=e}reset(){this.assignProperties(!1,$s.ONE,$s.ZERO,Qs.ADD,$s.ONE,$s.ZERO,Qs.ADD,Zs.ALL)}destroy(){this._nativeObj=null}assign(e){e&&this.assignProperties(e.blend,e.blendSrc,e.blendDst,e.blendEq,e.blendSrcAlpha,e.blendDstAlpha,e.blendAlphaEq,e.blendColorMask)}assignProperties(e,t,i,n,s,o,r,a){void 0!==e&&(this.blend=e),void 0!==t&&(this.blendSrc=t),void 0!==i&&(this.blendDst=i),void 0!==n&&(this.blendEq=n),void 0!==s&&(this.blendSrcAlpha=s),void 0!==o&&(this.blendDstAlpha=o),void 0!==r&&(this.blendAlphaEq=r),void 0!==a&&(this.blendColorMask=a)}}class Dr{_setTargets(e){this.targets=e;const t="$__nativeObj";this._syncTargetsToNativeObj(t),function(e,t,i,n,s){for(let o=0,r=t.length;o<r;o++){let r=t[o],a=r[i].$__nativeObj||r[i];r[i]=new Proxy(a,{get:(e,t)=>t===n?e:Reflect.get(e,t),set:(t,i,n)=>(Reflect.set(t,i,n),s(e),!0)})}}(this,this.targets,"_nativeObj",t,(e=>{e._syncTargetsToNativeObj(t)}))}_syncTargetsToNativeObj(e){const t=this.targets.map((t=>t.native[e]||t.native));this._nativeObj.targets=t}get native(){return this._nativeObj}constructor(e=!1,t=!1,i=new Po,n=[new Or]){this.targets=void 0,this._blendColor=void 0,this._nativeObj=void 0,this._isA2C=!1,this._isIndepend=!1,this._nativeObj=new gfx.BlendState,this._setTargets(n),this.blendColor=i,this.isA2c=e,this.isIndepend=t}get isA2c(){return this._isA2C}set isA2c(e){this._isA2C=e,this._nativeObj.isA2C=e}get isIndepend(){return this._isIndepend}set isIndepend(e){this._isIndepend=e,this._nativeObj.isIndepend=e}get blendColor(){return this._blendColor}set blendColor(e){this._blendColor=e,this._nativeObj.blendColor=e}setTarget(e,t){let i=this.targets[e];i||(i=this.targets[e]=new Or),i.assign(t),this._setTargets(this.targets)}reset(){this.isA2c=!1,this.isIndepend=!1,this.blendColor=new Po(0,0,0,0);const e=this.targets;for(let t=1,i=e.length;t<i;++t)e[t].destroy();e.length=1,e[0].reset(),this._setTargets(e)}destroy(){for(let e=0,t=this.targets.length;e<t;++e)this.targets[e].destroy();this.targets=null,this._nativeObj=null}}const Nr=gfx.PipelineState,Lr=gfx.PipelineStateInfo;class Br extends mr{get layout(){return this._layout}constructor(e){super(Is.DESCRIPTOR_SET),this._device=void 0,this._layout=null,this._buffers=[],this._textures=[],this._samplers=[],this._isDirty=!1,this._device=e}bindBuffer(e,t,i=0){const n=this._layout.bindingIndices[e],s=this._layout.bindings[n];if(s&&s.descriptorType&yr){const n=this._layout.descriptorIndices[e];this._buffers[n+i]!==t&&(this._buffers[n+i]=t,this._isDirty=!0)}}bindSampler(e,t,i=0){const n=this._layout.bindingIndices[e],s=this._layout.bindings[n];if(s&&s.descriptorType&xr){const n=this._layout.descriptorIndices[e];this._samplers[n+i]!==t&&(this._samplers[n+i]=t,this._isDirty=!0)}}bindTexture(e,t,i=0){const n=this._layout.bindingIndices[e],s=this._layout.bindings[n];if(s&&s.descriptorType&xr){const n=this._layout.descriptorIndices[e];this._textures[n+i]!==t&&(this._textures[n+i]=t,this._isDirty=!0)}}getBuffer(e,t=0){const i=this._layout.descriptorIndices[e];return this._buffers[i+t]}getSampler(e,t=0){const i=this._layout.descriptorIndices[e];return this._samplers[i+t]}getTexture(e,t=0){const i=this._layout.descriptorIndices[e];return this._textures[i+t]}}class zr extends mr{get usage(){return this._usage}get memUsage(){return this._memUsage}get size(){return this._size}get stride(){return this._stride}get count(){return this._count}get flags(){return this._flags}constructor(e){super(Is.BUFFER),this._device=void 0,this._usage=Fs.NONE,this._memUsage=ks.NONE,this._size=0,this._stride=1,this._count=0,this._flags=Us.NONE,this._indirectBuffer=null,this._isBufferView=!1,this._device=e}}class Fr extends mr{get type(){return this._type}get queue(){return this._queue}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}constructor(e){super(Is.COMMAND_BUFFER),this._device=void 0,this._queue=null,this._type=po.PRIMARY,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._device=e}}Fe(Ls);class Ur{constructor(){this._canvas=null,this._canvas2D=null,this._gfxAPI=Os.UNKNOWN,this._transform=Ds.IDENTITY,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(Ns.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._colorFmt=Ls.UNKNOWN,this._depthStencilFmt=Ls.UNKNOWN,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new pr,this._caps=new vo}get canvas(){return this._canvas}get canvas2D(){return this._canvas2D}get gfxAPI(){return this._gfxAPI}get queue(){return this._queue}get commandBuffer(){return this._cmdBuff}get devicePixelRatio(){return this._devicePixelRatio}get width(){return this._width}get height(){return this._height}get renderer(){return this._renderer}get vendor(){return this._vendor}get colorFormat(){return this._colorFmt}get depthStencilFormat(){return this._depthStencilFmt}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}get memoryStatus(){return this._memoryStatus}get capabilities(){return this._caps}get surfaceTransform(){return this._transform}hasFeature(e){return this._features[e]}}class Gr extends mr{get renderPass(){return this._renderPass}get colorTextures(){return this._colorTextures}get depthStencilTexture(){return this._depthStencilTexture}constructor(e){super(Is.FRAMEBUFFER),this._device=void 0,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._device=e}}const kr=String.prototype.charCodeAt;function Hr(e){return this[e]}function Vr(e,t){let i=e.length,n=t^i,s=0;const o="string"==typeof e?kr:Hr;for(;i>=4;){let t=255&o.call(e,s)|(255&o.call(e,++s))<<8|(255&o.call(e,++s))<<16|(255&o.call(e,++s))<<24;t=1540483477*(65535&t)+((1540483477*(t>>>16)&65535)<<16),t^=t>>>24,t=1540483477*(65535&t)+((1540483477*(t>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^t,i-=4,++s}switch(i){case 3:n^=(255&o.call(e,s+2))<<16;case 2:n^=(255&o.call(e,s+1))<<8;case 1:n^=255&o.call(e,s),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)}return n^=n>>>13,n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16),n^=n>>>15,n>>>0}class jr extends mr{get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get attributes(){return this._attributes}get attributesHash(){return this._attributesHash}get vertexCount(){return this._vertexCount}set vertexCount(e){this._vertexCount=e}get firstVertex(){return this._firstVertex}set firstVertex(e){this._firstVertex=e}get indexCount(){return this._indexCount}set indexCount(e){this._indexCount=e}get firstIndex(){return this._firstIndex}set firstIndex(e){this._firstIndex=e}get vertexOffset(){return this._vertexOffset}set vertexOffset(e){this._vertexOffset=e}get instanceCount(){return this._instanceCount}set instanceCount(e){this._instanceCount=e}get firstInstance(){return this._firstInstance}set firstInstance(e){this._firstInstance=e}get indirectBuffer(){return this._indirectBuffer}constructor(e){super(Is.INPUT_ASSEMBLER),this._device=void 0,this._attributes=[],this._vertexBuffers=[],this._indexBuffer=null,this._vertexCount=0,this._firstVertex=0,this._indexCount=0,this._firstIndex=0,this._vertexOffset=0,this._instanceCount=0,this._firstInstance=0,this._attributesHash=0,this._indirectBuffer=null,this._device=e}getVertexBuffer(e=0){return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}computeAttributesHash(){let e="attrs";for(let t=0;t<this.attributes.length;++t){const i=this.attributes[t];e+=`,${i.name},${i.format},${i.isNormalized},${i.stream},${i.isInstanced}`}return Vr(e,666)}}class Wr extends mr{get bindings(){return this._bindings}get bindingIndices(){return this._bindingIndices}get descriptorIndices(){return this._descriptorIndices}constructor(e){super(Is.DESCRIPTOR_SET_LAYOUT),this._device=void 0,this._bindings=[],this._bindingIndices=[],this._descriptorIndices=[],this._device=e}}class qr extends mr{get setLayouts(){return this._setLayouts}constructor(e){super(Is.PIPELINE_LAYOUT),this._device=void 0,this._setLayouts=[],this._device=e}}class Xr extends mr{get type(){return this._type}constructor(e){super(Is.QUEUE),this._device=void 0,this._type=_o.GRAPHICS,this._isAsync=!1,this._device=e}isAsync(){return this._isAsync}}class Yr extends mr{get colorAttachments(){return this._colorInfos}get depthStencilAttachment(){return this._depthStencilInfo}get subPasses(){return this._subpasses}get hash(){return this._hash}constructor(e){super(Is.RENDER_PASS),this._device=void 0,this._colorInfos=[],this._depthStencilInfo=null,this._subpasses=[],this._hash=0,this._device=e}computeHash(){let e="";if(this._subpasses.length)for(let t=0;t<this._subpasses.length;++t){const i=this._subpasses[t];if(i.inputs.length){e+="ia";for(let t=0;t<i.inputs.length;++t){const n=this._colorInfos[i.inputs[t]];e+=`,${n.format},${n.sampleCount}`}}if(i.colors.length){e+="ca";for(let t=0;t<i.inputs.length;++t){const n=this._colorInfos[i.inputs[t]];e+=`,${n.format},${n.sampleCount}`}}if(i.depthStencil>=0){const t=this._colorInfos[i.depthStencil];e+=`ds,${t.format},${t.sampleCount}`}}else{e+="ca";for(let t=0;t<this._colorInfos.length;++t){const i=this._colorInfos[t];e+=`,${i.format},${i.sampleCount}`}const t=this._depthStencilInfo;t&&(e+=`ds,${t.format},${t.sampleCount}`)}return Vr(e,666)}}class Kr extends mr{get minFilter(){return this._minFilter}get magFilter(){return this._magFilter}get mipFilter(){return this._mipFilter}get addressU(){return this._addressU}get addressV(){return this._addressV}get addressW(){return this._addressW}get maxAnisotropy(){return this._maxAnisotropy}get cmpFunc(){return this._cmpFunc}get borderColor(){return this._borderColor}get mipLODBias(){return this._mipLODBias}constructor(e){super(Is.SAMPLER),this._device=void 0,this._minFilter=qs.LINEAR,this._magFilter=qs.LINEAR,this._mipFilter=qs.NONE,this._addressU=Xs.WRAP,this._addressV=Xs.WRAP,this._addressW=Xs.WRAP,this._maxAnisotropy=16,this._cmpFunc=Ys.NEVER,this._borderColor=new Po,this._mipLODBias=0,this._device=e}}class $r extends mr{get id(){return this._id}get name(){return this._name}get attributes(){return this._attributes}get blocks(){return this._blocks}get samplers(){return this._samplers}constructor(e){super(Is.SHADER),this._device=void 0,this._id=void 0,this._name="",this._stages=[],this._attributes=[],this._blocks=[],this._samplers=[],this._device=e,this._id=$r._shaderIdGen++}}$r._shaderIdGen=0;class Qr extends mr{get type(){return this._type}get usage(){return this._usage}get format(){return this._format}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get layerCount(){return this._layerCount}get levelCount(){return this._levelCount}get samples(){return this._samples}get flags(){return this._flags}get size(){return this._size}constructor(e){super(Is.TEXTURE),this._device=void 0,this._type=Hs.TEX2D,this._usage=Vs.NONE,this._format=Ls.UNKNOWN,this._width=0,this._height=0,this._depth=1,this._layerCount=1,this._levelCount=1,this._samples=Ws.X1,this._flags=js.NONE,this._isPowerOf2=!1,this._size=0,this._device=e}}class Zr extends mr{constructor(e){super(Is.GLOBAL_BARRIER),this._device=void 0,this._info=new tr,this._device=e}initialize(e){return this._info.copy(e),!0}}class Jr extends mr{constructor(e){super(Is.TEXTURE_BARRIER),this._device=void 0,this._info=new ir,this._device=e}initialize(e){return this._info.copy(e),!0}}const ea={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(const e in n.gfx){if("__esModule"===e)continue;let t=ea[e];""===t?t=e:void 0===t&&(t=`GFX${e}`),ei(n,"cc",[{name:t,newName:e,target:n.gfx,targetName:"cc.gfx"}])}const ta=Object.assign({},Rr);ta.Device=gfx.Device,ta.Buffer=gfx.Buffer,ta.Texture=gfx.Texture,ta.Sampler=gfx.Sampler,ta.Shader=gfx.Shader,ta.InputAssembler=gfx.InputAssembler,ta.RenderPass=gfx.RenderPass,ta.Framebuffer=gfx.Framebuffer,ta.DescriptorSet=gfx.DescriptorSet,ta.DescriptorSetLayout=gfx.DescriptorSetLayout,ta.PipelineLayout=gfx.PipelineLayout,ta.PipelineState=gfx.PipelineState,ta.CommandBuffer=gfx.CommandBuffer,ta.Queue=gfx.Queue,n.gfx=ta;const ia=Or,na=Dr,sa=Ir,oa=Mr,ra=Nr,aa=Lr;let ca;ta.BlendTarget=Or,ta.BlendState=Dr,ta.RasterizerState=Ir,ta.DepthStencilState=Mr,ta.PipelineStateInfo=Lr,e("gfx",Object.freeze({__proto__:null,DescriptorSet:Br,Buffer:zr,CommandBuffer:Fr,get ObjectType(){return Is},get Status(){return Ms},get API(){return Os},get SurfaceTransform(){return Ds},get Feature(){return Ns},get Format(){return Ls},get FormatType(){return Bs},get Type(){return zs},get BufferUsageBit(){return Fs},get BufferFlagBit(){return Us},get MemoryAccessBit(){return Gs},get MemoryUsageBit(){return ks},get TextureType(){return Hs},get TextureUsageBit(){return Vs},get TextureFlagBit(){return js},get SampleCount(){return Ws},get Filter(){return qs},get Address(){return Xs},get ComparisonFunc(){return Ys},get StencilOp(){return Ks},get BlendFactor(){return $s},get BlendOp(){return Qs},get ColorMask(){return Zs},get ShaderStageFlagBit(){return Js},get LoadOp(){return eo},get StoreOp(){return to},get AccessType(){return io},get ResolveMode(){return no},get PipelineBindPoint(){return so},get PrimitiveMode(){return oo},get PolygonMode(){return ro},get ShadeModel(){return ao},get CullMode(){return co},get DynamicStateFlagBit(){return lo},get StencilFace(){return ho},get DescriptorType(){return uo},get QueueType(){return _o},get CommandBufferType(){return po},get ClearFlagBit(){return fo},Size:go,DeviceCaps:vo,Offset:yo,Rect:xo,Extent:So,TextureSubresLayers:bo,TextureSubresRange:To,TextureCopy:Eo,TextureBlit:Co,BufferTextureCopy:wo,Viewport:Ao,Color:Po,BindingMappingInfo:Ro,BufferInfo:Io,BufferViewInfo:Mo,DrawInfo:Oo,DispatchInfo:Do,IndirectBuffer:No,TextureInfo:Lo,TextureViewInfo:Bo,SamplerInfo:zo,Uniform:Fo,UniformBlock:Uo,UniformSamplerTexture:Go,UniformSampler:ko,UniformTexture:Ho,UniformStorageImage:Vo,UniformStorageBuffer:jo,UniformInputAttachment:Wo,ShaderStage:qo,Attribute:Xo,ShaderInfo:Yo,InputAssemblerInfo:Ko,ColorAttachment:$o,DepthStencilAttachment:Qo,SubpassInfo:Zo,SubpassDependency:Jo,RenderPassInfo:er,GlobalBarrierInfo:tr,TextureBarrierInfo:ir,FramebufferInfo:sr,DescriptorSetLayoutBinding:or,DescriptorSetLayoutInfo:rr,DescriptorSetInfo:ar,PipelineLayoutInfo:cr,InputState:lr,CommandBufferInfo:hr,QueueInfo:ur,FormatInfo:_r,MemoryStatus:pr,DynamicStencilStates:dr,DynamicStates:fr,Obj:mr,DeviceInfo:gr,get AttributeName(){return mo},FormatInfos:vr,DESCRIPTOR_BUFFER_TYPE:yr,DESCRIPTOR_SAMPLER_TYPE:xr,DESCRIPTOR_DYNAMIC_TYPE:Sr,DRAW_INFO_SIZE:br,IsPowerOf2:Tr,FormatSize:Er,FormatSurfaceSize:Cr,GetTypeSize:Ar,getTypedArrayConstructor:Pr,Device:Ur,Framebuffer:Gr,InputAssembler:jr,DescriptorSetLayout:Wr,PipelineLayout:qr,Queue:Xr,RenderPass:Yr,Sampler:Kr,Shader:$r,Texture:Qr,GlobalBarrier:Zr,TextureBarrier:Jr,BlendTarget:ia,BlendState:na,RasterizerState:sa,DepthStencilState:oa,PipelineState:ra,PipelineStateInfo:aa})),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(ca||(ca={}));const la=function(){const e=new zi(0,0,0);return function(t,i){const n=zi.dot(t.d,i.n);if(Math.abs(n)<Number.EPSILON)return 0;zi.multiplyScalar(e,i.n,i.d);const s=zi.dot(zi.subtract(e,e,t.o),i.n)/n;return s<0?0:s}}(),ha=function(){const e=new zi(0,0,0),t=new zi(0,0,0),i=new zi(0,0,0),n=new zi(0,0,0),s=new zi(0,0,0);return function(o,r,a){zi.subtract(e,r.b,r.a),zi.subtract(t,r.c,r.a),zi.cross(i,o.d,t);const c=zi.dot(e,i);if(c<Number.EPSILON&&(!a||c>-Number.EPSILON))return 0;const l=1/c;zi.subtract(n,o.o,r.a);const h=zi.dot(n,i)*l;if(h<0||h>1)return 0;zi.cross(s,n,e);const u=zi.dot(o.d,s)*l;if(u<0||h+u>1)return 0;const _=zi.dot(t,s)*l;return _<0?0:_}}(),ua=function(){const e=new zi(0,0,0);return function(t,i){const n=i.radius,s=i.center,o=t.o,r=t.d,a=n*n;zi.subtract(e,s,o);const c=e.lengthSqr(),l=zi.dot(e,r),h=a-(c-l*l);if(h<0)return 0;const u=Math.sqrt(h),_=c<a?l+u:l-u;return _<0?0:_}}(),_a=function(){const e=new zi,t=new zi;return function(i,n){return zi.subtract(e,n.center,n.halfExtents),zi.add(t,n.center,n.halfExtents),pa(i,e,t)}}();function pa(e,t,i){const n=e.o,s=e.d,o=1/s.x,r=1/s.y,a=1/s.z,c=(t.x-n.x)*o,l=(i.x-n.x)*o,h=(t.y-n.y)*r,u=(i.y-n.y)*r,_=(t.z-n.z)*a,p=(i.z-n.z)*a,d=Math.max(Math.max(Math.min(c,l),Math.min(h,u)),Math.min(_,p)),f=Math.min(Math.min(Math.max(c,l),Math.max(h,u)),Math.max(_,p));return f<0||d>f?0:d>0?d:f}const da=function(){let e=new zi,t=new zi,i=new zi;const n=new zi,s=new zi,o=new zi,r=new zi,a=new Array(3),c=new Array(3),l=new Array(3),h=new Array(6);return function(u,_){a[0]=_.halfExtents.x,a[1]=_.halfExtents.y,a[2]=_.halfExtents.z,e=_.center,t=u.o,i=u.d,zi.set(n,_.orientation.m00,_.orientation.m01,_.orientation.m02),zi.set(s,_.orientation.m03,_.orientation.m04,_.orientation.m05),zi.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),zi.subtract(r,e,t),c[0]=zi.dot(n,i),c[1]=zi.dot(s,i),c[2]=zi.dot(o,i),l[0]=zi.dot(n,r),l[1]=zi.dot(s,r),l[2]=zi.dot(o,r);for(let e=0;e<3;++e){if(0===c[e]){if(-l[e]-a[e]>0||-l[e]+a[e]<0)return 0;c[e]=1e-7}h[2*e+0]=(l[e]+a[e])/c[e],h[2*e+1]=(l[e]-a[e])/c[e]}const p=Math.max(Math.max(Math.min(h[0],h[1]),Math.min(h[2],h[3])),Math.min(h[4],h[5])),d=Math.min(Math.min(Math.max(h[0],h[1]),Math.max(h[2],h[3])),Math.max(h[4],h[5]));return d<0||p>d?0:p>0?p:d}}(),fa=function(){const e=new zi,t=new zi,i=new zi,n=new zi,s=new zi,o=new zi,r=new zi,a=new As;return function(c,l){const h=l.radius*l.radius,u=zi.normalize(e,c.d),_=l.ellipseCenter0,p=l.ellipseCenter1,d=zi.subtract(t,p,_);if(d.equals(zi.ZERO))return a.radius=l.radius,a.center.set(l.ellipseCenter0),qa.raySphere(c,a);const f=c.o,m=zi.subtract(i,f,_),g=zi.cross(n,u,d),v=g.lengthSqr();if(0===v){a.radius=l.radius;const e=zi.subtract(s,p,f);return m.lengthSqr()<e.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),qa.raySphere(c,a)}const y=zi.cross(s,m,d),x=d.lengthSqr(),S=2*zi.dot(g,y),b=S*S-4*v*(y.lengthSqr()-h*x);if(b<0)return 0;const T=(-S-Math.sqrt(b))/(2*v);if(T<0){a.radius=l.radius;const e=zi.subtract(o,p,f);return m.lengthSqr()<e.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),qa.raySphere(c,a)}{const e=zi.scaleAndAdd(o,c.o,u,T),t=zi.subtract(r,e,_),i=zi.dot(t,d)/x;return i>=0&&i<=1?T:i<0?(a.radius=l.radius,a.center.set(l.ellipseCenter0),qa.raySphere(c,a)):i>1?(a.radius=l.radius,a.center.set(l.ellipseCenter1),qa.raySphere(c,a)):0}}}(),ma=function(){const e=Ps.create(),t={distance:1/0,doubleSided:!1,mode:ca.ANY};let i=0;const n=(e,t,n,s,o,r)=>{e===ca.CLOSEST?(i>t||0===i)&&(i=t,r&&(0===r.length?r.push({distance:t,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:o/3}):(r[0].distance=t,r[0].vertexIndex0=n/3,r[0].vertexIndex1=s/3,r[0].vertexIndex2=o/3))):(i=t,r&&r.push({distance:t,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:o/3}))};return function(s,o,r){if(i=0,0===o.geometricInfo.positions.length)return i;const a=void 0===r?t:r;if(pa(s,o.geometricInfo.boundingBox.min,o.geometricInfo.boundingBox.max)){const t=o.primitiveMode,{positions:i,indices:r}=o.geometricInfo;((t,i,s,o,r)=>{if(s===oo.TRIANGLE_LIST){const s=i.length;for(let a=0;a<s;a+=3){const s=3*i[a],c=3*i[a+1],l=3*i[a+2];zi.set(e.a,t[s],t[s+1],t[s+2]),zi.set(e.b,t[c],t[c+1],t[c+2]),zi.set(e.c,t[l],t[l+1],t[l+2]);const h=qa.rayTriangle(o,e,r.doubleSided);if(!(0===h||h>r.distance)&&(n(r.mode,h,s,c,l,r.result),r.mode===ca.ANY))return h}}else if(s===oo.TRIANGLE_STRIP){const s=i.length-2;let a=0;for(let c=0;c<s;c+=1){const s=3*i[c-a],l=3*i[c+a+1],h=3*i[c+2];zi.set(e.a,t[s],t[s+1],t[s+2]),zi.set(e.b,t[l],t[l+1],t[l+2]),zi.set(e.c,t[h],t[h+1],t[h+2]),a=~a;const u=qa.rayTriangle(o,e,r.doubleSided);if(!(0===u||u>r.distance)&&(n(r.mode,u,s,l,h,r.result),r.mode===ca.ANY))return u}}else if(s===oo.TRIANGLE_FAN){const s=i.length-1,a=3*i[0];zi.set(e.a,t[a],t[a+1],t[a+2]);for(let c=1;c<s;c+=1){const s=3*i[c],l=3*i[c+1];zi.set(e.b,t[s],t[s+1],t[s+2]),zi.set(e.c,t[l],t[l+1],t[l+2]);const h=qa.rayTriangle(o,e,r.doubleSided);if(!(0===h||h>r.distance)&&(n(r.mode,h,a,s,l,r.result),r.mode===ca.ANY))return h}}})(i,r,t,s,a)}return i}}(),ga=function(){let e=0;const t={distance:1/0,doubleSided:!1,mode:ca.ANY};return function(i,n,s){e=0;const o=void 0===s?t:s,r=n.renderingSubMeshes.length,a=n.struct.minPosition,c=n.struct.maxPosition;if(a&&c&&!pa(i,a,c))return e;for(let t=0;t<r;t++){const s=n.renderingSubMeshes[t],r=ma(i,s,o);if(r)if(o.mode===ca.CLOSEST)(0===e||e>r)&&(e=r,o.subIndices&&(o.subIndices[0]=t));else if(e=r,o.subIndices&&o.subIndices.push(t),o.mode===ca.ANY)return r}return e&&o.mode===ca.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),va=function(){let e=0;const t={distance:1/0,doubleSided:!1,mode:ca.ANY},i=new Ss,n=new Zi;return function(s,o,r){e=0;const a=void 0===r?t:r,c=o.worldBounds;if(c&&!_a(s,c))return e;Ss.copy(i,s),o.node&&(Zi.invert(n,o.node.getWorldMatrix(n)),zi.transformMat4(i.o,s.o,n),zi.transformMat4Normal(i.d,s.d,n));const l=o.subModels;for(let t=0;t<l.length;t++){const n=l[t].subMesh,s=ma(i,n,a);if(s)if(a.mode===ca.CLOSEST)(0===e||e>s)&&(e=s,a.subIndices&&(a.subIndices[0]=t));else if(e=s,a.subIndices&&a.subIndices.push(t),a.mode===ca.ANY)return s}return e&&a.mode===ca.CLOSEST&&(a.result&&(a.result[0].distance=e,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),e}}(),ya=function(){const e=new zi(0,0,0);return function(t,i){zi.subtract(e,t.e,t.s);const n=(i.d-zi.dot(t.s,i.n))/zi.dot(e,i.n);return n<0||n>1?0:n}}(),xa=function(){const e=new zi(0,0,0),t=new zi(0,0,0),i=new zi(0,0,0),n=new zi(0,0,0),s=new zi(0,0,0),o=new zi(0,0,0);return function(r,a,c){zi.subtract(e,a.b,a.a),zi.subtract(t,a.c,a.a),zi.subtract(i,r.s,r.e),zi.cross(s,e,t);const l=zi.dot(i,s);if(l<=0)return 0;zi.subtract(n,r.s,a.a);const h=zi.dot(n,s);if(h<0||h>l)return 0;zi.cross(o,i,n);let u=zi.dot(t,o);if(u<0||u>l)return 0;let _=-zi.dot(e,o);if(_<0||u+_>l)return 0;if(c){const e=1/l;u*=e,_*=e;const t=1-u-_;zi.set(c,a.a.x*t+a.b.x*u+a.c.x*_,a.a.y*t+a.b.y*u+a.c.y*_,a.a.z*t+a.b.z*u+a.c.z*_)}return 1}}(),Sa=new Ss;function ba(e,t){Sa.o.set(e.s),zi.subtract(Sa.d,e.e,e.s),Sa.d.normalize();const i=_a(Sa,t);return i<=e.length()?i:0}function Ta(e,t){Sa.o.set(e.s),zi.subtract(Sa.d,e.e,e.s),Sa.d.normalize();const i=da(Sa,t);return i<=e.length()?i:0}function Ea(e,t){Sa.o.set(e.s),zi.subtract(Sa.d,e.e,e.s),Sa.d.normalize();const i=ua(Sa,t);return i<=e.length()?i:0}const Ca=function(){const e=new zi,t=new zi,i=new zi,n=new zi;return function(s,o){return zi.subtract(e,s.center,s.halfExtents),zi.add(t,s.center,s.halfExtents),zi.subtract(i,o.center,o.halfExtents),zi.add(n,o.center,o.halfExtents),e.x<=n.x&&t.x>=i.x&&e.y<=n.y&&t.y>=i.y&&e.z<=n.z&&t.z>=i.z}}();function wa(e,t,i,n,s,o){zi.set(o[0],e.x+i.x*t.x+n.x*t.y+s.x*t.z,e.y+i.y*t.x+n.y*t.y+s.y*t.z,e.z+i.z*t.x+n.z*t.y+s.z*t.z),zi.set(o[1],e.x-i.x*t.x+n.x*t.y+s.x*t.z,e.y-i.y*t.x+n.y*t.y+s.y*t.z,e.z-i.z*t.x+n.z*t.y+s.z*t.z),zi.set(o[2],e.x+i.x*t.x-n.x*t.y+s.x*t.z,e.y+i.y*t.x-n.y*t.y+s.y*t.z,e.z+i.z*t.x-n.z*t.y+s.z*t.z),zi.set(o[3],e.x+i.x*t.x+n.x*t.y-s.x*t.z,e.y+i.y*t.x+n.y*t.y-s.y*t.z,e.z+i.z*t.x+n.z*t.y-s.z*t.z),zi.set(o[4],e.x-i.x*t.x-n.x*t.y-s.x*t.z,e.y-i.y*t.x-n.y*t.y-s.y*t.z,e.z-i.z*t.x-n.z*t.y-s.z*t.z),zi.set(o[5],e.x+i.x*t.x-n.x*t.y-s.x*t.z,e.y+i.y*t.x-n.y*t.y-s.y*t.z,e.z+i.z*t.x-n.z*t.y-s.z*t.z),zi.set(o[6],e.x-i.x*t.x+n.x*t.y-s.x*t.z,e.y-i.y*t.x+n.y*t.y-s.y*t.z,e.z-i.z*t.x+n.z*t.y-s.z*t.z),zi.set(o[7],e.x-i.x*t.x-n.x*t.y+s.x*t.z,e.y-i.y*t.x-n.y*t.y+s.y*t.z,e.z-i.z*t.x-n.z*t.y+s.z*t.z)}function Aa(e,t){let i=zi.dot(t,e[0]),n=i;for(let s=1;s<8;++s){const o=zi.dot(t,e[s]);i=o<i?o:i,n=o>n?o:n}return[i,n]}const Pa=function(){const e=new Array(15);for(let t=0;t<15;t++)e[t]=new zi(0,0,0);const t=new Array(8),i=new Array(8);for(let e=0;e<8;e++)t[e]=new zi(0,0,0),i[e]=new zi(0,0,0);const n=new zi,s=new zi;return function(o,r){zi.set(e[0],1,0,0),zi.set(e[1],0,1,0),zi.set(e[2],0,0,1),zi.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),zi.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),zi.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(let t=0;t<3;++t)zi.cross(e[6+3*t],e[t],e[0]),zi.cross(e[7+3*t],e[t],e[1]),zi.cross(e[7+3*t],e[t],e[2]);zi.subtract(n,o.center,o.halfExtents),zi.add(s,o.center,o.halfExtents),function(e,t,i){zi.set(i[0],e.x,t.y,t.z),zi.set(i[1],e.x,t.y,e.z),zi.set(i[2],e.x,e.y,t.z),zi.set(i[3],e.x,e.y,e.z),zi.set(i[4],t.x,t.y,t.z),zi.set(i[5],t.x,t.y,e.z),zi.set(i[6],t.x,e.y,t.z),zi.set(i[7],t.x,e.y,e.z)}(n,s,t),wa(r.center,r.halfExtents,e[3],e[4],e[5],i);for(let n=0;n<15;++n){const s=Aa(t,e[n]),o=Aa(i,e[n]);if(o[0]>s[1]||s[0]>o[1])return 0}return 1}}(),Ra=function(e,t){const i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=zi.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},Ia=function(e,t){for(let i=0;i<t.planes.length;i++)if(-1===Ra(e,t.planes[i]))return 0;return 1},Ma=function(){const e=new Array(8);let t=0,i=0;for(let t=0;t<e.length;t++)e[t]=new zi(0,0,0);return function(n,s){let o=0,r=!1;for(let e=0;e<s.planes.length;e++){if(o=Ra(n,s.planes[e]),-1===o)return 0;1===o&&(r=!0)}if(!r)return 1;for(let t=0;t<s.vertices.length;t++)zi.subtract(e[t],s.vertices[t],n.center);t=0,i=0;for(let o=0;o<s.vertices.length;o++)e[o].x>n.halfExtents.x?t++:e[o].x<-n.halfExtents.x&&i++;if(t===s.vertices.length||i===s.vertices.length)return 0;t=0,i=0;for(let o=0;o<s.vertices.length;o++)e[o].y>n.halfExtents.y?t++:e[o].y<-n.halfExtents.y&&i++;if(t===s.vertices.length||i===s.vertices.length)return 0;t=0,i=0;for(let o=0;o<s.vertices.length;o++)e[o].z>n.halfExtents.z?t++:e[o].z<-n.halfExtents.z&&i++;return t===s.vertices.length||i===s.vertices.length?0:1}}(),Oa=function(){const e=new zi(0,0,0),t=new ki;return function(i,n){return zi.subtract(e,n,i.center),zi.transformMat3(e,e,ki.transpose(t,i.orientation)),s=e,o=i.halfExtents,Math.abs(s.x)<o.x&&Math.abs(s.y)<o.y&&Math.abs(s.z)<o.z;var s,o}}(),Da=function(){const e=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)};return function(t,i){const n=t.halfExtents.x*e(i.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*e(i.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*e(i.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),s=zi.dot(i.n,t.center);return s+n<i.d?-1:s-n>i.d?0:1}}(),Na=function(e,t){for(let i=0;i<t.planes.length;i++)if(-1===Da(e,t.planes[i]))return 0;return 1},La=function(){const e=new Array(8);let t=0,i=0,n=0;for(let t=0;t<e.length;t++)e[t]=new zi(0,0,0);const s=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(o,r){let a=0,c=!1;for(let e=0;e<r.planes.length;e++){if(a=Da(o,r.planes[e]),-1===a)return 0;1===a&&(c=!0)}if(!c)return 1;for(let t=0;t<r.vertices.length;t++)zi.subtract(e[t],r.vertices[t],o.center);i=0,n=0;for(let a=0;a<r.vertices.length;a++)t=s(e[a],o.orientation.m00,o.orientation.m01,o.orientation.m02),t>o.halfExtents.x?i++:t<-o.halfExtents.x&&n++;if(i===r.vertices.length||n===r.vertices.length)return 0;i=0,n=0;for(let a=0;a<r.vertices.length;a++)t=s(e[a],o.orientation.m03,o.orientation.m04,o.orientation.m05),t>o.halfExtents.y?i++:t<-o.halfExtents.y&&n++;if(i===r.vertices.length||n===r.vertices.length)return 0;i=0,n=0;for(let a=0;a<r.vertices.length;a++)t=s(e[a],o.orientation.m06,o.orientation.m07,o.orientation.m08),t>o.halfExtents.z?i++:t<-o.halfExtents.z&&n++;return i===r.vertices.length||n===r.vertices.length?0:1}}(),Ba=function(){const e=new Array(15);for(let t=0;t<15;t++)e[t]=new zi(0,0,0);const t=new Array(8),i=new Array(8);for(let e=0;e<8;e++)t[e]=new zi(0,0,0),i[e]=new zi(0,0,0);return function(n,s){zi.set(e[0],n.orientation.m00,n.orientation.m01,n.orientation.m02),zi.set(e[1],n.orientation.m03,n.orientation.m04,n.orientation.m05),zi.set(e[2],n.orientation.m06,n.orientation.m07,n.orientation.m08),zi.set(e[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),zi.set(e[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),zi.set(e[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(let t=0;t<3;++t)zi.cross(e[6+3*t],e[t],e[3]),zi.cross(e[7+3*t],e[t],e[4]),zi.cross(e[8+3*t],e[t],e[5]);wa(n.center,n.halfExtents,e[0],e[1],e[2],t),wa(s.center,s.halfExtents,e[3],e[4],e[5],i);for(let n=0;n<15;++n){const s=Aa(t,e[n]),o=Aa(i,e[n]);if(o[0]>s[1]||s[0]>o[1])return 0}return 1}}(),za=function(){const e=new As,t=new zi,i=new zi,n=new zi,s=new Array(8);for(let e=0;e<8;e++)s[e]=new zi;const o=new Array(8);for(let e=0;e<8;e++)o[e]=new zi;return function(r,a){if(0===zi.squaredDistance(a.ellipseCenter0,a.ellipseCenter1))return e.radius=a.radius,e.center.set(a.ellipseCenter0),qa.sphereOBB(e,r);{t.x=r.orientation.m00,t.y=r.orientation.m01,t.z=r.orientation.m02,i.x=r.orientation.m03,i.y=r.orientation.m04,i.z=r.orientation.m05,n.x=r.orientation.m06,n.y=r.orientation.m07,n.z=r.orientation.m08,wa(r.center,r.halfExtents,t,i,n,s);const e=o,c=zi.copy(e[0],t),l=zi.copy(e[1],i),h=zi.copy(e[2],n);zi.subtract(e[3],a.center,r.center).normalize();const u=zi.subtract(e[4],a.ellipseCenter0,a.ellipseCenter1);u.normalize(),zi.cross(e[5],c,u),zi.cross(e[6],l,u),zi.cross(e[7],h,u);for(let t=0;t<8;++t){const i=Aa(s,e[t]),n=zi.dot(e[t],a.ellipseCenter0),o=zi.dot(e[t],a.ellipseCenter1),r=Math.max(n,o),c=Math.min(n,o)-a.radius,l=r+a.radius;if(c>i[1]||i[0]>l)return 0}return 1}}}(),Fa=function(e,t){const i=zi.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1},Ua=function(e,t){for(let i=0;i<t.planes.length;i++)if(-1===Fa(e,t.planes[i]))return 0;return 1},Ga=function(){const e=new zi(0,0,0),t=[1,-1,1,-1,1,-1];return function(i,n){for(let s=0;s<6;s++){const o=n.planes[s],r=i.radius,a=i.center,c=o.n,l=o.d,h=zi.dot(c,a);if(h+r<l)return 0;if(!(h-r>l)){zi.add(e,a,zi.multiplyScalar(e,c,r));for(let i=0;i<6;i++){if(i===s||i===s+t[s])continue;const o=n.planes[i];if(zi.dot(o.n,e)<o.d)return 0}}}return 1}}(),ka=function(e,t){const i=e.radius+t.radius;return zi.squaredDistance(e.center,t.center)<i*i},Ha=function(){const e=new zi;return function(t,i){return ms(e,t.center,i),zi.squaredDistance(t.center,e)<t.radius*t.radius}}(),Va=function(){const e=new zi;return function(t,i){return gs(e,t.center,i),zi.squaredDistance(t.center,e)<t.radius*t.radius}}(),ja=function(){const e=new zi,t=new zi;return function(i,n){const s=i.radius+n.radius,o=s*s,r=zi.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===r)return zi.squaredDistance(i.center,n.center)<o;{zi.subtract(e,i.center,n.ellipseCenter0),zi.subtract(t,n.ellipseCenter1,n.ellipseCenter0);const s=zi.dot(e,t)/r;return s<0?zi.squaredDistance(i.center,n.ellipseCenter0)<o:s>1?zi.squaredDistance(i.center,n.ellipseCenter1)<o:(zi.scaleAndAdd(e,n.ellipseCenter0,t,s),zi.squaredDistance(i.center,e)<o)}}}(),Wa=function(){const e=new zi,t=new zi,i=new zi,n=new zi,s=new zi,o=new zi;return function(r,a){const c=zi.subtract(e,r.ellipseCenter1,r.ellipseCenter0),l=zi.subtract(t,a.ellipseCenter1,a.ellipseCenter0),h=zi.subtract(i,r.ellipseCenter0,a.ellipseCenter0),u=zi.dot(c,c),_=zi.dot(c,l),p=zi.dot(l,l),d=zi.dot(c,h),f=zi.dot(l,h),m=u*p-_*_;let g,v,y=m,x=m;m<ui?(g=0,y=1,v=f,x=p):(g=_*f-p*d,v=u*f-_*d,g<0?(g=0,v=f,x=p):g>y&&(g=y,v=f+_,x=p)),v<0?(v=0,-d<0?g=0:-d>u?g=y:(g=-d,y=u)):v>x&&(v=x,-d+_<0?g=0:-d+_>u?g=y:(g=-d+_,y=u));const S=Math.abs(g)<ui?0:g/y,b=Math.abs(v)<ui?0:v/x,T=n;T.set(h),T.add(zi.multiplyScalar(s,c,S)),T.subtract(zi.multiplyScalar(o,l,b));const E=r.radius+a.radius;return T.lengthSqr()<E*E}}(),qa={raySphere:ua,rayAABB:_a,rayOBB:da,rayPlane:la,rayTriangle:ha,rayCapsule:fa,raySubMesh:ma,rayMesh:ga,rayModel:va,lineSphere:Ea,lineAABB:ba,lineOBB:Ta,linePlane:ya,lineTriangle:xa,sphereWithSphere:ka,sphereAABB:Ha,sphereOBB:Va,spherePlane:Fa,sphereFrustum:Ua,sphereFrustumAccurate:Ga,sphereCapsule:ja,aabbWithAABB:Ca,aabbWithOBB:Pa,aabbPlane:Ra,aabbFrustum:Ia,aabbFrustumAccurate:Ma,obbWithOBB:Ba,obbPlane:Da,obbFrustum:Na,obbFrustumAccurate:La,obbPoint:Oa,obbCapsule:za,capsuleWithCapsule:Wa,resolve(e,t,i=null){const n=e._type,s=t._type,o=this[n|s];return n<s?o(e,t,i):o(t,e,i)}};qa[ys.SHAPE_RAY|ys.SHAPE_SPHERE]=ua,qa[ys.SHAPE_RAY|ys.SHAPE_AABB]=_a,qa[ys.SHAPE_RAY|ys.SHAPE_OBB]=da,qa[ys.SHAPE_RAY|ys.SHAPE_PLANE]=la,qa[ys.SHAPE_RAY|ys.SHAPE_TRIANGLE]=ha,qa[ys.SHAPE_RAY|ys.SHAPE_CAPSULE]=fa,qa[ys.SHAPE_LINE|ys.SHAPE_SPHERE]=Ea,qa[ys.SHAPE_LINE|ys.SHAPE_AABB]=ba,qa[ys.SHAPE_LINE|ys.SHAPE_OBB]=Ta,qa[ys.SHAPE_LINE|ys.SHAPE_PLANE]=ya,qa[ys.SHAPE_LINE|ys.SHAPE_TRIANGLE]=xa,qa[ys.SHAPE_SPHERE]=ka,qa[ys.SHAPE_SPHERE|ys.SHAPE_AABB]=Ha,qa[ys.SHAPE_SPHERE|ys.SHAPE_OBB]=Va,qa[ys.SHAPE_SPHERE|ys.SHAPE_PLANE]=Fa,qa[ys.SHAPE_SPHERE|ys.SHAPE_FRUSTUM]=Ua,qa[ys.SHAPE_SPHERE|ys.SHAPE_FRUSTUM_ACCURATE]=Ga,qa[ys.SHAPE_SPHERE|ys.SHAPE_CAPSULE]=ja,qa[ys.SHAPE_AABB]=Ca,qa[ys.SHAPE_AABB|ys.SHAPE_OBB]=Pa,qa[ys.SHAPE_AABB|ys.SHAPE_PLANE]=Ra,qa[ys.SHAPE_AABB|ys.SHAPE_FRUSTUM]=Ia,qa[ys.SHAPE_AABB|ys.SHAPE_FRUSTUM_ACCURATE]=Ma,qa[ys.SHAPE_OBB]=Ba,qa[ys.SHAPE_OBB|ys.SHAPE_PLANE]=Da,qa[ys.SHAPE_OBB|ys.SHAPE_FRUSTUM]=Na,qa[ys.SHAPE_OBB|ys.SHAPE_FRUSTUM_ACCURATE]=La,qa[ys.SHAPE_OBB|ys.SHAPE_CAPSULE]=za,qa[ys.SHAPE_CAPSULE]=Wa,ei(xs.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),ti(qa,"intersect",[{name:"line_quad"}]);const Xa=new zi(0,0,0),Ya=new zi(0,0,0),Ka=n.mat4(),$a=n.v4();class Qa{static create(e,t,i,n){return new Qa(e,t,i,n)}static clone(e){return new Qa(e.n.x,e.n.y,e.n.z,e.d)}static copy(e,t){return zi.copy(e.n,t.n),e.d=t.d,e}static fromPoints(e,t,i,n){return zi.subtract(Xa,i,t),zi.subtract(Ya,n,t),zi.normalize(e.n,zi.cross(e.n,Xa,Ya)),e.d=zi.dot(e.n,t),e}static set(e,t,i,n,s){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=s,e}static fromNormalAndPoint(e,t,i){return zi.copy(e.n,t),e.d=zi.dot(t,i),e}static normalize(e,t){const i=t.n.length();return zi.normalize(e.n,t.n),i>0&&(e.d=t.d/i),e}get type(){return this._type}set x(e){this.n.x=e}get x(){return this.n.x}set y(e){this.n.y=e}get y(){return this.n.y}set z(e){this.n.z=e}get z(){return this.n.z}set w(e){this.d=e}get w(){return this.d}constructor(e=0,t=1,i=0,n=0){this.n=void 0,this.d=void 0,this._type=void 0,this._type=ys.SHAPE_PLANE,this.n=new zi(e,t,i),this.d=n}transform(e){Zi.invert(Ka,e),Zi.transpose(Ka,Ka),an.set($a,this.n.x,this.n.y,this.n.z,this.d),an.transformMat4($a,$a,Ka),zi.set(this.n,$a.x,$a.y,$a.z),this.d=$a.w}}const Za=jsb.NativeBufferPool;var Ja;jsb.NativeObjectPool,jsb.NativeBufferAllocator,function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(Ja||(Ja={}));class ec{constructor(e,t,i,n,s=8){this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=s,this._dataType=t,this._dataMembers=i,this._stride=4*this._elementCount,this._entriesPerChunk=1<<s,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Za(e,s,this._stride);let o=Ja.NEVER,r=!1,a=!1;for(const e in t){if(r=this._hasFloat32,a=this._hasUint32,a&&r)break;o=t[e],r||o!==Ja.FLOAT32?a||o!==Ja.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}alloc(){let e=0;for(;e<this._freeLists.length;e++){const t=this._freeLists[e];if(t.length){const i=t[t.length-1];return t.length--,(e<<this._entryBits)+i+this._poolFlag}}const t=this._nativePool.allocateNewChunk(),i=[],n=[],s=[],o=this._hasFloat32,r=this._hasUint32;for(let e=0;e<this._entriesPerChunk;e++)o&&i.push(new Float32Array(t,this._stride*e,this._elementCount)),r&&n.push(new Uint32Array(t,this._stride*e,this._elementCount)),e&&s.push(e);return r&&this._uint32BufferViews.push(n),o&&this._float32BufferViews.push(i),this._freeLists.push(s),this._arrayBuffers.push(t),(e<<this._entryBits)+this._poolFlag}getBuffer(e){const t=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][i]}getTypedArray(e,t){const i=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e,s=t,o=(this._dataType[t]===Ja.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n],r=this._dataMembers[t];return o.subarray(s,s+r)}free(e){const t=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][i].fill(0),this._freeLists[t].push(i)}}let tc,ic;!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(tc||(tc={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(ic||(ic={}));const nc={[ic.DIRTY_FLAG]:Ja.UINT32,[ic.LAYER]:Ja.UINT32,[ic.WORLD_SCALE]:Ja.FLOAT32,[ic.WORLD_POSITION]:Ja.FLOAT32,[ic.WORLD_ROTATION]:Ja.FLOAT32,[ic.WORLD_MATRIX]:Ja.FLOAT32,[ic.LOCAL_SCALE]:Ja.FLOAT32,[ic.LOCAL_POSITION]:Ja.FLOAT32,[ic.LOCAL_ROTATION]:Ja.FLOAT32,[ic.COUNT]:Ja.NEVER},sc={[ic.DIRTY_FLAG]:ic.LAYER-ic.DIRTY_FLAG,[ic.LAYER]:ic.WORLD_SCALE-ic.LAYER,[ic.WORLD_SCALE]:ic.WORLD_POSITION-ic.WORLD_SCALE,[ic.WORLD_POSITION]:ic.WORLD_ROTATION-ic.WORLD_POSITION,[ic.WORLD_ROTATION]:ic.WORLD_MATRIX-ic.WORLD_ROTATION,[ic.WORLD_MATRIX]:ic.LOCAL_SCALE-ic.WORLD_MATRIX,[ic.LOCAL_SCALE]:ic.LOCAL_POSITION-ic.LOCAL_SCALE,[ic.LOCAL_POSITION]:ic.LOCAL_ROTATION-ic.LOCAL_POSITION,[ic.LOCAL_ROTATION]:ic.COUNT-ic.LOCAL_ROTATION,[ic.COUNT]:1},oc=new ec(tc.NODE,nc,sc,ic);let rc;!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(rc||(rc={}));const ac={[rc.PRIORITY]:Ja.UINT32,[rc.STAGE]:Ja.UINT32,[rc.PHASE]:Ja.UINT32,[rc.PRIMITIVE]:Ja.UINT32,[rc.BATCHING_SCHEME]:Ja.UINT32,[rc.DYNAMIC_STATE]:Ja.UINT32,[rc.HASH]:Ja.UINT32,[rc.COUNT]:Ja.NEVER},cc={[rc.PRIORITY]:rc.STAGE-rc.PRIORITY,[rc.STAGE]:rc.PHASE-rc.STAGE,[rc.PHASE]:rc.PRIMITIVE-rc.PHASE,[rc.PRIMITIVE]:rc.BATCHING_SCHEME-rc.PRIMITIVE,[rc.BATCHING_SCHEME]:rc.DYNAMIC_STATE-rc.BATCHING_SCHEME,[rc.DYNAMIC_STATE]:rc.HASH-rc.DYNAMIC_STATE,[rc.HASH]:rc.COUNT-rc.HASH,[rc.COUNT]:1},lc=new ec(tc.PASS,ac,cc,rc);let hc;!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(hc||(hc={}));const uc={[hc.CENTER]:Ja.FLOAT32,[hc.HALFEXTENTS]:Ja.FLOAT32,[hc.COUNT]:Ja.NEVER},_c={[hc.CENTER]:hc.HALFEXTENTS-hc.CENTER,[hc.HALFEXTENTS]:hc.COUNT-hc.HALFEXTENTS,[hc.COUNT]:1},pc=new ec(tc.AABB,uc,_c,hc),dc=new zi,fc=new zi,mc=new zi,gc=new zi,vc=new ki,yc=(e,t,i)=>{vc.m00=Math.abs(i.m00),vc.m01=Math.abs(i.m01),vc.m02=Math.abs(i.m02),vc.m03=Math.abs(i.m04),vc.m04=Math.abs(i.m05),vc.m05=Math.abs(i.m06),vc.m06=Math.abs(i.m08),vc.m07=Math.abs(i.m09),vc.m08=Math.abs(i.m10),zi.transformMat3(e,t,vc)};class xc{static create(e,t,i,n,s,o){return new xc(e,t,i,n,s,o)}static clone(e){return new xc(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)}static copy(e,t){return zi.copy(e.center,t.center),zi.copy(e.halfExtents,t.halfExtents),e}static fromPoints(e,t,i){return zi.add(dc,i,t),zi.subtract(fc,i,t),zi.multiplyScalar(e.center,dc,.5),zi.multiplyScalar(e.halfExtents,fc,.5),e}static set(e,t,i,n,s,o,r){return e.center.set(t,i,n),e.halfExtents.set(s,o,r),e}static merge(e,t,i){return zi.subtract(dc,t.center,t.halfExtents),zi.subtract(fc,i.center,i.halfExtents),zi.add(mc,t.center,t.halfExtents),zi.add(gc,i.center,i.halfExtents),zi.max(gc,mc,gc),zi.min(mc,dc,fc),xc.fromPoints(e,mc,gc)}static toBoundingSphere(e,t){t.getBoundary(dc,fc),e.center.set(dc),e.radius=0,zi.subtract(mc,fc,e.center);const i=mc.length(),n=.5*i;return e.radius+=n,zi.multiplyScalar(mc,mc,n/i),zi.add(e.center,e.center,mc),e}static transform(e,t,i){return zi.transformMat4(e.center,t.center,i),yc(e.halfExtents,t.halfExtents,i),e}get type(){return this._type}constructor(e=0,t=0,i=0,n=1,s=1,o=1){return this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=ys.SHAPE_AABB,this._aabbHandle=pc.alloc(),this.center=new zi(pc.getTypedArray(this._aabbHandle,hc.CENTER)),this.halfExtents=new zi(pc.getTypedArray(this._aabbHandle,hc.HALFEXTENTS)),this.center.set(e,t,i),this.halfExtents.set(n,s,o),this._nativeObj=new os,void this._nativeObj.initWithData(pc.getBuffer(this._aabbHandle))}get native(){return this._nativeObj}getBoundary(e,t){zi.subtract(e,this.center,this.halfExtents),zi.add(t,this.center,this.halfExtents)}transform(e,t,i,n,s){zi.transformMat4(s.center,this.center,e),yc(s.halfExtents,this.halfExtents,e)}clone(){return xc.clone(this)}copy(e){return xc.copy(this,e)}mergePoint(e){this.getBoundary(dc,fc),e.x<dc.x&&(dc.x=e.x),e.y<dc.y&&(dc.y=e.y),e.z<dc.z&&(dc.z=e.z),e.x>fc.x&&(fc.x=e.x),e.y>fc.y&&(fc.y=e.y),e.z>fc.z&&(fc.z=e.z),zi.add(mc,dc,fc),this.center.set(zi.multiplyScalar(mc,mc,.5)),this.halfExtents.set(fc.x-mc.x,fc.y-mc.y,fc.z-mc.z)}mergePoints(e){if(!(e.length<1))for(let t=0;t<e.length;t++)this.mergePoint(e[t])}mergeFrustum(e){return this.mergePoints(e.vertices)}}const Sc=new zi,bc=new zi,Tc=new ki;class Ec{static create(e,t,i,n,s,o,r,a,c,l,h,u,_,p,d){return new Ec(e,t,i,n,s,o,r,a,c,l,h,u,_,p,d)}static clone(e){return new Ec(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)}static copy(e,t){return zi.copy(e.center,t.center),zi.copy(e.halfExtents,t.halfExtents),ki.copy(e.orientation,t.orientation),e}static fromPoints(e,t,i){return zi.multiplyScalar(e.center,zi.add(Sc,t,i),.5),zi.multiplyScalar(e.halfExtents,zi.subtract(bc,i,t),.5),ki.identity(e.orientation),e}static set(e,t,i,n,s,o,r,a,c,l,h,u,_,p,d,f){return zi.set(e.center,t,i,n),zi.set(e.halfExtents,s,o,r),ki.set(e.orientation,a,c,l,h,u,_,p,d,f),e}get type(){return this._type}constructor(e=0,t=0,i=0,n=1,s=1,o=1,r=1,a=0,c=0,l=0,h=1,u=0,_=0,p=0,d=1){this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=ys.SHAPE_OBB,this.center=new zi(e,t,i),this.halfExtents=new zi(n,s,o),this.orientation=new ki(r,a,c,l,h,u,_,p,d)}getBoundary(e,t){var i,n,s;i=Sc,n=this.halfExtents,s=this.orientation,Tc.m00=Math.abs(s.m00),Tc.m01=Math.abs(s.m01),Tc.m02=Math.abs(s.m02),Tc.m03=Math.abs(s.m03),Tc.m04=Math.abs(s.m04),Tc.m05=Math.abs(s.m05),Tc.m06=Math.abs(s.m06),Tc.m07=Math.abs(s.m07),Tc.m08=Math.abs(s.m08),zi.transformMat3(i,n,Tc),zi.subtract(e,this.center,Sc),zi.add(t,this.center,Sc)}transform(e,t,i,n,s){zi.transformMat4(s.center,this.center,e),ki.fromQuat(s.orientation,i),zi.multiply(s.halfExtents,this.halfExtents,n)}translateAndRotate(e,t,i){zi.transformMat4(i.center,this.center,e),ki.fromQuat(i.orientation,t)}setScale(e,t){zi.multiply(t.halfExtents,this.halfExtents,e)}}class Cc{get type(){return this._type}constructor(e=.5,t=.5,i=1){this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=ys.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=i,this.center=new zi,this.rotation=new ji,this.ellipseCenter0=new zi(0,t,0),this.ellipseCenter1=new zi(0,-t,0),this.updateCache()}transform(e,t,i,n,s){const o=n,r=Ri(o);s.radius=this.radius*Math.abs(r);let a=(this.halfHeight+this.radius)*Math.abs(o.y)-s.radius;a<0&&(a=0),s.halfHeight=a,zi.transformMat4(s.center,this.center,e),ji.multiply(s.rotation,this.rotation,i),s.updateCache()}updateCache(){this.updateLocalCenter(),zi.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),zi.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}updateLocalCenter(){const e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}}}const wc=new Array(8);wc[0]=new zi(1,1,1),wc[1]=new zi(-1,1,1),wc[2]=new zi(-1,-1,1),wc[3]=new zi(1,-1,1),wc[4]=new zi(1,1,-1),wc[5]=new zi(-1,1,-1),wc[6]=new zi(-1,-1,-1),wc[7]=new zi(1,-1,-1);const Ac=new zi,Pc=new zi,Rc=new zi;class Ic{set accurate(e){this._type=e?ys.SHAPE_FRUSTUM_ACCURATE:ys.SHAPE_FRUSTUM}static createFromAABB(e,t){const i=new zi,n=new zi;return zi.subtract(i,t.center,t.halfExtents),zi.add(n,t.center,t.halfExtents),e.vertices[0].set(i.x,n.y,i.z),e.vertices[1].set(n.x,n.y,i.z),e.vertices[2].set(n.x,i.y,i.z),e.vertices[3].set(i.x,i.y,i.z),e.vertices[4].set(i.x,n.y,n.z),e.vertices[5].set(n.x,n.y,n.z),e.vertices[6].set(n.x,i.y,n.z),e.vertices[7].set(i.x,i.y,n.z),e._type!==ys.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e}static split(e,t,i,n,s){const o=Math.tan(.5*t.fov),r=o*t.aspect;Ac.set(n*r,n*o,n),Pc.set(s*r,s*o,s);const a=e.vertices;return Rc.set(Ac.x,Ac.y,Ac.z),zi.transformMat4(a[0],Rc,i),Rc.set(-Ac.x,Ac.y,Ac.z),zi.transformMat4(a[1],Rc,i),Rc.set(-Ac.x,-Ac.y,Ac.z),zi.transformMat4(a[2],Rc,i),Rc.set(Ac.x,-Ac.y,Ac.z),zi.transformMat4(a[3],Rc,i),Rc.set(Pc.x,Pc.y,Pc.z),zi.transformMat4(a[4],Rc,i),Rc.set(-Pc.x,Pc.y,Pc.z),zi.transformMat4(a[5],Rc,i),Rc.set(-Pc.x,-Pc.y,Pc.z),zi.transformMat4(a[6],Rc,i),Rc.set(Pc.x,-Pc.y,Pc.z),zi.transformMat4(a[7],Rc,i),e.updatePlanes(),e}static create(){return new Ic}static clone(e){return Ic.copy(new Ic,e)}static copy(e,t){e._type=t._type;for(let i=0;i<6;++i)Qa.copy(e.planes[i],t.planes[i]);for(let i=0;i<8;++i)zi.copy(e.vertices[i],t.vertices[i]);return e}get type(){return this._type}constructor(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=ys.SHAPE_FRUSTUM,this.planes=new Array(6);for(let e=0;e<6;++e)this.planes[e]=Qa.create(0,0,0,0);this.vertices=new Array(8);for(let e=0;e<8;++e)this.vertices[e]=new zi}update(e,t){if(zi.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),zi.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),zi.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),zi.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),zi.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),zi.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===ys.SHAPE_FRUSTUM_ACCURATE){for(let e=0;e<6;e++){const t=this.planes[e],i=1/t.n.length();zi.multiplyScalar(t.n,t.n,i),t.d*=i}for(let e=0;e<8;e++)zi.transformMat4(this.vertices[e],wc[e],t)}}transform(e){if(this._type===ys.SHAPE_FRUSTUM_ACCURATE){for(let t=0;t<8;t++)zi.transformMat4(this.vertices[t],this.vertices[t],e);Qa.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Qa.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Qa.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Qa.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Qa.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Qa.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}updatePlanes(){Qa.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Qa.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Qa.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Qa.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Qa.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Qa.fromPoints(this.planes[5],this.vertices[7],this.vertices[6],this.vertices[5])}}function Mc(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function Oc(e,t,i,n,s){var o={};return Object.keys(n).forEach((function(e){o[e]=n[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}let Dc,Nc;Ic.createOrtho=(e,t,i,n,s,o)=>{const r=t/2,a=i/2;zi.set(Rc,r,a,n),zi.transformMat4(e.vertices[0],Rc,o),zi.set(Rc,-r,a,n),zi.transformMat4(e.vertices[1],Rc,o),zi.set(Rc,-r,-a,n),zi.transformMat4(e.vertices[2],Rc,o),zi.set(Rc,r,-a,n),zi.transformMat4(e.vertices[3],Rc,o),zi.set(Rc,r,a,s),zi.transformMat4(e.vertices[4],Rc,o),zi.set(Rc,-r,a,s),zi.transformMat4(e.vertices[5],Rc,o),zi.set(Rc,-r,-a,s),zi.transformMat4(e.vertices[6],Rc,o),zi.set(Rc,r,-a,s),zi.transformMat4(e.vertices[7],Rc,o),Qa.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Qa.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Qa.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Qa.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Qa.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Qa.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Dc||(Dc={})),function(e){e[e.Default=Dc.Default]="Default",e[e.Normal=Dc.Normal]="Normal",e[e.Reverse=Dc.Reverse]="Reverse",e[e.Loop=Dc.Loop]="Loop",e[e.LoopReverse=Dc.Loop|Dc.Reverse]="LoopReverse",e[e.PingPong=Dc.PingPong]="PingPong",e[e.PingPongReverse=Dc.PingPong|Dc.Reverse]="PingPongReverse"}(Nc||(Nc={})),Fe(Nc);class Lc{constructor(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}set(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}function Bc(e,t,i=1e-6){let n=0,s=e.length-1,o=s>>>1;for(;n<=s;o=n+s>>>1){const r=e[o];if(r>t+i)s=o-1;else{if(!(r<t-i))return o;n=o+1}}return~n}const zc=()=>{},Fc=()=>zc,Uc=Gc((()=>{}));function Gc(e){return function(t){return"function"==typeof t?e(t):function(i){return e(i,t)}}}function kc(e){return t=>i=>{!function(e,t,i){const n=Vc(e);if(n){const e=jc(n,"proto");jc(e,"editor")[t]=i}}(i,e,t)}}const Hc="__ccclassCache__";function Vc(e){return jc(e,Hc)}function jc(e,t){return e[t]||(e[t]={})}const Wc=Gc(((e,t)=>{let i=De.getSuper(e);i===Object&&(i=null);const n={name:t,extends:i,ctor:e},s=e[Hc];if(s){const t=s.proto;t&&De.mixin(n,t),e[Hc]=void 0}return wt(n)})),qc=kc("requireComponent"),Xc=kc("executionOrder"),Yc=Uc;function Kc(e,t,i){let n=null;function s(e,t,i){const s=Vc(e.constructor);if(s){const o=jc(s,"proto"),r=jc(o,"properties");!function(e,t,i,n,s,o){let r;const a=s&&(s.get||s.set);n&&(r=mt(n,a));const c=t[i],l=De.mixin(c||{},r||n||{});if(a)s.get&&(l.get=s.get),s.set&&(l.set=s.set);else if(s)s.initializer&&(l.default=function(e){let t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(s.initializer));else{const t=o.default||(o.default=function(e){let t;try{t=new e}catch(e){return{}}return t}(e));t.hasOwnProperty(i)&&(l.default=t[i])}t[i]=l}(e.constructor,r,t,n,i,s)}}return void 0===e?Kc({type:void 0}):void 0===t?(n=e,s):void s(e,t,i)}const $c=Symbol("cc:SerializationMetadata"),Qc=(e,t,i)=>Kc(el({}))(e,t,i);function Zc(e){return Kc(el({formerlySerializedAs:e}))}const Jc=(e,t,i)=>Kc({editorOnly:!0})(e,t,i);function el(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}const tl=zc,il=Uc,nl=Fc,sl=Uc,ol=Fc,rl=Fc,al=Fc,cl=zc,ll=Fc,hl=zc,ul=Fc,_l=Fc,pl=Fc,dl=Fc,fl=Fc,ml=Fc,gl=zc,vl=Fc,yl=Fc,xl=zc,Sl=zc,bl=zc,Tl=Al(rt),El=Al(at),Cl=Al(ct),wl=Al(lt);function Al(e){return Kc({type:e})}const Pl=(e,t,i)=>Kc({__noImplicit:!0,override:!0})(e,t,i);let Rl;var Il,Ml,Ol,Dl;let Nl,Ll,Bl,zl=Wc("cc.KeyframeCurve")((Rl=Symbol.iterator,Ol=Oc((Ml=class{constructor(){Mc(this,"_times",Ol,this),Mc(this,"_values",Dl,this)}get keyFramesCount(){return this._times.length}get rangeMin(){return this._times[0]}get rangeMax(){return this._times[this._values.length-1]}[Rl](){let e=0;return{next:()=>{if(e>=this._times.length)return{done:!0,value:void 0};{const t=[this._times[e],this._values[e]];return++e,{done:!1,value:t}}}}}keyframes(){return this}times(){return this._times}values(){return this._values}getKeyframeTime(e){return this._times[e]}getKeyframeValue(e){return this._values[e]}addKeyFrame(e,t){return this._insertNewKeyframe(e,t)}removeKeyframe(e){this._times.splice(e,1),this._values.splice(e,1)}indexOfKeyframe(e){return Bc(this._times,e)}updateTime(e,t){const i=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,i)}assignSorted(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{const t=Array.from(e);this.setKeyframes(t.map((([e])=>e)),t.map((([,e])=>e)))}}clear(){this._times.length=0,this._values.length=0}searchKeyframe(e){return Bc(this._times,e)}setKeyframes(e,t){e.length,t.length,function(e){e.every(((e,t,i)=>0===t||e>i[t-1]||pi(e,i[t-1],1e-6)))}(e),this._times=e,this._values=t}_insertNewKeyframe(e,t){const i=this._times,n=this._values,s=i.length,o=Bc(i,e);if(o>=0)return o;const r=~o;return 0===r?(i.unshift(e),n.unshift(t)):r===s?(i.push(e),n.push(t)):(i.splice(r-1,0,e),n.splice(r-1,0,t)),r}}).prototype,"_times",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dl=Oc(Ml.prototype,"_values",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Il=Ml))||Il;function Fl(e){return e>-1e-9&&e<1e-9}!function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(Nl||(Nl=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(Ll||(Ll=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(Bl||(Bl=e("TangentWeightMode",{})));const Ul=Object;var Gl=Object.freeze({__proto__:null,uniquelyReferenced:tl,ccclass:Wc,property:Kc,requireComponent:qc,executionOrder:Xc,disallowMultiple:Yc,executeInEditMode:il,menu:nl,playOnFocus:sl,inspector:ol,icon:rl,help:al,type:Al,integer:Tl,float:El,boolean:Cl,string:wl});e("_decorator",Gl);class kl{constructor(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=De.createMap(!0),this._count=0)}add(e,t){return e in this._map||this._count++,this._map[e]=t}get(e){return this._map[e]}has(e){return e in this._map}remove(e){const t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t}clear(){0!==this._count&&(this._map=De.createMap(!0),this._count=0)}forEach(e){for(const t in this._map)e(this._map[t],t)}find(e){for(const t in this._map)if(e(this._map[t],t))return this._map[t];return null}get count(){return this._count}destroy(){this._map=null}}class Hl{constructor(e,t){this.id=Hl._pipelineId++,this.name="",this.pipes=[],this.name=e;for(let e=0,i=t.length;e<i;e++)this.pipes.push(t[e])}insert(e,t){return t>this.pipes.length?(T(4921),this):(this.pipes.splice(t,0,e),this)}append(e){return this.pipes.push(e),this}remove(e){return this.pipes.splice(e,1),this}sync(e){const t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(let i=0,n=t.length;i<n;){const s=(0,t[i])(e);if(s)return e.isFinish=!0,s;i++,i!==n&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output}async(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))}_flow(e,t){(0,this.pipes[e])(t,(i=>{i?(t.isFinish=!0,t.dispatch("complete",i)):++e<this.pipes.length?(t.input=t.output,t.output=null,this._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))}}Hl._pipelineId=0;const Vl=new kl,jl=new kl,Wl=new kl,ql=new kl,Xl=new Hl("normal load",[]),Yl=new Hl("fetch",[]),Kl=new Hl("transform url",[]);let $l;!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}($l||($l={}));const Ql={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};let Zl;!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(Zl||(Zl={}));class Jl{static create(e){let t;return 0!==Jl._deadPool.length?(t=Jl._deadPool.pop(),t.set(e)):t=new Jl(e),t}constructor(e){this.id=Jl._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}set(e=Object.create(null)){this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)}dispatch(e,t,i,n,s){switch(e){case"complete":this.onComplete&&this.onComplete(t,i);break;case"progress":this.onProgress&&this.onProgress(t,i,n,s);break;case"error":this.onError&&this.onError(t,i,n,s);break;default:{const o=`on${e[0].toUpperCase()}${e.substr(1)}`;"function"==typeof this[o]&&this[o](t,i,n,s);break}}}recycle(){Jl._deadPool.length!==Jl.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,Jl._deadPool.push(this))}}Jl.MAX_DEAD_NUM=500,Jl._taskId=0,Jl._deadPool=[];const eh="0123456789abcdef".split(""),th=["","","",""],ih=th.concat(th,"-",th,"-",th,"-",th,"-",th,th,th),nh=ih.map(((e,t)=>"-"===e?NaN:t)).filter(isFinite);function sh(e){const t=e.split("@")[0];if(22!==t.length)return e;ih[0]=e[0],ih[1]=e[1];for(let t=2,i=2;t<22;t+=2){const n=Ve[e.charCodeAt(t)],s=Ve[e.charCodeAt(t+1)];ih[nh[i++]]=eh[n>>2],ih[nh[i++]]=eh[(3&n)<<2|s>>4],ih[nh[i++]]=eh[15&s]}return e.replace(t,ih.join(""))}const oh=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function rh(e){const t=oh.exec(e);return t?t[1]:""}function ah(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;const i=ql.find((t=>!!t.getAssetInfo(e)));return i&&(t.bundle=i.name),hh(e,t)}function ch(e){return!!e&&(e instanceof n.SceneAsset||e instanceof n.Scene)}function lh(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function hh(e,t){const i=Jl.create({input:e,options:t}),n=[];try{const e=Kl.sync(i);for(const t of e){const e=t.url;t.recycle(),n.push(e)}}catch(e){for(const e of i.output)e.recycle();d(e.message,e.stack)}return i.recycle(),n.length>1?n:n[0]}var uh=Object.freeze({__proto__:null,getUuidFromURL:rh,getUrlWithUuid:ah,isScene:ch,normalize:lh,transform:hh,decodeUuid:sh});class _h{constructor(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}unuse(){this.type=_h.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=_h.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}reuse(e,t){this.type=e,this.bubbles=t||!1}isStopped(){return this.propagationStopped||this.propagationImmediateStopped}getCurrentTarget(){return this.currentTarget}getType(){return this.type}}e("Event",_h),_h.NO_TYPE="no_type",_h.TOUCH="touch",_h.MOUSE="mouse",_h.KEYBOARD="keyboard",_h.ACCELERATION="acceleration",_h.NONE=0,_h.CAPTURING_PHASE=1,_h.AT_TARGET=2,_h.BUBBLING_PHASE=3,n.Event=_h;const ph=new class{constructor(){this._finalizationRegistry=null}registerGCObject(e){return e}unregisterGCObject(e){}init(){}finalizationRegistryCallback(e){e.isValid&&e.destroy()}destroy(){}};var dh;let fh=Wc("cc.GCObject")(dh=class extends Ot{constructor(...e){return super(...e),ph.registerGCObject(this)}equals(e){return!!e&&e===this}destroy(){return ph.unregisterGCObject(this),super.destroy()}})||dh;var mh,gh,vh,yh;let xh=e("Asset",Wc("cc.Asset")((yh=class extends(Ht(fh)){static deserialize(e){return n.deserialize(e)}get nativeUrl(){if(!this._nativeUrl){if(!this._native)return"";const e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=ah(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=ah(this._uuid,{__nativeName__:e,nativeExt:Cn(e),isNative:!0})}return this._nativeUrl}get _nativeAsset(){return this._file}set _nativeAsset(e){this._file=e}constructor(...e){super(...e),this.loaded=!0,Mc(this,"_native",vh,this),this._nativeUrl="",this._file=null,this._ref=0,Object.defineProperty(this,"_uuid",{value:"",writable:!0})}toString(){return this.nativeUrl}serialize(){}_setRawAsset(e,t=!0){this._native=!1!==t?e||"":`/${e}`}get _nativeDep(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}get refCount(){return this._ref}addRef(){return this._ref++,this}decRef(e=!0){return this._ref>0&&this._ref--,e&&n.assetManager._releaseManager.tryRelease(this),this}onLoaded(){}initDefault(e){e&&(this._uuid=e),this.isDefault=!0}validate(){return!0}destroy(){return m(R(12101,this._uuid)),super.destroy()}},vh=Oc((gh=yh).prototype,"_native",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Oc(gh.prototype,"_nativeAsset",[Kc],Object.getOwnPropertyDescriptor(gh.prototype,"_nativeAsset"),gh.prototype),mh=gh))||mh);var Sh,bh,Th;xh.prototype.createNode=null,n.Asset=xh;let Eh=e("Script",Wc("cc.Script")(Sh=class extends xh{})||Sh);n._Script=Eh;let Ch=e("JavaScript",Wc("cc.JavaScript")(bh=class extends Eh{})||bh);n._JavaScript=Ch;let wh=e("TypeScript",Wc("cc.TypeScript")(Th=class extends Eh{})||Th);var Ah,Ph,Rh,Ih,Mh,Oh,Dh,Nh,Lh,Bh,zh;n._TypeScript=wh;const Fh=new X("Comp"),Uh=Ot.Flags.IsOnLoadCalled;let Gh=e("Component",(Ah=Wc("cc.Component"),Ph=ul(),Rh=Al(Eh),Ih=_l(),Ah((zh=Bh=class extends Ot{constructor(...e){super(...e),Mc(this,"node",Dh,this),Mc(this,"_enabled",Nh,this),Mc(this,"__prefab",Lh,this),this._sceneGetter=null,this._id=Fh.getNewId()}get name(){if(this._name)return this._name;let e=oe(this);const t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),`${this.node.name}<${e}>`}set name(e){this._name=e}get uuid(){return this._id}get __scriptAsset(){return null}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){const t=n.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}get enabledInHierarchy(){return this._enabled&&this.node&&this.node.activeInHierarchy}get _isOnLoadCalled(){return this._objFlags&Uh}_getRenderScene(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}addComponent(e){return this.node.addComponent(e)}getComponent(e){return this.node.getComponent(e)}getComponents(e){return this.node.getComponents(e)}getComponentInChildren(e){return this.node.getComponentInChildren(e)}getComponentsInChildren(e){return this.node.getComponentsInChildren(e)}destroy(){return!!super.destroy()&&(this._enabled&&this.node.activeInHierarchy&&n.director._compScheduler.disableComp(this),!0)}_onPreDestroy(){this.unscheduleAllCallbacks(),n.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}_instantiate(e){return e||(e=n.instantiate._clone(this,this)),e&&(e.node=null),e}schedule(e,t=0,i=n.macro.REPEAT_FOREVER,s=0){A(e,1619),A((t=t||0)>=0,1620),i=Number.isNaN(i)?n.macro.REPEAT_FOREVER:i,s=s||0;const o=n.director.getScheduler(),r=o.isTargetPaused(this);o.schedule(e,this,t,i,s,r)}scheduleOnce(e,t=0){this.schedule(e,0,0,t)}unschedule(e){e&&n.director.getScheduler().unschedule(e,this)}unscheduleAllCallbacks(){n.director.getScheduler().unscheduleAllForTarget(this)}},Bh.system=null,Oc((Oh=zh).prototype,"__scriptAsset",[Ph,Rh,Ih,bl],Object.getOwnPropertyDescriptor(Oh.prototype,"__scriptAsset"),Oh.prototype),Dh=Oc(Oh.prototype,"node",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nh=Oc(Oh.prototype,"_enabled",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Lh=Oc(Oh.prototype,"__prefab",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mh=Oh))||Mh));const kh=Gh.prototype;var Hh,Vh,jh;kh.update=null,kh.lateUpdate=null,kh.__preload=null,kh.onLoad=null,kh.start=null,kh.onEnable=null,kh.onDisable=null,kh.onDestroy=null,kh.onFocusInEditor=null,kh.onLostFocusInEditor=null,kh.resetInEditor=null,kh._getLocalBounds=null,kh.onRestore=null,Gh._requireComponent=null,Gh._executionOrder=0,ee(Gh,"_registerEditorProps",((e,t)=>{const i=t.requireComponent;i&&(e._requireComponent=i);const n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)})),n.Component=Gh;let Wh=e("MissingScript",Wc("cc.MissingScript")(Hh=ol()((jh=Oc((Vh=class extends Gh{static safeFindClass(e){const t=Pe(e);if(t)return t;n.deserialize.reportMissingClass(e)}constructor(){super(),Mc(this,"_$erialized",jh,this)}onLoad(){T(4600,this.node.name)}}).prototype,"_$erialized",[Qc,Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hh=Vh))||Hh)||Hh);n._MissingScript=Wh;const qh=e("serializeTag",Symbol("[[Serialize]]")),Xh=e("deserializeTag",Symbol("[[Deserialize]]"));class Yh{constructor(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}get document(){return this._document}get chunks(){return this._chunks}}function Kh(e){const t=e;return{chunks:t.chunks,document:t.document}}function $h(e){if(e.length<16)throw new Qh(R(13102));const t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new Qh(R(13100));const i=t.getUint32(4,!0);if(1!==i)throw new Qh(R(13101,i));if(t.getUint32(8,!0)!==t.byteLength)throw new Qh(R(13102));let n=12;const s=t.getUint32(n,!0);n+=4;const o=new Uint8Array(t.buffer,n+t.byteOffset,s);n+=s;const r=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis){const{Buffer:t}=globalThis;return t.from(e.buffer,e.byteOffset,e.byteLength).toString()}throw new Error(R(13104))}(o);let a;try{a=JSON.parse(r)}catch(e){throw new Qh(e)}const c=[];for(;n<t.byteLength;){n%8!=0&&(n+=8-n%8);const e=t.getUint32(n,!0);n+=4,c.push(new Uint8Array(t.buffer,n+t.byteOffset,e)),n+=e}if(n!==t.byteLength)throw new Qh(R(13102));return new Yh(a,c)}class Qh extends Error{}function Zh(e,t,i,s,o){if(t instanceof n.ValueType){o||e.push("if(prop){");const n=oe(t);e.push(`s._deserializeFastDefinedObject(o${i},prop,${n});`),o||e.push(`}else o${i}=null;`)}else e.push(`\nif (prop) {\n    s._deserializeAndAssignField(o, prop, ${s});\n} else {\n    o${i}=null;\n}\n`)}n.internal.parseCCONJson=Kh,n.internal.decodeCCONBinary=$h,n.internal.CCON=Yh;const Jh="$_$type",eu="$_$default",tu="$_$formerlySerializedAs";class iu{constructor(e,t,i,n,s){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=i,this._onDereferenced=null==t?void 0:t.onDereferenced}reset(e,t,i,n,s){this.result=e,this.customEnv=n,this._classFinder=t,this._reportMissingClass=i,this._onDereferenced=null==t?void 0:t.onDereferenced}clear(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null}deserialize(e){let t,i=!1;e instanceof Yh?(i=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:i};const n=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(n,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData}_deserializeObject(e,t,i,n){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,i,n):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}}_deserializeTypedArrayView(e){return globalThis[e.ctor].from(e.array)}_deserializeTypedArrayViewRef(e){const{offset:t,length:i,ctor:n}=e;return new globalThis[n](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,i)}_deserializeArray(e){const t=new Array(e.length);let i;for(let n=0;n<e.length;n++)i=e[n],"object"==typeof i&&i?this._deserializeAndAssignField(t,i,`${n}`)&&(t[n]=null):t[n]=i;return t}_deserializePlainObject(e){const t={};return this._fillPlainObject(t,e),t}_deserializeTypeTaggedObject(e,t,i,n){const s=e.__type__,o=this._classFinder(s,e,i,n);if(!o)return this._classFinder===Pe&&this._reportMissingClass(s),null;{const i=(e=>{const i=new e;return t>=0&&(this.deserializedList[t]=i),i})(o);return this._deserializeInto(e,i,o),i}}_deserializeInto(e,t,i,s=!1){s||!t[Xh]?t._deserialize?t._deserialize(e.content,this):n.Class._isCCClass(i)?this._deserializeFireClass(t,e,i):this._deserializeFastDefinedObject(t,e,i):this._runCustomizedDeserialize(e,t,i)}_runCustomizedDeserialize(e,t,i){const n={readProperty:t=>{const i=e[t];return"object"==typeof i&&i?this._deserializeObjectField(i):i},readThis:()=>{this._deserializeInto(e,t,i,!0)},readSuper:()=>{const n=ge(i);n&&this._deserializeInto(e,t,n)}};t[Xh](n,this._context)}_deserializeFireClass(e,t,i){let s;i.hasOwnProperty("__deserialize__")?s=i.__deserialize__:(s=function(e,t){const i=nt(t),s=t.__values__,o=["var prop;"],r=ke.test(Ie(t));for(let e=0;e<s.length;e++){const t=s[e];let n,a;wt.IDENTIFIER_RE.test(t)?(a=`"${t}"`,n=`.${t}`):(a=wt.escapeForJS(t),n=`[${a}]`);let c=n;if(i[t+tu]){const e=i[t+tu];c=wt.IDENTIFIER_RE.test(e)?`.${e}`:`[${wt.escapeForJS(e)}]`}o.push(`prop=d${c};`),o.push('if(typeof (prop)!=="undefined"){');const l=wt.getDefault(i[t+eu]);if(r){let e;const s=i[t+Jh];if(void 0===l&&s)e=s instanceof ot;else{const t=typeof l;e="string"===t||"number"===t||"boolean"===t}e?o.push(`o${n}=prop;`):Zh(o,l,n,a,!0)}else o.push(`if(typeof (prop)!=="object"){o${n}=prop;}else{`),Zh(o,l,n,a,!1),o.push("}");o.push("}")}return(n.js.isChildClassOf(t,n._BaseNode)||n.js.isChildClassOf(t,n.Component))&&o.push("d._id&&(o._id=d._id);"),"_$erialized"===s[s.length-1]&&(o.push("o._$erialized=JSON.parse(JSON.stringify(d));"),o.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",o.join(""))}(0,i),ee(i,"__deserialize__",s,!0)),s(this,e,t,i)}_deserializeAndAssignField(e,t,i){const n=t.__id__;if("number"==typeof n){const t=this.deserializedList[n];if(t)e[i]=t;else{var s;const t=this._serializedData[n];e[i]=this._deserializeObject(t,n,void 0,i),null===(s=this._onDereferenced)||void 0===s||s.call(this,this.deserializedList,n,e,i)}}else{const n=t.__uuid__;if(n){const s=t.__expectedType__;this.result.push(e,i,n,s)}else e[i]=this._deserializeObject(t,-1)}return!1}_deserializeObjectField(e){const t=e.__id__;if("number"==typeof t){const e=this.deserializedList[t];if(e)return e;{const e=this._serializedData[t];return this._deserializeObject(e,t,void 0,void 0)}}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)}_fillPlainObject(e,t){for(const i in t){if(!t.hasOwnProperty(i))continue;const n=t[i];"object"!=typeof n?"__type__"!==i&&(e[i]=n):n?this._deserializeAndAssignField(e,n,i)&&(e[i]=null):e[i]=null}}_deserializeFastDefinedObject(e,t,i){if(i===n.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===n.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i===n.Color){e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;const i=t.a;return void(e.a=void 0===i?255:i)}if(i===n.Size)return e.width=t.width||0,void(e.height=t.height||0);const s=nt(i),o=i.__values__;for(let i=0;i<o.length;i++){const n=o[i];let r=t[n];void 0!==r||t.hasOwnProperty(n)||(r=wt.getDefault(s[n+eu])),"object"!=typeof r?e[n]=r:r?this._deserializeAndAssignField(e,r,n):e[n]=null}}}iu.pool=new class extends Me{constructor(){super((e=>{e.clear()}),1)}get(e,t,i,n,s){const o=this._get();return o?(o.reset(e,t,i,n,s),o):new iu(e,t,i,n,s)}};const nu=[nn,zi,an,ji,Di,hn,_n,Zi];function su(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}const ou=[(e,t)=>{e.x=t[1],e.y=t[2]},(e,t)=>{e.x=t[1],e.y=t[2],e.z=t[3]},su,su,(e,t)=>{e._val=t[1]},(e,t)=>{e.width=t[1],e.height=t[2]},(e,t)=>{e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},(e,t)=>{Zi.fromArray(e,t,1)}];class ru{constructor(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}init(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])}reset(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)}push(e,t,i,n){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(i),this.uuidTypeList.push(n||"")}}function au(e,t){const i=e[4][t[0]],n=i[0],s=new(0,n[0]),o=n[1],r=n[2],a=i[i.length-1];let c=1;for(;c<a;++c)s[o[i[c]]]=t[c];for(;c<t.length;++c){const a=o[i[c]],l=n[i[c]+r];(0,pu[l])(e,s,a,t[c])}return s}function cu(e,t,i){const n=new t;return n._deserialize?n._deserialize(i,e[0]):C(5303,oe(t)),n}function lu(e,t,i,n){n>=0?t[i]=e[5][n]:e[7][3*~n]=t}function hu(e){return(t,i,n,s)=>{i[n]=s;for(let i=0;i<s.length;++i)e(t,s,i,s[i])}}function uu(e,t,i,n){t[i]=null,e[8][n]=t}function _u(e,t,i,n){t[i]=au(e,n)}e("Details",ru),ru.pool=new Me((e=>{e.reset()}),5),ru.pool.get=function(){return this._get()||new ru};const pu=new Array(13);function du(e,t,i){return e||i(t),Object}function fu(e,t,i,n,s,o,r){let a=e(t);if(!a){if(s)return void(i[n]=(c=i,l=n,h=t,function(){const t=e(h)||du(o,h,r);return c[l]=t,new t}));a=du(o,t,r)}var c,l,h;i[n]=a}function mu(e,t,i,n){const s=i||Pe,o=e[3];for(let e=0;e<o.length;++e){const r=o[e];"string"!=typeof r?fu(s,r[0],r,0,t,i,n):fu(s,r,o,e,t,i,n)}}function gu(e){const t=e[4];if(t){const i=e[3];for(let e=0;e<t.length;++e){const n=t[e];n[0]=i[n[0]]}}}function vu(e,t,i){"string"==typeof e&&(e=JSON.parse(e));const s=!t;let o;if(t=t||ru.pool.get(),function(e){if(Array.isArray(e)){const t=e[0];return"number"==typeof t||t instanceof yu}return!1}(e)){t.init(e),i=i||{};let s=e[0],a=!1;if("object"==typeof s&&(a=s.preprocessed,s=s.version),s<1)throw new Error(R(5304,s));var r;i._version=s,i.result=t,e[0]=i,a||(mu(e,!1,i.classFinder,null!==(r=i.reportMissingClass)&&void 0!==r?r:vu.reportMissingClass),gu(e)),n.game._isCloning=!0;const c=e[5],l=function(e){const t=e[5],i=e[6],n=0===i?0:i.length;let s=t[t.length-1],o=t.length-n;"number"!=typeof s?s=0:(s<0&&(s=~s),--o);let r=0;for(;r<o;++r)t[r]=au(e,t[r]);const a=e[3];for(let s=0;s<n;++s,++r){let n=i[s];const o=t[r];if(n>=0){const i=a[n];t[r]=cu(e,i,o)}else n=~n,(0,pu[n])(e,t,r,o)}return s}(e);n.game._isCloning=!1,e[7]&&function(e,t,i){const n=e.length-1;let s=0;const o=3*e[n];for(;s<o;s+=3){const n=e[s],o=t[e[s+2]],r=e[s+1];r>=0?n[i[r]]=o:n[~r]=o}for(;s<n;s+=3){const n=t[e[s]],o=t[e[s+2]],r=e[s+1];r>=0?n[i[r]]=o:n[~r]=o}}(e[7],c,e[2]),function(e){const t=e[5],i=e[2],n=e[1],s=e[8],o=e[9],r=e[10];for(let e=0;e<s.length;++e){const a=s[e];"number"==typeof a&&(s[e]=t[a]);let c=o[e];"number"==typeof c&&(c=c>=0?i[c]:~c,o[e]=c);const l=r[e];"number"==typeof l&&(r[e]=n[l])}}(e),o=c[l]}else o=function(e,t,i){var s;const o=(i=i||{}).classFinder||Pe,r=i.createAssetRefs||xn.platform===z.EDITOR_CORE,a=i.customEnv,c=i.ignoreEditorOnly,l=null!==(s=i.reportMissingClass)&&void 0!==s?s:n.deserialize.reportMissingClass;t.init();const h=iu.pool.get(t,o,l,a,c);n.game._isCloning=!0;const u=h.deserialize(e);return n.game._isCloning=!1,iu.pool.put(h),r&&t.assignAssetsBy(EditorExtends.serialize.asAsset),u}(e,t,i);return s&&ru.pool.put(t),o}pu[0]=function(e,t,i,n){t[i]=n},pu[1]=lu,pu[2]=hu(lu),pu[3]=hu(uu),pu[4]=_u,pu[5]=function(e,t,i,n){ou[n[0]](t[i],n)},pu[6]=uu,pu[7]=function(e,t,i,n){t[i].set(n)},pu[8]=function(e,t,i,n){const s=new nu[n[0]];ou[n[0]](s,n),t[i]=s},pu[9]=hu(_u),pu[10]=function(e,t,i,n){const s=e[3][n[0]];t[i]=cu(e,s,n[1])},pu[11]=function(e,t,i,n){const s=n[0];t[i]=s;for(let t=1;t<n.length;t+=3){const i=n[t],o=n[t+1],r=n[t+2];(0,pu[o])(e,s,i,r)}},pu[12]=function(e,t,i,n){const s=n[0];t[i]=s;for(let t=0;t<s.length;++t){const i=s[t],o=n[t+1];0!==o&&(0,pu[o])(e,s,t,i)}},vu.Details=ru,vu.reportMissingClass=function(e){T(5302,e)};class yu{constructor(e){this.preprocessed=!0,this.version=e}}function xu(e,t,i){return[1,0,0,[e],0,i?[t,-1]:[t],[0],0,[],[],[]]}n.deserialize=vu;const Su=Ot.Flags.Destroyed,bu=Ot.Flags.PersistentMask,Tu=[];function Eu(e){let t;if(e instanceof Ot){if(e._instantiate)return n.game._isCloning=!0,t=e._instantiate(null,!0),n.game._isCloning=!1,t;if(e instanceof n.Asset)throw new TypeError(R(6903))}return n.game._isCloning=!0,t=Cu(e),n.game._isCloning=!1,t}function Cu(e,t){let i;i=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),wu(e,i,t);for(let e=0,t=Tu.length;e<t;++e)Tu[e]._iN$t=null;return Tu.length=0,i}function wu(e,t,i){De.value(e,"_iN$t",t,!0),Tu.push(e);const s=e.constructor;if(n.Class._isCCClass(s))!function(e,t,i,n){const s=e.__values__;for(let e=0;e<s.length;e++){const o=s[e],r=t[o];if("object"==typeof r&&r){const e=i[o];e instanceof Ue&&e.constructor===r.constructor?e.set(r):i[o]=r._iN$t||Au(r,n)}else i[o]=r}}(s,e,t,i);else for(const n in e){if(!e.hasOwnProperty(n)||95===n.charCodeAt(0)&&95===n.charCodeAt(1)&&"__type__"!==n)continue;const s=e[n];if("object"==typeof s&&s){if(s===t)continue;t[n]=s._iN$t||Au(s,i)}else t[n]=s}e instanceof Ot&&(t._objFlags&=bu)}function Au(e,t){if(e instanceof Ue)return e.clone();if(e instanceof n.Asset)return e;let i;if(ArrayBuffer.isView(e)){const t=e.length;i=new e.constructor(t),e._iN$t=i,Tu.push(e);for(let n=0;n<t;++n)i[n]=e[n];return i}if(Array.isArray(e)){const n=e.length;i=new Array(n),e._iN$t=i,Tu.push(e);for(let s=0;s<n;++s){const n=e[s];i[s]="object"==typeof n&&n?n._iN$t||Au(n,t):n}return i}if(e._objFlags&Su)return null;const s=e.constructor;if(n.Class._isCCClass(s)){if(t)if(t instanceof n.Component){if(e instanceof n._BaseNode||e instanceof n.Component)return e}else if(t instanceof n._BaseNode)if(e instanceof n._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof n.Component&&e.node&&!e.node.isChildOf(t))return e;i=new s}else if(s===Object)i={};else{if(s)return e;i=Object.create(null)}return wu(e,i,t),i}var Pu,Ru,Iu,Mu,Ou,Du,Nu,Lu;let Bu,zu;function Fu(e,t){return(t<<3)+e}function Uu(e){return ku[e]}function Gu(e){switch(e){case Bu.Uint8:return Uint8Array;case Bu.Uint16:return Uint16Array;case Bu.Uint32:return Uint32Array;case Bu.Int8:return Int8Array;case Bu.Int16:return Int16Array;case Bu.Int32:return Int32Array;case Bu.Float32:return Float32Array;case Bu.Float64:return Float64Array}}Eu._clone=Cu,n.instantiate=Eu,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Bu||(Bu={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(zu||(zu={})),e("CompactValueTypeArray",Wc("cc.CompactValueTypeArray")((Lu=Nu=class e{constructor(){Mc(this,"_byteOffset",Iu,this),Mc(this,"_unitCount",Mu,this),Mc(this,"_unitElement",Ou,this),Mc(this,"_length",Du,this)}static lengthFor(e,t,i){return Uu(t).requiredUnits*e.length*Gu(i).BYTES_PER_ELEMENT}static compress(t,i,n,s,o,r){const a=Uu(i),c=Gu(n),l=a.requiredUnits*t.length,h=new c(s,o,l);for(let e=0;e<t.length;++e)a.compress(h,e,t[e]);const u=new e;return u._unitElement=Fu(n,i),u._byteOffset=r,u._unitCount=l,u._length=t.length,u}decompress(e){const{storageUnit:t,elementType:i}={storageUnit:7&(n=this._unitElement),elementType:n>>3};var n;const s=Uu(i),o=new(Gu(t))(e,this._byteOffset,this._unitCount),r=new Array(this._length);for(let e=0;e<this._length;++e)r[e]=s.decompress(o,e);return r}},Nu.StorageUnit=Bu,Nu.ElementType=zu,Iu=Oc((Ru=Lu).prototype,"_byteOffset",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mu=Oc(Ru.prototype,"_unitCount",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ou=Oc(Ru.prototype,"_unitElement",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fu(Bu.Uint8,zu.Scalar)}}),Du=Oc(Ru.prototype,"_length",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pu=Ru))||Pu);const ku={[zu.Scalar]:{requiredUnits:1,compress(e,t,i){e[t]=i},decompress:(e,t)=>e[t]},[zu.Vec2]:{requiredUnits:2,compress(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:(e,t)=>new zi(e[2*t],e[2*t+1])},[zu.Vec3]:{requiredUnits:3,compress(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:(e,t)=>new zi(e[3*t],e[3*t+1],e[3*t+2])},[zu.Vec4]:{requiredUnits:4,compress(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:(e,t)=>new an(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])},[zu.Quat]:{requiredUnits:4,compress(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:(e,t)=>new ji(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])},[zu.Mat4]:{requiredUnits:16,compress(e,t,i){Zi.toArray(e,i,16*t)},decompress:(e,t)=>Zi.fromArray(new Zi,e,16*t)}};function Hu(){return 0}function Vu(e){return e}function ju(e){return e*e}function Wu(e){return e*(2-e)}function qu(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function Xu(e){return e*e*e}function Yu(e){return--e*e*e+1}function Ku(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function $u(e){return e*e*e*e}function Qu(e){return 1- --e*e*e*e}function Zu(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function Ju(e){return e*e*e*e*e}function e_(e){return--e*e*e*e*e+1}function t_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function i_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function n_(e){return Math.sin(e*Math.PI/2)}function s_(e){return.5*(1-Math.cos(Math.PI*e))}function o_(e){return 0===e?0:Math.pow(1024,e-1)}function r_(e){return 1===e?1:1-Math.pow(2,-10*e)}function a_(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function c_(e){return 1-Math.sqrt(1-e*e)}function l_(e){return Math.sqrt(1- --e*e)}function h_(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function u_(e){let t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function __(e){let t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function p_(e){let t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function d_(e){if(1===e)return 1;const t=1.70158;return e*e*((t+1)*e-t)}function f_(e){if(0===e)return 0;const t=1.70158;return--e*e*((t+1)*e+t)+1}function m_(e){const t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function g_(e){return 1-v_(1-e)}function v_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function y_(e){return e<.5?.5*g_(2*e):.5*v_(2*e-1)+.5}function x_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function S_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}n._decorator=Gl;const b_=O_(ju,Wu),T_=O_(Xu,Yu),E_=O_($u,Qu),C_=O_(Ju,e_),w_=O_(i_,n_),A_=O_(o_,r_),P_=O_(c_,l_),R_=O_(u_,__),I_=O_(d_,f_),M_=O_(g_,v_);function O_(e,t){return i=>i<.5?t(2*i)/2:e(2*i-1)/2+.5}var D_=Object.freeze({__proto__:null,constant:Hu,linear:Vu,quadIn:ju,quadOut:Wu,quadInOut:qu,cubicIn:Xu,cubicOut:Yu,cubicInOut:Ku,quartIn:$u,quartOut:Qu,quartInOut:Zu,quintIn:Ju,quintOut:e_,quintInOut:t_,sineIn:i_,sineOut:n_,sineInOut:s_,expoIn:o_,expoOut:r_,expoInOut:a_,circIn:c_,circOut:l_,circInOut:h_,elasticIn:u_,elasticOut:__,elasticInOut:p_,backIn:d_,backOut:f_,backInOut:m_,bounceIn:g_,bounceOut:v_,bounceInOut:y_,smooth:x_,fade:S_,quadOutIn:b_,cubicOutIn:T_,quartOutIn:E_,quintOutIn:C_,sineOutIn:w_,expoOutIn:A_,circOutIn:P_,elasticOutIn:R_,backOutIn:I_,bounceOutIn:M_});let N_;e("easing",D_),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(N_||(N_={}));const L_={[N_.CONSTANT]:Hu,[N_.LINEAR]:Vu,[N_.QUAD_IN]:ju,[N_.QUAD_OUT]:Wu,[N_.QUAD_IN_OUT]:qu,[N_.QUAD_OUT_IN]:b_,[N_.CUBIC_IN]:Xu,[N_.CUBIC_OUT]:Yu,[N_.CUBIC_IN_OUT]:Ku,[N_.CUBIC_OUT_IN]:T_,[N_.QUART_IN]:$u,[N_.QUART_OUT]:Qu,[N_.QUART_IN_OUT]:Zu,[N_.QUART_OUT_IN]:E_,[N_.QUINT_IN]:Ju,[N_.QUINT_OUT]:e_,[N_.QUINT_IN_OUT]:t_,[N_.QUINT_OUT_IN]:C_,[N_.SINE_IN]:i_,[N_.SINE_OUT]:n_,[N_.SINE_IN_OUT]:s_,[N_.SINE_OUT_IN]:w_,[N_.EXPO_IN]:o_,[N_.EXPO_OUT]:r_,[N_.EXPO_IN_OUT]:a_,[N_.EXPO_OUT_IN]:A_,[N_.CIRC_IN]:c_,[N_.CIRC_OUT]:l_,[N_.CIRC_IN_OUT]:h_,[N_.CIRC_OUT_IN]:P_,[N_.ELASTIC_IN]:u_,[N_.ELASTIC_OUT]:__,[N_.ELASTIC_IN_OUT]:p_,[N_.ELASTIC_OUT_IN]:R_,[N_.BACK_IN]:d_,[N_.BACK_OUT]:f_,[N_.BACK_IN_OUT]:m_,[N_.BACK_OUT_IN]:I_,[N_.BOUNCE_IN]:g_,[N_.BOUNCE_OUT]:v_,[N_.BOUNCE_IN_OUT]:y_,[N_.BOUNCE_OUT_IN]:M_,[N_.SMOOTH]:x_,[N_.FADE]:S_};function B_(e){return L_[e]}var z_,F_,U_,G_,k_,H_,V_;class j_ extends Ul{constructor(...e){super(...e),this.interpolationMode=Nl.LINEAR,this.tangentWeightMode=Bl.NONE,this.value=0,this.rightTangent=0,this.rightTangentWeight=0,this.leftTangent=0,this.leftTangentWeight=0,this.easingMethod=N_.LINEAR}}function W_(e){const t=new j_;if("number"==typeof e)t.value=e;else{const{interpolationMode:i,tangentWeightMode:n,value:s,rightTangent:o,rightTangentWeight:r,leftTangent:a,leftTangentWeight:c,easingMethod:l,[Rt]:h}=e;t.value=null!=s?s:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=r?r:t.rightTangentWeight,t.leftTangent=null!=a?a:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=i?i:t.interpolationMode,t.tangentWeightMode=null!=n?n:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,h&&(t[Rt]=h)}return t}wt.fastDefine("cc.RealKeyframeValue",j_,{interpolationMode:Nl.LINEAR,tangentWeightMode:Bl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:N_.LINEAR}),wt.Attr.setClassAttr(j_,Rt,"editorOnly",!0),(k_=j_,null!==(V_=(H_=k_)[$c])&&void 0!==V_?V_:H_[$c]={}).uniquelyReferenced=!0;let q_=e("RealCurve",Wc("cc.RealCurve")((U_=Oc((F_=class extends zl{constructor(...e){super(...e),Mc(this,"preExtrapolation",U_,this),Mc(this,"postExtrapolation",G_,this)}evaluate(e){const{_times:t,_values:i}=this,n=t.length;if(0===n)return 0;const s=t[0],o=t[n-1];if(e<s){const{preExtrapolation:r}=this,a=i[0];if(r===Ll.CLAMP||n<2)return a.value;switch(r){case Ll.LINEAR:return cp(s,i[0].value,t[1],i[1].value,e);case Ll.LOOP:e=rp(e,s,o);break;case Ll.PING_PONG:e=ap(e,s,o);break;default:return a.value}}else if(e>o){const{postExtrapolation:r}=this,a=i[n-1];if(r===Ll.CLAMP||n<2)return a.value;switch(r){case Ll.LINEAR:return cp(o,a.value,t[n-2],i[n-2].value,e);case Ll.LOOP:e=rp(e,s,o);break;case Ll.PING_PONG:e=ap(e,s,o);break;default:return a.value}}const r=Bc(t,e);if(r>=0)return i[r].value;const a=~r,c=a-1,l=t[c],h=i[c],u=t[a];return function(e,t,i,n,s){const o=i-e;switch(t.interpolationMode){default:case Nl.CONSTANT:return t.value;case Nl.LINEAR:{const e=t.easingMethod===N_.LINEAR?s:B_(t.easingMethod)(s);return mi(t.value,n.value,e)}case Nl.CUBIC:{const r=1/3,{rightTangent:a,rightTangentWeight:c}=t,l=0!=(t.tangentWeightMode&Bl.RIGHT),{leftTangent:h,leftTangentWeight:u}=n,_=0!=(n.tangentWeightMode&Bl.LEFT);if(l||_){let p=0;if(l)p=c;else{const e=o,t=o*a;p=Math.sqrt(e*e+t*t)*r}const d=Math.atan(a),f=Math.cos(d)*p+e,m=Math.sin(d)*p+t.value;let g=0;if(_)g=u;else{const e=o,t=o*h;g=Math.sqrt(e*e+t*t)*r}const v=Math.atan(h),y=(f-e)/o,x=(-Math.cos(v)*g+i-e)/o,S=m,b=-Math.sin(v)*g+n.value,T=[0,0,0],E=function(e,t,i,n,s){const o=i/n,r=t/n,a=o*o,c=1/3*(-1/3*a+r),l=.5*(2/27*o*a-1/3*o*r+e/n),h=c*c*c,u=l*l+h;let _=0;if(Fl(u)){if(Fl(l))return s[0]=0,1;{const e=Math.cbrt(-l);return s[0]=2*e,s[1]=-e,2}}if(u<0){const e=1/3*Math.acos(-l/Math.sqrt(-h)),t=2*Math.sqrt(-c);s[0]=t*Math.cos(e),s[1]=-t*Math.cos(e+Math.PI/3),s[2]=-t*Math.cos(e-Math.PI/3),_=3}else{const e=Math.sqrt(u),t=Math.cbrt(e-l),i=-Math.cbrt(e+l);s[0]=t+i,_=1}const p=1/3*o;for(let e=0;e<_;++e)s[e]-=p;return _}(0-s,3*y,3*x-6*y,3*(y-x)+1,T),C=function(e,t,i){let n=i;if(1===t)n=e[0];else{n=-1/0;for(let i=0;i<t;++i){const t=e[i];t>=0&&t<=1&&t>n&&(n=t)}n===-1/0&&(n=0)}return n}(T,E,s);return lp(t.value,S,b,n.value,C)}{const e=t.value+r*a*o,i=n.value-r*h*o;return lp(t.value,e,i,n.value,s)}}}}(l,h,u,i[a],(e-l)/(u-l))}addKeyFrame(e,t){return super.addKeyFrame(e,W_(t))}assignSorted(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((e=>W_(e))));else{const t=Array.from(e);this.setKeyframes(t.map((([e])=>e)),t.map((([,e])=>W_(e))))}}isConstant(e){if(this._values.length<=1)return!0;const t=this._values[0].value;return this._values.every((i=>pi(i.value,t,e)))}[qh](e,t){if(!t.toCCON)return void e.writeThis();const{_times:i,_values:n}=this,s=i.length,o=new DataView(new ArrayBuffer(0+Y_+Y_+K_+$_*s+np*s));let r=0;o.setUint8(r,this.preExtrapolation),r+=Y_,o.setUint8(r,this.postExtrapolation),r+=Y_,o.setUint32(r,s,!0),r+=K_,i.forEach(((e,t)=>o.setFloat32(r+$_*t,e,!0))),r+=$_*s;for(const e of n)r=sp(o,e,r);const a=new Uint8Array(o.buffer,0,r);e.writeProperty("bytes",a);const c=n.map((e=>e[Rt]));c.some((e=>void 0!==e))&&e.writeProperty("keyframeValueEditorExtras",c)}[Xh](e,t){if(!t.fromCCON)return void e.readThis();const i=e.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength);let s=0;this.preExtrapolation=n.getUint8(s),s+=Y_,this.postExtrapolation=n.getUint8(s),s+=Y_;const o=n.getUint32(s,!0);s+=K_;const r=Array.from({length:o},((e,t)=>n.getFloat32(s+$_*t,!0)));s+=$_*o;const a=new Array(o);for(let e=0;e<o;++e){const t=W_({});s=op(n,t,s),a[e]=t}i.byteLength;const c=e.readProperty("keyframeValueEditorExtras");c&&(c.length,c.forEach(((e,t)=>a[t][Rt]=e))),this._times=r,this._values=a}}).prototype,"preExtrapolation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ll.CLAMP}}),G_=Oc(F_.prototype,"postExtrapolation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ll.CLAMP}}),z_=F_))||z_);var X_;!function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(X_||(X_={}));const Y_=1,K_=4,$_=4,{interpolationMode:Q_,tangentWeightMode:Z_,leftTangent:J_,leftTangentWeight:ep,rightTangent:tp,rightTangentWeight:ip}=W_({}),np=26;function sp(e,t,i){let n=0,s=i;const o=s;s+=4;const{value:r,interpolationMode:a,tangentWeightMode:c,rightTangent:l,rightTangentWeight:h,leftTangent:u,leftTangentWeight:_,easingMethod:p}=t;return e.setFloat32(s,r,!0),s+=4,a!==Q_&&(n|=X_.INTERPOLATION_MODE,e.setUint8(s,a),s+=1),c!==Z_&&(n|=X_.TANGENT_WEIGHT_MODE,e.setUint8(s,c),s+=1),u!==J_&&(n|=X_.LEFT_TANGENT,e.setFloat32(s,u,!0),s+=4),_!==ep&&(n|=X_.LEFT_TANGENT_WEIGHT,e.setFloat32(s,_,!0),s+=4),l!==tp&&(n|=X_.RIGHT_TANGENT,e.setFloat32(s,l,!0),s+=4),h!==ip&&(n|=X_.RIGHT_TANGENT_WEIGHT,e.setFloat32(s,h,!0),s+=4),n|=p<<8,e.setUint32(o,n,!0),s}function op(e,t,i){let n=i;const s=e.getUint32(n,!0);n+=4,t.value=e.getFloat32(n,!0),n+=4,s&X_.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(n),n+=1),s&X_.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(n),n+=1),s&X_.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(n,!0),n+=4),s&X_.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(n,!0),n+=4),s&X_.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(n,!0),n+=4),s&X_.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(n,!0),n+=4);const o=(65280&s)>>8;return t.easingMethod=o,n}function rp(e,t,i){return t+wi(e-t,i-t)}function ap(e,t,i){return t+Ai(e-t,i-t)}function cp(e,t,i,n,s){return t+(n-t)/(i-e)*(s-e)}function lp(e,t,i,n,s){const o=1-s;return o*o*o*e+3*o*o*s*t+3*o*s*s*i+s*s*s*n}function hp(e,t,i,n,s){const o=1-s;return o*(o*(e+(3*t-e)*s)+3*i*s*s)+n*s*s*s}n.bezier=hp;const up=Math.cos,_p=Math.acos,pp=Math.max,dp=2*Math.PI,fp=Math.sqrt;function mp(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function gp(e,t){const i=function(e,t){const i=t-0,n=t-e[0],s=3*i,o=3*n,r=3*(t-e[2]),a=1/(-i+o-r+(t-1)),c=1/3,l=(s-6*n+r)*a,h=l*c,u=(-s+o)*a,_=(3*u-l*l)*c,p=_*c,d=(2*l*l*l-9*l*u+i*a*27)/27,f=d/2,m=f*f+p*p*p;let g,v,y,x,S;if(m<0){const e=-_*c,t=fp(e*e*e),i=-d/(2*t),n=_p(i<-1?-1:i>1?1:i),s=2*mp(t);return y=s*up(n*c)-h,x=s*up((n+dp)*c)-h,S=s*up((n+2*dp)*c)-h,y>=0&&y<=1?x>=0&&x<=1?S>=0&&S<=1?pp(y,x,S):pp(y,x):S>=0&&S<=1?pp(y,S):y:x>=0&&x<=1?S>=0&&S<=1?pp(x,S):x:S}if(0===m)return g=f<0?mp(-f):-mp(f),y=2*g-h,x=-g-h,y>=0&&y<=1?x>=0&&x<=1?pp(y,x):y:x;{const e=fp(m);return g=mp(-f+e),v=mp(f+e),y=g-v-h,y}}(e,t),n=e[1];return((1-i)*(n+(e[3]-n)*i)*3+i*i)*i}var vp,yp,xp,Sp,bp,Tp,Ep,Cp,wp;let Ap;n.bezierByTime=gp,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(Ap||(Ap=e("QuatInterpolationMode",{})));let Pp=Wc("cc.QuatKeyframeValue")(vp=tl((xp=Oc((yp=class{constructor({value:e,interpolationMode:t,easingMethod:i}={}){Mc(this,"interpolationMode",xp,this),Mc(this,"value",Sp,this),Mc(this,"easingMethod",bp,this),this.value=e?ji.clone(e):this.value,this.interpolationMode=null!=t?t:this.interpolationMode,this.easingMethod=null!=i?i:this.easingMethod}}).prototype,"interpolationMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ap.SLERP}}),Sp=Oc(yp.prototype,"value",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ji.clone(ji.IDENTITY)}}),bp=Oc(yp.prototype,"easingMethod",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N_.LINEAR}}),vp=yp))||vp)||vp;function Rp(e){return new Pp(e)}let Ip=e("QuatCurve",Wc("cc.QuatCurve")((Cp=Oc((Ep=class extends zl{constructor(...e){super(...e),Mc(this,"preExtrapolation",Cp,this),Mc(this,"postExtrapolation",wp,this)}evaluate(e,t){var i;null!==(i=t)&&void 0!==i||(t=new ji);const{_times:n,_values:s,postExtrapolation:o,preExtrapolation:r}=this,a=n.length;if(0===a)return t;const c=n[0],l=n[a-1];if(e<c){const i=s[0];switch(r){case Ll.LOOP:e=c+wi(e-c,l-c);break;case Ll.PING_PONG:e=c+Ai(e-c,l-c);break;case Ll.CLAMP:default:return ji.copy(t,i.value)}}else if(e>l){const i=s[a-1];switch(o){case Ll.LOOP:e=c+wi(e-c,l-c);break;case Ll.PING_PONG:e=c+Ai(e-c,l-c);break;case Ll.CLAMP:default:return ji.copy(t,i.value)}}const h=Bc(n,e);if(h>=0)return ji.copy(t,s[h].value);const u=~h,_=u-1,p=n[_],d=s[_],f=n[u],m=s[u],g=(e-p)/(f-p);switch(d.interpolationMode){default:case Ap.CONSTANT:return ji.copy(t,d.value);case Ap.SLERP:{const{easingMethod:e}=d,i=e===N_.LINEAR?g:Array.isArray(e)?gp(e,g):B_(e)(g);return ji.slerp(t,d.value,m.value,i)}}}addKeyFrame(e,t){const i=new Pp(t);return super.addKeyFrame(e,i)}assignSorted(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((e=>Rp(e))));else{const t=Array.from(e);this.setKeyframes(t.map((([e])=>e)),t.map((([,e])=>Rp(e))))}}[qh](e,t){if(!t.toCCON)return void e.writeThis();const{_times:i,_values:n}=this;let s=!0;n.forEach(((e,t,[i])=>{s&&e.interpolationMode!==i.interpolationMode&&(s=!1)}));const o=i.length,r=Bp*(s?1:o),a=n.reduce(((e,{easingMethod:t})=>e+(Array.isArray(t)?zp+4*Up:zp)),0);let c=0;c+=Op+Dp+Np*o+4*Lp*o+a+r+0;const l=new DataView(new ArrayBuffer(c));let h=0,u=0;s&&(u|=Mp.INTERPOLATION_MODE),l.setUint32(h,u,!0),h+=Op,l.setUint32(h,o,!0),h+=Dp,i.forEach(((e,t)=>l.setFloat32(h+Np*t,e,!0))),h+=Np*o,n.forEach((({value:{x:e,y:t,z:i,w:n}},s)=>{const o=h+4*Lp*s;l.setFloat32(o+0*Lp,e,!0),l.setFloat32(o+1*Lp,t,!0),l.setFloat32(o+2*Lp,i,!0),l.setFloat32(o+3*Lp,n,!0)})),h+=4*Lp*o,n.forEach((({easingMethod:e})=>{Array.isArray(e)?(l.setUint8(h,Fp),++h,l.setFloat32(h+0*Up,e[0],!0),l.setFloat32(h+1*Up,e[1],!0),l.setFloat32(h+2*Up,e[2],!0),l.setFloat32(h+3*Up,e[3],!0),h+=4*Up):(l.setUint8(h,e),++h)}));const _=h;h+=r;let p=_;n.forEach((({interpolationMode:e})=>{l.setUint8(p,e),s||(p+=Bp)}));const d=new Uint8Array(l.buffer);e.writeProperty("bytes",d)}[Xh](e,t){if(!t.fromCCON)return void e.readThis();const i=e.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength);let s=0;const o=n.getUint32(s,!0);s+=Op;const r=o&Mp.INTERPOLATION_MODE,a=n.getUint32(s,!0);s+=Dp;const c=Array.from({length:a},((e,t)=>n.getFloat32(s+Np*t,!0)));s+=Np*a;const l=s;s+=4*Lp*a;const h=Array.from({length:a},((e,t)=>{const i=l+4*Lp*t,o=n.getFloat32(i+0*Lp,!0),r=n.getFloat32(i+1*Lp,!0),a=n.getFloat32(i+2*Lp,!0),c=n.getFloat32(i+3*Lp,!0),h=n.getUint8(s);++s;const u=Rp({value:{x:o,y:r,z:a,w:c}});return h!==Fp?u.easingMethod=h:(u.easingMethod=[n.getFloat32(s+0*Up,!0),n.getFloat32(s+1*Up,!0),n.getFloat32(s+2*Up,!0),n.getFloat32(s+3*Up,!0)],s+=4*Up),u}));if(r){const e=n.getUint8(s);++s;for(let t=0;t<a;++t)h[t].interpolationMode=e}else{for(let e=0;e<a;++e){const t=n.getUint8(s+e);h[e].interpolationMode=t}s+=a}this._times=c,this._values=h}}).prototype,"preExtrapolation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ll.CLAMP}}),wp=Oc(Ep.prototype,"postExtrapolation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ll.CLAMP}}),Tp=Ep))||Tp);var Mp;!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Mp||(Mp={}));const Op=1,Dp=4,Np=4,Lp=4,Bp=1,zp=1,Fp=255,Up=4;var Gp;let kp=e("ObjectCurve",Wc("cc.ObjectCurve")(Gp=class extends zl{evaluate(e){const t=this.searchKeyframe(e);if(t>=0)return this._values[t];const i=di(~t-1,0,this._values.length-1);return this._values[i]}})||Gp);var Hp,Vp,jp,Wp,qp;class Xp{constructor(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}}wt.fastDefine("cc.Keyframe",Xp,{time:0,value:0,inTangent:0,outTangent:0});class Yp{constructor(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}evaluate(e){return t=e-this.time,i=this.coefficient,t*(t*(t*i[0]+i[1])+i[2])+i[3];var t,i}}let Kp=Wc("cc.AnimationCurve")((qp=Wp=class{get _internalCurve(){return this._curve}get keyFrames(){return Array.from(this._curve.keyframes()).map((([e,t])=>{const i=new Xp;return i.time=e,i.value=t.value,i.inTangent=t.leftTangent,i.outTangent=t.rightTangent,i}))}set keyFrames(e){this._curve.assignSorted(e.map((e=>[e.time,{interpolationMode:Nl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}])))}get preWrapMode(){return Qp(this._curve.preExtrapolation)}set preWrapMode(e){this._curve.preExtrapolation=$p(e)}get postWrapMode(){return Qp(this._curve.postExtrapolation)}set postWrapMode(e){this._curve.postExtrapolation=$p(e)}constructor(e=null){if(Mc(this,"_curve",jp,this),this.cachedKey=void 0,e instanceof q_)this._curve=e;else{const t=new q_;this._curve=t,t.preExtrapolation=Ll.LOOP,t.postExtrapolation=Ll.CLAMP,e?t.assignSorted(e.map((e=>[e.time,{interpolationMode:Nl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]))):t.assignSorted([[0,{interpolationMode:Nl.CUBIC,value:1}],[1,{interpolationMode:Nl.CUBIC,value:1}]])}this.cachedKey=new Yp}addKey(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:Nl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()}evaluate_slow(e){return this._curve.evaluate(e)}evaluate(e){const{cachedKey:t,_curve:i}=this,n=i.keyFramesCount-1;let s=e;const o=e<0?i.preExtrapolation:i.postExtrapolation,r=i.getKeyframeTime(0),a=i.getKeyframeTime(n);switch(o){case Ll.LOOP:s=wi(e-r,a-r)+r;break;case Ll.PING_PONG:s=Ai(e-r,a-r)+r;break;case Ll.CLAMP:default:s=di(e,r,a)}if(s>=t.time&&s<t.endTime)return t.evaluate(s);const c=this.findIndex(t,s),l=Math.min(c+1,n);return this.calcOptimizedKey(t,c,l),t.evaluate(s)}calcOptimizedKey(e,t,i){const n=this._curve.getKeyframeTime(t),s=this._curve.getKeyframeTime(i),{value:o,leftTangent:r}=this._curve.getKeyframeValue(t),{value:a,rightTangent:c}=this._curve.getKeyframeValue(i);e.index=t,e.time=n,e.endTime=s;const l=s-n,h=a-o,u=1/(l*l),_=r*l,p=c*l;e.coefficient[0]=(_+p-h-h)*u/l,e.coefficient[1]=(h+h+h-_-_-p)*u,e.coefficient[2]=r,e.coefficient[3]=o}findIndex(e,t){const{_curve:i}=this,n=i.keyFramesCount,s=e.index;if(-1!==s)if(t>i.getKeyframeTime(s))for(let e=0;e<3;e++){const o=s+e;if(o+1<n&&i.getKeyframeTime(o+1)>t)return o}else for(let e=0;e<3;e++){const n=s-e;if(n>=0&&i.getKeyframeTime(n-1)<=t)return n-1}let o,r=0,a=n;for(;a-r>1;)o=Math.floor((r+a)/2),i.getKeyframeTime(o)>=t?a=o:r=o;return r}},Wp.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],jp=Oc((Vp=qp).prototype,"_curve",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Hp=Vp))||Hp;function $p(e){switch(e){default:case Dc.Default:case Dc.Normal:case Dc.Clamp:return Ll.CLAMP;case Dc.PingPong:return Ll.PING_PONG;case Dc.Loop:return Ll.LOOP}}function Qp(e){switch(e){default:case Ll.LINEAR:case Ll.CLAMP:return Dc.Clamp;case Ll.PING_PONG:return Dc.PingPong;case Ll.LOOP:return Dc.Loop}}function Zp(){const e=new q_;return e.assignSorted([[0,{interpolationMode:Nl.CUBIC,value:1}],[1,{interpolationMode:Nl.CUBIC,value:1}]]),e}function Jp(e,t){console.warn(`${e} is deprecated, please use ${t} instead.`)}ei(qa,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var ed=Object.freeze({__proto__:null,distance:vs,enums:ys,intersect:qa,Line:xs,Plane:Qa,Ray:Ss,Triangle:Ps,Sphere:As,AABB:xc,OBB:Ec,Capsule:Cc,Frustum:Ic,Keyframe:Xp,AnimationCurve:Kp,get ERaycastMode(){return ca},line:class extends xs{constructor(){super(),Jp("line","Line")}},plane:class extends Qa{constructor(){super(),Jp("plane","Plane")}},ray:class extends Ss{constructor(){super(),Jp("ray","Ray")}},triangle:class extends Ps{constructor(){super(),Jp("triangle","Triangle")}},sphere:class extends As{constructor(){super(),Jp("sphere","Sphere")}},aabb:class extends xc{constructor(){super(),Jp("aabb","AABB")}},obb:class extends Ec{constructor(){super(),Jp("obb","OBB")}},capsule:class extends Cc{constructor(){super(),Jp("capsule","Capsule")}},frustum:class extends Ic{constructor(){super(),Jp("frustum","Frustum")}}});e("geometry",ed);const td={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295};class id{static makeMaskInclude(e){let t=0;for(const i of e)t|=i;return t}static makeMaskExclude(e){return~id.makeMaskInclude(e)}static addLayer(e,t){void 0!==t?t>19||t<0?console.warn("maximum layers reached."):(id.Enum[e]=1<<t,id.Enum[t]=e,id.BitMask[e]=1<<t,id.BitMask[t]=e):console.warn("bitNum can't be undefined")}static deleteLayer(e){e>19||e<0?console.warn("do not change buildin layers."):(delete id.Enum[id.Enum[e]],delete id.Enum[e],delete id.BitMask[id.BitMask[e]],delete id.BitMask[e])}static nameToLayer(e){return void 0===e?(console.warn("name can't be undefined"),-1):Kt(id.Enum[e])}static layerToName(e){return e>31||e<0?(console.warn("Unable to access unknown layer."),""):id.Enum[e]}}let nd,sd;e("Layers",id),id.Enum=Le(td),id.BitMask=Ne({...td}),n.Layers=id,function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(nd||(nd={})),n.RenderPassStage=nd,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(sd||(sd={}));const od={bindings:[],layouts:{}},rd={bindings:[],layouts:{}};let ad;!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_GBUFFER_ALBEDOMAP=6]="SAMPLER_GBUFFER_ALBEDOMAP",e[e.SAMPLER_GBUFFER_POSITIONMAP=7]="SAMPLER_GBUFFER_POSITIONMAP",e[e.SAMPLER_GBUFFER_NORMALMAP=8]="SAMPLER_GBUFFER_NORMALMAP",e[e.SAMPLER_GBUFFER_EMISSIVEMAP=9]="SAMPLER_GBUFFER_EMISSIVEMAP",e[e.SAMPLER_LIGHTING_RESULTMAP=10]="SAMPLER_LIGHTING_RESULTMAP",e[e.COUNT=11]="COUNT"}(ad||(ad={}));const cd=ad.SAMPLER_SHADOWMAP,ld=ad.COUNT-cd;let hd;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=11]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=12]="STORAGE_REFLECTION",e[e.COUNT=13]="COUNT"}(hd||(hd={}));const ud=hd.SAMPLER_JOINTS,_d=hd.COUNT-ud;let pd;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(pd||(pd={}));const dd=new Ro;dd.bufferOffsets=[0,cd+ud,cd],dd.samplerOffsets=[-cd,ld+_d,ld-ud],dd.flexibleSet=1;class fd{}fd.TIME_OFFSET=0,fd.NATIVE_SIZE_OFFSET=fd.TIME_OFFSET+4,fd.SCREEN_SIZE_OFFSET=fd.NATIVE_SIZE_OFFSET+4,fd.COUNT=fd.SCREEN_SIZE_OFFSET+4,fd.SIZE=4*fd.COUNT,fd.NAME="CCGlobal",fd.BINDING=ad.UBO_GLOBAL,fd.DESCRIPTOR=new or(fd.BINDING,uo.UNIFORM_BUFFER,1,Js.ALL),fd.LAYOUT=new Uo(pd.GLOBAL,fd.BINDING,fd.NAME,[new Fo("cc_time",zs.FLOAT4,1),new Fo("cc_screenSize",zs.FLOAT4,1),new Fo("cc_nativeSize",zs.FLOAT4,1)],1),od.layouts[fd.NAME]=fd.LAYOUT,od.bindings[fd.BINDING]=fd.DESCRIPTOR;class md{}md.MAT_VIEW_OFFSET=0,md.MAT_VIEW_INV_OFFSET=md.MAT_VIEW_OFFSET+16,md.MAT_PROJ_OFFSET=md.MAT_VIEW_INV_OFFSET+16,md.MAT_PROJ_INV_OFFSET=md.MAT_PROJ_OFFSET+16,md.MAT_VIEW_PROJ_OFFSET=md.MAT_PROJ_INV_OFFSET+16,md.MAT_VIEW_PROJ_INV_OFFSET=md.MAT_VIEW_PROJ_OFFSET+16,md.CAMERA_POS_OFFSET=md.MAT_VIEW_PROJ_INV_OFFSET+16,md.SCREEN_SCALE_OFFSET=md.CAMERA_POS_OFFSET+4,md.EXPOSURE_OFFSET=md.SCREEN_SCALE_OFFSET+4,md.MAIN_LIT_DIR_OFFSET=md.EXPOSURE_OFFSET+4,md.MAIN_LIT_COLOR_OFFSET=md.MAIN_LIT_DIR_OFFSET+4,md.AMBIENT_SKY_OFFSET=md.MAIN_LIT_COLOR_OFFSET+4,md.AMBIENT_GROUND_OFFSET=md.AMBIENT_SKY_OFFSET+4,md.GLOBAL_FOG_COLOR_OFFSET=md.AMBIENT_GROUND_OFFSET+4,md.GLOBAL_FOG_BASE_OFFSET=md.GLOBAL_FOG_COLOR_OFFSET+4,md.GLOBAL_FOG_ADD_OFFSET=md.GLOBAL_FOG_BASE_OFFSET+4,md.COUNT=md.GLOBAL_FOG_ADD_OFFSET+4,md.SIZE=4*md.COUNT,md.NAME="CCCamera",md.BINDING=ad.UBO_CAMERA,md.DESCRIPTOR=new or(md.BINDING,uo.UNIFORM_BUFFER,1,Js.ALL),md.LAYOUT=new Uo(pd.GLOBAL,md.BINDING,md.NAME,[new Fo("cc_matView",zs.MAT4,1),new Fo("cc_matViewInv",zs.MAT4,1),new Fo("cc_matProj",zs.MAT4,1),new Fo("cc_matProjInv",zs.MAT4,1),new Fo("cc_matViewProj",zs.MAT4,1),new Fo("cc_matViewProjInv",zs.MAT4,1),new Fo("cc_cameraPos",zs.FLOAT4,1),new Fo("cc_screenScale",zs.FLOAT4,1),new Fo("cc_exposure",zs.FLOAT4,1),new Fo("cc_mainLitDir",zs.FLOAT4,1),new Fo("cc_mainLitColor",zs.FLOAT4,1),new Fo("cc_ambientSky",zs.FLOAT4,1),new Fo("cc_ambientGround",zs.FLOAT4,1),new Fo("cc_fogColor",zs.FLOAT4,1),new Fo("cc_fogBase",zs.FLOAT4,1),new Fo("cc_fogAdd",zs.FLOAT4,1)],1),od.layouts[md.NAME]=md.LAYOUT,od.bindings[md.BINDING]=md.DESCRIPTOR;class gd{}gd.MAT_LIGHT_PLANE_PROJ_OFFSET=0,gd.MAT_LIGHT_VIEW_OFFSET=gd.MAT_LIGHT_PLANE_PROJ_OFFSET+16,gd.MAT_LIGHT_VIEW_PROJ_OFFSET=gd.MAT_LIGHT_VIEW_OFFSET+16,gd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=gd.MAT_LIGHT_VIEW_PROJ_OFFSET+16,gd.SHADOW_PROJ_DEPTH_INFO_OFFSET=gd.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+4,gd.SHADOW_PROJ_INFO_OFFSET=gd.SHADOW_PROJ_DEPTH_INFO_OFFSET+4,gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=gd.SHADOW_PROJ_INFO_OFFSET+4,gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=gd.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+4,gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=gd.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+4,gd.SHADOW_COLOR_OFFSET=gd.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+4,gd.COUNT=gd.SHADOW_COLOR_OFFSET+4,gd.SIZE=4*gd.COUNT,gd.NAME="CCShadow",gd.BINDING=ad.UBO_SHADOW,gd.DESCRIPTOR=new or(gd.BINDING,uo.UNIFORM_BUFFER,1,Js.ALL),gd.LAYOUT=new Uo(pd.GLOBAL,gd.BINDING,gd.NAME,[new Fo("cc_matLightPlaneProj",zs.MAT4,1),new Fo("cc_matLightView",zs.MAT4,1),new Fo("cc_matLightViewProj",zs.MAT4,1),new Fo("cc_shadowInvProjDepthInfo",zs.FLOAT4,1),new Fo("cc_shadowProjDepthInfo",zs.FLOAT4,1),new Fo("cc_shadowProjInfo",zs.FLOAT4,1),new Fo("cc_shadowNFLSInfo",zs.FLOAT4,1),new Fo("cc_shadowWHPBInfo",zs.FLOAT4,1),new Fo("cc_shadowLPNNInfo",zs.FLOAT4,1),new Fo("cc_shadowColor",zs.FLOAT4,1)],1),od.layouts[gd.NAME]=gd.LAYOUT,od.bindings[gd.BINDING]=gd.DESCRIPTOR;const vd=ad.SAMPLER_SHADOWMAP,yd=new or(vd,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),xd=new Go(pd.GLOBAL,vd,"cc_shadowMap",zs.SAMPLER2D,1);od.layouts.cc_shadowMap=xd,od.bindings[vd]=yd;const Sd=ad.SAMPLER_GBUFFER_ALBEDOMAP,bd=new or(Sd,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),Td=new Go(pd.GLOBAL,Sd,"cc_gbuffer_albedoMap",zs.SAMPLER2D,1);od.layouts.cc_gbuffer_albedoMap=Td,od.bindings[Sd]=bd;const Ed=ad.SAMPLER_GBUFFER_POSITIONMAP,Cd=new or(Ed,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),wd=new Go(pd.GLOBAL,Ed,"cc_gbuffer_positionMap",zs.SAMPLER2D,1);od.layouts.cc_gbuffer_positionMap=wd,od.bindings[Ed]=Cd;const Ad=ad.SAMPLER_GBUFFER_NORMALMAP,Pd=new or(Ad,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),Rd=new Go(pd.GLOBAL,Ad,"cc_gbuffer_normalMap",zs.SAMPLER2D,1);od.layouts.cc_gbuffer_normalMap=Rd,od.bindings[Ad]=Pd;const Id=ad.SAMPLER_LIGHTING_RESULTMAP,Md=new or(Id,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),Od=new Go(pd.GLOBAL,Id,"cc_lighting_resultMap",zs.SAMPLER2D,1);od.layouts.cc_lighting_resultMap=Od,od.bindings[Id]=Md;const Dd=ad.SAMPLER_GBUFFER_EMISSIVEMAP,Nd=new or(Dd,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),Ld=new Go(pd.GLOBAL,Dd,"cc_gbuffer_emissiveMap",zs.SAMPLER2D,1);od.layouts.cc_gbuffer_emissiveMap=Ld,od.bindings[Dd]=Nd;const Bd=ad.SAMPLER_ENVIRONMENT,zd=new or(Bd,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),Fd=new Go(pd.GLOBAL,Bd,"cc_environment",zs.SAMPLER_CUBE,1);od.layouts.cc_environment=Fd,od.bindings[Bd]=zd;const Ud=ad.SAMPLER_SPOT_LIGHTING_MAP,Gd=new or(Ud,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),kd=new Go(pd.GLOBAL,Ud,"cc_spotLightingMap",zs.SAMPLER2D,1);od.layouts.cc_spotLightingMap=kd,od.bindings[Ud]=Gd;class Hd{}Hd.MAT_WORLD_OFFSET=0,Hd.MAT_WORLD_IT_OFFSET=Hd.MAT_WORLD_OFFSET+16,Hd.LIGHTINGMAP_UVPARAM=Hd.MAT_WORLD_IT_OFFSET+16,Hd.COUNT=Hd.LIGHTINGMAP_UVPARAM+4,Hd.SIZE=4*Hd.COUNT,Hd.NAME="CCLocal",Hd.BINDING=hd.UBO_LOCAL,Hd.DESCRIPTOR=new or(Hd.BINDING,uo.UNIFORM_BUFFER,1,Js.VERTEX|Js.COMPUTE),Hd.LAYOUT=new Uo(pd.LOCAL,Hd.BINDING,Hd.NAME,[new Fo("cc_matWorld",zs.MAT4,1),new Fo("cc_matWorldIT",zs.MAT4,1),new Fo("cc_lightingMapUVParam",zs.FLOAT4,1)],1),rd.layouts[Hd.NAME]=Hd.LAYOUT,rd.bindings[Hd.BINDING]=Hd.DESCRIPTOR;class Vd{}Vd.BATCHING_COUNT=10,Vd.MAT_WORLDS_OFFSET=0,Vd.COUNT=16*Vd.BATCHING_COUNT,Vd.SIZE=4*Vd.COUNT,Vd.NAME="CCLocalBatched",Vd.BINDING=hd.UBO_LOCAL,Vd.DESCRIPTOR=new or(Vd.BINDING,uo.UNIFORM_BUFFER,1,Js.VERTEX|Js.COMPUTE),Vd.LAYOUT=new Uo(pd.LOCAL,Vd.BINDING,Vd.NAME,[new Fo("cc_matWorlds",zs.MAT4,Vd.BATCHING_COUNT)],1),rd.layouts[Vd.NAME]=Vd.LAYOUT,rd.bindings[Vd.BINDING]=Vd.DESCRIPTOR;class jd{}jd.LIGHTS_PER_PASS=1,jd.LIGHT_POS_OFFSET=0,jd.LIGHT_COLOR_OFFSET=jd.LIGHT_POS_OFFSET+4*jd.LIGHTS_PER_PASS,jd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=jd.LIGHT_COLOR_OFFSET+4*jd.LIGHTS_PER_PASS,jd.LIGHT_DIR_OFFSET=jd.LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*jd.LIGHTS_PER_PASS,jd.COUNT=jd.LIGHT_DIR_OFFSET+4*jd.LIGHTS_PER_PASS,jd.SIZE=4*jd.COUNT,jd.NAME="CCForwardLight",jd.BINDING=hd.UBO_FORWARD_LIGHTS,jd.DESCRIPTOR=new or(jd.BINDING,uo.DYNAMIC_UNIFORM_BUFFER,1,Js.FRAGMENT),jd.LAYOUT=new Uo(pd.LOCAL,jd.BINDING,jd.NAME,[new Fo("cc_lightPos",zs.FLOAT4,jd.LIGHTS_PER_PASS),new Fo("cc_lightColor",zs.FLOAT4,jd.LIGHTS_PER_PASS),new Fo("cc_lightSizeRangeAngle",zs.FLOAT4,jd.LIGHTS_PER_PASS),new Fo("cc_lightDir",zs.FLOAT4,jd.LIGHTS_PER_PASS)],1),rd.layouts[jd.NAME]=jd.LAYOUT,rd.bindings[jd.BINDING]=jd.DESCRIPTOR;class Wd{}Wd.JOINTS_TEXTURE_INFO_OFFSET=0,Wd.COUNT=Wd.JOINTS_TEXTURE_INFO_OFFSET+4,Wd.SIZE=4*Wd.COUNT,Wd.NAME="CCSkinningTexture",Wd.BINDING=hd.UBO_SKINNING_TEXTURE,Wd.DESCRIPTOR=new or(Wd.BINDING,uo.UNIFORM_BUFFER,1,Js.VERTEX),Wd.LAYOUT=new Uo(pd.LOCAL,Wd.BINDING,Wd.NAME,[new Fo("cc_jointTextureInfo",zs.FLOAT4,1)],1),rd.layouts[Wd.NAME]=Wd.LAYOUT,rd.bindings[Wd.BINDING]=Wd.DESCRIPTOR;class qd{}qd.JOINTS_ANIM_INFO_OFFSET=0,qd.COUNT=qd.JOINTS_ANIM_INFO_OFFSET+4,qd.SIZE=4*qd.COUNT,qd.NAME="CCSkinningAnimation",qd.BINDING=hd.UBO_SKINNING_ANIMATION,qd.DESCRIPTOR=new or(qd.BINDING,uo.UNIFORM_BUFFER,1,Js.VERTEX),qd.LAYOUT=new Uo(pd.LOCAL,qd.BINDING,qd.NAME,[new Fo("cc_jointAnimInfo",zs.FLOAT4,1)],1),rd.layouts[qd.NAME]=qd.LAYOUT,rd.bindings[qd.BINDING]=qd.DESCRIPTOR;class Xd{}Xd.JOINTS_OFFSET=0,Xd.COUNT=Xd.JOINTS_OFFSET+360,Xd.SIZE=4*Xd.COUNT,Xd.NAME="CCSkinning",Xd.BINDING=hd.UBO_SKINNING_TEXTURE,Xd.DESCRIPTOR=new or(Xd.BINDING,uo.UNIFORM_BUFFER,1,Js.VERTEX),Xd.LAYOUT=new Uo(pd.LOCAL,Xd.BINDING,Xd.NAME,[new Fo("cc_joints",zs.FLOAT4,90)],1),rd.layouts[Xd.NAME]=Xd.LAYOUT,rd.bindings[Xd.BINDING]=Xd.DESCRIPTOR;class Yd{}Yd.MAX_MORPH_TARGET_COUNT=60,Yd.OFFSET_OF_WEIGHTS=0,Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Yd.MAX_MORPH_TARGET_COUNT,Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH+4,Yd.OFFSET_OF_VERTICES_COUNT=Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT+4,Yd.COUNT_BASE_4_BYTES=4*Math.ceil(Yd.MAX_MORPH_TARGET_COUNT/4)+4,Yd.SIZE=4*Yd.COUNT_BASE_4_BYTES,Yd.NAME="CCMorph",Yd.BINDING=hd.UBO_MORPH,Yd.DESCRIPTOR=new or(Yd.BINDING,uo.UNIFORM_BUFFER,1,Js.VERTEX),Yd.LAYOUT=new Uo(pd.LOCAL,Yd.BINDING,Yd.NAME,[new Fo("cc_displacementWeights",zs.FLOAT4,Yd.MAX_MORPH_TARGET_COUNT/4),new Fo("cc_displacementTextureInfo",zs.FLOAT4,1)],1),rd.layouts[Yd.NAME]=Yd.LAYOUT,rd.bindings[Yd.BINDING]=Yd.DESCRIPTOR;const Kd=hd.SAMPLER_JOINTS,$d=new or(Kd,uo.SAMPLER_TEXTURE,1,Js.VERTEX),Qd=new Go(pd.LOCAL,Kd,"cc_jointTexture",zs.SAMPLER2D,1);rd.layouts.cc_jointTexture=Qd,rd.bindings[Kd]=$d;const Zd=hd.SAMPLER_MORPH_POSITION,Jd=new or(Zd,uo.SAMPLER_TEXTURE,1,Js.VERTEX),ef=new Go(pd.LOCAL,Zd,"cc_PositionDisplacements",zs.SAMPLER2D,1);rd.layouts.cc_PositionDisplacements=ef,rd.bindings[Zd]=Jd;const tf=hd.SAMPLER_MORPH_NORMAL,nf=new or(tf,uo.SAMPLER_TEXTURE,1,Js.VERTEX),sf=new Go(pd.LOCAL,tf,"cc_NormalDisplacements",zs.SAMPLER2D,1);rd.layouts.cc_NormalDisplacements=sf,rd.bindings[tf]=nf;const of=hd.SAMPLER_MORPH_TANGENT,rf=new or(of,uo.SAMPLER_TEXTURE,1,Js.VERTEX),af=new Go(pd.LOCAL,of,"cc_TangentDisplacements",zs.SAMPLER2D,1);rd.layouts.cc_TangentDisplacements=af,rd.bindings[of]=rf;const cf=hd.SAMPLER_LIGHTMAP,lf=new or(cf,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),hf=new Go(pd.LOCAL,cf,"cc_lightingMap",zs.SAMPLER2D,1);rd.layouts.cc_lightingMap=hf,rd.bindings[cf]=lf;const uf=hd.SAMPLER_SPRITE,_f=new or(uf,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),pf=new Go(pd.LOCAL,uf,"cc_spriteTexture",zs.SAMPLER2D,1);rd.layouts.cc_spriteTexture=pf,rd.bindings[uf]=_f;const df=hd.SAMPLER_REFLECTION,ff=new or(df,uo.SAMPLER_TEXTURE,1,Js.FRAGMENT),mf=new Go(pd.LOCAL,df,"cc_reflectionTexture",zs.SAMPLER2D,1);rd.layouts.cc_reflectionTexture=mf,rd.bindings[df]=ff;const gf=hd.STORAGE_REFLECTION,vf=new or(gf,uo.STORAGE_IMAGE,1,Js.COMPUTE),yf=new Vo(pd.LOCAL,gf,"cc_reflectionStorage",zs.IMAGE2D,1);rd.layouts.cc_reflectionStorage=yf,rd.bindings[gf]=vf;const xf=id.makeMaskExclude([id.BitMask.UI_2D,id.BitMask.GIZMOS,id.BitMask.EDITOR,id.BitMask.SCENE_GIZMO,id.BitMask.PROFILER]);let Sf,bf,Tf,Ef,Cf;id.makeMaskExclude([id.BitMask.UI_2D,id.BitMask.PROFILER]),id.Enum.ALL,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Sf||(Sf={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(bf||(bf={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Tf||(Tf={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Ef||(Ef={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Cf||(Cf={}));const wf=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Af=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Pf=[100,200,400,800],Rf=new zi,If=new zi,Mf=new Zi,Of=fo.STENCIL<<1,Df=[];class Nf{constructor(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Sf.VERTICAL,this._fov=gi(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Po(.2,.2,.2,1),this._viewport=new _n(0,0,1,1),this._curTransform=Ds.IDENTITY,this._isProjDirty=!0,this._matView=new Zi,this._matViewInv=null,this._matProj=new Zi,this._matProjInv=new Zi,this._matViewProj=new Zi,this._matViewProjInv=new Zi,this._frustum=new Ic,this._forward=new zi,this._position=new zi,this._priority=0,this._aperture=Tf.F16_0,this._apertureValue=void 0,this._shutter=Cf.D125,this._shutterValue=0,this._iso=Ef.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=fo.NONE,this._clearDepth=1,this._visibility=xf,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=wf[this._aperture],this._shutterValue=Af[this._shutter],this._isoValue=Pf[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!Df.length){const t=e.capabilities.clipSpaceSignY;Df[Ds.IDENTITY]=new Zi(1,0,0,0,0,t),Df[Ds.ROTATE_90]=new Zi(0,1,0,0,-t,0),Df[Ds.ROTATE_180]=new Zi(-1,0,0,0,0,-t),Df[Ds.ROTATE_270]=new Zi(0,-1,0,0,t,0)}}_setWidth(e){this._width=e,this._nativeObj.width=e}_setHeight(e){this._height=e,this._nativeObj.height=e}_setScene(e){this._scene=e,this._nativeObj.scene=e?e.native:null}_init(e){this._nativeObj=new $n,this._scene&&(this._nativeObj.scene=this._scene.native),this._nativeObj.frustum=this._frustum}initialize(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=fo.NONE,this.clearDepth=1,this.visibility=xf,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)}_destroy(){this._nativeObj=null}destroy(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()}attachToScene(e){this._enabled=!0,this._setScene(e)}detachFromScene(){this._enabled=!1,this._setScene(null)}resize(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._nativeObj.aspect=this._aspect,this._isProjDirty=!0)}setFixedSize(e,t){this._setWidth(e),this._setHeight(t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._nativeObj.aspect=this._aspect,this.isWindowSize=!1}update(e=!1){if(!this._node)return;let t=!1;(this._node.hasChangedFlags||e)&&(Zi.invert(this._matView,this._node.worldMatrix),this._nativeObj.matView=this._matView,this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),this._nativeObj.position=this._position,this._nativeObj.forward=this._forward,t=!0);let i=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==i){var n;this._curTransform=i;const e=this._device.capabilities.clipSpaceSignY;if((null===(n=this.window)||void 0===n?void 0:n.hasOffScreenAttachments)&&(i=Ds.IDENTITY),this._proj===bf.PERSPECTIVE)Zi.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Sf.VERTICAL,this._device.capabilities.clipSpaceMinZ,e,i);else{const t=this._orthoHeight*this._aspect,n=this._orthoHeight;Zi.ortho(this._matProj,-t,t,-n,n,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,e,i)}this._nativeObj.aspect=this._aspect,Zi.invert(this._matProjInv,this._matProj),this._nativeObj.matProj=this._matProj,this._nativeObj.matProjInv=this._matProjInv,t=!0,this._isProjDirty=!1}t&&(Zi.multiply(this._matViewProj,this._matProj,this._matView),Zi.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),this._nativeObj.matViewProj=this._matViewProj,this._nativeObj.matViewProjInv=this._matViewProjInv,this._nativeObj.frustum=this._frustum)}set node(e){this._node=e,this._nativeObj.node=this._node.native}get node(){return this._node}set enabled(e){this._enabled=e}get enabled(){return this._enabled}set orthoHeight(e){this._orthoHeight=e,this._isProjDirty=!0}get orthoHeight(){return this._orthoHeight}set projectionType(e){this._proj=e,this._isProjDirty=!0}get projectionType(){return this._proj}set fovAxis(e){this._fovAxis=e,this._isProjDirty=!0}get fovAxis(){return this._fovAxis}set fov(e){this._fov=e,this._nativeObj.fov=e,this._isProjDirty=!0}get fov(){return this._fov}set nearClip(e){this._nearClip=e,this._isProjDirty=!0}get nearClip(){return this._nearClip}set farClip(e){this._farClip=e,this._isProjDirty=!0}get farClip(){return this._farClip}set clearColor(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w,this._nativeObj.clearColor=this._clearColor}get clearColor(){return this._clearColor}get viewport(){return this._viewport}set viewport(e){const{x:t,width:i,height:n}=e,s=this._device.capabilities.screenSpaceSignY<0?1-e.y-n:e.y;switch(this._device.surfaceTransform){case Ds.ROTATE_90:this._viewport.x=1-s-n,this._viewport.y=t,this._viewport.width=n,this._viewport.height=i;break;case Ds.ROTATE_180:this._viewport.x=1-t-i,this._viewport.y=1-s-n,this._viewport.width=i,this._viewport.height=n;break;case Ds.ROTATE_270:this._viewport.x=s,this._viewport.y=1-t-i,this._viewport.width=n,this._viewport.height=i;break;case Ds.IDENTITY:this._viewport.x=t,this._viewport.y=s,this._viewport.width=i,this._viewport.height=n}this._nativeObj.viewPort=this._viewport,this.resize(this.width,this.height)}get scene(){return this._scene}get name(){return this._name}get width(){return this._width}get height(){return this._height}get aspect(){return this._aspect}set matView(e){this._matView=e,this._nativeObj.matView=this._matView}get matView(){return this._matView}set matViewInv(e){this._matViewInv=e}get matViewInv(){return this._matViewInv||this._node.worldMatrix}set matProj(e){this._matProj=e,this._nativeObj.matProj=this._matProj}get matProj(){return this._matProj}set matProjInv(e){this._matProjInv=e,this._nativeObj.matProjInv=this._matProjInv}get matProjInv(){return this._matProjInv}set matViewProj(e){this._matViewProj=e,this._nativeObj.matViewProj=this._matViewProj}get matViewProj(){return this._matViewProj}set matViewProjInv(e){this._matViewProjInv=e,this._nativeObj.matViewProjInv=this._matViewProjInv}get matViewProjInv(){return this._matViewProjInv}set frustum(e){this._frustum=e,this._nativeObj.frustum=this._frustum}get frustum(){return this._frustum}set window(e){this._window=e,e&&(this._nativeObj.window=this._window.native)}get window(){return this._window}set forward(e){this._forward=e,this._nativeObj.forward=this._forward}get forward(){return this._forward}set position(e){this._position=e,this._nativeObj.position=this._position}get position(){return this._position}set visibility(e){this._visibility=e,this._nativeObj.visibility=this._visibility}get visibility(){return this._visibility}get priority(){return this._priority}set priority(e){this._priority=e}set aperture(e){this._aperture=e,this._apertureValue=wf[this._aperture],this.updateExposure()}get aperture(){return this._aperture}get apertureValue(){return this._apertureValue}set shutter(e){this._shutter=e,this._shutterValue=Af[this._shutter],this.updateExposure()}get shutter(){return this._shutter}get shutterValue(){return this._shutterValue}set iso(e){this._iso=e,this._isoValue=Pf[this._iso],this.updateExposure()}get iso(){return this._iso}get isoValue(){return this._isoValue}set ec(e){this._ec=e}get ec(){return this._ec}get exposure(){return this._exposure}get clearFlag(){return this._clearFlag}set clearFlag(e){this._clearFlag=e,this._nativeObj.clearFlag=e}get clearDepth(){return this._clearDepth}set clearDepth(e){this._clearDepth=e,this._nativeObj.clearDepth=e}get clearStencil(){return this._clearStencil}set clearStencil(e){this._clearStencil=e,this._nativeObj.clearStencil=e}get native(){return this._nativeObj}changeTargetWindow(e=null){this._window&&this._window.detachCamera(this);const t=e||n.director.root.mainWindow;t&&(t.attachCamera(this),this.window=t,this.resize(t.width,t.height))}detachCamera(){this._window&&this._window.detachCamera(this)}screenPointToRay(e,t,i){if(!this._node)return null;const n=this.width,s=this.height,o=this._viewport.x*n,r=this._viewport.y*s,a=this._viewport.width*n,c=this._viewport.height*s,l=this._proj===bf.PERSPECTIVE,h=this._device.capabilities.clipSpaceSignY,u=Qi[this._curTransform];zi.set(Rf,(t-o)/a*2-1,(i-r)/c*2-1,l?1:-1);const{x:_,y:p}=Rf;return Rf.x=_*u[0]+p*u[2]*h,Rf.y=_*u[1]+p*u[3]*h,zi.transformMat4(l?Rf:e.o,Rf,this._matViewProjInv),l?(this._node.getWorldPosition(If),Ss.fromPoints(e,If,Rf)):zi.transformQuat(e.d,zi.FORWARD,this._node.worldRotation),e}screenToWorld(e,t){const i=this.width,n=this.height,s=this._viewport.x*i,o=this._viewport.y*n,r=this._viewport.width*i,a=this._viewport.height*n,c=this._device.capabilities.clipSpaceSignY,l=Qi[this._curTransform];if(this._proj===bf.PERSPECTIVE){zi.set(e,(t.x-s)/r*2-1,(t.y-o)/a*2-1,1);const{x:i,y:n}=e;e.x=i*l[0]+n*l[2]*c,e.y=i*l[1]+n*l[3]*c,zi.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(Rf),zi.lerp(e,Rf,e,mi(this._nearClip/this._farClip,1,t.z))}else{zi.set(e,(t.x-s)/r*2-1,(t.y-o)/a*2-1,2*t.z-1);const{x:i,y:n}=e;e.x=i*l[0]+n*l[2]*c,e.y=i*l[1]+n*l[3]*c,zi.transformMat4(e,e,this._matViewProjInv)}return e}worldToScreen(e,t){const i=this.width,n=this.height,s=this._viewport.x*i,o=this._viewport.y*n,r=this._viewport.width*i,a=this._viewport.height*n,c=this._device.capabilities.clipSpaceSignY,l=Qi[this._curTransform];zi.transformMat4(e,t,this._matViewProj);const{x:h,y:u}=e;return e.x=h*l[0]+u*l[2]*c,e.y=h*l[1]+u*l[3]*c,e.x=s+.5*(e.x+1)*r,e.y=o+.5*(e.y+1)*a,e.z=.5*e.z+.5,e}worldMatrixToScreen(e,t,i,n){Zi.multiply(e,this._matViewProj,t),Zi.multiply(e,Df[this._curTransform],e);const s=i/2,o=n/2;return Zi.identity(Mf),Zi.transform(Mf,Mf,zi.set(Rf,s,o,0)),Zi.scale(Mf,Mf,zi.set(Rf,s,o,1)),Zi.multiply(e,Mf,e),e}setExposure(e){this._exposure=.833333/2**e,this._nativeObj.exposure=this._exposure}updateExposure(){const e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)}}let Lf,Bf,zf,Ff=1024;var Uf,Gf,kf,Hf;function Vf(e){return!!(n.sys.capabilities.imageBitmap&&e instanceof ImageBitmap)}!function(e){e[e.RGB565=Ls.R5G6B5]="RGB565",e[e.RGB5A1=Ls.RGB5A1]="RGB5A1",e[e.RGBA4444=Ls.RGBA4]="RGBA4444",e[e.RGB888=Ls.RGB8]="RGB888",e[e.RGB32F=Ls.RGB32F]="RGB32F",e[e.RGBA8888=Ls.RGBA8]="RGBA8888",e[e.RGBA32F=Ls.RGBA32F]="RGBA32F",e[e.A8=Ls.A8]="A8",e[e.I8=Ls.L8]="I8",e[e.AI8=Ls.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Ls.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Ls.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Ff++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Ls.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Ls.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Ff++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Ls.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Ff++]="RGBA_ETC1",e[e.RGB_ETC2=Ls.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Ls.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Ls.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Ls.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Ls.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Ls.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Ls.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Ls.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Ls.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Ls.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Ls.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Ls.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Ls.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Ls.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Ls.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Ls.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Lf||(Lf={})),function(e){e[e.REPEAT=Xs.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Xs.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Xs.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Xs.BORDER]="CLAMP_TO_BORDER"}(Bf||(Bf={})),function(e){e[e.NONE=qs.NONE]="NONE",e[e.LINEAR=qs.LINEAR]="LINEAR",e[e.NEAREST=qs.POINT]="NEAREST"}(zf||(zf={}));let jf,Wf=e("ImageAsset",Wc("cc.ImageAsset")((Hf=kf=class e extends xh{get _nativeAsset(){return this._nativeData}set _nativeAsset(e){e instanceof HTMLElement||Vf(e)||(e.format=e.format||this._format),this.reset(e)}get data(){return this._nativeData&&!0!==(e=this._nativeData)._compressed&&(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Vf(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}get width(){return this._nativeData.width||this._width}get height(){return this._nativeData.height||this._height}get format(){return this._format}get isCompressed(){return this._format>=Lf.RGB_ETC1&&this._format<=Lf.RGBA_ASTC_12x12||this._format>=Lf.RGB_A_PVRTC_2BPPV1&&this._format<=Lf.RGBA_ETC1}get url(){return this.nativeUrl}constructor(e){super(),this._nativeData=void 0,this._exportedExts=void 0,this._format=Lf.RGBA8888,this._width=0,this._height=0,this._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&this.reset(e)}reset(e){Vf(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)}destroy(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset(""),this.data.destroy()):Vf(this.data)&&this.data.close&&this.data.close(),super.destroy()}_serialize(){}_deserialize(t){let i="";"string"==typeof t?i=t:(this._width=t.w,this._height=t.h,i=t.fmt);const s=n.director.root?n.director.root.device:null,o=i.split("_");let r=Number.MAX_VALUE,a=this._format,c="";const l=n.macro.SUPPORT_TEXTURE_FORMATS;for(const t of o){const i=t.split("@"),o=parseInt(i[0],void 0),h=e.extnames[o]||i[0],u=l.indexOf(h);if(-1!==u&&u<r){const e=i[1]?parseInt(i[1]):this._format;if(!(".astc"!==h||s&&s.hasFeature(Ns.FORMAT_ASTC)))continue;if(!(".pvr"!==h||s&&s.hasFeature(Ns.FORMAT_PVRTC)))continue;if(!(e!==Lf.RGB_ETC1&&e!==Lf.RGBA_ETC1||s&&s.hasFeature(Ns.FORMAT_ETC1)))continue;if(!(e!==Lf.RGB_ETC2&&e!==Lf.RGBA_ETC2||s&&s.hasFeature(Ns.FORMAT_ETC2)))continue;if(".webp"===h&&!n.sys.capabilities.webp)continue;r=u,c=h,a=e}}c?(this._setRawAsset(c),this._format=a):T(3121)}initDefault(t){if(super.initDefault(t),e._sharedPlaceHolderCanvas)this.reset(e._sharedPlaceHolderCanvas);else{const t=document.createElement("canvas"),i=t.getContext("2d"),n=t.width=t.height=2;i.fillStyle="#ff00ff",i.fillRect(0,0,n,n),this.reset(t),e._sharedPlaceHolderCanvas=t}}validate(){return!!this.data}},kf.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],kf._sharedPlaceHolderCanvas=null,Oc((Gf=Hf).prototype,"_nativeAsset",[Pl],Object.getOwnPropertyDescriptor(Gf.prototype,"_nativeAsset"),Gf.prototype),Uf=Gf))||Uf);n.ImageAsset=Wf,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.mipLODBias=8]="mipLODBias",e[e.total=9]="total"}(jf||(jf={}));const qf=[qs.LINEAR,qs.LINEAR,qs.NONE,Xs.WRAP,Xs.WRAP,Xs.WRAP,0,Ys.NEVER,0],Xf=$f(qf),Yf=new Po,Kf=new zo;function $f(e){let t=0,i=0;for(let n=0;n<qf.length;n++)switch(t=e[n]||qf[n],n){case jf.minFilter:i|=t;break;case jf.magFilter:i|=t<<2;break;case jf.mipFilter:i|=t<<4;break;case jf.addressU:i|=t<<6;break;case jf.addressV:i|=t<<8;break;case jf.addressW:i|=t<<10;break;case jf.maxAnisotropy:i|=t<<12;break;case jf.cmpFunc:i|=t<<16;break;case jf.mipLODBias:i|=t<<28}return i}const Qf=new class{constructor(){this._cache={}}getSampler(e,t){t||(t=Xf);const i=this._cache[t];return i||(Kf.minFilter=3&t,Kf.magFilter=t>>2&3,Kf.mipFilter=t>>4&3,Kf.addressU=t>>6&3,Kf.addressV=t>>8&3,Kf.addressW=t>>10&3,Kf.maxAnisotropy=t>>12&15,Kf.cmpFunc=t>>16&15,Kf.mipLODBias=t>>28&15,Kf.borderColor=Yf,this._cache[t]=e.createSampler(Kf))}};var Zf,Jf,em,tm,im,nm,sm,om,rm,am,cm,lm;n.samplerLib=Qf;const hm=new X("Tex");let um=Wc("cc.TextureBase")((lm=cm=class extends xh{get isCompressed(){return this._format>=Lf.RGB_ETC1&&this._format<=Lf.RGBA_ASTC_12x12||this._format>=Lf.RGB_A_PVRTC_2BPPV1&&this._format<=Lf.RGBA_ETC1}get width(){return this._width}get height(){return this._height}constructor(){super(),Mc(this,"_format",em,this),Mc(this,"_minFilter",tm,this),Mc(this,"_magFilter",im,this),Mc(this,"_mipFilter",nm,this),Mc(this,"_wrapS",sm,this),Mc(this,"_wrapT",om,this),Mc(this,"_wrapR",rm,this),Mc(this,"_anisotropy",am,this),this._width=1,this._height=1,this._id=void 0,this._samplerInfo=[],this._samplerHash=0,this._gfxSampler=null,this._gfxDevice=null,this._textureHash=0,this._id=hm.getNewId(),this._gfxDevice=this._getGFXDevice(),this._textureHash=Vr(this._id,666)}getId(){return this._id}getPixelFormat(){return this._format}getAnisotropy(){return this._anisotropy}setWrapMode(e,t,i){this._wrapS=e,this._samplerInfo[jf.addressU]=e,this._wrapT=t,this._samplerInfo[jf.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[jf.addressW]=i),this._samplerHash=$f(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Qf.getSampler(this._gfxDevice,this._samplerHash))}setFilters(e,t){this._minFilter=e,this._samplerInfo[jf.minFilter]=e,this._magFilter=t,this._samplerInfo[jf.magFilter]=t,this._samplerHash=$f(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Qf.getSampler(this._gfxDevice,this._samplerHash))}setMipFilter(e){this._mipFilter=e,this._samplerInfo[jf.mipFilter]=e,this._samplerHash=$f(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Qf.getSampler(this._gfxDevice,this._samplerHash))}setAnisotropy(e){this._anisotropy=e,this._samplerInfo[jf.maxAnisotropy]=e,this._samplerHash=$f(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Qf.getSampler(this._gfxDevice,this._samplerHash))}destroy(){var e;const t=super.destroy();return t&&(null===(e=n.director.root)||void 0===e?void 0:e.batcher2D)&&n.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),t}getHash(){return this._textureHash}getGFXTexture(){return null}getSamplerHash(){return this._samplerHash}getGFXSampler(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=Qf.getSampler(this._gfxDevice,this._samplerHash):C(9302)),this._gfxSampler}_serialize(e){return""}_deserialize(e,t){const i=e.split(",");i.unshift(""),i.length>=5&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4]))),i.length>=7&&(this.setMipFilter(parseInt(i[5])),this.setAnisotropy(parseInt(i[6])))}_getGFXDevice(){return n.director.root?n.director.root.device:null}_getGFXFormat(){return this._getGFXPixelFormat(this._format)}_setGFXFormat(e){this._format=void 0===e?Lf.RGBA8888:e}_getGFXPixelFormat(e){return e===Lf.RGBA_ETC1?e=Lf.RGB_ETC1:e===Lf.RGB_A_PVRTC_4BPPV1?e=Lf.RGB_PVRTC_4BPPV1:e===Lf.RGB_A_PVRTC_2BPPV1&&(e=Lf.RGB_PVRTC_2BPPV1),e}},cm.PixelFormat=Lf,cm.WrapMode=Bf,cm.Filter=zf,em=Oc((Jf=lm).prototype,"_format",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lf.RGBA8888}}),tm=Oc(Jf.prototype,"_minFilter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zf.LINEAR}}),im=Oc(Jf.prototype,"_magFilter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zf.LINEAR}}),nm=Oc(Jf.prototype,"_mipFilter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zf.NONE}}),sm=Oc(Jf.prototype,"_wrapS",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bf.REPEAT}}),om=Oc(Jf.prototype,"_wrapT",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bf.REPEAT}}),rm=Oc(Jf.prototype,"_wrapR",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bf.REPEAT}}),am=Oc(Jf.prototype,"_anisotropy",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zf=Jf))||Zf;n.TextureBase=um;const _m=new WeakMap,pm=new WeakSet,dm=new WeakSet;function fm(e,t){let i;i=Wh.safeFindClass;const n=ru.pool.get();let s;try{s=vu(e,n,{classFinder:i,customEnv:t})}catch(e){throw d(e),ru.pool.put(n),e}s._uuid=t.__uuid__||"";const o=n.uuidList,r=n.uuidObjList,a=n.uuidPropList,c=n.uuidTypeList||[],l=[];for(let e=0;e<o.length;e++){const t=o[e];l[e]={uuid:sh(t),owner:r[e],prop:a[e],type:De._getClassById(c[e])}}return _m.set(s,l),s._native&&pm.add(s),ru.pool.put(n),s}var mm,gm=new class{constructor(){this._depends=new kl}init(){this._depends.clear()}getNativeDep(e){const t=this._depends.get(e);return t&&t.nativeDep?{...t.nativeDep}:null}getDeps(e){return this._depends.has(e)?this._depends.get(e).deps:[]}getDepsRecursively(e){const t=Object.create(null),i=[];return this._descend(e,t,i),i}remove(e){this._depends.remove(e)}parse(e,t){let i=null;if(Array.isArray(t)||t.__type__||t instanceof Yh){if(this._depends.has(e))return this._depends.get(e);if(Array.isArray(t)&&!function(e){const t=e[5],i=t[t.length-1];return"number"==typeof i&&i<0}(t))i={deps:this._parseDepsFromJson(t)};else try{const n=fm(t,{__uuid__:e});i=this._parseDepsFromAsset(n),i.nativeDep&&(i.nativeDep.uuid=e),Wl.add(`${e}@import`,n)}catch(t){jl.remove(`${e}@import`),i={deps:[]}}}else{if(this._depends.has(e)&&(i=this._depends.get(e),i.parsedFromExistAsset))return i;i=this._parseDepsFromAsset(t)}return this._depends.add(e,i),i}_parseDepsFromAsset(e){const t={deps:[],parsedFromExistAsset:!0},i=_m.get(e);for(let e=0,n=i.length;e<n;e++)t.deps.push(i[e].uuid);return pm.has(e)&&(t.nativeDep=e._nativeDep),t}_parseDepsFromJson(e){const t=function(e){const t=e[1];return e[10].map((e=>t[e]))}(e);return t.forEach(((e,i)=>t[i]=sh(e))),t}_descend(e,t,i){const n=this.getDeps(e);for(let e=0;e<n.length;e++){const s=n[e];t[s]||(t[s]=!0,i.push(s),this._descend(s,t,i))}}};const vm=[new wo];function ym(e){return e&&0==(e&e-1)}let xm=Wc("cc.SimpleTexture")(mm=class extends um{constructor(...e){super(...e),this._gfxTexture=null,this._mipmapLevel=1,this._textureWidth=0,this._textureHeight=0}get mipmapLevel(){return this._mipmapLevel}getGFXTexture(){return this._gfxTexture}destroy(){return this._tryDestroyTexture(),super.destroy()}updateImage(){this.updateMipmaps(0)}updateMipmaps(e=0,t){}uploadData(e,t=0,i=0){if(!this._gfxTexture||this._mipmapLevel<=t)return;const n=this._getGFXDevice();if(!n)return;const s=vm[0];s.texExtent.width=this._textureWidth>>t,s.texExtent.height=this._textureHeight>>t,s.texSubres.mipLevel=t,s.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?n.copyBuffersToTexture([e],this._gfxTexture,vm):n.copyTexImagesToTexture([e],this._gfxTexture,vm)}_assignImage(e,t,i){const n=e.data;if(n&&(this.uploadData(n,t,i),this._checkTextureLoaded(),Ge.CLEANUP_IMAGE_CACHE)){const t=gm.getDeps(this._uuid),i=t.indexOf(e._uuid);-1!==i&&(V(t,i),e.decRef())}}_checkTextureLoaded(){this._textureReady()}_textureReady(){this.loaded=!0,this.emit("load")}_setMipmapLevel(e){this._mipmapLevel=e<1?1:e}_getGfxTextureCreateInfo(e){return null}_tryReset(){if(this._tryDestroyTexture(),0===this._mipmapLevel)return;const e=this._getGFXDevice();e&&this._createTexture(e)}_createTexture(e){if(0===this._width||0===this._height)return;let t=js.NONE;this._mipFilter!==zf.NONE&&function(e,t,i){return!(e.gfxAPI===Os.WEBGL)||ym(t)&&ym(i)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){let i=Math.max(e,t),n=0;for(;i;)i>>=1,n++;return n}(this._width,this._height),t=js.GEN_MIPMAP);const i=this._getGfxTextureCreateInfo({usage:Vs.SAMPLED|Vs.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t|js.IMMUTABLE});if(!i)return;const n=e.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n}_tryDestroyTexture(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}})||mm;var Sm,bm,Tm,Em,Cm;n.SimpleTexture=xm;let wm=e("Texture2D",(Sm=Wc("cc.Texture2D"),bm=Al([Wf]),Sm((Cm=Oc((Em=class extends xm{constructor(...e){super(...e),Mc(this,"_mipmaps",Cm,this)}get mipmaps(){return this._mipmaps}set mipmaps(e){if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const e=this._mipmaps[0];this.reset({width:e.width,height:e.height,format:e.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(((e,t)=>{this._assignImage(e,t)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(e){this.mipmaps=e?[e]:[]}initialize(){this.mipmaps=this._mipmaps}onLoaded(){this.initialize()}reset(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}create(e,t,i=Lf.RGBA8888,n=1){this.reset({width:e,height:t,format:i,mipmapLevel:n})}toString(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}updateMipmaps(e=0,t){if(e>=this._mipmaps.length)return;const i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e);for(let t=0;t<i;++t){const i=e+t;this._assignImage(this._mipmaps[i],i)}}getHtmlElementObj(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}destroy(){return this._mipmaps=[],super.destroy()}description(){return`<cc.Texture2D | Name = ${this._mipmaps[0]?this._mipmaps[0].url:""} | Dimension = ${this.width} x ${this.height}>`}releaseTexture(){this.destroy()}_serialize(e){return null}_deserialize(e,t){const i=e;super._deserialize(i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(let e=0;e<i.mipmaps.length;++e){if(this._mipmaps[e]=new Wf,!i.mipmaps[e])continue;const n=i.mipmaps[e];t.result.push(this._mipmaps,`${e}`,n,De._getClassId(Wf))}}_getGfxTextureCreateInfo(e){const t=new Lo(Hs.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)}initDefault(e){super.initDefault(e);const t=new Wf;t.initDefault(),this.image=t}validate(){return this.mipmaps&&0!==this.mipmaps.length}}).prototype,"_mipmaps",[bm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tm=Em))||Tm));var Am,Pm,Rm,Im,Mm,Om,Dm;n.Texture2D=wm,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Dm||(Dm={}));let Nm=e("TextureCube",Wc("cc.TextureCube")((Om=Mm=class e extends xm{constructor(...e){super(...e),Mc(this,"isRGBE",Rm,this),Mc(this,"_mipmaps",Im,this)}get mipmaps(){return this._mipmaps}set mipmaps(e){if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const e=this._mipmaps[0].front;this.reset({width:e.width,height:e.height,format:e.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(((e,t)=>{Lm(e,((e,i)=>{this._assignImage(e,t,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(e){this.mipmaps=e?[e]:[]}static fromTexture2DArray(t,i){const n=[],s=t.length/6;for(let e=0;e<s;e++){const i=6*e;n.push({front:t[i+Dm.front].image,back:t[i+Dm.back].image,left:t[i+Dm.left].image,right:t[i+Dm.right].image,top:t[i+Dm.top].image,bottom:t[i+Dm.bottom].image})}return(i=i||new e).mipmaps=n,i}onLoaded(){this.mipmaps=this._mipmaps}reset(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}updateMipmaps(e=0,t){if(e>=this._mipmaps.length)return;const i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e);for(let t=0;t<i;++t){const i=e+t;Lm(this._mipmaps[i],((e,t)=>{this._assignImage(e,i,t)}))}}destroy(){return this._mipmaps=[],super.destroy()}releaseTexture(){this.mipmaps=[]}_serialize(e){return null}_deserialize(e,t){const i=e;super._deserialize(i.base,t),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(let e=0;e<i.mipmaps.length;++e){this._mipmaps[e]={front:new Wf,back:new Wf,left:new Wf,right:new Wf,top:new Wf,bottom:new Wf};const n=i.mipmaps[e],s=De._getClassId(Wf);t.result.push(this._mipmaps[e],"front",n.front,s),t.result.push(this._mipmaps[e],"back",n.back,s),t.result.push(this._mipmaps[e],"left",n.left,s),t.result.push(this._mipmaps[e],"right",n.right,s),t.result.push(this._mipmaps[e],"top",n.top,s),t.result.push(this._mipmaps[e],"bottom",n.bottom,s)}}_getGfxTextureCreateInfo(e){const t=new Lo(Hs.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t}initDefault(e){super.initDefault(e);const t=new Wf;t.initDefault(),this.mipmaps=[{front:t,back:t,top:t,bottom:t,left:t,right:t}]}validate(){return 0!==this._mipmaps.length&&!this._mipmaps.find((e=>!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)))}},Mm.FaceIndex=Dm,Rm=Oc((Pm=Om).prototype,"isRGBE",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Im=Oc(Pm.prototype,"_mipmaps",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Am=Pm))||Am);function Lm(e,t){t(e.front,Dm.front),t(e.back,Dm.back),t(e.left,Dm.left),t(e.right,Dm.right),t(e.top,Dm.top),t(e.bottom,Dm.bottom)}n.TextureCube=Nm;const Bm=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:308883658,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:50,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0}]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:3113634185,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3001336778,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2637621064,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:1675533382,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:1867464226,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color2",type:16,count:1,defines:["TWO_COLORED"],stageFlags:1,format:44,location:3}]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1559944983,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:3247695832,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:220,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:63},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"miscParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1783225275,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:63},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"miscParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3600213289,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:67,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:58},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3278422876,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:65,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:1017648509,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:195,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3555385669,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:56},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_gbuffer_albedoMap",defines:[]},{name:"cc_gbuffer_positionMap",defines:[]},{name:"cc_gbuffer_normalMap",defines:[]},{name:"cc_gbuffer_emissiveMap",defines:[]}]},locals:{blocks:[{name:"CCForwardLight",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:1115292548,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:213,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:56},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:1780456825,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:145,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_lighting_resultMap",defines:[]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7}]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:3169038185,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:3552712539,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:58,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},precent:{value:[.5],type:13,handleInfo:["u_buffer0",2,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,.5,0]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:1349506124,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),zm=4026531840,Fm=264241152,Um=3145728,Gm=1032192;let km;!function(e){e[e.BUFFER=0]="BUFFER",e[e.TEXTURE=1]="TEXTURE"}(km||(km={}));const Hm=(e,t,i,n,s=0)=>e<<28&zm|n<<22&Fm|t<<20&Um|i<<14&Gm|16383&s,Vm=e=>(e&zm)>>>28,jm=e=>(e&Fm)>>>22,Wm=e=>(e&Gm)>>>14,qm=e=>16383&e,Xm=(e,t)=>e&~Fm|t<<22&Fm,Ym={[zs.UNKNOWN]:()=>console.warn("illegal uniform handle"),[zs.INT]:(e,t,i=0)=>e[i],[zs.INT2]:(e,t,i=0)=>nn.fromArray(t,e,i),[zs.INT3]:(e,t,i=0)=>zi.fromArray(t,e,i),[zs.INT4]:(e,t,i=0)=>an.fromArray(t,e,i),[zs.FLOAT]:(e,t,i=0)=>e[i],[zs.FLOAT2]:(e,t,i=0)=>nn.fromArray(t,e,i),[zs.FLOAT3]:(e,t,i=0)=>zi.fromArray(t,e,i),[zs.FLOAT4]:(e,t,i=0)=>an.fromArray(t,e,i),[zs.MAT3]:(e,t,i=0)=>ki.fromArray(t,e,i),[zs.MAT4]:(e,t,i=0)=>Zi.fromArray(t,e,i)},Km={[zs.UNKNOWN]:()=>console.warn("illegal uniform handle"),[zs.INT]:(e,t,i=0)=>e[i]=t,[zs.INT2]:(e,t,i=0)=>nn.toArray(e,t,i),[zs.INT3]:(e,t,i=0)=>zi.toArray(e,t,i),[zs.INT4]:(e,t,i=0)=>an.toArray(e,t,i),[zs.FLOAT]:(e,t,i=0)=>e[i]=t,[zs.FLOAT2]:(e,t,i=0)=>nn.toArray(e,t,i),[zs.FLOAT3]:(e,t,i=0)=>zi.toArray(e,t,i),[zs.FLOAT4]:(e,t,i=0)=>an.toArray(e,t,i),[zs.MAT3]:(e,t,i=0)=>ki.toArray(e,t,i),[zs.MAT4]:(e,t,i=0)=>Zi.toArray(e,t,i)},$m=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Qm(e){switch(e){case zs.BOOL:case zs.INT:case zs.UINT:case zs.FLOAT:return $m[0];case zs.BOOL2:case zs.INT2:case zs.UINT2:case zs.FLOAT2:return $m[1];case zs.BOOL4:case zs.INT4:case zs.UINT4:case zs.FLOAT4:return $m[2];case zs.MAT4:return $m[3];case zs.SAMPLER2D:return"default-texture";case zs.SAMPLER_CUBE:return"default-cube-texture"}return $m[0]}function Zm(e,t){const i=Object.entries(t);let n=!1;for(let t=0;t<i.length;t++)e[i[t][0]]!==i[t][1]&&(e[i[t][0]]=i[t][1],n=!0);return n}const Jm=new rr;function eg(e){return Math.ceil(Math.log2(Math.max(e,2)))}function tg(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn(`unknown define type '${e.type}'`),"-1"}}function ig(e,t,i,n,s){const o=e.builtins[n],r=[];for(let e=0;e<o.blocks.length;e++){const t=o.blocks[e],n=i.layouts[t.name],a=n&&i.bindings.find((e=>e.binding===n.binding));n&&a&&a.descriptorType&yr?(r.push(n),s&&!s.includes(a)&&s.push(a)):console.warn(`builtin UBO '${t.name}' not available!`)}Array.prototype.unshift.apply(t.gfxBlocks,r);const a=[];for(let e=0;e<o.samplerTextures.length;e++){const t=o.samplerTextures[e],n=i.layouts[t.name],r=n&&i.bindings.find((e=>e.binding===n.binding));n&&r&&r.descriptorType&xr?(a.push(n),s&&!s.includes(r)&&s.push(r)):console.warn(`builtin samplerTexture '${t.name}' not available!`)}Array.prototype.unshift.apply(t.gfxSamplerTextures,a),s&&s.sort(((e,t)=>e.binding-t.binding))}function ng(e){return e.members.reduce(((e,t)=>e+Ar(t.type)*t.count),0)}function sg(e,t){for(let i=0;i<e.length;i++){const n=e[i];if("!"===n[0]){if(t[n.slice(1)])return!1}else if(!t[n])return!1}return!0}function og(e){switch(e.gfxAPI){case Os.GLES2:case Os.WEBGL:return"glsl1";case Os.GLES3:case Os.WEBGL2:return"glsl3";default:return"glsl4"}}const rg=new class{constructor(){this._templates={},this._cache={},this._templateInfos={}}register(e){for(let t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name}define(e){const t=this._templates[e.name];if(t&&t.hash===e.hash)return t;const i={...e};let n=0;for(let e=0;e<i.defines.length;e++){const t=i.defines[e];let s=1;if("number"===t.type){const e=t.range;s=eg(e[1]-e[0]+1),t._map=t=>t-e[0]}else"string"===t.type?(s=eg(t.options.length),t._map=e=>Math.max(0,t.options.findIndex((t=>t===e)))):"boolean"===t.type&&(t._map=e=>e?1:0);t._offset=n,n+=s}n>31&&(i.uber=!0),i.constantMacros="";for(const e in i.builtins.statistics)i.constantMacros+=`#define ${e} ${i.builtins.statistics[e]}\n`;if(this._templates[e.name]=i,!this._templateInfos[i.hash]){const e={};e.samplerStartBinding=i.blocks.length,e.gfxBlocks=[],e.gfxSamplerTextures=[],e.bindings=[],e.blockSizes=[];for(let t=0;t<i.blocks.length;t++){const n=i.blocks[t];e.blockSizes.push(ng(n)),e.bindings.push(new or(n.binding,n.descriptorType||uo.UNIFORM_BUFFER,1,n.stageFlags)),e.gfxBlocks.push(new Uo(pd.MATERIAL,n.binding,n.name,n.members.map((e=>new Fo(e.name,e.type,e.count))),1))}for(let t=0;t<i.samplerTextures.length;t++){const n=i.samplerTextures[t];e.bindings.push(new or(n.binding,n.descriptorType||uo.SAMPLER_TEXTURE,n.count,n.stageFlags)),e.gfxSamplerTextures.push(new Go(pd.MATERIAL,n.binding,n.name,n.type,n.count))}e.gfxAttributes=[];for(let t=0;t<i.attributes.length;t++){const n=i.attributes[t];e.gfxAttributes.push(new Xo(n.name,n.format,n.isNormalized,0,n.isInstanced,n.location))}ig(i,e,rd,"locals"),e.gfxStages=[],e.gfxStages.push(new qo(Js.VERTEX,"")),e.gfxStages.push(new qo(Js.FRAGMENT,"")),e.handleMap=function(e){const t={};for(let i=0;i<e.blocks.length;i++){const n=e.blocks[i],s=n.members;let o=0;for(let e=0;e<s.length;e++){const i=s[e];t[i.name]=Hm(km.BUFFER,pd.MATERIAL,n.binding,i.type,o),o+=(Ar(i.type)>>2)*i.count}}for(let i=0;i<e.samplerTextures.length;i++){const n=e.samplerTextures[i];t[n.name]=Hm(km.TEXTURE,pd.MATERIAL,n.binding,n.type)}return t}(i),e.setLayouts=[],this._templateInfos[i.hash]=e}return i}getTemplate(e){return this._templates[e]}getTemplateInfo(e){const t=this._templates[e].hash;return this._templateInfos[t]}getDescriptorSetLayout(e,t,i=!1){const n=this._templates[t],s=this._templateInfos[n.hash];return s.setLayouts.length||(Jm.bindings=s.bindings,s.setLayouts[pd.MATERIAL]=e.createDescriptorSetLayout(Jm),Jm.bindings=rd.bindings,s.setLayouts[pd.LOCAL]=e.createDescriptorSetLayout(Jm)),s.setLayouts[i?pd.LOCAL:pd.MATERIAL]}hasProgram(e){return void 0!==this._templates[e]}getKey(e,t){const i=this._templates[e],n=i.defines;if(i.uber){let e="";for(let i=0;i<n.length;i++){const s=n[i],o=t[s.name];if(!o||!s._map)continue;const r=s._map(o);e+=`${s._offset}${r}|`}return`${e}${i.hash}`}let s=0;for(let e=0;e<n.length;e++){const i=n[e],o=t[i.name];o&&i._map&&(s|=i._map(o)<<i._offset)}return`${s.toString(16)}|${i.hash}`}destroyShaderByDefines(e){const t=Object.keys(e);if(!t.length)return;const i=t.map((t=>{let i=e[t];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(`${t}${i}`)})),n=Object.keys(this._cache).filter((e=>i.every((t=>t.test(this._cache[e].name)))));for(let e=0;e<n.length;e++){const t=n[e],i=this._cache[t];m(`destroyed shader ${i.name}`),i.destroy(),delete this._cache[t]}}getGFXShader(e,t,i,n,s){Object.assign(i,n.macros),s||(s=this.getKey(t,i));const o=this._cache[s];if(o)return o;const r=this._templates[t],a=this._templateInfos[r.hash];a.pipelineLayout||(this.getDescriptorSetLayout(e,t),ig(r,a,od,"globals"),a.setLayouts[pd.GLOBAL]=n.descriptorSetLayout,a.pipelineLayout=e.createPipelineLayout(new cr(a.setLayouts)));const c=function(e,t){const i=[];for(let n=0;n<t.length;n++){const s=t[n],o=s.name,r=e[o],a=tg(s,r),c=!r||"0"===r;i.push({name:o,value:a,isDefault:c})}return i}(i,r.defines),l=n.constantMacros+r.constantMacros+c.reduce(((e,t)=>`${e}#define ${t.name} ${t.value}\n`),"");let h=r.glsl3;const u=og(e);u?h=r[u]:console.error("Invalid GFX API!"),a.gfxStages[0].source=l+h.vert,a.gfxStages[1].source=l+h.frag;const _=function(e,t,i){const n=[],s=e.attributes,o=t.gfxAttributes;for(let e=0;e<s.length;e++)sg(s[e].defines,i)&&n.push(o[e]);return n}(r,a,i),p=function(e,t){return e+t.reduce(((e,t)=>t.isDefault?e:`${e}|${t.name}${t.value}`),"")}(t,c),d=new Yo(p,a.gfxStages,_,a.gfxBlocks);return d.samplerTextures=a.gfxSamplerTextures,this._cache[s]=e.createShader(d)}};n.programLib=rg;const ag={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 toQuat(vec3 rotation) {\nvec3 rotTmp = rotation;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\nreturn rot;\n}\nmat3 QuatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 Mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 EulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\nvec4 rot = toQuat(startRotation);\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 miscParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * miscParams.x) * normalize(v_tangent) +\n(nmmp.y * miscParams.x) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.w;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture2D(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture2D(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture2D(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture2D(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\ngl_FragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nvarying vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 toQuat(vec3 rotation) {\nvec3 rotTmp = rotation;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\nreturn rot;\n}\nmat3 QuatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 Mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 EulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\nvec4 rot = toQuat(startRotation);\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nin float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * miscParams.x) * normalize(v_tangent) +\n(nmmp.y * miscParams.x) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.w;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin float v_fog_factor;\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nin vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout float v_percent;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nin float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]],glsl4:[[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(location = 0) in vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord;\nlayout(location = 7) in vec3 a_texCoord3;\nlayout(location = 8) in vec3 a_normal;\nlayout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\nlayout(set = 1, binding = 3) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\nlayout(set = 1, binding = 4) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\nlayout(set = 1, binding = 5) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\nlayout(set = 1, binding = 6) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\nlayout(set = 1, binding = 7) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nlayout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\nlayout(set = 1, binding = 8) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 toQuat(vec3 rotation) {\nvec3 rotTmp = rotation;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\nreturn rot;\n}\nmat3 QuatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 Mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 EulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\nvec4 rot = toQuat(startRotation);\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) in vec3 vBarycentric;\n#endif\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\nlayout(location = 8) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord3;\nlayout(location = 7) in vec3 a_normal;\nlayout(location = 8) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 v_light;\nlayout(location = 1) out vec2 uv0;\n#if TWO_COLORED\nlayout(location = 3) in vec4 a_color2;\nlayout(location = 2) out vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 v_light;\n#if TWO_COLORED\nlayout(location = 2) in vec4 v_dark;\n#endif\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nlayout(location = 13) in vec4 a_color;\nlayout(location = 2) out vec4 v_color;\n#endif\nlayout(location = 3) out vec3 v_position;\nlayout(location = 4) out vec3 v_normal;\nlayout(location = 5) out vec2 v_uv;\nlayout(location = 6) out vec2 v_uv1;\n#if USE_NORMAL_MAP\nlayout(location = 7) out vec3 v_tangent;\nlayout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nlayout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) out vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(location = 0) in float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) in vec3 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nlayout(location = 3) in vec3 v_position;\nlayout(location = 5) in vec2 v_uv;\nlayout(location = 6) in vec2 v_uv1;\nlayout(location = 4) in vec3 v_normal;\n#if USE_VERTEX_COLOR\nlayout(location = 2) in vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nlayout(location = 7) in vec3 v_tangent;\nlayout(location = 8) in vec3 v_bitangent;\nlayout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nlayout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nlayout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nlayout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nlayout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * miscParams.x) * normalize(v_tangent) +\n(nmmp.y * miscParams.x) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.w;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nlayout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out vec4 v_worldPos;\nlayout(location = 3) out float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in vec4 v_worldPos;\nlayout(location = 3) in float v_clip_depth;\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 2) out highp vec3 v_position;\nlayout(location = 3) out mediump vec3 v_normal;\n#if USE_NORMALMAP\nlayout(location = 4) out mediump vec3 v_tangent;\nlayout(location = 5) out mediump vec3 v_binormal;\n#endif\nlayout(location = 6) out mediump vec2 uvw;\nlayout(location = 7) out mediump vec2 uv0;\nlayout(location = 8) out mediump vec2 uv1;\nlayout(location = 9) out mediump vec2 uv2;\nlayout(location = 10) out mediump vec2 uv3;\nlayout(location = 11) out mediump vec3 luv;\nlayout(location = 12) out mediump vec3 diffuse;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 0) in float v_fog_factor;\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 13) in vec3 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nlayout(location = 2) in highp vec3 v_position;\nlayout(location = 3) in mediump vec3 v_normal;\n#if USE_NORMALMAP\nlayout(location = 4) in mediump vec3 v_tangent;\nlayout(location = 5) in mediump vec3 v_binormal;\n#endif\nlayout(location = 6) in mediump vec2 uvw;\nlayout(location = 7) in mediump vec2 uv0;\nlayout(location = 8) in mediump vec2 uv1;\nlayout(location = 9) in mediump vec2 uv2;\nlayout(location = 10) in mediump vec2 uv3;\nlayout(location = 12) in mediump vec3 diffuse;\nlayout(location = 11) in mediump vec3 luv;\nlayout(set = 1, binding = 1) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nlayout(set = 1, binding = 2) uniform sampler2D weightMap;\nlayout(set = 1, binding = 3) uniform sampler2D detailMap0;\nlayout(set = 1, binding = 4) uniform sampler2D detailMap1;\nlayout(set = 1, binding = 5) uniform sampler2D detailMap2;\nlayout(set = 1, binding = 6) uniform sampler2D detailMap3;\nlayout(set = 1, binding = 7) uniform sampler2D normalMap0;\nlayout(set = 1, binding = 8) uniform sampler2D normalMap1;\nlayout(set = 1, binding = 9) uniform sampler2D normalMap2;\nlayout(set = 1, binding = 10) uniform sampler2D normalMap3;\nlayout(set = 1, binding = 11) uniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(location = 0) in vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\n#if USE_VERTEX_COLOR\nlayout(location = 13) in lowp vec4 a_color;\nlayout(location = 1) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nlayout(location = 2) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nlayout(location = 2) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nlayout(location = 1) in lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout (set = 0, binding = 6) uniform sampler2D cc_gbuffer_albedoMap;\nlayout (set = 0, binding = 7) uniform sampler2D cc_gbuffer_positionMap;\nlayout (set = 0, binding = 8) uniform sampler2D cc_gbuffer_normalMap;\nlayout (set = 0, binding = 9) uniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout (set = 0, binding = 10) uniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out float v_percent;\nlayout(set = 1, binding = 0) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in float v_percent;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},cg=e("builtinResMgr",n.builtinResMgr=new class{constructor(){this._device=null,this._resources={}}initBuiltinRes(e){this._device=e;const t=this._resources,i=document.createElement("canvas"),s=i.getContext("2d"),o=new Wf(i),r=i.width=i.height=2;s.fillStyle="#000",s.fillRect(0,0,r,r);const a=new wm;a._uuid="black-texture",a.image=o,t[a._uuid]=a,s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,r,r);const c=new wm;c._uuid="empty-texture",c.image=o,t[c._uuid]=c;const l=new Nm;l._uuid="black-cube-texture",l.setMipFilter(Nm.Filter.NEAREST),l.image={front:new Wf(i),back:new Wf(i),left:new Wf(i),right:new Wf(i),top:new Wf(i),bottom:new Wf(i)},t[l._uuid]=l,s.fillStyle="#777",s.fillRect(0,0,r,r);const h=new wm;h._uuid="grey-texture",h.image=o,t[h._uuid]=h,s.fillStyle="#fff",s.fillRect(0,0,r,r);const u=new wm;u._uuid="white-texture",u.image=o,t[u._uuid]=u;const _=new Nm;_._uuid="white-cube-texture",_.setMipFilter(Nm.Filter.NEAREST),_.image={front:new Wf(i),back:new Wf(i),left:new Wf(i),right:new Wf(i),top:new Wf(i),bottom:new Wf(i)},t[_._uuid]=_,s.fillStyle="#7f7fff",s.fillRect(0,0,r,r);const p=new wm;p._uuid="normal-texture",p.image=o,t[p._uuid]=p,i.width=i.height=16,s.fillStyle="#ddd",s.fillRect(0,0,16,16),s.fillStyle="#555",s.fillRect(0,0,8,8),s.fillStyle="#555",s.fillRect(8,8,8,8);const d=new wm;d._uuid="default-texture",d.image=o,t[d._uuid]=d;const f=new Nm;if(f.setMipFilter(Nm.Filter.NEAREST),f._uuid="default-cube-texture",f.image={front:new Wf(i),back:new Wf(i),left:new Wf(i),right:new Wf(i),top:new Wf(i),bottom:new Wf(i)},t[f._uuid]=f,n.SpriteFrame){const e=new n.SpriteFrame,i=o,s=new wm;s.image=i,e.texture=s,e._uuid="default-spriteframe",t[e._uuid]=e}const m=og(e);if(!m)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));const g=ag[m];return g?Promise.resolve().then((()=>{Bm.forEach(((e,t)=>{const i=Object.assign(new n.EffectAsset,e);i.shaders.forEach(((e,i)=>{const n=g[t][i];n&&(e[m]=n)})),i.hideInEditor=!0,i.onLoaded()})),this._initMaterials()})):Promise.reject(Error(`Current device is requiring builtin shaders of version ${m} but shaders of that version are not assembled in this build.`))}get(e){return this._resources[e]}_initMaterials(){const e=this._resources,t=[],i=new n.Material;i._uuid="standard-material",i.initialize({effectName:"standard"}),e[i._uuid]=i,t.push(i);const s=new n.Material;s._uuid="missing-effect-material",s.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),s.setProperty("mainColor",n.color("#ffff00")),e[s._uuid]=s,t.push(s);const o=new n.Material;o._uuid="missing-material",o.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),o.setProperty("mainColor",n.color("#ff00ff")),e[o._uuid]=o,t.push(o);const r=new n.Material;r._uuid="default-clear-stencil",r.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[r._uuid]=r,t.push(r);const a=new n.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[a._uuid]=a,t.push(a);const c=new n.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);const l=new n.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[l._uuid]=l,t.push(l);const h=new n.Material;h._uuid="ui-sprite-gray-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[h._uuid]=h,t.push(h);const u=new n.Material;u._uuid="ui-sprite-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[u._uuid]=u,t.push(u);const _=new n.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_,t.push(_);const p=new n.Material;p._uuid="ui-graphics-material",p.initialize({effectName:"graphics"}),e[p._uuid]=p,t.push(p);const d=new n.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),e[d._uuid]=d,t.push(d);const f=new n.Material;f._uuid="default-particle-gpu-material",f.initialize({effectName:"particle-gpu"}),e[f._uuid]=f,t.push(f);const m=new n.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);const g=new n.Material;g._uuid="default-billboard-material",g.initialize({effectName:"billboard"}),e[g._uuid]=g,t.push(g);const v=new n.Material;v._uuid="default-spine-material",v.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[v._uuid]=v,t.push(v),n.game.on(n.Game.EVENT_GAME_INITED,(()=>{for(let e=0;e<t.length;++e){const i=t[e];for(let e=0;e<i.passes.length;++e)i.passes[e].tryCompile()}}))}}),lg=(()=>{const e=new Map;let t=0;return i=>"number"==typeof i?i:(e.has(i)||(e.set(i,1<<t),t++),e.get(i))})(),hg=new Io(Fs.UNIFORM|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE),ug=new Mo(null),_g=new ar(null);let pg;!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(pg||(pg={}));class dg{static fillPipelineInfo(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(lg(t.phase));const i=e._bs;if(t.blendState){const e=t.blendState,{targets:n}=e;n&&n.forEach(((e,t)=>{i.setTarget(t,e)})),void 0!==e.isA2C&&(i.isA2C=e.isA2C),void 0!==e.isIndepend&&(i.isIndepend=e.isIndepend),void 0!==e.blendColor&&(i.blendColor=e.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)}static getPassHash(e){let t=`${rg.getKey(e.program,e.defines)},${e._primitive},${e._dynamicStates}`;var i;return t+=function(e){let t=`,bs,${e.isA2C}`;for(const i of e.targets)t+=`,bt,${i.blend},${i.blendEq},${i.blendAlphaEq},${i.blendColorMask}`,t+=`,${i.blendSrc},${i.blendDst},${i.blendSrcAlpha},${i.blendDstAlpha}`;return t}(e._bs),t+=function(e){let t=`,dss,${e.depthTest},${e.depthWrite},${e.depthFunc}`;return t+=`,${e.stencilTestFront},${e.stencilFuncFront},${e.stencilRefFront},${e.stencilReadMaskFront}`,t+=`,${e.stencilFailOpFront},${e.stencilZFailOpFront},${e.stencilPassOpFront},${e.stencilWriteMaskFront}`,t+=`,${e.stencilTestBack},${e.stencilFuncBack},${e.stencilRefBack},${e.stencilReadMaskBack}`,t+=`,${e.stencilFailOpBack},${e.stencilZFailOpBack},${e.stencilPassOpBack},${e.stencilWriteMaskBack}`,t}(e._dss),t+=`,rs,${(i=e._rs).cullMode},${i.depthBias},${i.isFrontFaceCCW}`,Vr(t,666)}get native(){return this._nativeObj}constructor(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new na,this._dss=new oa,this._rs=new sa,this._priority=sd.DEFAULT,this._stage=nd.DEFAULT,this._phase=lg("default"),this._primitive=oo.TRIANGLE_LIST,this._batchingScheme=pg.NONE,this._dynamicStates=lo.NONE,this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}initialize(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()}getHandle(e,t=0,i=zs.UNKNOWN){let n=this._propertyHandleMap[e];return n?(i?n=Xm(n,i):t&&(n=Xm(n,jm(n)-t)),n+t):0}getBinding(e){const t=this.getHandle(e);return t?dg.getBindingFromHandle(t):-1}setUniform(e,t){const i=dg.getBindingFromHandle(e),n=dg.getTypeFromHandle(e),s=dg.getOffsetFromHandle(e),o=this._blocks[i];Km[n](o,t,s),this._setRootBufferDirty(!0)}getUniform(e,t){const i=dg.getBindingFromHandle(e),n=dg.getTypeFromHandle(e),s=dg.getOffsetFromHandle(e),o=this._blocks[i];return Ym[n](o,t,s)}setUniformArray(e,t){const i=dg.getBindingFromHandle(e),n=dg.getTypeFromHandle(e),s=Ar(n)>>2,o=this._blocks[i];let r=dg.getOffsetFromHandle(e);for(let e=0;e<t.length;e++,r+=s)null!==t[e]&&Km[n](o,t[e],r);this._setRootBufferDirty(!0)}bindTexture(e,t,i){this._descriptorSet.bindTexture(e,t,i||0)}bindSampler(e,t,i){this._descriptorSet.bindSampler(e,t,i||0)}setDynamicState(e,t){const i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}overridePipelineStates(e,t){console.warn("base pass cannot override states, please use pass instance instead.")}_setRootBufferDirty(e){this._rootBufferDirty=e,this._nativeObj.setRootBufferDirty(e)}update(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update(),this._nativeObj.update()):C(12006)}_initNative(){this._nativeObj||(this._nativeObj=new es,this._passHandle=lc.alloc(),this._nativePriority=lc.getTypedArray(this._passHandle,rc.PRIORITY),this._nativeStage=lc.getTypedArray(this._passHandle,rc.STAGE),this._nativePhase=lc.getTypedArray(this._passHandle,rc.PHASE),this._nativePrimitive=lc.getTypedArray(this._passHandle,rc.PRIMITIVE),this._nativeBatchingScheme=lc.getTypedArray(this._passHandle,rc.BATCHING_SCHEME),this._nativeDynamicStates=lc.getTypedArray(this._passHandle,rc.DYNAMIC_STATE),this._nativeHash=lc.getTypedArray(this._passHandle,rc.HASH),this._nativeObj.initWithData(lc.getBuffer(this._passHandle)))}_destroy(){this._nativeObj=null,this._passHandle&&lc.free(this._passHandle)}destroy(){for(let e=0;e<this._shaderInfo.blocks.length;e++){const t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()}resetUniform(e){const t=this.getHandle(e);if(!t)return;const i=dg.getTypeFromHandle(t),n=dg.getBindingFromHandle(t),s=dg.getOffsetFromHandle(t),o=this._blocks[n],r=this._properties[e],a=r&&r.value||Qm(i);Km[i](o,a,s),this._setRootBufferDirty(!0)}resetTexture(e,t){const i=this.getHandle(e);if(!i)return;const n=dg.getTypeFromHandle(i),s=dg.getBindingFromHandle(i),o=this._properties[e],r=o&&o.value,a=r?`${r}-texture`:Qm(n),c=cg.get(a),l=c&&c.getGFXTexture(),h=o&&void 0!==o.samplerHash?o.samplerHash:c&&c.getSamplerHash(),u=Qf.getSampler(this._device,h);this._descriptorSet.bindSampler(s,u,t),this._descriptorSet.bindTexture(s,l,t)}resetUBOs(){for(let e=0;e<this._shaderInfo.blocks.length;e++){const t=this._shaderInfo.blocks[e],i=this._blocks[t.binding];let n=0;for(let e=0;e<t.members.length;e++){const s=t.members[e],o=this._properties[s.name],r=o&&o.value||Qm(s.type),a=(Ar(s.type)>>2)*s.count;for(let e=0;e+r.length<=a;e+=r.length)i.set(r,n+e);n+=a}}this._setRootBufferDirty(!0)}resetTextures(){for(let e=0;e<this._shaderInfo.samplerTextures.length;e++){const t=this._shaderInfo.samplerTextures[e];for(let e=0;e<t.count;e++)this.resetTexture(t.name,e)}}tryCompile(){const{pipeline:e}=this._root;if(!e)return!1;this._syncBatchingScheme();const t=rg.getGFXShader(this._device,this._programName,this._defines,e);return t?(this._shader=t,this._setPipelineLayout(rg.getTemplateInfo(this._programName).pipelineLayout),this._setHash(dg.getPassHash(this)),!0):(console.warn(`create shader ${this._programName} failed`),!1)}getShaderVariant(e=null){if(!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;const{pipeline:t}=this._root;for(let t=0;t<e.length;t++){const i=e[t];this._defines[i.name]=i.value}const i=rg.getGFXShader(this._device,this._programName,this._defines,t);for(let t=0;t<e.length;t++){const i=e[t];delete this._defines[i.name]}return i}beginChangeStatesSilently(){}endChangeStatesSilently(){}_setPriority(e){this._priority=e,this._nativePriority[0]=e}_setStage(e){this._stage=e,this._nativeStage[0]=e}_setPhase(e){this._phase=e,this._nativePhase[0]=e}_setPrimitive(e){this._primitive=e,this._nativePrimitive[0]=e}_setState(e,t,i,n){this._bs=e,this._dss=t,this._rs=i,this._descriptorSet=n,this._nativeObj.blendState=e.native,this._nativeObj.depthStencilState=t.native,this._nativeObj.rasterizerState=i.native,this._nativeObj.descriptorSet=n}_doInit(e,t=!1){this._initNative(),this._setPriority(sd.DEFAULT),this._setStage(nd.DEFAULT),this._setPhase(lg("default")),this._setPrimitive(oo.TRIANGLE_LIST),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=t?{...e.defines}:e.defines,this._shaderInfo=rg.getTemplate(e.program),this._properties=e.properties||this._properties;const i=this._device;dg.fillPipelineInfo(this,e),e.stateOverrides&&dg.fillPipelineInfo(this,e.stateOverrides),_g.layout=rg.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(_g),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);const n=this._shaderInfo.blocks,s=rg.getTemplateInfo(e.program),{blockSizes:o,handleMap:r}=s,a=i.capabilities.uboOffsetAlignment,c=[];let l=0,h=0;for(let e=0;e<n.length;e++){const t=o[e];c.push(h),h+=Math.ceil(t/a)*a,l=t}const u=c[c.length-1]+l;u&&(hg.size=16*Math.ceil(u/16),this._rootBuffer=i.createBuffer(hg),this._rootBlock=new ArrayBuffer(u),this._nativeObj.setRootBufferAndBlock(this._rootBuffer,this._rootBlock));for(let e=0,t=0;e<n.length;e++){const{binding:s}=n[e],r=o[e];ug.buffer=this._rootBuffer,ug.offset=c[t++],ug.range=16*Math.ceil(r/16);const a=this._buffers[s]=i.createBuffer(ug);this._blocks[s]=new Float32Array(this._rootBlock,ug.offset,r/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(s,a)}const _=this._propertyHandleMap=r,p={};for(const e in this._properties){const t=this._properties[e];t.handleInfo&&(p[e]=this.getHandle.apply(this,t.handleInfo))}Object.assign(_,p)}_syncBatchingScheme(){this._defines.USE_INSTANCING?this._device.hasFeature(Ns.INSTANCED_ARRAYS)?this._setBatchingScheme(pg.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(pg.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(pg.VB_MERGING):this._setBatchingScheme(pg.NONE)}_setBatchingScheme(e){this._batchingScheme=e,this._nativeBatchingScheme[0]=e}_setDynamicState(e){this._dynamicStates=e,this._nativeDynamicStates[0]=e}_setHash(e){this._hash=e,this._nativeHash[0]=e}_setPipelineLayout(e){this._pipelineLayout=e,this._nativeObj.setPipelineLayout(e)}_initPassFromTarget(e,t,i,n){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(i,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(rg.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^n)}get root(){return this._root}get device(){return this._device}get shaderInfo(){return this._shaderInfo}get localSetLayout(){return rg.getDescriptorSetLayout(this._device,this._programName,!0)}get program(){return this._programName}get properties(){return this._properties}get defines(){return this._defines}get passIndex(){return this._passIndex}get propertyIndex(){return this._propertyIndex}get dynamics(){return this._dynamics}get blocks(){return this._blocks}get rootBufferDirty(){return this._rootBufferDirty}get priority(){return this._priority}get primitive(){return this._primitive}get stage(){return this._stage}get phase(){return this._phase}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get dynamicStates(){return this._dynamicStates}get batchingScheme(){return this._batchingScheme}get descriptorSet(){return this._descriptorSet}get hash(){return this._hash}get pipelineLayout(){return this._pipelineLayout}}dg.PropertyType=km,dg.getPropertyTypeFromHandle=Vm,dg.getTypeFromHandle=jm,dg.getBindingFromHandle=Wm,dg.getOffsetFromHandle=qm;const fg=new ar(null);class mg{constructor(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=sd.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}_destroyDescriptorSet(){this._descriptorSet.destroy(),this._nativeObj.setDescriptorSet(null),this._descriptorSet=null}_destroyInputAssembler(){this._inputAssembler.destroy(),this._nativeObj.setInputAssembler(null),this._inputAssembler=null}_createDescriptorSet(e){this._descriptorSet=this._device.createDescriptorSet(e),this._nativeObj.setDescriptorSet(this._descriptorSet)}set passes(e){e.length>8?C(12004,8):(this._passes=e,this._flushPassInfo(),this._descriptorSet&&(this._destroyDescriptorSet(),fg.layout=e[0].localSetLayout,this._createDescriptorSet(fg)))}get passes(){return this._passes}get shaders(){return this._shaders}set subMesh(e){this._setSubMesh(e),this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===pg.VB_MERGING&&this.subMesh.genFlatBuffers()}get subMesh(){return this._subMesh}set priority(e){this._priority=e,this._nativeObj.setPriority(e)}get priority(){return this._priority}get inputAssembler(){return this._inputAssembler}get descriptorSet(){return this._descriptorSet}get patches(){return this._patches}get planarInstanceShader(){return this._planarInstanceShader}get planarShader(){return this._planarShader}_setInputAssembler(e){this._inputAssembler=this._device.createInputAssembler(e),this._nativeObj.setInputAssembler(this._inputAssembler)}_setSubMesh(e){this._subMesh=e,this._nativeObj.setSubMeshBuffers(e.flatBuffers)}get native(){return this._nativeObj}_init(){this._nativeObj=new ts}initialize(e,t,i=null){if(this._device=n.director.root.device,fg.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(fg),this._setSubMesh(e),this._patches=i,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===pg.VB_MERGING&&this.subMesh.genFlatBuffers(),this.priority=sd.DEFAULT,t[0].phase===lg("reflection")){let e=this._device.width,t=this._device.height;const i=512;t<e?(e=i*e/t,t=i):(e=i,t=i*t/e),this._reflectionTex=this._device.createTexture(new Lo(Hs.TEX2D,Vs.STORAGE|Vs.TRANSFER_SRC|Vs.SAMPLED,Ls.RGBA8,e,t,js.IMMUTABLE)),this.descriptorSet.bindTexture(df,this._reflectionTex);const n=$f([qs.LINEAR,qs.LINEAR,qs.NONE,Xs.CLAMP,Xs.CLAMP,Xs.CLAMP]);this._reflectionSampler=Qf.getSampler(this._device,n),this.descriptorSet.bindSampler(df,this._reflectionSampler),this.descriptorSet.bindTexture(gf,this._reflectionTex)}}_initNativePlanarShadowShader(e){this._planarShader=e.getPlanarShader(this._patches),this._nativeObj.setPlanarShader(this._planarShader)}initPlanarShadowShader(){const e=n.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)}_initNativePlanarShadowInstanceShader(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches),this._nativeObj.setPlanarInstanceShader(this._planarInstanceShader)}initPlanarShadowInstanceShader(){const e=n.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)}_destroy(){this._nativeObj=null}destroy(){this._destroyDescriptorSet(),this._destroyInputAssembler(),this.priority=sd.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler&&this._reflectionSampler.destroy(),this._reflectionSampler=null,this._destroy()}update(){for(let e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update()}onPipelineStateChanged(){const e=this._passes;if(e){for(let t=0;t<e.length;t++){const i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}onMacroPatchesStateChanged(e){this._patches=e;const t=this._passes;if(t){for(let e=0;e<t.length;e++){const i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}_flushPassInfo(){const e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(let t=0,i=e.length;t<i;t++)this._shaders[t]=e[t].getShaderVariant(this.patches);{const t=e.map((e=>e.native));this._nativeObj.setPasses(t),this._nativeObj.setShaders(this._shaders)}}}}class gg{static get(e,t=0){const i=gg._buffers;i.has(e)||i.set(e,{});const n=i.get(e);return n[t]||(n[t]=new gg(e))}constructor(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}destroy(){for(let e=0;e<this.instances.length;++e){const t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0}merge(e,t,i,n=null){const s=t.buffer.length;if(!s)return;const o=e.inputAssembler,r=e.descriptorSet.getTexture(cf);let a=n;a||(a=e.shaders[i]);const c=e.descriptorSet;for(let e=0;e<this.instances.length;++e){const i=this.instances[e];if(!(i.ia.indexBuffer!==o.indexBuffer||i.count>=1024)&&i.lightingMap===r){if(i.stride!==s)return;if(i.count>=i.capacity){i.capacity<<=1;const e=i.stride*i.capacity,t=i.data;i.data=new Uint8Array(e),i.data.set(t),i.vb.resize(e)}return i.shader!==a&&(i.shader=a),i.descriptorSet!==c&&(i.descriptorSet=c),i.data.set(t.buffer,i.stride*i.count++),void(this.hasPendingModels=!0)}}const l=this._device.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,32*s,s)),h=new Uint8Array(32*s),u=o.vertexBuffers.slice(),_=o.attributes.slice(),p=o.indexBuffer;for(let e=0;e<t.attributes.length;e++){const i=t.attributes[e],n=new Xo(i.name,i.format,i.isNormalized,u.length,!0);_.push(n)}h.set(t.buffer),u.push(l);const d=new Ko(_,u,p),f=this._device.createInputAssembler(d);this.instances.push({count:1,capacity:32,vb:l,data:h,ia:f,stride:s,shader:a,descriptorSet:c,lightingMap:r}),this.hasPendingModels=!0}uploadBuffers(e){for(let t=0;t<this.instances.length;++t){const i=this.instances[t];i.count&&(i.ia.instanceCount=i.count,e.updateBuffer(i.vb,i.data))}}clear(){for(let e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1}}gg._buffers=new Map;const vg=new Zi,yg=(new F((()=>new mg),32),[{name:"CC_RECEIVE_SHADOW",value:!0}]);let xg;!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(xg||(xg={}));const Sg=$f([qs.LINEAR,qs.LINEAR,qs.NONE,Xs.CLAMP,Xs.CLAMP,Xs.CLAMP]),bg=$f([qs.LINEAR,qs.LINEAR,qs.LINEAR,Xs.CLAMP,Xs.CLAMP,Xs.CLAMP]);class Tg{get subModels(){return this._subModels}get inited(){return this._inited}get worldBounds(){return this._worldBounds}get modelBounds(){return this._modelBounds}get localBuffer(){return this._localBuffer}get updateStamp(){return this._updateStamp}get isInstancingEnabled(){return this._instMatWorldIdx>=0}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e,this._nativeObj.setCastShadow(e)}get node(){return this._node}set node(e){this._node=e,this._nativeObj.setNode(e.native)}get transform(){return this._transform}set transform(e){this._transform=e,this._nativeObj.setTransform(e.native)}get visFlags(){return this._visFlags}set visFlags(e){this._visFlags=e,this._nativeObj.seVisFlag(e)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._nativeObj.setEnabled(e)}get native(){return this._nativeObj}constructor(){this.type=xg.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._localData=new Float32Array(Hd.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new an,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=id.Enum.NONE,this._device=n.director.root.device}_setReceiveShadow(e){this._receiveShadow=e,this._nativeObj.setReceiveShadow(e)}_init(){this._nativeObj=new Un}initialize(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=id.Enum.NONE,this._inited=!0)}_destroySubmodel(e){e.destroy()}_destroy(){this._nativeObj=null}destroy(){const e=this._subModels;for(let t=0;t<e.length;t++){const e=this._subModels[t];this._destroySubmodel(e)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()}attachToScene(e){this.scene=e}detachFromScene(){this.scene=null}updateTransform(e){const t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._transformUpdated=!0;const e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}}updateWorldBound(){const e=this.transform;if(null!==e){e.updateWorldTransform(),this._transformUpdated=!0;const t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}}_applyLocalData(){}_applyLocalBuffer(){this._nativeObj.setLocalBuffer(this._localBuffer)}updateUBOs(e){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].update();if(this._updateStamp=e,!this._transformUpdated)return;this._transformUpdated=!1;const i=this.transform._mat,n=this._instMatWorldIdx;if(n>=0){const e=this.instancedAttributes.views;!function(e,t,i,n){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,i[0]=e.m04,i[1]=e.m05,i[2]=e.m06,i[3]=e.m13,n[0]=e.m08,n[1]=e.m09,n[2]=e.m10,n[3]=e.m14}(i,e[n],e[n+1],e[n+2])}else this._localBuffer&&(Zi.toArray(this._localData,i,Hd.MAT_WORLD_OFFSET),Zi.inverseTranspose(vg,i),Zi.toArray(this._localData,vg,Hd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer())}_updateNativeBounds(){this._nativeObj.setBounds(this._worldBounds.native)}createBoundingShape(e,t){e&&t&&(this._modelBounds=xc.fromPoints(xc.create(),e,t),this._worldBounds=xc.clone(this._modelBounds),this._updateNativeBounds())}_createSubModel(){return new mg}initSubModel(e,t,i){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e),this._nativeObj.setSubModel(e,this._subModels[e].native)}setSubModelMesh(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)}setSubModelMaterial(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))}onGlobalPipelineStateChanged(){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].onPipelineStateChanged()}onMacroPatchesStateChanged(){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))}updateLightingmap(e,t){an.toArray(this._localData,t,Hd.LIGHTINGMAP_UVPARAM),this._applyLocalData(),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=cg.get("empty-texture"));const i=e.getGFXTexture();if(i){const t=Qf.getSampler(this._device,e.mipmaps.length>1?bg:Sg),n=this._subModels;for(let e=0;e<n.length;e++){const{descriptorSet:s}=n[e];s.bindTexture(cf,i),s.bindSampler(cf,t),s.update()}}}getMacroPatches(e){return this.receiveShadow?yg:null}_updateAttributesAndBinding(e){const t=this._subModels[e];if(!t)return;this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);const i=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(i.attributes,t.passes[0])}_getInstancedAttributeIndex(e){const{attributes:t}=this.instancedAttributes;for(let i=0;i<t.length;i++)if(t[i].name===e)return i;return-1}_setInstMatWorldIdx(e){this._instMatWorldIdx=e,this._nativeObj.setInstMatWorldIdx(e)}_updateInstancedAttributes(e,t){if(!t.device.hasFeature(Ns.INSTANCED_ARRAYS))return;let i=0;for(let t=0;t<e.length;t++){const n=e[t];n.isInstanced&&(i+=vr[n.format].size)}const n=this.instancedAttributes;n.buffer=new Uint8Array(i),n.views.length=n.attributes.length=0;let s=0;for(let t=0;t<e.length;t++){const i=e[t];if(!i.isInstanced)continue;const o=new Xo;o.format=i.format,o.name=i.name,o.isNormalized=i.isNormalized,o.location=i.location,n.attributes.push(o);const r=vr[i.format],a=new(Pr(r))(n.buffer.buffer,s,r.count);n.views.push(a),s+=r.size}t.batchingScheme===pg.INSTANCING&&gg.get(t).destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex("a_matWorld0")),this._transformUpdated=!0,this._nativeObj.setInstancedAttrBlock(n.buffer.buffer,n.views,n.attributes)}_initLocalDescriptors(e){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Io(Fs.UNIFORM|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,Hd.SIZE,Hd.SIZE)),this._applyLocalBuffer())}_updateLocalDescriptors(e,t){this._localBuffer&&t.bindBuffer(Hd.BINDING,this._localBuffer)}}let Eg,Cg;!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Eg||(Eg={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(Cg||(Cg={})),n.internal.TransformBit=Cg;class wg{get root(){return this._root}get name(){return this._name}get cameras(){return this._cameras}get mainLight(){return this._mainLight}get sphereLights(){return this._sphereLights}get spotLights(){return this._spotLights}get models(){return this._models}get native(){return this._nativeObj}get batches(){return this._batches}static registerCreateFunc(e){e._createSceneFun=e=>new wg(e)}constructor(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}initialize(e){return this._name=e.name,this._createNativeObject(),!0}update(e){{const t=[];for(let e=0,i=this._batches.length;e<i;++e)t.push(this._batches[e].native);return this._nativeObj.updateBatches(t),void this._nativeObj.update(e)}}_destroy(){this._nativeObj=null}destroy(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()}addCamera(e){e.attachToScene(this),this._cameras.push(e)}removeCamera(e){for(let t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()}removeCameras(){for(const e of this._cameras)e.detachFromScene();this._cameras.splice(0)}setMainLight(e){this._mainLight=e,this._nativeObj.setMainLight(e?e.native:null)}unsetMainLight(e){if(this._mainLight===e){const e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Cg.ROTATION));this.setMainLight(null)}}addDirectionalLight(e){e.attachToScene(this),this._directionalLights.push(e)}removeDirectionalLight(e){for(let t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)}addSphereLight(e){e.attachToScene(this),this._sphereLights.push(e),this._nativeObj.addSphereLight(e.native)}removeSphereLight(e){for(let t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),this._sphereLights.splice(t,1),void this._nativeObj.removeSphereLight(e.native)}addSpotLight(e){e.attachToScene(this),this._spotLights.push(e),this._nativeObj.addSpotLight(e.native)}removeSpotLight(e){for(let t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),this._spotLights.splice(t,1),void this._nativeObj.removeSpotLight(e.native)}removeSphereLights(){for(let e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0,this._nativeObj.removeSphereLights()}removeSpotLights(){for(let e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[],this._nativeObj.removeSpotLights()}addModel(e){switch(e.attachToScene(this),this._models.push(e),e.type){case xg.SKINNING:this._nativeObj.addSkinningModel(e.native);break;case xg.BAKED_SKINNING:this._nativeObj.addBakedSkinningModel(e.native);break;case xg.DEFAULT:default:this._nativeObj.addModel(e.native)}}removeModel(e){for(let t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),this._models.splice(t,1),void this._nativeObj.removeModel(t)}removeModels(){for(const e of this._models)e.detachFromScene(),e.destroy();this._models.length=0,this._nativeObj.removeModels()}addBatch(e){this._batches.push(e)}removeBatch(e){for(let t=0;t<this._batches.length;++t)if(this._batches[t]===e)return this._batches.splice(t,1),void this._nativeObj.removeBatch(t)}removeBatches(){this._batches.length=0,this._nativeObj.removeBatches()}onGlobalPipelineStateChanged(){for(const e of this._models)e.onGlobalPipelineStateChanged()}generateModelId(){return this._modelId++}_createNativeObject(){this._nativeObj=new Zn}}var Ag,Pg,Rg,Ig,Mg,Og,Dg,Ng;let Lg=e("EffectAsset",Wc("cc.EffectAsset")((Ng=Dg=class e extends xh{constructor(...e){super(...e),Mc(this,"techniques",Rg,this),Mc(this,"shaders",Ig,this),Mc(this,"combinations",Mg,this),Mc(this,"hideInEditor",Og,this)}static register(t){e._effects[t.name]=t}static remove(t){if("string"!=typeof t)e._effects[t.name]&&e._effects[t.name].equals(t)&&delete e._effects[t.name];else{if(e._effects[t])return void delete e._effects[t];for(const i in e._effects)if(e._effects[i]._uuid===t)return void delete e._effects[i]}}static get(t){if(e._effects[t])return e._effects[t];for(const i in e._effects)if(e._effects[i]._uuid===t)return e._effects[i];return null}static getAll(){return e._effects}onLoaded(){rg.register(this),e.register(this),n.game.once(n.Game.EVENT_ENGINE_INITED,this._precompile,this)}_precompile(){const e=n.director.root;for(let t=0;t<this.shaders.length;t++){const i=this.shaders[t],n=this.combinations[t];n&&Object.keys(n).reduce(((e,t)=>e.reduce(((e,i)=>{const s=n[t];for(let n=0;n<s.length;++n){const o={...i};o[t]=s[n],e.push(o)}return e}),[])),[{}]).forEach((t=>rg.getGFXShader(e.device,i.name,t,e.pipeline)))}}destroy(){return e.remove(this),super.destroy()}initDefault(t){super.initDefault(t);const i=e.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques}validate(){return this.techniques.length>0&&this.shaders.length>0}},Dg._effects={},Rg=Oc((Pg=Ng).prototype,"techniques",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ig=Oc(Pg.prototype,"shaders",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mg=Oc(Pg.prototype,"combinations",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Og=Oc(Pg.prototype,"hideInEditor",[Qc,Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ag=Pg))||Ag);var Bg,zg,Fg,Ug,Gg,kg,Hg,Vg,jg;n.EffectAsset=Lg;let Wg=e("Material",(Bg=Wc("cc.Material"),zg=Al(Lg),Bg((Gg=Oc((Ug=class e extends xh{static getHash(e){let t=0;for(const i of e.passes)t^=i.hash;return t}constructor(){super(),Mc(this,"_effectAsset",Gg,this),Mc(this,"_techIdx",kg,this),Mc(this,"_defines",Hg,this),Mc(this,"_states",Vg,this),Mc(this,"_props",jg,this),this._passes=[],this._hash=0}get effectAsset(){return this._effectAsset}get effectName(){return this._effectAsset?this._effectAsset.name:""}get technique(){return this._techIdx}get passes(){return this._passes}get hash(){return this._hash}get parent(){return null}get owner(){return null}initialize(e){this._passes.length?T(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=Lg.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update())}reset(e){this.initialize(e)}destroy(){return this._doDestroy(),super.destroy()}recompileShaders(e,t){console.warn(`Shaders in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}overridePipelineStates(e,t){console.warn(`Pipeline states in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}onLoaded(){this._update()}resetUniforms(e=!0){this._props.length=this._passes.length;for(let e=0;e<this._props.length;e++)this._props[e]={};if(e)for(const e of this._passes)e.resetUBOs(),e.resetTextures()}setProperty(e,t,i){let n=!1;if(void 0===i){const i=this._passes,s=i.length;for(let o=0;o<s;o++){const s=i[o];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,n=!0)}}else{if(i>=this._passes.length)return void console.warn(`illegal pass index: ${i}.`);const s=this._passes[i];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,n=!0)}n||console.warn(`illegal property name: ${e}.`)}getProperty(e,t){if(void 0===t){const t=this._props,i=t.length;for(let n=0;n<i;n++){const i=t[n];if(e in i)return i[e]}}else{if(t>=this._props.length)return console.warn(`illegal pass index: ${t}.`),null;const i=this._props[this._passes[t].propertyIndex];if(e in i)return i[e]}return null}copy(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(let t=0;t<e._props.length;t++)this._props[t]={...e._props[t]};this._defines.length=e._defines.length;for(let t=0;t<e._defines.length;t++)this._defines[t]={...e._defines[t]};this._states.length=e._states.length;for(let t=0;t<e._states.length;t++)this._states[t]={...e._states[t]};this._effectAsset=e._effectAsset,this._update()}_prepareInfo(e,t){let i=e;if(!Array.isArray(i)){const e=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(e).fill(i)}for(let e=0;e<i.length;++e)Object.assign(t[e]||(t[e]={}),i[e])}_createPasses(){const e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];const t=e.passes.length,i=[];for(let s=0;s<t;++s){const t=e.passes[s],o=t.passIndex=s,r=t.defines=this._defines[o]||(this._defines[o]={}),a=t.stateOverrides=this._states[o]||(this._states[o]={});if(void 0!==t.propertyIndex&&(Object.assign(r,this._defines[t.propertyIndex]),Object.assign(a,this._states[t.propertyIndex])),void 0!==t.embeddedMacros&&Object.assign(r,t.embeddedMacros),t.switch&&!r[t.switch])continue;const c=new dg(n.director.root);c.initialize(t),i.push(c)}return i}_update(t=!0){if(this._effectAsset){this._passes=this._createPasses();const e=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=e,t)this._passes.forEach(((e,t)=>{let i=this._props[t];i||(i=this._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,this._props[e.propertyIndex]);for(const t in i)this._uploadProperty(e,t,i[t])}));else for(let e=0;e<this._props.length;e++)this._props[e]={}}this._hash=e.getHash(this)}_uploadProperty(e,t,i){const n=e.getHandle(t);if(!n)return!1;const s=dg.getPropertyTypeFromHandle(n);if(s===km.BUFFER)Array.isArray(i)?e.setUniformArray(n,i):null!==i?e.setUniform(n,i):e.resetUniform(t);else if(s===km.TEXTURE)if(Array.isArray(i))for(let t=0;t<i.length;t++)this._bindTexture(e,n,i[t],t);else i?this._bindTexture(e,n,i):e.resetTexture(t);return!0}_bindTexture(e,t,i,n){const s=dg.getBindingFromHandle(t);if(i instanceof Qr)e.bindTexture(s,i,n);else if(i instanceof um){const t=i.getGFXTexture();if(!t||!t.width||!t.height)return;e.bindTexture(s,t,n),e.bindSampler(s,i.getGFXSampler(),n)}}_doDestroy(){if(this._passes&&this._passes.length)for(const e of this._passes)e.destroy();this._passes.length=0}initDefault(e){super.initDefault(e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Di("#ff00ff"))}validate(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0}}).prototype,"_effectAsset",[zg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kg=Oc(Ug.prototype,"_techIdx",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hg=Oc(Ug.prototype,"_defines",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vg=Oc(Ug.prototype,"_states",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jg=Oc(Ug.prototype,"_props",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fg=Ug))||Fg));n.Material=Wg;const qg=Le({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Xg=Le({Planar:0,ShadowMap:1}),Yg=Le({HARD:0,SOFT:1,SOFT_2X:2}),Kg=Xg.ShadowMap+1;class $g{get enabled(){return this._enabled}set enabled(e){this._setEnable(e),this.activate()}get normal(){return this._normal}set normal(e){zi.copy(this._normal,e),this._nativeObj.normal=this._normal}get distance(){return this._distance}set distance(e){this._distance=e,this._nativeObj.distance=e}get shadowColor(){return this._shadowColor}set shadowColor(e){this._shadowColor=e,this._nativeObj.color=e}get invisibleOcclusionRange(){return this._invisibleOcclusionRange}set invisibleOcclusionRange(e){this._invisibleOcclusionRange=e,this._nativeObj.invisibleOcclusionRange=e}get shadowDistance(){return this._shadowDistance}set shadowDistance(e){this._shadowDistance=e,this._nativeObj.shadowDistance=e}get type(){return this._type}set type(e){this._setType(e),this.activate()}get near(){return this._near}set near(e){this._near=e,this._nativeObj.nearValue=e}get far(){return this._far}set far(e){this._far=e,this._nativeObj.farValue=e}get orthoSize(){return this._orthoSize}set orthoSize(e){this._orthoSize=e,this._nativeObj.orthoSize=e}get size(){return this._size}set size(e){this._size.set(e),this._nativeObj.size=e}get pcf(){return this._pcf}set pcf(e){this._pcf=e,this._nativeObj.pcfType=e}get shadowMapDirty(){return this._shadowMapDirty}set shadowMapDirty(e){this._shadowMapDirty=e,this._nativeObj.shadowMapDirty=e}get bias(){return this._bias}set bias(e){this._bias=e,this._nativeObj.bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e,this._nativeObj.normalBias=e}get saturation(){return this._saturation}set saturation(e){this._saturation=e,this._nativeObj.saturation=e}get fixedArea(){return this._fixedArea}set fixedArea(e){this._fixedArea=e,this._nativeObj.fixedArea=e}get matLight(){return this._matLight}get material(){return this._material}get instancingMaterial(){return this._instancingMaterial}get native(){return this._nativeObj}constructor(){this.fixedSphere=new As(0,0,0,.01),this.maxReceived=4,this.shadowCameraFar=0,this.matShadowView=new Zi,this.matShadowProj=new Zi,this.matShadowViewProj=new Zi,this._normal=new zi(0,1,0),this._shadowColor=new Di(0,0,0,76),this._matLight=new Zi,this._material=null,this._instancingMaterial=null,this._size=new nn(512,512),this._enabled=!1,this._distance=0,this._type=Kg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75,this._nativeObj=new Kn}getPlanarShader(e){return this._material||(this._material=new Wg,this._material.initialize({effectName:"planar-shadow"}),this._nativeObj.planarPass=this._material.passes[0].native),this._material.passes[0].getShaderVariant(e)}getPlanarInstanceShader(e){return this._instancingMaterial||(this._instancingMaterial=new Wg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),this._nativeObj.instancePass=this._instancingMaterial.passes[0].native),this._instancingMaterial.passes[0].getShaderVariant(e)}_setEnable(e){this._enabled=e,this._nativeObj.enabled=e,e||this._setType(Kg)}_setType(e){this._type=this.enabled?e:Kg,this._nativeObj.shadowType=this._type}initialize(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation}activate(){if(this.enabled)this.type===Xg.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{const e=n.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()}}_updatePlanarInfo(){this._material||(this._material=new Wg,this._material.initialize({effectName:"planar-shadow"}),this._nativeObj.planarPass=this._material.passes[0].native),this._instancingMaterial||(this._instancingMaterial=new Wg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),this._nativeObj.instancePass=this._instancingMaterial.passes[0].native);const e=n.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()}_updatePipeline(){const e=n.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=1,e.onGlobalPipelineStateChanged()}_destroy(){this._nativeObj=null}destroy(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()}}$g.MAX_FAR=2e3,$g.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),n.Shadows=$g,ti(wg.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),ti(wg.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);const Qg={};ti(Qg,"CameraVisFlags",[{name:"GENERAL"}]),ei(Qg,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:id.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:id.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:id.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:id.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:id.BitMask,targetName:"UI_2D"}]),n.CameraVisFlags=Qg;const Zg={};function Jg(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);const i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),s=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),o=2*n-8*s+4,r=3*n/o,a=2*s/o,c=1/a*r,l=1/a*(1-r-a);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}let ev;ti(Zg,"VisibilityFlags",[{name:"GENERAL"}]),ei(Zg,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:id.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:id.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:id.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:id.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:id.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:id.Enum,targetName:"UI_2D"}]),n.VisibilityFlags=Zg,ei(dg.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),ti(Nf.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]),ti($g.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(ev||(ev={}));const tv=e=>4*Math.PI*Math.PI*e*e;class iv{constructor(){this._baked=!1,this._color=new zi(1,1,1),this._colorTemp=6550,this._colorTempRGB=new zi(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=ev.UNKNOWN}_init(){switch(this._type){case ev.DIRECTIONAL:this._nativeObj=new Vn;break;case ev.SPHERE:this._nativeObj=new Wn;break;case ev.SPOT:this._nativeObj=new jn}this._nativeObj.setType(this._type)}_destroy(){this._nativeObj=null}get baked(){return this._baked}set baked(e){this._baked=e}set color(e){this._color.set(e),this._nativeObj.setColor(e)}get color(){return this._color}set useColorTemperature(e){this._useColorTemperature=e,this._nativeObj.setUseColorTemperature(e)}get useColorTemperature(){return this._useColorTemperature}set colorTemperature(e){this._colorTemp=e,Jg(this._colorTempRGB,this._colorTemp),this._nativeObj.setColorTemperatureRGB(this._colorTempRGB)}get colorTemperature(){return this._colorTemp}get colorTemperatureRGB(){return this._colorTempRGB}set node(e){this._node=e,this._node&&(this._node.hasChangedFlags|=Cg.ROTATION,this._nativeObj.setNode(e?e.native:null))}get node(){return this._node}get type(){return this._type}get name(){return this._name}set name(e){this._name=e}get scene(){return this._scene}get native(){return this._nativeObj}initialize(){this._init(),this.color=new zi(1,1,1),this.colorTemperature=6550}attachToScene(e){this._scene=e}detachFromScene(){this._scene=null}destroy(){this._name=null,this._node=null,this._destroy()}update(){}}const nv=new zi(0,0,-1),sv=new zi;class ov extends iv{set direction(e){zi.normalize(this._dir,e),this._nativeObj.setDirection(e)}get direction(){return this._dir}set illuminance(e){this._illuminance=e,this._nativeObj.setIlluminance(e)}get illuminance(){return this._illuminance}constructor(){super(),this._dir=new zi(1,-1,-1),this._illuminance=rs.SUN_ILLUM,this._type=ev.DIRECTIONAL}initialize(){super.initialize(),this.illuminance=rs.SUN_ILLUM,this.direction=new zi(1,-1,-1)}update(){this._node&&this._node.hasChangedFlags&&(this.direction=zi.transformQuat(sv,nv,this._node.worldRotation))}}class rv extends dg{get parent(){return this._parent}constructor(e,t){super(e.root),this._parent=void 0,this._owner=void 0,this._dontNotify=!1,this._parent=e,this._owner=t,this._doInit(this._parent,!0);for(let e=0;e<this._shaderInfo.blocks.length;e++){const t=this._shaderInfo.blocks[e],i=this._blocks[t.binding],n=this._parent.blocks[t.binding];i.set(n)}this._setRootBufferDirty(!0);const i=this._parent;for(let e=0;e<this._shaderInfo.samplerTextures.length;e++){const t=this._shaderInfo.samplerTextures[e];for(let e=0;e<t.count;e++){const n=i._descriptorSet.getSampler(t.binding,e),s=i._descriptorSet.getTexture(t.binding,e);this._descriptorSet.bindSampler(t.binding,n,e),this._descriptorSet.bindTexture(t.binding,s,e)}}super.tryCompile()}overridePipelineStates(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),dg.fillPipelineInfo(this,e),dg.fillPipelineInfo(this,t),this._onStateChange()}tryCompile(e){if(e&&!Zm(this._defines,e))return!1;const t=super.tryCompile();return this._onStateChange(),t}beginChangeStatesSilently(){this._dontNotify=!0}endChangeStatesSilently(){this._dontNotify=!1}_syncBatchingScheme(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(pg.NONE)}_onStateChange(){this._setHash(dg.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)}}class av extends Wg{get parent(){return this._parent}get owner(){return this._owner}constructor(e){super(),this._passes=[],this._parent=void 0,this._owner=void 0,this._subModelIdx=0,this._parent=e.parent,this._owner=e.owner||null,this._subModelIdx=e.subModelIdx||0,this.copy(this._parent)}recompileShaders(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(const t of this._passes)t.tryCompile(e);else this._passes[t].tryCompile(e)}overridePipelineStates(e,t){if(!this._passes||!this.effectAsset)return;const i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(let t=0;t<this._passes.length;t++){const n=this._passes[t],s=this._states[t]||(this._states[t]={});for(const t in e)s[t]=e[t];n.overridePipelineStates(i[n.passIndex],s)}else{const n=this._states[t]||(this._states[t]={});for(const t in e)n[t]=e[t];this._passes[t].overridePipelineStates(i[t],n)}}destroy(){return this._doDestroy(),!0}onPassStateChange(e){this._hash=Wg.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}_createPasses(){const e=[],t=this._parent.passes;if(!t)return e;for(let i=0;i<t.length;++i)e.push(new rv(t[i],this));return e}}let cv=null,lv=null;class hv{get model(){return this._model}get enabled(){return this._enabled}set enabled(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}get useIBL(){return this._useIBL}set useIBL(e){this._setUseIBL(e),this._updatePipeline()}get isRGBE(){return this._isRGBE}set isRGBE(e){e&&(lv&&lv.recompileShaders({USE_RGBE_CUBEMAP:e}),this._model&&this._model.setSubModelMaterial(0,lv)),this._setIsRGBE(e),this._updatePipeline()}get envmap(){return this._envmap}set envmap(e){this._envmap=e||this._default,this._envmap&&(n.director.root.pipeline.pipelineSceneData.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}get native(){return this._nativeObj}constructor(){this._envmap=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._isRGBE=!1,this._nativeObj=new qn}_setEnabled(e){this._enabled=e,this._nativeObj.enabled=e}_setUseIBL(e){this._useIBL=e,this._nativeObj.useIBL=e}_setIsRGBE(e){this._isRGBE=e,this._nativeObj.isRGBE=e}initialize(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setIsRGBE(e.isRGBE),this._envmap=e.envmap}activate(){const e=n.director.root.pipeline,t=e.pipelineSceneData.ambient;if(this._globalDSManager=e.globalDSManager,this._default=cg.get("default-cube-texture"),this._model||(this._model=n.director.root.createModel(n.renderer.scene.Model),this._model._initLocalDescriptors=()=>{},this._nativeObj.model=this._model.native),this._envmap||(this._envmap=this._default),t.albedoArray[3]=this._envmap.mipmapLevel,lv)lv.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{const e=new Wg;e.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),lv=new av({parent:e})}this.enabled&&(cv||(cv=n.utils.createMesh(n.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,cv.renderingSubMeshes[0],lv)),this._updateGlobalBinding(),this._updatePipeline()}_updatePipeline(){const e=this.useIBL?this.isRGBE?2:1:0,t=n.director.root,i=t.pipeline;i.macros.CC_USE_IBL!==e&&(i.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())}_updateGlobalBinding(){const e=this.envmap.getGFXTexture(),t=Qf.getSampler(n.director._device,this.envmap.getSamplerHash());this._globalDSManager.bindSampler(Bd,t),this._globalDSManager.bindTexture(Bd,e),this._globalDSManager.update()}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}n.Skybox=hv;class uv extends iv{_init(){super._init(),this._nativeObj.setPosition(this._pos),this._nativeObj.setAABB(this._aabb.native)}_destroy(){super._destroy()}get position(){return this._pos}set size(e){this._size=e,this._nativeObj.setSize(e)}get size(){return this._size}set range(e){this._range=e,this._nativeObj.setRange(e),this._needUpdate=!0}get range(){return this._range}set luminance(e){this._luminance=e,this._nativeObj.setIlluminance(e)}get luminance(){return this._luminance}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._size=.15,this._range=1,this._luminance=0,this._pos=void 0,this._aabb=void 0,this._aabb=xc.create(),this._pos=new zi,this._type=ev.SPHERE}initialize(){super.initialize(),this.size=.15,this.range=1,this.luminance=1700/tv(.15)}update(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);const e=this._range;xc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}}}const _v=new zi(0,0,-1),pv=new ji,dv=new Zi,fv=new Zi,mv=new Zi,gv=new Zi;class vv extends iv{_init(){super._init();{const e=this._nativeObj;e.setAABB(this._aabb.native),e.setFrustum(this._frustum),e.setDirection(this._dir),e.setPosition(this._pos)}}_destroy(){super._destroy()}_setDirection(e){this._dir.set(e),this._nativeObj.setDirection(e)}get position(){return this._pos}set size(e){this._size=e,this._nativeObj.setSize(e)}get size(){return this._size}set range(e){this._range=e,this._nativeObj.setRange(e),this._needUpdate=!0}get range(){return this._range}set luminance(e){this._luminance=e,this._nativeObj.setIlluminance(e)}get luminance(){return this._luminance}get direction(){return this._dir}get spotAngle(){return this._spotAngle}set spotAngle(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._nativeObj.setAngle(this._spotAngle),this._needUpdate=!0}get angle(){return this._angle}set aspect(e){this._aspect=e,this._nativeObj.setAspect(e),this._needUpdate=!0}get aspect(){return this._aspect}get aabb(){return this._aabb}get frustum(){return this._frustum}constructor(){super(),this._dir=new zi(1,-1,-1),this._range=5,this._spotAngle=Math.cos(Math.PI/6),this._pos=void 0,this._aabb=void 0,this._frustum=void 0,this._angle=0,this._needUpdate=!1,this._size=.15,this._luminance=0,this._aspect=0,this._aabb=xc.create(),this._frustum=Ic.create(),this._pos=new zi,this._type=ev.SPOT}initialize(){super.initialize(),this.size=.15,this.aspect=1,this.luminance=1700/tv(.15),this.range=Math.cos(Math.PI/6),this._setDirection(new zi(1,-1,-1))}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),zi.transformQuat(this._dir,_v,this._node.getWorldRotation(pv)),zi.normalize(this._dir,this._dir),xc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(dv),Zi.invert(dv,dv),Zi.perspective(fv,this._angle,1,.001,this._range),Zi.multiply(mv,fv,dv),this._frustum.update(mv,gv),this._needUpdate=!1)}}var yv=Object.freeze({__proto__:null,Ambient:rs,get CameraFOVAxis(){return Sf},get CameraProjection(){return bf},get CameraAperture(){return Tf},get CameraISO(){return Ef},get CameraShutter(){return Cf},SKYBOX_FLAG:Of,Camera:Nf,CameraVisFlags:Qg,VisibilityFlags:Zg,DirectionalLight:ov,ColorTemperatureToRGB:Jg,get LightType(){return ev},nt2lm:tv,Light:iv,get ModelType(){return xg},Model:Tg,ShadowSize:qg,ShadowType:Xg,PCFType:Yg,Shadows:$g,RenderScene:wg,Skybox:hv,SphereLight:uv,SpotLight:vv,SubModel:mg,NativeNode:zn,NativeScene:Fn,NativeModel:Un,NativeSkinningModel:Gn,NativeBakedSkinningModel:kn,NativeLight:Hn,NativeDirectionalLight:Vn,NativeSpotLight:jn,NativeSphereLight:Wn,NaitveSkybox:qn,NativeFog:Xn,NativeAmbient:Yn,NativeShadow:Kn,NativeCamera:$n,NativeRenderWindow:Qn,NativeRenderScene:Zn,NativeDrawBatch2D:Jn,NativePass:es,NativeSubModel:ts,NativeRoot:is,NativePipelineSharedSceneData:ss,NativeAABB:os});let xv,Sv;function bv(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function Tv(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(xv||(xv={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(Sv||(Sv={}));class Ev{constructor(e){this._device=void 0,this._format=Ls.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new wo,this._region1=new wo,this._region2=new wo,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}initialize(e){const t=vr[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=Pr(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)}destroy(){for(let e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0}alloc(e,t){e=Tv(e,this._alignment);let i=-1,n=-1;if(void 0!==t&&(i=t,n=this._findAvailableSpace(e,i)),n<0)for(let t=0;t<this._chunkCount&&(i=t,n=this._findAvailableSpace(e,i),!(n>=0));++t);if(n>=0){const t=this._chunks[i];t.start+=e;const s={chunkIdx:i,start:n,end:n+e,texture:t.texture};return this._handles.push(s),s}const s=Math.sqrt(e/this._formatSize),o=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,bv(s)),r=this._chunks[this.createChunk(o)];r.start+=e;const a={chunkIdx:this._chunkCount-1,start:0,end:e,texture:r.texture};return this._handles.push(a),a}free(e){for(let t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}createChunk(e){const t=e*e*this._formatSize;m(`TextureBufferPool: Allocate chunk ${this._chunkCount}, size: ${t}, format: ${this._format}`);const i={texture:this._device.createTexture(new Lo(Hs.TEX2D,Vs.SAMPLED|Vs.TRANSFER_DST,this._format,e,e,js.IMMUTABLE)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=i,this._chunkCount++}update(e,t){const i=[],n=[],s=e.start/this._formatSize;let o=t.byteLength/this._formatSize,r=s%e.texture.width,a=Math.floor(s/e.texture.width),c=Math.min(e.texture.width-r,o),l=0;r>0&&(this._region0.texOffset.x=r,this._region0.texOffset.y=a,this._region0.texExtent.width=c,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),n.push(this._region0),r=0,a+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=r,this._region1.texOffset.y=a,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),n.push(this._region1),r=0,a+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=r,this._region2.texOffset.y=a,this._region2.texExtent.width=o,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}_findAvailableSpace(e,t){const i=this._chunks[t];let n=!1,s=i.start;if(s+e<=i.size)n=!0;else{s=0;const o=this._handles.filter((e=>e.chunkIdx===t)).sort(((e,t)=>e.start-t.start));for(let t=0;t<o.length;t++){const i=o[t];if(s+e<=i.start){n=!0;break}s=i.end}!n&&s+e<=i.size&&(n=!0)}return n?s:-1}_McDonaldAlloc(e){e=Tv(e,this._alignment);for(let t=0;t<this._chunkCount;++t){const i=this._chunks[t];let n=!1,s=i.start;if(s+e<=i.end?n=!0:s>i.end?s+e<=i.size?n=!0:e<=i.end&&(i.start=s=0,n=!0):s===i.end&&(i.start=s=0,i.end=i.size,e<=i.end&&(n=!0)),n){i.start+=e;const n={chunkIdx:t,start:s,end:s+e,texture:i.texture};return this._handles.push(n),n}}const t=Math.sqrt(e/this._formatSize),i=this._roundUpFn&&this._roundUpFn(t,this._formatSize)||Math.max(1024,bv(t)),n=this._chunks[this.createChunk(i)];n.start+=e;const s={chunkIdx:this._chunkCount,start:0,end:e,texture:n.texture};return this._handles.push(s),s}}const Cv=Bn.addStage;var wv=Object.freeze({__proto__:null,addStage:Cv,scene:yv,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;const i=[],n=t.positions.length/3;for(let e=0;e<n;++e)i.push(t.positions[3*e],t.positions[3*e+1],t.positions[3*e+2]),t.normals&&i.push(t.normals[3*e],t.normals[3*e+1],t.normals[3*e+2]),t.uvs&&i.push(t.uvs[2*e],t.uvs[2*e+1]),t.colors&&i.push(t.colors[3*e],t.colors[3*e+1],t.colors[3*e+2]);const s=[];s.push(new Xo(mo.ATTR_POSITION,Ls.RGB32F)),t.normals&&s.push(new Xo(mo.ATTR_NORMAL,Ls.RGB32F)),t.uvs&&s.push(new Xo(mo.ATTR_TEX_COORD,Ls.RG32F)),t.colors&&s.push(new Xo(mo.ATTR_COLOR,Ls.RGB32F));const o=e.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,4*i.length,4*i.length/n));o.update(new Float32Array(i));let r=null;return t.indices&&(r=e.createBuffer(new Io(Fs.INDEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,2*t.indices.length,2)),r.update(new Uint16Array(t.indices))),e.createInputAssembler(new Ko(s,[o],r))},get RenderQueue(){return xv},get PassStage(){return Sv},get PropertyType(){return km},genHandle:Hm,getPropertyTypeFromHandle:Vm,getTypeFromHandle:jm,getSetIndexFromHandle:e=>(e&Um)>>>20,getBindingFromHandle:Wm,getOffsetFromHandle:qm,customizeType:Xm,type2reader:Ym,type2writer:Km,getDefaultFromType:Qm,overrideMacros:Zm,get BatchingSchemes(){return pg},Pass:dg,getDeviceShaderVersion:og,programLib:rg,get SamplerInfoIndex(){return jf},defaultSamplerHash:Xf,genSamplerHash:$f,samplerLib:Qf,nearestPOT:bv,TextureBufferPool:Ev,MaterialInstance:av,PassInstance:rv,get PoolType(){return tc},NULL_HANDLE:0,get NodeView(){return ic},NodePool:oc,get PassView(){return rc},PassPool:lc,get AABBView(){return hc},AABBPool:pc});e("renderer",wv);const Av=Le({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),Pv=Av.LAYERED+1;class Rv{set enabled(e){this._setEnable(e),e||(this._type=Pv),e?this.activate():this._updatePipeline()}get enabled(){return this._enabled}set fogColor(e){this._fogColor.set(e),Di.toArray(this._colorArray,this._fogColor),this._nativeObj.color=this._fogColor}get fogColor(){return this._fogColor}get type(){return this._type}set type(e){this._setType(e),this.enabled&&this._updatePipeline()}get fogDensity(){return this._fogDensity}set fogDensity(e){this._fogDensity=e,this._nativeObj.density=e}get fogStart(){return this._fogStart}set fogStart(e){this._fogStart=e,this._nativeObj.start=e}get fogEnd(){return this._fogEnd}set fogEnd(e){this._fogEnd=e,this._nativeObj.end=e}get fogAtten(){return this._fogAtten}set fogAtten(e){this._fogAtten=e,this._nativeObj.atten=e}get fogTop(){return this._fogTop}set fogTop(e){this._fogTop=e,this._nativeObj.top=e}get fogRange(){return this._fogRange}set fogRange(e){this._fogRange=e,this._nativeObj.range=e}get colorArray(){return this._colorArray}get native(){return this._nativeObj}constructor(){this._fogColor=new Di("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._enabled=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._nativeObj=new Xn}_setType(e){this._type=this.enabled?e:Pv,this._nativeObj.type=this._type}_setEnable(e){this._enabled=e,this._nativeObj.enabled=e}initialize(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange}activate(){this._updatePipeline()}_updatePipeline(){const e=n.director.root,t=this.enabled?this.type:Pv,i=e.pipeline;i.macros.CC_USE_FOG!==t&&(i.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}n.Fog=Rv;class Iv{_init(){this._nativeObj=new ss,this._nativeObj.fog=this.fog.native,this._nativeObj.ambient=this.ambient.native,this._nativeObj.skybox=this.skybox.native,this._nativeObj.shadow=this.shadows.native}get native(){return this._nativeObj}get isHDR(){return this._isHDR}set isHDR(e){this._isHDR=e,this._nativeObj.isHDR=e}get shadingScale(){return this._shadingScale}set shadingScale(e){this._shadingScale=e,this._nativeObj.shadingScale=e}get fpScale(){return this._fpScale}set fpScale(e){this._fpScale=e,this._fpScale=e}constructor(){this.fog=new Rv,this.ambient=new rs,this.skybox=new hv,this.shadows=new $g,this.renderObjects=[],this.shadowObjects=[],this.shadowFrameBufferMap=new Map,this._isHDR=!1,this._shadingScale=1,this._fpScale=1/1024,this._init(),this.shadingScale=1,this.fpScale=1/1024}activate(e,t){return this._device=e,this._pipeline=t,!0}onGlobalPipelineStateChanged(){}destroy(){this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this._nativeObj=null}}function Mv(e,t){for(const i of t)Array.isArray(i)?Mv(e,i):e.push(i)}function Ov(e){const t=[];return Mv(t,e),t.join("")}const Dv=Ot.Flags.Destroyed,Nv=Ot.Flags.PersistentMask,Lv=wt.IDENTIFIER_RE,Bv="var ",zv="o",Fv={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},Uv=wt.escapeForJS;class Gv{constructor(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}toString(){return`${Bv+this.varName}=${this.expression};`}}function kv(e,t){return t instanceof Gv?new Gv(t.varName,e+t.expression):e+t}function Hv(e,t,i){Array.isArray(i)?(i[0]=kv(t,i[0]),e.push(i)):e.push(`${kv(t,i)};`)}class Vv{constructor(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}append(e,t){this._exps.push([e,t])}writeCode(e){let t;if(this._exps.length>1)e.push(`t=${this._targetExp};`),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(let i=0;i<this._exps.length;i++){const n=this._exps[i];Hv(e,`${t+jv(n[0])}=`,n[1])}}}function jv(e){return Lv.test(e)?`.${e}`:`[${Uv(e)}]`}Vv.pool=void 0,Vv.pool=new Me((e=>{e._exps.length=0,e._targetExp=null}),1),Vv.pool.get=function(e){const t=this._get()||new Vv;return t._targetExp=e,t};class Wv{constructor(e,t){let i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=se(),fe(this.funcModuleCache,Fv),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{",`o=R=new ${this.getFuncModule(e.constructor,!0)}();`,"}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(i=`${Bv+this.globalVariables.join(",")};`);const n=Ov(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(let e=0,t=this.objsToClear_iN$t.length;e<t;++e)this.objsToClear_iN$t[e]._iN$t=null;this.objsToClear_iN$t.length=0}getFuncModule(e,t){const i=oe(e);if(i){const t=this.funcModuleCache[i];if(t)return t;if(void 0===t){let t=-1!==i.indexOf(".");if(t)try{if(t=e===Function(`return ${i}`)(),t)return this.funcModuleCache[i]=i,i}catch(e){}}}let n=this.funcs.indexOf(e);n<0&&(n=this.funcs.length,this.funcs.push(e));let s=`F[${n}]`;return t&&(s=`(${s})`),this.funcModuleCache[i]=s,s}getObjRef(e){let t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),`O[${t}]`}setValueType(e,t,i,n){const s=Vv.pool.get(n);let o=t.constructor.__props__;o||(o=Object.keys(t));for(let e=0;e<o.length;e++){const n=o[e],r=i[n];if(t[n]===r)continue;const a=this.enumerateField(i,n,r);s.append(n,a)}s.writeCode(e),Vv.pool.put(s)}enumerateCCClass(e,t,i){const s=i.__values__,o=nt(i);for(let i=0;i<s.length;i++){const r=s[i],a=t[r];let c=o[r+"$_$default"];if(!qv(c,a))if("object"==typeof a&&a instanceof n.ValueType&&(c=wt.getDefault(c),c&&c.constructor===a.constructor)){const t=zv+jv(r);this.setValueType(e,c,a,t)}else this.setObjProp(e,t,r,a)}}instantiateArray(e){if(0===e.length)return"[]";const t="a"+ ++this.localVariableId,i=[new Gv(t,`new Array(${e.length})`)];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(let n=0;n<e.length;++n)Hv(i,`${t}[${n}]=`,this.enumerateField(e,n,e[n]));return i}instantiateTypedArray(e){const t=e.constructor.name;if(0===e.length)return`new ${t}`;const i="a"+ ++this.localVariableId,n=[new Gv(i,`new ${t}(${e.length})`)];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(let t=0;t<e.length;++t)0!==e[t]&&Hv(n,`${i}[${t}]=`,e[t]);return n}enumerateField(e,t,i){if("object"==typeof i&&i){const e=i._iN$t;if(e){let t=e.globalVar;if(!t){t=e.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(t);const i=e.source[0];e.source[0]=kv(`${t}=`,i)}return t}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?Uv(i):("_objFlags"===t&&e instanceof Ot&&(i&=Nv),i)}setObjProp(e,t,i,n){Hv(e,`${zv+jv(i)}=`,this.enumerateField(t,i,n))}enumerateObject(e,t){const i=t.constructor;if(n.Class._isCCClass(i))this.enumerateCCClass(e,t,i);else for(const i in t){if(!t.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const n=t[i];"object"==typeof n&&n&&n===t._iN$t||this.setObjProp(e,t,i,n)}}instantiateObj(e){if(e instanceof n.ValueType)return wt.getNewValueTypeCode(e);if(e instanceof n.Asset)return this.getObjRef(e);if(e._objFlags&Dv)return null;let t;const i=e.constructor;if(n.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof n.Component){if(e instanceof n._BaseNode||e instanceof n.Component)return this.getObjRef(e)}else if(this.parent instanceof n._BaseNode)if(e instanceof n._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof n.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new Gv(zv,`new ${this.getFuncModule(i,!0)}()`)}else if(i===Object)t=new Gv(zv,"{}");else{if(i)return this.getObjRef(e);t=new Gv(zv,"Object.create(null)")}const s=[t];return e._iN$t={globalVar:"",source:s},this.objsToClear_iN$t.push(e),this.enumerateObject(s,e),["(function(){",s,"return o;})();"]}}function qv(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof n.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return J(e)&&J(t)}return!1}class Xv{get uiTransformComp(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp}set uiTransformComp(e){this._uiTransformComp=e}get uiComp(){return this._uiComp}set uiComp(e){this._uiComp&&e?T(12002):this._uiComp=e}constructor(e){this._uiComp=null,this.opacity=1,this.localOpacity=1,this._uiTransformComp=null,this._node=void 0,this.uiTransformDirty=!0,this._node=e}}let Yv;!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Yv||(Yv=e("SystemEventType",{}))),Fe(Yv),n.SystemEventType=Yv;class Kv{static create(e){A(e&&e.event,1900);const t=e.event;delete e.event;let i=null;if(t===n.EventListener.TOUCH_ONE_BY_ONE?i=new Zv:t===n.EventListener.TOUCH_ALL_AT_ONCE?i=new Jv:t===n.EventListener.MOUSE?i=new Qv:t===n.EventListener.KEYBOARD?i=new ty:t===n.EventListener.ACCELERATION&&(i=new ey(e.callback),delete e.callback),i)for(const t of Object.keys(e))i[t]=e[t];return i}get onEvent(){return this._onEvent}constructor(e,t,i){this._cameraPriority=0,this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}_setPaused(e){this._paused=e}_isPaused(){return this._paused}_setRegistered(e){this._registered=e}_isRegistered(){return this._registered}_getType(){return this._type}_getListenerID(){return this._listenerID}_setFixedPriority(e){this._fixedPriority=e}_getFixedPriority(){return this._fixedPriority}_setSceneGraphPriority(e){this._target=e,this._node=e}_getSceneGraphPriority(){return this._node}checkAvailable(){return null!==this._onEvent}clone(){return null}setEnabled(e){this._isEnabled=e}isEnabled(){return this._isEnabled}}Kv.UNKNOWN=0,Kv.TOUCH_ONE_BY_ONE=1,Kv.TOUCH_ALL_AT_ONCE=2,Kv.KEYBOARD=3,Kv.MOUSE=4,Kv.ACCELERATION=6,Kv.CUSTOM=8,Kv.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};const $v=Kv.ListenerID;class Qv extends Kv{constructor(){super(Kv.MOUSE,$v.MOUSE,null),this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onMouseScroll=null,this._onEvent=e=>this._callback(e)}_callback(e){switch(e.type){case Yv.MOUSE_DOWN:this.onMouseDown&&this.onMouseDown(e);break;case Yv.MOUSE_UP:this.onMouseUp&&this.onMouseUp(e);break;case Yv.MOUSE_MOVE:this.onMouseMove&&this.onMouseMove(e);break;case Yv.MOUSE_WHEEL:this.onMouseScroll&&this.onMouseScroll(e)}}clone(){const e=new Qv;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}checkAvailable(){return!0}}class Zv extends Kv{constructor(){super(Kv.TOUCH_ONE_BY_ONE,$v.TOUCH_ONE_BY_ONE,null),this.swallowTouches=!1,this.onTouchBegan=null,this.onTouchMoved=null,this.onTouchEnded=null,this.onTouchCancelled=null,this._claimedTouches=[]}setSwallowTouches(e){this.swallowTouches=e}isSwallowTouches(){return this.swallowTouches}clone(){const e=new Zv;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}checkAvailable(){return!!this.onTouchBegan||(S(1801),!1)}}class Jv extends Kv{constructor(){super(Kv.TOUCH_ALL_AT_ONCE,$v.TOUCH_ALL_AT_ONCE,null),this.onTouchesBegan=null,this.onTouchesMoved=null,this.onTouchesEnded=null,this.onTouchesCancelled=null}clone(){const e=new Jv;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}checkAvailable(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(S(1802),!1)}}class ey extends Kv{constructor(e){super(Kv.ACCELERATION,$v.ACCELERATION,null),this._onAccelerationEvent=null,this._onEvent=e=>this._callback(e),this._onAccelerationEvent=e}_callback(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}checkAvailable(){return A(this._onAccelerationEvent,1803),!0}clone(){return new ey(this._onAccelerationEvent)}}class ty extends Kv{constructor(){super(Kv.KEYBOARD,$v.KEYBOARD,null),this.onKeyDown=void 0,this.onKeyPressed=void 0,this.onKeyReleased=void 0,this._onEvent=e=>this._callback(e)}_callback(e){var t,i;switch(e.type){case Yv.KEY_DOWN:null===(t=this.onKeyPressed)||void 0===t||t.call(this,e.keyCode,e);break;case Yv.KEY_UP:null===(i=this.onKeyReleased)||void 0===i||i.call(this,e.keyCode,e)}}clone(){const e=new ty;return e.onKeyDown=this.onKeyDown,e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}checkAvailable(){return null!==this.onKeyDown||null!==this.onKeyPressed||null!==this.onKeyReleased||(S(1800),!1)}}n.EventListener=Kv;const iy=Kv.ListenerID,ny=[Yv.TOUCH_START,Yv.TOUCH_MOVE,Yv.TOUCH_END,Yv.TOUCH_CANCEL],sy=[Yv.MOUSE_DOWN,Yv.MOUSE_MOVE,Yv.MOUSE_UP,Yv.MOUSE_WHEEL],oy=[Yv.KEY_DOWN,Yv.KEY_UP];class ry{constructor(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}size(){return this._fixedListeners.length+this._sceneGraphListeners.length}empty(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}push(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}clearSceneGraphListeners(){this._sceneGraphListeners.length=0}clearFixedListeners(){this._fixedListeners.length=0}clear(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}getFixedPriorityListeners(){return this._fixedListeners}getSceneGraphPriorityListeners(){return this._sceneGraphListeners}}const ay=new class{constructor(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners={},this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}pauseTarget(e,t=!1){if(!(e instanceof n._BaseNode))return void T(3506);const i=this._nodeListenersMap[e.uuid];if(i)for(let e=0,t=i.length;e<t;e++){const t=i[e];t._setPaused(!0),t instanceof Zv&&t._claimedTouches.includes(this._currentTouch)&&this._clearCurTouch()}if(!0===t){const t=e.children;if(t)for(let e=0;e<t.length;++e){const i=t[e];this.pauseTarget(i,!0)}}}resumeTarget(e,t=!1){if(!(e instanceof n._BaseNode))return void T(3506);const i=this._nodeListenersMap[e.uuid];if(i)for(let e=0;e<i.length;++e)i[e]._setPaused(!1);if(this._setDirtyForNode(e),!0===t&&e.children.length>0){const t=e.children;if(t)for(let e=0;e<t.length;++e){const i=t[e];this.resumeTarget(i,!0)}}}frameUpdateListeners(){const e=this._listenersMap,t=this._priorityDirtyFlagMap;for(const i in e)e[i].empty()&&(delete t[i],delete e[i]);const i=this._toAddedListeners;if(0!==i.length){for(let e=0,t=i.length;e<t;e++)this._forceAddEventListener(i[e]);i.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}hasEventListener(e){return!!this._getListeners(e)}addListener(e,t){if(A(e&&t,3503),!(n.js.isNumber(t)||t instanceof n._BaseNode))return T(3506),null;if(e instanceof n.EventListener){if(e._isRegistered())return S(3505),null}else A(!n.js.isNumber(t),3504),e=n.EventListener.create(e);if(!e.checkAvailable())return null;if(n.js.isNumber(t)){if(0===t)return S(3500),null;e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(i=t)||!i.getComponent("cc.UITransform"))return S(3512),null;e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var i;return e}addCustomListener(e,t){const i=Kv.create({event:n.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}removeListener(e){if(null==e)return;let t=!1;const i=this._listenersMap;e===this._currentTouchListener&&(this._currentTouchListener=this._currentTouch=null);for(const n in i){const s=i[n],o=s.getFixedPriorityListeners(),r=s.getSceneGraphPriorityListeners();if(t=this._removeListenerInVector(r,e),t?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(o,e),t&&this._setDirty(e._getListenerID(),1)),s.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t){const t=this._toAddedListeners;for(let i=t.length-1;i>=0;i--){const s=t[i];if(s===e){n.js.array.removeAt(t,i),s._setRegistered(!1);break}}}}removeListeners(e,t=!1){if(n.js.isNumber(e)||e instanceof n._BaseNode)if(void 0!==e._id){const i=this._nodeListenersMap[e._id];if(i){const t=n.js.array.copy(i);for(let e=0;e<t.length;++e){const i=t[e];this.removeListener(i)}delete this._nodeListenersMap[e._id]}const s=this._toAddedListeners;for(let t=0;t<s.length;){const i=s[t];i._getSceneGraphPriority()===e?(i._setSceneGraphPriority(null),i._setRegistered(!1),s.splice(t,1)):++t}if(!0===t){const t=e.getChildren();for(let e=0;e<t.length;++e){const i=t[e];this.removeListeners(i,!0)}}}else e===n.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(iy.TOUCH_ONE_BY_ONE):e===n.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(iy.TOUCH_ALL_AT_ONCE):e===n.EventListener.MOUSE?this._removeListenersForListenerID(iy.MOUSE):e===n.EventListener.ACCELERATION?this._removeListenersForListenerID(iy.ACCELERATION):e===n.EventListener.KEYBOARD?this._removeListenersForListenerID(iy.KEYBOARD):S(3501);else T(3506)}removeCustomListeners(e){this._removeListenersForListenerID(e)}removeAllListeners(){const e=this._listenersMap,t=this._internalCustomListenerIDs;for(const i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}setPriority(e,t){if(null==e)return;const i=this._listenersMap;for(const n in i){const s=i[n].getFixedPriorityListeners();if(s&&-1!==s.indexOf(e))return null!=e._getSceneGraphPriority()&&S(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}setEnabled(e){this._isEnabled=e}isEnabled(){return this._isEnabled}dispatchEvent(e){if(!this._isEnabled)return;if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,!e||!e.getType)return void C(3511);if(ny.includes(e.getType()))return this._dispatchTouchEvent(e),void this._inDispatch--;const t=function(e){const t=e.type;return t===Yv.DEVICEMOTION?iy.ACCELERATION:oy.includes(t)?iy.KEYBOARD:sy.includes(t)?iy.MOUSE:(ny.includes(t)&&S(2e3),"")}(e);this._sortEventListeners(t);const i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}_onListenerCallback(e,t){t.currentTarget=e._target;const i=e.onEvent;return i&&i(t),t.isStopped()}dispatchCustomEvent(e,t){const i=new n.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}_setDirtyForNode(e){const t=this._nodeListenersMap[e._id];if(void 0!==t)for(let e=0,i=t.length;e<i;e++){const i=t[e]._getListenerID();this._dirtyListeners[i]||(this._dirtyListeners[i]=!0)}if(e.children.length>0){const t=e.children;for(let e=0,i=t?t.length:0;e<i;e++)this._setDirtyForNode(t[e])}}_addListener(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}_forceAddEventListener(e){const t=e._getListenerID();let i=this._listenersMap[t];if(i||(i=new ry,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);const i=e._getSceneGraphPriority();null===i&&S(3507),this._associateNodeAndEventListener(i,e),i.activeInHierarchy&&this.resumeTarget(i)}else this._setDirty(t,1)}_getListeners(e){return this._listenersMap[e]}_updateDirtyFlagForSceneGraph(){const e=this._dirtyListeners;for(const t in e)this._setDirty(t,2),e[t]=!1}_removeAllListenersInVector(e){if(!e)return;let t;for(let i=e.length-1;i>=0;i--)t=e[i],t._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&n.js.array.removeAt(e,i)}_removeListenersForListenerID(e){const t=this._listenersMap[e];if(t){const i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}const i=this._toAddedListeners;for(let t=i.length-1;t>=0;t--){const s=i[t];s&&s._getListenerID()===e&&n.js.array.removeAt(i,t)}}_sortEventListeners(e){let t=0;const i=this._priorityDirtyFlagMap;i[e]&&(t=i[e]),0!==t&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t)&&n.director.getScene()&&this._sortListenersOfSceneGraphPriority(e)}_sortListenersOfSceneGraphPriority(e){const t=this._getListeners(e);if(!t)return;const i=t.getSceneGraphPriorityListeners();if(!i||0===i.length)return;const n=t.getSceneGraphPriorityListeners();n.forEach((e=>{const t=e._getSceneGraphPriority(),i=null==t?void 0:t._uiProps.uiTransformComp;e._cameraPriority=i?i.cameraPriority:0})),n.sort(this._sortEventListenersOfSceneGraphPriorityDes)}_sortEventListenersOfSceneGraphPriorityDes(e,t){const i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;let s=i,o=n,r=!1;if(e._cameraPriority!==t._cameraPriority)return t._cameraPriority-e._cameraPriority;for(;s.parent._id!==o.parent._id;)s=null===s.parent.parent?(r=!0)&&n:s.parent,o=null===o.parent.parent?(r=!0)&&i:o.parent;if(s._id===o._id){if(s._id===n._id)return-1;if(s._id===i._id)return 1}const a=s.getSiblingIndex(),c=o.getSiblingIndex();return r?a-c:c-a}_sortListenersOfFixedPriority(e){const t=this._listenersMap[e];if(!t)return;const i=t.getFixedPriorityListeners();if(!i||0===i.length)return;i.sort(this._sortListenersOfFixedPriorityAsc);let n=0;for(const e=i.length;n<e&&!(i[n]._getFixedPriority()>=0);)++n;t.gt0Index=n}_sortListenersOfFixedPriorityAsc(e,t){return e._getFixedPriority()-t._getFixedPriority()}_onUpdateListeners(e){const t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),s=this._toRemovedListeners;if(i)for(let e=i.length-1;e>=0;e--){const t=i[e];if(!t._isRegistered()){n.js.array.removeAt(i,e);const o=s.indexOf(t);-1!==o&&s.splice(o,1)}}if(t)for(let e=t.length-1;e>=0;e--){const i=t[e];if(!i._isRegistered()){n.js.array.removeAt(t,e);const o=s.indexOf(i);-1!==o&&s.splice(o,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}_updateTouchListeners(e){const t=this._inDispatch;if(A(t>0,3508),t>1)return;let i;i=this._listenersMap[iy.TOUCH_ONE_BY_ONE],i&&this._onUpdateListeners(i),i=this._listenersMap[iy.TOUCH_ALL_AT_ONCE],i&&this._onUpdateListeners(i),A(1===t,3509);const n=this._toAddedListeners;if(0!==n.length){for(let e=0,t=n.length;e<t;e++)this._forceAddEventListener(n[e]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}_cleanToRemovedListeners(){const e=this._toRemovedListeners;for(let t=0;t<e.length;++t){const i=e[t],n=this._listenersMap[i._getListenerID()];if(!n)continue;const s=n.getFixedPriorityListeners(),o=n.getSceneGraphPriorityListeners();if(o){const e=o.indexOf(i);-1!==e&&o.splice(e,1)}if(s){const e=s.indexOf(i);-1!==e&&s.splice(e,1)}}e.length=0}_onTouchEventCallback(e,t){if(!e._isRegistered())return!1;const i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();let s=!1,o=-1;const r=i.type;if(r===Yv.TOUCH_START){if(!Ge.ENABLE_MULTI_TOUCH&&ay._currentTouch){const e=ay._currentTouchListener._node;if(!e||e.activeInHierarchy)return!1}e.onTouchBegan&&(s=e.onTouchBegan(n,i),s&&e._isRegistered()&&!e._isPaused()&&(e._claimedTouches.push(n),!Ge.ENABLE_MULTI_TOUCH&&ay._currentTouch||(ay._currentTouch=n),ay._currentTouchListener=e))}else if(e._claimedTouches.length>0&&(o=e._claimedTouches.indexOf(n),-1!==o)){if(s=!0,!Ge.ENABLE_MULTI_TOUCH&&ay._currentTouch&&ay._currentTouch!==n)return!1;r===Yv.TOUCH_MOVE&&e.onTouchMoved?e.onTouchMoved(n,i):r===Yv.TOUCH_END?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(o,1),(Ge.ENABLE_MULTI_TOUCH||ay._currentTouch===n)&&(ay._currentTouch=null),ay._currentTouchListener=null):r===Yv.TOUCH_CANCEL&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(o,1),(Ge.ENABLE_MULTI_TOUCH||ay._currentTouch===n)&&(ay._currentTouch=null),ay._currentTouchListener=null)}return i.isStopped()?(ay._updateTouchListeners(i),!0):!!(s&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}_dispatchTouchEvent(e){this._sortEventListeners(iy.TOUCH_ONE_BY_ONE),this._sortEventListeners(iy.TOUCH_ALL_AT_ONCE);const t=this._getListeners(iy.TOUCH_ONE_BY_ONE),i=this._getListeners(iy.TOUCH_ALL_AT_ONCE);if(null===t&&null===i)return;const s=e.getTouches(),o=n.js.array.copy(s),r={event:e,needsMutableSet:t&&i,touches:o,selTouch:null};if(t)for(let i=0;i<s.length;++i){const n=s[i];e.touch=n,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,r)}i&&o.length>0&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:o}),e.isStopped())||this._updateTouchListeners(e)}_onTouchesEventCallback(e,t){if(!e._isRegistered())return!1;const i=t.event,n=t.touches,s=i.type;return i.currentTarget=e._getSceneGraphPriority(),s===Yv.TOUCH_START&&e.onTouchesBegan?e.onTouchesBegan(n,i):s===Yv.TOUCH_MOVE&&e.onTouchesMoved?e.onTouchesMoved(n,i):s===Yv.TOUCH_END&&e.onTouchesEnded?e.onTouchesEnded(n,i):s===Yv.TOUCH_CANCEL&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(ay._updateTouchListeners(i),!0)}_associateNodeAndEventListener(e,t){let i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}_dissociateNodeAndEventListener(e,t){const i=this._nodeListenersMap[e.uuid];i&&(n.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}_dispatchEventToListeners(e,t,i){let n=!1;const s=e.getFixedPriorityListeners(),o=e.getSceneGraphPriorityListeners();let r=0;if(s&&0!==s.length)for(;r<e.gt0Index;++r){const e=s[r];if(e.isEnabled()&&!e._isPaused()&&e._isRegistered()&&t(e,i)){n=!0;break}}if(o&&!n)for(let e=0;e<o.length;++e){const s=o[e];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&t(s,i)){n=!0;break}}if(s&&!n)for(;r<s.length;++r){const e=s[r];if(e.isEnabled()&&!e._isPaused()&&e._isRegistered()&&t(e,i)){n=!0;break}}}_setDirty(e,t){const i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]|=t}_sortNumberAsc(e,t){return e-t}_clearCurTouch(){this._currentTouchListener=null,this._currentTouch=null}_removeListenerInCallback(e,t){if(null==e)return!1;for(let i=e.length-1;i>=0;i--){const s=e[i];if(s._onCustomEvent===t||s.onEvent===t)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?n.js.array.removeAt(e,i):this._toRemovedListeners.push(s),!0}return!1}_removeListenerInVector(e,t){if(null==e)return!1;for(let i=e.length-1;i>=0;i--){const s=e[i];if(s===t)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?n.js.array.removeAt(e,i):this._toRemovedListeners.push(s),!0}return!1}};let cy;var ly,hy,uy,_y,py,dy,fy,my,gy;Ot.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(cy||(cy={}));const vy=Ot.Flags.Destroying,yy=Ot.Flags.DontDestroy,xy=Ot.Flags.Deactivating,Sy=new X("Node");function by(e){return e?"string"==typeof e?Re(e):e:(C(3804),null)}let Ty=e("BaseNode",Wc("cc.BaseNode")((gy=my=class e extends Ot{get components(){return this._components}get _persistNode(){return(this._objFlags&yy)>0}set _persistNode(e){e?this._objFlags|=yy:this._objFlags&=~yy}get name(){return this._name}set name(e){this._name=e}get uuid(){return this._id}get children(){return this._children}get active(){return this._active}set active(e){if(this._active!==e){this._active=e;const t=this._parent;t&&t._activeInHierarchy&&n.director._nodeActivator.activateNode(this,e)}}get activeInHierarchy(){return this._activeInHierarchy}get parent(){return this._parent}set parent(e){this.setParent(e)}get scene(){return this._scene}get eventProcessor(){return this._eventProcessor}static _setScene(e){e._updateScene()}static _findComponent(e,t){const i=t,n=e._components;if(i._sealed)for(let e=0;e<n.length;++e){const i=n[e];if(i.constructor===t)return i}else for(let e=0;e<n.length;++e){const i=n[e];if(i instanceof t)return i}return null}static _findComponents(e,t,i){const n=t,s=e._components;if(n._sealed)for(let e=0;e<s.length;++e){const n=s[e];n.constructor===t&&i.push(n)}else for(let e=0;e<s.length;++e){const n=s[e];n instanceof t&&i.push(n)}}static _findChildComponent(t,i){for(let n=0;n<t.length;++n){const s=t[n];let o=e._findComponent(s,i);if(o)return o;if(s._children.length>0&&(o=e._findChildComponent(s._children,i),o))return o}return null}static _findChildComponents(t,i,n){for(let s=0;s<t.length;++s){const o=t[s];e._findComponents(o,i,n),o._children.length>0&&e._findChildComponents(o._children,i,n)}}_updateScene(){null==this._parent?d("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene}constructor(e){super(e),Mc(this,"_parent",uy,this),Mc(this,"_children",_y,this),Mc(this,"_active",py,this),Mc(this,"_components",dy,this),Mc(this,"_prefab",fy,this),this._scene=null,this._activeInHierarchy=!1,this._id=Sy.getNewId(),this._name=void 0,this._eventProcessor=new n.NodeEventProcessor(this),this._eventMask=0,this._siblingIndex=0,this._originalSceneId="",this._registerIfAttached=void 0,this._name=void 0!==e?e:"New Node"}attr(e){fe(this,e)}getParent(){return this._parent}setParent(e,t=!1){if(this._parent===e)return;const i=this._parent,n=e;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(cy.PARENT_CHANGED,i),i&&!(i._objFlags&vy)){const e=i._children.indexOf(this);i._children.splice(e,1),i._updateSiblingIndex(),i.emit&&i.emit(cy.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(cy.CHILD_ADDED,this)),this._onHierarchyChanged(i)}getChildByUuid(e){if(!e)return _("Invalid uuid"),null;const t=this._children;for(let i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}getChildByName(e){if(!e)return _("Invalid name"),null;const t=this._children;for(let i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}getChildByPath(e){const t=e.split("/");let i=this;for(let e=0;e<t.length;++e){const n=t[e];if(0===n.length)continue;const s=i.children.find((e=>e.name===n));if(!s)return null;i=s}return i}addChild(e){e.setParent(this)}insertChild(e,t){e.parent=this,e.setSiblingIndex(t)}getSiblingIndex(){return this._siblingIndex}setSiblingIndex(e){if(!this._parent)return;if(this._parent._objFlags&xy)return void C(3821);const t=this._parent._children;e=-1!==e?e:t.length-1;const i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}walk(t,i){let n=1,s=null,o=null,r=0,a=e._stacks[e._stackId];a||(a=[],e._stacks.push(a)),e._stackId++,a.length=0,a[0]=this;let c=null,l=!1;for(;n;)if(n--,o=a[n],o)if(!l&&t?t(o):l&&i&&i(o),a[n]=null,l){if(c===this._parent)break;if(l=!1,s)if(r++,s[r])a[n]=s[r],n++;else if(c&&(a[n]=c,n++,l=!0,c._parent?(s=c._parent._children,r=s.indexOf(c),c=c._parent):(c=null,s=null),r<0))break}else o._children.length>0?(c=o,s=o._children,r=0,a[n]=s[r],n++):(a[n]=o,n++,l=!0);a.length=0,e._stackId--}removeFromParent(){this._parent&&this._parent.removeChild(this)}removeChild(e){this._children.indexOf(e)>-1&&(e.parent=null)}removeAllChildren(){const e=this._children;for(let t=e.length-1;t>=0;t--){const i=e[t];i&&(i.parent=null)}this._children.length=0}isChildOf(e){let t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}getComponent(t){const i=by(t);return i?e._findComponent(this,i):null}getComponents(t){const i=by(t),n=[];return i&&e._findComponents(this,i,n),n}getComponentInChildren(t){const i=by(t);return i?e._findChildComponent(this._children,i):null}getComponentsInChildren(t){const i=by(t),n=[];return i&&(e._findComponents(this,i,n),e._findChildComponents(this._children,i,n)),n}addComponent(e){let t;if("string"==typeof e){if(t=Re(e),!t)throw n._RF.peek()&&C(3808,e),TypeError(R(3807,e))}else{if(!e)throw TypeError(R(3804));t=e}if("function"!=typeof t)throw TypeError(R(3809));if(!ve(t,n.Component))throw TypeError(R(3810));const i=t._requireComponent;i&&!this.getComponent(i)&&this.addComponent(i);const s=new t;return s.node=this,this._components.push(s),this._activeInHierarchy&&n.director._nodeActivator.activateComp(s),s}removeComponent(e){if(!e)return void C(3813);let t=null;t=e instanceof Gh?e:this.getComponent(e),t&&t.destroy()}on(e,t,i,n=!1){switch(e){case cy.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}off(e,t,i,n=!1){if(this._eventProcessor.off(e,t,i,n),!this._eventProcessor.hasEventListener(e))switch(e){case cy.TRANSFORM_CHANGED:this._eventMask&=-2}}once(e,t,i,n){this._eventProcessor.once(e,t,i,n)}emit(e,t,i,n,s,o){this._eventProcessor.emit(e,t,i,n,s,o)}dispatchEvent(e){this._eventProcessor.dispatchEvent(e)}hasEventListener(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)}targetOff(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(cy.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}destroy(){return!!super.destroy()&&(this.active=!1,!0)}destroyAllChildren(){const e=this._children;for(let t=0;t<e.length;++t)e[t].destroy()}_removeComponent(e){if(e){if(!(this._objFlags&vy)){const t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&C(3815)}}else C(3814)}_updateSiblingIndex(){for(let e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(cy.SIBLING_ORDER_CHANGED)}_onSetParent(t,i=!1){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(e._setScene))}_onPostActivated(e){}_onBatchCreated(e){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}_onPreDestroy(){this._onPreDestroyBase()}_onHierarchyChanged(e){return this._onHierarchyChangedBase(e)}_instantiate(e,t){return e||(e=n.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e}_onHierarchyChangedBase(e){const t=this._parent;!this._persistNode||t instanceof n.Scene||n.game.removePersistRootNode(this);const i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&n.director._nodeActivator.activateNode(this,i)}_onPreDestroyBase(){this._objFlags|=vy;const e=this._parent,t=!!e&&0!=(e._objFlags&vy);if(this._persistNode&&n.game.removePersistRootNode(this),!t&&e){this.emit(cy.PARENT_CHANGED,this);const t=e._children.indexOf(this);e._children.splice(t,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(cy.CHILD_REMOVED,this)}this.emit(cy.NODE_DESTROYED,this),this._eventProcessor.destroy();const i=this._children;for(let e=0;e<i.length;++e)i[e]._destroyImmediate();const s=this._components;for(let e=0;e<s.length;++e)s[e]._destroyImmediate();return t}},my.idGenerator=Sy,my._stacks=[[]],my._stackId=0,Oc((hy=gy).prototype,"_persistNode",[Kc],Object.getOwnPropertyDescriptor(hy.prototype,"_persistNode"),hy.prototype),Oc(hy.prototype,"name",[cl],Object.getOwnPropertyDescriptor(hy.prototype,"name"),hy.prototype),Oc(hy.prototype,"children",[cl],Object.getOwnPropertyDescriptor(hy.prototype,"children"),hy.prototype),Oc(hy.prototype,"active",[cl],Object.getOwnPropertyDescriptor(hy.prototype,"active"),hy.prototype),Oc(hy.prototype,"activeInHierarchy",[cl],Object.getOwnPropertyDescriptor(hy.prototype,"activeInHierarchy"),hy.prototype),Oc(hy.prototype,"parent",[cl],Object.getOwnPropertyDescriptor(hy.prototype,"parent"),hy.prototype),uy=Oc(hy.prototype,"_parent",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_y=Oc(hy.prototype,"_children",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),py=Oc(hy.prototype,"_active",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dy=Oc(hy.prototype,"_components",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fy=Oc(hy.prototype,"_prefab",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ly=hy))||ly);function Ey(e){const t=e._prefab;if(!t)return;if(!t.instance)return;if(!t.asset)return C(3701,e.name),void(t.instance=void 0);const i=e._objFlags,s=e._parent,o=e._id,r=e._prefab;e[Rt],n.game._isCloning=!0,t.asset._doInstantiate(e),n.game._isCloning=!1,e._objFlags=i,e._parent=s,e._id=o,e._prefab&&(e._prefab.instance=null==r?void 0:r.instance)}function Cy(e,t,i){var n;if(!t)return;let s=t;const o=null===(n=e._prefab)||void 0===n?void 0:n.instance;!i&&o&&(t[o.fileId]={},s=t[o.fileId]);const r=e._prefab;r&&(s[r.fileId]=e);const a=e.components;for(let e=0;e<a.length;e++){const t=a[e];t.__prefab&&(s[t.__prefab.fileId]=t)}for(let t=0;t<e.children.length;t++)Cy(e.children[t],s,!1)}function wy(e,t){if(!e)return null;let i=null,n=t;for(let t=0;t<e.length;t++){if(!n)return null;n=n[e[t]]}return i=n,i}function Ay(e,t,i){if(t)for(let e=0;e<t.length;e++){const n=t[e];if(n&&n.targetInfo){const e=wy(n.targetInfo.localID,i);if(!e)continue;let t=i;const s=n.targetInfo.localID;if(s.length>0)for(let e=0;e<s.length-1;e++)t=t[s[e]];if(n.nodes)for(let i=0;i<n.nodes.length;i++){const s=n.nodes[i];s&&(e._children.push(s),s._parent=e,Cy(s,t,!1),s._siblingIndex=e._children.length-1,s._onBatchCreated(!1))}}}}function Py(e,t,i){if(t)for(let e=0;e<t.length;e++){const n=t[e];if(n&&n.targetInfo){const e=wy(n.targetInfo.localID,i);if(!e)continue;if(n.components)for(let t=0;t<n.components.length;t++){const i=n.components[t];i&&(i.node=e,e._components.push(i))}}}}function Ry(e,t,i){if(t)for(let e=0;e<t.length;e++){const n=t[e];if(n){const e=wy(n.localID,i);if(!e||!e.node)continue;const t=e.node.components.indexOf(e);t>=0&&e.node._components.splice(t,1)}}}function Iy(e,t,i){if(t.length<=0)return;let n=null;for(let e=0;e<t.length;e++){const s=t[e];if(s&&s.targetInfo){if(n=wy(s.targetInfo.localID,i),!n)continue;let e=n;const t=s.propertyPath.slice();if(t.length>0){const i=t.pop();if(!i)continue;for(let i=0;i<t.length&&(e=e[t[i]],e);i++);if(!e)continue;if(Array.isArray(e))if("length"===i)e[i]=s.value;else{const t=Number.parseInt(i);Number.isInteger(t)&&t<e.length&&(e[i]=s.value)}else e[i]instanceof Ue?e[i].set(s.value):e[i]=s.value}}}}function My(e){var t;const i=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(i)for(let e=0;e<i.length;e++){var n,s;const t=i[e];let a=t.source;const c=t.sourceInfo;if(c){var o,r;const e=null===(o=t.source)||void 0===o||null===(r=o._prefab)||void 0===r?void 0:r.instance;e&&e.targetMap&&(a=wy(c.localID,e.targetMap))}if(!a)continue;let l=null;const h=t.targetInfo;if(!h)continue;const u=null===(n=t.target)||void 0===n||null===(s=n._prefab)||void 0===s?void 0:s.instance;if(!u||!u.targetMap)continue;if(l=wy(h.localID,u.targetMap),!l)continue;const _=t.propertyPath.slice();let p=a;if(_.length>0){const e=_.pop();if(!e)return;for(let e=0;e<_.length&&(p=p[_[e]],p);e++);if(!p)continue;p[e]=l}}}var Oy,Dy,Ny,Ly,By,zy,Fy,Uy,Gy,ky,Hy;n._BaseNode=Ty;const Vy=new zi,jy=new ji,Wy=new ji,qy=new ji,Xy=new ki,Yy=new ki,Ky=new Zi,$y=[],Qy=[],Zy=[];class Jy{constructor(){this._chunks=[],this._freelists=[],this._createChunk()}alloc(){const e=this._freelists.length;for(let t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)}free(e,t){const i=this._freelists.length;for(let n=0;n<i;++n)if(this._chunks[n]===e)return void this._freelists[n].push(t)}clear(){const e=this._chunks.length;for(let t=0;t<e;++t)this._chunks[t].fill(0)}_createChunk(){this._chunks.push(new Uint32Array(Jy.CAPACITY_PER_CHUNK));const e=[];for(let t=Jy.CAPACITY_PER_CHUNK-1;t>=0;t--)e.push(t);this._freelists.push(e)}_createView(e){return Zy[0]=this._chunks[e],Zy[1]=this._freelists[e].pop(),Zy}}Jy.CAPACITY_PER_CHUNK=256;const ex=new Jy,tx=Symbol("ReserveContentsForAllSyncablePrefab");let ix=e("Node",(Oy=Wc("cc.Node"),Dy=Al(zi),Oy((Hy=ky=class e extends Ty{get _dirtyFlags(){return this._dirtyFlagsPri}set _dirtyFlags(e){this._dirtyFlagsPri=e,this._nativeDirtyFlag[0]=e}_init(){const[e,t]=ex.alloc();this._hasChangedFlagsChunk=e,this._hasChangedFlagsOffset=t;const i=new Uint32Array(e.buffer,e.byteOffset+4*t,1);this._hasChangedFlags=i,this._nodeHandle=oc.alloc(),this._pos=new zi(oc.getTypedArray(this._nodeHandle,ic.WORLD_POSITION)),this._rot=new ji(oc.getTypedArray(this._nodeHandle,ic.WORLD_ROTATION)),this._scale=new zi(oc.getTypedArray(this._nodeHandle,ic.WORLD_SCALE)),this._lpos=new zi(oc.getTypedArray(this._nodeHandle,ic.LOCAL_POSITION)),this._lrot=new ji(oc.getTypedArray(this._nodeHandle,ic.LOCAL_ROTATION)),this._lscale=new zi(oc.getTypedArray(this._nodeHandle,ic.LOCAL_SCALE)),this._mat=new Zi(oc.getTypedArray(this._nodeHandle,ic.WORLD_MATRIX)),this._nativeLayer=oc.getTypedArray(this._nodeHandle,ic.LAYER),this._nativeDirtyFlag=oc.getTypedArray(this._nodeHandle,ic.DIRTY_FLAG),this._scale.set(1,1,1),this._lscale.set(1,1,1),this._nativeLayer[0]=this._layer,this._nativeObj=new zn,this._nativeObj.initWithData(oc.getBuffer(this._nodeHandle),i,Qy)}constructor(e){super(e),this._uiProps=new Xv(this),this._static=!1,Mc(this,"_lpos",By,this),Mc(this,"_lrot",zy,this),Mc(this,"_lscale",Fy,this),Mc(this,"_layer",Uy,this),Mc(this,"_euler",Gy,this),this._dirtyFlagsPri=Cg.NONE,this._eulerDirty=!1,this._nodeHandle=0,this._init()}static isNode(t){return t instanceof e&&(t.constructor===e||!(t instanceof n.Scene))}_onPreDestroy(){const e=this._onPreDestroyBase();return this._nodeHandle&&(oc.free(this._nodeHandle),this._nodeHandle=0),this._nativeObj=null,ex.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e}get native(){return this._nativeObj}get position(){return this._lpos}set position(e){this.setPosition(e)}get worldPosition(){return this.updateWorldTransform(),this._pos}set worldPosition(e){this.setWorldPosition(e)}get rotation(){return this._lrot}set rotation(e){this.setRotation(e)}set eulerAngles(e){this.setRotationFromEuler(e.x,e.y,e.z)}get eulerAngles(){return this._eulerDirty&&(ji.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}get angle(){return this._euler.z}set angle(e){zi.set(this._euler,0,0,e),ji.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(Cg.ROTATION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.ROTATION)}get worldRotation(){return this.updateWorldTransform(),this._rot}set worldRotation(e){this.setWorldRotation(e)}get scale(){return this._lscale}set scale(e){this.setScale(e)}get worldScale(){return this.updateWorldTransform(),this._scale}set worldScale(e){this.setWorldScale(e)}set matrix(e){Zi.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Cg.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.TRS)}get worldMatrix(){return this.updateWorldTransform(),this._mat}get forward(){return zi.transformQuat(new zi,zi.FORWARD,this.worldRotation)}set forward(e){const t=e.length();zi.multiplyScalar(Vy,e,-1/t),ji.fromViewUp(jy,Vy),this.setWorldRotation(jy)}get up(){return zi.transformQuat(new zi,zi.UP,this.worldRotation)}get right(){return zi.transformQuat(new zi,zi.RIGHT,this.worldRotation)}set layer(e){this._layer=e,this._nativeLayer[0]=this._layer,this.emit(cy.LAYER_CHANGED,this._layer)}get layer(){return this._layer}get hasChangedFlags(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]}set hasChangedFlags(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}[qh](e,t){e.writeThis()}setParent(e,t=!1){t&&this.updateWorldTransform(),super.setParent(e,t),this._nativeObj.setParent(this.parent?this.parent.native:null)}_onSetParent(e,t){if(super._onSetParent(e,t),t){const e=this._parent;e?(e.updateWorldTransform(),Zi.multiply(Ky,Zi.invert(Ky,e._mat),this._mat),Zi.toRTS(Ky,this._lrot,this._lpos,this._lscale)):(zi.copy(this._lpos,this._pos),ji.copy(this._lrot,this._rot),zi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Cg.TRS)}_onHierarchyChanged(e){this.eventProcessor.reattach(),super._onHierarchyChangedBase(e)}_onBatchCreated(e){var t,i;this._nativeLayer[0]=this._layer,this._nativeObj.setParent(null===(i=this.parent)||void 0===i?void 0:i.native);const n=null===(t=this._prefab)||void 0===t?void 0:t.instance;!e&&n&&Ey(this),this.hasChangedFlags=Cg.TRS,this._dirtyFlags|=Cg.TRS,this._uiProps.uiTransformDirty=!0;const s=this._children.length;for(let t=0;t<s;++t)this._children[t]._siblingIndex=t,this._children[t]._onBatchCreated(e);if(!e&&n){const e={};n.targetMap=e,Cy(this,e,!0),Ay(0,n.mountedChildren,e),Ry(0,n.removedComponents,e),Py(0,n.mountedComponents,e),Iy(0,n.propertyOverrides,e)}My(this)}_onBeforeSerialize(){this.eulerAngles}_onPostActivated(e){e?(ay.resumeTarget(this),this.invalidateChildren(Cg.TRS)):ay.pauseTarget(this)}translate(e,t){const i=t||Eg.LOCAL;if(i===Eg.LOCAL)zi.transformQuat(Vy,e,this._lrot),this._lpos.x+=Vy.x,this._lpos.y+=Vy.y,this._lpos.z+=Vy.z;else if(i===Eg.WORLD)if(this._parent){ji.invert(jy,this._parent.worldRotation),zi.transformQuat(Vy,e,jy);const t=this.worldScale;this._lpos.x+=Vy.x/t.x,this._lpos.y+=Vy.y/t.y,this._lpos.z+=Vy.z/t.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Cg.POSITION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.POSITION)}rotate(e,t){const i=t||Eg.LOCAL;if(ji.normalize(jy,e),i===Eg.LOCAL)ji.multiply(this._lrot,this._lrot,jy);else if(i===Eg.WORLD){const e=this.worldRotation;ji.multiply(Wy,jy,e),ji.invert(jy,e),ji.multiply(Wy,jy,Wy),ji.multiply(this._lrot,this._lrot,Wy)}this._eulerDirty=!0,this.invalidateChildren(Cg.ROTATION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.ROTATION)}lookAt(e,t){this.getWorldPosition(Vy),zi.subtract(Vy,Vy,e),zi.normalize(Vy,Vy),ji.fromViewUp(jy,Vy,t),this.setWorldRotation(jy)}_setDirtyNode(e,t){$y[e]=t,Qy[e]=t.native}invalidateChildren(e){let t,i,n,s=0,o=0,r=0,a=0,c=0;const l=e|Cg.POSITION;for($y[0]=this,Qy[0]=this.native;s>=0;){if(t=$y[s--],c=t._hasChangedFlags[0],a=t._dirtyFlagsPri,t.isValid&&(a&c&e)!==e)for(a|=e,t._dirtyFlagsPri=a,t._nativeDirtyFlag[0]=a,t._uiProps.uiTransformDirty=!0,t._hasChangedFlags[0]=c|e,n=t._children,r=n.length,o=0;o<r;o++)i=n[o],$y[++s]=i,Qy[s]=i.native;e=l}}updateWorldTransform(){if(!this._dirtyFlags)return;let e,t=this,i=0;for(;t&&t._dirtyFlags;)this._setDirtyNode(i++,t),t=t._parent;let n=0;for(;i;)e=$y[--i],n|=e._dirtyFlags,t?(n&Cg.POSITION&&(zi.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Cg.RS&&(Zi.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Zi.multiply(e._mat,t._mat,e._mat),n&Cg.ROTATION&&ji.multiply(e._rot,t._rot,e._lrot),ki.fromQuat(Xy,ji.conjugate(qy,e._rot)),ki.multiplyMat4(Xy,Xy,e._mat),e._scale.x=Xy.m00,e._scale.y=Xy.m04,e._scale.z=Xy.m08)):(n&Cg.POSITION&&(zi.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Cg.RS&&(n&Cg.ROTATION&&ji.copy(e._rot,e._lrot),n&Cg.SCALE&&(zi.copy(e._scale,e._lscale),Zi.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=Cg.NONE,t=e}setPosition(e,t,i){void 0===t&&void 0===i?zi.copy(this._lpos,e):void 0===i?zi.set(this._lpos,e,t,this._lpos.z):zi.set(this._lpos,e,t,i),this.invalidateChildren(Cg.POSITION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.POSITION)}getPosition(e){return e?zi.set(e,this._lpos.x,this._lpos.y,this._lpos.z):zi.copy(new zi,this._lpos)}setRotation(e,t,i,n){void 0===t||void 0===i||void 0===n?ji.copy(this._lrot,e):ji.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(Cg.ROTATION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.ROTATION)}setRotationFromEuler(e,t,i){const n=void 0===i?this._euler.z:i;void 0===t?(zi.copy(this._euler,e),ji.fromEuler(this._lrot,e.x,e.y,e.z)):(zi.set(this._euler,e,t,n),ji.fromEuler(this._lrot,e,t,n)),this._eulerDirty=!1,this.invalidateChildren(Cg.ROTATION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.ROTATION)}getRotation(e){return e?ji.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):ji.copy(new ji,this._lrot)}setScale(e,t,i){void 0===t&&void 0===i?zi.copy(this._lscale,e):void 0===i?zi.set(this._lscale,e,t,this._lscale.z):zi.set(this._lscale,e,t,i),this.invalidateChildren(Cg.SCALE),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.SCALE)}getScale(e){return e?zi.set(e,this._lscale.x,this._lscale.y,this._lscale.z):zi.copy(new zi,this._lscale)}inverseTransformPoint(e,t){zi.copy(e,t);let i=this,n=0;for(;i._parent;)this._setDirtyNode(n++,i),i=i._parent;for(;n>=0;)zi.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=$y[--n];return e}setWorldPosition(e,t,i){void 0===t||void 0===i?zi.copy(this._pos,e):zi.set(this._pos,e,t,i);const n=this._parent,s=this._lpos;n?(n.updateWorldTransform(),zi.transformMat4(s,this._pos,Zi.invert(Ky,n._mat))):zi.copy(s,this._pos),this.invalidateChildren(Cg.POSITION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.POSITION)}getWorldPosition(e){return this.updateWorldTransform(),e?zi.copy(e,this._pos):zi.copy(new zi,this._pos)}setWorldRotation(e,t,i,n){void 0===t||void 0===i||void 0===n?ji.copy(this._rot,e):ji.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),ji.multiply(this._lrot,ji.conjugate(this._lrot,this._parent._rot),this._rot)):ji.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Cg.ROTATION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.ROTATION)}setWorldRotationFromEuler(e,t,i){ji.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),ji.multiply(this._lrot,ji.conjugate(this._lrot,this._parent._rot),this._rot)):ji.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Cg.ROTATION),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.ROTATION)}getWorldRotation(e){return this.updateWorldTransform(),e?ji.copy(e,this._rot):ji.copy(new ji,this._rot)}setWorldScale(e,t,i){void 0===t||void 0===i?zi.copy(this._scale,e):zi.set(this._scale,e,t,i);const n=this._parent;n?(n.updateWorldTransform(),ki.fromQuat(Xy,ji.conjugate(qy,n._rot)),ki.multiplyMat4(Xy,Xy,n._mat),Yy.m00=this._scale.x,Yy.m04=this._scale.y,Yy.m08=this._scale.z,ki.multiply(Xy,Yy,ki.invert(Xy,Xy)),this._lscale.x=zi.set(Vy,Xy.m00,Xy.m01,Xy.m02).length(),this._lscale.y=zi.set(Vy,Xy.m03,Xy.m04,Xy.m05).length(),this._lscale.z=zi.set(Vy,Xy.m06,Xy.m07,Xy.m08).length()):zi.copy(this._lscale,this._scale),this.invalidateChildren(Cg.SCALE),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,Cg.SCALE)}getWorldScale(e){return this.updateWorldTransform(),e?zi.copy(e,this._scale):zi.copy(new zi,this._scale)}getWorldMatrix(e){this.updateWorldTransform();const t=e||new Zi;return Zi.copy(t,this._mat)}getWorldRS(e){this.updateWorldTransform();const t=e||new Zi;return Zi.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t}getWorldRT(e){this.updateWorldTransform();const t=e||new Zi;return Zi.fromRT(t,this._rot,this._pos)}setRTS(e,t,i){let n=0;e&&(n|=Cg.ROTATION,void 0!==e.w?(ji.copy(this._lrot,e),this._eulerDirty=!0):(zi.copy(this._euler,e),ji.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(zi.copy(this._lpos,t),n|=Cg.POSITION),i&&(zi.copy(this._lscale,i),n|=Cg.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(cy.TRANSFORM_CHANGED,n))}pauseSystemEvents(e){ay.pauseTarget(this,e)}resumeSystemEvents(e){ay.resumeTarget(this,e)}static resetHasChangedFlags(){ex.clear()}static clearNodeArray(){e.ClearFrame<e.ClearRound?e.ClearFrame++:(e.ClearFrame=0,$y.length=0,Qy.length=0)}},ky.EventType=cy,ky.NodeSpace=Eg,ky.TransformDirtyBit=Cg,ky.TransformBit=Cg,ky.reserveContentsForAllSyncablePrefabTag=tx,ky.ClearFrame=0,ky.ClearRound=1e3,By=Oc((Ly=Hy).prototype,"_lpos",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),zy=Oc(Ly.prototype,"_lrot",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ji}}),Fy=Oc(Ly.prototype,"_lscale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1,1)}}),Uy=Oc(Ly.prototype,"_layer",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return id.Enum.DEFAULT}}),Gy=Oc(Ly.prototype,"_euler",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),Oc(Ly.prototype,"eulerAngles",[Dy],Object.getOwnPropertyDescriptor(Ly.prototype,"eulerAngles"),Ly.prototype),Oc(Ly.prototype,"angle",[cl],Object.getOwnPropertyDescriptor(Ly.prototype,"angle"),Ly.prototype),Oc(Ly.prototype,"layer",[cl],Object.getOwnPropertyDescriptor(Ly.prototype,"layer"),Ly.prototype),Ny=Ly))||Ny));var nx,sx,ox,rx,ax,cx,lx,hx,ux,_x,px,dx,fx,mx,gx,vx,yx,xx,Sx,bx,Tx,Ex,Cx,wx,Ax,Px,Rx,Ix,Mx,Ox,Dx,Nx,Lx,Bx,zx,Fx,Ux,Gx,kx,Hx,Vx,jx,Wx,qx,Xx,Yx,Kx,$x,Qx,Zx,Jx,eS,tS,iS,nS,sS,oS,rS,aS,cS,lS,hS,uS,_S;n.Node=ix;let pS=Wc("cc.TargetInfo")((ox=Oc((sx=class{constructor(){Mc(this,"localID",ox,this)}}).prototype,"localID",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nx=sx))||nx,dS=(rx=Wc("cc.TargetOverrideInfo"),ax=Al(Ot),cx=Al(pS),lx=Al(ix),hx=Al(pS),rx((px=Oc((_x=class{constructor(){Mc(this,"source",px,this),Mc(this,"sourceInfo",dx,this),Mc(this,"propertyPath",fx,this),Mc(this,"target",mx,this),Mc(this,"targetInfo",gx,this)}}).prototype,"source",[Qc,ax],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dx=Oc(_x.prototype,"sourceInfo",[Qc,cx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fx=Oc(_x.prototype,"propertyPath",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mx=Oc(_x.prototype,"target",[Qc,lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gx=Oc(_x.prototype,"targetInfo",[Qc,hx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ux=_x))||ux),fS=Wc("cc.CompPrefabInfo")((xx=Oc((yx=class{constructor(){Mc(this,"fileId",xx,this)}}).prototype,"fileId",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vx=yx))||vx,mS=(Sx=Wc("CCPropertyOverrideInfo"),bx=Al(pS),Sx((Cx=Oc((Ex=class{constructor(){Mc(this,"targetInfo",Cx,this),Mc(this,"propertyPath",wx,this),Mc(this,"value",Ax,this)}isTarget(e,t){}}).prototype,"targetInfo",[Qc,bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wx=Oc(Ex.prototype,"propertyPath",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ax=Oc(Ex.prototype,"value",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Tx=Ex))||Tx),gS=(Px=Wc("cc.MountedChildrenInfo"),Rx=Al(pS),Ix=Al([ix]),Px((Dx=Oc((Ox=class{constructor(){Mc(this,"targetInfo",Dx,this),Mc(this,"nodes",Nx,this)}isTarget(e){}}).prototype,"targetInfo",[Qc,Rx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nx=Oc(Ox.prototype,"nodes",[Qc,Ix],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mx=Ox))||Mx),vS=(Lx=Wc("cc.MountedComponentsInfo"),Bx=Al(pS),zx=Al([Gh]),Lx((Gx=Oc((Ux=class{constructor(){Mc(this,"targetInfo",Gx,this),Mc(this,"components",kx,this)}isTarget(e){}}).prototype,"targetInfo",[Qc,Bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kx=Oc(Ux.prototype,"components",[Qc,zx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fx=Ux))||Fx),yS=(Hx=Wc("cc.PrefabInstance"),Vx=Al(ix),jx=Al([gS]),Wx=Al([vS]),qx=Al([mS]),Xx=Al([pS]),Hx(($x=Oc((Kx=class{constructor(){Mc(this,"fileId",$x,this),Mc(this,"prefabRootNode",Qx,this),Mc(this,"mountedChildren",Zx,this),Mc(this,"mountedComponents",Jx,this),Mc(this,"propertyOverrides",eS,this),Mc(this,"removedComponents",tS,this),this.targetMap={}}findPropertyOverride(e,t){}removePropertyOverride(e,t){}}).prototype,"fileId",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Qx=Oc(Kx.prototype,"prefabRootNode",[Qc,Vx],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zx=Oc(Kx.prototype,"mountedChildren",[Qc,jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jx=Oc(Kx.prototype,"mountedComponents",[Qc,Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eS=Oc(Kx.prototype,"propertyOverrides",[Qc,qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tS=Oc(Kx.prototype,"removedComponents",[Qc,Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yx=Kx))||Yx),xS=(iS=Wc("cc.PrefabInfo"),nS=Al(ix),sS=Al(yS),oS=Al([dS]),iS((cS=Oc((aS=class{constructor(){Mc(this,"root",cS,this),Mc(this,"asset",lS,this),Mc(this,"fileId",hS,this),Mc(this,"instance",uS,this),Mc(this,"targetOverrides",_S,this)}}).prototype,"root",[Qc,nS],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lS=Oc(aS.prototype,"asset",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hS=Oc(aS.prototype,"fileId",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uS=Oc(aS.prototype,"instance",[Qc,sS],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_S=Oc(aS.prototype,"targetOverrides",[Qc,oS],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rS=aS))||rS);n._PrefabInfo=xS;var SS,bS,TS,ES,CS,wS,AS=Object.freeze({__proto__:null,TargetInfo:pS,TargetOverrideInfo:dS,CompPrefabInfo:fS,PropertyOverrideInfo:mS,MountedChildrenInfo:gS,MountedComponentsInfo:vS,PrefabInstance:yS,PrefabInfo:xS,createNodeWithPrefab:Ey,generateTargetMap:Cy,getTarget:wy,applyMountedChildren:Ay,applyMountedComponents:Py,applyRemovedComponents:Ry,applyPropertyOverrides:Iy,applyTargetOverrides:My});const PS=Le({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2});let RS=e("Prefab",Wc("cc.Prefab")((wS=CS=class e extends xh{constructor(){super(),Mc(this,"data",TS,this),Mc(this,"optimizationPolicy",ES,this),this._createFunction=void 0,this._instantiatedTimes=void 0,this._createFunction=null,this._instantiatedTimes=0}createNode(e){const t=n.instantiate(this);t.name=this.name,e(null,t)}compileCreateFunction(){this._createFunction=function(e){const t=e instanceof n._BaseNode&&e;return new Wv(e,t).result}(this.data)}_doInstantiate(e){return this.data._prefab||T(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}_instantiate(){let t,i=!1;return i=this.optimizationPolicy!==PS.SINGLE_INSTANCE&&(this.optimizationPolicy===PS.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold),i?(t=this._doInstantiate(),this.data._instantiate(t)):t=this.data._instantiate(),++this._instantiatedTimes,t}initDefault(e){super.initDefault(e),this.data=new ix,this.data.name="(Missing Node)";const t=new n._PrefabInfo;t.asset=this,t.root=this.data,this.data._prefab=t}validate(){return!!this.data}},CS.OptimizationPolicy=PS,CS.OptimizationPolicyThreshold=3,TS=Oc((bS=wS).prototype,"data",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ES=Oc(bS.prototype,"optimizationPolicy",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PS.AUTO}}),SS=bS))||SS);var IS,MS,OS,DS,NS,LS;De.value(RS,"_utils",AS),n.Prefab=RS,re(n,"cc._Prefab","Prefab"),e("PrefabLink",(IS=Wc("cc.PrefabLink"),MS=Al(RS),OS=ll(),IS((LS=Oc((NS=class extends Gh{constructor(...e){super(...e),Mc(this,"prefab",LS,this)}}).prototype,"prefab",[MS,Qc,OS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DS=NS))||DS));const BS=new zi;function zS(e,t,i,n){n||(n=new zi),e.convertToUINode(t,i,n);const s=i.position;return n.add(s),n}function FS(e,t,i){return i||(i=new zi),e.worldToScreen(t,i),i.x/=n.view.getScaleX(),i.y/=n.view.getScaleY(),i}const US=e("convertUtils",{WorldNode3DToLocalNodeUI:zS,WorldNode3DToWorldNodeUI:FS});var GS,kS,HS,VS,jS,WS,qS,XS,YS;n.pipelineUtils=US,ei(n.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction(...e){const t=e[0],i=e[3]||BS;return t.convertToUINode(e[1],e[2],i),i.add(e[2].position),e[3]||i.clone()}}]);const KS=new $o;KS.endAccesses=[io.FRAGMENT_SHADER_READ_TEXTURE];const $S=new Qo,QS=new er([KS],$S),ZS={width:1,height:1,renderPassInfo:QS};let JS=e("RenderTexture",(GS=Wc("cc.RenderTexture"),kS=dl(),HS=fl(),VS=dl(),jS=fl(),GS((XS=Oc((qS=class extends um{constructor(...e){super(...e),Mc(this,"_width",XS,this),Mc(this,"_height",YS,this),this._window=null}get width(){return this._width}get height(){return this._height}get window(){return this._window}initialize(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)}reset(e){this.initialize(e)}destroy(){if(this._window){const e=n.director.root;null==e||e.destroyWindow(this._window),this._window=null}return super.destroy()}resize(e,t){this._width=e,this._height=t,this._window&&this._window.resize(e,t),this.emit("resize",this._window)}get _serialize(){return null}get _deserialize(){return null}getGFXTexture(){return this._window&&this._window.framebuffer.colorTextures[0]}getGFXSampler(){const e=n.director.root;return Qf.getSampler(e.device,Xf)}getSamplerHash(){return Xf}onLoaded(){this._initWindow()}_initWindow(e){const t=n.director.root;ZS.title=this._name,ZS.width=this._width,ZS.height=this._height,ZS.renderPassInfo=e&&e.passInfo?e.passInfo:QS,this._window?(this._window.destroy(),this._window.initialize(t.device,ZS)):this._window=t.createWindow(ZS)}initDefault(e){super.initDefault(e),this._width=this._height=1,this._initWindow()}validate(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048}}).prototype,"_width",[Qc,kS,HS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),YS=Oc(qS.prototype,"_height",[Qc,VS,jS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WS=qS))||WS));var eb,tb;n.RenderTexture=JS,ti(um.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),ei(JS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction(){return this._window}}]);let ib=e("BufferAsset",Wc("cc.BufferAsset")((Oc((tb=class extends xh{constructor(...e){super(...e),this._buffer=null}get _nativeAsset(){return this._buffer}set _nativeAsset(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}buffer(){return this._buffer}validate(){return!!this.buffer}}).prototype,"_nativeAsset",[Pl],Object.getOwnPropertyDescriptor(tb.prototype,"_nativeAsset"),tb.prototype),eb=tb))||eb);n.BufferAsset=ib;const nb={[Bs.UNORM]:"Uint",[Bs.SNORM]:"Int",[Bs.UINT]:"Uint",[Bs.INT]:"Int",[Bs.UFLOAT]:"Float",[Bs.FLOAT]:"Float",default:"Uint"};function sb(e){return`${nb[e.type]||nb.default}${e.size/e.count*8}`}function ob(e,t,i=Ls.R32F,n=0,s=0){const o=vr[i];s||(s=o.size);const r=`set${sb(o)}`,a=o.size/o.count,c=Math.floor(t.length/o.count),l=xn.isLittleEndian;for(let i=0;i<c;++i){const c=n+s*i;for(let n=0;n<o.count;++n){const s=c+a*n;e[r](s,t[o.count*i+n],l)}}}function rb(e,t=Ls.R32F,i=0,n=e.byteLength-i,s=0,o=[]){const r=vr[t];s||(s=r.size);const a=`get${sb(r)}`,c=r.size/r.count,l=Math.floor(n/s),h=xn.isLittleEndian;for(let t=0;t<l;++t){const n=i+s*t;for(let i=0;i<r.count;++i){const s=n+c*i;o[r.count*t+i]=e[a](s,h)}}return o}function ab(e,t,i=Ls.R32F,n=0,s=e.byteLength-n,o=0,r){r||(r=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));const a=vr[i];o||(o=a.size);const c=`set${sb(a)}`,l=`get${sb(a)}`,h=a.size/a.count,u=Math.floor(s/o),_=xn.isLittleEndian;for(let i=0;i<u;++i){const s=n+o*i;for(let i=0;i<a.count;++i){const n=s+h*i,o=e[l](n,_);r[c](n,t(o,i,e),_)}}return r}class cb{_init(){}constructor(e,t,i,n=null,s=null){this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=n,this._indirectBuffer=s,this._primitiveMode=i,this._iaInfo=new Ko(t,e,n,s),this._init()}get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get primitiveMode(){return this._primitiveMode}get geometricInfo(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:zi.ZERO,max:zi.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:zi.ZERO,max:zi.ZERO}};const{mesh:e}=this,t=this.subMeshIdx,i=e.readAttribute(t,mo.ATTR_POSITION),n=e.readIndices(t),s=new zi,o=new zi,r=this.attributes.find((e=>e.name===mo.ATTR_POSITION));if(r){const e=vr[r.format].count;2===e?(s.set(i[0],i[1],0),o.set(i[0],i[1],0)):(s.set(i[0],i[1],i[2]),o.set(i[0],i[1],i[2]));for(let t=0;t<i.length;t+=e)2===e?(s.x=i[t]>s.x?i[t]:s.x,s.y=i[t+1]>s.y?i[t+1]:s.y,o.x=i[t]<o.x?i[t]:o.x,o.y=i[t+1]<o.y?i[t+1]:o.y):(s.x=i[t]>s.x?i[t]:s.x,s.y=i[t+1]>s.y?i[t+1]:s.y,s.z=i[t+2]>s.z?i[t+2]:s.z,o.x=i[t]<o.x?i[t]:o.x,o.y=i[t+1]<o.y?i[t+1]:o.y,o.z=i[t+2]<o.z?i[t+2]:o.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:s,min:o}},this._geometricInfo}get flatBuffers(){return this._flatBuffers}genFlatBuffers(){if(this._flatBuffers.length||!this.mesh||void 0===this.subMeshIdx)return;const{mesh:e}=this;let t=0;const i=e.struct.primitives[this.subMeshIdx];i.indexView&&(t=i.indexView.count);for(let n=0;n<i.vertexBundelIndices.length;n++){const s=i.vertexBundelIndices[n],o=e.struct.vertexBundles[s],r=i.indexView?i.indexView.count:o.view.count,a=o.view.stride,c=a*r,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),h=new Uint8Array(i.indexView?c:o.view.length);if(!i.indexView){h.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:a,count:r,buffer:h});continue}const u=e.readIndices(this.subMeshIdx);for(let e=0;e<t;++e){const t=e*a,i=u[e]*a;for(let e=0;e<a;++e)h[t+e]=l[i+e]}this._flatBuffers.push({stride:a,count:r,buffer:h})}}get jointMappedBuffers(){if(this._jointMappedBuffers)return this._jointMappedBuffers;const e=this._jointMappedBuffers=[],t=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;const{struct:i}=this.mesh,s=i.primitives[this.subMeshIdx];if(!i.jointMaps||void 0===s.jointMapIndex||!i.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;let o,r;const{device:a}=n.director.root;for(let n=0;n<s.vertexBundelIndices.length;n++){const c=i.vertexBundles[s.vertexBundelIndices[n]];r=0,o=Ls.UNKNOWN;for(let e=0;e<c.attributes.length;e++){const t=c.attributes[e];if(t.name===mo.ATTR_JOINTS){o=t.format;break}r+=vr[t.format].size}if(o){const l=new Uint8Array(this.mesh.data.buffer,c.view.offset,c.view.length),h=new DataView(l.slice().buffer),u=i.jointMaps[s.jointMapIndex];ab(h,(e=>u.indexOf(e)),o,r,c.view.length,c.view.stride,h);const _=a.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.DEVICE,c.view.length,c.view.stride));_.update(h.buffer),e.push(_),t.push(n)}else e.push(this.vertexBuffers[s.vertexBundelIndices[n]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(a)),e}get iaInfo(){return this._iaInfo}destroy(){for(let e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(let e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)}enableVertexIdChannel(e){if(this._vertexIdChannel)return;const t=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(e);this._vertexBuffers.push(n),this._attributes.push(new Xo("a_vertexId",Ls.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:i}}_allocVertexIdBuffer(e){const t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(t);for(let e=0;e<t;++e)i[e]=e+.5;const n=e.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return n.update(i),n}}e("RenderingSubMesh",cb);const lb=new Array(16);let hb=null,ub=new nn;const _b=[cy.TOUCH_START,cy.TOUCH_MOVE,cy.TOUCH_END,cy.TOUCH_CANCEL],pb=[cy.MOUSE_DOWN,cy.MOUSE_ENTER,cy.MOUSE_MOVE,cy.MOUSE_LEAVE,cy.MOUSE_UP,cy.MOUSE_WHEEL];function db(e,t){const i=this.owner;return!(!i||!i._uiProps.uiTransformComp||(e.getUILocation(ub),!i._uiProps.uiTransformComp.isHit(ub,this)||(t.type=cy.TOUCH_START,t.touch=e,t.bubbles=!0,i.dispatchEvent(t),0)))}function fb(e,t){const i=this.owner;return!(!i||!i._uiProps.uiTransformComp||(t.type=cy.TOUCH_MOVE,t.touch=e,t.bubbles=!0,i.dispatchEvent(t),0))}function mb(e,t){const i=this.owner;i&&i._uiProps.uiTransformComp&&(e.getUILocation(ub),i._uiProps.uiTransformComp.isHit(ub,this)?t.type=cy.TOUCH_END:t.type=cy.TOUCH_CANCEL,t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function gb(e,t){const i=this.owner;i&&i._uiProps.uiTransformComp&&(t.type=cy.TOUCH_CANCEL,t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function vb(e){const t=this.owner;t&&t._uiProps.uiTransformComp&&(ub=e.getUILocation(),t._uiProps.uiTransformComp.isHit(ub,this)&&(e.type=cy.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e)))}function yb(e){const t=this.owner;if(t&&t._uiProps.uiTransformComp){if(ub=e.getUILocation(),t._uiProps.uiTransformComp.isHit(ub,this))this._previousIn||(hb&&hb.eventProcessor.mouseListener&&(e.type=cy.MOUSE_LEAVE,hb.dispatchEvent(e),hb.eventProcessor.mouseListener&&(hb.eventProcessor.mouseListener._previousIn=!1)),hb=t,e.type=cy.MOUSE_ENTER,t.dispatchEvent(e),this._previousIn=!0),e.type=cy.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=cy.MOUSE_LEAVE,t.dispatchEvent(e),this._previousIn=!1,hb=null}e.propagationStopped=!0}}function xb(e){const t=this.owner;t&&t._uiProps.uiTransformComp&&(ub=e.getUILocation(),t._uiProps.uiTransformComp.isHit(ub,this)&&(e.type=cy.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Sb(e){const t=this.owner;t&&t._uiProps.uiTransformComp&&(ub=e.getUILocation(),t._uiProps.uiTransformComp.isHit(ub,this)&&(e.type=cy.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function bb(e,t){if(t){let i=0,n=[];for(let s=e;s&&ix.isNode(s);s=s.parent,++i){const e=s.getComponent(t);if(e){const t={index:i,comp:e};n?n.push(t):n=[t]}}return n.length>0?n:null}return null}function Tb(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(let i=0;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(let i=0;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}return!0}class Eb{get node(){return this._node}constructor(e){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}reattach(){let e;this.node.walk((t=>{e||(e=bb(t,Eb._comp)),t.eventProcessor.touchListener&&(t.eventProcessor.touchListener.mask=e),t.eventProcessor.mouseListener&&(t.eventProcessor.mouseListener.mask=e)}))}destroy(){hb===this._node&&(hb=null),(this.touchListener||this.mouseListener)&&(ay.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}on(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new kt),this.bubblingTargets.on(e,t,i))}once(e,t,i,n){let s;s=this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new kt:this.bubblingTargets=this.bubblingTargets||new kt,s.on(e,t,i,!0),s.on(e,(()=>{this.off(e,t,i)}),void 0,!0)}off(e,t,i,n){const s=-1!==_b.indexOf(e),o=!s&&-1!==pb.indexOf(e);s||o?(this._offDispatch(e,t,i,n),s?this.touchListener&&!Tb(this._node,_b)&&(ay.removeListener(this.touchListener),this.touchListener=null):o&&this.mouseListener&&!Tb(this._node,pb)&&(ay.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}emit(e,t,i,n,s,o){this.bubblingTargets&&this.bubblingTargets.emit(e,t,i,n,s,o)}dispatchEvent(e){!function(e,t){let i,n=0;for(t.target=e,lb.length=0,e.eventProcessor.getCapturingTargets(t.type,lb),t.eventPhase=1,n=lb.length-1;n>=0;--n)if(i=lb[n],i.eventProcessor.capturingTargets&&(t.currentTarget=i,i.eventProcessor.capturingTargets.emit(t.type,t,lb),t.propagationStopped))return void(lb.length=0);if(lb.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,lb),t.eventPhase=3,n=0;n<lb.length;++n)if(i=lb[n],i.eventProcessor.bubblingTargets&&(t.currentTarget=i,i.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(lb.length=0);lb.length=0}(this._node,e),lb.length=0}hasEventListener(e,t,i){let n=!1;return this.bubblingTargets&&(n=this.bubblingTargets.hasEventListener(e,t,i)),!n&&this.capturingTargets&&(n=this.capturingTargets.hasEventListener(e,t,i)),n}targetOff(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!Tb(this.node,_b)&&(ay.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!Tb(this.node,pb)&&(ay.removeListener(this.mouseListener),this.mouseListener=null)}getCapturingTargets(e,t){let i=this._node.parent;for(;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}getBubblingTargets(e,t){let i=this._node.parent;for(;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}_checknSetupSysEvent(e){let t=!1,i=!1;return-1!==_b.indexOf(e)?(this.touchListener||(this.touchListener=n.EventListener.create({event:n.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:bb(this._node,Eb._comp),onTouchBegan:db,onTouchMoved:fb,onTouchEnded:mb,onTouchCancelled:gb}),ay.addListener(this.touchListener,this._node),t=!0),i=!0):-1!==pb.indexOf(e)&&(this.mouseListener||(this.mouseListener=n.EventListener.create({event:n.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:bb(this._node,Eb._comp),onMouseDown:vb,onMouseMove:yb,onMouseUp:xb,onMouseScroll:Sb}),ay.addListener(this.mouseListener,this._node),t=!0),i=!0),t&&!this._node.activeInHierarchy&&n.director.getScheduler().schedule((()=>{this._node.activeInHierarchy||ay.pauseTarget(this._node)}),this._node,0,0,0,!1),i}_onDispatch(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,!t)return void C(6800);let s=null;return s=n?this.capturingTargets=this.capturingTargets||new kt:this.bubblingTargets=this.bubblingTargets||new kt,s.hasEventListener(e,t,i)||s.on(e,t,i),t}_offDispatch(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){const s=n?this.capturingTargets:this.bubblingTargets;s&&s.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}var Cb,wb,Ab,Pb,Rb,Ib,Mb,Ob,Db,Nb,Lb,Bb,zb,Fb,Ub,Gb,kb,Hb,Vb,jb,Wb,qb,Xb,Yb,Kb,$b,Qb,Zb,Jb,eT,tT,iT,nT,sT,oT,rT,aT,cT,lT,hT,uT,_T,pT,dT,fT,mT,gT,vT,yT,xT,ST,bT,TT,ET,CT,wT,AT,PT,RT,IT,MT,OT,DT,NT,LT,BT,zT,FT,UT,GT,kT,HT,VT,jT,WT,qT,XT,YT,KT,$T,QT,ZT,JT,eE,tE,iE,nE,sE,oE,rE,aE,cE,lE,hE,uE,_E,pE,dE,fE,mE,gE,vE,yE,xE,SE,bE,TE,EE,CE,wE,AE,PE,RE,IE,ME,OE,DE,NE,LE;Eb._comp=null,n.NodeEventProcessor=Eb;const BE=new zi(0,1,0),zE=new zi,FE=new ji;let UE=(Cb=Wc("cc.AmbientInfo"),wb=Al(at),Cb((Rb=Oc((Pb=class{constructor(){Mc(this,"_skyColor",Rb,this),Mc(this,"_skyIllum",Ib,this),Mc(this,"_groundAlbedo",Mb,this),this._resource=null}set skyColor(e){this._skyColor.set(e),this._resource&&(this._resource.skyColor=this._skyColor)}get skyColor(){return this._skyColor}set skyIllum(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)}get skyIllum(){return this._skyIllum}set groundAlbedo(e){this._groundAlbedo.set(e),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)}get groundAlbedo(){return this._groundAlbedo}activate(e){this._resource=e,this._resource.initialize(this)}}).prototype,"_skyColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(51,128,204,1)}}),Ib=Oc(Pb.prototype,"_skyIllum",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rs.SKY_ILLUM}}),Mb=Oc(Pb.prototype,"_groundAlbedo",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(51,51,51,255)}}),Oc(Pb.prototype,"skyColor",[cl],Object.getOwnPropertyDescriptor(Pb.prototype,"skyColor"),Pb.prototype),Oc(Pb.prototype,"skyIllum",[cl,wb],Object.getOwnPropertyDescriptor(Pb.prototype,"skyIllum"),Pb.prototype),Oc(Pb.prototype,"groundAlbedo",[cl],Object.getOwnPropertyDescriptor(Pb.prototype,"groundAlbedo"),Pb.prototype),Ab=Pb))||Ab);n.AmbientInfo=UE;let GE=(Ob=Wc("cc.SkyboxInfo"),Db=Al(Nm),Nb=Al(Nm),Ob((zb=Oc((Bb=class{constructor(){Mc(this,"_envmap",zb,this),Mc(this,"_isRGBE",Fb,this),Mc(this,"_enabled",Ub,this),Mc(this,"_useIBL",Gb,this),this._resource=null}set enabled(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}get enabled(){return this._enabled}set useIBL(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}get useIBL(){return this._useIBL}set envmap(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)}get envmap(){return this._envmap}set isRGBE(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)}get isRGBE(){return this._isRGBE}activate(e){this._resource=e,this._resource.initialize(this),this._resource.activate()}}).prototype,"_envmap",[Db],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fb=Oc(Bb.prototype,"_isRGBE",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ub=Oc(Bb.prototype,"_enabled",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gb=Oc(Bb.prototype,"_useIBL",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(Bb.prototype,"enabled",[cl],Object.getOwnPropertyDescriptor(Bb.prototype,"enabled"),Bb.prototype),Oc(Bb.prototype,"useIBL",[cl],Object.getOwnPropertyDescriptor(Bb.prototype,"useIBL"),Bb.prototype),Oc(Bb.prototype,"envmap",[cl,Nb],Object.getOwnPropertyDescriptor(Bb.prototype,"envmap"),Bb.prototype),Oc(Bb.prototype,"isRGBE",[cl],Object.getOwnPropertyDescriptor(Bb.prototype,"isRGBE"),Bb.prototype),Lb=Bb))||Lb);n.SkyboxInfo=GE;let kE=(kb=Wc("cc.FogInfo"),Hb=Al(Av),Vb=ll(),jb=Al(at),Wb=pl(),qb=ml(),Xb=vl(),Yb=ll(),Kb=Al(at),$b=ml(),Qb=vl(),Zb=ll(),Jb=Al(at),eT=ml(),tT=vl(),iT=ll(),nT=Al(at),sT=dl(),oT=ml(),rT=vl(),aT=ll(),cT=Al(at),lT=ml(),hT=vl(),uT=ll(),_T=Al(at),pT=ml(),dT=vl(),kb((AT=wT=class{constructor(){Mc(this,"_type",gT,this),Mc(this,"_fogColor",vT,this),Mc(this,"_enabled",yT,this),Mc(this,"_fogDensity",xT,this),Mc(this,"_fogStart",ST,this),Mc(this,"_fogEnd",bT,this),Mc(this,"_fogAtten",TT,this),Mc(this,"_fogTop",ET,this),Mc(this,"_fogRange",CT,this),this._resource=null}set enabled(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set fogColor(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(e){this._type=e,this._resource&&(this._resource.type=e)}get fogDensity(){return this._fogDensity}set fogDensity(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}get fogStart(){return this._fogStart}set fogStart(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}get fogEnd(){return this._fogEnd}set fogEnd(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}get fogAtten(){return this._fogAtten}set fogAtten(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}get fogTop(){return this._fogTop}set fogTop(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}get fogRange(){return this._fogRange}set fogRange(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}activate(e){this._resource=e,this._resource.initialize(this),this._resource.activate()}},wT.FogType=Av,gT=Oc((mT=AT).prototype,"_type",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Av.LINEAR}}),vT=Oc(mT.prototype,"_fogColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di("#C8C8C8")}}),yT=Oc(mT.prototype,"_enabled",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xT=Oc(mT.prototype,"_fogDensity",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),ST=Oc(mT.prototype,"_fogStart",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),bT=Oc(mT.prototype,"_fogEnd",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),TT=Oc(mT.prototype,"_fogAtten",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),ET=Oc(mT.prototype,"_fogTop",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),CT=Oc(mT.prototype,"_fogRange",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Oc(mT.prototype,"enabled",[cl],Object.getOwnPropertyDescriptor(mT.prototype,"enabled"),mT.prototype),Oc(mT.prototype,"fogColor",[cl],Object.getOwnPropertyDescriptor(mT.prototype,"fogColor"),mT.prototype),Oc(mT.prototype,"type",[cl,Hb],Object.getOwnPropertyDescriptor(mT.prototype,"type"),mT.prototype),Oc(mT.prototype,"fogDensity",[Vb,jb,Wb,qb,gl,Xb],Object.getOwnPropertyDescriptor(mT.prototype,"fogDensity"),mT.prototype),Oc(mT.prototype,"fogStart",[Yb,Kb,$b,Qb],Object.getOwnPropertyDescriptor(mT.prototype,"fogStart"),mT.prototype),Oc(mT.prototype,"fogEnd",[Zb,Jb,eT,tT],Object.getOwnPropertyDescriptor(mT.prototype,"fogEnd"),mT.prototype),Oc(mT.prototype,"fogAtten",[iT,nT,sT,oT,rT],Object.getOwnPropertyDescriptor(mT.prototype,"fogAtten"),mT.prototype),Oc(mT.prototype,"fogTop",[aT,cT,lT,hT],Object.getOwnPropertyDescriptor(mT.prototype,"fogTop"),mT.prototype),Oc(mT.prototype,"fogRange",[uT,_T,pT,dT],Object.getOwnPropertyDescriptor(mT.prototype,"fogRange"),mT.prototype),fT=mT))||fT),HE=(PT=Wc("cc.ShadowsInfo"),RT=Al(Xg),IT=ll(),MT=ll(),OT=Al(at),DT=ll(),NT=pl(),LT=Al(at),BT=ll(),zT=Al(Yg),FT=ll(),UT=Al(rt),GT=ll(),kT=Al(at),HT=ll(),VT=Al(at),jT=ll(),WT=Al(qg),qT=ll(),XT=Al(ct),YT=ll(),KT=Al(at),$T=ll(),QT=Al(at),ZT=ll(),JT=_l(),eE=pl(),tE=Al(at),iE=ll(),nE=_l(),sE=pl(),oE=Al(at),rE=ll(),aE=Al(at),cE=ll(),PT((uE=Oc((hE=class{constructor(){Mc(this,"_type",uE,this),Mc(this,"_enabled",_E,this),Mc(this,"_normal",pE,this),Mc(this,"_distance",dE,this),Mc(this,"_shadowColor",fE,this),Mc(this,"_fixedArea",mE,this),Mc(this,"_pcf",gE,this),Mc(this,"_bias",vE,this),Mc(this,"_normalBias",yE,this),Mc(this,"_near",xE,this),Mc(this,"_far",SE,this),Mc(this,"_shadowDistance",bE,this),Mc(this,"_invisibleOcclusionRange",TE,this),Mc(this,"_orthoSize",EE,this),Mc(this,"_maxReceived",CE,this),Mc(this,"_size",wE,this),Mc(this,"_saturation",AE,this),this._resource=null}set enabled(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set type(e){this._type=e,this._resource&&(this._resource.type=e)}get type(){return this._type}set shadowColor(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}get shadowColor(){return this._shadowColor}set normal(e){zi.copy(this._normal,e),this._resource&&(this._resource.normal=e)}get normal(){return this._normal}set distance(e){this._distance=e,this._resource&&(this._resource.distance=e)}get distance(){return this._distance}set saturation(e){e>1?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}get saturation(){return this._saturation}set pcf(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}get pcf(){return this._pcf}set maxReceived(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}get maxReceived(){return this._maxReceived}set bias(e){this._bias=e,this._resource&&(this._resource.bias=e)}get bias(){return this._bias}set normalBias(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}get normalBias(){return this._normalBias}set shadowMapSize(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}get shadowMapSize(){return this._size.x}get size(){return this._size}set fixedArea(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}get fixedArea(){return this._fixedArea}set near(e){this._near=e,this._resource&&(this._resource.near=e)}get near(){return this._near}set far(e){this._far=Math.min(e,2e3),this._resource&&(this._resource.far=Math.min(e,2e3))}get far(){return this._far}set invisibleOcclusionRange(e){this._invisibleOcclusionRange=Math.min(e,2e3),this._resource&&(this._resource.invisibleOcclusionRange=Math.min(e,2e3))}get invisibleOcclusionRange(){return this._invisibleOcclusionRange}set shadowDistance(e){this._shadowDistance=Math.min(e,2e3),this._resource&&(this._resource.shadowDistance=Math.min(e,2e3))}get shadowDistance(){return this._shadowDistance}set orthoSize(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}get orthoSize(){return this._orthoSize}setPlaneFromNode(e){e.getWorldRotation(FE),this.normal=zi.transformQuat(zE,BE,FE),e.getWorldPosition(zE),this.distance=zi.dot(this._normal,zE)}activate(e){this._resource=e,this.pcf=Math.min(this._pcf,Yg.SOFT_2X),this._resource.initialize(this),this._resource.activate()}}).prototype,"_type",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xg.Planar}}),_E=Oc(hE.prototype,"_enabled",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pE=Oc(hE.prototype,"_normal",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,1,0)}}),dE=Oc(hE.prototype,"_distance",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fE=Oc(hE.prototype,"_shadowColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(0,0,0,76)}}),mE=Oc(hE.prototype,"_fixedArea",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gE=Oc(hE.prototype,"_pcf",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yg.HARD}}),vE=Oc(hE.prototype,"_bias",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),yE=Oc(hE.prototype,"_normalBias",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xE=Oc(hE.prototype,"_near",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),SE=Oc(hE.prototype,"_far",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),bE=Oc(hE.prototype,"_shadowDistance",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),TE=Oc(hE.prototype,"_invisibleOcclusionRange",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),EE=Oc(hE.prototype,"_orthoSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),CE=Oc(hE.prototype,"_maxReceived",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),wE=Oc(hE.prototype,"_size",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(512,512)}}),AE=Oc(hE.prototype,"_saturation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),Oc(hE.prototype,"enabled",[cl],Object.getOwnPropertyDescriptor(hE.prototype,"enabled"),hE.prototype),Oc(hE.prototype,"type",[cl,RT],Object.getOwnPropertyDescriptor(hE.prototype,"type"),hE.prototype),Oc(hE.prototype,"shadowColor",[IT],Object.getOwnPropertyDescriptor(hE.prototype,"shadowColor"),hE.prototype),Oc(hE.prototype,"normal",[MT],Object.getOwnPropertyDescriptor(hE.prototype,"normal"),hE.prototype),Oc(hE.prototype,"distance",[OT,DT],Object.getOwnPropertyDescriptor(hE.prototype,"distance"),hE.prototype),Oc(hE.prototype,"saturation",[cl,NT,gl,LT,BT],Object.getOwnPropertyDescriptor(hE.prototype,"saturation"),hE.prototype),Oc(hE.prototype,"pcf",[zT,FT],Object.getOwnPropertyDescriptor(hE.prototype,"pcf"),hE.prototype),Oc(hE.prototype,"maxReceived",[UT,GT],Object.getOwnPropertyDescriptor(hE.prototype,"maxReceived"),hE.prototype),Oc(hE.prototype,"bias",[kT,HT],Object.getOwnPropertyDescriptor(hE.prototype,"bias"),hE.prototype),Oc(hE.prototype,"normalBias",[VT,jT],Object.getOwnPropertyDescriptor(hE.prototype,"normalBias"),hE.prototype),Oc(hE.prototype,"shadowMapSize",[WT,qT],Object.getOwnPropertyDescriptor(hE.prototype,"shadowMapSize"),hE.prototype),Oc(hE.prototype,"fixedArea",[XT,YT],Object.getOwnPropertyDescriptor(hE.prototype,"fixedArea"),hE.prototype),Oc(hE.prototype,"near",[KT,$T],Object.getOwnPropertyDescriptor(hE.prototype,"near"),hE.prototype),Oc(hE.prototype,"far",[QT,ZT],Object.getOwnPropertyDescriptor(hE.prototype,"far"),hE.prototype),Oc(hE.prototype,"invisibleOcclusionRange",[cl,JT,eE,gl,tE,iE],Object.getOwnPropertyDescriptor(hE.prototype,"invisibleOcclusionRange"),hE.prototype),Oc(hE.prototype,"shadowDistance",[cl,nE,sE,gl,oE,rE],Object.getOwnPropertyDescriptor(hE.prototype,"shadowDistance"),hE.prototype),Oc(hE.prototype,"orthoSize",[aE,cE],Object.getOwnPropertyDescriptor(hE.prototype,"orthoSize"),hE.prototype),lE=hE))||lE);n.ShadowsInfo=HE;let VE=(PE=Wc("cc.SceneGlobals"),RE=Al(GE),PE((OE=Oc((ME=class{constructor(){Mc(this,"ambient",OE,this),Mc(this,"shadows",DE,this),Mc(this,"_skybox",NE,this),Mc(this,"fog",LE,this)}get skybox(){return this._skybox}set skybox(e){this._skybox=e}activate(){const e=n.director.root.pipeline.pipelineSceneData;this.ambient.activate(e.ambient),this.skybox.activate(e.skybox),this.shadows.activate(e.shadows),this.fog.activate(e.fog)}}).prototype,"ambient",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UE}}),DE=Oc(ME.prototype,"shadows",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HE}}),NE=Oc(ME.prototype,"_skybox",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GE}}),LE=Oc(ME.prototype,"fog",[cl,Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kE}}),Oc(ME.prototype,"skybox",[cl,RE],Object.getOwnPropertyDescriptor(ME.prototype,"skybox"),ME.prototype),IE=ME))||IE);var jE;n.SceneGlobals=VE,ei(Ty.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter(){return this.children.length}}]),ei(ix.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.width},customSetter(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.height},customSetter(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.anchorX},customSetter(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.anchorY},customSetter(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction(e){return e||(e=new nn),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction(e){return e||(e=new hn),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),ti(VE.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),ti(ix.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),ti(id,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),ei(id,"Layers",[{name:"Default",newName:"DEFAULT",target:id.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:id.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:id.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:id.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:id.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:id.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:id.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:id.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:id,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:id,targetName:"Layers"}]),ti(id.Enum,"Layers.Enum",[{name:"ALWAYS"}]),ti(id.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);const WE=Ot.Flags.HideInHierarchy,qE=Ot.Flags.DontSave;let XE=e("PrivateNode",Wc("cc.PrivateNode")(jE=class extends ix{constructor(e){super(e),T(12003,this.name),this.hideFlags|=qE|WE}})||jE);var YE,KE,$E,QE;n.PrivateNode=XE;let ZE=e("Scene",Wc("cc.Scene")((Oc((KE=class extends Ty{get renderScene(){return this._renderScene}get globals(){return this._globals}_updateScene(){this._scene=this}get native(){return this._nativeObj}_init(){this._nativeObj=new Fn}constructor(e){super(e),Mc(this,"autoReleaseAssets",$E,this),Mc(this,"_globals",QE,this),this._renderScene=null,this.dependAssets=null,this._inited=void 0,this._prefabSyncedInLiveReload=!1,this._pos=zi.ZERO,this._rot=ji.IDENTITY,this._scale=zi.ONE,this._mat=Zi.IDENTITY,this._dirtyFlags=0,this._lpos=zi.ZERO,this._lrot=ji.IDENTITY,this._lscale=zi.ONE,this._activeInHierarchy=!1,n.director&&n.director.root&&(this._renderScene=n.director.root.createScene({})),this._inited=!n.game||!n.game._isCloning,this._init()}destroy(){const e=Ot.prototype.destroy.call(this);if(e){const e=this._children;for(let t=0;t<e.length;++t)e[t].active=!1}return this._renderScene&&n.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e}addComponent(){throw new Error(R(3822))}_onHierarchyChanged(){}_onBatchCreated(e){super._onBatchCreated(e);const t=this._children.length;for(let i=0;i<t;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e);My(this)}getPosition(e){return zi.copy(e||new zi,zi.ZERO)}getRotation(e){return ji.copy(e||new ji,ji.IDENTITY)}getScale(e){return zi.copy(e||new zi,zi.ONE)}getWorldPosition(e){return zi.copy(e||new zi,zi.ZERO)}getWorldRotation(e){return ji.copy(e||new ji,ji.IDENTITY)}getWorldScale(e){return zi.copy(e||new zi,zi.ONE)}getWorldMatrix(e){return Zi.copy(e||new Zi,Zi.IDENTITY)}getWorldRS(e){return Zi.copy(e||new Zi,Zi.IDENTITY)}getWorldRT(e){return Zi.copy(e||new Zi,Zi.IDENTITY)}get position(){return zi.ZERO}get worldPosition(){return zi.ZERO}get rotation(){return ji.IDENTITY}get worldRotation(){return ji.IDENTITY}get scale(){return zi.ONE}get worldScale(){return zi.ONE}get eulerAngles(){return zi.ZERO}get worldMatrix(){return Zi.IDENTITY}updateWorldTransform(){}_instantiate(){}_load(){this._inited||(this._onBatchCreated(false),this._inited=!0),this.walk(Ty._setScene)}_activate(e){e=!1!==e,n.director._nodeActivator.activateNode(this,e),this._globals.activate()}}).prototype,"globals",[cl],Object.getOwnPropertyDescriptor(KE.prototype,"globals"),KE.prototype),$E=Oc(KE.prototype,"autoReleaseAssets",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QE=Oc(KE.prototype,"_globals",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VE}}),YE=KE))||YE);function JE(e,t){if(!t){const e=n.director.getScene();if(!e)return null;t=e}return t.getChildByPath(e)}n.Scene=ZE,n.find=JE;const eC=Oe.fastRemoveAt,tC=Ot.Flags.IsStartCalled,iC=Ot.Flags.IsOnEnableCalled;function nC(e,t){const i=t.constructor._executionOrder,n=t._id;let s=0;for(let t=e.length-1,o=t>>>1;s<=t;o=s+t>>>1){const r=e[o],a=r.constructor._executionOrder;if(a>i)t=o-1;else if(a<i)s=o+1;else{const e=r._id;if(e>n)t=o-1;else{if(!(e<n))return o;s=o+1}}}return~s}function sC(e,t){const i=e.array;let n=e.i+1;for(;n<i.length;){const s=i[n];s.node._activeInHierarchy?++n:(e.removeAt(n),t&&(s._objFlags&=~t))}}Ot.Flags.IsEditorOnEnableCalled;class oC{constructor(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;const t=k;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e}}function rC(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}oC.stableRemoveInactive=sC;class aC extends oC{add(e){const t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}remove(e){const t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}cancelInactive(e){sC(this._zero,e),sC(this._neg,e),sC(this._pos,e)}invoke(){const e=this._neg;e.array.length>0&&(e.array.sort(rC),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;const t=this._pos;t.array.length>0&&(t.array.sort(rC),this._invoke(t),t.array.length=0)}}class cC extends oC{add(e){const t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{const i=t<0?this._neg.array:this._pos.array,n=nC(i,e);n<0&&i.splice(~n,0,e)}}remove(e){const t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{const i=t<0?this._neg:this._pos,n=nC(i.array,e);n>=0&&i.removeAt(n)}}invoke(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}function lC(e,t,i){const s=`var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];${e}}`,o=t?Function("it","dt",s):Function("it",s);return function(e,t,i){return(s,o)=>{try{t(s,o)}catch(t){n._throw(t);const r=s.array;for(i&&(r[s.i]._objFlags|=i),++s.i;s.i<r.length;++s.i)try{e(r[s.i],o)}catch(e){n._throw(e),i&&(r[s.i]._objFlags|=i)}}}}(Function("c","dt",e),o,i)}const hC=lC(`c.start();c._objFlags|=${tC}`,!1,tC),uC=lC("c.update(dt)",!0),_C=lC("c.lateUpdate(dt)",!0),pC=e=>{const t=n.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){const n=i[e.i];n._enabled&&(n.onEnable(),!n.node._activeInHierarchy||t._onEnabled(n))}};class dC{constructor(){this._deferredComps=[],this.unscheduleAll()}unscheduleAll(){this.startInvoker=new aC(hC),this.updateInvoker=new cC(uC),this.lateUpdateInvoker=new cC(_C),this._updating=!1}_onEnabled(e){n.director.getScheduler().resumeTarget(e),e._objFlags|=iC,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)}_onDisabled(e){n.director.getScheduler().pauseTarget(e),e._objFlags&=~iC;const t=this._deferredComps.indexOf(e);t>=0?eC(this._deferredComps,t):(!e.start||e._objFlags&tC||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}enableComp(e,t){if(!(e._objFlags&iC)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}disableComp(e){e._objFlags&iC&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}startPhase(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}updatePhase(e){this.updateInvoker.invoke(e)}lateUpdatePhase(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()}_startForNewComps(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}_scheduleImmediate(e){"function"!=typeof e.start||e._objFlags&tC||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)}_deferredSchedule(){const e=this._deferredComps;for(let t=0,i=e.length;t<i;t++)this._scheduleImmediate(e[t]);e.length=0}}const fC=Ot.Flags.IsPreloadStarted,mC=Ot.Flags.IsOnLoadStarted,gC=Ot.Flags.IsOnLoadCalled,vC=Ot.Flags.Deactivating;class yC extends oC{add(e){this._zero.array.push(e)}remove(e){this._zero.fastRemove(e)}cancelInactive(e){oC.stableRemoveInactive(this._zero,e)}invoke(){this._invoke(this._zero),this._zero.array.length=0}}const xC=lC("c.__preload();"),SC=lC(`c.onLoad();c._objFlags|=${gC}`,!1,gC),bC=new Me(4);function TC(e,t,i){t?e._removeComponent(t):Oe.removeAt(e._components,i)}bC.get=function(){const e=this._get()||{preload:new yC(xC),onLoad:new aC(SC),onEnable:new aC(pC)};e.preload._zero.i=-1;let t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,t=e.onEnable,t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};class EC{constructor(){this.resetComp=void 0,this.reset()}reset(){this._activatingStack=[]}activateNode(e,t){if(t){const t=bC.get();this._activatingStack.push(t),this._activateNodeRecursively(e,t.preload,t.onLoad,t.onEnable),t.preload.invoke(),t.onLoad.invoke(),t.onEnable.invoke(),this._activatingStack.pop(),bC.put(t)}else{this._deactivateNodeRecursively(e);const t=this._activatingStack;for(const e of t)e.preload.cancelInactive(fC),e.onLoad.cancelInactive(mC),e.onEnable.cancelInactive()}e.emit("active-in-hierarchy-changed",e)}activateComp(e,t,i,s){if(Nt(e,!0)&&(e._objFlags&fC||(e._objFlags|=fC,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&mC||(e._objFlags|=mC,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=gC):e._objFlags|=gC),e._enabled)){if(!e.node._activeInHierarchy)return;n.director._compScheduler.enableComp(e,s)}}destroyComp(e){n.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&gC&&e.onDestroy()}_activateNodeRecursively(e,t,i,s){if(e._objFlags&vC)return void C(3816,e.name);e._activeInHierarchy=!0;let o=e._components.length;for(let r=0;r<o;++r){const a=e._components[r];a instanceof n.Component?this.activateComp(a,t,i,s):(TC(e,a,r),--r,--o)}e._childArrivalOrder=e._children.length;for(let n=0,o=e._children.length;n<o;++n){const o=e._children[n];o._active&&this._activateNodeRecursively(o,t,i,s)}e._onPostActivated(!0)}_deactivateNodeRecursively(e){e._objFlags|=vC,e._activeInHierarchy=!1;const t=e._components.length;for(let i=0;i<t;++i){const t=e._components[i];if(t._enabled&&(n.director._compScheduler.disableComp(t),e._activeInHierarchy))return void(e._objFlags&=~vC)}for(let t=0,i=e._children.length;t<i;++t){const i=e._children[t];if(i._activeInHierarchy&&(this._deactivateNodeRecursively(i),e._activeInHierarchy))return void(e._objFlags&=~vC)}e._onPostActivated(!1),e._objFlags&=~vC}}var CC,wC,AC;e("NodeActivator",EC);let PC=e("SceneAsset",Wc("cc.SceneAsset")((AC=Oc((wC=class extends xh{constructor(...e){super(...e),Mc(this,"scene",AC,this)}initDefault(e){super.initDefault(e),this.scene=new ZE("New Scene")}validate(){return!!this.scene}}).prototype,"scene",[cl,Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CC=wC))||CC);var RC,IC,MC;n.SceneAsset=PC;let OC=e("TextAsset",Wc("cc.TextAsset")((MC=Oc((IC=class extends xh{constructor(...e){super(...e),Mc(this,"text",MC,this)}toString(){return this.text}}).prototype,"text",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RC=IC))||RC);var DC,NC,LC;n.TextAsset=OC;let BC=e("JsonAsset",Wc("cc.JsonAsset")((LC=Oc((NC=class extends xh{constructor(...e){super(...e),Mc(this,"json",LC,this)}}).prototype,"json",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DC=NC))||DC);n.JsonAsset=BC;class zC extends Iv{get deferredLightingMaterial(){return this._deferredLightingMaterial}set deferredLightingMaterial(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updateDeferredPassInfo())}get deferredPostMaterial(){return this._deferredPostMaterial}set deferredPostMaterial(e){this._deferredPostMaterial!==e&&e&&(this._deferredPostMaterial=e,this.updateDeferredPassInfo())}onGlobalPipelineStateChanged(){this.updateDeferredPassInfo()}initPipelinePassInfo(){const e=new Wg;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(let t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;const t=new Wg;t._uuid="builtin-post-process-material",t.initialize({effectName:"post-process"});for(let e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredPostMaterial=t,this.updateDeferredPassInfo()}activate(e,t){return super.activate(e,t),this.initPipelinePassInfo(),!0}updateDeferredPassInfo(){this.updateDeferredLightPass(),this.updateDeferredPostPass()}updateDeferredLightPass(){if(!this._deferredLightingMaterial)return;const e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently(),this._nativeObj.deferredLightPassShader=e.getShaderVariant(),this._nativeObj.deferredLightPass=e.native}updateDeferredPostPass(){if(!this.deferredPostMaterial)return;const e=this.deferredPostMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently(),this._nativeObj.deferredPostPassShader=e.getShaderVariant(),this._nativeObj.deferredPostPass=e.native}}nr.getPhaseID=lg;const FC=e("RenderPipeline",nr.RenderPipeline),UC=(e("RenderFlow",nr.RenderFlow),e("RenderStage",nr.RenderStage),e("InstancedBuffer",nr.InstancedBuffer),e("PipelineStateManager",nr.PipelineStateManager));nr.InstancedBuffer.get;let GC=nr.PipelineStateManager.getOrCreatePipelineState;function kC(){const e=new HC;return e.init(),e}nr.PipelineStateManager.getOrCreatePipelineState=function(e,t,i,n,s){return GC.call(e,t.native,i,n,s)};class HC extends nr.ForwardPipeline{constructor(){super(),this.pipelineSceneData=new Iv,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.native);for(let e=0;e<this._flows.length;e++)this._flows[e].init();const e=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(e)}activate(){return super.activate()&&this.pipelineSceneData.activate(n.director.root.device,this)}render(e){let t=[];for(let i=0,n=e.length;i<n;++i)t.push(e[i].native);super.render(t)}destroy(){this.pipelineSceneData.destroy(),super.destroy()}}e("ForwardPipeline",HC),fe(HC.prototype,xh.prototype);const VC=HC.prototype.onLoaded;HC.prototype.onLoaded=function(){VC&&VC.call(this),this.init()};class jC extends nr.ForwardFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let e=0;e<this._stages.length;e++)this._stages[e].init();const e=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(e)}}e("ForwardFlow",jC);class WC extends nr.ShadowFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let e=0;e<this._stages.length;e++)this._stages[e].init();const e=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(e)}}e("ShadowFlow",WC);class qC extends nr.ForwardStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());const t=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(t)}}e("ForwardStage",qC);class XC extends nr.ShadowStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0}init(){const e=new nr.RenderStageInfo(this._name,this._priority,this._tag,[]);this.initialize(e)}}e("ShadowStage",XC);class YC{constructor(){this.isTransparent=!1,this.sortMode=0,this.stages=[],this.isTransparent=!1,this.sortMode=0,this.stages=[]}init(){return new nr.RenderQueueDesc(this.isTransparent,this.sortMode,this.stages)}}e("RenderQueueDesc",YC);class KC extends nr.DeferredPipeline{constructor(){super(),this.pipelineSceneData=new zC,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.native);for(let e=0;e<this._flows.length;e++)this._flows[e].init(this);let e=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(e)}activate(){return super.activate()&&this.pipelineSceneData.activate(n.director.root.device,this)}render(e){let t=[];for(let i=0,n=e.length;i<n;++i)t.push(e[i].native);super.render(t)}destroy(){this.fog.destroy(),this.ambient.destroy(),this.skybox.destroy(),this.shadows.destroy(),this.pipelineSceneData.destroy(),super.destroy()}}e("DeferredPipeline",KC),fe(KC.prototype,xh.prototype);const $C=KC.prototype.onLoaded;KC.prototype.onLoaded=function(){$C&&$C.call(this),this.init()};class QC extends nr.GbufferFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(e){for(let t=0;t<this._stages.length;t++)this._stages[t].init(e);let t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}e("GbufferFlow",QC);class ZC extends nr.GbufferStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(e){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(i)}}e("GbufferStage",ZC);class JC extends nr.LightingFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(e){for(let t=0;t<this._stages.length;t++)this._stages[t].init(e);let t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}class ew extends nr.LightingStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[],this._deferredMaterial=null}init(e){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial;let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(i)}}e("LightingStage",ew);class tw extends nr.PostprocessStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[],this._postProcessMaterial=null}init(e){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());e.pipelineSceneData.deferredPostMaterial=this._postProcessMaterial;let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(i)}}e("PostprocessStage",tw),Ce("DeferredPipeline",KC),Ce("GbufferFlow",QC),Ce("GbufferStage",ZC),Ce("LightingFlow",JC),Ce("LightingStage",ew),Ce("PostprocessStage",tw),Ce("ForwardPipeline",HC),Ce("ForwardFlow",jC),Ce("ShadowFlow",WC),Ce("ForwardStage",qC),Ce("ShadowStage",XC),Ce("RenderQueueDesc",YC),ei(Yv,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);class iw{constructor(){this.support=void 0,this._intervalInSeconds=.2,this._intervalId=void 0,this._isEnabled=!1,this._eventTarget=new Vt,this._didAccelerateFunc=void 0;const e=qt.isMobile;this.support=e,this._didAccelerateFunc=this._didAccelerate.bind(this)}_didAccelerate(){const e=jsb.device.getDeviceMotionValue();let t=.1*e[3],i=.1*e[4];const n=.1*e[5],s=gn.orientation,o=t;s===fn.LANDSCAPE_RIGHT?(t=-i,i=o):s===fn.LANDSCAPE_LEFT?(t=i,i=-o):s===fn.PORTRAIT_UPSIDE_DOWN&&(t=-t,i=-i),qt.os!==B.ANDROID&&qt.os!==B.OHOS||(t=-t,i=-i);const r={type:Yv.DEVICEMOTION,x:t,y:i,z:n,timestamp:performance.now()};this._eventTarget.emit(Yv.DEVICEMOTION,r)}start(){this._intervalId&&clearInterval(this._intervalId),this._intervalId=setInterval(this._didAccelerateFunc,1e3*this._intervalInSeconds),jsb.device.setAccelerometerInterval(this._intervalInSeconds),jsb.device.setAccelerometerEnabled(!0),this._isEnabled=!0}stop(){this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),jsb.device.setAccelerometerEnabled(!1),this._isEnabled=!1}setInterval(e){this._intervalInSeconds=e/1e3,jsb.device.setAccelerometerInterval(this._intervalInSeconds),this._isEnabled&&(jsb.device.setAccelerometerEnabled(!1),jsb.device.setAccelerometerEnabled(!0))}onChange(e){this._eventTarget.on(Yv.DEVICEMOTION,e)}}class nw{constructor(){this.support=void 0,this.support=!0}show(){throw new Error("Method not implemented.")}hide(){throw new Error("Method not implemented.")}onChange(){throw new Error("Method not implemented.")}onComplete(){throw new Error("Method not implemented.")}offChange(){throw new Error("Method not implemented.")}offComplete(){throw new Error("Method not implemented.")}}let sw;!function(e){e[e.NONE=0]="NONE",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(sw||(sw=e("KeyCode",{})));const ow={12:sw.NUM_LOCK,10048:sw.NUM_0,10049:sw.NUM_1,10050:sw.NUM_2,10051:sw.NUM_3,10052:sw.NUM_4,10053:sw.NUM_5,10054:sw.NUM_6,10055:sw.NUM_7,10056:sw.NUM_8,10057:sw.NUM_9,20013:sw.NUM_ENTER,20016:sw.SHIFT_RIGHT,20017:sw.CTRL_RIGHT,20018:sw.ALT_RIGHT};function rw(e){return ow[e]||e}class aw{constructor(){this.support=void 0,this._eventTarget=new Vt,this._keyStateMap={},this.support=!qt.isMobile,this._registerEvent()}_registerEvent(){jsb.onKeyDown=e=>{const t=rw(e.keyCode),i=this._getInputEvent(e,Yv.KEY_DOWN);this._eventTarget.emit(Yv.KEY_DOWN,i),this._keyStateMap[t]=!0},jsb.onKeyUp=e=>{const t=rw(e.keyCode),i={type:Yv.KEY_UP,code:t,timestamp:performance.now()};this._keyStateMap[t]=!1,this._eventTarget.emit(Yv.KEY_UP,i)}}_getInputEvent(e,t){return{type:t,code:rw(e.keyCode),timestamp:performance.now()}}onDown(e){this._eventTarget.on("keypress",e)}onPressing(e){this._eventTarget.on(Yv.KEY_DOWN,e)}onUp(e){this._eventTarget.on(Yv.KEY_UP,e)}}class cw{constructor(){this.support=void 0,this._eventTarget=new Vt,this._preMousePos=new nn,this.support=!qt.isMobile,this._registerEvent()}_getLocation(e){return new nn(e.x,e.y)}_registerEvent(){jsb.onMouseDown=this._createCallback(Yv.MOUSE_DOWN),jsb.onMouseMove=this._createCallback(Yv.MOUSE_MOVE),jsb.onMouseUp=this._createCallback(Yv.MOUSE_UP),jsb.onMouseWheel=e=>{const t=this._getLocation(e),i=gn.windowSize,n={type:Yv.MOUSE_WHEEL,x:t.x,y:i.height-t.y,button:e.button,deltaX:120*e.wheelDeltaX,deltaY:120*e.wheelDeltaY,timestamp:performance.now()};this._eventTarget.emit(Yv.MOUSE_WHEEL,n)}}_createCallback(e){return t=>{const i=this._getLocation(t),n=gn.windowSize,s=i.x,o=n.height-i.y,r={type:e,x:s,y:o,movementX:s-this._preMousePos.x,movementY:this._preMousePos.y-o,button:t.button,timestamp:performance.now()};this._preMousePos.set(r.x,r.y),this._eventTarget.emit(e,r)}}onDown(e){this._eventTarget.on(Yv.MOUSE_DOWN,e)}onMove(e){this._eventTarget.on(Yv.MOUSE_MOVE,e)}onUp(e){this._eventTarget.on(Yv.MOUSE_UP,e)}onWheel(e){this._eventTarget.on(Yv.MOUSE_WHEEL,e)}}class lw{constructor(){this.support=void 0,this._eventTarget=new Vt,this.support=!0,this._registerEvent()}_registerEvent(){jsb.onTouchStart=this._createCallback(Yv.TOUCH_START),jsb.onTouchMove=this._createCallback(Yv.TOUCH_MOVE),jsb.onTouchEnd=this._createCallback(Yv.TOUCH_END),jsb.onTouchCancel=this._createCallback(Yv.TOUCH_CANCEL)}_createCallback(e){return t=>{const i=[],n=t.length,s=gn.windowSize;for(let e=0;e<n;++e){const n=t[e],o=this._getLocation(n),r=o.x,a=s.height-o.y,c={identifier:n.identifier,x:r,y:a,force:n.force};i.push(c)}const o={type:e,changedTouches:i,timestamp:performance.now()};this._eventTarget.emit(e,o)}}_getLocation(e){return new nn(e.clientX,e.clientY)}onStart(e){this._eventTarget.on(Yv.TOUCH_START,e)}onMove(e){this._eventTarget.on(Yv.TOUCH_MOVE,e)}onEnd(e){this._eventTarget.on(Yv.TOUCH_END,e)}onCancel(e){this._eventTarget.on(Yv.TOUCH_CANCEL,e)}}const hw=new class{constructor(){this._touch=new lw,this._mouse=new cw,this._keyboard=new aw,this._accelerometer=new iw,this._inputBox=new nw,this._touchEvents=[],this._mouseEvents=[],this._keyboardEvents=[],this._accelerometerEvents=[],this._registerEvent()}_registerEvent(){if(this._touch.support){const e=this._touchEvents;this._touch.onStart((t=>{e.push(t)})),this._touch.onMove((t=>{e.push(t)})),this._touch.onEnd((t=>{e.push(t)})),this._touch.onCancel((t=>{e.push(t)}))}if(this._mouse.support){const e=this._mouseEvents;this._mouse.onDown((t=>{e.push(t)})),this._mouse.onMove((t=>{e.push(t)})),this._mouse.onUp((t=>{e.push(t)})),this._mouse.onWheel((t=>{e.push(t)}))}if(this._keyboard.support){const e=this._keyboardEvents;this._keyboard.onPressing((t=>{e.push(t)})),this._keyboard.onUp((t=>{e.push(t)}))}if(this._accelerometer.support){const e=this._accelerometerEvents;this._accelerometer.onChange((t=>{e.push(t)}))}}startAccelerometer(){this._accelerometer.start()}stopAccelerometer(){this._accelerometer.stop()}setAccelerometerInterval(e){this._accelerometer.setInterval(e)}pollTouchEvents(){const e=De.array.copy(this._touchEvents);return this._touchEvents.length=0,e}pollMouseEvents(){const e=De.array.copy(this._mouseEvents);return this._mouseEvents.length=0,e}pollKeyboardEvents(){const e=De.array.copy(this._keyboardEvents);return this._keyboardEvents.length=0,e}pollAccelerometerEvents(){const e=De.array.copy(this._accelerometerEvents);return this._accelerometerEvents.length=0,e}},uw=new nn;class _w extends _h{get eventType(){return this._eventType}constructor(e,t,i){super(e,t),this.movementX=0,this.movementY=0,this._eventType=void 0,this._button=_w.BUTTON_MISSING,this._x=0,this._y=0,this._prevX=0,this._prevY=0,this._scrollX=0,this._scrollY=0,this._eventType=e,i&&(this._prevX=i.x,this._prevY=i.y)}setScrollData(e,t){this._scrollX=e,this._scrollY=t}getScrollX(){return this._scrollX}getScrollY(){return this._scrollY}setLocation(e,t){this._x=e,this._y=t}getLocation(e){return e||(e=new nn),nn.set(e,this._x,this._y),e}getLocationInView(e){return e||(e=new nn),nn.set(e,this._x,n.view._designResolutionSize.height-this._y),e}getUILocation(e){return e||(e=new nn),nn.set(e,this._x,this._y),n.view._convertPointWithScale(e),e}getPreviousLocation(e){return e||(e=new nn),nn.set(e,this._prevX,this._prevY),e}getUIPreviousLocation(e){return e||(e=new nn),nn.set(e,this._prevX,this._prevY),n.view._convertPointWithScale(e),e}getDelta(e){return e||(e=new nn),nn.set(e,this._x-this._prevX,this._y-this._prevY),e}getDeltaX(){return this._x-this._prevX}getDeltaY(){return this._y-this._prevY}getUIDelta(e){return e||(e=new nn),nn.set(e,(this._x-this._prevX)/n.view.getScaleX(),(this._y-this._prevY)/n.view.getScaleY()),e}getUIDeltaX(){return(this._x-this._prevX)/n.view.getScaleX()}getUIDeltaY(){return(this._y-this._prevY)/n.view.getScaleY()}setButton(e){this._button=e}getButton(){return this._button}getLocationX(){return this._x}getLocationY(){return this._y}getUILocationX(){const e=n.view.getViewportRect();return(this._x-e.x)/n.view.getScaleX()}getUILocationY(){const e=n.view.getViewportRect();return(this._y-e.y)/n.view.getScaleY()}}e("EventMouse",_w),_w.BUTTON_MISSING=-1,_w.BUTTON_LEFT=0,_w.BUTTON_RIGHT=2,_w.BUTTON_MIDDLE=1,_w.BUTTON_4=3,_w.BUTTON_5=4,_w.BUTTON_6=5,_w.BUTTON_7=6,_w.BUTTON_8=7;class pw extends _h{constructor(e,t,i,n=[]){super(i,t),this.touch=null,this.simulate=!1,this._eventCode=void 0,this._touches=void 0,this._allTouches=void 0,this._eventCode=i,this._touches=e||[],this._allTouches=n}getEventCode(){return this._eventCode}getTouches(){return this._touches}getAllTouches(){return this._allTouches}setLocation(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}getLocation(e){return this.touch?this.touch.getLocation(e):new nn}getUILocation(e){return this.touch?this.touch.getUILocation(e):new nn}getLocationInView(e){return this.touch?this.touch.getLocationInView(e):new nn}getPreviousLocation(e){return this.touch?this.touch.getPreviousLocation(e):new nn}getStartLocation(e){return this.touch?this.touch.getStartLocation(e):new nn}getUIStartLocation(e){return this.touch?this.touch.getUIStartLocation(e):new nn}getID(){return this.touch?this.touch.getID():null}getDelta(e){return this.touch?this.touch.getDelta(e):new nn}getUIDelta(e){return this.touch?this.touch.getUIDelta(e):new nn}getDeltaX(){return this.touch?this.touch.getDelta(uw).x:0}getDeltaY(){return this.touch?this.touch.getDelta(uw).y:0}getLocationX(){return this.touch?this.touch.getLocationX():0}getLocationY(){return this.touch?this.touch.getLocationY():0}}e("EventTouch",pw),pw.MAX_TOUCHES=5;class dw extends _h{constructor(e,t){super(Yv.DEVICEMOTION,t),this.acc=void 0,this.acc=e}}e("EventAcceleration",dw);class fw extends _h{get isPressed(){return this._isPressed}constructor(e,t,i){"boolean"==typeof t&&(t=t?Yv.KEY_DOWN:Yv.KEY_UP),super(t,i),this.keyCode=void 0,this.rawEvent=void 0,this._isPressed=void 0,this._isPressed=t!==Yv.KEY_UP,"number"==typeof e?this.keyCode=e:(this.keyCode=e.keyCode,this.rawEvent=e)}}e("EventKeyboard",fw),_h.EventMouse=_w,_h.EventTouch=pw,_h.EventAcceleration=dw,_h.EventKeyboard=fw;const mw=new nn;class gw{get lastModified(){return this._lastModified}constructor(e,t,i=0){this._point=new nn,this._prevPoint=new nn,this._lastModified=0,this._id=0,this._startPoint=new nn,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}getLocation(e){return e||(e=new nn),e.set(this._point.x,this._point.y),e}getLocationX(){return this._point.x}getLocationY(){return this._point.y}getUILocation(e){return e||(e=new nn),e.set(this._point.x,this._point.y),n.view._convertPointWithScale(e),e}getUILocationX(){const e=n.view.getViewportRect();return(this._point.x-e.x)/n.view.getScaleX()}getUILocationY(){const e=n.view.getViewportRect();return(this._point.y-e.y)/n.view.getScaleY()}getPreviousLocation(e){return e||(e=new nn),e.set(this._prevPoint.x,this._prevPoint.y),e}getUIPreviousLocation(e){return e||(e=new nn),e.set(this._prevPoint.x,this._prevPoint.y),n.view._convertPointWithScale(e),e}getStartLocation(e){return e||(e=new nn),e.set(this._startPoint.x,this._startPoint.y),e}getUIStartLocation(e){return e||(e=new nn),e.set(this._startPoint.x,this._startPoint.y),n.view._convertPointWithScale(e),e}getDelta(e){return e||(e=new nn),e.set(this._point),e.subtract(this._prevPoint),e}getUIDelta(e){return e||(e=new nn),mw.set(this._point),mw.subtract(this._prevPoint),e.set(n.view.getScaleX(),n.view.getScaleY()),nn.divide(e,mw,e),e}getLocationInView(e){return e||(e=new nn),e.set(this._point.x,n.view._designResolutionSize.height-this._point.y),e}getPreviousLocationInView(e){return e||(e=new nn),e.set(this._prevPoint.x,n.view._designResolutionSize.height-this._prevPoint.y),e}getStartLocationInView(e){return e||(e=new nn),e.set(this._startPoint.x,n.view._designResolutionSize.height-this._startPoint.y),e}getID(){return this._id}setTouchInfo(e=0,t,i){this._prevPoint=this._point,this._point=new nn(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new nn(this._point),this._startPointCaptured=!0)}setPoint(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=n.game.frameStartTime}setPrevPoint(e,t){this._prevPoint="object"==typeof e?new nn(e.x,e.y):new nn(e||0,t||0),this._lastModified=n.game.frameStartTime}}e("Touch",gw),n.Touch=gw;class vw{constructor(e=0,t=0,i=0,n=0){this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n}}const yw=Ge.TOUCH_TIMEOUT,xw=new nn,Sw=new nn,bw=new class{constructor(){this._preTouchPoint=new nn,this._prevMousePoint=new nn,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._glView=null}clearEvents(){hw.pollMouseEvents(),hw.pollTouchEvents(),hw.pollKeyboardEvents(),hw.pollAccelerometerEvents()}frameDispatchEvents(){const e=hw.pollMouseEvents();for(let t=0,i=e.length;t<i;++t){const i=e[t];this._dispatchMouseEvent(i)}const t=hw.pollTouchEvents();for(let e=0,i=t.length;e<i;++e){const i=t[e];this._dispatchTouchEvent(i)}const i=hw.pollKeyboardEvents();for(let e=0,t=i.length;e<t;++e){const t=i[e];this._dispatchKeyboardEvent(t)}const n=hw.pollAccelerometerEvents();for(let e=0,t=n.length;e<t;++e){const t=n[e];this._dispatchAccelerometerEvent(t)}}_dispatchMouseEvent(e){let t,i;switch(e.type){case Yv.MOUSE_DOWN:t=this._getMouseEvent(e),i=this._getTouch(e),this._handleTouchesStart([i]),ay.dispatchEvent(t);break;case Yv.MOUSE_MOVE:t=this._getMouseEvent(e),i=this._getTouch(e),this._handleTouchesMove([i]),ay.dispatchEvent(t);break;case Yv.MOUSE_UP:t=this._getMouseEvent(e),i=this._getTouch(e),this._handleTouchesEnd([i]),ay.dispatchEvent(t);break;case Yv.MOUSE_WHEEL:t=this._getMouseEvent(e),t.setScrollData(e.deltaX,e.deltaY),ay.dispatchEvent(t)}}_dispatchTouchEvent(e){const t=this._getTouchList(e);switch(e.type){case Yv.TOUCH_START:this._handleTouchesStart(t);break;case Yv.TOUCH_MOVE:this._handleTouchesMove(t);break;case Yv.TOUCH_END:this._handleTouchesEnd(t);break;case Yv.TOUCH_CANCEL:this._handleTouchesCancel(t)}}_handleTouchesStart(e){const t=[],i=this._touchesIntegerDict;for(let n=0;n<e.length;++n){const s=e[n],o=s.getID();if(null!==o&&void 0===i[o]){const e=this._getUnUsedIndex();if(-1===e){S(2300,e);continue}s.getLocation(xw);const n=new gw(xw.x,xw.y,o);this._touches[e]=n,s.getPreviousLocation(xw),n.setPrevPoint(xw),i[o]=e,t.push(n)}}if(t.length>0){const e=new pw(t,!1,Yv.TOUCH_START,Ge.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);ay.dispatchEvent(e)}}_handleTouchesMove(e){const t=[],i=this._touches;for(let n=0;n<e.length;++n){const s=e[n],o=s.getID();if(null===o)continue;const r=this._touchesIntegerDict[o];void 0!==r&&i[r]&&(s.getLocation(xw),i[r].setPoint(xw),s.getPreviousLocation(xw),i[r].setPrevPoint(xw),t.push(i[r]))}if(t.length>0){const e=new pw(t,!1,Yv.TOUCH_MOVE,Ge.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);ay.dispatchEvent(e)}}_handleTouchesEnd(e){const t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){const e=new pw(t,!1,Yv.TOUCH_END,Ge.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);ay.dispatchEvent(e)}this._preTouchPool.length=0}_handleTouchesCancel(e){const t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){const e=new pw(t,!1,Yv.TOUCH_CANCEL,Ge.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);ay.dispatchEvent(e)}this._preTouchPool.length=0}getSetOfTouchesEndOrCancel(e){const t=[],i=this._touches,n=this._touchesIntegerDict;for(let s=0;s<e.length;++s){const o=e[s],r=o.getID();if(null===r)continue;const a=n[r];void 0!==a&&i[a]&&(o.getLocation(xw),i[a].setPoint(xw),o.getPreviousLocation(xw),i[a].setPrevPoint(xw),t.push(i[a]),this._removeUsedIndexBit(a),delete n[r])}return t}_getPreTouch(e){let t=null;const i=this._preTouchPool,n=e.getID();for(let e=i.length-1;e>=0;e--)if(i[e].getID()===n){t=i[e];break}return t||(t=e),t}_setPreTouch(e){let t=!1;const i=this._preTouchPool,n=e.getID();for(let s=i.length-1;s>=0;s--)if(i[s].getID()===n){i[s]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}_getViewPixelRatio(){return this._glView||(this._glView=n.view),this._glView?this._glView._devicePixelRatio:1}_getTouch(e){const t=this._preTouchPoint,i=this._getViewPixelRatio(),n=e.x*i,s=e.y*i,o=new gw(n,s,0);return o.setPrevPoint(t.x,t.y),t.x=n,t.y=s,o}_getMouseEvent(e){const t=this._prevMousePoint,i=new _w(e.type,!1,t),s=this._getViewPixelRatio();return t.x=e.x*s,t.y=e.y*s,n.GAME_VIEW&&(t.x/=n.gameView.canvas.width/n.game.canvas.width,t.y/=n.gameView.canvas.height/n.game.canvas.height),i.setLocation(t.x,t.y),i.setButton(e.button),e.movementX&&(i.movementX=e.movementX),e.movementY&&(i.movementY=e.movementY),i}_getTouchList(e){const t=[],i=this._preTouchPoint,n=e.changedTouches.length,s=this._getViewPixelRatio();for(let o=0;o<n;o++){const n=e.changedTouches[o],r=n.x*s,a=n.y*s,c=new gw(r,a,n.identifier);if(this._getPreTouch(c).getLocation(Sw),c.setPrevPoint(Sw.x,Sw.y),this._setPreTouch(c),i.x=r,i.y=a,t.push(c),!Ge.ENABLE_MULTI_TOUCH)break}return t}_getUnUsedIndex(){let e=this._indexBitsUsed;const t=n.game.frameStartTime;for(let i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;{const e=this._touches[i];if(t-e.lastModified>yw){this._removeUsedIndexBit(i);const t=e.getID();return null!==t&&delete this._touchesIntegerDict[t],i}}e>>=1}return-1}_removeUsedIndexBit(e){if(e<0||e>=this._maxTouches)return;let t=1<<e;t=~t,this._indexBitsUsed&=t}_getUsefulTouches(){const e=[],t=this._touchesIntegerDict;for(const i in t){const n=t[parseInt(i)];if(null==n)continue;const s=this._touches[n];e.push(s)}return e}_dispatchKeyboardEvent(e){switch(e.type){case Yv.KEY_DOWN:ay.dispatchEvent(new fw(e.code,Yv.KEY_DOWN));break;case Yv.KEY_UP:ay.dispatchEvent(new fw(e.code,Yv.KEY_UP))}}_dispatchAccelerometerEvent(e){if(e.type===Yv.DEVICEMOTION){const{x:t,y:i,z:n,timestamp:s}=e;ay.dispatchEvent(new dw(new vw(t,i,n,s)))}}setAccelerometerEnabled(e){e?hw.startAccelerometer():hw.stopAccelerometer()}setAccelerometerInterval(e){hw.setAccelerometerInterval(e)}};n.internal.inputManager=bw;let Tw=null,Ew=null,Cw=null,ww=null;class Aw extends Vt{constructor(){super()}setAccelerometerEnabled(e){e&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((e=>{S(3520,e),bw.setAccelerometerEnabled("granted"===e)})).catch((e=>{T(3521,e.message),bw.setAccelerometerEnabled(!1)})):bw.setAccelerometerEnabled(e)}setAccelerometerInterval(e){bw.setAccelerometerInterval(e)}on(e,t,i,s){return super.on(e,t,i,s),e!==Yv.KEY_DOWN&&e!==Yv.KEY_UP||Tw||(Tw=Kv.create({event:Kv.KEYBOARD,onKeyDown(e,t){Pw.emit(t.type,t)},onKeyPressed(e,t){Pw.emit(t.type,t)},onKeyReleased(e,t){Pw.emit(t.type,t)}}),ay.addListener(Tw,256)),e===Yv.DEVICEMOTION&&(Ew||(Ew=Kv.create({event:Kv.ACCELERATION,callback(e,t){n.systemEvent.emit(t.type,t)}}),ay.addListener(Ew,256))),e!==Yv.TOUCH_START&&e!==Yv.TOUCH_MOVE&&e!==Yv.TOUCH_END&&e!==Yv.TOUCH_CANCEL||Cw||(Cw=Kv.create({event:Kv.TOUCH_ONE_BY_ONE,onTouchBegan:(e,t)=>(n.systemEvent.emit(t.type,e,t),!0),onTouchMoved(e,t){n.systemEvent.emit(t.type,e,t)},onTouchEnded(e,t){n.systemEvent.emit(t.type,e,t)},onTouchCancelled(e,t){n.systemEvent.emit(t.type,e,t)}}),ay.addListener(Cw,256)),e!==Yv.MOUSE_DOWN&&e!==Yv.MOUSE_MOVE&&e!==Yv.MOUSE_UP&&e!==Yv.MOUSE_WHEEL||ww||(ww=Kv.create({event:Kv.MOUSE,onMouseDown(e){n.systemEvent.emit(e.type,e)},onMouseMove(e){n.systemEvent.emit(e.type,e)},onMouseUp(e){n.systemEvent.emit(e.type,e)},onMouseScroll(e){n.systemEvent.emit(e.type,e)}}),ay.addListener(ww,256)),t}off(e,t,i){if(super.off(e,t,i),Tw&&(e===Yv.KEY_DOWN||e===Yv.KEY_UP)){const e=this.hasEventListener(Yv.KEY_DOWN),t=this.hasEventListener(Yv.KEY_UP);e||t||(ay.removeListener(Tw),Tw=null)}if(Ew&&e===Yv.DEVICEMOTION&&(ay.removeListener(Ew),Ew=null),Cw&&(e===Yv.TOUCH_START||e===Yv.TOUCH_MOVE||e===Yv.TOUCH_END||e===Yv.TOUCH_CANCEL)){const e=this.hasEventListener(Yv.TOUCH_START),t=this.hasEventListener(Yv.TOUCH_MOVE),i=this.hasEventListener(Yv.TOUCH_END),n=this.hasEventListener(Yv.TOUCH_CANCEL);e||t||i||n||(ay.removeListener(Cw),Cw=null)}if(ww&&(e===Yv.MOUSE_DOWN||e===Yv.MOUSE_MOVE||e===Yv.MOUSE_UP||e===Yv.MOUSE_WHEEL)){const e=this.hasEventListener(Yv.MOUSE_DOWN),t=this.hasEventListener(Yv.MOUSE_MOVE),i=this.hasEventListener(Yv.MOUSE_UP),n=this.hasEventListener(Yv.MOUSE_WHEEL);e||t||i||n||(ay.removeListener(ww),ww=null)}}}e("SystemEvent",Aw),Aw.EventType=Yv,n.SystemEvent=Aw;const Pw=e("systemEvent",new Aw);n.systemEvent=Pw;class Rw extends Vt{constructor(...e){super(...e),this.frame=null,this.container=null,this.canvas=null,this.renderType=-1,this.eventTargetOn=super.on,this.eventTargetOnce=super.once,this.config={},this.onStart=null,this.frameTime=1e3/60,this.collisionMatrix=[],this.groupList=[],this._persistRootNodes={},this._gfxDevice=null,this._configLoaded=!1,this._isCloning=!1,this._inited=!1,this._engineInited=!1,this._rendererInitialized=!1,this._paused=!0,this._frameRate=60,this._intervalId=0,this._initTime=0,this._startTime=0,this._deltaTime=0}get inited(){return this._inited}get frameRate(){return this._frameRate}set frameRate(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}get deltaTime(){return this._deltaTime}get totalTime(){return performance.now()-this._initTime}get frameStartTime(){return this._startTime}setFrameRate(e){this.frameRate=e}getFrameRate(){return this.frameRate}step(){n.director.tick(this.frameTime/1e3)}pause(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}resume(){this._paused&&(bw.clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))}isPaused(){return this._paused}restart(){return new Promise((e=>n.director.once(n.Director.EVENT_END_FRAME,(()=>e())))).then((()=>{for(const e in this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[e]);return n.director.getScene().destroy(),n.Object._deferredDestroy(),n.director.reset(),this.pause(),this._setRenderPipelineNShowSplash().then((()=>{this.resume(),this._safeEmit(Rw.EVENT_RESTART)}))}))}end(){qt.close()}on(e,t,i,n){return(this._engineInited&&e===Rw.EVENT_ENGINE_INITED||this._inited&&e===Rw.EVENT_GAME_INITED||this._rendererInitialized&&e===Rw.EVENT_RENDERER_INITED)&&t.call(i),this.eventTargetOn(e,t,i,n)}once(e,t,i){return this._engineInited&&e===Rw.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}init(e){if(this._initConfig(e),this.config.assetOptions&&n.assetManager.init(this.config.assetOptions),this.config.layers){const e=this.config.layers;for(let t=0;t<e.length;t++){const i=e[t],n=Kt(i.value);id.addLayer(i.name,n)}}return this._initEngine().then((()=>(this._initEvents(),n.director.root&&n.director.root.dataPoolManager&&n.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),this._engineInited)))}run(e,t){let i;return"function"!=typeof e&&e?(i=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,ph.init(),Promise.resolve(i).then((()=>this._setRenderPipelineNShowSplash()))}addPersistRootNode(e){if(!n.Node.isNode(e)||!e.uuid)return void T(3800);const t=e.uuid;if(!this._persistRootNodes[t]){const i=n.director._scene;if(n.isValid(i))if(e.parent){if(!(e.parent instanceof n.Scene))return void T(3801);if(e.parent!==i)return void T(3802);e._originalSceneId=i.uuid}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0,n.assetManager._releaseManager._addPersistNodeRef(e)}}removePersistRootNode(e){const t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",n.assetManager._releaseManager._removePersistNodeRef(e))}isPersistRootNode(e){return!!e._persistNode}_initEngine(){return this._initDevice(),Promise.resolve(n.director._init()).then((()=>{_(`Cocos Creator v${s}`),this.emit(Rw.EVENT_ENGINE_INITED),this._engineInited=!0,n.internal.dynamicAtlasManager&&(n.internal.dynamicAtlasManager.enabled=!Ge.CLEANUP_IMAGE_CACHE)}))}_setAnimFrame(){const e=this._frameRate;jsb.setPreferredFramesPerSecond(e),window.rAF=window.requestAnimationFrame,window.cAF=window.cancelAnimationFrame}_stTime(e){const t=performance.now(),i=Math.max(0,t-this._startTime),n=Math.max(0,this.frameTime-i);return window.setTimeout(e,n)}_ctTime(e){window.clearTimeout(e)}_calculateDT(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>Rw.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime}_updateCallback(){const e=n.director;let t;t=t=>{e.tick(this._calculateDT(t)),this._intervalId=window.rAF(this._frameCB)},this._frameCB=t}_runMainLoop(){if(!this._inited)return;const e=this.config,t=n.director;M(!!e.showFPS),t.startAnimation(),this.resume()}_initConfig(e){"number"!=typeof e.debugMode&&(e.debugMode=P.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);const t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,g(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate}_determineRenderType(){const e=this.config,t=parseInt(e.renderMode,10);this.renderType=Rw.RENDER_TYPE_CANVAS;let i=!1;if(0===t?xn.capabilities.opengl?(this.renderType=Rw.RENDER_TYPE_WEBGL,i=!0):xn.capabilities.canvas&&(this.renderType=Rw.RENDER_TYPE_CANVAS,i=!0):1===t&&xn.capabilities.canvas?(this.renderType=Rw.RENDER_TYPE_CANVAS,i=!0):2===t&&xn.capabilities.opengl&&(this.renderType=Rw.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(R(3820,t))}_initDevice(){if(this._rendererInitialized)return;const e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===Rw.RENDER_TYPE_WEBGL){const e=[],t=Ge.ENABLE_WEBGL_ANTIALIAS,i=new gr(this.canvas,t,!1,window.devicePixelRatio,xn.windowPixelResolution.width,xn.windowPixelResolution.height,dd);if(window.gfx)this._gfxDevice=gfx.DeviceManager.create(i);else{let t=!!window.WebGL2RenderingContext;const s=window.navigator.userAgent.toLowerCase();(-1!==s.indexOf("safari")&&-1===s.indexOf("chrome")||xn.browserType===D.UC)&&(t=!1),t&&n.WebGL2Device&&e.push(n.WebGL2Device),n.WebGLDevice&&e.push(n.WebGLDevice);for(let t=0;t<e.length&&(this._gfxDevice=new e[t],!this._gfxDevice.initialize(i));t++);}}if(!this._gfxDevice)return d("can not support canvas rendering in 3D"),void(this.renderType=Rw.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=()=>!1}_initEvents(){qt.on("show",this._onShow,this),qt.on("hide",this._onHide,this)}_onHide(){this.emit(Rw.EVENT_HIDE),this.pause()}_onShow(){this.emit(Rw.EVENT_SHOW),this.resume()}_setRenderPipelineNShowSplash(){return Promise.resolve(this._setupRenderPipeline()).then((()=>Promise.resolve(this._showSplashScreen()).then((()=>{this._inited=!0,this._initTime=performance.now(),this._runMainLoop(),this._safeEmit(Rw.EVENT_GAME_INITED),this.onStart&&this.onStart()}))))}_setupRenderPipeline(){const{renderPipeline:e}=this.config;return e?new Promise(((t,i)=>{n.assetManager.loadAny(e,((e,n)=>!e&&n instanceof FC?t(n):i(e)))})).then((e=>{this._setRenderPipeline(e)})).catch((t=>{p(t),p(`Failed load render pipeline: ${e}, engine failed to initialize, will fallback to default pipeline`),this._setRenderPipeline()})):this._setRenderPipeline()}_showSplashScreen(){if(n.internal.SplashScreen){const e=n.internal.SplashScreen.instance;return e.main(n.director.root),new Promise((t=>{e.setOnFinish((()=>t())),e.loadFinish=!0}))}return null}_setRenderPipeline(e){n.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(Rw.EVENT_RENDERER_INITED)}_safeEmit(e){this.emit(e)}}e("Game",Rw),Rw.EVENT_HIDE="game_on_hide",Rw.EVENT_SHOW="game_on_show",Rw.EVENT_LOW_MEMORY="game_on_low_memory",Rw.EVENT_GAME_INITED="game_inited",Rw.EVENT_ENGINE_INITED="engine_inited",Rw.EVENT_RENDERER_INITED="renderer_inited",Rw.EVENT_RESTART="game_on_restart",Rw.RENDER_TYPE_CANVAS=0,Rw.RENDER_TYPE_WEBGL=1,Rw.RENDER_TYPE_OPENGL=2,Rw.DEBUG_DT_THRESHOLD=1,n.Game=Rw;const Iw=e("game",n.game=new Rw),Mw={topLeft:n.v2(0,0),topRight:n.v2(0,0),top:n.v2(0,0),bottomLeft:n.v2(0,0),bottomRight:n.v2(0,0),bottom:n.v2(0,0),center:n.v2(0,0),left:n.v2(0,0),right:n.v2(0,0),width:0,height:0,init(e){const t=this.width=e.width,i=this.height=e.height,n=e.x,s=e.y,o=s+i,r=n+t;this.topLeft.x=n,this.topLeft.y=o,this.topRight.x=r,this.topRight.y=o,this.top.x=n+t/2,this.top.y=o,this.bottomLeft.x=n,this.bottomLeft.y=s,this.bottomRight.x=r,this.bottomRight.y=s,this.bottom.x=n+t/2,this.bottom.y=s,this.center.x=n+t/2,this.center.y=s+i/2,this.left.x=n,this.left.y=s+i/2,this.right.x=r,this.right.y=s+i/2}};n.visibleRect=Mw;const Ow=e("screen",new class{get supportsFullScreen(){return gn.supportFullScreen}fullScreen(){return gn.isFullScreen}requestFullScreen(e,t,i){return arguments.length>0&&T(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),gn.requestFullScreen().then((()=>{null==t||t()})).catch((e=>{console.error(e),null==i||i()}))}exitFullScreen(){return gn.exitFullScreen()}autoFullScreen(e,t){var i;null===(i=this.requestFullScreen(e,t))||void 0===i||i.catch((()=>{}))}disableAutoFullScreen(e){}});n.screen=Ow;const Dw=new hn;class Nw extends Vt{constructor(){super(),this._resizeWithBrowserSize=void 0,this._designResolutionSize=void 0,this._frameSize=void 0,this._scaleX=void 0,this._scaleY=void 0,this._viewportRect=void 0,this._visibleRect=void 0,this._autoFullScreen=void 0,this._devicePixelRatio=void 0,this._maxPixelRatio=void 0,this._retinaEnabled=void 0,this._resizeCallback=void 0,this._resizing=void 0,this._orientationChanging=void 0,this._isRotated=void 0,this._orientation=void 0,this._resolutionPolicy=void 0,this._rpExactFit=void 0,this._rpShowAll=void 0,this._rpNoBorder=void 0,this._rpFixedHeight=void 0,this._rpFixedWidth=void 0;const e=Lw,t=Bw;this._frameSize=new hn(0,0),this._designResolutionSize=new hn(0,0),this._scaleX=1,this._scaleY=1,this._viewportRect=new _n(0,0,0,0),this._visibleRect=new _n(0,0,0,0),this._autoFullScreen=!1,this._devicePixelRatio=1,this._maxPixelRatio=4,this._retinaEnabled=!1,this._resizeCallback=null,this._resizing=!1,this._resizeWithBrowserSize=!1,this._orientationChanging=!0,this._isRotated=!1,this._orientation=n.macro.ORIENTATION_AUTO,this._rpExactFit=new zw(e.EQUAL_TO_FRAME,t.EXACT_FIT),this._rpShowAll=new zw(e.EQUAL_TO_FRAME,t.SHOW_ALL),this._rpNoBorder=new zw(e.EQUAL_TO_FRAME,t.NO_BORDER),this._rpFixedHeight=new zw(e.EQUAL_TO_FRAME,t.FIXED_HEIGHT),this._rpFixedWidth=new zw(e.EQUAL_TO_FRAME,t.FIXED_WIDTH),this._resolutionPolicy=this._rpShowAll,n.game.once(n.Game.EVENT_ENGINE_INITED,this.init,this)}init(){this._initFrameSize();const e=n.game.canvas.width,t=n.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,Dw.width=this._visibleRect.width,Dw.height=this._visibleRect.height,Mw&&Mw.init(this._visibleRect)}resizeWithBrowserSize(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,gn.on("window-resize",this._resizeEvent,this),gn.on("orientation-change",this._orientationChange,this)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,gn.off("window-resize",this._resizeEvent,this),gn.off("orientation-change",this._orientationChange,this))}setResizeCallback(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}setOrientation(e){(e&=n.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}adjustViewportMeta(e){}enableRetina(e){this._retinaEnabled=!!e}isRetinaEnabled(){return this._retinaEnabled}enableAutoFullScreen(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&Ow.requestFullScreen().catch((()=>{})))}isAutoFullScreenEnabled(){return this._autoFullScreen}setCanvasSize(e,t){const i=n.game.canvas,s=n.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=xn.windowPixelResolution.width,i.height=xn.windowPixelResolution.height,i.style.width=`${e}px`,i.style.height=`${t}px`,s.style.width=`${e}px`,s.style.height=`${t}px`,this._resizeEvent()}getCanvasSize(){return new hn(n.game.canvas.width,n.game.canvas.height)}getFrameSize(){return new hn(this._frameSize.width,this._frameSize.height)}setFrameSize(e,t){this._frameSize.width=e,this._frameSize.height=t,n.game.frame.style.width=`${e}px`,n.game.frame.style.height=`${t}px`,this._resizeEvent()}getVisibleSize(){return new hn(this._visibleRect.width,this._visibleRect.height)}getVisibleSizeInPixel(){return new hn(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}getVisibleOrigin(){return new nn(this._visibleRect.x,this._visibleRect.y)}getVisibleOriginInPixel(){return new nn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}getResolutionPolicy(){return this._resolutionPolicy}setResolutionPolicy(e){if(e instanceof zw)this._resolutionPolicy=e;else{const t=zw;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}setDesignResolutionSize(e,t,i){if(!(e>0&&t>0))return void C(2200);this.setResolutionPolicy(i);const n=this._resolutionPolicy;if(n&&n.preApply(this),this._orientationChanging=!0,this._resizing||this._initFrameSize(),!n)return void S(2201);this._designResolutionSize.width=e,this._designResolutionSize.height=t;const s=n.apply(this,this._designResolutionSize);if(s.scale&&2===s.scale.length&&(this._scaleX=s.scale[0],this._scaleY=s.scale[1]),s.viewport){const e=this._viewportRect,t=this._visibleRect,i=s.viewport;e.x=i.x,e.y=i.y,e.width=i.width,e.height=i.height,t.x=0,t.y=0,t.width=i.width/this._scaleX,t.height=i.height/this._scaleY}n.postApply(this),Dw.width=this._visibleRect.width,Dw.height=this._visibleRect.height,Mw&&Mw.init(this._visibleRect),this.emit("design-resolution-changed")}getDesignResolutionSize(){return new hn(this._designResolutionSize.width,this._designResolutionSize.height)}setRealPixelResolution(e,t,i){this.setDesignResolutionSize(e,t,i)}getViewportRect(){return this._viewportRect}getScaleX(){return this._scaleX}getScaleY(){return this._scaleY}getDevicePixelRatio(){return this._devicePixelRatio}convertToLocationInView(e,t,i,s){const o=s||new nn,r=this._devicePixelRatio*(e-i.left),a=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(o.x=n.game.canvas.width-a,o.y=r):(o.x=r,o.y=a),n.GAME_VIEW&&(o.x/=n.gameView.canvas.width/n.game.canvas.width,o.y/=n.gameView.canvas.height/n.game.canvas.height),o}_convertPointWithScale(e){const t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}_resizeEvent(){var e;if(this._frameSize.width,this._frameSize.height,this._isRotated,n.sys.isMobile){const e=n.game.container.style,t=e.margin;e.margin="0",e.display="none",this._initFrameSize(),e.margin=t,e.display="block"}else this._initFrameSize();const t=this._designResolutionSize.width,i=this._designResolutionSize.height;this._resizing=!0,t>0&&this.setDesignResolutionSize(t,i,this._resolutionPolicy),this._resizing=!1,this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)}_orientationChange(){this._orientationChanging=!0,this._resizeEvent()}_initFrameSize(){const e=this._frameSize,t=gn.windowSize,i=t.width,s=t.height,o=i>=s;!n.sys.isMobile||o&&this._orientation&n.macro.ORIENTATION_LANDSCAPE||!o&&this._orientation&n.macro.ORIENTATION_PORTRAIT?(e.width=i,e.height=s,n.game.container.style["-webkit-transform"]="rotate(0deg)",n.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=s,e.height=i,n.game.container.style["-webkit-transform"]="rotate(90deg)",n.game.container.style.transform="rotate(90deg)",n.game.container.style["-webkit-transform-origin"]="0px 0px 0px",n.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,n.game.canvas.style["-webkit-transform"]="translateZ(0px)",n.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((()=>{n.view._orientationChanging=!1}),1e3)}}e("View",Nw),Nw.instance=void 0;class Lw{constructor(){this.name="ContainerStrategy"}preApply(e){}apply(e,t){}postApply(e){}_setupContainer(e,t,i){const s=n.game.canvas,o=n.game.container;xn.os!==B.ANDROID&&xn.os!==B.OHOS||(document.body.style.width=`${e._isRotated?i:t}px`,document.body.style.height=`${e._isRotated?t:i}px`),o.style.width=s.style.width=`${t}px`,o.style.height=s.style.height=`${i}px`,e._devicePixelRatio=1,e.isRetinaEnabled()&&(e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),s.width=xn.windowPixelResolution.width,s.height=xn.windowPixelResolution.height}_fixContainer(){document.body.insertBefore(n.game.container,document.body.firstChild);const e=document.body.style;e.width=`${window.innerWidth}px`,e.height=`${window.innerHeight}px`,e.overflow="hidden";const t=n.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}Lw.EQUAL_TO_FRAME=void 0,Lw.PROPORTION_TO_FRAME=void 0;class Bw{constructor(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}preApply(e){}apply(e,t){return{scale:[1,1]}}postApply(e){}_buildResult(e,t,i,n,s,o){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);const r=new _n(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[s,o],this._result.viewport=r,this._result}}Bw.EXACT_FIT=void 0,Bw.SHOW_ALL=void 0,Bw.NO_BORDER=void 0,Bw.FIXED_HEIGHT=void 0,Bw.FIXED_WIDTH=void 0,(()=>{const e=("undefined"==typeof window?global:window).__globalAdapter;e&&(e.adaptContainerStrategy&&e.adaptContainerStrategy(Lw.prototype),e.adaptView&&e.adaptView(Nw.prototype)),Lw.EQUAL_TO_FRAME=new class extends Lw{constructor(...e){super(...e),this.name="EqualToFrame"}apply(e){const t=e._frameSize.height,i=n.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin=`0 0 0 ${t}px`:i.margin="0px",i.padding="0px"}},Lw.PROPORTION_TO_FRAME=new class extends Lw{constructor(...e){super(...e),this.name="ProportionalToFrame"}apply(e,t){const i=e._frameSize.width,s=e._frameSize.height,o=n.game.container.style,r=t.width,a=t.height,c=i/r,l=s/a;let h,u;c<l?(h=i,u=a*c):(h=r*l,u=s);const _=Math.round((i-h)/2),p=Math.round((s-u)/2);h=i-2*_,u=s-2*p,this._setupContainer(e,h,u),e._isRotated?o.margin=`0 0 0 ${s}px`:o.margin="0px",o.paddingLeft=`${_}px`,o.paddingRight=`${_}px`,o.paddingTop=`${p}px`,o.paddingBottom=`${p}px`}},Bw.EXACT_FIT=new class extends Bw{constructor(...e){super(...e),this.name="ExactFit"}apply(e,t){const i=n.game.canvas.width,s=n.game.canvas.height,o=i/t.width,r=s/t.height;return this._buildResult(i,s,i,s,o,r)}},Bw.SHOW_ALL=new class extends Bw{constructor(...e){super(...e),this.name="ShowAll"}apply(e,t){const i=n.game.canvas.width,s=n.game.canvas.height,o=t.width,r=t.height,a=i/o,c=s/r;let l,h,u=0;return a<c?(u=a,l=i,h=r*u):(u=c,l=o*u,h=s),this._buildResult(i,s,l,h,u,u)}},Bw.NO_BORDER=new class extends Bw{constructor(...e){super(...e),this.name="NoBorder"}apply(e,t){const i=n.game.canvas.width,s=n.game.canvas.height,o=t.width,r=t.height,a=i/o,c=s/r;let l,h,u;return a<c?(l=c,h=o*l,u=s):(l=a,h=i,u=r*l),this._buildResult(i,s,h,u,l,l)}},Bw.FIXED_HEIGHT=new class extends Bw{constructor(...e){super(...e),this.name="FixedHeight"}apply(e,t){const i=n.game.canvas.width,s=n.game.canvas.height,o=s/t.height,r=i,a=s;return this._buildResult(i,s,r,a,o,o)}},Bw.FIXED_WIDTH=new class extends Bw{constructor(...e){super(...e),this.name="FixedWidth"}apply(e,t){const i=n.game.canvas.width,s=n.game.canvas.height,o=i/t.width,r=i,a=s;return this._buildResult(i,s,r,a,o,o)}}})();class zw{constructor(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}get canvasSize(){return new nn(n.game.canvas.width,n.game.canvas.height)}preApply(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}apply(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}postApply(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}setContainerStrategy(e){e instanceof Lw&&(this._containerStrategy=e)}setContentStrategy(e){e instanceof Bw&&(this._contentStrategy=e)}}e("ResolutionPolicy",zw),zw.EXACT_FIT=0,zw.NO_BORDER=1,zw.SHOW_ALL=2,zw.FIXED_HEIGHT=3,zw.FIXED_WIDTH=4,zw.UNKNOWN=5,zw.ContainerStrategy=Lw,zw.ContentStrategy=Bw,n.ResolutionPolicy=zw;const Fw=e("view",Nw.instance=n.view=new Nw);n.winSize=Dw,ti(Nw.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),ii(Nw.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"}]),ii(n,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),ei(_h,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:Aw.EventType,targetName:"SystemEvent.EventType"}]),ii(_h,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),ei(_w,"EventMouse",["DOWN","UP","MOVE"].map((e=>({name:e,newName:`MOUSE_${e}`,target:Aw.EventType,targetName:"SystemEvent.EventType"})))),ei(_w,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:Aw.EventType,targetName:"SystemEvent.EventType"}]),ii(_w.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),ei(pw,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:Aw.EventType,targetName:"SystemEvent.EventType"}]),ei(pw,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:Aw.EventType,targetName:"SystemEvent.EventType"}]),ei(pw,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:Aw.EventType,targetName:"SystemEvent.EventType"}]),ei(pw,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:Aw.EventType,targetName:"SystemEvent.EventType"}]),ii(pw.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),ei(xn,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((e=>({name:`LANGUAGE_${e}`,newName:e,target:xn.Language,targetName:"sys.Language"})))),ei(xn,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((e=>({name:`OS_${e}`,newName:e,target:xn.OS,targetName:"sys.OS"})))),ei(xn,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((e=>({name:`BROWSER_TYPE_${e}`,newName:e,target:xn.BrowserType,targetName:"sys.BrowserType"})))),ei(xn,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:xn.BrowserType,targetName:"sys.BrowserType"}]),ei(xn,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((e=>({name:e,target:xn.Platform,targetName:"sys.Platform"})))),ei(xn,"sys",[{name:"IPHONE",newName:"IOS",target:xn.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:xn.Platform,targetName:"sys.Platform"}]),ti(xn,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((e=>({name:e})))),ei(Yv,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((e=>({name:e,target:ix.EventType,targetName:"Node.EventType"})))),ei(ix.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:Aw.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:Aw.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:Aw.EventType,targetName:"SystemEvent.EventType"}]),ii(Ge.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((e=>({name:e})))),ii(Ge.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),ii(Ge.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),ii(Ge.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),ii(Ge,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),ii(Ow,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);const Uw=new nn;class Gw{set splashFinish(e){this._splashFinish=e,this._tryToStart()}set loadFinish(e){this._loadFinish=e,this._tryToStart()}main(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){const e=this.settings=window._CCSettings.splashScreen;e.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,e.base64src=this.settings.base64src||"",e.effect=this.settings.effect||"FADE-INOUT",e.clearColor=this.settings.clearColor||new Po(.88,.88,.88,1),e.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,e.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new Po(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{n.view.enableRetina(!0),n.view.resizeWithBrowserSize(!0);const t=window._CCSettings.designResolution;t?n.view.setDesignResolutionSize(t.width,t.height,t.policy):n.view.setDesignResolutionSize(960,640,4),this.root=e,this.device=e.device,n.game.once(n.Game.EVENT_GAME_INITED,(()=>{n.director._lateUpdate=performance.now()}),n.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else d("RENDER ROOT IS NULL.")}setOnFinish(e){if(this._directCall&&e)return Gw._ins=void 0,void e();this.callBack=e}_tryToStart(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),n.game.resume())}preInit(){const e=this.settings.clearColor;this.clearColors=[new Po(e.x,e.y,e.z,e.w)];const t=this.device;this.renderArea=new xo(0,0,t.width,t.height),this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=t.commandBuffer;const i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),n=4*Float32Array.BYTES_PER_ELEMENT,s=4*n;this.vertexBuffers=t.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,s,n)),this.vertexBuffers.update(i);const o=new Uint16Array([0,1,2,1,3,2]),r=Uint16Array.BYTES_PER_ELEMENT,a=6*r;this.indicesBuffers=t.createBuffer(new Io(Fs.INDEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,a,r)),this.indicesBuffers.update(o);const c=[new Xo("a_position",Ls.RG32F),new Xo("a_texCoord",Ls.RG32F)],l=new Ko(c,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(l),this.projection=new Zi,Zi.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,t.surfaceTransform)}init(){this.initLogo(),this.settings.displayWatermark&&this.initWarterMark();const e=t=>{if(this.cancelAnimate)return;const i=this.settings,n=this.device;Zi.ortho(this.projection,-1,1,-1,1,-1,1,n.capabilities.clipSpaceMinZ,n.capabilities.clipSpaceSignY,n.surfaceTransform);const s=n.width,o=n.height,r=s<o?s:o;this.startTime<0&&(this.startTime=t);const a=t-this.startTime;let c=Yu(fi(a/i.totalTime));"NONE"===i.effect&&(c=1);const l=this.logoTexture.width,h=this.logoTexture.height,u=r*i.displayRatio;let _=u*l/h,p=u;if(n.surfaceTransform!==Ds.ROTATE_90&&n.surfaceTransform!==Ds.ROTATE_270||(_=u*s/o,p=u*h/l*o/s),this.logoMat.setProperty("resolution",Uw.set(s,o),0),this.logoMat.setProperty("scale",Uw.set(_,p),0),this.logoMat.setProperty("translate",Uw.set(.5*s,.5*o),0),this.logoMat.setProperty("precent",c),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update(),i.displayWatermark&&this.watermarkMat){const e=.5*r,t=this.watermarkTexture.width;let i=e,a=e*this.watermarkTexture.height/t;n.surfaceTransform!==Ds.ROTATE_90&&n.surfaceTransform!==Ds.ROTATE_270||(i=.5*e,a=e*s/o*.5),this.watermarkMat.setProperty("resolution",Uw.set(s,o),0),this.watermarkMat.setProperty("scale",Uw.set(i,a),0),this.watermarkMat.setProperty("translate",Uw.set(.5*s,.1*o),0),this.watermarkMat.setProperty("precent",c),this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update()}this.frame(),a>i.totalTime&&(this.splashFinish=!0),requestAnimationFrame(e)};n.game.pause(),this.handle=requestAnimationFrame(e)}hide(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}initLogo(){const e=this.device;this.logoMat=new Wg,this.logoMat.initialize({effectName:"splash-screen"});const t=new zo;t.addressU=Xs.CLAMP,t.addressV=Xs.CLAMP,t.addressW=Xs.CLAMP,this.sampler=e.createSampler(t),this.logoTexture=e.createTexture(new Lo(Hs.TEX2D,Vs.SAMPLED|Vs.TRANSFER_DST,Ls.RGBA8,this.logoImage.width,this.logoImage.height));const i=this.logoMat.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.logoTexture),this.shader=i.getShaderVariant();const s=i.descriptorSet;s.bindSampler(n,this.sampler),s.update();const o=new wo;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])}initWarterMark(){const e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=`${e.width}`,e.style.height=`${e.height}`;const t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";const i="Powered by Cocos Creator",n=t.measureText(i);t.fillText(i,(330-n.width)/2,6);const s=new wo;s.texExtent.width=e.width,s.texExtent.height=e.height,s.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Lo(Hs.TEX2D,Vs.SAMPLED|Vs.TRANSFER_DST,Ls.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[s]),this.watermarkMat=new Wg,this.watermarkMat.initialize({effectName:"splash-screen"});const o=this.watermarkMat.passes[0],r=o.getBinding("mainTexture");o.bindTexture(r,this.watermarkTexture),o.descriptorSet.update()}frame(){const e=this.device;e.acquire();const t=this.cmdBuff,i=this.framebuffer,n=this.renderArea;n.width=e.width,n.height=e.height,t.begin(),t.beginRenderPass(i.renderPass,i,n,this.clearColors,1,0);const s=this.logoMat.passes[0],o=UC.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);if(t.bindPipelineState(o),t.bindDescriptorSet(pd.MATERIAL,s.descriptorSet),t.bindInputAssembler(this.quadAssmebler),t.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){const n=this.watermarkMat.passes[0],s=UC.getOrCreatePipelineState(e,n,this.shader,i.renderPass,this.quadAssmebler);t.bindPipelineState(s),t.bindDescriptorSet(pd.MATERIAL,n.descriptorSet),t.bindInputAssembler(this.quadAssmebler),t.draw(this.quadAssmebler)}t.endRenderPass(),t.end(),e.flushCommands([t]),e.queue.submit([t]),e.present()}destroy(){this.callBack=null,this.root=null,this.device=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,Gw._ins=void 0}static get instance(){return Gw._ins||(Gw._ins=new Gw),Gw._ins}constructor(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}}Gw._ins=void 0,n.internal.SplashScreen=Gw;class kw{constructor(){this._id="",this._priority=0,this._executeInEditMode=!1}set priority(e){this._priority=e}get priority(){return this._priority}set id(e){this._id=e}get id(){return this._id}static sortByPriority(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}init(){}update(e){}postUpdate(e){}}e("System",kw),kw.Priority=Le({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});const Hw=new X("Scheduler");class Vw{constructor(e,t,i,n){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=i,this.markedForDeletion=n}}Vw.get=(e,t,i,n)=>{let s=Vw._listEntries.pop();return s?(s.target=e,s.priority=t,s.paused=i,s.markedForDeletion=n):s=new Vw(e,t,i,n),s},Vw.put=e=>{Vw._listEntries.length<20&&(e.target=null,Vw._listEntries.push(e))},Vw._listEntries=[];class jw{constructor(e,t,i,n){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=i,this.callback=n}}jw.get=(e,t,i,n)=>{let s=jw._hashUpdateEntries.pop();return s?(s.list=e,s.entry=t,s.target=i,s.callback=n):s=new jw(e,t,i,n),s},jw.put=e=>{jw._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,jw._hashUpdateEntries.push(e))},jw._hashUpdateEntries=[];class Ww{constructor(e,t,i,n,s,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=s,this.paused=o}}Ww.get=(e,t,i,n,s,o)=>{let r=Ww._hashTimerEntries.pop();return r?(r.timers=e,r.target=t,r.timerIndex=i,r.currentTimer=n,r.currentTimerSalvaged=s,r.paused=o):r=new Ww(e,t,i,n,s,o),r},Ww.put=e=>{Ww._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,Ww._hashTimerEntries.push(e))},Ww._hashTimerEntries=[];class qw{constructor(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}initWithCallback(e,t,i,s,o,r){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=s,this._delay=r,this._useDelay=this._delay>0,this._repeat=o,this._runForever=this._repeat===n.macro.REPEAT_FOREVER,!0}getInterval(){return this._interval}setInterval(e){this._interval=e}update(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}getCallback(){return this._callback}trigger(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}cancel(){this._scheduler.unschedule(this._callback,this._target)}}qw._timers=[],qw.get=()=>qw._timers.pop()||new qw,qw.put=e=>{qw._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,qw._timers.push(e))};class Xw extends kw{static enableForTarget(e){let t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?T(1513):e.id=Hw.getNewId())}constructor(){super(),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=se(!0),this._hashForTimers=se(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}setTimeScale(e){this._timeScale=e}getTimeScale(){return this._timeScale}update(e){let t,i,n,s,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=this._updatesNegList,n=i.length;t<n;t++)s=i[t],s.paused||s.markedForDeletion||s.target.update(e);for(t=0,i=this._updates0List,n=i.length;t<n;t++)s=i[t],s.paused||s.markedForDeletion||s.target.update(e);for(t=0,i=this._updatesPosList,n=i.length;t<n;t++)s=i[t],s.paused||s.markedForDeletion||s.target.update(e);const r=this._arrayForTimers;for(t=0;t<r.length;t++){if(o=r[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)s=i[t],s.markedForDeletion?this._removeUpdateFromHash(s):t++;for(t=0,i=this._updates0List;t<i.length;)s=i[t],s.markedForDeletion?this._removeUpdateFromHash(s):t++;for(t=0,i=this._updatesPosList;t<i.length;)s=i[t],s.markedForDeletion?this._removeUpdateFromHash(s):t++;this._updateHashLocked=!1,this._currentTarget=null}schedule(e,t,i,s,o,r){if("function"!=typeof e){const i=e;e=t,t=i}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(r=!!s,s=n.macro.REPEAT_FOREVER,o=0),A(t,1502);const a=t.uuid||t.id;if(!a)return void C(1510);let c,l,h=this._hashForTimers[a];if(h?h.paused!==r&&T(1511):(h=Ww.get(null,t,0,null,null,r),this._arrayForTimers.push(h),this._hashForTimers[a]=h),null==h.timers)h.timers=[];else for(l=0;l<h.timers.length;++l)if(c=h.timers[l],c&&e===c._callback)return S(1507,c.getInterval(),i),void(c._interval=i);c=qw.get(),c.initWithCallback(this,e,t,i,s,o),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}scheduleUpdate(e,t,i){const n=e.uuid||e.id;if(!n)return void C(1510);const s=this._hashForUpdates[n];if(s&&s.entry){if(s.entry.priority===t)return s.entry.markedForDeletion=!1,void(s.entry.paused=i);if(this._updateHashLocked)return S(1506),s.entry.markedForDeletion=!1,void(s.entry.paused=i);this.unscheduleUpdate(e)}const o=Vw.get(e,t,i,!1);let r;0===t?(r=this._updates0List,this._appendIn(r,o)):(r=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(r,o,t)),this._hashForUpdates[n]=jw.get(r,o,e,null)}unschedule(e,t){if(!t||!e)return;const i=t.uuid||t.id;if(!i)return void C(1510);const n=this._hashForTimers[i];if(n){const t=n.timers;for(let i=0,s=t.length;i<s;i++){const s=t[i];if(e===s._callback)return s!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),t.splice(i,1),qw.put(s),n.timerIndex>=i&&n.timerIndex--,void(0===t.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}}unscheduleUpdate(e){if(!e)return;const t=e.uuid||e.id;if(!t)return void C(1510);const i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}unscheduleAllForTarget(e){if(!e)return;const t=e.uuid||e.id;if(!t)return void C(1510);const i=this._hashForTimers[t];if(i){const e=i.timers;e.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(let t=0,i=e.length;t<i;t++)qw.put(e[t]);e.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}unscheduleAll(){this.unscheduleAllWithMinPriority(kw.Priority.SCHEDULER)}unscheduleAllWithMinPriority(e){let t,i;const n=this._arrayForTimers;for(t=n.length-1;t>=0;t--)i=n[t],this.unscheduleAllForTarget(i.target);let s,o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,s=this._updatesNegList[t],s&&s.priority>=e&&this.unscheduleUpdate(s.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,s=this._updates0List[t],s&&this.unscheduleUpdate(s.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,s=this._updatesPosList[t],s&&s.priority>=e&&this.unscheduleUpdate(s.target),o===this._updatesPosList.length&&t++}isScheduled(e,t){A(e,1508),A(t,1509);const i=t.uuid||t.id;if(!i)return C(1510),!1;const n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;{const t=n.timers;for(let i=0;i<t.length;++i)if(e===t[i]._callback)return!0;return!1}}pauseAllTargets(){return this.pauseAllTargetsWithMinPriority(kw.Priority.SCHEDULER)}pauseAllTargetsWithMinPriority(e){const t=[];let i;const n=this._arrayForTimers;let s,o,r;for(s=0,o=n.length;s<o;s++)i=n[s],i&&(i.paused=!0,t.push(i.target));if(e<0)for(s=0;s<this._updatesNegList.length;s++)r=this._updatesNegList[s],r&&r.priority>=e&&(r.paused=!0,t.push(r.target));if(e<=0)for(s=0;s<this._updates0List.length;s++)r=this._updates0List[s],r&&(r.paused=!0,t.push(r.target));for(s=0;s<this._updatesPosList.length;s++)r=this._updatesPosList[s],r&&r.priority>=e&&(r.paused=!0,t.push(r.target));return t}resumeTargets(e){if(e)for(let t=0;t<e.length;t++)this.resumeTarget(e[t])}pauseTarget(e){A(e,1503);const t=e.uuid||e.id;if(!t)return void C(1510);const i=this._hashForTimers[t];i&&(i.paused=!0);const n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}resumeTarget(e){A(e,1504);const t=e.uuid||e.id;if(!t)return void C(1510);const i=this._hashForTimers[t];i&&(i.paused=!1);const n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}isTargetPaused(e){A(e,1505);const t=e.uuid||e.id;if(!t)return C(1510),!1;const i=this._hashForTimers[t];if(i)return i.paused;const n=this._hashForUpdates[t];return!!n&&n.entry.paused}_removeHashElement(e){const t=e.target.uuid||e.target.id;delete this._hashForTimers[t];const i=this._arrayForTimers;for(let t=0,n=i.length;t<n;t++)if(i[t]===e){i.splice(t,1);break}Ww.put(e)}_removeUpdateFromHash(e){const t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){const e=i.list,n=i.entry;for(let t=0,i=e.length;t<i;t++)if(e[t]===n){e.splice(t,1);break}delete this._hashForUpdates[t],Vw.put(n),jw.put(i)}}_priorityIn(e,t,i){for(let n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}_appendIn(e,t){e.push(t)}}e("Scheduler",Xw),Xw.ID="scheduler",n.Scheduler=Xw;class Yw{get width(){return this._width}get height(){return this._height}get framebuffer(){return this._framebuffer}get shouldSyncSizeWithSwapchain(){return this._shouldSyncSizeWithSwapchain}get hasOnScreenAttachments(){return this._hasOnScreenAttachments}get hasOffScreenAttachments(){return this._hasOffScreenAttachments}get cameras(){return this._cameras}static registerCreateFunc(e){e._createWindowFun=e=>new Yw(e)}get native(){return this._nativeObj}constructor(e){this._title="",this._width=1,this._height=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}_setHasOffScreenAttachments(e){this._hasOffScreenAttachments=e,this._nativeObj.hasOffScreenAttachments=e}_setHasOnScreenAttachments(e){this._hasOnScreenAttachments=e,this._nativeObj.hasOnScreenAttachments=e}_createFrameBuffer(e,t){this._framebuffer=e.createFramebuffer(new sr(t,this._colorTextures,this._depthStencilTexture)),this._nativeObj.frameBuffer=this._framebuffer}_init(){this._nativeObj=new Qn}initialize(e,t){this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchainBufferIndices&&(this._swapchainBufferIndices=t.swapchainBufferIndices),void 0!==t.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=t.shouldSyncSizeWithSwapchain),this._width=t.width,this._height=t.height;const{colorAttachments:i,depthStencilAttachment:n}=t.renderPassInfo;for(let t=0;t<i.length;t++)i[t].format===Ls.UNKNOWN&&(i[t].format=e.colorFormat);n&&n.format===Ls.UNKNOWN&&(n.format=e.depthStencilFormat),this._renderPass=e.createRenderPass(t.renderPassInfo);for(let t=0;t<i.length;t++){let n=null;this._swapchainBufferIndices&1<<t?this._setHasOnScreenAttachments(!0):(n=e.createTexture(new Lo(Hs.TEX2D,Vs.COLOR_ATTACHMENT|Vs.SAMPLED,i[t].format,this._width,this._height)),this._setHasOffScreenAttachments(!0)),this._colorTextures.push(n)}return n?this._swapchainBufferIndices>=0&&(this._depthStencilTexture=e.createTexture(new Lo(Hs.TEX2D,Vs.DEPTH_STENCIL_ATTACHMENT|Vs.SAMPLED,n.format,this._width,this._height)),this._setHasOffScreenAttachments(!0)):this._setHasOnScreenAttachments(!0),this._createFrameBuffer(e,this._renderPass),!0}_destroy(){this.framebuffer.destroy(),this._nativeObj=null}destroy(){this.clearCameras(),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(let e=0;e<this._colorTextures.length;e++){const t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()}resize(e,t){this._width=e,this._height=t;let i=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(e,t),i=!0);for(let n=0;n<this._colorTextures.length;n++){const s=this._colorTextures[n];s&&(s.resize(e,t),i=!0)}const n=this.framebuffer;i&&n&&(n.destroy(),n.initialize(new sr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(const i of this._cameras)i.isWindowSize&&i.resize(e,t)}extractRenderCameras(e){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];i.enabled&&(i.update(),e.push(i))}}attachCamera(e){for(let t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()}detachCamera(e){for(let t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)}clearCameras(){this._cameras.length=0}sortCameras(){this._cameras.sort(((e,t)=>e.priority-t.priority))}}class Kw{_init(){this._naitveObj=new is}_destroy(){this._naitveObj=null}_setCumulativeTime(e){this._cumulativeTime+=e,this._naitveObj.cumulativeTime=this._cumulativeTime}_setFrameTime(e){this._frameTime=e,this._naitveObj.frameTime=e}get device(){return this._device}get mainWindow(){return this._mainWindow}set curWindow(e){this._curWindow=e}get curWindow(){return this._curWindow}set tempWindow(e){this._tempWindow=e}get tempWindow(){return this._tempWindow}get windows(){return this._windows}get pipeline(){return this._pipeline}get batcher2D(){return this._batcher}get scenes(){return this._scenes}get cumulativeTime(){return this._cumulativeTime}get frameTime(){return this._frameTime}get frameCount(){return this._frameCount}get fps(){return this._fps}set fixedFPS(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}get fixedFPS(){return this._fixedFPS}get dataPoolManager(){return this._dataPoolMgr}get useDeferredPipeline(){return this._useDeferredPipeline}constructor(e){this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=n.internal.DataPoolManager&&new n.internal.DataPoolManager(e),wg.registerCreateFunc(this),Yw.registerCreateFunc(this),this._cameraPool=new F((()=>new Nf(this._device)),4)}initialize(e){this._init();const t=new $o,i=new Qo;i.depthStoreOp=to.DISCARD,i.stencilStoreOp=to.DISCARD;const s=new er([t],i);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:s,swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,Promise.resolve(cg.initBuiltinRes(this._device)).then((()=>{n.view.on("design-resolution-changed",(()=>{const e=n.game.canvas.width,t=n.game.canvas.height;this.resize(e,t)}),this)}))}destroy(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()}resize(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);for(const i of this._windows)i.shouldSyncSizeWithSwapchain&&i.resize(e,t);this._pipeline&&this._pipeline.resize(e,t)}setRenderPipeline(e){if(e instanceof KC&&(this._useDeferredPipeline=!0),e||(e=kC()),this._pipeline=e,!this._pipeline.activate())return!1;const t=n.director.getScene();return t&&t.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&n.internal.Batcher2D&&(this._batcher=new n.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}onGlobalPipelineStateChanged(){for(let e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()}activeWindow(e){this._curWindow=e}resetCumulativeTime(){this._setCumulativeTime(0)}frameMove(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(let e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();this._batcher&&this._batcher.update();const t=this._windows,i=[];for(let e=0;e<t.length;e++)t[e].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire();const e=this._scenes,t=n.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(let i=0;i<e.length;i++)e[i].update(t);n.director.emit(n.Director.EVENT_BEFORE_COMMIT),i.sort(((e,t)=>e.priority-t.priority)),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()}createWindow(e){const t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t}destroyWindow(e){for(let t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}destroyWindows(){for(const e of this._windows)e.destroy();this._windows=[]}createScene(e){const t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}destroyScene(e){for(let t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}destroyScenes(){for(const e of this._scenes)e.destroy();this._scenes=[]}createModel(e){let t=this._modelPools.get(e);t||(this._modelPools.set(e,new F((()=>new e),10)),t=this._modelPools.get(e));const i=t.alloc();return i.initialize(),i}destroyModel(e){const t=this._modelPools.get(e.constructor);t?(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e)):T(1300,e.constructor.name)}createCamera(){return this._cameraPool.alloc()}createLight(e){let t=this._lightPools.get(e);t||(this._lightPools.set(e,new F((()=>new e),4)),t=this._lightPools.get(e));const i=t.alloc();return i.initialize(),i}destroyLight(e){const t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case ev.SPHERE:e.scene.removeSphereLight(e);break;case ev.SPOT:e.scene.removeSpotLight(e)}}}n.Root=Kw;class $w extends Vt{constructor(){super(),this._compScheduler=void 0,this._nodeActivator=void 0,this._invalid=void 0,this._paused=void 0,this._root=void 0,this._loadingScene=void 0,this._scene=void 0,this._totalFrames=void 0,this._scheduler=void 0,this._systems=void 0,this._invalid=!1,this._paused=!1,this._root=null,this._loadingScene="",this._scene=null,this._totalFrames=0,this._scheduler=new Xw,this._compScheduler=new dC,this._nodeActivator=new EC,this._systems=[],Iw.once(Rw.EVENT_RENDERER_INITED,this._initOnRendererInitialized,this)}calculateDeltaTime(e){}convertToGL(e){const t=Iw.container,i=n.view,s=t.getBoundingClientRect(),o=s.left+window.pageXOffset-t.clientLeft,r=s.top+window.pageYOffset-t.clientTop,a=i._devicePixelRatio*(e.x-o),c=i._devicePixelRatio*(r+s.height-e.y);return i._isRotated?rn(i._viewportRect.width-c,a):rn(a,c)}convertToUI(e){const t=Iw.container,i=n.view,s=t.getBoundingClientRect(),o=s.left+window.pageXOffset-t.clientLeft,r=s.top+window.pageYOffset-t.clientTop,a=rn(0,0);return i._isRotated?(a.x=o+e.y/i._devicePixelRatio,a.y=r+s.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(a.x=o+e.x*i._devicePixelRatio,a.y=r+s.height-e.y*i._devicePixelRatio),a}end(){this.once($w.EVENT_END_FRAME,(()=>{this.purgeDirector()}))}pause(){this._paused||(this._paused=!0)}purgeDirector(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),ay&&ay.setEnabled(!1),n.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),n.assetManager.releaseAll()}reset(){this.purgeDirector(),this.emit($w.EVENT_RESET),ay&&ay.setEnabled(!0),this.startAnimation()}runSceneImmediate(e,t,i){e instanceof PC&&(e=e.scene),A(e instanceof ZE,1216),e._load();const s=Object.keys(Iw._persistRootNodes).map((e=>Iw._persistRootNodes[e]));for(let t=0;t<s.length;t++){const i=s[t];i.emit(n.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);const o=e.uuid===i._originalSceneId&&e.getChildByUuid(i.uuid);if(o){const t=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(i,t)}else i.parent=e}const o=this._scene;n.isValid(o)&&o.destroy(),n.assetManager._releaseManager._autoRelease(o,e,Iw._persistRootNodes),this._scene=null,Ot._deferredDestroy(),t&&t(),this.emit(n.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(n.Director.EVENT_AFTER_SCENE_LAUNCH,e)}runScene(e,t,i){e instanceof PC&&(e=e.scene),A(e,1205),A(e instanceof ZE,1216),e._load(),this.once(n.Director.EVENT_END_FRAME,(()=>{this.runSceneImmediate(e,t,i)}))}loadScene(e,t,i){if(this._loadingScene)return T(1208,e,this._loadingScene),!1;const s=n.assetManager.bundles.find((t=>!!t.getSceneInfo(e)));return s?(this.emit(n.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time(`LoadScene ${e}`),s.loadScene(e,((n,s)=>{console.timeEnd(`LoadScene ${e}`),this._loadingScene="",n?(d(n),t&&t(n)):this.runSceneImmediate(s,i,t)})),!0):(C(1209,e),!1)}preloadScene(e,t,i){const s=n.assetManager.bundles.find((t=>!!t.getSceneInfo(e)));if(s)s.preloadScene(e,null,t,i);else{const t=`Can not preload the scene "${e}" because it is not in the build settings.`;i&&i(new Error(t)),d(`preloadScene: ${t}`)}}resume(){this._paused&&(this._paused=!1)}get root(){return this._root}getScene(){return this._scene}getDeltaTime(){return Iw.deltaTime}getTotalTime(){return Iw.totalTime}getCurrentTime(){return Iw.frameStartTime}getTotalFrames(){return this._totalFrames}isPaused(){return this._paused}getScheduler(){return this._scheduler}setScheduler(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(Xw.ID,e,200))}registerSystem(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(kw.sortByPriority)}unregisterSystem(e){Oe.fastRemove(this._systems,e),this._systems.sort(kw.sortByPriority)}getSystem(e){return this._systems.find((t=>t.id===e))}getAnimationManager(){return this.getSystem(n.AnimationManager.ID)}startAnimation(){this._invalid=!1}stopAnimation(){this._invalid=!0}mainLoop(e){let t;t=Iw._calculateDT(e),this.tick(t)}tick(e){if(!this._invalid){if(this.emit($w.EVENT_BEGIN_FRAME),bw.frameDispatchEvents(),!this._paused){this.emit($w.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(let t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit($w.EVENT_AFTER_UPDATE),Ot._deferredDestroy();for(let t=0;t<this._systems.length;++t)this._systems[t].postUpdate(e)}this.emit($w.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit($w.EVENT_AFTER_DRAW),ay.frameUpdateListeners(),ix.resetHasChangedFlags(),ix.clearNodeArray(),this.emit($w.EVENT_END_FRAME),this._totalFrames++}}_initOnRendererInitialized(){this._totalFrames=0,this._paused=!1,ay&&ay.setEnabled(!0),this.registerSystem(Xw.ID,this._scheduler,200),this.emit($w.EVENT_INIT)}_init(){return this._root=new Kw(Iw._gfxDevice),this._root.initialize({}).catch((e=>(C(1217),Promise.reject(e))))}}e("Director",$w),$w.EVENT_INIT="director_init",$w.EVENT_RESET="director_reset",$w.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",$w.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",$w.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",$w.EVENT_BEFORE_UPDATE="director_before_update",$w.EVENT_AFTER_UPDATE="director_after_update",$w.EVENT_BEFORE_DRAW="director_before_draw",$w.EVENT_AFTER_DRAW="director_after_draw",$w.EVENT_BEFORE_COMMIT="director_before_commit",$w.EVENT_BEFORE_PHYSICS="director_before_physics",$w.EVENT_AFTER_PHYSICS="director_after_physics",$w.EVENT_BEGIN_FRAME="director_begin_frame",$w.EVENT_END_FRAME="director_end_frame",$w.instance=void 0,n.Director=$w;const Qw=e("director",$w.instance=n.director=new $w),Zw={};ei(Zw,"vmath",[{name:"vec2",newName:"Vec2",target:dn,targetName:"math"},{name:"vec3",newName:"Vec3",target:dn,targetName:"math"},{name:"vec4",newName:"Vec4",target:dn,targetName:"math"},{name:"quat",newName:"Quat",target:dn,targetName:"math"},{name:"mat3",newName:"Mat3",target:dn,targetName:"math"},{name:"mat4",newName:"Mat4",target:dn,targetName:"math"},{name:"color4",newName:"Color",target:dn,targetName:"math"},{name:"rect",newName:"Rect",target:dn,targetName:"math"},{name:"approx",newName:"approx",target:dn,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:dn,targetName:"math"},{name:"equals",newName:"equals",target:dn,targetName:"math"},{name:"clamp",newName:"clamp",target:dn,targetName:"math"},{name:"clamp01",newName:"clamp01",target:dn,targetName:"math"},{name:"lerp",newName:"lerp",target:dn,targetName:"math"},{name:"toRadian",newName:"toRadian",target:dn,targetName:"math"},{name:"toDegree",newName:"toDegree",target:dn,targetName:"math"},{name:"random",newName:"random",target:dn,targetName:"math"},{name:"randomRange",newName:"randomRange",target:dn,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:dn,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:dn,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:dn,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:dn,targetName:"math"},{name:"repeat",newName:"repeat",target:dn,targetName:"math"},{name:"pingPong",newName:"pingPong",target:dn,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:dn,targetName:"math"}]),n.vmath=Zw,ei(Xw.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:Xw,targetName:"Scheduler"}]),ei(Xw,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:()=>kw.Priority.SCHEDULER}]),ti(Xw,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),ei(pw.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:pw,targetName:"EventTouch"}]),ei(mg.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),ti(mg.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),ei(Kw.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),ii(Iw,"game",[{name:"collisionMatrix"},{name:"groupList"}]),ii($w.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),ti($w.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"}]);class Jw{constructor(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new kl,this.scenes=new kl,this.paths=new kl}init(e){(e=>{let t=e.uuids;const i=e.paths,n=e.types,s=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(let e=0,i=t.length;e<i;e++)t[e]=sh(t[e]);for(const e in i){const t=i[e],s=t[1];t[1]=n[s]}}else{const e=Object.create(null);for(let i=0,n=t.length;i<n;i++){const n=t[i];t[i]=e[n]=sh(n)}t=e}for(const e in i){const n=i[e];o[t[e]]=n}const r=e.scenes;for(const e in r){const i=r[e];r[e]=t[i]}const a=e.packs;for(const e in a){const i=a[e];for(let e=0;e<i.length;++e)i[e]=t[i[e]]}const c=e.versions;if(c)for(const e in c){const i=c[e];for(let e=0;e<i.length;e+=2){const n=i[e];i[e]=t[n]||n}}const l=e.redirect;if(l)for(let e=0;e<l.length;e+=2)l[e]=t[l[e]],l[e+1]=s[l[e+1]];if(e.extensionMap)for(const i in e.extensionMap)Object.prototype.hasOwnProperty.call(e.extensionMap,i)&&e.extensionMap[i].forEach(((n,s)=>{e.extensionMap[i][s]=t[n]||n}))})(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);for(const t in e.extensionMap)Object.prototype.hasOwnProperty.call(e.extensionMap,t)&&e.extensionMap[t].forEach((e=>{const i=this.assetInfos.get(e);i&&(i.extension=t)}))}getInfoWithPath(e,t){if(!e)return null;e=lh(e);const i=this.paths.get(e);if(i){if(!t)return i[0];for(let e=0,n=i.length;e<n;e++){const n=i[e];if(De.isChildClassOf(n.ctor,t))return n}}return null}getDirWithPath(e,t,i){"/"===(e=lh(e))[e.length-1]&&(e=e.slice(0,-1));const n=i||[];return this.paths.forEach(((i,s)=>{if(s.startsWith(e)&&((e,t)=>!(e.length>t.length)||47===e.charCodeAt(t.length))(s,e)||!e)for(let e=0,s=i.length;e<s;e++){const s=i[e];t&&!De.isChildClassOf(s.ctor,t)||n.push(s)}})),n}getAssetInfo(e){return this.assetInfos.get(e)||null}getSceneInfo(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e=`/${e}`),this.scenes.find(((t,i)=>i.endsWith(e)))}destroy(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}_initUuid(e){if(e){this.assetInfos.clear();for(let t=0,i=e.length;t<i;t++){const i=e[t];this.assetInfos.add(i,{uuid:i})}}}_initPath(e){if(!e)return;const t=this.paths;t.clear();for(const i in e){const n=e[i],s=n[0],o=n[1],r=3===n.length,a=this.assetInfos.get(i);a.path=s,a.ctor=De._getClassById(o),t.has(s)?r?t.get(s).push(a):t.get(s).unshift(a):t.add(s,[a])}}_initScene(e){if(!e)return;const t=this.scenes;t.clear();const i=this.assetInfos;for(const n in e){const s=e[n],o=i.get(s);o.url=n,t.add(n,o)}}_initPackage(e){if(!e)return;const t=this.assetInfos;for(const i in e){const n=e[i],s={uuid:i,packedUuids:n,ext:".json"};t.add(i,s);for(let e=0,i=n.length;e<i;e++){const o=n[e],r=t.get(o),a=r.packs;a?1===i?a.unshift(s):a.push(s):r.packs=[s]}}}_initVersion(e){if(!e)return;const t=this.assetInfos;let i=e.import;if(i)for(let e=0,n=i.length;e<n;e+=2){const n=i[e];t.get(n).ver=i[e+1]}if(i=e.native,i)for(let e=0,n=i.length;e<n;e+=2){const n=i[e];t.get(n).nativeVer=i[e+1]}}_initRedirect(e){if(!e)return;const t=this.assetInfos;for(let i=0,n=e.length;i<n;i+=2){const n=e[i];t.get(n).redirect=e[i+1]}}}function eA(e,t){e._uuid&&t.push(e._uuid)}function tA(e,t){const i=Object.getOwnPropertyNames(e);for(let n=0;n<i.length;n++){const s=i[n];if("node"===s||"__eventTargets"===s)continue;const o=e[s];if("object"==typeof o&&o)if(Array.isArray(o))for(let e=0;e<o.length;e++){const i=o[e];i instanceof xh&&eA(i,t)}else if(o.constructor&&o.constructor!==Object)o instanceof xh&&eA(o,t);else{const e=Object.getOwnPropertyNames(o);for(let i=0;i<e.length;i++){const n=o[e[i]];n instanceof xh&&eA(n,t)}}}}function iA(e,t){for(let i=0;i<e._components.length;i++)tA(e._components[i],t);for(let i=0;i<e._children.length;i++)iA(e._children[i],t)}function nA(e,t,i,n){i.push(e._uuid);const s=gm.getDeps(e._uuid);for(let e=0,o=s.length;e<o;e++){const o=Vl.get(s[e]);if(!o)continue;const r=o._uuid;r in t?t[r]+=n:t[r]=o.refCount+n,i.includes(r)||nA(o,t,i,n)}}const sA=[];var oA=new class{constructor(){this._persistNodeDeps=new kl,this._toDelete=new kl,this._eventListener=!1}init(){this._persistNodeDeps.clear(),this._toDelete.clear()}_addPersistNodeRef(e){const t=[];iA(e,t);for(let e=0,i=t.length;e<i;e++){const i=Vl.get(t[e]);i&&i.addRef()}this._persistNodeDeps.add(e.uuid,t)}_removePersistNodeRef(e){if(!this._persistNodeDeps.has(e.uuid))return;const t=this._persistNodeDeps.get(e.uuid);for(let e=0,i=t.length;e<i;e++){const i=Vl.get(t[e]);i&&i.decRef()}this._persistNodeDeps.remove(e.uuid)}_autoRelease(e,t,i){if(e){const i=gm.getDeps(e.uuid);for(let t=0,n=i.length;t<n;t++){const n=Vl.get(i[t]);n&&n.decRef(e.autoReleaseAssets)}const n=gm._depends.get(e.uuid);if(n&&n.persistDeps){const t=n.persistDeps;for(let i=0,n=t.length;i<n;i++){const n=Vl.get(t[i]);n&&n.decRef(e.autoReleaseAssets)}}e.uuid!==t.uuid&&gm.remove(e.uuid)}const n=gm._depends.get(t.uuid);n&&(n.persistDeps=[]);for(const e in i){const t=i[e],s=this._persistNodeDeps.get(t.uuid);for(const e of s){const t=Vl.get(e);t&&t.addRef()}n&&n.persistDeps.push(...s)}}tryRelease(e,t=!1){e instanceof xh&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,Ye(this._freeAssets.bind(this)))))}_freeAssets(){this._eventListener=!1,this._toDelete.forEach((e=>{this._free(e)})),this._toDelete.clear()}_free(e,t=!1){const i=e._uuid;if(this._toDelete.remove(i),!Nt(e,!0))return;if(!t&&e.refCount>0&&function(e){const t=Object.create(null);if(t[e._uuid]=e.refCount,nA(e,t,sA,-1),sA.length=0,0!==t[e._uuid])return t[e._uuid];for(const e in t)0!==t[e]&&nA(Vl.get(e),t,sA,1);return sA.length=0,t[e._uuid]}(e)>0)return;Vl.remove(i);const n=gm.getDeps(i);for(let e=0,t=n.length;e<t;e++){const t=Vl.get(n[e]);t&&(t.decRef(!1),this._free(t,!1))}e.destroy(),gm.remove(i)}};let rA=null;function aA(e,t){for(let i=0,n=e.input.length;i<n;i++){const n=e.input[i];t&&!n.isNative&&n.content instanceof xh&&n.content.decRef(!1),n.recycle()}e.input=null}function cA(e,t){return t?/\?/.test(e)?`${e}&_t=${Date.now()}`:`${e}?_t=${Date.now()}`:e}function lA(e,t,i,n,s=0){e(s,((o,r)=>{s++,!o||s>t?n&&n(o,r):setTimeout((()=>{lA(e,t,i,n,s)}),i)}))}function hA(e,t,i,n,s){try{const o=gm.parse(e,t);for(let e=0,t=o.deps.length;e<t;e++){const t=o.deps[e];t in i||(i[t]=!0,n.push({uuid:t,bundle:s&&s.name}))}o.nativeDep&&(s&&(o.nativeDep.bundle=s.name),n.push({...o.nativeDep}))}catch(e){d(e.message,e.stack)}}function uA(e,t,i){t&&(i=void 0!==i?i:n.assetManager.cacheAsset,ch(t)||!i||t.isDefault||Vl.add(e,t))}function _A(e,t,i){let n=0;const s=[],o=e.length;0===o&&i&&i(s);const r=e=>{e&&s.push(e),n++,n===o&&i&&i(s)};for(let i=0;i<o;i++)t(e[i],r)}function pA(e,t,i){let n=e,s=t,o=i;if(void 0===i){const i="function"==typeof e;t?(o=t,i||(s=null)):void 0===t&&i&&(o=e,n=null,s=null),void 0!==t&&i&&(s=e,n=null)}return{options:n||Object.create(null),onProgress:s,onComplete:o}}function dA(e,t,i){let n=e,s=t,o=i;if(void 0===i){const i=De.isChildClassOf(e,xh);t?(o=t,i&&(s=null)):void 0!==t||i||(o=e,s=null,n=null),void 0===t||i||(s=e,n=null)}return{type:n,onProgress:s||rA,onComplete:o}}function fA(e,t,i,n={}){if(!i[t]||n[t])return!1;n[t]=!0;let s=!1;const o=gm.getDeps(t);if(o)for(let t=0,r=o.length;t<r;t++){const r=o[t];if(r===e||fA(e,r,i,n)){s=!0;break}}return s}function mA(e){return(t,i)=>{if(!e)return;const n=[];Array.isArray(i)?i.forEach((e=>e instanceof xh&&n.push(e.addRef()))):i instanceof xh&&n.push(i.addRef()),Ye((()=>{n.forEach((e=>e.decRef(!1))),e(t,i)}))}}class gA{constructor(){this._config=new Jw}get config(){return this._config}get name(){return this._config.name}get deps(){return this._config.deps}get base(){return this._config.base}getInfoWithPath(e,t){return this._config.getInfoWithPath(e,t)}getDirWithPath(e,t,i){return this._config.getDirWithPath(e,t,i)}getAssetInfo(e){return this._config.getAssetInfo(e)}getSceneInfo(e){return this._config.getSceneInfo(e)}init(e){this._config.init(e),ql.add(e.name,this)}load(e,t,i,s){const{type:o,onProgress:r,onComplete:a}=dA(t,i,s),c={__requestType__:$l.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(e)};n.assetManager.loadAny(e,c,r,a)}preload(e,t,i,s){const{type:o,onProgress:r,onComplete:a}=dA(t,i,s);n.assetManager.preloadAny(e,{__requestType__:$l.PATH,type:o,bundle:this.name},r,a)}loadDir(e,t,i,s){const{type:o,onProgress:r,onComplete:a}=dA(t,i,s);n.assetManager.loadAny(e,{__requestType__:$l.DIR,type:o,bundle:this.name,__outputAsArray__:!0},r,a)}preloadDir(e,t,i,s){const{type:o,onProgress:r,onComplete:a}=dA(t,i,s);n.assetManager.preloadAny(e,{__requestType__:$l.DIR,type:o,bundle:this.name},r,a)}loadScene(e,t,i,s){const{options:o,onProgress:r,onComplete:a}=pA(t,i,s);o.preset=o.preset||"scene",o.bundle=this.name,n.assetManager.loadAny({scene:e},o,r,((e,t)=>{if(e)d(e.message,e.stack);else if(t instanceof PC&&t.scene){const e=t.scene;e._id=t._uuid,e.name=t.name}else e=new Error(`The asset ${t._uuid} is not a scene`);a&&a(e,t)}))}preloadScene(e,t,i,s){const{options:o,onProgress:r,onComplete:a}=pA(t,i,s);o.bundle=this.name,n.assetManager.preloadAny({scene:e},o,r,(t=>{t&&C(1210,e,t.message),a&&a(t)}))}get(e,t){const i=this.getInfoWithPath(e,t);return i&&Vl.get(i.uuid)||null}release(e,t){const i=this.get(e,t);i&&oA.tryRelease(i,!0)}releaseUnusedAssets(){Vl.forEach((e=>{const t=this.getAssetInfo(e._uuid);t&&!t.redirect&&oA.tryRelease(e)}))}releaseAll(){Vl.forEach((e=>{const t=this.getAssetInfo(e._uuid);t&&!t.redirect&&oA.tryRelease(e,!0)}))}_destroy(){this._config.destroy()}}const vA=e("resources",new gA);function yA(e,t,i){const n=new Image;function s(){n.removeEventListener("load",s),n.removeEventListener("error",o),i&&i(null,n)}function o(){n.removeEventListener("load",s),n.removeEventListener("error",o),i&&i(new Error(R(4930,e)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.addEventListener("load",s),n.addEventListener("error",o),n.src=e,n}function xA(e,t,i,n){const s=new XMLHttpRequest,o=`download failed: ${e}, status: `;if(s.open("GET",e,!0),void 0!==t.xhrResponseType&&(s.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(s.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&s.overrideMimeType&&s.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(s.timeout=t.xhrTimeout),t.xhrHeader)for(const e in t.xhrHeader)s.setRequestHeader(e,t.xhrHeader[e]);return s.onload=()=>{200===s.status||0===s.status?n&&n(null,s.response):n&&n(new Error(`${o}${s.status}(no response)`))},i&&(s.onprogress=e=>{e.lengthComputable&&i(e.loaded,e.total)}),s.onerror=()=>{n&&n(new Error(`${o}${s.status}(error)`))},s.ontimeout=()=>{n&&n(new Error(`${o}${s.status}(time out)`))},s.onabort=()=>{n&&n(new Error(`${o}${s.status}(abort)`))},s.send(null),s}n.resources=vA;const SA={};function bA(e,t,i){if(SA[e])return i&&i(null),null;const n=document.createElement("script");function s(){n.parentNode.removeChild(n),n.removeEventListener("load",s,!1),n.removeEventListener("error",o,!1),SA[e]=!0,i&&i(null)}function o(){n.parentNode.removeChild(n),n.removeEventListener("load",s,!1),n.removeEventListener("error",o,!1),i&&i(new Error(R(4928,e)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.async=t.scriptAsyncLoading||!1,n.src=e,n.addEventListener("load",s,!1),n.addEventListener("error",o,!1),document.body.appendChild(n),n}const TA=/^(?:\w+:\/\/|\.+\/).+/,EA=(e,t,i)=>{(xn.capabilities.imageBitmap&&n.assetManager.allowImageBitmap?CA:yA)(e,t,i)},CA=(e,t,i)=>{t.xhrResponseType="blob",xA(e,t,t.onFileProgress,i)},wA=(e,t,i)=>{t.xhrResponseType="json",xA(e,t,t.onFileProgress,i)},AA=(e,t,i)=>{t.xhrResponseType="arraybuffer",xA(e,t,t.onFileProgress,i)},PA=(e,t,i)=>{wA(e,t,((t,n)=>{if(t)return void i(t);const s=Kh(n);Promise.all(s.chunks.map((i=>new Promise(((n,s)=>{AA(`${wn(e)}${i}`,{},((e,i)=>{t?s(t):n(new Uint8Array(i))}))}))))).then((e=>{const t=new Yh(s.document,e);i(null,t)})).catch((e=>{i(e)}))}))},RA=(e,t,i)=>{AA(e,t,((e,t)=>{if(e)i(e);else try{const e=$h(new Uint8Array(t));i(null,e)}catch(e){i(e)}}))},IA=(e,t,i)=>{t.xhrResponseType="text",xA(e,t,t.onFileProgress,i)},MA=(e,t,i)=>{const n=An(e);let s=e;TA.test(s)||(s=-1!==OA.remoteBundles.indexOf(n)?`${OA.remoteServerAddress}remote/${n}`:`assets/${n}`);const o=t.version||OA.bundleVers[n];let r=0,a=null,c=null;wA(`${s}/config.${o?`${o}.`:""}json`,t,((e,t)=>{c=e,a=t,a&&(a.base=`${s}/`),2==++r&&i(c,a)})),bA(`${s}/index.${o?`${o}.`:""}js`,t,(e=>{c=e,2==++r&&i(e,a)}))},OA=new class{constructor(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=yA,this.downloadDomAudio=null,this.downloadFile=xA,this.downloadScript=bA,this._downloaders={".png":EA,".jpg":EA,".bmp":EA,".jpeg":EA,".gif":EA,".ico":EA,".tiff":EA,".webp":EA,".image":EA,".pvr":AA,".pkm":AA,".astc":AA,".txt":IA,".xml":IA,".vsh":IA,".fsh":IA,".atlas":IA,".tmx":IA,".tsx":IA,".json":wA,".ExportJson":wA,".plist":IA,".ccon":PA,".cconb":RA,".fnt":IA,".binary":AA,".bin":AA,".dbbin":AA,".skel":AA,".js":bA,bundle:MA,default:IA},this._downloading=new kl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}get remoteServerAddress(){return this._remoteServerAddress}init(e="",t={},i=[]){this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=i}register(e,t){"object"==typeof e?fe(this._downloaders,e):this._downloaders[e]=t}download(e,t,i,n,s){const o=jl.get(e);if(o)return void s(null,o);const r=this._downloading.get(e);if(r){r.push(s);const t=this._queue.find((t=>t.id===e));if(!t)return;const i=n.priority||0;return void(t.priority<i&&(t.priority=i,this._queueDirty=!0))}const a=void 0!==n.maxRetryCount?n.maxRetryCount:this.maxRetryCount,c=void 0!==n.maxConcurrency?n.maxConcurrency:this.maxConcurrency,l=void 0!==n.maxRequestsPerFrame?n.maxRequestsPerFrame:this.maxRequestsPerFrame,h=this._downloaders[i]||this._downloaders.default;lA(((i,o)=>{if(0===i&&this._downloading.add(e,[s]),!this.limited)return void h(cA(t,this.appendTimeStamp),n,o);this._updateTime();const r=(e,t)=>{this._totalNum--,this._handleQueueInNextFrame(c,l),o(e,t)};this._totalNum<c&&this._totalNumThisPeriod<l?(h(cA(t,this.appendTimeStamp),n,r),this._totalNum++,this._totalNumThisPeriod++):(this._queue.push({id:e,priority:n.priority||0,url:t,options:n,done:r,handler:h}),this._queueDirty=!0,this._totalNum<c&&this._handleQueueInNextFrame(c,l))}),a,this.retryInterval,((t,i)=>{t||jl.add(e,i);const n=this._downloading.remove(e);for(let e=0,s=n.length;e<s;e++)n[e](t,i)}))}loadSubpackage(e,t){n.assetManager.loadBundle(e,null,t)}_updateTime(){const e=performance.now(),t=n.game.deltaTime,i=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=e)}_handleQueue(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort(((e,t)=>e.priority-t.priority)),this._queueDirty=!1);const e=this._queue.pop();if(!e)break;this._totalNum++,this._totalNumThisPeriod++,e.handler(cA(e.url,this.appendTimeStamp),e.options,e.done)}this._handleQueueInNextFrame(e,t)}_handleQueueInNextFrame(e,t){!this._checkNextPeriod&&this._queue.length>0&&(Ye(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)}};function DA(e,t,i,n){let s=null,o=null;try{s=new Wf,s._nativeUrl=e,s._nativeAsset=t}catch(e){o=e}n(o,s)}function NA(e,t,i,n){const s=new BC;s.json=t,n(null,s)}function LA(e,t,i,n){const s=new OC;s.text=t,n(null,s)}function BA(e,t,i,n){const s=new ib;s._nativeUrl=e,s._nativeAsset=t,n(null,s)}function zA(e,t,i,n){const s=new xh;s._nativeUrl=e,s._nativeAsset=t,n(null,s)}function FA(e,i,n,s){let o=ql.get(i.name);o||(o=i.name===Zl.RESOURCES?vA:new gA,i.base=i.base||`${e}/`,o.init(i)),t.import(`virtual:///prerequisite-imports/${o.name}`).then((()=>{s(null,o)})).catch(s)}var UA=new class{constructor(){this._creating=new kl,this._producers={".png":DA,".jpg":DA,".bmp":DA,".jpeg":DA,".gif":DA,".ico":DA,".tiff":DA,".webp":DA,".image":DA,".pvr":DA,".pkm":DA,".txt":LA,".xml":LA,".vsh":LA,".fsh":LA,".atlas":LA,".tmx":LA,".tsx":LA,".fnt":LA,".json":NA,".ExportJson":NA,".binary":BA,".bin":BA,".dbbin":BA,".skel":BA,bundle:FA,default:zA}}register(e,t){"object"==typeof e?De.mixin(this._producers,e):this._producers[e]=t}create(e,t,i,n,s){const o=this._producers[i]||this._producers.default,r=Vl.get(e);if(!n.reloadAsset&&r)return void s(null,r);const a=this._creating.get(e);a?a.push(s):(this._creating.add(e,[s]),o(e,t,n,((t,i)=>{!t&&i instanceof xh&&(i._uuid=e,uA(e,i,n.cacheAsset));const s=this._creating.remove(e);for(let e=0,n=s.length;e<n;e++)s[e](t,i)})))}},GA=new class{constructor(){this._loading=new kl,this._unpackers={".json":this.unpackJson}}unpackJson(e,t,i,n){let s=De.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(R(5304,e[0]));mu(e,!0,void 0,vu.reportMissingClass),gu(e);const t=new yu(e[0]),i=e[1],n=e[2],s=e[3],o=e[4],r=e[5];for(let e=0;e<r.length;++e)r[e].unshift(t,i,n,s,o);return r}(t)).length!==e.length&&C(4915);for(let i=0;i<e.length;i++)s[`${e[i]}@import`]=t[i]}else{const i=De._getClassId(wm),n=De._getClassId(Wf);if(t.type===i&&t.data){const n=t.data;n.length!==e.length&&C(4915);for(let t=0;t<e.length;t++)s[`${e[t]}@import`]=xu(i,{base:n[t][0],mipmaps:n[t][1]})}else if(t.type===n&&t.data){const i=t.data;i.length!==e.length&&C(4915);for(let t=0;t<e.length;t++)s[`${e[t]}@import`]=i[t]}else o=new Error("unmatched type pack!"),s=null}n(o,s)}init(){this._loading.clear()}register(e,t){"object"==typeof e?De.mixin(this._unpackers,e):this._unpackers[e]=t}unpack(e,t,i,n,s){t?(0,this._unpackers[i])(e,t,n,s):s(new Error("package data is wrong!"))}load(e,t,i){if(e.isNative||!e.info||!e.info.packs)return void OA.download(e.id,e.url,e.ext,e.options,i);if(jl.has(e.id))return void i(null,jl.get(e.id));const n=e.info.packs;let s=n.find((e=>this._loading.has(e.uuid)));if(s)return void this._loading.get(s.uuid).push({onComplete:i,id:e.id});s=n[0],this._loading.add(s.uuid,[{onComplete:i,id:e.id}]);const o=hh(s.uuid,{ext:s.ext,bundle:e.config.name});OA.download(s.uuid,o,s.ext,e.options,((t,i)=>{jl.remove(s.uuid),t&&d(t.message,t.stack),this.unpack(s.packedUuids,i,s.ext,e.options,((e,i)=>{if(!e)for(const e in i)jl.add(e,i[e]);const n=this._loading.remove(s.uuid);for(let s=0,o=n.length;s<o;s++){const o=n[s];if(t||e){o.onComplete(t||e);continue}const r=i[o.id];r?o.onComplete(null,r):o.onComplete(new Error("can not retrieve data from package"))}}))}))}};function kA(e,t){let i=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},i=!0);const{options:s,progress:o}=e,r=[],a=o.total,c=s.__exclude__=s.__exclude__||Object.create(null);e.output=[],_A(e.input,((s,l)=>{if(!s.isNative&&Vl.has(s.uuid)){const t=Vl.get(s.uuid);return s.content=t.addRef(),e.output.push(s),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,s),void l()}GA.load(s,e.options,((h,u)=>{h?e.isFinish||(!n.assetManager.force||i?(d(h.message,h.stack),o.canInvoke=!1,t(h)):(e.output.push(s),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,s))):e.isFinish||(s.file=u,e.output.push(s),s.isNative||(c[s.uuid]=!0,hA(s.uuid,u,c,r,s.config),o.total=a+r.length),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,s)),l()}))}),(()=>{if(e.isFinish)return aA(e,!0),void e.dispatch("error");if(r.length>0){const n=Jl.create({input:r,progress:o,options:s,onProgress:e.onProgress,onError:Jl.prototype.recycle,onComplete:s=>{s||(e.output.push(...n.output),n.recycle()),i&&HA(e),t(s)}});Yl.async(n)}else i&&HA(e),t()}))}function HA(e){const t=e.output;for(let e=0,i=t.length;e<i;e++)t[e].content&&t[e].content.decRef(!1)}const VA=new class extends class{constructor(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}parse(e){return this._parseXML(e)}_parseXML(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}{parse(e){const t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return T(5100),{};let i=null;for(let e=0,n=t.childNodes.length;e<n&&(i=t.childNodes[e],1!==i.nodeType);e++);return this._parseNode(i)}_parseNode(e){let t=null;const i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(let i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}_parseArray(e){const t=[];for(let i=0,n=e.childNodes.length;i<n;i++){const n=e.childNodes[i];1===n.nodeType&&t.push(this._parseNode(n))}return t}_parseDict(e){const t={};let i="";for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:t[i]=this._parseNode(s))}return t}};function jA(e,t){return e[t]<<8|e[t+1]}var WA=new class{constructor(){this._parsing=new kl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}parseImage(e,t,i){e instanceof HTMLImageElement?i(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((e=>{i(null,e)}),(e=>{i(e,null)}))}parsePVRTex(e,t,i){let n=null,s=null;try{const t=e instanceof ArrayBuffer?e:e.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){const e=i[7],n=i[6],o=i[12]+52;s={_data:new Uint8Array(t,o),_compressed:!0,width:e,height:n,format:0}}else{if(559044176!==i[11])throw new Error("Invalid magic number in PVR header");{const e=i[0],n=i[1],o=i[2];s={_data:new Uint8Array(t,e),_compressed:!0,width:o,height:n,format:0}}}}catch(e){n=e}i(n,s)}parsePKMTex(e,t,i){let n=null,s=null;try{const t=e instanceof ArrayBuffer?e:e.buffer,i=new Uint8Array(t),n=jA(i,6);if(0!==n&&1!==n&&3!==n)throw new Error("Invalid magic number in ETC header");const o=jA(i,12),r=jA(i,14);jA(i,8),jA(i,10),s={_data:new Uint8Array(t,16),_compressed:!0,width:o,height:r,format:0}}catch(e){n=e}i(n,s)}parseASTCTex(e,t,i){let n=null,s=null;try{const t=e instanceof ArrayBuffer?e:e.buffer,i=new Uint8Array(t);if(1554098963!==i[0]+(i[1]<<8)+(i[2]<<16)+(i[3]<<24))throw new Error("Invalid magic number in ASTC header");const n=i[4],o=i[5],r=i[6];if((n<3||n>6||o<3||o>6||r<3||r>6)&&(n<4||7===n||9===n||11===n||n>12||o<4||7===o||9===o||11===o||o>12||1!==r))throw new Error("Invalid block number in ASTC header");const a=function(e,t){return 4===e?Lf.RGBA_ASTC_4x4:5===e?4===t?Lf.RGBA_ASTC_5x4:Lf.RGBA_ASTC_5x5:6===e?5===t?Lf.RGBA_ASTC_6x5:Lf.RGBA_ASTC_6x6:8===e?5===t?Lf.RGBA_ASTC_8x5:6===t?Lf.RGBA_ASTC_8x6:Lf.RGBA_ASTC_8x8:10===e?5===t?Lf.RGBA_ASTC_10x5:6===t?Lf.RGBA_ASTC_10x6:8===t?Lf.RGBA_ASTC_10x8:Lf.RGBA_ASTC_10x10:10===t?Lf.RGBA_ASTC_12x10:Lf.RGBA_ASTC_12x12}(n,o),c=i[7]+(i[8]<<8)+(i[9]<<16),l=i[10]+(i[11]<<8)+(i[12]<<16);i[13],i[14],i[15],s={_data:new Uint8Array(t,16),_compressed:!0,width:c,height:l,format:a}}catch(e){n=e}i(n,s)}parsePlist(e,t,i){let n=null;const s=VA.parse(e);s||(n=new Error("parse failed")),i(n,s)}parseImport(e,t,i){if(!e)return void i(new Error(`The json file of asset ${t.__uuid__} is empty or missing`));let n=null,s=null;try{n=fm(e,t)}catch(e){s=e}i(s,n)}init(){this._parsing.clear()}register(e,t){"object"==typeof e?fe(this._parsers,e):this._parsers[e]=t}parse(e,t,i,n,s){const o=Wl.get(e);if(o)return void s(null,o);const r=this._parsing.get(e);if(r)return void r.push(s);const a=this._parsers[i];a?(this._parsing.add(e,[s]),a(t,n,((t,i)=>{t?jl.remove(e):ch(i)||Wl.add(e,i);const n=this._parsing.remove(e);for(let e=0,s=n.length;e<s;e++)n[e](t,i)}))):s(null,t)}};function qA(e,t){let i=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},i=!0);const{options:s,progress:o}=e;s.__exclude__=s.__exclude__||Object.create(null),e.output=[],_A(e.input,((r,a)=>{const c=Jl.create({input:r,onProgress:e.onProgress,options:s,progress:o,onComplete:(s,l)=>{s&&!e.isFinish&&(!n.assetManager.force||i?(d(s.message,s.stack),o.canInvoke=!1,t(s)):o.canInvoke&&e.dispatch("progress",++o.finish,o.total,r)),e.output.push(l),c.recycle(),a(null)}});XA.async(c)}),(()=>{if(s.__exclude__=null,e.isFinish)return aA(e,!0),void e.dispatch("error");!function(e){const t=e.source;if(e.options.__outputAsArray__||1!==t.length){const i=e.output=[];for(let e=0,n=t.length;e<n;e++)i.push(t[e].content)}else e.output=t[0].content}(e),aA(e,!0),t()}))}const XA=new Hl("loadOneAsset",[function(e,t){const i=e.output=e.input,{options:n,isNative:s,uuid:o,file:r}=i,{reloadAsset:a}=n;r||!a&&!s&&Vl.has(o)?t():GA.load(i,e.options,((e,n)=>{i.file=n,t(e)}))},function(e,t){const i=e.output=e.input,n=e.progress,s=e.options.__exclude__,{id:o,file:r,options:a}=i;if(i.isNative)WA.parse(o,r,i.ext,a,((s,r)=>{s?t(s):(i.content=r,n.canInvoke&&e.dispatch("progress",++n.finish,n.total,i),jl.remove(o),Wl.remove(o),t())}));else{const{uuid:c}=i;if(c in s){const{finish:o,content:r,err:a,callbacks:l}=s[c];n.canInvoke&&e.dispatch("progress",++n.finish,n.total,i),o||fA(c,c,s)?(r&&r.addRef(),i.content=r,t(a)):l.push({done:t,item:i})}else if(!a.reloadAsset&&Vl.has(c)){const s=Vl.get(c);i.content=s.addRef(),n.canInvoke&&e.dispatch("progress",++n.finish,n.total,i),t()}else a.__uuid__=c,WA.parse(o,r,"import",a,((i,n)=>{i?t(i):function(e,t,i){const{input:n,progress:s}=e,{uuid:o,id:r,options:a,config:c}=n,{cacheAsset:l}=a,h=[];t.addRef&&t.addRef(),hA(o,t,Object.create(null),h,c),s.canInvoke&&e.dispatch("progress",++s.finish,s.total+=h.length,n);const u=e.options.__exclude__[o]={content:t,finish:!1,callbacks:[{done:i,item:n}]},_=Jl.create({input:h,options:e.options,onProgress:e.onProgress,onError:Jl.prototype.recycle,progress:s,onComplete:e=>{if(t.decRef&&t.decRef(!1),u.finish=!0,u.err=e,!e){const e=Array.isArray(_.output)?_.output:[_.output],i=Object.create(null);for(const t of e)t&&(i[t instanceof xh?`${t._uuid}@import`:`${o}@native`]=t);!function(e,t,i){let n=!1;const s=_m.get(t);if(s){for(let e=0,t=s.length;e<t;e++){const t=s[e],o=i[`${t.uuid}@import`];if(o)t.owner[t.prop]=o.addRef();else{if(d(`The asset ${t.uuid} is missing!`),t.type&&t.type!==xh){const e=new t.type;e.initDefault(t.uuid),t.owner[t.prop]=e}n=!0}}_m.delete(t)}pm.has(t)&&(i[`${e}@native`]?t._nativeAsset=i[`${e}@native`]:(n=!0,console.error(`the native asset of ${e} is missing!`)),pm.delete(t))}(o,t,i);try{"function"!=typeof t.onLoaded||dm.has(t)||pm.has(t)||(t.onLoaded(),dm.add(t))}catch(e){d(`The asset ${o} is invalid for some reason, detail message: ${e.message}, stack: ${e.stack}`)}jl.remove(r),Wl.remove(r),uA(o,t,l),_.recycle()}const i=u.callbacks;for(let n=0,s=i.length;n<s;n++){const s=i[n];t.addRef&&t.addRef(),s.item.content=t,s.done(e)}i.length=0}});Xl.async(_)}(e,n,t)}))}}]);function YA(e,t){const i=e.options,n=Object.create(null),s=Object.create(null);for(const e in i)switch(e){case $l.PATH:case $l.UUID:case $l.DIR:case $l.SCENE:case $l.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":n[e]=i[e];break;case"__exclude__":case"__outputAsArray__":s[e]=i[e];break;default:n[e]=i[e],s[e]=i[e]}e.options=s;const o=Jl.create({input:e.input,options:n});let r=null;try{e.output=e.source=Kl.sync(o)}catch(e){r=e;for(let e=0,t=o.output.length;e<t;e++)o.output[e].recycle()}o.recycle(),t(r)}class KA{constructor(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}get id(){return this._id||(this._id=`${this.uuid}@${this.isNative?"native":"import"}`),this._id}static create(){let e;return e=0!==KA._deadPool.length?KA._deadPool.pop():new KA,e}recycle(){KA._deadPool.length!==KA.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),KA._deadPool.push(this))}}KA.MAX_DEAD_NUM=500,KA._deadPool=[];const $A=[];function QA(e){var t;const i=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(let o=0;o<n.length;o++){let r=n[o],a=KA.create(),c=null,l=null;if("string"==typeof r&&(r=Object.create(null),r[i.__requestType__||$l.UUID]=n[o]),"object"==typeof r){de(r,i),r.preset&&de(r,Ql[r.preset]);for(const e in r){switch(e){case $l.UUID:{var s;const e=a.uuid=sh(r.uuid);if(!r.bundle){const t=ql.find((t=>!!t.getAssetInfo(e)));r.bundle=t&&t.name}if(ql.has(r.bundle)){if(c=ql.get(r.bundle).config,l=c.getAssetInfo(e),l&&l.redirect){if(!ql.has(l.redirect))throw new Error(`Please load bundle ${l.redirect} first`);c=ql.get(l.redirect).config,l=c.getAssetInfo(e)}a.config=c,a.info=l}a.ext=r.ext||(null===(s=l)||void 0===s?void 0:s.extension)||".json";break}case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case $l.DIR:if(ql.has(r.bundle)){ql.get(r.bundle).config.getDirWithPath(r.dir,r.type,$A);for(const e of $A)n.push({uuid:e.uuid,__isNative__:!1,ext:e.extension||".json",bundle:r.bundle});$A.length=0}a.recycle(),a=null;break;case $l.PATH:if(ql.has(r.bundle)){if(c=ql.get(r.bundle).config,l=c.getInfoWithPath(r.path,r.type),l&&l.redirect){if(!ql.has(l.redirect))throw new Error(`you need to load bundle ${l.redirect} first`);c=ql.get(l.redirect).config,l=c.getAssetInfo(l.uuid)}if(!l)throw a.recycle(),new Error(`Bundle ${r.bundle} doesn't contain ${r.path}`);a.config=c,a.uuid=l.uuid,a.info=l}a.ext=r.ext||(null===(t=l)||void 0===t?void 0:t.extension)||".json";break;case $l.SCENE:if(!r.bundle){const e=ql.find((e=>!!e.getSceneInfo(r.scene)));r.bundle=e&&e.name}if(ql.has(r.bundle)){if(c=ql.get(r.bundle).config,l=c.getSceneInfo(r.scene),l&&l.redirect){if(!ql.has(l.redirect))throw new Error(`you need to load bundle ${l.redirect} first`);c=ql.get(l.redirect).config,l=c.getAssetInfo(l.uuid)}if(!l)throw a.recycle(),new Error(`Bundle ${c.name} doesn't contain scene ${r.scene}`);a.config=c,a.uuid=l.uuid,a.info=l}break;case"__isNative__":a.isNative=r.__isNative__;break;case $l.URL:a.url=r.url,a.uuid=r.uuid||r.url,a.ext=r.ext||Cn(r.url),a.isNative=void 0===r.__isNative__||r.__isNative__;break;default:a.options[e]=r[e]}if(!a)break}}if(a&&(e.output.push(a),!a.uuid&&!a.url))throw new Error(`Can not parse this input:${JSON.stringify(r)}`)}return null}function ZA(e){const t=e.output=e.input;for(let e=0;e<t.length;e++){const i=t[e];if(i.url)continue;let s="",o="";const r=i.config;o=i.isNative?r&&r.nativeBase?r.base+r.nativeBase:n.assetManager.generalNativeBase:r&&r.importBase?r.base+r.importBase:n.assetManager.generalImportBase;const a=i.uuid;let c="";i.info&&(c=i.isNative?i.info.nativeVer?`.${i.info.nativeVer}`:"":i.info.ver?`.${i.info.ver}`:""),s=".ttf"===i.ext?`${o}/${a.slice(0,2)}/${a}${c}/${i.options.__nativeName__}`:`${o}/${a.slice(0,2)}/${a}${c}${i.ext}`,i.url=s}return null}class JA{constructor(){this.pipeline=Xl.append(YA).append(qA),this.fetchPipeline=Yl.append(YA).append(kA),this.transformPipeline=Kl.append(QA).append(ZA),this.bundles=ql,this.assets=Vl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=gm,this.force=!1,this.allowImageBitmap=!xn.isMobile,this.utils=uh,this.downloader=OA,this.parser=WA,this.packManager=GA,this.cacheAsset=!0,this.cacheManager=null,this.presets=Ql,this.factory=UA,this.preprocessPipe=YA,this.fetchPipe=kA,this.loadPipe=qA,this.references=null,this._releaseManager=oA,this._files=jl,this._parsed=Wl,this._parsePipeline=null}get main(){return ql.get(Zl.MAIN)||null}get resources(){return ql.get(Zl.RESOURCES)||null}init(e={}){this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();let t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));let i=e.nativeBase||"";i&&i.endsWith("/")&&(i=i.substr(0,i.length-1)),this.generalImportBase=t,this.generalNativeBase=i}getBundle(e){return ql.get(e)||null}removeBundle(e){e._destroy(),ql.remove(e.name)}loadAny(e,t,i,n){const{options:s,onProgress:o,onComplete:r}=pA(t,i,n);s.preset=s.preset||"default",e=Array.isArray(e)?e.slice():e;const a=Jl.create({input:e,onProgress:o,onComplete:mA(r),options:s});Xl.async(a)}preloadAny(e,t,i,n){const{options:s,onProgress:o,onComplete:r}=pA(t,i,n);s.preset=s.preset||"preload",e=Array.isArray(e)?e.slice():e;const a=Jl.create({input:e,onProgress:o,onComplete:mA(r),options:s});Yl.async(a)}loadRemote(e,t,i){const{options:n,onComplete:s}=pA(t,void 0,i);n.reloadAsset||!this.assets.has(e)?(n.__isNative__=!0,n.preset=n.preset||"remote",this.loadAny({url:e},n,null,((t,i)=>{t?(d(t.message,t.stack),s&&s(t,i)):UA.create(e,i,n.ext||Cn(e),n,((e,t)=>{s&&s(e,t)}))}))):mA(s)(null,this.assets.get(e))}loadBundle(e,t,i){const{options:n,onComplete:s}=pA(t,void 0,i),o=An(e);this.bundles.has(o)?mA(s)(null,this.getBundle(o)):(n.preset=n.preset||"bundle",n.ext="bundle",n.__isNative__=!0,this.loadAny({url:e},n,null,((t,i)=>{t?(d(t.message,t.stack),s&&s(t,i)):UA.create(e,i,"bundle",n,((e,t)=>{s&&s(e,t)}))})))}releaseAsset(e){oA.tryRelease(e,!0)}releaseUnusedAssets(){Vl.forEach((e=>{oA.tryRelease(e)}))}releaseAll(){Vl.forEach((e=>{oA.tryRelease(e,!0)}))}loadWithJson(e,t,i,n){throw new Error("Only valid in Editor")}}e("AssetManager",JA),JA.Pipeline=Hl,JA.Task=Jl,JA.Cache=kl,JA.RequestItem=KA,JA.Bundle=gA,JA.BuiltinBundleName=Zl;var eP=e("assetManager",n.assetManager=new JA);n.AssetManager=JA;const tP=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],iP=[".mp3",".ogg",".wav",".m4a"];function nP(){return!0}const sP={transformURL(e){const t=rh(e);if(!t)return e;const i=ql.find((e=>!!e.getAssetInfo(t)));if(!i)return e;let n="";const s=i.getAssetInfo(t);if(n=e.startsWith(i.base+i.config.nativeBase)?s.nativeVer||"":s.ver||"",!n||-1!==e.indexOf(n))return e;let o=!1;if(".ttf"===Cn(e)&&(o=!0),o){const t=Pn(e),i=An(e);e=`${t}.${n}/${i}`}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/,(e=>`${e}.${n}`));return e}};class oP{constructor(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=dA}set onProgress(e){rA=e}get _cache(){return Vl._map}load(e,t,i){void 0===i&&void 0!==t&&(i=t,t=null);const n=Array.isArray(e)?e:[e];for(let e=0;e<n.length;e++){const t=n[e];"string"==typeof t?n[e]={url:t,__isNative__:!0}:(t.type&&(t.ext=`.${t.type}`,t.type=void 0),t.url&&(t.__isNative__=!0))}const s=[],o=[];eP.loadAny(n,null,((e,i,n)=>{n.content&&(tP.includes(n.ext)?s.push(n.content):iP.includes(n.ext)&&o.push(n.content)),t&&t(e,i,n)}),((e,t)=>{let r=null;if(!e){t=Array.isArray(t)?t:[t];for(let e=0;e<t.length;e++){const i=t[e];if(!(i instanceof xh)){let r=i;const a=n[e].url;s.includes(r)?UA.create(a,i,".png",{},((i,n)=>{r=t[e]=n})):o.includes(r)&&UA.create(a,i,".mp3",{},((i,n)=>{r=t[e]=n})),Vl.add(a,r)}}if(t.length>1){const e=Object.create(null);t.forEach((t=>{e[t._uuid]=t})),r={isCompleted:nP,_map:e}}else r=t[0]}i&&i(e,r)}))}getXMLHttpRequest(){return new XMLHttpRequest}getItem(e){return eP.assets.has(e)?{content:eP.assets.get(e)}:null}loadRes(e,t,i,n){const{type:s,onProgress:o,onComplete:r}=this._parseLoadResArgs(t,i,n),a=Cn(e);a&&!vA.getInfoWithPath(e,s)&&(e=e.slice(0,-a.length)),vA.load(e,s,o,r)}loadResArray(e,t,i,n){const{type:s,onProgress:o,onComplete:r}=this._parseLoadResArgs(t,i,n);e.forEach(((t,i)=>{const n=Cn(t);n&&!vA.getInfoWithPath(t,s)&&(e[i]=t.slice(0,-n.length))})),vA.load(e,s,o,r)}loadResDir(e,t,i,n){const{type:s,onProgress:o,onComplete:r}=this._parseLoadResArgs(t,i,n);vA.loadDir(e,s,o,((t,i)=>{let n=[];t||(n=vA.getDirWithPath(e,s).map((e=>e.path))),r&&r(t,i,n)}))}getRes(e,t){return Vl.has(e)?Vl.get(e):vA.get(e,t)}getResCount(){return Vl.count}getDependsRecursively(e){if(!e)return[];const t="string"==typeof e?e:e._uuid;return gm.getDepsRecursively(t).concat([t])}get md5Pipe(){return sP}get downloader(){return OA}get loader(){return eP.parser}addDownloadHandlers(e){const t=Object.create(null);for(const i in e){const n=e[i];t[`.${i}`]=(e,t,i)=>{n({url:e},i)}}OA.register(t)}addLoadHandlers(e){const t=Object.create(null);for(const i in e){const n=e[i];t[`.${i}`]=(e,t,i)=>{n({content:e},i)}}WA.register(t)}release(e){if(Array.isArray(e))for(let t=0;t<e.length;t++){let i=e[t];"string"==typeof i&&(i=Vl.get(i)),eP.releaseAsset(i)}else e&&("string"==typeof e&&(e=Vl.get(e)),eP.releaseAsset(e))}releaseAsset(e){eP.releaseAsset(e)}releaseRes(e,t){vA.release(e,t)}releaseAll(){eP.releaseAll(),Vl.clear()}removeItem(e){return!!Vl.remove(e)}setAutoRelease(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t}setAutoReleaseRecursively(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;const i=gm.getDepsRecursively(e);for(let e=0;e<i.length;e++)this._autoReleaseSetting[i[e]]=t}isAutoRelease(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]}}e("CCLoader",oP);const rP=e("loader",new oP),aP=e("AssetLibrary",{init(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,eP.init(e),e.rawAssets&&vA.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:Zl.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset(e,t,i){eP.loadAny(e,t)}}),cP=e("url",{});ei(cP,"url",[{name:"normalize",target:eP.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:e=>e.startsWith("resources/")?hh({path:Rn(e.substr(10)),bundle:Zl.RESOURCES,__isNative__:!0,ext:Cn(e)}):""}]),ti(aP,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),ti(rP,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),ei(n,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:()=>rP},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:()=>aP},{name:"Pipeline",target:JA,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:()=>cP}]),ti(n,"cc",[{name:"LoadingItems",suggest:R(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),ei(Ge,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:OA,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),ei(Qw,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:e=>{var t;return eP.main?null===(t=eP.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),ei(Iw,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:()=>{const e=[];return eP.main&&eP.main.config.scenes.forEach((t=>{e.push(t)})),e}}]);const lP=oA._autoRelease;var hP,uP,_P,pP,dP,fP,mP,gP,vP,yP,xP,SP,bP;oA._autoRelease=function(e,t,i){lP.call(oA,e,t,i);const n=rP._autoReleaseSetting,s=Object.keys(n);for(let e=0;e<s.length;e++){const t=s[e];if(!0===n[t]){const e=Vl.get(t);e&&oA.tryRelease(e)}}};let TP=e("EventHandler",(hP=Wc("cc.ClickEvent"),uP=Al(n.Node),_P=_l(),pP=_l(),dP=_l(),fP=_l(),hP((vP=Oc((gP=class e{constructor(){Mc(this,"target",vP,this),Mc(this,"component",yP,this),Mc(this,"_componentId",xP,this),Mc(this,"handler",SP,this),Mc(this,"customEventData",bP,this)}get _componentName(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)}set _componentName(e){this._componentId=this._compName2Id(e)}static emitEvents(t,...i){for(let n=0,s=t.length;n<s;n++){const s=t[n];s instanceof e&&s.emit(i)}}emit(e){const t=this.target;if(!n.isValid(t))return;this._genCompIdIfNeeded();const i=n.js._getClassById(this._componentId),s=t.getComponent(i);if(!n.isValid(s))return;const o=s[this.handler];"function"==typeof o&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),o.apply(s,e))}_compName2Id(e){const t=n.js.getClassByName(e);return n.js._getClassId(t)}_compId2Name(e){const t=n.js._getClassById(e);return n.js.getClassName(t)}_genCompIdIfNeeded(){this._componentId||(this._componentName=this.component,this.component="")}}).prototype,"target",[Qc,uP,_P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yP=Oc(gP.prototype,"component",[Qc,cl,pP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xP=Oc(gP.prototype,"_componentId",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SP=Oc(gP.prototype,"handler",[Qc,cl,dP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bP=Oc(gP.prototype,"customEventData",[Qc,cl,fP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mP=gP))||mP));var EP,CP,wP,AP,PP,RP,IP,MP,OP,DP,NP,LP,BP,zP,FP,UP,GP,kP,HP,VP,jP,WP,qP,XP,YP,KP,$P,QP,ZP,JP,eR,tR,iR,nR,sR,oR,rR,aR,cR,lR,hR,uR,_R,pR,dR,fR,mR,gR,vR,yR,xR,SR,bR,TR,ER,CR,wR,AR,PR,RR,IR,MR,OR,DR,NR,LR,BR;n.Component.EventHandler=TP;const zR=new zi,FR=Le(bf),UR=Le(Sf),GR=Le(Tf),kR=Le(Cf),HR=Le(Ef),VR=Le({SKYBOX:Of|fo.DEPTH_STENCIL,SOLID_COLOR:fo.ALL,DEPTH_ONLY:fo.DEPTH_STENCIL,DONT_CLEAR:fo.NONE});let jR=(EP=Wc("cc.Camera"),CP=al(),wP=nl(),AP=vl(),PP=_l(),RP=Al(id.BitMask),IP=vl(),MP=_l(),OP=Al(VR),DP=vl(),NP=_l(),LP=vl(),BP=_l(),zP=vl(),FP=_l(),UP=vl(),GP=_l(),kP=Al(FR),HP=vl(),VP=_l(),jP=Al(UR),WP=vl(),qP=_l(),XP=vl(),YP=_l(),KP=vl(),$P=_l(),QP=vl(),ZP=_l(),JP=vl(),eR=_l(),tR=Al(GR),iR=vl(),nR=_l(),sR=Al(kR),oR=vl(),rR=_l(),aR=Al(HR),cR=vl(),lR=_l(),hR=vl(),uR=_l(),_R=Al(JS),pR=vl(),dR=_l(),WR=EP(fR=CP(fR=wP(fR=il((BR=LR=class e extends Gh{constructor(...e){super(...e),Mc(this,"_projection",gR,this),Mc(this,"_priority",vR,this),Mc(this,"_fov",yR,this),Mc(this,"_fovAxis",xR,this),Mc(this,"_orthoHeight",SR,this),Mc(this,"_near",bR,this),Mc(this,"_far",TR,this),Mc(this,"_color",ER,this),Mc(this,"_depth",CR,this),Mc(this,"_stencil",wR,this),Mc(this,"_clearFlags",AR,this),Mc(this,"_rect",PR,this),Mc(this,"_aperture",RR,this),Mc(this,"_shutter",IR,this),Mc(this,"_iso",MR,this),Mc(this,"_screenScale",OR,this),Mc(this,"_visibility",DR,this),Mc(this,"_targetTexture",NR,this),this._camera=null,this._inEditorMode=!1,this._flows=void 0}get camera(){return this._camera}get priority(){return this._priority}set priority(e){this._priority=e,this._camera&&(this._camera.priority=e)}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}get clearFlags(){return this._clearFlags}set clearFlags(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}get clearColor(){return this._color}set clearColor(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}get clearDepth(){return this._depth}set clearDepth(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}get clearStencil(){return this._stencil}set clearStencil(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}get projection(){return this._projection}set projection(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}get fovAxis(){return this._fovAxis}set fovAxis(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Sf.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}get fov(){return this._fov}set fov(e){this._fov=e,this._camera&&(this._camera.fov=gi(e))}get orthoHeight(){return this._orthoHeight}set orthoHeight(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}get near(){return this._near}set near(e){this._near=e,this._camera&&(this._camera.nearClip=e)}get far(){return this._far}set far(e){this._far=e,this._camera&&(this._camera.farClip=e)}get aperture(){return this._aperture}set aperture(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}get shutter(){return this._shutter}set shutter(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}get iso(){return this._iso}set iso(e){this._iso=e,this._camera&&(this._camera.iso=e)}get rect(){return this._rect}set rect(e){this._rect=e,this._camera&&(this._camera.viewport=e)}get targetTexture(){return this._targetTexture}set targetTexture(t){if(this._targetTexture===t)return;const i=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(i),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(e.TARGET_TEXTURE_CHANGE,this)}get screenScale(){return this._screenScale}set screenScale(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}get inEditorMode(){return this._inEditorMode}set inEditorMode(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?n.director.root&&n.director.root.mainWindow:n.director.root&&n.director.root.tempWindow)}onLoad(){this._createCamera()}onEnable(){this.node.hasChangedFlags|=Cg.POSITION,this._camera&&this._attachToScene()}onDisable(){this._camera&&this._detachFromScene()}onDestroy(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}screenPointToRay(e,t,i){return i||(i=Ss.create()),this._camera&&this._camera.screenPointToRay(i,e,t),i}worldToScreen(e,t){return t||(t=new zi),this._camera&&this._camera.worldToScreen(t,e),t}screenToWorld(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}convertToUINode(e,t,i){if(i||(i=new zi),!this._camera)return i;this.worldToScreen(e,zR);const s=t.getComponent("cc.UITransform"),o=Fw.getVisibleSize(),r=zR.x-.5*this._camera.width,a=zR.y-.5*this._camera.height;return zR.x=r/n.view.getScaleX()+.5*o.width,zR.y=a/n.view.getScaleY()+.5*o.height,s&&s.convertToNodeSpaceAR(zR,i),i}_createCamera(){this._camera||(this._camera=n.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?n.director.root&&n.director.root.mainWindow:n.director.root&&n.director.root.tempWindow,priority:this._priority}),this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=gi(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}_attachToScene(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}_detachFromScene(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}_checkTargetTextureEvent(e){e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(e=>{this._camera&&this._camera.setFixedSize(e.width,e.height)}),this)}_updateTargetTexture(){if(this._camera&&this._targetTexture){const e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},LR.ProjectionType=FR,LR.FOVAxis=UR,LR.ClearFlag=VR,LR.Aperture=GR,LR.Shutter=kR,LR.ISO=HR,LR.TARGET_TEXTURE_CHANGE="tex-change",gR=Oc((mR=BR).prototype,"_projection",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FR.PERSPECTIVE}}),vR=Oc(mR.prototype,"_priority",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yR=Oc(mR.prototype,"_fov",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),xR=Oc(mR.prototype,"_fovAxis",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UR.VERTICAL}}),SR=Oc(mR.prototype,"_orthoHeight",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),bR=Oc(mR.prototype,"_near",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),TR=Oc(mR.prototype,"_far",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),ER=Oc(mR.prototype,"_color",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di("#333333")}}),CR=Oc(mR.prototype,"_depth",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wR=Oc(mR.prototype,"_stencil",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AR=Oc(mR.prototype,"_clearFlags",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VR.SOLID_COLOR}}),PR=Oc(mR.prototype,"_rect",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _n(0,0,1,1)}}),RR=Oc(mR.prototype,"_aperture",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GR.F16_0}}),IR=Oc(mR.prototype,"_shutter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kR.D125}}),MR=Oc(mR.prototype,"_iso",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HR.ISO100}}),OR=Oc(mR.prototype,"_screenScale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),DR=Oc(mR.prototype,"_visibility",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xf}}),NR=Oc(mR.prototype,"_targetTexture",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(mR.prototype,"priority",[AP,PP],Object.getOwnPropertyDescriptor(mR.prototype,"priority"),mR.prototype),Oc(mR.prototype,"visibility",[RP,IP,MP],Object.getOwnPropertyDescriptor(mR.prototype,"visibility"),mR.prototype),Oc(mR.prototype,"clearFlags",[OP,DP,NP],Object.getOwnPropertyDescriptor(mR.prototype,"clearFlags"),mR.prototype),Oc(mR.prototype,"clearColor",[LP,BP],Object.getOwnPropertyDescriptor(mR.prototype,"clearColor"),mR.prototype),Oc(mR.prototype,"clearDepth",[zP,FP],Object.getOwnPropertyDescriptor(mR.prototype,"clearDepth"),mR.prototype),Oc(mR.prototype,"clearStencil",[UP,GP],Object.getOwnPropertyDescriptor(mR.prototype,"clearStencil"),mR.prototype),Oc(mR.prototype,"projection",[kP,HP,VP],Object.getOwnPropertyDescriptor(mR.prototype,"projection"),mR.prototype),Oc(mR.prototype,"fovAxis",[jP,WP,qP],Object.getOwnPropertyDescriptor(mR.prototype,"fovAxis"),mR.prototype),Oc(mR.prototype,"fov",[XP,YP],Object.getOwnPropertyDescriptor(mR.prototype,"fov"),mR.prototype),Oc(mR.prototype,"orthoHeight",[KP,$P],Object.getOwnPropertyDescriptor(mR.prototype,"orthoHeight"),mR.prototype),Oc(mR.prototype,"near",[QP,ZP],Object.getOwnPropertyDescriptor(mR.prototype,"near"),mR.prototype),Oc(mR.prototype,"far",[JP,eR],Object.getOwnPropertyDescriptor(mR.prototype,"far"),mR.prototype),Oc(mR.prototype,"aperture",[tR,iR,nR],Object.getOwnPropertyDescriptor(mR.prototype,"aperture"),mR.prototype),Oc(mR.prototype,"shutter",[sR,oR,rR],Object.getOwnPropertyDescriptor(mR.prototype,"shutter"),mR.prototype),Oc(mR.prototype,"iso",[aR,cR,lR],Object.getOwnPropertyDescriptor(mR.prototype,"iso"),mR.prototype),Oc(mR.prototype,"rect",[hR,uR],Object.getOwnPropertyDescriptor(mR.prototype,"rect"),mR.prototype),Oc(mR.prototype,"targetTexture",[_R,pR,dR],Object.getOwnPropertyDescriptor(mR.prototype,"targetTexture"),mR.prototype),fR=mR))||fR)||fR)||fR)||fR,e({Camera:WR,CameraComponent:WR}),WR);var WR,qR,XR,YR,KR,$R,QR,ZR,JR,eI;n.Camera=jR;const tI={parent:null,owner:null,subModelIdx:0};let iI=e("RenderableComponent",(qR=Wc("cc.RenderableComponent"),XR=Al([Wg]),YR=Al(Wg),KR=vl(),$R=ul(),qR((JR=Oc((ZR=class extends Gh{constructor(...e){super(...e),Mc(this,"_materials",JR,this),Mc(this,"_visFlags",eI,this),this._materialInstances=[],this._models=[]}get visibility(){return this._visFlags}set visibility(e){this._visFlags=e,this._onVisibilityChange(e)}get sharedMaterials(){return this._materials}set sharedMaterials(e){for(let t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(let t=e.length;t<this._materials.length;t++)this.setMaterial(null,t);this._materials.splice(e.length)}}get materials(){for(let e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances}set materials(e){const t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(let e=this._materials.length-t;e<this._materials.length;++e)this.setMaterialInstance(null,e);for(let t=0;t<this._materialInstances.length;t++)this._materialInstances[t]!=e[t]&&this.setMaterialInstance(e[t],t)}get sharedMaterial(){return this.getMaterial(0)}getMaterial(e){return e<0||e>=this._materials.length?null:this._materials[e]}setMaterial(e,t){e&&e instanceof av&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;const i=this._materialInstances[t];i&&(i.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])}get material(){return this.getMaterialInstance(0)}set material(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}getMaterialInstance(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){tI.parent=this._materials[e],tI.owner=this,tI.subModelIdx=e;const t=new av(tI);tI.parent=null,tI.owner=null,tI.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]}setMaterialInstance(e,t){if("number"==typeof e){T(12007);const i=e;e=t,t=i}const i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)}getRenderMaterial(e){return this._materialInstances[e]||this._materials[e]}_collectModels(){return this._models}_attachToScene(){}_detachFromScene(){}_onMaterialModified(e,t){}_onRebuildPSO(e,t){}_clearMaterials(){}_onVisibilityChange(e){}}).prototype,"_materials",[XR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eI=Oc(ZR.prototype,"_visFlags",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return id.Enum.NONE}}),Oc(ZR.prototype,"sharedMaterials",[YR,KR,$R],Object.getOwnPropertyDescriptor(ZR.prototype,"sharedMaterials"),ZR.prototype),QR=ZR))||QR));var nI,sI,oI,rI,aI,cI;function lI(e){return"string"==typeof e||"number"==typeof e}n.RenderableComponent=iI,ei(jR,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),ei(jR.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),n.CameraComponent=jR,De.setClassAlias(jR,"cc.CameraComponent");let hI=Wc("cc.animation.HierarchyPath")((oI=Oc((sI=class{constructor(e){Mc(this,"path",oI,this),this.path=e||""}get(e){if(!(e instanceof ix))return T(3925),null;return e.getChildByPath(this.path)||(T(3926,e.name,this.path),null)}}).prototype,"path",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nI=sI))||nI,uI=Wc("cc.animation.ComponentPath")((cI=Oc((aI=class{constructor(e){Mc(this,"component",cI,this),this.component=e||""}get(e){if(!(e instanceof ix))return T(3927),null;return e.getComponent(this.component)||(T(3928,e.name,this.component),null)}}).prototype,"component",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rI=aI))||rI;var _I,pI,dI,fI,mI;let gI=Wc("cc.animation.UniformProxyFactory")((dI=Oc((pI=class{constructor(e,t){Mc(this,"passIndex",dI,this),Mc(this,"uniformName",fI,this),Mc(this,"channelIndex",mI,this),this.passIndex=t||0,this.uniformName=e||""}forTarget(e){const t=e.passes[this.passIndex],i=t.getHandle(this.uniformName);if(!i)throw new Error(`Material "${e.name}" has no uniform "${this.uniformName}"`);const s=dg.getPropertyTypeFromHandle(i);if(s===km.BUFFER){const n=void 0===this.channelIndex?i:t.getHandle(this.uniformName,this.channelIndex,zs.FLOAT);if(!n)throw new Error(`Uniform "${this.uniformName} (in material ${e.name}) has no channel ${this.channelIndex}"`);return function(e,t){for(const i of e.shaderInfo.blocks)for(const e of i.members)if(e.name===t)return e.count>1;return!1}(t,this.uniformName)?{set:e=>{t.setUniformArray(n,e)}}:{set:e=>{t.setUniform(n,e)}}}if(s===km.TEXTURE){const e=dg.getBindingFromHandle(i),s=t.properties[this.uniformName],o=s&&s.value?`${s.value}-texture`:Qm(s.type);let r=cg.get(o);return r||(p(`Illegal texture default value: ${o}.`),r=cg.get("default-texture")),{set:i=>{i||(i=r);const s=i.getGFXTexture();s&&s.width&&s.height&&(t.bindTexture(e,s),i instanceof um&&t.bindSampler(e,Qf.getSampler(n.game._gfxDevice,i.getSamplerHash())))}}}throw new Error(`Animations are not available for uniforms with property type ${s}.`)}}).prototype,"passIndex",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fI=Oc(pI.prototype,"uniformName",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mI=Oc(pI.prototype,"channelIndex",[El],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),_I=pI))||_I;var vI,yI,xI,SI,bI,TI,EI,CI;let wI=Wc("cc.animation.MorphWeightValueProxy")((xI=Oc((yI=class{constructor(){Mc(this,"subMeshIndex",xI,this),Mc(this,"shapeIndex",SI,this)}forTarget(e){return{set:t=>{e.setWeight(t,this.subMeshIndex,this.shapeIndex)}}}}).prototype,"subMeshIndex",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SI=Oc(yI.prototype,"shapeIndex",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vI=yI))||vI,AI=Wc("cc.animation.MorphWeightsValueProxy")((EI=Oc((TI=class{constructor(){Mc(this,"subMeshIndex",EI,this)}forTarget(e){return{set:t=>{e.setWeights(t,this.subMeshIndex)}}}}).prototype,"subMeshIndex",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bI=TI))||bI,PI=Wc("cc.animation.MorphWeightsAllValueProxy")(CI=class{forTarget(e){return{set:t=>{var i,n;const s=null!==(i=null===(n=e.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0;for(let i=0;i<s;++i)e.setWeights(t,i)}}}})||CI;var RI,II,MI,OI,DI;function NI(e,t,i,n){var s,o,r,a,c;let l=new t,h=new t,u=new t,_=Wc(e)((r=Oc((o=class{constructor(e,i,n){Mc(this,"dataPoint",r,this),Mc(this,"inTangent",a,this),Mc(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=i||new t,this.outTangent=n||new t}lerp(e,t,s){const o=this.dataPoint,r=e.dataPoint;h=i(h,this.inTangent,s),u=i(u,e.outTangent,s);const a=t*t*t,c=t*t,_=a-2*c+t,p=-2*a+3*c,d=a-c;return l=i(l,o,2*a-3*c+1),l=n(l,l,h,_),l=n(l,l,r,p),l=n(l,l,u,d),l}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),a=Oc(o.prototype,"inTangent",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=Oc(o.prototype,"outTangent",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=o))||s;if(t===ji){const e=_.prototype.lerp;_.prototype.lerp=function(t,i,n){const s=e.call(this,t,i,n);return ji.normalize(s,s),s}}return _}const LI=e("CubicSplineVec2Value",NI("cc.CubicSplineVec2Value",nn,nn.multiplyScalar,nn.scaleAndAdd));n.CubicSplineVec2Value=LI;const BI=e("CubicSplineVec3Value",NI("cc.CubicSplineVec3Value",zi,zi.multiplyScalar,zi.scaleAndAdd));n.CubicSplineVec3Value=BI;const zI=e("CubicSplineVec4Value",NI("cc.CubicSplineVec4Value",an,an.multiplyScalar,an.scaleAndAdd));n.CubicSplineVec4Value=zI;const FI=e("CubicSplineQuatValue",NI("cc.CubicSplineQuatValue",ji,ji.multiplyScalar,ji.scaleAndAdd));n.CubicSplineQuatValue=FI;let UI=e("CubicSplineNumberValue",Wc("cc.CubicSplineNumberValue")((MI=Oc((II=class{constructor(e,t,i){Mc(this,"dataPoint",MI,this),Mc(this,"inTangent",OI,this),Mc(this,"outTangent",DI,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}lerp(e,t,i){const n=this.dataPoint,s=e.dataPoint,o=t*t*t,r=t*t;return n*(2*o-3*r+1)+this.outTangent*i*(o-2*r+t)+s*(-2*o+3*r)+e.inTangent*i*(o-r)}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OI=Oc(II.prototype,"inTangent",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DI=Oc(II.prototype,"outTangent",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RI=II))||RI);n.CubicSplineNumberValue=UI;const GI=Symbol("CreateEval");var kI,HI,VI,jI,WI,qI,XI,YI,KI,$I,QI,ZI,JI,eM,tM,iM;const nM=Symbol("NormalizedFollow"),sM=Symbol("ConvertAsTrsPath"),oM=Symbol("TrackBinding");let rM=Wc("cc.animation.TrackPath")((VI=Oc((HI=class e{constructor(){Mc(this,"_paths",VI,this)}get length(){return this._paths.length}toProperty(e){return this._paths.push(e),this}toElement(e){return this._paths.push(e),this}toHierarchy(e){return this._paths.push(new hI(e)),this}toComponent(e){const t=new uI("string"==typeof e?e:De.getClassName(e));return this._paths.push(t),this}toCustomized(e){return this._paths.push(e),this}append(...e){const t=this._paths.concat(...e.map((e=>e._paths)));return this._paths=t,this}isPropertyAt(e){return"string"==typeof this._paths[e]}parsePropertyAt(e){return this._paths[e]}isElementAt(e){return"number"==typeof this._paths[e]}parseElementAt(e){return this._paths[e]}isHierarchyAt(e){return this._paths[e]instanceof hI}parseHierarchyAt(e){return this.isHierarchyAt(e),this._paths[e].path}isComponentAt(e){return this._paths[e]instanceof uI}parseComponentAt(e){return this.isComponentAt(e),this._paths[e].component}slice(t,i){const n=new e;return n._paths=this._paths.slice(t,i),n}trace(e,t,i){var n,s;return null!==(n=t)&&void 0!==n||(t=0),null!==(s=i)&&void 0!==s||(i=this._paths.length),this[nM](e,t,i)}[sM](){const{_paths:e}=this,t=e.length;let i,n=0,s="";for(;n<t;++n){const t=e[n];if(!(t instanceof hI))break;t.path&&(s?s+=`/${t.path}`:s=t.path)}if(n===t)return null;if(n!==t-1)return null;switch(e[n]){case"position":case"scale":case"rotation":case"eulerAngles":i=e[n];break;default:return null}return{node:s,property:i}}[nM](e,t,i){const{_paths:n}=this;let s=e;for(let e=t;e<i;++e){const t=n[e];if(lI(t)){if(!(t in s))return T(3929,t),null;s=s[t]}else s=t.get(s);if(null===s)break}return s}}).prototype,"_paths",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kI=HI))||kI,aM=Wc("cc.animation.TrackBinding")(jI=tl((qI=Oc((WI=class{constructor(){Mc(this,"path",qI,this),Mc(this,"proxy",XI,this)}parseTrsPath(){return this.proxy?null:this.path[sM]()}createRuntimeBinding(e,t,i){const{path:n,proxy:s}=this,o=n.length,r=o-1;if(0===o||!n.isPropertyAt(r)&&!n.isElementAt(r)||s){if(s){const t=n[nM](e,0,o);if(null===t)return null;const i=s.forTarget(t),r={setValue:e=>{i.set(e)}},a=i.get;return a&&(r.getValue=()=>a.call(i)),r}return C(3921),null}{const s=n.isPropertyAt(r)?n.parsePropertyAt(r):n.parseElementAt(r),c=n[nM](e,0,o-1);return null===c?null:t&&c instanceof ix&&("position"===(a=s)||"rotation"===a||"scale"===a||"eulerAngles"===a)?t.createPoseWriter(c,s,i):{setValue:e=>{c[s]=e},getValue:()=>c[s]}}var a}}).prototype,"path",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rM}}),XI=Oc(WI.prototype,"proxy",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),jI=WI))||jI)||jI,cM=Wc("cc.animation.Track")(($I=Oc((KI=class{constructor(){Mc(this,"_binding",$I,this)}get path(){return this._binding.path}set path(e){this._binding.path=e}get proxy(){return this._binding.proxy}set proxy(e){this._binding.proxy=e}get[oM](){return this._binding}channels(){return[]}range(){const e={min:1/0,max:-1/0};for(const t of this.channels())e.min=Math.min(e.min,t.curve.rangeMin),e.max=Math.max(e.max,t.curve.rangeMax);return e}[GI](e){throw new Error("No Impl")}}).prototype,"_binding",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new aM}}),YI=KI))||YI,lM=Wc("cc.animation.Channel")((JI=Oc((ZI=class{constructor(e){this.name="",Mc(this,"_curve",JI,this),this._curve=e}get curve(){return this._curve}}).prototype,"_curve",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QI=ZI))||QI,hM=Wc("cc.animation.SingleChannelTrack")((iM=Oc((tM=class extends cM{constructor(){super(),Mc(this,"_channel",iM,this),this._channel=new lM(this.createCurve())}get channel(){return this._channel}channels(){return[this._channel]}createCurve(){throw new Error("Not impl")}[GI](e){const{curve:t}=this._channel;return new uM(t)}}).prototype,"_channel",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),eM=tM))||eM;class uM{constructor(e){this._curve=e}evaluate(e){return this._curve.evaluate(e)}}var _M;let pM=Wc("cc.animation.RealTrack")(_M=class extends hM{createCurve(){return new q_}})||_M;function dM(e){return 0===e.keyFramesCount?void 0:e}var fM,mM,gM,vM;const yM=["X","Y","Z","W"];let xM=Wc("cc.animation.VectorTrack")((gM=Oc((mM=class extends cM{constructor(){super(),Mc(this,"_channels",gM,this),Mc(this,"_nComponents",vM,this),this._channels=new Array(4);for(let e=0;e<this._channels.length;++e){const t=new lM(new q_);t.name=yM[e],this._channels[e]=t}}get componentsCount(){return this._nComponents}set componentsCount(e){this._nComponents=e}channels(){return this._channels}[GI](){switch(this._nComponents){default:case 2:return new SM(dM(this._channels[0].curve),dM(this._channels[1].curve));case 3:return new bM(dM(this._channels[0].curve),dM(this._channels[1].curve),dM(this._channels[2].curve));case 4:return new TM(dM(this._channels[0].curve),dM(this._channels[1].curve),dM(this._channels[2].curve),dM(this._channels[3].curve))}}}).prototype,"_channels",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),vM=Oc(mM.prototype,"_nComponents",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),fM=mM))||fM;class SM{constructor(e,t){this._result=new nn,this._x=e,this._y=t}evaluate(e,t){return this._x&&this._y||!t.getValue||nn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result}}class bM{constructor(e,t,i){this._result=new zi,this._x=e,this._y=t,this._z=i}evaluate(e,t){return this._x&&this._y&&this._z||!t.getValue||zi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result}}class TM{constructor(e,t,i,n){this._result=new an,this._x=e,this._y=t,this._z=i,this._w=n}evaluate(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||an.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result}}var EM;let CM=Wc("cc.animation.QuatTrack")(EM=class extends hM{createCurve(){return new Ip}[GI](){return new wM(this.channels()[0].curve)}})||EM;class wM{constructor(e){this._result=new ji,this._curve=e}evaluate(e){return this._curve.evaluate(e,this._result),this._result}}var AM,PM,RM;const IM=["Red","Green","Blue","Alpha"];let MM=Wc("cc.animation.ColorTrack")((RM=Oc((PM=class extends cM{constructor(){super(),Mc(this,"_channels",RM,this),this._channels=new Array(4);for(let e=0;e<this._channels.length;++e){const t=new lM(new q_);t.name=IM[e],this._channels[e]=t}}channels(){return this._channels}[GI](){return new OM(dM(this._channels[0].curve),dM(this._channels[1].curve),dM(this._channels[2].curve),dM(this._channels[3].curve))}}).prototype,"_channels",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),AM=PM))||AM;class OM{constructor(e,t,i,n){this._result=new Di,this._x=e,this._y=t,this._z=i,this._w=n}evaluate(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Di.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result}}var DM,NM,LM;const BM=["Width","Height"];let zM=Wc("cc.animation.SizeTrack")((LM=Oc((NM=class extends cM{constructor(){super(),Mc(this,"_channels",LM,this),this._channels=new Array(2);for(let e=0;e<this._channels.length;++e){const t=new lM(new q_);t.name=BM[e],this._channels[e]=t}}channels(){return this._channels}[GI](){return new FM(dM(this._channels[0].curve),dM(this._channels[1].curve))}}).prototype,"_channels",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),DM=NM))||DM;class FM{constructor(e,t){this._result=new hn,this._width=e,this._height=t}evaluate(e,t){if((!this._width||!this._height)&&t.getValue){const e=t.getValue();this._result.x=e.x,this._result.y=e.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result}}var UM;let GM=Wc("cc.animation.ObjectTrack")(UM=class extends hM{createCurve(){return new kp}})||UM;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:gI,MorphWeightValueProxy:wI,MorphWeightsValueProxy:AI,MorphWeightsAllValueProxy:PI,Track:cM,TrackPath:rM,RealTrack:pM,VectorTrack:xM,QuatTrack:CM,ColorTrack:MM,SizeTrack:zM,ObjectTrack:GM,isPropertyPath:lI,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:hI,ComponentPath:uI,CubicSplineVec2Value:LI,CubicSplineVec3Value:BI,CubicSplineVec4Value:zI,CubicSplineQuatValue:FI,CubicSplineNumberValue:UI}));const kM=Symbol("BakeNodeCurves");class HM{static getOrExtract(e){let t=HM.pool.get(e);if(!t||t.samples!==e.sample){t&&n.director.root.dataPoolManager.releaseAnimationClip(e);const i=Math.ceil(e.sample*e.duration)+1,s=e.sample;t=e[kM](0,s,i),HM.pool.set(e,t)}return t}static destroy(e){HM.pool.delete(e)}}e("SkelAnimDataHub",HM),HM.pool=new Map;class VM{constructor(e){let t,i;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;let n=!0;for(let s=1,o=e.length;s<o;s++)if(t=e[s]-e[s-1],1===s)i=t;else if(Math.abs(t-i)>1e-6){n=!1;break}this._findRatio=n?XM:Bc}sample(e){return this._findRatio(this.ratios,e)}}e("RatioSampler",VM),n.RatioSampler=VM;class jM{static Bezier(e){return e}constructor(e,t){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=t,this._values=e.values;const i=e=>"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?jM.Linear:jM.Bezier(e):jM.Linear;if(void 0!==e.easingMethod)this.type=i(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(i);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(const t of Object.keys(e.easingMethods))this.types[t]=i(e.easingMethods[t])}else this.type=null;const n=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=YM(n)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}hasLerp(){return!!this._lerp}valueAt(e){if(void 0===this._array){const t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(let t=0;t<this._array.length;++t)this._array[t]=this._values[this._array.length*e+t];return this._array}valueBetween(e,t,i,n,s){if(this._lerp){const o=this.types?this.types[t]:this.type,r=s-i;let a=(e-i)/r;if(o&&(a=qM(a,o)),void 0===this._array){const e=this._values[t],i=this._values[n];return this._lerp(e,i,a,r*this._duration)}for(let e=0;e<this._array.length;++e){const i=this._values[this._array.length*t+e],s=this._values[this._array.length*n+e];this._array[e]=this._lerp(i,s,a,r*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(let e=0;e<this._array.length;++e)this._array[e]=this._values[this._array.length*t+e];return this._array}empty(){return 0===this._values.length}constant(){return 1===this._values.length}}function WM(e,t,i){let n=t.sample(i);if(n<0)if(n=~n,n<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function qM(e,t){if("string"==typeof t){const i=D_[t];i?e=i(e):C(3906,t)}else Array.isArray(t)&&(e=gp(t,e));return e}function XM(e,t){const i=e.length-1;if(0===i)return 0;const n=e[0];if(t<n)return 0;const s=e[i];if(t>s)return i;const o=(t=(t-n)/(s-n))/(1/i),r=0|o,a=1e-6;return o-r<a?r:r+1-o<a?r+1:~(r+1)}e("AnimCurve",jM),jM.Linear=null,n.AnimCurve=jM,e("EventInfo",class{constructor(){this.events=[]}add(e,t){this.events.push({func:e||"",params:t||[]})}}),n.sampleAnimationCurve=WM;const YM=(()=>{function e(e,t,i,n){return e.lerp(t,i,n)}return t=>{if(null!==t){if("number"==typeof t)return mi;if("object"==typeof t&&t.constructor){if(t instanceof ji)return function(){const e=new ji;return(t,i,n)=>ji.slerp(e,t,i,n)}();if(t instanceof Ue)return function(e){const t=new e;return(i,n,s)=>(e.lerp(t,i,n,s),t)}(t.constructor);if(t.constructor===Number)return mi;if("function"==typeof t.lerp)return e}}}})();var KM,$M,QM,ZM,JM,eO;let tO=Wc("cc.animation.UntypedTrackChannel")((QM=Oc(($M=class extends lM{constructor(){super(new q_),Mc(this,"property",QM,this)}}).prototype,"property",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),KM=$M))||KM,iO=Wc("cc.animation.UntypedTrack")((eO=Oc((JM=class extends cM{constructor(...e){super(...e),Mc(this,"_channels",eO,this)}channels(){return this._channels}[GI](e){if(!e.getValue)throw new Error(R(3930));const t=e=>{var t;return null===(t=this._channels.find((t=>t.property===e)))||void 0===t?void 0:t.curve},i=e.getValue();switch(!0){default:throw new Error(R(3931));case i instanceof nn:return new SM(t("x"),t("y"));case i instanceof zi:return new bM(t("x"),t("y"),t("z"));case i instanceof an:return new TM(t("x"),t("y"),t("z"),t("w"));case i instanceof Di:return new OM(t("r"),t("g"),t("b"),t("a"));case i instanceof hn:return new FM(t("width"),t("height"))}}addChannel(e){const t=new tO;return t.property=e,this._channels.push(t),t}upgrade(e){const t=(e,t)=>{const i=this.channels().find((t=>t.property===e));i&&(t.name=i.name,t.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":{const e=new xM;e.path=this.path,e.proxy=this.proxy,e.componentsCount="vec2"===i?2:"vec3"===i?3:4;const[n,s,o,r]=e.channels();switch(i){case"vec4":t("w",r);case"vec3":t("z",o);default:case"vec2":t("x",n),t("y",s)}return e}case"color":{const e=new MM,[i,n,s,o]=e.channels();return t("r",i),t("g",n),t("b",s),t("a",o),t("x",i),t("y",n),t("z",s),t("w",o),e}case"size":}return null}}).prototype,"_channels",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZM=JM))||ZM;class nO{constructor(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}get keys(){return this._keys}set keys(e){this._keys=e}get curves(){return this._curves}set curves(e){this._curves=e,delete this._runtimeCurves}get commonTargets(){return this._commonTargets}set commonTargets(e){this._commonTargets=e}get data(){return this._data}getPropertyCurves(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}toTracks(){const e=[],{keys:t,curves:i,commonTargets:n}=this,s=(e,t,i)=>{const n=new rM;for(const e of t)"string"==typeof e?n.toProperty(e):"number"==typeof e?n.toElement(e):e instanceof hI?n.toHierarchy(e.path):e instanceof uI?n.toComponent(e.component):n.toCustomized(e);e.path=n,e.proxy=i},o=n.map((t=>{const i=new iO;return s(i,t.modifiers,t.valueAdapter),e.push(i),i}));for(const n of i){var r;const i=n.data,a=i.values;if(0===a.length)continue;const c=i.keys<0?[0]:t[i.keys],l=a[0],h=null===(r=i.interpolate)||void 0===r||r;i._arrayLength;const u=new oO(i,c.length),_=e=>{s(e,n.modifiers,n.valueAdapter)};let p;if("number"==typeof n.commonTarget){if(!a.every((e=>"number"==typeof e))){T(3932);continue}if(n.valueAdapter||1!==n.modifiers.length||"string"!=typeof n.modifiers[0]){T(3933);continue}const e=n.modifiers[0],t=o[n.commonTarget],{curve:i}=t.addChannel(e);p=i}(()=>{if("number"==typeof l){if(!a.every((e=>"number"==typeof e)))return void T(3934);let t;if(p)t=p;else{const i=new pM;_(i),e.push(i),t=i.channel.curve}const i=h?Nl.LINEAR:Nl.CONSTANT;return t.assignSorted(c,a.map((e=>({value:e,interpolationMode:i})))),void u.convert(t)}if("object"==typeof l)switch(!0){default:break;case sO(a,nn):case sO(a,zi):case sO(a,an):{const t=l instanceof nn?2:l instanceof zi?3:4,i=new xM;_(i),i.componentsCount=t;const[{curve:n},{curve:s},{curve:o},{curve:r}]=i.channels(),p=h?Nl.LINEAR:Nl.CONSTANT,d=e=>({value:e,interpolationMode:p});switch(t){case 4:r.assignSorted(c,a.map((e=>d(e.w)))),u.convert(r);case 3:o.assignSorted(c,a.map((e=>d(e.z)))),u.convert(o);default:n.assignSorted(c,a.map((e=>d(e.x)))),u.convert(n),s.assignSorted(c,a.map((e=>d(e.y)))),u.convert(s)}return void e.push(i)}case sO(a,ji):{const t=new CM;_(t);const i=h?Ap.SLERP:Ap.CONSTANT;return t.channel.curve.assignSorted(c,a.map((e=>({value:ji.clone(e),interpolationMode:i})))),u.convertQuatCurve(t.channel.curve),void e.push(t)}case sO(a,Di):{const t=new MM;_(t);const[{curve:i},{curve:n},{curve:s},{curve:o}]=t.channels(),r=h?Nl.LINEAR:Nl.CONSTANT,l=e=>({value:e,interpolationMode:r});return i.assignSorted(c,a.map((e=>l(e.r)))),u.convert(i),n.assignSorted(c,a.map((e=>l(e.g)))),u.convert(n),s.assignSorted(c,a.map((e=>l(e.b)))),u.convert(s),o.assignSorted(c,a.map((e=>l(e.a)))),u.convert(o),void e.push(t)}case sO(a,hn):{const t=new zM;_(t);const[{curve:i},{curve:n}]=t.channels(),s=h?Nl.LINEAR:Nl.CONSTANT,o=e=>({value:e,interpolationMode:s});return i.assignSorted(c,a.map((e=>o(e.width)))),u.convert(i),n.assignSorted(c,a.map((e=>o(e.height)))),u.convert(n),void e.push(t)}case sO(a,UI):{const t=new pM;_(t);const i=h?Nl.CUBIC:Nl.CONSTANT;return t.channel.curve.assignSorted(c,a.map((e=>({value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:i})))),void e.push(t)}case sO(a,LI):case sO(a,BI):case sO(a,zI):{const t=l instanceof LI?2:l instanceof BI?3:4,i=new xM;_(i),i.componentsCount=t;const[n,s,o,r]=i.channels(),u=h?Nl.LINEAR:Nl.CONSTANT,p=(e,t,i)=>({value:e,leftTangent:t,rightTangent:i,interpolationMode:u});switch(t){case 4:r.curve.assignSorted(c,a.map((e=>p(e.dataPoint.w,e.inTangent.w,e.outTangent.w))));case 3:o.curve.assignSorted(c,a.map((e=>p(e.dataPoint.z,e.inTangent.z,e.outTangent.z))));default:n.curve.assignSorted(c,a.map((e=>p(e.dataPoint.y,e.inTangent.y,e.outTangent.y)))),s.curve.assignSorted(c,a.map((e=>p(e.dataPoint.x,e.inTangent.x,e.outTangent.x))))}return void e.push(i)}case a.every((e=>e instanceof FI)):T(3935)}const t=new GM;_(t),t.channel.curve.assignSorted(c,a),e.push(t)})()}return e}_createPropertyCurves(){this._ratioSamplers=this._keys.map((e=>new VM(e.map((e=>e/this._duration))))),this._runtimeCurves=this._curves.map((e=>({curve:new jM(e.data,this._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:this._ratioSamplers[e.data.keys],commonTarget:e.commonTarget})))}}function sO(e,t){return e.every((e=>e instanceof t))}class oO{constructor(e,t){this._easingMethods=void 0;const{easingMethods:i}=e;Array.isArray(i)?0===i.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=i:this._easingMethods=void 0===i?new Array(t).fill(e.easingMethod):Array.from({length:t},((e,t)=>{var n;return null!==(n=i[t])&&void 0!==n?n:null}))}get nil(){return!this._easingMethods||this._easingMethods.every((e=>null==e))}convert(e){const{_easingMethods:t}=this;if(!t)return;const i=e.keyFramesCount;if(e.keyFramesCount<2)return;Array.isArray(t)&&t.length;const n=i-1;for(let i=0;i<n;++i){const n=t[i];n&&(Array.isArray(n)?lO(n,e.getKeyframeTime(i),e.getKeyframeValue(i),e.getKeyframeTime(i+1),e.getKeyframeValue(i+1)):rO(n,e,i))}}convertQuatCurve(e){const{_easingMethods:t}=this;if(!t)return;const i=e.keyFramesCount;if(e.keyFramesCount<2)return;Array.isArray(t)&&t.length;const n=i-1;for(let i=0;i<n;++i){const n=t[i];n&&(Array.isArray(n)?e.getKeyframeValue(i).easingMethod=n.slice():aO(n,e,i))}}}function rO(e,t,i){t.keyFramesCount;const n=t.getKeyframeValue(i),s=cO[e];s===N_.CONSTANT?n.interpolationMode=Nl.CONSTANT:(n.interpolationMode=Nl.LINEAR,n.easingMethod=s)}function aO(e,t,i){t.keyFramesCount;const n=t.getKeyframeValue(i),s=cO[e];n.easingMethod=s}const cO={constant:N_.CONSTANT,linear:N_.LINEAR,quadIn:N_.QUAD_IN,quadOut:N_.QUAD_OUT,quadInOut:N_.QUAD_IN_OUT,quadOutIn:N_.QUAD_OUT_IN,cubicIn:N_.CUBIC_IN,cubicOut:N_.CUBIC_OUT,cubicInOut:N_.CUBIC_IN_OUT,cubicOutIn:N_.CUBIC_OUT_IN,quartIn:N_.QUART_IN,quartOut:N_.QUART_OUT,quartInOut:N_.QUART_IN_OUT,quartOutIn:N_.QUART_OUT_IN,quintIn:N_.QUINT_IN,quintOut:N_.QUINT_OUT,quintInOut:N_.QUINT_IN_OUT,quintOutIn:N_.QUINT_OUT_IN,sineIn:N_.SINE_IN,sineOut:N_.SINE_OUT,sineInOut:N_.SINE_IN_OUT,sineOutIn:N_.SINE_OUT_IN,expoIn:N_.EXPO_IN,expoOut:N_.EXPO_OUT,expoInOut:N_.EXPO_IN_OUT,expoOutIn:N_.EXPO_OUT_IN,circIn:N_.CIRC_IN,circOut:N_.CIRC_OUT,circInOut:N_.CIRC_IN_OUT,circOutIn:N_.CIRC_OUT_IN,elasticIn:N_.ELASTIC_IN,elasticOut:N_.ELASTIC_OUT,elasticInOut:N_.ELASTIC_IN_OUT,elasticOutIn:N_.ELASTIC_OUT_IN,backIn:N_.BACK_IN,backOut:N_.BACK_OUT,backInOut:N_.BACK_IN_OUT,backOutIn:N_.BACK_OUT_IN,bounceIn:N_.BOUNCE_IN,bounceOut:N_.BOUNCE_OUT,bounceInOut:N_.BOUNCE_IN_OUT,bounceOutIn:N_.BOUNCE_OUT_IN,smooth:N_.SMOOTH,fade:N_.FADE};function lO(e,t,i,n,s){const[o,r,a,c]=e,{value:l}=i,{value:h}=s,u=3*(n-t),_=3*(h-l),p=o*u,d=r*_,f=(1-a)*u,m=(1-c)*_,g=1/3,v=d/p,y=Math.sqrt(p*p+d*d)*g,x=m/f,S=Math.sqrt(f*f+m*m)*g;var b;i.interpolationMode=Nl.CUBIC,i.tangentWeightMode=(b=i.tangentWeightMode)===Bl.NONE?Bl.RIGHT:b===Bl.LEFT?Bl.BOTH:b,i.rightTangent=v,i.rightTangentWeight=y,s.tangentWeightMode=function(e){return e===Bl.NONE?Bl.LEFT:e===Bl.RIGHT?Bl.BOTH:e}(s.tangentWeightMode),s.leftTangent=x,s.leftTangentWeight=S}var hO,uO,_O,pO,dO,fO,mO,gO,vO,yO,xO,SO,bO,TO,EO,CO,wO,AO,PO,RO,IO,MO,OO,DO;function NO(){throw new Error("split() only valid in Editor.")}Wc("cc.animation.ExoticAnimation")((uO=Oc((hO=class{constructor(){Mc(this,"_nodeAnimations",uO,this)}createEvaluator(e){return new HO(this._nodeAnimations,e)}addNodeAnimation(e){const t=new LO(e);return this._nodeAnimations.push(t),t}collectAnimatedJoints(){return Array.from(new Set(this._nodeAnimations.map((({path:e})=>e))))}split(e,t){return NO()}toHashString(){return this._nodeAnimations.map((e=>e.toHashString())).join("\n")}}).prototype,"_nodeAnimations",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hO));let LO=Wc("cc.animation.ExoticNodeAnimation")((dO=Oc((pO=class{constructor(e){Mc(this,"_path",dO,this),Mc(this,"_position",fO,this),Mc(this,"_rotation",mO,this),Mc(this,"_scale",gO,this),this._path=e}createPosition(e,t){this._position=new kO(e,new UO(t))}createRotation(e,t){this._rotation=new kO(e,new GO(t))}createScale(e,t){this._scale=new kO(e,new UO(t))}createEvaluator(e){return new VO(this._path,this._position,this._rotation,this._scale,e)}split(e,t,i){return NO()}get path(){return this._path}toHashString(){var e,t,i,n,s,o;return`${this._path}\n${null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:""}${null!==(i=null===(n=this._scale)||void 0===n?void 0:n.toHashString())&&void 0!==i?i:""}${null!==(s=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==s?s:""}`}}).prototype,"_path",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fO=Oc(pO.prototype,"_position",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mO=Oc(pO.prototype,"_rotation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gO=Oc(pO.prototype,"_scale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_O=pO))||_O;function BO(e){return e.toPrecision(2)}function zO(e){return e.map(BO).join(" ")}let FO=Wc("cc.animation.ExoticVectorLikeTrackValues")((xO=Oc((yO=class{constructor(e){Mc(this,"_values",xO,this),Mc(this,"_isQuantized",SO,this),this._values=e,this._isQuantized=!1}get precision(){return this._isQuantized?this._values.originalPrecision:XO(this._values)}quantize(e){this._isQuantized,this._values=function(e,t){const i=WO[t],n=1<<i.BYTES_PER_ELEMENT;let s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((e=>{s=Math.min(e,s),o=Math.max(e,o)}));const r=o-s,a=i.from(e,(e=>(e-s)/r*n));return new YO(XO(e),a,r,s)}(this._values,e),this._isQuantized=!0}toHashString(){const{_isQuantized:e,_values:t}=this;return`${e} ${e?t.toHashString():zO(t)}`}}).prototype,"_values",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),SO=Oc(yO.prototype,"_isQuantized",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),vO=yO))||vO,UO=Wc("cc.animation.ExoticVec3TrackValues")(bO=class e extends FO{static imitate(t,i){const n=new e(t);return i._isQuantized&&n.quantize(i._values.quantizationType),n}get(e,t){const{_values:i,_isQuantized:n}=this;n?QO(i,e,t):zi.fromArray(t,i,3*e)}lerp(e,t,i,n,s,o){const{_values:r,_isQuantized:a}=this;a?(QO(r,e,n),QO(r,t,s)):(zi.fromArray(n,r,3*e),zi.fromArray(s,r,3*t)),zi.lerp(o,n,s,i)}})||bO,GO=Wc("cc.animation.ExoticQuatTrackValues")(TO=class e extends FO{static imitate(t,i){const n=new e(t);return i._isQuantized&&n.quantize(i._values.quantizationType),n}get(e,t){const{_values:i,_isQuantized:n}=this;n?ZO(i,e,t):ji.fromArray(t,i,4*e)}lerp(e,t,i,n,s,o){const{_values:r,_isQuantized:a}=this;a?(ZO(r,e,n),ZO(r,t,s)):(ji.fromArray(n,r,4*e),ji.fromArray(s,r,4*t)),ji.slerp(o,n,s,i)}})||TO,kO=Wc("cc.animation.ExoticTrack")((wO=Oc((CO=class{constructor(e,t){Mc(this,"times",wO,this),Mc(this,"values",AO,this),this.times=e,this.values=t}toHashString(){const{times:e,values:t}=this;return`times: ${zO(e)}; values: ${t.toHashString()}`}}).prototype,"times",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),AO=Oc(CO.prototype,"values",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),EO=CO))||EO;class HO{constructor(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((e=>e.createEvaluator(t)))}evaluate(e){this._nodeEvaluations.forEach((t=>{t.evaluate(e)}))}}class VO{constructor(e,t,i,n,s){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=$O(t.times,t.values,zi,e,"position",s)),i&&(this._rotation=$O(i.times,i.values,ji,e,"rotation",s)),n&&(this._scale=$O(n.times,n.values,zi,e,"scale",s))}evaluate(e){if(this._position){const t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){const t=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(t)}if(this._scale){const t=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(t)}}}class jO{constructor(e,t,i){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new i,this._nextValue=new i,this._resultValue=new i}evaluate(e){const{_times:t,_values:i,_resultValue:n}=this;if(0===t.length)return n;const s=function(e,t,i){const n=e.length,s=e[0],o=e[n-1];if(t<s)i.just=!0,i.index=0;else if(t>o)i.just=!0,i.index=n-1;else{const n=Bc(e,t);if(n>=0)i.just=!0,i.index=n;else{const s=~n,o=s-1,r=e[o],a=e[s],c=(t-e[o])/(a-r);i.just=!1,i.index=o,i.nextIndex=s,i.ratio=c}}return i}(t,e,this._inputSampleResultCache);return s.just?i.get(s.index,n):i.lerp(s.index,s.nextIndex,s.ratio,this._prevValue,this._nextValue,n),n}}const WO={uint8:Uint8Array,uint16:Uint16Array};var qO;function XO(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return qO.FLOAT_32;case 8:return qO.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(qO||(qO={}));let YO=Wc("cc.animation.QuantizedFloatArray")((IO=Oc((RO=class{get quantizationType(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}constructor(e,t,i,n=0){Mc(this,"originalPrecision",IO,this),Mc(this,"min",MO,this),Mc(this,"extent",OO,this),Mc(this,"values",DO,this),this.originalPrecision=e,this.values=t,this.extent=i,this.min=n}toHashString(){const{originalPrecision:e,min:t,extent:i,values:n}=this;return`${e} ${BO(t)} ${BO(i)} ${n.join(" ")}`}}).prototype,"originalPrecision",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),MO=Oc(RO.prototype,"min",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),OO=Oc(RO.prototype,"extent",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),DO=Oc(RO.prototype,"values",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),PO=RO))||PO;function KO(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function $O(e,t,i,n,s,o){const r=new aM;r.path=(new rM).toHierarchy(n).toProperty(s);const a=o(r);return a?{runtimeBinding:a,evaluator:new jO(e,t,i)}:null}function QO(e,t,i){zi.set(i,KO(e,3*t+0),KO(e,3*t+1),KO(e,3*t+2))}function ZO(e,t,i){ji.set(i,KO(e,4*t+0),KO(e,4*t+1),KO(e,4*t+2),KO(e,4*t+3))}var JO,eD,tD,iD,nD,sD,oD,rD,aD,cD,lD,hD,uD;const _D=Symbol("SearchForRootBonePath"),pD=Symbol("ExoticAnimation");let dD=e("AnimationClip",Wc("cc.AnimationClip")((uD=hD=class e extends xh{constructor(...e){super(...e),Mc(this,"sample",tD,this),Mc(this,"speed",iD,this),Mc(this,"wrapMode",nD,this),Mc(this,"enableTrsBlending",sD,this),Mc(this,"_duration",oD,this),Mc(this,"_hash",rD,this),this.frameRate=0,Mc(this,"_tracks",aD,this),Mc(this,"_exoticAnimation",cD,this),this._legacyData=void 0,this._legacyDataDirty=!1,Mc(this,"_events",lD,this),this._runtimeEvents={ratios:[],eventGroups:[]}}static createWithSpriteFrames(t,i){const n=new e;n.sample=i||n.sample,n.duration=t.length/n.sample;const s=1/n.sample,o=new GM;return o.path=(new rM).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(t.map(((e,t)=>[s*t,e]))),n.addTrack(o),n}get duration(){return this._duration}set duration(e){this._duration=e}get tracksCount(){return this._tracks.length}get tracks(){return this._tracks}get hash(){var e,t;if(this._hash)return this._hash;const i=`Exotic:${null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:""}`;return this._hash=Vr(i,666)}get events(){return this._events}set events(e){this._events=e;const t=[],i=[],n=this.events.sort(((e,t)=>e.frame-t.frame)),s=n.length;for(let e=0;e<s;++e){const s=n[e],o=s.frame/this._duration;let r=t.findIndex((e=>e===o));r<0&&(r=t.length,t.push(o),i.push({events:[]})),i[r].events.push({functionName:s.func,parameters:s.params})}this._runtimeEvents={ratios:t,eventGroups:i}}get[pD](){return this._exoticAnimation}set[pD](e){this._exoticAnimation=e}onLoaded(){this.frameRate=this.sample,this.events=this._events}range(){const e={min:1/0,max:-1/0},{_tracks:t}=this,i=t.length;for(let n=0;n<i;++n){const i=t[n].range();e.min=Math.min(e.min,i.min),e.max=Math.max(e.max,i.max)}return e}getTrack(e){return this._tracks[e]}addTrack(e){const t=this._tracks.length;return this._tracks.push(e),t}removeTrack(e){this._tracks.splice(e,1)}clearTracks(){this._tracks.length=0}createEventEvaluator(e){return new bD(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)}createEvaluator(e){const{target:t}=e;return this._createEvalWithBinder(t,(i=>{const n=i.createRuntimeBinding(t,this.enableTrsBlending?e.pose:void 0,!1);return null!=n?n:void 0}),e.rootMotion)}destroy(){var e;return(null===(e=n.director.root)||void 0===e?void 0:e.dataPoolManager)&&n.director.root.dataPoolManager.releaseAnimationClip(this),HM.destroy(this),super.destroy()}[kM](e,t,i){const n=1/t,s=this._collectAnimatedJoints(),o=s.length,r={};for(let e=0;e<o;++e)r[s[e]]={transforms:Array.from({length:i},(()=>new Zi))};const a=s.reduce(((e,t)=>(e[t]=new gD,e)),{});for(const e in a){const t=a[e],i=e.lastIndexOf("/");if(i>=0){const n=e.substring(0,i),s=a[n];s&&(t.parent=s)}}const c=this._createEvalWithBinder(void 0,(e=>{const t=e.parseTrsPath();if(!t)return;const i=a[t.node];return i?SD(i,t.property):void 0}),void 0);for(let t=0;t<i;++t){const i=e+n*t;c.evaluate(i);for(let e=0;e<o;++e){const i=s[e];Zi.copy(r[i].transforms[t],a[i].globalTransform)}for(let e=0;e<o;++e){const t=s[e];a[t].invalidate()}}return{samples:t,frames:i,joints:r}}upgradeUntypedTracks(e){const t=[],i=[],{_tracks:n}=this,s=n.length;for(let o=0;o<s;++o){const s=n[o];if(!(s instanceof iO))continue;const r=s.upgrade(e);r&&(t.push(r),i.push(s))}const o=i.length;for(let e=0;e<o;++e)Oe.remove(n,i[e]);n.push(...t)}[_D](){return this._searchForRootBonePath()}get keys(){return this._getLegacyData().keys}set keys(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}get curves(){return this._legacyDataDirty=!0,this._getLegacyData().curves}set curves(e){this._getLegacyData().curves=e}get commonTargets(){return this._getLegacyData().commonTargets}set commonTargets(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}get data(){return this._getLegacyData().data}getPropertyCurves(){return this._getLegacyData().getPropertyCurves()}get eventGroups(){return this._runtimeEvents.eventGroups}updateEventDatas(){this.events=this._events}hasEvents(){return 0!==this.events.length}syncLegacyData(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)}_createEvalWithBinder(e,t,i){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());const n=[];let s;i&&(s=this._createRootMotionEvaluation(e,i,n));const o=[];let r;const{_tracks:a}=this,c=a.length;for(let e=0;e<c;++e){const i=a[e];if(n.includes(i))continue;const s=t(i[oM]);if(!s)continue;const r=i[GI](s);o.push({binding:s,trackEval:r})}return this._exoticAnimation&&(r=this._exoticAnimation.createEvaluator(t)),new fD(o,r,s)}_createRootMotionEvaluation(e,t,i){if(!(e instanceof ix))return void C(3920);const n=this._searchForRootBonePath();if(!n)return void T(3923);const s=e.getChildByPath(n);if(!s)return void T(3924);const o=new mD,r=[],{_tracks:a}=this,c=a.length;for(let e=0;e<c;++e){const t=a[e],{[oM]:s}=t,c=s.parseTrsPath();if(!c)continue;if(c.node!==n)continue;i.push(t);const l=SD(o,c.property);if(!l)continue;const h=t[GI](l);r.push({binding:l,trackEval:h})}return new yD(s,this._duration,o,r)}_searchForRootBonePath(){const e=this._tracks.map((e=>{const t=e[oM].parseTrsPath();if(t){const e=t.node;return{path:e,rank:e.split("/").length}}return{path:"",rank:0}}));e.sort(((e,t)=>e.rank-t.rank));const t=e.findIndex((e=>0!==e.rank));if(t<0)return"";const i=e.length,n=e[t];let s=!0;for(let o=t+1;o<i;++o){const t=e[o];if(t.rank!==n.rank)break;if(t.path!==n.path){s=!1;break}}return s?n.path:""}_getLegacyData(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData}_toLegacy(){const e=new nO(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e}_fromLegacy(e){const t=e.toTracks(),i=t.length;for(let e=0;e<i;++e)this.addTrack(t[e])}_collectAnimatedJoints(){const e=new Set,{_tracks:t}=this,i=t.length;for(let n=0;n<i;++n){const i=t[n][oM].parseTrsPath();i&&e.add(i.node)}if(this._exoticAnimation){const t=this._exoticAnimation.collectAnimatedJoints(),i=t.length;for(let n=0;n<i;++n)e.add(t[n])}return Array.from(e)}},hD.WrapMode=Nc,tD=Oc((eD=uD).prototype,"sample",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),iD=Oc(eD.prototype,"speed",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nD=Oc(eD.prototype,"wrapMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nc.Normal}}),sD=Oc(eD.prototype,"enableTrsBlending",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oD=Oc(eD.prototype,"_duration",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rD=Oc(eD.prototype,"_hash",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aD=Oc(eD.prototype,"_tracks",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cD=Oc(eD.prototype,"_exoticAnimation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lD=Oc(eD.prototype,"_events",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JO=eD))||JO);n.AnimationClip=dD;class fD{constructor(e,t,i){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=i}evaluate(e){const{_trackEvalStatues:t,_exoticAnimationEvaluator:i}=this,n=t.length;for(let i=0;i<n;++i){const{trackEval:n,binding:s}=t[i],o=n.evaluate(e,s);s.setValue(o)}i&&i.evaluate(e)}evaluateRootMotion(e,t){const{_rootMotionEvaluation:i}=this;i&&i.evaluate(e,t)}}class mD{constructor(){this.position=new zi,this.scale=new zi(1,1,1),this.rotation=new ji,this.eulerAngles=new zi}getTransform(e){Zi.fromRTS(e,this.rotation,this.position,this.scale)}}class gD extends mD{constructor(...e){super(...e),this.parent=null,this._dirty=!0,this._transform=new Zi}get globalTransform(){const e=this._transform;return this._dirty&&(this._dirty=!1,Zi.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&Zi.multiply(e,this.parent.globalTransform,e)),this._transform}invalidate(){this._dirty=!0}}const vD=new Zi;class yD{constructor(e,t,i,n){this._initialTransformCache=new Zi,this._clipEndTransformCache=new Zi,this._startTransformCache=new Zi,this._endTransformCache=new Zi,this._motionTransformCache=new Zi,this._translationMotionCache=new zi,this._rotationMotionCache=new ji,this._scaleMotionCache=new zi,this._rootBone=e,this._duration=t,this._boneTransform=i,this._trackEvalStatuses=n}evaluate(e,t){const i=this._calcMotionTransform(e,t,this._motionTransformCache),{_translationMotionCache:n,_rotationMotionCache:s,_scaleMotionCache:o,_rootBone:r}=this;Zi.toRTS(i,s,n,o),zi.add(n,n,r.position),r.setPosition(n),ji.multiply(s,s,r.rotation),r.setRotation(s),zi.multiply(o,o,r.scale),r.setScale(o)}_calcMotionTransform(e,t,i){const{_duration:n}=this,s=n-e,o=this._evaluateAt(e,this._startTransformCache);if(t<s){const n=this._evaluateAt(e+t,this._endTransformCache);xD(i,o,n)}else{Zi.identity(i);const e=(e,t)=>{xD(vD,e,t),Zi.multiply(i,i,vD)},r=t-s,a=Math.floor(r/n),c=r-a*n,l=this._evaluateAt(0,this._initialTransformCache),h=this._evaluateAt(n,this._clipEndTransformCache),u=this._evaluateAt(c,this._endTransformCache);e(o,h),xD(vD,l,h);for(let e=0;e<a;++e)Zi.multiply(i,i,vD);e(l,u)}return i}_evaluateAt(e,t){const{_trackEvalStatuses:i}=this,n=i.length;for(let t=0;t<n;++t){const{trackEval:n,binding:s}=i[t],o=n.evaluate(e,s);s.setValue(o)}return this._boneTransform.getTransform(t),t}}function xD(e,t,i){Zi.invert(e,t),Zi.multiply(e,i,e)}function SD(e,t){switch(t){default:return;case"position":return{setValue(t){zi.copy(e.position,t)}};case"rotation":return{setValue(t){ji.copy(e.rotation,t)}};case"scale":return{setValue(t){zi.copy(e.scale,t)}};case"eulerAngles":return{setValue(t){zi.copy(e.eulerAngles,t)}}}}class bD{constructor(e,t,i,n){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=i,this._wrapMode=n}setWrapMode(e){this._wrapMode=e}ignore(e,t){this._ignoreIndex=-1,this._sampled=!1;let i=ED(e,this._ratios);i<0&&(i=~i-1,t<0&&(i+=1),this._ignoreIndex=i)}sample(e,t,i){const n=this._eventGroups.length;let s=ED(e,this._ratios);if(s<0&&(s=~s-1,t<0&&(s+=1)),this._ignoreIndex!==s&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(s,!1),this._lastFrameIndex=s,this._lastIterations=i,void(this._lastDirection=t);const o=this._wrapMode,r=TD(i);let a=TD(this._lastIterations),c=this._lastFrameIndex;const l=this._lastDirection,h=-1!==a&&r!==a;if(c===s&&h&&1===n)this._doFire(0,!1);else if(c!==s||h){t=l;do{if(c!==s){if(-1===t&&0===c&&s>0?((o&Dc.PingPong)===Dc.PingPong?t*=-1:c=n,a++):1===t&&c===n-1&&s<n-1&&((o&Dc.PingPong)===Dc.PingPong?t*=-1:c=-1,a++),c===s)break;if(a>r)break}c+=t,this._doFire(c,!0)}while(c!==s&&c>-1&&c<n)}this._lastFrameIndex=s,this._lastIterations=i,this._lastDirection=t}_doFire(e,t){t?n.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)}_checkAndFire(e){if(!this._targetNode||!this._targetNode.isValid)return;const{_eventGroups:t}=this;if(e<0||e>=t.length||this._ignoreIndex===e)return;const i=t[e],n=this._targetNode.components,s=i.events.length;for(let e=0;e<s;++e){const t=i.events[e],{functionName:s}=t,o=n.length;for(let e=0;e<o;++e){const i=n[e],o=i[s];"function"==typeof o&&o.apply(i,t.parameters)}}}}function TD(e){return e-(0|e)==0&&(e-=1),0|e}function ED(e,t){return Bc(t,e)}class CD{constructor(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isMotionless(){return!this.isPlaying||this.isPaused}play(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(R(3912)):(this._isPlaying=!0,this.onPlay())}stop(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}pause(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}resume(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}step(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}update(e){}onPlay(){}onPause(){}onResume(){}onStop(){}onError(e){}}class wD{constructor(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}destroy(){for(let e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0}createPoseWriter(e,t,i){const n=this._pose.createWriter(e,t,this,i);return this._blendStateWriters.push(n),n}}let AD;!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(AD||(AD={})),Fe(AD);class PD extends CD{get clip(){return this._clip}get name(){return this._name}get length(){return this.duration}get wrapMode(){return this._wrapMode}set wrapMode(e){var t;this._wrapMode=e,this.time=0,e&Dc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}get repeatCount(){return this._repeatCount}set repeatCount(e){this._repeatCount=e;const t=this._wrapMode&Dc.ShouldWrap,i=(this.wrapMode&Dc.Reverse)===Dc.Reverse;this._useSimpleProcess=e===1/0&&!t&&!i}get delay(){return this._delay}set delay(e){this._delayTime=this._delay=e}get playbackRange(){return this._playbackRange}set playbackRange(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}get current(){return this.getWrappedInfo(this.time).time}get ratio(){return this.current/this.duration}get weight(){return this._weight}set weight(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}constructor(e,t=""){super(),this.duration=1,this.speed=1,this.time=0,this.frameRate=0,this._targetNode=null,this._curveLoaded=!1,this._clip=void 0,this._useSimpleProcess=!1,this._target=null,this._wrapMode=Nc.Normal,this._repeatCount=1,this._delay=0,this._delayTime=0,this._currentFramePlayed=!1,this._name=void 0,this._lastIterations=NaN,this._lastWrapInfo=null,this._wrappedInfo=new Lc,this._allowLastFrame=!1,this._blendStateWriterHost={weight:0},this._playbackDuration=0,this._invDuration=1,this._poseOutput=null,this._weight=0,this._clipEval=void 0,this._clipEventEval=void 0,this._doNotCreateEval=!1,this._clip=e,this._name=t||e&&e.name,this._playbackRange={min:0,max:e.duration},this._playbackDuration=e.duration,e.duration||m(`Clip ${e.name} has zero duration.`)}get curveLoaded(){return this._curveLoaded}initialize(e){if(this._curveLoaded)return;this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;const t=this._clip;if(this.duration=t.duration,this._invDuration=1/this.duration,this.speed=t.speed,this.wrapMode=t.wrapMode,this.frameRate=t.sample,this._playbackRange.min=0,this._playbackRange.max=t.duration,this._playbackDuration=t.duration,(this.wrapMode&Dc.Loop)===Dc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,s,o;const r=null!==(i=null===(s=n.director.getAnimationManager())||void 0===s?void 0:s.blendState)&&void 0!==i?i:null;r&&(this._poseOutput=new wD(r)),this._clipEval=t.createEvaluator({target:e,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=t.createEventEvaluator(this._targetNode)}destroy(){this.isMotionless||n.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0}emit(...e){n.director.getAnimationManager().pushDelayEvent(this._emit,this,e)}on(e,t,i){return this._target&&this._target.isValid?this._target.on(e,t,i):null}once(e,t,i){return this._target&&this._target.isValid?this._target.once(e,t,i):null}off(e,t,i){this._target&&this._target.isValid&&this._target.off(e,t,i)}allowLastFrameEvent(e){this._allowLastFrame=e}_setEventTarget(e){this._target=e}setTime(e){this._currentFramePlayed=!1,this.time=e||0;{var t;const i=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(i.ratio,i.direction)}}update(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}sample(){const e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e}onPlay(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(AD.PLAY,this)}onStop(){this.isPaused||this._onPauseOrStop(),this.emit(AD.STOP,this)}onResume(){this._onReplayOrResume(),this.emit(AD.RESUME,this)}onPause(){this._onPauseOrStop(),this.emit(AD.PAUSE,this)}_sampleCurves(e){const{_poseOutput:t,_clipEval:i}=this;t&&(t.weight=this.weight),i&&i.evaluate(e)}_process(){this._useSimpleProcess?this.simpleProcess():this.process()}process(){const e=this.sample();if(this._allowLastFrame){let t;t=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Lc(e),this.repeatCount>1&&(0|e.iterations)>(0|t.iterations)&&this.emit(AD.LASTFRAME,this),t.set(e)}e.stopped&&(this.stop(),this.emit(AD.FINISHED,this))}simpleProcess(){const e=this._playbackRange.min,t=this._playbackDuration;let i=this.time%t;i<0&&(i+=t);const n=(e+i)*this._invDuration;this._sampleCurves(e+i),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=n),(this.time>0&&this._lastIterations>n||this.time<0&&this._lastIterations<n)&&this.emit(AD.LASTFRAME,this),this._lastIterations=n)}_needReverse(e){const t=this.wrapMode;let i=!1;return(t&Dc.PingPong)===Dc.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(i=!i)),(t&Dc.Reverse)===Dc.Reverse&&(i=!i),i}getWrappedInfo(e,t){t=t||new Lc;const i=this._getPlaybackStart(),n=this._getPlaybackEnd()-i;let s=!1;const o=this.repeatCount;let r=(e-=i)>0?e/n:-e/n;if(r>=o){r=o,s=!0;let t=o-(0|o);0===t&&(t=1),e=t*n*(e>0?1:-1)}if(e>n){const t=e%n;e=0===t?n:t}else e<0&&0!=(e%=n)&&(e+=n);let a=!1;const c=this._wrapMode&Dc.ShouldWrap;c&&(a=this._needReverse(r));let l=a?-1:1;return this.speed<0&&(l*=-1),c&&a&&(e=n-e),t.time=i+e,t.ratio=t.time/this.duration,t.direction=l,t.stopped=s,t.iterations=r,t}_getPlaybackStart(){return this._playbackRange.min}_getPlaybackEnd(){return this._playbackRange.max}_sampleEvents(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)}_emit(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}_onReplayOrResume(){n.director.getAnimationManager().addAnimation(this)}_onPauseOrStop(){n.director.getAnimationManager().removeAnimation(this)}}e("AnimationState",PD),n.AnimationState=PD;class RD extends CD{constructor(e){super(),this._managedStates=[],this._fadings=[],this._scheduled=!1,this._scheduler=null!=e?e:n.director.getAnimationManager()}update(e){if(this.isMotionless)return;const t=this._managedStates,i=this._fadings;if(1===t.length&&1===i.length){const e=t[0].state;e&&(e.weight=1)}else this._calculateWeights(e);1===t.length&&1===i.length&&this._unscheduleThis()}crossFade(e,t){var i;0===this._managedStates.length&&(t=0),0===t&&this.clear();let n=this._managedStates.find((t=>t.state===e));n?(null===(i=n.state)||void 0===i?void 0:i.isMotionless)&&n.state.play():(n={state:e,reference:0},e&&e.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:n}),this.isMotionless||this._scheduleThis()}clear(){for(let e=0;e<this._managedStates.length;++e){const t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}onPlay(){super.onPlay(),this._scheduleThis()}onPause(){super.onPause();for(let e=0;e<this._managedStates.length;++e){const t=this._managedStates[e].state;t&&t.pause()}this._unscheduleThis()}onResume(){super.onResume();for(let e=0;e<this._managedStates.length;++e){const t=this._managedStates[e].state;t&&t.resume()}this._scheduleThis()}onStop(){super.onStop(),this.clear()}_calculateWeights(e){const t=this._managedStates,i=this._fadings;for(let e=0;e<t.length;++e){const i=t[e].state;i&&(i.weight=0)}let n=1,s=i.length;for(let t=0;t<i.length;++t){const o=i[t];o.easeTime+=e;const r=0===o.easeDuration?1:fi(o.easeTime/o.easeDuration),a=r*n;if(n*=1-r,o.target.state&&(o.target.state.weight+=a),o.easeTime>=o.easeDuration){s=t+1,o.easeTime=o.easeDuration;break}}if(s!==i.length){for(let e=s;e<i.length;++e){const t=i[e];--t.target.reference,t.target.reference<=0&&(t.target.state&&t.target.state.stop(),j(this._managedStates,t.target))}i.splice(s)}}_scheduleThis(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)}_unscheduleThis(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)}}var ID,MD,OD,DD,ND,LD,BD,zD,FD,UD,GD,kD,HD,VD,jD,WD,qD;let XD=function(t){return e({AnimationComponent:t,Animation:t}),t}((ID=Wc("cc.Animation"),MD=al(),OD=Xc(99),DD=nl(),ND=Al([dD]),LD=_l(),BD=Al(dD),zD=_l(),FD=_l(),UD=Al([dD]),ID(GD=MD(GD=OD(GD=il(GD=DD((qD=WD=class extends(Ht(Gh)){constructor(...e){super(...e),Mc(this,"playOnLoad",HD,this),this._crossFade=new RD,this._nameToState=se(!0),Mc(this,"_clips",VD,this),Mc(this,"_defaultClip",jD,this),this._hasBeenPlayed=!1}get clips(){return this._clips}set clips(e){this._crossFade&&this._crossFade.clear();for(const e of this._clips)e&&this._removeStateOfAutomaticClip(e);for(const t of e)t&&this.createState(t);const t=e.find((e=>YD(e,this._defaultClip)));this._defaultClip=t||null,this._clips=e}get defaultClip(){return this._defaultClip}set defaultClip(e){this._defaultClip=e,e&&(this._clips.findIndex((t=>YD(t,e)))>=0||(this._clips.push(e),this.createState(e)))}onLoad(){this.clips=this._clips;for(const e in this._nameToState)this._nameToState[e].initialize(this.node)}start(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}onEnable(){this._crossFade.resume()}onDisable(){this._crossFade.pause()}onDestroy(){this._crossFade.stop();for(const e in this._nameToState)this._nameToState[e].destroy();this._nameToState=se(!0)}play(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}crossFade(e,t=.3){this._hasBeenPlayed=!0;const i=this._nameToState[e];i&&(this._crossFade.play(),this._crossFade.crossFade(i,t))}pause(){this._crossFade.pause()}resume(){this._crossFade.resume()}stop(){this._crossFade.stop()}getAnimationState(e){return this.getState(e)}getState(e){const t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}createState(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}removeState(e){const t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])}addClip(e,t){return W(this._clips,e)||this._clips.push(e),this.createState(e,t)}removeClip(e,t){let i;for(const t in this._nameToState){const n=this._nameToState[t];if(n.clip===e){i=n;break}}if(e===this._defaultClip){if(!t)return void T(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!t)return void T(3903);i.stop()}this._clips=this._clips.filter((t=>t!==e)),i&&delete this._nameToState[i.name]}on(e,t,i,n){const s=super.on(e,t,i,n);return e===AD.LASTFRAME&&this._syncAllowLastFrameEvent(),s}once(e,t,i){const n=super.once(e,t,i);return e===AD.LASTFRAME&&this._syncAllowLastFrameEvent(),n}off(e,t,i){super.off(e,t,i),e===AD.LASTFRAME&&this._syncDisallowLastFrameEvent()}_createState(e,t){return new PD(e,t)}_doCreateState(e,t){const i=this._createState(e,t);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(AD.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}_getStateByNameOrDefaultClip(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}return this._nameToState[e]||null}_removeStateOfAutomaticClip(e){for(const t in this._nameToState){const i=this._nameToState[t];YD(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}_syncAllowLastFrameEvent(){if(this.hasEventListener(AD.LASTFRAME))for(const e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)}_syncDisallowLastFrameEvent(){if(!this.hasEventListener(AD.LASTFRAME))for(const e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)}},WD.EventType=AD,Oc((kD=qD).prototype,"clips",[ND,LD],Object.getOwnPropertyDescriptor(kD.prototype,"clips"),kD.prototype),Oc(kD.prototype,"defaultClip",[BD,zD],Object.getOwnPropertyDescriptor(kD.prototype,"defaultClip"),kD.prototype),HD=Oc(kD.prototype,"playOnLoad",[Qc,FD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VD=Oc(kD.prototype,"_clips",[UD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jD=Oc(kD.prototype,"_defaultClip",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GD=kD))||GD)||GD)||GD)||GD)||GD));function YD(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}ei(XD.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction(...e){const t=e[0];return XD.prototype.removeState.call(this,t.name)}}]),n.AnimationComponent=XD,De.setClassAlias(XD,"cc.AnimationComponent");class KD{constructor(){this._nodeBlendStates=new Map}createWriter(e,t,i,n){const s=this.ref(e,t);return new $D(e,t,s,i,n)}destroyWriter(e){const t=e;this.deRef(t.node,t.property)}ref(e,t){let i=this._nodeBlendStates.get(e);return i||(i=new eN,this._nodeBlendStates.set(e,i)),i.refProperty(t)}deRef(e,t){const i=this._nodeBlendStates.get(e);i&&(i.deRefProperty(t),i.empty&&this._nodeBlendStates.delete(e))}apply(){this._nodeBlendStates.forEach(((e,t)=>{e.apply(t)}))}}class $D{constructor(e,t,i,n,s){this._node=e,this._property=t,this._propertyBlendState=i,this._host=n,this._constants=s}get node(){return this._node}get property(){return this._property}getValue(){return this._node[this._property]}setValue(e){const{_propertyBlendState:t,_host:i}=this,n=i.weight;t.blend(e,n)}}class QD{constructor(e){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=e}}class ZD extends QD{constructor(){super(new zi)}blend(e,t){const{blendedValue:i}=this;1===t?zi.copy(i,e):zi.scaleAndAdd(i,i,e,t),this.blendedWeight+=t}reset(){this.blendedWeight=0,zi.zero(this.blendedValue)}}class JD extends QD{constructor(){super(new ji)}blend(e,t){if(0===t)return;const{blendedValue:i,blendedWeight:n}=this;if(1===t)ji.copy(i,e);else{const s=t/(n+t);ji.slerp(i,i,e,s)}this.blendedWeight+=t}reset(){this.blendedWeight=0,ji.identity(this.blendedValue)}}class eN{constructor(){this._properties={}}get empty(){const{_properties:e}=this;return!(e.position||e.rotation||e.eulerAngles||e.scale)}refProperty(e){var t,i;const{_properties:n}=this;let s;switch(e){default:case"position":case"scale":case"eulerAngles":s=null!==(t=n[e])&&void 0!==t?t:n[e]=new ZD;break;case"rotation":s=null!==(i=n[e])&&void 0!==i?i:n[e]=new JD}return++s.refCount,s}deRefProperty(e){const{_properties:t}=this,i=t[e];i&&(--i.refCount,i.refCount>0||delete t[e])}apply(e){const{_properties:{position:t,scale:i,rotation:n,eulerAngles:s}}=this;let o,r,a,c=!1,l=!1,h=!1,u=!1;t&&t.blendedWeight&&(c=!0,t.blendedWeight<1&&t.blend(e.position,1-t.blendedWeight),o=t.blendedValue),i&&i.blendedWeight&&(l=!0,i.blendedWeight<1&&i.blend(e.scale,1-i.blendedWeight),r=i.blendedValue),s&&s.blendedWeight&&(u=!0,s.blendedWeight<1&&s.blend(e.eulerAngles,1-s.blendedWeight),a=s.blendedValue),n&&n.blendedWeight&&(h=!0,n.blendedWeight<1&&n.blend(e.rotation,1-n.blendedWeight),a=n.blendedValue),(a||o||r)&&e.setRTS(a,o,r),c&&t.reset(),l&&i.reset(),h&&n.reset(),u&&s.reset()}}const tN=[],iN=new Map;function nN(e,t){let i=0,n=Zi.IDENTITY;for(;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){n=e.world,e.stamp=t;break}e.stamp=t,tN[i++]=e,e=e.parent}for(;i>0;){e=tN[--i],tN[i]=null;const t=e.node;Zi.fromRTS(e.local,t.rotation,t.position,t.scale),n=Zi.multiply(e.world,n,e.local)}return n}function sN(e,t){let i,n=null,s=0;for(;e!==t;){const t=e.uuid;if(iN.has(t)){n=iN.get(t);break}n={node:e,local:new Zi,world:new Zi,stamp:-1,parent:null},iN.set(t,n),tN[s++]=n,e=e.parent,n=null}for(;s>0;)i=tN[--s],tN[s]=null,i.parent=n,n=i;return n}function oN(e){let t=iN.get(e.uuid)||null;for(;t;)iN.delete(t.node.uuid),t=t.parent}var rN,aN,cN;let lN=e("AnimationManager",Wc((cN=aN=class extends kw{constructor(...e){super(...e),this._anims=new k([]),this._crossFades=new k([]),this._delayEvents=[],this._blendStateBuffer=new KD,this._sockets=[]}get blendState(){return this._blendStateBuffer}addCrossFade(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)}removeCrossFade(e){const t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):C(3907)}update(e){const{_delayEvents:t,_crossFades:i,_sockets:s}=this;{const t=i.array;for(i.i=0;i.i<t.length;++i.i)t[i.i].update(e)}const o=this._anims,r=o.array;for(o.i=0;o.i<r.length;++o.i){const t=r[o.i];t.isMotionless||t.update(e)}this._blendStateBuffer.apply();const a=n.director.getTotalFrames();for(let e=0,t=s.length;e<t;e++){const{target:t,transform:i}=s[e];t.matrix=nN(i,a)}for(let e=0,i=t.length;e<i;e++){const i=t[e];i.fn.apply(i.thisArg,i.args)}t.length=0}destruct(){}addAnimation(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)}removeAnimation(e){const t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):C(3907)}pushDelayEvent(e,t,i){this._delayEvents.push({fn:e,thisArg:t,args:i})}addSockets(e,t){for(let i=0;i<t.length;++i){const n=t[i];if(this._sockets.find((e=>e.target===n.target)))continue;const s=e.getChildByPath(n.path),o=n.target&&s&&sN(s,e);o&&this._sockets.push({target:n.target,transform:o})}}removeSockets(e,t){for(let e=0;e<t.length;++e){const i=t[e];for(let e=0;e<this._sockets.length;++e){const t=this._sockets[e];if(t.target===i.target){oN(t.transform.node),this._sockets[e]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}},aN.ID="animation",rN=cN))||rN);Qw.on($w.EVENT_INIT,(()=>{const e=new lN;Qw.registerSystem(lN.ID,e,kw.Priority.HIGH)})),n.AnimationManager=lN;const hN=new Zi;function uN(e,t,i){for(Zi.identity(i);e!==t;)Zi.fromRTS(hN,e.rotation,e.position,e.scale),Zi.multiply(i,hN,i),e=e.parent;return i}var _N,pN,dN,fN;n.easing=D_;let mN=e("HierachyModifier",Wc("cc.HierachyModifier")(_N=class extends hI{})||_N);n.HierachyModifier=mN;let gN=e("ComponentModifier",Wc("cc.ComponentModifier")(pN=class extends uI{})||pN);n.ComponentModifier=gN;let vN=e("CurveValueAdapter",Wc("cc.CurveValueAdapter")(dN=class{forTarget(e){return{set:()=>{}}}})||dN);n.CurveValueAdapter=vN;let yN,xN=e("UniformCurveValueAdapter",Wc("cc.UniformCurveValueAdapter")(fN=class extends gI{})||fN);function SN(e){return"string"==typeof e}function bN(e){return"number"==typeof e}function TN(e,t){return e instanceof t}n.UniformCurveValueAdapter=xN,n.isPropertyModifier=SN,n.isElementModifier=bN,n.isCustomTargetModifier=TN,n.math=dn,n.geometry=ed;class EN{constructor(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}size(){return this._pool.length}clear(){const e=this._pool.length;for(let t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}put(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();const t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}get(...e){const t=this._pool.length-1;if(t<0)return null;{const e=this._pool[t];this._pool.length=t;const i=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;return i&&i.reuse&&i.reuse(arguments),e}}}e("NodePool",EN),n.NodePool=EN,n.renderer=wv;class CN extends Br{constructor(...e){super(...e),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(e){this._layout=e.layout;const{bindings:t,descriptorIndices:i,descriptorCount:n}=e.layout.gpuDescriptorSetLayout;this._buffers=Array(n).fill(null),this._textures=Array(n).fill(null),this._samplers=Array(n).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:i};for(let e=0;e<t.length;++e){const i=t[e];for(let e=0;e<i.count;e++)s.push({type:i.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}return!0}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const e=this._gpuDescriptorSet.gpuDescriptors;for(let t=0;t<e.length;++t)if(e[t].type&yr){const i=this._buffers[t];i&&(e[t].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else e[t].type&xr&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}}function wN(e,t){switch(e){case Ls.R8:return t.UNSIGNED_BYTE;case Ls.R8SN:return t.BYTE;case Ls.R8UI:return t.UNSIGNED_BYTE;case Ls.R8I:return t.BYTE;case Ls.R16F:return yN.HALF_FLOAT_OES;case Ls.R16UI:return t.UNSIGNED_SHORT;case Ls.R16I:return t.SHORT;case Ls.R32F:return t.FLOAT;case Ls.R32UI:return t.UNSIGNED_INT;case Ls.R32I:return t.INT;case Ls.RG8:return t.UNSIGNED_BYTE;case Ls.RG8SN:return t.BYTE;case Ls.RG8UI:return t.UNSIGNED_BYTE;case Ls.RG8I:return t.BYTE;case Ls.RG16F:return yN.HALF_FLOAT_OES;case Ls.RG16UI:return t.UNSIGNED_SHORT;case Ls.RG16I:return t.SHORT;case Ls.RG32F:return t.FLOAT;case Ls.RG32UI:return t.UNSIGNED_INT;case Ls.RG32I:return t.INT;case Ls.RGB8:case Ls.SRGB8:return t.UNSIGNED_BYTE;case Ls.RGB8SN:return t.BYTE;case Ls.RGB8UI:return t.UNSIGNED_BYTE;case Ls.RGB8I:return t.BYTE;case Ls.RGB16F:return yN.HALF_FLOAT_OES;case Ls.RGB16UI:return t.UNSIGNED_SHORT;case Ls.RGB16I:return t.SHORT;case Ls.RGB32F:return t.FLOAT;case Ls.RGB32UI:return t.UNSIGNED_INT;case Ls.RGB32I:return t.INT;case Ls.BGRA8:case Ls.RGBA8:case Ls.SRGB8_A8:return t.UNSIGNED_BYTE;case Ls.RGBA8SN:return t.BYTE;case Ls.RGBA8UI:return t.UNSIGNED_BYTE;case Ls.RGBA8I:return t.BYTE;case Ls.RGBA16F:return yN.HALF_FLOAT_OES;case Ls.RGBA16UI:return t.UNSIGNED_SHORT;case Ls.RGBA16I:return t.SHORT;case Ls.RGBA32F:return t.FLOAT;case Ls.RGBA32UI:return t.UNSIGNED_INT;case Ls.RGBA32I:return t.INT;case Ls.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Ls.R11G11B10F:return t.FLOAT;case Ls.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Ls.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Ls.RGB10A2:return t.UNSIGNED_BYTE;case Ls.RGB10A2UI:return t.UNSIGNED_INT;case Ls.RGB9E5:return t.UNSIGNED_BYTE;case Ls.D16:return t.UNSIGNED_SHORT;case Ls.D16S8:return yN.UNSIGNED_INT_24_8_WEBGL;case Ls.D24:return t.UNSIGNED_INT;case Ls.D24S8:return yN.UNSIGNED_INT_24_8_WEBGL;case Ls.D32F:return t.UNSIGNED_INT;case Ls.D32F_S8:return yN.UNSIGNED_INT_24_8_WEBGL;case Ls.BC1:case Ls.BC1_SRGB:case Ls.BC2:case Ls.BC2_SRGB:case Ls.BC3:case Ls.BC3_SRGB:case Ls.BC4:return t.UNSIGNED_BYTE;case Ls.BC4_SNORM:return t.BYTE;case Ls.BC5:return t.UNSIGNED_BYTE;case Ls.BC5_SNORM:return t.BYTE;case Ls.BC6H_SF16:case Ls.BC6H_UF16:return t.FLOAT;case Ls.BC7:case Ls.BC7_SRGB:case Ls.ETC_RGB8:case Ls.ETC2_RGB8:case Ls.ETC2_SRGB8:case Ls.ETC2_RGB8_A1:case Ls.ETC2_SRGB8_A1:case Ls.EAC_R11:return t.UNSIGNED_BYTE;case Ls.EAC_R11SN:return t.BYTE;case Ls.EAC_RG11:return t.UNSIGNED_BYTE;case Ls.EAC_RG11SN:return t.BYTE;case Ls.PVRTC_RGB2:case Ls.PVRTC_RGBA2:case Ls.PVRTC_RGB4:case Ls.PVRTC_RGBA4:case Ls.PVRTC2_2BPP:case Ls.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Ls.ASTC_RGBA_4X4:case Ls.ASTC_RGBA_5X4:case Ls.ASTC_RGBA_5X5:case Ls.ASTC_RGBA_6X5:case Ls.ASTC_RGBA_6X6:case Ls.ASTC_RGBA_8X5:case Ls.ASTC_RGBA_8X6:case Ls.ASTC_RGBA_8X8:case Ls.ASTC_RGBA_10X5:case Ls.ASTC_RGBA_10X6:case Ls.ASTC_RGBA_10X8:case Ls.ASTC_RGBA_10X10:case Ls.ASTC_RGBA_12X10:case Ls.ASTC_RGBA_12X12:case Ls.ASTC_SRGBA_4X4:case Ls.ASTC_SRGBA_5X4:case Ls.ASTC_SRGBA_5X5:case Ls.ASTC_SRGBA_6X5:case Ls.ASTC_SRGBA_6X6:case Ls.ASTC_SRGBA_8X5:case Ls.ASTC_SRGBA_8X6:case Ls.ASTC_SRGBA_8X8:case Ls.ASTC_SRGBA_10X5:case Ls.ASTC_SRGBA_10X6:case Ls.ASTC_SRGBA_10X8:case Ls.ASTC_SRGBA_10X10:case Ls.ASTC_SRGBA_12X10:case Ls.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function AN(e,t){switch(e){case Ls.A8:return t.ALPHA;case Ls.L8:return t.LUMINANCE;case Ls.LA8:return t.LUMINANCE_ALPHA;case Ls.RGB8:case Ls.RGB16F:case Ls.RGB32F:return t.RGB;case Ls.BGRA8:case Ls.RGBA8:case Ls.SRGB8_A8:case Ls.RGBA16F:case Ls.RGBA32F:return t.RGBA;case Ls.R5G6B5:return t.RGB;case Ls.RGB5A1:case Ls.RGBA4:return t.RGBA;case Ls.D16:return t.DEPTH_COMPONENT;case Ls.D16S8:return t.DEPTH_STENCIL;case Ls.D24:return t.DEPTH_COMPONENT;case Ls.D24S8:return t.DEPTH_STENCIL;case Ls.D32F:return t.DEPTH_COMPONENT;case Ls.D32F_S8:return t.DEPTH_STENCIL;case Ls.BC1:return yN.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ls.BC1_ALPHA:return yN.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ls.BC1_SRGB:return yN.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ls.BC1_SRGB_ALPHA:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ls.BC2:return yN.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ls.BC2_SRGB:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ls.BC3:return yN.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ls.BC3_SRGB:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ls.ETC_RGB8:return yN.COMPRESSED_RGB_ETC1_WEBGL;case Ls.ETC2_RGB8:return yN.COMPRESSED_RGB8_ETC2;case Ls.ETC2_SRGB8:return yN.COMPRESSED_SRGB8_ETC2;case Ls.ETC2_RGB8_A1:return yN.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ls.ETC2_SRGB8_A1:return yN.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ls.ETC2_RGBA8:return yN.COMPRESSED_RGBA8_ETC2_EAC;case Ls.ETC2_SRGB8_A8:return yN.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ls.EAC_R11:return yN.COMPRESSED_R11_EAC;case Ls.EAC_R11SN:return yN.COMPRESSED_SIGNED_R11_EAC;case Ls.EAC_RG11:return yN.COMPRESSED_RG11_EAC;case Ls.EAC_RG11SN:return yN.COMPRESSED_SIGNED_RG11_EAC;case Ls.PVRTC_RGB2:return yN.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ls.PVRTC_RGBA2:return yN.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ls.PVRTC_RGB4:return yN.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ls.PVRTC_RGBA4:return yN.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ls.ASTC_RGBA_4X4:return yN.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ls.ASTC_RGBA_5X4:return yN.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ls.ASTC_RGBA_5X5:return yN.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ls.ASTC_RGBA_6X5:return yN.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ls.ASTC_RGBA_6X6:return yN.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ls.ASTC_RGBA_8X5:return yN.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ls.ASTC_RGBA_8X6:return yN.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ls.ASTC_RGBA_8X8:return yN.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ls.ASTC_RGBA_10X5:return yN.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ls.ASTC_RGBA_10X6:return yN.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ls.ASTC_RGBA_10X8:return yN.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ls.ASTC_RGBA_10X10:return yN.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ls.ASTC_RGBA_12X10:return yN.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ls.ASTC_RGBA_12X12:return yN.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ls.ASTC_SRGBA_4X4:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ls.ASTC_SRGBA_5X4:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ls.ASTC_SRGBA_5X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ls.ASTC_SRGBA_6X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ls.ASTC_SRGBA_6X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ls.ASTC_SRGBA_8X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ls.ASTC_SRGBA_8X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ls.ASTC_SRGBA_8X8:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ls.ASTC_SRGBA_10X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ls.ASTC_SRGBA_10X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ls.ASTC_SRGBA_10X8:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ls.ASTC_SRGBA_10X10:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ls.ASTC_SRGBA_12X10:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ls.ASTC_SRGBA_12X12:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}function PN(e,t){switch(e){case zs.BOOL:return t.BOOL;case zs.BOOL2:return t.BOOL_VEC2;case zs.BOOL3:return t.BOOL_VEC3;case zs.BOOL4:return t.BOOL_VEC4;case zs.INT:return t.INT;case zs.INT2:return t.INT_VEC2;case zs.INT3:return t.INT_VEC3;case zs.INT4:return t.INT_VEC4;case zs.UINT:return t.UNSIGNED_INT;case zs.FLOAT:return t.FLOAT;case zs.FLOAT2:return t.FLOAT_VEC2;case zs.FLOAT3:return t.FLOAT_VEC3;case zs.FLOAT4:return t.FLOAT_VEC4;case zs.MAT2:return t.FLOAT_MAT2;case zs.MAT3:return t.FLOAT_MAT3;case zs.MAT4:return t.FLOAT_MAT4;case zs.SAMPLER2D:return t.SAMPLER_2D;case zs.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),zs.UNKNOWN}}function RN(e){switch(e){case zs.BOOL:case zs.BOOL2:case zs.BOOL3:case zs.BOOL4:case zs.INT:case zs.INT2:case zs.INT3:case zs.INT4:case zs.UINT:return Int32Array;case zs.FLOAT:case zs.FLOAT2:case zs.FLOAT3:case zs.FLOAT4:case zs.MAT2:case zs.MAT3:case zs.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function IN(e,t){switch(e){case t.BOOL:return zs.BOOL;case t.BOOL_VEC2:return zs.BOOL2;case t.BOOL_VEC3:return zs.BOOL3;case t.BOOL_VEC4:return zs.BOOL4;case t.INT:return zs.INT;case t.INT_VEC2:return zs.INT2;case t.INT_VEC3:return zs.INT3;case t.INT_VEC4:return zs.INT4;case t.UNSIGNED_INT:return zs.UINT;case t.FLOAT:return zs.FLOAT;case t.FLOAT_VEC2:return zs.FLOAT2;case t.FLOAT_VEC3:return zs.FLOAT3;case t.FLOAT_VEC4:return zs.FLOAT4;case t.FLOAT_MAT2:return zs.MAT2;case t.FLOAT_MAT3:return zs.MAT3;case t.FLOAT_MAT4:return zs.MAT4;case t.SAMPLER_2D:return zs.SAMPLER2D;case t.SAMPLER_CUBE:return zs.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),zs.UNKNOWN}}function MN(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function ON(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(yN||(yN={}));const DN=[512,513,514,515,516,517,518,519],NN=[0,7680,7681,7682,7683,5386,34055,34056],LN=[32774,32778,32779,32775,32776],BN=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let zN;!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(zN||(zN={}));class FN{constructor(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e}}class UN extends FN{constructor(){super(zN.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea=new xo,this.clearFlag=fo.NONE,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class GN extends FN{constructor(){super(zN.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.dynamicStates=new fr}clear(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0}}class kN extends FN{constructor(){super(zN.DRAW),this.drawInfo=new Oo}clear(){}}class HN extends FN{constructor(){super(zN.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class VN extends FN{constructor(){super(zN.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class jN{constructor(){this.cmds=new G(1),this.beginRenderPassCmds=new G(1),this.bindStatesCmds=new G(1),this.drawCmds=new G(1),this.updateBufferCmds=new G(1),this.copyBufferToTextureCmds=new G(1)}clearCmds(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function WN(e,t,i,n,s){if(t.usage&Fs.UNIFORM)ArrayBuffer.isView(i)?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&Fs.INDIRECT)t.indirects.length=n,Array.prototype.push.apply(t.indirects,i.drawInfos);else{const o=i,{gl:r}=e,a=e.stateCache;switch(t.glTarget){case r.ARRAY_BUFFER:e.useVAO&&a.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=qN.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case r.ELEMENT_ARRAY_BUFFER:e.useVAO&&a.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=qN.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}s===o.byteLength?r.bufferSubData(t.glTarget,n,o):r.bufferSubData(t.glTarget,n,o.slice(0,s))}}const qN={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function XN(e,t,i,n,s,o,r){const{gl:a}=e,c=e.stateCache;let l=0;if(i&&t){c.glFramebuffer!==i.glFramebuffer&&(a.bindFramebuffer(a.FRAMEBUFFER,i.glFramebuffer),c.glFramebuffer=i.glFramebuffer),c.viewport.left===n.x&&c.viewport.top===n.y&&c.viewport.width===n.width&&c.viewport.height===n.height||(a.viewport(n.x,n.y,n.width,n.height),c.viewport.left=n.x,c.viewport.top=n.y,c.viewport.width=n.width,c.viewport.height=n.height),c.scissorRect.x===n.x&&c.scissorRect.y===n.y&&c.scissorRect.width===n.width&&c.scissorRect.height===n.height||(a.scissor(n.x,n.y,n.width,n.height),c.scissorRect.x=n.x,c.scissorRect.y=n.y,c.scissorRect.width=n.width,c.scissorRect.height=n.height);let h=s.length;e.WEBGL_draw_buffers||(h=1);for(let e=0;e<h;++e){const i=t.colorAttachments[e];if(i.format!==Ls.UNKNOWN)switch(i.loadOp){case eo.LOAD:break;case eo.CLEAR:{c.bs.targets[0].blendColorMask!==Zs.ALL&&a.colorMask(!0,!0,!0,!0);const e=s[0];a.clearColor(e.x,e.y,e.z,e.w),l|=a.COLOR_BUFFER_BIT;break}case eo.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Ls.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case eo.LOAD:break;case eo.CLEAR:c.dss.depthWrite||a.depthMask(!0),a.clearDepth(o),l|=a.DEPTH_BUFFER_BIT;break;case eo.DISCARD:}if(vr[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case eo.LOAD:break;case eo.CLEAR:c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(r),l|=a.STENCIL_BUFFER_BIT;break;case eo.DISCARD:}}if(l&&a.clear(l),l&a.COLOR_BUFFER_BIT){const e=c.bs.targets[0].blendColorMask;if(e!==Zs.ALL){const t=(e&Zs.R)!==Zs.NONE,i=(e&Zs.G)!==Zs.NONE,n=(e&Zs.B)!==Zs.NONE,s=(e&Zs.A)!==Zs.NONE;a.colorMask(t,i,n,s)}}l&a.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&a.depthMask(!1),l&a.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function YN(e,t,i,n,s,o){const{gl:r}=e,a=e.stateCache,c=t&&t.gpuShader;let l,h,u,_=!1;if(t&&qN.gpuPipelineState!==t){if(qN.gpuPipelineState=t,qN.glPrimitive=t.glPrimitive,t.gpuShader){const{glProgram:e}=t.gpuShader;a.glProgram!==e&&(r.useProgram(e),a.glProgram=e,_=!0)}const{rs:e}=t;if(e){if(a.rs.cullMode!==e.cullMode){switch(e.cullMode){case co.NONE:r.disable(r.CULL_FACE);break;case co.FRONT:r.enable(r.CULL_FACE),r.cullFace(r.FRONT);break;case co.BACK:r.enable(r.CULL_FACE),r.cullFace(r.BACK)}a.rs.cullMode=e.cullMode}const t=e.isFrontFaceCCW;a.rs.isFrontFaceCCW!==t&&(r.frontFace(t?r.CCW:r.CW),a.rs.isFrontFaceCCW=t),a.rs.depthBias===e.depthBias&&a.rs.depthBiasSlop===e.depthBiasSlop||(r.polygonOffset(e.depthBias,e.depthBiasSlop),a.rs.depthBias=e.depthBias,a.rs.depthBiasSlop=e.depthBiasSlop),a.rs.lineWidth!==e.lineWidth&&(r.lineWidth(e.lineWidth),a.rs.lineWidth=e.lineWidth)}const{dss:i}=t;i&&(a.dss.depthTest!==i.depthTest&&(i.depthTest?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),a.dss.depthTest=i.depthTest),a.dss.depthWrite!==i.depthWrite&&(r.depthMask(i.depthWrite),a.dss.depthWrite=i.depthWrite),a.dss.depthFunc!==i.depthFunc&&(r.depthFunc(DN[i.depthFunc]),a.dss.depthFunc=i.depthFunc),a.dss.stencilTestFront===i.stencilTestFront&&a.dss.stencilTestBack===i.stencilTestBack||(i.stencilTestFront||i.stencilTestBack?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),a.dss.stencilTestFront=i.stencilTestFront,a.dss.stencilTestBack=i.stencilTestBack),a.dss.stencilFuncFront===i.stencilFuncFront&&a.dss.stencilRefFront===i.stencilRefFront&&a.dss.stencilReadMaskFront===i.stencilReadMaskFront||(r.stencilFuncSeparate(r.FRONT,DN[i.stencilFuncFront],i.stencilRefFront,i.stencilReadMaskFront),a.dss.stencilFuncFront=i.stencilFuncFront,a.dss.stencilRefFront=i.stencilRefFront,a.dss.stencilReadMaskFront=i.stencilReadMaskFront),a.dss.stencilFailOpFront===i.stencilFailOpFront&&a.dss.stencilZFailOpFront===i.stencilZFailOpFront&&a.dss.stencilPassOpFront===i.stencilPassOpFront||(r.stencilOpSeparate(r.FRONT,NN[i.stencilFailOpFront],NN[i.stencilZFailOpFront],NN[i.stencilPassOpFront]),a.dss.stencilFailOpFront=i.stencilFailOpFront,a.dss.stencilZFailOpFront=i.stencilZFailOpFront,a.dss.stencilPassOpFront=i.stencilPassOpFront),a.dss.stencilWriteMaskFront!==i.stencilWriteMaskFront&&(r.stencilMaskSeparate(r.FRONT,i.stencilWriteMaskFront),a.dss.stencilWriteMaskFront=i.stencilWriteMaskFront),a.dss.stencilFuncBack===i.stencilFuncBack&&a.dss.stencilRefBack===i.stencilRefBack&&a.dss.stencilReadMaskBack===i.stencilReadMaskBack||(r.stencilFuncSeparate(r.BACK,DN[i.stencilFuncBack],i.stencilRefBack,i.stencilReadMaskBack),a.dss.stencilFuncBack=i.stencilFuncBack,a.dss.stencilRefBack=i.stencilRefBack,a.dss.stencilReadMaskBack=i.stencilReadMaskBack),a.dss.stencilFailOpBack===i.stencilFailOpBack&&a.dss.stencilZFailOpBack===i.stencilZFailOpBack&&a.dss.stencilPassOpBack===i.stencilPassOpBack||(r.stencilOpSeparate(r.BACK,NN[i.stencilFailOpBack],NN[i.stencilZFailOpBack],NN[i.stencilPassOpBack]),a.dss.stencilFailOpBack=i.stencilFailOpBack,a.dss.stencilZFailOpBack=i.stencilZFailOpBack,a.dss.stencilPassOpBack=i.stencilPassOpBack),a.dss.stencilWriteMaskBack!==i.stencilWriteMaskBack&&(r.stencilMaskSeparate(r.BACK,i.stencilWriteMaskBack),a.dss.stencilWriteMaskBack=i.stencilWriteMaskBack));const{bs:n}=t;if(n){a.bs.isA2C!==n.isA2C&&(n.isA2C?r.enable(r.SAMPLE_ALPHA_TO_COVERAGE):r.disable(r.SAMPLE_ALPHA_TO_COVERAGE),a.bs.isA2C=n.isA2C),a.bs.blendColor.x===n.blendColor.x&&a.bs.blendColor.y===n.blendColor.y&&a.bs.blendColor.z===n.blendColor.z&&a.bs.blendColor.w===n.blendColor.w||(r.blendColor(n.blendColor.x,n.blendColor.y,n.blendColor.z,n.blendColor.w),a.bs.blendColor.x=n.blendColor.x,a.bs.blendColor.y=n.blendColor.y,a.bs.blendColor.z=n.blendColor.z,a.bs.blendColor.w=n.blendColor.w);const e=n.targets[0],t=a.bs.targets[0];t.blend!==e.blend&&(e.blend?r.enable(r.BLEND):r.disable(r.BLEND),t.blend=e.blend),t.blendEq===e.blendEq&&t.blendAlphaEq===e.blendAlphaEq||(r.blendEquationSeparate(LN[e.blendEq],LN[e.blendAlphaEq]),t.blendEq=e.blendEq,t.blendAlphaEq=e.blendAlphaEq),t.blendSrc===e.blendSrc&&t.blendDst===e.blendDst&&t.blendSrcAlpha===e.blendSrcAlpha&&t.blendDstAlpha===e.blendDstAlpha||(r.blendFuncSeparate(BN[e.blendSrc],BN[e.blendDst],BN[e.blendSrcAlpha],BN[e.blendDstAlpha]),t.blendSrc=e.blendSrc,t.blendDst=e.blendDst,t.blendSrcAlpha=e.blendSrcAlpha,t.blendDstAlpha=e.blendDstAlpha),t.blendColorMask!==e.blendColorMask&&(r.colorMask((e.blendColorMask&Zs.R)!==Zs.NONE,(e.blendColorMask&Zs.G)!==Zs.NONE,(e.blendColorMask&Zs.B)!==Zs.NONE,(e.blendColorMask&Zs.A)!==Zs.NONE),t.blendColorMask=e.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){const i=c.glBlocks.length,{dynamicOffsetIndices:o}=t.gpuPipelineLayout;for(let e=0;e<i;e++){const t=c.glBlocks[e],i=n[t.set],a=i&&i.descriptorIndices[t.binding],l=a>=0&&i.gpuDescriptors[a];let h=null,u=0;if(l&&l.gpuBuffer){const{gpuBuffer:e}=l,i=o[t.set],n=i&&i[t.binding];n>=0&&(u=s[n]),"vf32"in e?h=e.vf32:(u+=e.offset,h=e.gpuBuffer.vf32),u>>=2}if(!h){d(`Buffer binding '${t.name}' at set ${t.set} binding ${t.binding} is not bounded`);continue}const _=t.glActiveUniforms.length;for(let e=0;e<_;e++){const i=t.glActiveUniforms[e];switch(i.glType){case r.BOOL:case r.INT:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniform1iv(i.glLoc,i.array);break}}break;case r.BOOL_VEC2:case r.INT_VEC2:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniform2iv(i.glLoc,i.array);break}}break;case r.BOOL_VEC3:case r.INT_VEC3:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniform3iv(i.glLoc,i.array);break}}break;case r.BOOL_VEC4:case r.INT_VEC4:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniform4iv(i.glLoc,i.array);break}}break;case r.FLOAT:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniform1fv(i.glLoc,i.array);break}}break;case r.FLOAT_VEC2:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniform2fv(i.glLoc,i.array);break}}break;case r.FLOAT_VEC3:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniform3fv(i.glLoc,i.array);break}}break;case r.FLOAT_VEC4:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniform4fv(i.glLoc,i.array);break}}break;case r.FLOAT_MAT2:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniformMatrix2fv(i.glLoc,!1,i.array);break}}break;case r.FLOAT_MAT3:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniformMatrix3fv(i.glLoc,!1,i.array);break}}break;case r.FLOAT_MAT4:for(let e=0;e<i.array.length;++e){const t=i.offset+u+e;if(h[t]!==i.array[e]){for(let n=e,s=t;n<i.array.length;++n,++s)i.array[n]=h[s];r.uniformMatrix4fv(i.glLoc,!1,i.array);break}}}}}const _=c.glSamplerTextures.length;for(let t=0;t<_;t++){const i=c.glSamplerTextures[t],s=n[i.set];let o=s&&s.descriptorIndices[i.binding],_=o>=0&&s.gpuDescriptors[o];const p=i.units.length;for(let t=0;t<p;t++){const n=i.units[t];if(_&&_.gpuSampler){if(_.gpuTexture&&_.gpuTexture.size>0){const{gpuTexture:t}=_,i=a.glTexUnits[n];i.glTexture!==t.glTexture&&(a.texUnit!==n&&(r.activeTexture(r.TEXTURE0+n),a.texUnit=n),t.glTexture?r.bindTexture(t.glTarget,t.glTexture):r.bindTexture(t.glTarget,e.nullTex2D.gpuTexture.glTexture),i.glTexture=t.glTexture);const{gpuSampler:s}=_;t.isPowerOf2?(l=s.glWrapS,h=s.glWrapT):(l=r.CLAMP_TO_EDGE,h=r.CLAMP_TO_EDGE),u=t.isPowerOf2?t.mipLevel<=1&&(s.glMinFilter===r.LINEAR_MIPMAP_NEAREST||s.glMinFilter===r.LINEAR_MIPMAP_LINEAR)?r.LINEAR:s.glMinFilter:s.glMinFilter===r.LINEAR||s.glMinFilter===r.LINEAR_MIPMAP_NEAREST||s.glMinFilter===r.LINEAR_MIPMAP_LINEAR?r.LINEAR:r.NEAREST,t.glWrapS!==l&&(a.texUnit!==n&&(r.activeTexture(r.TEXTURE0+n),a.texUnit=n),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,l),t.glWrapS=l),t.glWrapT!==h&&(a.texUnit!==n&&(r.activeTexture(r.TEXTURE0+n),a.texUnit=n),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,h),t.glWrapT=h),t.glMinFilter!==u&&(a.texUnit!==n&&(r.activeTexture(r.TEXTURE0+n),a.texUnit=n),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,u),t.glMinFilter=u),t.glMagFilter!==s.glMagFilter&&(a.texUnit!==n&&(r.activeTexture(r.TEXTURE0+n),a.texUnit=n),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,s.glMagFilter),t.glMagFilter=s.glMagFilter)}_=s.gpuDescriptors[++o]}else d(`Sampler binding '${i.name}' at set ${i.set} binding ${i.binding} index ${t} is not bounded`)}}}if(i&&c&&(_||qN.gpuInputAssembler!==i)){qN.gpuInputAssembler=i;const t=e.ANGLE_instanced_arrays;if(e.useVAO){const n=e.OES_vertex_array_object;let s=i.glVAOs.get(c.glProgram);if(!s){let e;s=n.createVertexArrayOES(),i.glVAOs.set(c.glProgram,s),n.bindVertexArrayOES(s),r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null;const o=c.glInputs.length;for(let n=0;n<o;n++){const s=c.glInputs[n];e=null;const o=i.glAttribs.length;for(let t=0;t<o;t++){const n=i.glAttribs[t];if(n.name===s.name){e=n;break}}if(e){a.glArrayBuffer!==e.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,e.glBuffer),a.glArrayBuffer=e.glBuffer);for(let i=0;i<e.componentCount;++i){const n=s.glLoc+i,o=e.offset+e.size*i;r.enableVertexAttribArray(n),a.glCurrentAttribLocs[n]=!0,r.vertexAttribPointer(n,e.count,e.glType,e.isNormalized,e.stride,o),t&&t.vertexAttribDivisorANGLE(n,e.isInstanced?1:0)}}}const l=i.gpuIndexBuffer;l&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,l.glBuffer),n.bindVertexArrayOES(null),r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null}a.glVAO!==s&&(n.bindVertexArrayOES(s),a.glVAO=s)}else{for(let t=0;t<e.capabilities.maxVertexAttributes;++t)a.glCurrentAttribLocs[t]=!1;const n=c.glInputs.length;for(let e=0;e<n;e++){const n=c.glInputs[e];let s=null;const o=i.glAttribs.length;for(let e=0;e<o;e++){const t=i.glAttribs[e];if(t.name===n.name){s=t;break}}if(s){a.glArrayBuffer!==s.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,s.glBuffer),a.glArrayBuffer=s.glBuffer);for(let e=0;e<s.componentCount;++e){const i=n.glLoc+e,o=s.offset+s.size*e;!a.glEnabledAttribLocs[i]&&i>=0&&(r.enableVertexAttribArray(i),a.glEnabledAttribLocs[i]=!0),a.glCurrentAttribLocs[i]=!0,r.vertexAttribPointer(i,s.count,s.glType,s.isNormalized,s.stride,o),t&&t.vertexAttribDivisorANGLE(i,s.isInstanced?1:0)}}}const s=i.gpuIndexBuffer;s&&a.glElementArrayBuffer!==s.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s.glBuffer),a.glElementArrayBuffer=s.glBuffer);for(let t=0;t<e.capabilities.maxVertexAttributes;++t)a.glEnabledAttribLocs[t]!==a.glCurrentAttribLocs[t]&&(r.disableVertexAttribArray(t),a.glEnabledAttribLocs[t]=!1)}}if(t&&t.dynamicStates.length){const e=t.dynamicStates.length;for(let i=0;i<e;i++)switch(t.dynamicStates[i]){case lo.VIEWPORT:{const e=o.viewport;a.viewport.left===e.left&&a.viewport.top===e.top&&a.viewport.width===e.width&&a.viewport.height===e.height||(r.viewport(e.left,e.top,e.width,e.height),a.viewport.left=e.left,a.viewport.top=e.top,a.viewport.width=e.width,a.viewport.height=e.height);break}case lo.SCISSOR:{const e=o.scissor;a.scissorRect.x===e.x&&a.scissorRect.y===e.y&&a.scissorRect.width===e.width&&a.scissorRect.height===e.height||(r.scissor(e.x,e.y,e.width,e.height),a.scissorRect.x=e.x,a.scissorRect.y=e.y,a.scissorRect.width=e.width,a.scissorRect.height=e.height);break}case lo.LINE_WIDTH:a.rs.lineWidth!==o.lineWidth&&(r.lineWidth(o.lineWidth),a.rs.lineWidth=o.lineWidth);break;case lo.DEPTH_BIAS:a.rs.depthBias===o.depthBiasConstant&&a.rs.depthBiasSlop===o.depthBiasSlope||(r.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),a.rs.depthBias=o.depthBiasConstant,a.rs.depthBiasSlop=o.depthBiasSlope);break;case lo.BLEND_CONSTANTS:{const e=o.blendConstant;a.bs.blendColor.x===e.x&&a.bs.blendColor.y===e.y&&a.bs.blendColor.z===e.z&&a.bs.blendColor.w===e.w||(r.blendColor(e.x,e.y,e.z,e.w),a.bs.blendColor.copy(e));break}case lo.STENCIL_WRITE_MASK:{const e=o.stencilStatesFront,t=o.stencilStatesBack;a.dss.stencilWriteMaskFront!==e.writeMask&&(r.stencilMaskSeparate(r.FRONT,e.writeMask),a.dss.stencilWriteMaskFront=e.writeMask),a.dss.stencilWriteMaskBack!==t.writeMask&&(r.stencilMaskSeparate(r.BACK,t.writeMask),a.dss.stencilWriteMaskBack=t.writeMask);break}case lo.STENCIL_COMPARE_MASK:{const e=o.stencilStatesFront,t=o.stencilStatesBack;a.dss.stencilRefFront===e.reference&&a.dss.stencilReadMaskFront===e.compareMask||(r.stencilFuncSeparate(r.FRONT,DN[a.dss.stencilFuncFront],e.reference,e.compareMask),a.dss.stencilRefFront=e.reference,a.dss.stencilReadMaskFront=e.compareMask),a.dss.stencilRefBack===t.reference&&a.dss.stencilReadMaskBack===t.compareMask||(r.stencilFuncSeparate(r.BACK,DN[a.dss.stencilFuncBack],t.reference,t.compareMask),a.dss.stencilRefBack=t.reference,a.dss.stencilReadMaskBack=t.compareMask);break}}}}function KN(e,t){const{gl:i}=e,n=e.ANGLE_instanced_arrays,{gpuInputAssembler:s,glPrimitive:o}=qN;if(s)if(s.gpuIndirectBuffer){const e=s.gpuIndirectBuffer.indirects.length;for(let t=0;t<e;t++){const e=s.gpuIndirectBuffer.indirects[t],r=s.gpuIndexBuffer;if(e.instanceCount&&n)if(r){if(e.indexCount>0){const t=e.firstIndex*r.stride;n.drawElementsInstancedANGLE(o,e.indexCount,s.glIndexType,t,e.instanceCount)}}else e.vertexCount>0&&n.drawArraysInstancedANGLE(o,e.firstVertex,e.vertexCount,e.instanceCount);else if(r){if(e.indexCount>0){const t=e.firstIndex*r.stride;i.drawElements(o,e.indexCount,s.glIndexType,t)}}else e.vertexCount>0&&i.drawArrays(o,e.firstVertex,e.vertexCount)}}else{const e=s.gpuIndexBuffer;if(t.instanceCount&&n)if(e){if(t.indexCount>0){const i=t.firstIndex*e.stride;n.drawElementsInstancedANGLE(o,t.indexCount,s.glIndexType,i,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstancedANGLE(o,t.firstVertex,t.vertexCount,t.instanceCount);else if(e){if(t.indexCount>0){const n=t.firstIndex*e.stride;i.drawElements(o,t.indexCount,s.glIndexType,n)}}else t.vertexCount>0&&i.drawArrays(o,t.firstVertex,t.vertexCount)}}const $N=new Array(zN.COUNT);function QN(e,t){$N.fill(0);for(let i=0;i<t.cmds.length;++i){const n=t.cmds.array[i],s=$N[n]++;switch(n){case zN.BEGIN_RENDER_PASS:{const i=t.beginRenderPassCmds.array[s];XN(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break}case zN.BIND_STATES:{const i=t.bindStatesCmds.array[s];YN(e,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.dynamicStates);break}case zN.DRAW:KN(e,t.drawCmds.array[s].drawInfo);break;case zN.UPDATE_BUFFER:{const i=t.updateBufferCmds.array[s];WN(e,i.gpuBuffer,i.buffer,i.offset,i.size);break}case zN.COPY_BUFFER_TO_TEXTURE:{const i=t.copyBufferToTextureCmds.array[s];ZN(e,i.buffers,i.gpuTexture,i.regions);break}}}}function ZN(e,t,i,n){const{gl:s}=e,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);let r=0,a=1,c=1,l=0;const h=vr[i.format],{isCompressed:u}=h;switch(i.glTarget){case s.TEXTURE_2D:for(let o=0;o<n.length;o++){const l=n[o];a=l.texExtent.width,c=l.texExtent.height;const h=t[r++];u?i.glInternalFmt===yN.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,i.glInternalFmt,a,c,0,h):s.compressedTexSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,i.glFormat,h):s.texSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,i.glFormat,i.glType,h)}break;case s.TEXTURE_CUBE_MAP:for(let o=0;o<n.length;o++){const h=n[o],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(l=h.texSubres.baseArrayLayer;l<_;++l){a=h.texExtent.width,c=h.texExtent.height;const n=t[r++];u?i.glInternalFmt===yN.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,i.glInternalFmt,a,c,0,n):s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,c,i.glFormat,n):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,c,i.glFormat,i.glType,n)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&js.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}class JN extends zr{constructor(...e){super(...e),this._gpuBuffer=null,this._gpuBufferView=null,this._uniformBuffer=null}get gpuBuffer(){return this._gpuBuffer}get gpuBufferView(){return this._gpuBufferView}initialize(e){if("buffer"in e){this._isBufferView=!0;const t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Fs.INDIRECT&&(this._indirectBuffer=new No),this._usage&Fs.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&Fs.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&Fs.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){const{gl:i}=e,n=e.stateCache,s=t.memUsage&ks.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&Fs.VERTEX){t.glTarget=i.ARRAY_BUFFER;const o=i.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=qN.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Fs.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;const o=i.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=qN.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&Fs.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&Fs.INDIRECT||t.usage&Fs.TRANSFER_DST||t.usage&Fs.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}destroy(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)}resize(e){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){const{gl:i}=e,n=e.stateCache,s=t.memUsage&ks.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&Fs.VERTEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=qN.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,s):i.bufferData(i.ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&Fs.INDEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=qN.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Fs.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&Fs.INDIRECT||t.usage&Fs.TRANSFER_DST||t.usage&Fs.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e)))}update(e,t){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let i;i=void 0!==t?t:this._usage&Fs.INDIRECT?0:e.byteLength,WN(this._device,this._gpuBuffer,e,0,i)}}class eL{constructor(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new G(t);for(let i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}alloc(e){if(this._freeIdx<0){const t=2*this._frees.length,i=this._frees;this._frees=new Array(t);const n=t-i.length;for(let t=0;t<n;++t)this._frees[t]=new e;for(let e=n,s=0;e<t;++e,++s)this._frees[e]=i[s];this._freeIdx+=n}const t=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++t.refCount,t}free(e){0==--e.refCount&&this._freeCmds.push(e)}freeCmds(e){for(let t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}release(){for(let e=0;e<this._freeCmds.length;++e){const t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}class tL{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new eL(UN,1),this.bindStatesCmdPool=new eL(GN,1),this.drawCmdPool=new eL(kN,1),this.updateBufferCmdPool=new eL(HN,1),this.copyBufferToTextureCmdPool=new eL(VN,1)}clearCmds(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class iL extends Fr{constructor(...e){super(...e),this.cmdPackage=new jN,this._webGLAllocator=null,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets=[],this._curDynamicOffsets=Array(8).fill(0),this._curDynamicStates=new fr,this._isStateInvalied=!1}initialize(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;const t=this._device.bindingMappingInfo.bufferOffsets.length;for(let e=0;e<t;e++)this._curGPUDescriptorSets.push(null);return!0}destroy(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}begin(e,t=0,i){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(e,t,i,n,s,o){const r=this._webGLAllocator.beginRenderPassCmdPool.alloc(UN);r.gpuRenderPass=e.gpuRenderPass,r.gpuFramebuffer=t.gpuFramebuffer,r.renderArea=i,r.clearColors.length=n.length;for(let e=0;e<n.length;++e)r.clearColors[e]=n[e];r.clearDepth=s,r.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(r),this.cmdPackage.cmds.push(zN.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(e){const t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}bindDescriptorSet(e,t,i){const n=t.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=n,this._isStateInvalied=!0),i){var s;const t=null===(s=this._curGPUPipelineState)||void 0===s?void 0:s.gpuPipelineLayout;if(t){const n=this._curDynamicOffsets,s=t.dynamicOffsetOffsets[e];for(let e=0;e<i.length;e++)n[s+e]=i[e];this._isStateInvalied=!0}}}bindInputAssembler(e){const t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}setViewport(e){const t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)}setScissor(e){const t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)}setLineWidth(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)}setDepthBias(e,t,i){const n=this._curDynamicStates;n.depthBiasConstant===e&&n.depthBiasClamp===t&&n.depthBiasSlope===i||(n.depthBiasConstant=e,n.depthBiasClamp=t,n.depthBiasSlope=i,this._isStateInvalied=!0)}setBlendConstants(e){const t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)}setDepthBound(e,t){const i=this._curDynamicStates;i.depthMinBounds===e&&i.depthMaxBounds===t||(i.depthMinBounds=e,i.depthMaxBounds=t,this._isStateInvalied=!0)}setStencilWriteMask(e,t){const i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;e&ho.FRONT&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0),e&ho.BACK&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0)}setStencilCompareMask(e,t,i){const n=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&ho.FRONT&&(n.compareMask===i&&n.reference===t||(n.reference=t,n.compareMask=i,this._isStateInvalied=!0)),e&ho.BACK&&(s.compareMask===i&&s.reference===t||(s.reference=t,s.compareMask=i,this._isStateInvalied=!0))}draw(e){if(this._type===po.PRIMARY&&this._isInRenderPass||this._type===po.SECONDARY){this._isStateInvalied&&this.bindStates();const t=this._webGLAllocator.drawCmdPool.alloc(kN);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(zN.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;const i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(e,t,i){if(this._type===po.PRIMARY&&!this._isInRenderPass||this._type===po.SECONDARY){const n=e.gpuBuffer;if(n){const s=this._webGLAllocator.updateBufferCmdPool.alloc(HN);let o=0,r=null;e.usage&Fs.INDIRECT||(o=void 0!==i?i:t.byteLength),r=t,s.gpuBuffer=n,s.buffer=r,s.offset=0,s.size=o,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(zN.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(e,t,i){if(this._type===po.PRIMARY&&!this._isInRenderPass||this._type===po.SECONDARY){const n=t.gpuTexture;if(n){const t=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(VN);t&&(t.gpuTexture=n,t.regions=i,t.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(t),this.cmdPackage.cmds.push(zN.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(e,t){for(let i=0;i<t;++i){const t=e[i];for(let e=0;e<t.cmdPackage.beginRenderPassCmds.length;++e){const i=t.cmdPackage.beginRenderPassCmds.array[e];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(let e=0;e<t.cmdPackage.bindStatesCmds.length;++e){const i=t.cmdPackage.bindStatesCmds.array[e];++i.refCount,this.cmdPackage.bindStatesCmds.push(i)}for(let e=0;e<t.cmdPackage.drawCmds.length;++e){const i=t.cmdPackage.drawCmds.array[e];++i.refCount,this.cmdPackage.drawCmds.push(i)}for(let e=0;e<t.cmdPackage.updateBufferCmds.length;++e){const i=t.cmdPackage.updateBufferCmds.array[e];++i.refCount,this.cmdPackage.updateBufferCmds.push(i)}for(let e=0;e<t.cmdPackage.copyBufferToTextureCmds.length;++e){const i=t.cmdPackage.copyBufferToTextureCmds.array[e];++i.refCount,this.cmdPackage.copyBufferToTextureCmds.push(i)}this.cmdPackage.cmds.concat(t.cmdPackage.cmds.array),this._numDrawCalls+=t._numDrawCalls,this._numInstances+=t._numInstances,this._numTris+=t._numTris}}pipelineBarrier(e,t){}get webGLDevice(){return this._device}bindStates(){const e=this._webGLAllocator.bindStatesCmdPool.alloc(GN);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(zN.BIND_STATES),this._isStateInvalied=!1)}}class nL extends Gr{constructor(...e){super(...e),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;const t=[];for(let i=0;i<e.colorTextures.length;++i){const n=e.colorTextures[i];n&&t.push(n.gpuTexture)}let i=null;return e.depthStencilTexture&&(i=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:i,glFramebuffer:null},function(e,t){if(!t.gpuColorTextures.length&&!t.gpuDepthStencilTexture)return;const{gl:i}=e,n=[],s=i.createFramebuffer();if(s){t.glFramebuffer=s,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(let e=0;e<t.gpuColorTextures.length;++e){const s=t.gpuColorTextures[e];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.RENDERBUFFER,s.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+e))}const o=t.gpuDepthStencilTexture;if(o){const e=vr[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,e,o.glTarget,o.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,e,i.RENDERBUFFER,o.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);const r=i.checkFramebufferStatus(i.FRAMEBUFFER);if(r!==i.FRAMEBUFFER_COMPLETE)switch(r){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(this._device,this._gpuFramebuffer),!0}destroy(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)}}class sL extends jr{constructor(...e){super(...e),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(e){if(0===e.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{const e=this._vertexBuffers[0];this._vertexCount=e.size/e.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;const t=new Array(e.vertexBuffers.length);for(let i=0;i<e.vertexBuffers.length;++i){const n=e.vertexBuffers[i];n.gpuBuffer&&(t[i]=n.gpuBuffer)}let i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}let s=null;return e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:t,gpuIndexBuffer:i,gpuIndirectBuffer:s,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){const{gl:i}=e;t.glAttribs=new Array(t.attributes.length);const n=[0,0,0,0,0,0,0,0];for(let e=0;e<t.attributes.length;++e){const s=t.attributes[e],o=void 0!==s.stream?s.stream:0,r=t.gpuVertexBuffers[o],a=wN(s.format,i),{size:c}=vr[s.format];t.glAttribs[e]={name:s.name,glBuffer:r.glBuffer,glType:a,size:c,count:vr[s.format].count,stride:r.stride,componentCount:ON(a,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[o]},n[o]+=c}}(this._device,this._gpuInputAssembler),!0}destroy(){const e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){const i=t.glVAOs.values();let n=i.next();for(;!n.done;)e.OES_vertex_array_object.deleteVertexArrayOES(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}}class oL extends Wr{constructor(...e){super(...e),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(e){Array.prototype.push.apply(this._bindings,e.bindings);let t=0,i=-1;const n=[];for(let e=0;e<this._bindings.length;e++){const s=this._bindings[e];n.push(t),t+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);const s=this._descriptorIndices=Array(i+1).fill(-1);for(let e=0;e<this._bindings.length;e++){const t=this._bindings[e];this._bindingIndices[t.binding]=e,s[t.binding]=n[e]}const o=[];for(let e=0;e<this._bindings.length;e++){const t=this._bindings[e];if(t.descriptorType&Sr)for(let e=0;e<t.count;e++)o.push(t.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:o,descriptorIndices:s,descriptorCount:t},!0}destroy(){this._bindings.length=0}}class rL extends qr{constructor(...e){super(...e),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);const t=[],i=[];let n=0;const s=[];for(let e=0;e<this._setLayouts.length;e++){const o=this._setLayouts[e],r=o.gpuDescriptorSetLayout.dynamicBindings,a=Array(o.bindingIndices.length).fill(-1);for(let e=0;e<r.length;e++){const t=r[e];a[t]<0&&(a[t]=n+e)}i.push(o.gpuDescriptorSetLayout),t.push(a),s.push(n),n+=r.length}return this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:t,dynamicOffsetCount:n,dynamicOffsetOffsets:s},!0}destroy(){this._setLayouts.length=0}}class aL{get native(){return this}constructor(e=!1,t=ro.FILL,i=ao.GOURAND,n=co.BACK,s=!0,o=!1,r=0,a=0,c=0,l=!0,h=!1,u=1){this.isDiscard=e,this.polygonMode=t,this.shadeModel=i,this.cullMode=n,this.isFrontFaceCCW=s,this.depthBiasEnabled=o,this.depthBias=r,this.depthBiasClamp=a,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=h,this.lineWidth=u}reset(){this.isDiscard=!1,this.polygonMode=ro.FILL,this.shadeModel=ao.GOURAND,this.cullMode=co.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}assign(e){Object.assign(this,e)}destroy(){}}class cL{get native(){return this}constructor(e=!0,t=!0,i=Ys.LESS,n=!1,s=Ys.ALWAYS,o=65535,r=65535,a=Ks.KEEP,c=Ks.KEEP,l=Ks.KEEP,h=1,u=!1,_=Ys.ALWAYS,p=65535,d=65535,f=Ks.KEEP,m=Ks.KEEP,g=Ks.KEEP,v=1){this.depthTest=e,this.depthWrite=t,this.depthFunc=i,this.stencilTestFront=n,this.stencilFuncFront=s,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=r,this.stencilFailOpFront=a,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=h,this.stencilTestBack=u,this.stencilFuncBack=_,this.stencilReadMaskBack=p,this.stencilWriteMaskBack=d,this.stencilFailOpBack=f,this.stencilZFailOpBack=m,this.stencilPassOpBack=g,this.stencilRefBack=v}reset(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Ys.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Ys.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Ks.KEEP,this.stencilZFailOpFront=Ks.KEEP,this.stencilPassOpFront=Ks.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Ys.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Ks.KEEP,this.stencilZFailOpBack=Ks.KEEP,this.stencilPassOpBack=Ks.KEEP,this.stencilRefBack=1}assign(e){Object.assign(this,e)}destroy(){}}class lL{constructor(e=!1,t=$s.ONE,i=$s.ZERO,n=Qs.ADD,s=$s.ONE,o=$s.ZERO,r=Qs.ADD,a=Zs.ALL){this.blend=e,this.blendSrc=t,this.blendDst=i,this.blendEq=n,this.blendSrcAlpha=s,this.blendDstAlpha=o,this.blendAlphaEq=r,this.blendColorMask=a}reset(){this.blend=!1,this.blendSrc=$s.ONE,this.blendDst=$s.ZERO,this.blendEq=Qs.ADD,this.blendSrcAlpha=$s.ONE,this.blendDstAlpha=$s.ZERO,this.blendAlphaEq=Qs.ADD,this.blendColorMask=Zs.ALL}assign(e){Object.assign(this,e)}destroy(){}}class hL{get native(){return this}constructor(e=!1,t=!1,i=new Po,n=[new lL]){this.isA2C=e,this.isIndepend=t,this.blendColor=i,this.targets=n}setTarget(e,t){let i=this.targets[e];i||(i=this.targets[e]=new lL),Object.assign(i,t)}reset(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()}destroy(){}}class uL extends mr{get shader(){return this._shader}get pipelineLayout(){return this._pipelineLayout}get primitive(){return this._primitive}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get inputState(){return this._is}get dynamicStates(){return this._dynamicStates}get renderPass(){return this._renderPass}constructor(e){super(Is.PIPELINE_STATE),this._device=void 0,this._shader=null,this._pipelineLayout=null,this._primitive=oo.TRIANGLE_LIST,this._is=null,this._rs=new aL,this._dss=new cL,this._bs=new hL,this._dynamicStates=lo.NONE,this._renderPass=null,this._device=e}}const _L=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class pL extends uL{constructor(...e){super(...e),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;const t=this._bs;if(e.blendState){const i=e.blendState,{targets:n}=i;n&&n.forEach(((e,i)=>{t.setTarget(i,e)})),void 0!==i.isA2C&&(t.isA2C=i.isA2C),void 0!==i.isIndepend&&(t.isIndepend=i.isIndepend),void 0!==i.blendColor&&(t.blendColor=i.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;const i=[];for(let e=0;e<31;e++)this._dynamicStates&1<<e&&i.push(1<<e);return this._gpuPipelineState={glPrimitive:_L[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:i},!0}destroy(){this._gpuPipelineState=null}}class dL extends iL{beginRenderPass(e,t,i,n,s,o){XN(this._device,e.gpuRenderPass,t.gpuFramebuffer,i,n,s,o),this._isInRenderPass=!0}draw(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),KN(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;const t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(e,t,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const n=e.gpuBuffer;if(n){let s;s=void 0!==i?i:e.usage&Fs.INDIRECT?0:t.byteLength,WN(this._device,n,t,0,s)}}}copyBuffersToTexture(e,t,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const n=t.gpuTexture;n&&ZN(this._device,e,n,i)}}execute(e,t){for(let i=0;i<t;++i){const t=e[i];QN(this._device,t.cmdPackage),this._numDrawCalls+=t._numDrawCalls,this._numInstances+=t._numInstances,this._numTris+=t._numTris}}bindStates(){YN(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}}class fL extends Xr{constructor(...e){super(...e),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(e){return this._type=e.type,!0}destroy(){}submit(e){if(!this._isAsync){const t=e.length;for(let i=0;i<t;i++){const t=e[i];this.numDrawCalls+=t.numDrawCalls,this.numInstances+=t.numInstances,this.numTris+=t.numTris}}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class mL extends Yr{constructor(...e){super(...e),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subpasses&&(this._subpasses=e.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}destroy(){this._gpuRenderPass=null}}const gL=[10497,33648,33071,33071];class vL extends Kr{constructor(...e){super(...e),this._gpuSampler=null}get gpuSampler(){return this._gpuSampler}initialize(e){this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._mipLODBias=e.mipLODBias;let t=0,i=0;const n=this._minFilter,s=this._magFilter,o=this._mipFilter;t=n===qs.LINEAR||n===qs.ANISOTROPIC?o===qs.LINEAR||o===qs.ANISOTROPIC?9987:o===qs.POINT?9985:9729:o===qs.LINEAR||o===qs.ANISOTROPIC?9986:o===qs.POINT?9984:9728,i=s===qs.LINEAR||s===qs.ANISOTROPIC?9729:9728;const r=gL[this._addressU],a=gL[this._addressV],c=gL[this._addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:r,glWrapT:a,glWrapR:c},!0}destroy(){this._gpuSampler=null}}class yL extends $r{constructor(...e){super(...e),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplerTextures:e.samplerTextures,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let t=0;t<e.stages.length;++t){const i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.stage,source:i.source,glShader:null}}return function(e,t){const{gl:i}=e;for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];let s=0,o="",r=1;switch(n.type){case Js.VERTEX:o="VertexShader",s=i.VERTEX_SHADER;break;case Js.FRAGMENT:o="FragmentShader",s=i.FRAGMENT_SHADER;break;default:return void console.error("Unsupported ShaderType.")}const a=i.createShader(s);if(a&&(n.glShader=a,i.shaderSource(n.glShader,n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(`${o} in '${t.name}' compilation failed.`),console.error("Shader source dump:",n.source.replace(/^|\n/g,(()=>`\n${r++} `))),console.error(i.getShaderInfoLog(n.glShader));for(let n=0;n<t.gpuStages.length;n++){const n=t.gpuStages[e];n.glShader&&(i.deleteShader(n.glShader),n.glShader=null)}return}}const n=i.createProgram();if(!n)return;t.glProgram=n;for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];i.attachShader(t.glProgram,n.glShader)}if(i.linkProgram(t.glProgram),e.destroyShadersImmediately)for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];n.glShader&&(i.detachShader(t.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}if(!i.getProgramParameter(t.glProgram,i.LINK_STATUS))return console.error(`Failed to link shader '${t.name}'.`),void console.error(i.getProgramInfoLog(t.glProgram));m(`Shader '${t.name}' compilation succeeded.`);const s=i.getProgramParameter(t.glProgram,i.ACTIVE_ATTRIBUTES);t.glInputs=new Array(s);for(let e=0;e<s;++e){const n=i.getActiveAttrib(t.glProgram,e);if(n){let s;const o=n.name.indexOf("[");s=-1!==o?n.name.substr(0,o):n.name;const r=i.getAttribLocation(t.glProgram,s),a=IN(n.type,i),c=MN(n.type,i);t.glInputs[e]={binding:r,name:s,type:a,stride:c,count:n.size,size:c*n.size,glType:n.type,glLoc:r}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(let e=0;e<t.blocks.length;++e){const n=t.blocks[e],s={set:n.set,binding:n.binding,name:n.name,size:0,glUniforms:new Array(n.members.length),glActiveUniforms:[]};t.glBlocks[e]=s;for(let e=0;e<n.members.length;++e){const t=n.members[e],o=PN(t.type,i),r=MN(o,i),a=r*t.count;s.glUniforms[e]={binding:-1,name:t.name,type:t.type,stride:r,count:t.count,size:a,offset:0,glType:o,glLoc:-1,array:null}}}}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(let e=0;e<t.samplerTextures.length;++e){const n=t.samplerTextures[e];t.glSamplerTextures[e]={set:n.set,binding:n.binding,name:n.name,type:n.type,count:n.count,units:[],glUnits:null,glType:PN(n.type,i),glLoc:null}}}const o=i.getProgramParameter(t.glProgram,i.ACTIVE_UNIFORMS);for(let e=0;e<o;++e){const n=i.getActiveUniform(t.glProgram,e);if(n&&n.type!==i.SAMPLER_2D&&n.type!==i.SAMPLER_CUBE){const e=i.getUniformLocation(t.glProgram,n.name);if(null!==e&&("number"==typeof e||-1!==e.id)){let i;const s=n.name.indexOf("[");i=-1!==s?n.name.substr(0,s):n.name;for(let s=0;s<t.glBlocks.length;s++){const o=t.glBlocks[s];for(let t=0;t<o.glUniforms.length;t++){const s=o.glUniforms[t];if(s.name===i){s.glLoc=e,s.count=n.size,s.size=s.stride*s.count,s.array=new(RN(s.type))(s.size/4),o.glActiveUniforms.push(s);break}}}}}}for(let e=0;e<t.glBlocks.length;e++){const i=t.glBlocks[e];for(let e=0;e<i.glUniforms.length;e++){const t=i.glUniforms[e];t.offset=i.size/4,i.size+=t.size}}const r=[],a=[],{bindingMappingInfo:c}=e,{texUnitCacheMap:l}=e.stateCache;let h=0;for(let e=0;e<t.blocks.length;++e)t.blocks[e].set===c.flexibleSet&&h++;let u=0;for(let n=0;n<t.samplerTextures.length;++n){const s=t.samplerTextures[n],o=i.getUniformLocation(t.glProgram,s.name);if(null===o||"number"!=typeof o&&-1===o.id||(r.push(t.glSamplerTextures[n]),a.push(o)),void 0===l[s.name]){let t=s.binding+c.samplerOffsets[s.set]+u;s.set===c.flexibleSet&&(t-=h),l[s.name]=t%e.capabilities.maxTextureUnits,u+=s.count-1}}if(r.length){const n=[];for(let t=0;t<r.length;++t){const i=r[t];let s=l[i.name];if(void 0!==s){i.glLoc=a[t];for(let t=0;t<i.count;++t){for(;n[s];)s=(s+1)%e.capabilities.maxTextureUnits;i.units.push(s),n[s]=!0}}}let s=0;for(let t=0;t<r.length;++t){const i=r[t];if(!i.glLoc){i.glLoc=a[t];for(let t=0;t<i.count;++t){for(;n[s];)s=(s+1)%e.capabilities.maxTextureUnits;void 0===l[i.name]&&(l[i.name]=s),i.units.push(s),n[s]=!0}}}e.stateCache.glProgram!==t.glProgram&&i.useProgram(t.glProgram);for(let e=0;e<r.length;e++){const t=r[e];t.glUnits=new Int32Array(t.units),i.uniform1iv(t.glLoc,t.glUnits)}e.stateCache.glProgram!==t.glProgram&&i.useProgram(e.stateCache.glProgram)}for(let e=0;e<t.glBlocks.length;)t.glBlocks[e].glActiveUniforms.length?e++:(t.glBlocks[e]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=r}(this._device,this._gpuShader),!0}destroy(){this._gpuShader&&(function(e,t){if(t.glProgram){const{gl:i}=e;if(!e.destroyShadersImmediately)for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];n.glShader&&(i.detachShader(t.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}i.deleteProgram(t.glProgram),t.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)}}class xL{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new Ao,this.scissorRect=new xo(0,0,0,0),this.rs=new aL,this.dss=new cL,this.bs=new hL,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(e,t){for(let t=0;t<e;++t)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)}}class SL extends Qr{constructor(...e){super(...e),this._gpuTexture=null}get gpuTexture(){return this._gpuTexture}initialize(e){return"texture"in e?(console.log("WebGL does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=Tr(this._width)&&Tr(this._height),this._size=Cr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){const{gl:i}=e;t.glFormat=t.glInternalFmt=AN(t.format,i),t.glType=wN(t.format,i);let n=t.width,s=t.height;switch(t.type){case Hs.TEX2D:{t.glTarget=i.TEXTURE_2D;const o=Math.max(n,s);if(o>e.capabilities.maxTextureSize&&C(9100,o,e.capabilities.maxTextureSize),!e.WEBGL_depth_texture&&vr[t.format].hasDepth){t.glInternalFmt=function(e,t){switch(e){case Ls.R5G6B5:return t.RGB565;case Ls.RGB5A1:return t.RGB5_A1;case Ls.RGBA4:return t.RGBA4;case Ls.RGBA16F:return yN.RGBA16F_EXT;case Ls.RGBA32F:return yN.RGBA32F_EXT;case Ls.SRGB8_A8:return yN.SRGB8_ALPHA8_EXT;case Ls.D16:return t.DEPTH_COMPONENT16;case Ls.D16S8:return t.DEPTH_STENCIL;case Ls.D24:return t.DEPTH_COMPONENT16;case Ls.D24S8:return t.DEPTH_STENCIL;case Ls.D32F:return t.DEPTH_COMPONENT16;case Ls.D32F_S8:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,i);const o=i.createRenderbuffer();o&&t.size>0&&(t.glRenderbuffer=o,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,s))}else{const o=i.createTexture();if(o&&t.size>0){t.glTexture=o;const r=e.stateCache.glTexUnits[e.stateCache.texUnit];if(r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),r.glTexture=t.glTexture),vr[t.format].isCompressed)if(t.glInternalFmt!==yN.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<t.mipLevel;++e){const o=Er(t.format,n,s,1),r=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,r),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else{const e=Er(t.format,2,2,1),n=new Uint8Array(e);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternalFmt,2,2,0,n)}else for(let e=0;e<t.mipLevel;++e)i.texImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}else i.deleteTexture(o)}break}case Hs.CUBE:{t.glTarget=i.TEXTURE_CUBE_MAP;const o=Math.max(n,s);o>e.capabilities.maxCubeMapTextureSize&&C(9100,o,e.capabilities.maxTextureSize);const r=i.createTexture();if(r&&t.size>0){t.glTexture=r;const o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),o.glTexture=t.glTexture),vr[t.format].isCompressed)if(t.glInternalFmt!==yN.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<6;++e){n=t.width,s=t.height;for(let o=0;o<t.mipLevel;++o){const r=Er(t.format,n,s,1),a=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,o,t.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let e=0;e<6;++e){const n=Er(t.format,2,2,1),s=new Uint8Array(n);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.glInternalFmt,2,2,0,s)}else for(let e=0;e<6;++e){n=t.width,s=t.height;for(let o=0;o<t.mipLevel;++o)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,o,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break}default:console.error("Unsupported TextureType, create texture failed."),t.type=Hs.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}destroy(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}resize(e,t){const i=this._size;this._width=e,this._height=t,this._size=Cr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){const{gl:i}=e;let n=t.width,s=t.height;switch(t.type){case Hs.TEX2D:{t.glTarget=i.TEXTURE_2D;const o=Math.max(n,s);if(o>e.capabilities.maxTextureSize&&C(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,s);else if(t.glTexture){const o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),vr[t.format].isCompressed){if(t.glInternalFmt!==yN.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<t.mipLevel;++e){const o=Er(t.format,n,s,1),r=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,r),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let e=0;e<t.mipLevel;++e)i.texImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}case Hs.CUBE:{t.glTarget=i.TEXTURE_CUBE_MAP;const o=Math.max(n,s);o>e.capabilities.maxCubeMapTextureSize&&C(9100,o,e.capabilities.maxTextureSize);const r=e.stateCache.glTexUnits[e.stateCache.texUnit];if(r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),r.glTexture=t.glTexture),vr[t.format].isCompressed){if(t.glInternalFmt!==yN.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<6;++e){n=t.width,s=t.height;for(let o=0;o<t.mipLevel;++o){const r=Er(t.format,n,s,1),a=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,o,t.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}}else for(let e=0;e<6;++e){n=t.width,s=t.height;for(let o=0;o<t.mipLevel;++o)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,o,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported TextureType, create texture failed."),t.type=Hs.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}}const bL="webglcontextlost";class TL extends Ur{constructor(...e){super(...e),this.stateCache=new xL,this.cmdAllocator=new tL,this.nullTex2D=null,this.nullTexCube=null,this._webGLRC=null,this._isAntialias=!0,this._isPremultipliedAlpha=!0,this._useVAO=!1,this._destroyShadersImmediately=!0,this._noCompressedTexSubImage2D=!1,this._bindingMappingInfo=new Ro,this._webGLContextLostHandler=null,this._extensions=null,this._EXT_texture_filter_anisotropic=null,this._EXT_blend_minmax=null,this._EXT_frag_depth=null,this._EXT_shader_texture_lod=null,this._EXT_sRGB=null,this._OES_vertex_array_object=null,this._EXT_color_buffer_half_float=null,this._WEBGL_color_buffer_float=null,this._WEBGL_compressed_texture_etc1=null,this._WEBGL_compressed_texture_etc=null,this._WEBGL_compressed_texture_pvrtc=null,this._WEBGL_compressed_texture_astc=null,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._WEBGL_debug_shaders=null,this._WEBGL_draw_buffers=null,this._WEBGL_lose_context=null,this._WEBGL_depth_texture=null,this._WEBGL_debug_renderer_info=null,this._OES_texture_half_float=null,this._OES_texture_half_float_linear=null,this._OES_texture_float=null,this._OES_texture_float_linear=null,this._OES_standard_derivatives=null,this._OES_element_index_uint=null,this._ANGLE_instanced_arrays=null}get gl(){return this._webGLRC}get webGLQueue(){return this._queue}get isAntialias(){return this._isAntialias}get isPremultipliedAlpha(){return this._isPremultipliedAlpha}get useVAO(){return this._useVAO}get destroyShadersImmediately(){return this._destroyShadersImmediately}get noCompressedTexSubImage2D(){return this._noCompressedTexSubImage2D}get bindingMappingInfo(){return this._bindingMappingInfo}get EXT_texture_filter_anisotropic(){return this._EXT_texture_filter_anisotropic}get EXT_blend_minmax(){return this._EXT_blend_minmax}get EXT_frag_depth(){return this._EXT_frag_depth}get EXT_shader_texture_lod(){return this._EXT_shader_texture_lod}get EXT_sRGB(){return this._EXT_sRGB}get OES_vertex_array_object(){return this._OES_vertex_array_object}get WEBGL_color_buffer_float(){return this._WEBGL_color_buffer_float}get WEBGL_compressed_texture_etc1(){return this._WEBGL_compressed_texture_etc1}get WEBGL_compressed_texture_pvrtc(){return this._WEBGL_compressed_texture_pvrtc}get WEBGL_compressed_texture_astc(){return this._WEBGL_compressed_texture_astc}get WEBGL_compressed_texture_s3tc(){return this._WEBGL_compressed_texture_s3tc}get WEBGL_compressed_texture_s3tc_srgb(){return this._WEBGL_compressed_texture_s3tc_srgb}get WEBGL_debug_shaders(){return this._WEBGL_debug_shaders}get WEBGL_draw_buffers(){return this._WEBGL_draw_buffers}get WEBGL_lose_context(){return this._WEBGL_lose_context}get WEBGL_depth_texture(){return this._WEBGL_depth_texture}get WEBGL_debug_renderer_info(){return this._WEBGL_debug_renderer_info}get OES_texture_half_float(){return this._OES_texture_half_float}get OES_texture_half_float_linear(){return this._OES_texture_half_float_linear}get OES_texture_float(){return this._OES_texture_float}get OES_standard_derivatives(){return this._OES_standard_derivatives}get OES_element_index_uint(){return this._OES_element_index_uint}get ANGLE_instanced_arrays(){return this._ANGLE_instanced_arrays}initialize(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{const e={alpha:Ge.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",e)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(bL,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Os.WEBGL,this._deviceName="WebGL";const t=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=t.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR)),this._version=t.getParameter(t.VERSION),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.depthBits=t.getParameter(t.DEPTH_BITS),this._caps.stencilBits=t.getParameter(t.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=e.width,this._height=e.height,this._colorFmt=Ls.RGBA8,24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=Ls.D24S8:this._depthStencilFmt=Ls.D24:8===this._caps.stencilBits?this._depthStencilFmt=Ls.D16S8:this._depthStencilFmt=Ls.D16,this._extensions=t.getSupportedExtensions();let i="";if(this._extensions){for(const e of this._extensions)i+=`${e} `;m(`EXTENSIONS: ${i}`)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_blend_minmax=this.getExtension("EXT_blend_minmax"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),xn.os===B.IOS&&14===xn.osMainVersion&&xn.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),xn.browserType===D.UC&&(this._ANGLE_instanced_arrays=null),xn.os===B.IOS&&xn.osMainVersion<=10&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._EXT_sRGB&&(this._features[Ns.FORMAT_SRGB]=!0),this._EXT_blend_minmax&&(this._features[Ns.BLEND_MINMAX]=!0),this._WEBGL_color_buffer_float&&(this._features[Ns.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[Ns.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[Ns.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[Ns.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Ns.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Ns.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Ns.FORMAT_RGB8]=!0,this._OES_element_index_uint&&(this._features[Ns.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[Ns.INSTANCED_ARRAYS]=!0),this._WEBGL_draw_buffers&&(this._features[Ns.MULTIPLE_RENDER_TARGETS]=!0);let n="";this._WEBGL_compressed_texture_etc1&&(this._features[Ns.FORMAT_ETC1]=!0,n+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Ns.FORMAT_ETC2]=!0,n+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Ns.FORMAT_DXT]=!0,n+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Ns.FORMAT_PVRTC]=!0,n+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Ns.FORMAT_ASTC]=!0,n+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),m(`RENDERER: ${this._renderer}`),m(`VENDOR: ${this._vendor}`),m(`VERSION: ${this._version}`),m(`DPR: ${this._devicePixelRatio}`),m(`SCREEN_SIZE: ${this._width} x ${this._height}`),m(`MAX_VERTEX_UNIFORM_VECTORS: ${this._caps.maxVertexUniformVectors}`),m(`DEPTH_BITS: ${this._caps.depthBits}`),m(`STENCIL_BITS: ${this._caps.stencilBits}`),this._EXT_texture_filter_anisotropic&&m(`MAX_TEXTURE_MAX_ANISOTROPY_EXT: ${this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT}`),m(`USE_VAO: ${this._useVAO}`),m(`COMPRESSED_FORMAT: ${n}`),this.initStates(t),this._queue=this.createQueue(new ur(_o.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new hr(this._queue)),this.nullTex2D=this.createTexture(new Lo(Hs.TEX2D,Vs.SAMPLED,Ls.RGBA8,2,2,js.GEN_MIPMAP)),this.nullTexCube=this.createTexture(new Lo(Hs.CUBE,Vs.SAMPLED,Ls.RGBA8,2,2,js.GEN_MIPMAP,6));const s=new wo;s.texExtent.width=2,s.texExtent.height=2;const o=new Uint8Array(this.nullTex2D.size);return o.fill(0),this.copyBuffersToTexture([o],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([o,o,o,o,o,o],this.nullTexCube,[s]),!0}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(bL,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGLRC=null}resize(e,t){this._width===e&&this._height===t||(m(`Resizing device: ${e}x${t}`),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}flushCommands(e){}acquire(){this.cmdAllocator.releaseCmds()}present(){const e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}createCommandBuffer(e){const t=new(e.type===po.PRIMARY?dL:iL)(this);return t.initialize(e)?t:null}createBuffer(e){const t=new JN(this);return t.initialize(e)?t:null}createTexture(e){const t=new SL(this);return t.initialize(e)?t:null}createSampler(e){const t=new vL(this);return t.initialize(e)?t:null}createDescriptorSet(e){const t=new CN(this);return t.initialize(e)?t:null}createShader(e){const t=new yL(this);return t.initialize(e)?t:null}createInputAssembler(e){const t=new sL(this);return t.initialize(e)?t:null}createRenderPass(e){const t=new mL(this);return t.initialize(e)?t:null}createFramebuffer(e){const t=new nL(this);return t.initialize(e)?t:null}createDescriptorSetLayout(e){const t=new oL(this);return t.initialize(e)?t:null}createPipelineLayout(e){const t=new rL(this);return t.initialize(e)?t:null}createPipelineState(e){const t=new pL(this);return t.initialize(e)?t:null}createQueue(e){const t=new fL(this);return t.initialize(e)?t:null}createGlobalBarrier(e){const t=new Zr(this);return t.initialize(e)?t:null}createTextureBarrier(e){const t=new Jr(this);return t.initialize(e)?t:null}copyBuffersToTexture(e,t,i){ZN(this,e,t.gpuTexture,i)}copyTextureToBuffers(e,t,i){!function(e,t,i,n){const{gl:s}=e,o=e.stateCache,r=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,r);let a=0,c=0,l=1,h=1;switch(t.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const o=n[e];s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,o.texSubres.mipLevel),a=o.texOffset.x,c=o.texOffset.y,l=o.texExtent.width,h=o.texExtent.height,s.readPixels(a,c,l,h,t.glFormat,t.glType,i[e])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}s.bindFramebuffer(s.FRAMEBUFFER,null),o.glFramebuffer=null,s.deleteFramebuffer(r)}(this,e.gpuTexture,t,i)}copyTexImagesToTexture(e,t,i){!function(e,t,i,n){const{gl:s}=e,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);let r=0,a=0;switch(i.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const o=n[e];s.texSubImage2D(s.TEXTURE_2D,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,i.glFormat,i.glType,t[r++])}break;case s.TEXTURE_CUBE_MAP:for(let e=0;e<n.length;e++){const o=n[e],c=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(a=o.texSubres.baseArrayLayer;a<c;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,i.glFormat,i.glType,t[r++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&js.GEN_MIPMAP&&i.isPowerOf2&&s.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}copyFramebufferToBuffer(e,t,i){const n=this._webGLRC,s=e.gpuFramebuffer,o=s.gpuColorTextures[0].format,r=AN(o,n),a=wN(o,n),c=Pr(vr[o]),l=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==s.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,s.glFramebuffer),this.stateCache.glFramebuffer=s.glFramebuffer);const h=new c(t);for(const e of i){const t=e.texExtent.width,i=e.texExtent.height;n.readPixels(e.texOffset.x,e.texOffset.y,t,i,r,a,h)}this.stateCache.glFramebuffer!==l&&(n.bindFramebuffer(n.FRAMEBUFFER,l),this.stateCache.glFramebuffer=l)}blitFramebuffer(e,t,i,n,s){}getExtension(e){const t=["","WEBKIT_","MOZ_"];for(let i=0;i<t.length;++i){const n=this.gl.getExtension(t[i]+e);if(n)return n}return null}initStates(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}_onWebGLContextLost(e){T(11e3),p(e)}}e("WebGLDevice",TL),n.WebGLDevice=TL;class EL extends Br{constructor(...e){super(...e),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(e){this._layout=e.layout;const{bindings:t,descriptorIndices:i,descriptorCount:n}=e.layout.gpuDescriptorSetLayout;this._buffers=Array(n).fill(null),this._textures=Array(n).fill(null),this._samplers=Array(n).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:i};for(let e=0;e<t.length;++e){const i=t[e];for(let e=0;e<i.count;e++)s.push({type:i.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}return!0}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const e=this._gpuDescriptorSet.gpuDescriptors;for(let t=0;t<e.length;++t)e[t].type&yr?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&xr&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}}const CL=[10497,33648,33071,33071],wL=new Float32Array(4);function AL(e,t){switch(e){case Ls.R8:return t.UNSIGNED_BYTE;case Ls.R8SN:return t.BYTE;case Ls.R8UI:return t.UNSIGNED_BYTE;case Ls.R8I:return t.BYTE;case Ls.R16F:return t.HALF_FLOAT;case Ls.R16UI:return t.UNSIGNED_SHORT;case Ls.R16I:return t.SHORT;case Ls.R32F:return t.FLOAT;case Ls.R32UI:return t.UNSIGNED_INT;case Ls.R32I:return t.INT;case Ls.RG8:return t.UNSIGNED_BYTE;case Ls.RG8SN:return t.BYTE;case Ls.RG8UI:return t.UNSIGNED_BYTE;case Ls.RG8I:return t.BYTE;case Ls.RG16F:return t.HALF_FLOAT;case Ls.RG16UI:return t.UNSIGNED_SHORT;case Ls.RG16I:return t.SHORT;case Ls.RG32F:return t.FLOAT;case Ls.RG32UI:return t.UNSIGNED_INT;case Ls.RG32I:return t.INT;case Ls.RGB8:case Ls.SRGB8:return t.UNSIGNED_BYTE;case Ls.RGB8SN:return t.BYTE;case Ls.RGB8UI:return t.UNSIGNED_BYTE;case Ls.RGB8I:return t.BYTE;case Ls.RGB16F:return t.HALF_FLOAT;case Ls.RGB16UI:return t.UNSIGNED_SHORT;case Ls.RGB16I:return t.SHORT;case Ls.RGB32F:return t.FLOAT;case Ls.RGB32UI:return t.UNSIGNED_INT;case Ls.RGB32I:return t.INT;case Ls.BGRA8:case Ls.RGBA8:case Ls.SRGB8_A8:return t.UNSIGNED_BYTE;case Ls.RGBA8SN:return t.BYTE;case Ls.RGBA8UI:return t.UNSIGNED_BYTE;case Ls.RGBA8I:return t.BYTE;case Ls.RGBA16F:return t.HALF_FLOAT;case Ls.RGBA16UI:return t.UNSIGNED_SHORT;case Ls.RGBA16I:return t.SHORT;case Ls.RGBA32F:return t.FLOAT;case Ls.RGBA32UI:return t.UNSIGNED_INT;case Ls.RGBA32I:return t.INT;case Ls.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Ls.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case Ls.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Ls.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Ls.RGB10A2:case Ls.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case Ls.RGB9E5:return t.FLOAT;case Ls.D16:return t.UNSIGNED_SHORT;case Ls.D16S8:return t.UNSIGNED_INT_24_8;case Ls.D24:return t.UNSIGNED_INT;case Ls.D24S8:return t.UNSIGNED_INT_24_8;case Ls.D32F:return t.FLOAT;case Ls.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case Ls.BC1:case Ls.BC1_SRGB:case Ls.BC2:case Ls.BC2_SRGB:case Ls.BC3:case Ls.BC3_SRGB:case Ls.BC4:return t.UNSIGNED_BYTE;case Ls.BC4_SNORM:return t.BYTE;case Ls.BC5:return t.UNSIGNED_BYTE;case Ls.BC5_SNORM:return t.BYTE;case Ls.BC6H_SF16:case Ls.BC6H_UF16:return t.FLOAT;case Ls.BC7:case Ls.BC7_SRGB:case Ls.ETC_RGB8:case Ls.ETC2_RGB8:case Ls.ETC2_SRGB8:case Ls.ETC2_RGB8_A1:case Ls.ETC2_SRGB8_A1:case Ls.EAC_R11:return t.UNSIGNED_BYTE;case Ls.EAC_R11SN:return t.BYTE;case Ls.EAC_RG11:return t.UNSIGNED_BYTE;case Ls.EAC_RG11SN:return t.BYTE;case Ls.PVRTC_RGB2:case Ls.PVRTC_RGBA2:case Ls.PVRTC_RGB4:case Ls.PVRTC_RGBA4:case Ls.PVRTC2_2BPP:case Ls.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Ls.ASTC_RGBA_4X4:case Ls.ASTC_RGBA_5X4:case Ls.ASTC_RGBA_5X5:case Ls.ASTC_RGBA_6X5:case Ls.ASTC_RGBA_6X6:case Ls.ASTC_RGBA_8X5:case Ls.ASTC_RGBA_8X6:case Ls.ASTC_RGBA_8X8:case Ls.ASTC_RGBA_10X5:case Ls.ASTC_RGBA_10X6:case Ls.ASTC_RGBA_10X8:case Ls.ASTC_RGBA_10X10:case Ls.ASTC_RGBA_12X10:case Ls.ASTC_RGBA_12X12:case Ls.ASTC_SRGBA_4X4:case Ls.ASTC_SRGBA_5X4:case Ls.ASTC_SRGBA_5X5:case Ls.ASTC_SRGBA_6X5:case Ls.ASTC_SRGBA_6X6:case Ls.ASTC_SRGBA_8X5:case Ls.ASTC_SRGBA_8X6:case Ls.ASTC_SRGBA_8X8:case Ls.ASTC_SRGBA_10X5:case Ls.ASTC_SRGBA_10X6:case Ls.ASTC_SRGBA_10X8:case Ls.ASTC_SRGBA_10X10:case Ls.ASTC_SRGBA_12X10:case Ls.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function PL(e,t){switch(e){case Ls.A8:return t.ALPHA;case Ls.L8:return t.LUMINANCE;case Ls.LA8:return t.LUMINANCE_ALPHA;case Ls.R8:case Ls.R8SN:return t.RED;case Ls.R8UI:case Ls.R8I:return t.RED;case Ls.RG8:case Ls.RG8SN:case Ls.RG8UI:case Ls.RG8I:return t.RG;case Ls.RGB8:case Ls.RGB8SN:case Ls.RGB8UI:case Ls.RGB8I:return t.RGB;case Ls.BGRA8:case Ls.RGBA8:case Ls.RGBA8SN:case Ls.RGBA8UI:case Ls.RGBA8I:return t.RGBA;case Ls.R16UI:case Ls.R16I:case Ls.R16F:return t.RED;case Ls.RG16UI:case Ls.RG16I:case Ls.RG16F:return t.RG;case Ls.RGB16UI:case Ls.RGB16I:case Ls.RGB16F:return t.RGB;case Ls.RGBA16UI:case Ls.RGBA16I:case Ls.RGBA16F:return t.RGBA;case Ls.R32UI:case Ls.R32I:case Ls.R32F:return t.RED;case Ls.RG32UI:case Ls.RG32I:case Ls.RG32F:return t.RG;case Ls.RGB32UI:case Ls.RGB32I:case Ls.RGB32F:return t.RGB;case Ls.RGBA32UI:case Ls.RGBA32I:case Ls.RGBA32F:case Ls.RGB10A2:return t.RGBA;case Ls.R11G11B10F:case Ls.R5G6B5:return t.RGB;case Ls.RGB5A1:case Ls.RGBA4:return t.RGBA;case Ls.SRGB8:return t.RGB;case Ls.SRGB8_A8:return t.RGBA;case Ls.D16:return t.DEPTH_COMPONENT;case Ls.D16S8:return t.DEPTH_STENCIL;case Ls.D24:return t.DEPTH_COMPONENT;case Ls.D24S8:return t.DEPTH_STENCIL;case Ls.D32F:return t.DEPTH_COMPONENT;case Ls.D32F_S8:return t.DEPTH_STENCIL;case Ls.BC1:return yN.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ls.BC1_ALPHA:return yN.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ls.BC1_SRGB:return yN.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ls.BC1_SRGB_ALPHA:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ls.BC2:return yN.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ls.BC2_SRGB:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ls.BC3:return yN.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ls.BC3_SRGB:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ls.ETC_RGB8:return yN.COMPRESSED_RGB_ETC1_WEBGL;case Ls.ETC2_RGB8:return yN.COMPRESSED_RGB8_ETC2;case Ls.ETC2_SRGB8:return yN.COMPRESSED_SRGB8_ETC2;case Ls.ETC2_RGB8_A1:return yN.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ls.ETC2_SRGB8_A1:return yN.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ls.ETC2_RGBA8:return yN.COMPRESSED_RGBA8_ETC2_EAC;case Ls.ETC2_SRGB8_A8:return yN.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ls.EAC_R11:return yN.COMPRESSED_R11_EAC;case Ls.EAC_R11SN:return yN.COMPRESSED_SIGNED_R11_EAC;case Ls.EAC_RG11:return yN.COMPRESSED_RG11_EAC;case Ls.EAC_RG11SN:return yN.COMPRESSED_SIGNED_RG11_EAC;case Ls.PVRTC_RGB2:return yN.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ls.PVRTC_RGBA2:return yN.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ls.PVRTC_RGB4:return yN.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ls.PVRTC_RGBA4:return yN.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ls.ASTC_RGBA_4X4:return yN.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ls.ASTC_RGBA_5X4:return yN.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ls.ASTC_RGBA_5X5:return yN.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ls.ASTC_RGBA_6X5:return yN.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ls.ASTC_RGBA_6X6:return yN.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ls.ASTC_RGBA_8X5:return yN.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ls.ASTC_RGBA_8X6:return yN.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ls.ASTC_RGBA_8X8:return yN.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ls.ASTC_RGBA_10X5:return yN.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ls.ASTC_RGBA_10X6:return yN.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ls.ASTC_RGBA_10X8:return yN.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ls.ASTC_RGBA_10X10:return yN.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ls.ASTC_RGBA_12X10:return yN.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ls.ASTC_RGBA_12X12:return yN.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ls.ASTC_SRGBA_4X4:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ls.ASTC_SRGBA_5X4:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ls.ASTC_SRGBA_5X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ls.ASTC_SRGBA_6X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ls.ASTC_SRGBA_6X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ls.ASTC_SRGBA_8X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ls.ASTC_SRGBA_8X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ls.ASTC_SRGBA_8X8:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ls.ASTC_SRGBA_10X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ls.ASTC_SRGBA_10X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ls.ASTC_SRGBA_10X8:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ls.ASTC_SRGBA_10X10:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ls.ASTC_SRGBA_12X10:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ls.ASTC_SRGBA_12X12:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}function RL(e,t){switch(e){case zs.BOOL:return t.BOOL;case zs.BOOL2:return t.BOOL_VEC2;case zs.BOOL3:return t.BOOL_VEC3;case zs.BOOL4:return t.BOOL_VEC4;case zs.INT:return t.INT;case zs.INT2:return t.INT_VEC2;case zs.INT3:return t.INT_VEC3;case zs.INT4:return t.INT_VEC4;case zs.UINT:return t.UNSIGNED_INT;case zs.FLOAT:return t.FLOAT;case zs.FLOAT2:return t.FLOAT_VEC2;case zs.FLOAT3:return t.FLOAT_VEC3;case zs.FLOAT4:return t.FLOAT_VEC4;case zs.MAT2:return t.FLOAT_MAT2;case zs.MAT2X3:return t.FLOAT_MAT2x3;case zs.MAT2X4:return t.FLOAT_MAT2x4;case zs.MAT3X2:return t.FLOAT_MAT3x2;case zs.MAT3:return t.FLOAT_MAT3;case zs.MAT3X4:return t.FLOAT_MAT3x4;case zs.MAT4X2:return t.FLOAT_MAT4x2;case zs.MAT4X3:return t.FLOAT_MAT4x3;case zs.MAT4:return t.FLOAT_MAT4;case zs.SAMPLER2D:return t.SAMPLER_2D;case zs.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case zs.SAMPLER3D:return t.SAMPLER_3D;case zs.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),zs.UNKNOWN}}function IL(e,t){switch(e){case t.BOOL:return zs.BOOL;case t.BOOL_VEC2:return zs.BOOL2;case t.BOOL_VEC3:return zs.BOOL3;case t.BOOL_VEC4:return zs.BOOL4;case t.INT:return zs.INT;case t.INT_VEC2:return zs.INT2;case t.INT_VEC3:return zs.INT3;case t.INT_VEC4:return zs.INT4;case t.UNSIGNED_INT:return zs.UINT;case t.UNSIGNED_INT_VEC2:return zs.UINT2;case t.UNSIGNED_INT_VEC3:return zs.UINT3;case t.UNSIGNED_INT_VEC4:return zs.UINT4;case t.FLOAT:return zs.FLOAT;case t.FLOAT_VEC2:return zs.FLOAT2;case t.FLOAT_VEC3:return zs.FLOAT3;case t.FLOAT_VEC4:return zs.FLOAT4;case t.FLOAT_MAT2:return zs.MAT2;case t.FLOAT_MAT2x3:return zs.MAT2X3;case t.FLOAT_MAT2x4:return zs.MAT2X4;case t.FLOAT_MAT3x2:return zs.MAT3X2;case t.FLOAT_MAT3:return zs.MAT3;case t.FLOAT_MAT3x4:return zs.MAT3X4;case t.FLOAT_MAT4x2:return zs.MAT4X2;case t.FLOAT_MAT4x3:return zs.MAT4X3;case t.FLOAT_MAT4:return zs.MAT4;case t.SAMPLER_2D:return zs.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return zs.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return zs.SAMPLER3D;case t.SAMPLER_CUBE:return zs.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),zs.UNKNOWN}}function ML(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function OL(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}const DL=[512,513,514,515,516,517,518,519],NL=[0,7680,7681,7682,7683,5386,34055,34056],LL=[32774,32778,32779,32775,32776],BL=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let zL;!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(zL||(zL={}));class FL{constructor(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e}}class UL extends FL{constructor(){super(zL.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea=new xo,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class GL extends FL{constructor(){super(zL.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.dynamicStates=new fr}clear(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0}}class kL extends FL{constructor(){super(zL.DRAW),this.drawInfo=new Oo}clear(){}}class HL extends FL{constructor(){super(zL.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class VL extends FL{constructor(){super(zL.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class jL{constructor(){this.cmds=new G(1),this.beginRenderPassCmds=new G(1),this.bindStatesCmds=new G(1),this.drawCmds=new G(1),this.updateBufferCmds=new G(1),this.copyBufferToTextureCmds=new G(1)}clearCmds(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function WL(e,t,i,n,s){if(t.usage&Fs.INDIRECT)t.indirects.length=n,Array.prototype.push.apply(t.indirects,i.drawInfos);else{const o=i,{gl:r}=e,a=e.stateCache;switch(t.glTarget){case r.ARRAY_BUFFER:a.glVAO&&(r.bindVertexArray(null),a.glVAO=qL.gpuInputAssembler=null),a.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),a.glArrayBuffer=t.glBuffer),s===o.byteLength?r.bufferSubData(t.glTarget,n,o):r.bufferSubData(t.glTarget,n,o.slice(0,s));break;case r.ELEMENT_ARRAY_BUFFER:a.glVAO&&(r.bindVertexArray(null),a.glVAO=qL.gpuInputAssembler=null),a.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),a.glElementArrayBuffer=t.glBuffer),s===o.byteLength?r.bufferSubData(t.glTarget,n,o):r.bufferSubData(t.glTarget,n,o.slice(0,s));break;case r.UNIFORM_BUFFER:a.glUniformBuffer!==t.glBuffer&&(r.bindBuffer(r.UNIFORM_BUFFER,t.glBuffer),a.glUniformBuffer=t.glBuffer),s===o.byteLength?r.bufferSubData(t.glTarget,n,o):r.bufferSubData(t.glTarget,n,new Float32Array(o,0,s/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}const qL={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function XL(e,t,i,n,s,o,r){const{gl:a}=e,c=e.stateCache;let l=0;if(i&&t){c.glFramebuffer!==i.glFramebuffer&&(a.bindFramebuffer(a.FRAMEBUFFER,i.glFramebuffer),c.glFramebuffer=i.glFramebuffer),c.viewport.left===n.x&&c.viewport.top===n.y&&c.viewport.width===n.width&&c.viewport.height===n.height||(a.viewport(n.x,n.y,n.width,n.height),c.viewport.left=n.x,c.viewport.top=n.y,c.viewport.width=n.width,c.viewport.height=n.height),c.scissorRect.x===n.x&&c.scissorRect.y===n.y&&c.scissorRect.width===n.width&&c.scissorRect.height===n.height||(a.scissor(n.x,n.y,n.width,n.height),c.scissorRect.x=n.x,c.scissorRect.y=n.y,c.scissorRect.width=n.width,c.scissorRect.height=n.height),qL.invalidateAttachments.length=0;for(let e=0;e<s.length;++e){const n=t.colorAttachments[e];if(n.format!==Ls.UNKNOWN)switch(n.loadOp){case eo.LOAD:break;case eo.CLEAR:if(c.bs.targets[0].blendColorMask!==Zs.ALL&&a.colorMask(!0,!0,!0,!0),i.isOffscreen)wL[0]=s[e].x,wL[1]=s[e].y,wL[2]=s[e].z,wL[3]=s[e].w,a.clearBufferfv(a.COLOR,e,wL);else{const e=s[0];a.clearColor(e.x,e.y,e.z,e.w),l|=a.COLOR_BUFFER_BIT}break;case eo.DISCARD:qL.invalidateAttachments.push(a.COLOR_ATTACHMENT0+e)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Ls.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case eo.LOAD:break;case eo.CLEAR:c.dss.depthWrite||a.depthMask(!0),a.clearDepth(o),l|=a.DEPTH_BUFFER_BIT;break;case eo.DISCARD:qL.invalidateAttachments.push(a.DEPTH_ATTACHMENT)}if(vr[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case eo.LOAD:break;case eo.CLEAR:c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(r),l|=a.STENCIL_BUFFER_BIT;break;case eo.DISCARD:qL.invalidateAttachments.push(a.STENCIL_ATTACHMENT)}}if(i.glFramebuffer&&qL.invalidateAttachments.length&&a.invalidateFramebuffer(a.FRAMEBUFFER,qL.invalidateAttachments),l&&a.clear(l),l&a.COLOR_BUFFER_BIT){const e=c.bs.targets[0].blendColorMask;if(e!==Zs.ALL){const t=(e&Zs.R)!==Zs.NONE,i=(e&Zs.G)!==Zs.NONE,n=(e&Zs.B)!==Zs.NONE,s=(e&Zs.A)!==Zs.NONE;a.colorMask(t,i,n,s)}}l&a.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&a.depthMask(!1),l&a.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function YL(e,t,i,n,s,o){const{gl:r}=e,a=e.stateCache,c=t&&t.gpuShader;let l=!1;if(t&&qL.gpuPipelineState!==t){if(qL.gpuPipelineState=t,qL.glPrimitive=t.glPrimitive,c){const{glProgram:e}=c;a.glProgram!==e&&(r.useProgram(e),a.glProgram=e,l=!0)}const{rs:i}=t;if(i){if(a.rs.cullMode!==i.cullMode){switch(i.cullMode){case co.NONE:r.disable(r.CULL_FACE);break;case co.FRONT:r.enable(r.CULL_FACE),r.cullFace(r.FRONT);break;case co.BACK:r.enable(r.CULL_FACE),r.cullFace(r.BACK)}e.stateCache.rs.cullMode=i.cullMode}const t=i.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==t&&(r.frontFace(t?r.CCW:r.CW),e.stateCache.rs.isFrontFaceCCW=t),e.stateCache.rs.depthBias===i.depthBias&&e.stateCache.rs.depthBiasSlop===i.depthBiasSlop||(r.polygonOffset(i.depthBias,i.depthBiasSlop),e.stateCache.rs.depthBias=i.depthBias,e.stateCache.rs.depthBiasSlop=i.depthBiasSlop),e.stateCache.rs.lineWidth!==i.lineWidth&&(r.lineWidth(i.lineWidth),e.stateCache.rs.lineWidth=i.lineWidth)}const{dss:n}=t;n&&(a.dss.depthTest!==n.depthTest&&(n.depthTest?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),a.dss.depthTest=n.depthTest),a.dss.depthWrite!==n.depthWrite&&(r.depthMask(n.depthWrite),a.dss.depthWrite=n.depthWrite),a.dss.depthFunc!==n.depthFunc&&(r.depthFunc(DL[n.depthFunc]),a.dss.depthFunc=n.depthFunc),a.dss.stencilTestFront===n.stencilTestFront&&a.dss.stencilTestBack===n.stencilTestBack||(n.stencilTestFront||n.stencilTestBack?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),a.dss.stencilTestFront=n.stencilTestFront,a.dss.stencilTestBack=n.stencilTestBack),a.dss.stencilFuncFront===n.stencilFuncFront&&a.dss.stencilRefFront===n.stencilRefFront&&a.dss.stencilReadMaskFront===n.stencilReadMaskFront||(r.stencilFuncSeparate(r.FRONT,DL[n.stencilFuncFront],n.stencilRefFront,n.stencilReadMaskFront),a.dss.stencilFuncFront=n.stencilFuncFront,a.dss.stencilRefFront=n.stencilRefFront,a.dss.stencilReadMaskFront=n.stencilReadMaskFront),a.dss.stencilFailOpFront===n.stencilFailOpFront&&a.dss.stencilZFailOpFront===n.stencilZFailOpFront&&a.dss.stencilPassOpFront===n.stencilPassOpFront||(r.stencilOpSeparate(r.FRONT,NL[n.stencilFailOpFront],NL[n.stencilZFailOpFront],NL[n.stencilPassOpFront]),a.dss.stencilFailOpFront=n.stencilFailOpFront,a.dss.stencilZFailOpFront=n.stencilZFailOpFront,a.dss.stencilPassOpFront=n.stencilPassOpFront),a.dss.stencilWriteMaskFront!==n.stencilWriteMaskFront&&(r.stencilMaskSeparate(r.FRONT,n.stencilWriteMaskFront),a.dss.stencilWriteMaskFront=n.stencilWriteMaskFront),a.dss.stencilFuncBack===n.stencilFuncBack&&a.dss.stencilRefBack===n.stencilRefBack&&a.dss.stencilReadMaskBack===n.stencilReadMaskBack||(r.stencilFuncSeparate(r.BACK,DL[n.stencilFuncBack],n.stencilRefBack,n.stencilReadMaskBack),a.dss.stencilFuncBack=n.stencilFuncBack,a.dss.stencilRefBack=n.stencilRefBack,a.dss.stencilReadMaskBack=n.stencilReadMaskBack),a.dss.stencilFailOpBack===n.stencilFailOpBack&&a.dss.stencilZFailOpBack===n.stencilZFailOpBack&&a.dss.stencilPassOpBack===n.stencilPassOpBack||(r.stencilOpSeparate(r.BACK,NL[n.stencilFailOpBack],NL[n.stencilZFailOpBack],NL[n.stencilPassOpBack]),a.dss.stencilFailOpBack=n.stencilFailOpBack,a.dss.stencilZFailOpBack=n.stencilZFailOpBack,a.dss.stencilPassOpBack=n.stencilPassOpBack),a.dss.stencilWriteMaskBack!==n.stencilWriteMaskBack&&(r.stencilMaskSeparate(r.BACK,n.stencilWriteMaskBack),a.dss.stencilWriteMaskBack=n.stencilWriteMaskBack));const{bs:s}=t;if(s){a.bs.isA2C!==s.isA2C&&(s.isA2C?r.enable(r.SAMPLE_ALPHA_TO_COVERAGE):r.disable(r.SAMPLE_ALPHA_TO_COVERAGE),a.bs.isA2C=s.isA2C),a.bs.blendColor.x===s.blendColor.x&&a.bs.blendColor.y===s.blendColor.y&&a.bs.blendColor.z===s.blendColor.z&&a.bs.blendColor.w===s.blendColor.w||(r.blendColor(s.blendColor.x,s.blendColor.y,s.blendColor.z,s.blendColor.w),a.bs.blendColor.x=s.blendColor.x,a.bs.blendColor.y=s.blendColor.y,a.bs.blendColor.z=s.blendColor.z,a.bs.blendColor.w=s.blendColor.w);const e=s.targets[0],t=a.bs.targets[0];t.blend!==e.blend&&(e.blend?r.enable(r.BLEND):r.disable(r.BLEND),t.blend=e.blend),t.blendEq===e.blendEq&&t.blendAlphaEq===e.blendAlphaEq||(r.blendEquationSeparate(LL[e.blendEq],LL[e.blendAlphaEq]),t.blendEq=e.blendEq,t.blendAlphaEq=e.blendAlphaEq),t.blendSrc===e.blendSrc&&t.blendDst===e.blendDst&&t.blendSrcAlpha===e.blendSrcAlpha&&t.blendDstAlpha===e.blendDstAlpha||(r.blendFuncSeparate(BL[e.blendSrc],BL[e.blendDst],BL[e.blendSrcAlpha],BL[e.blendDstAlpha]),t.blendSrc=e.blendSrc,t.blendDst=e.blendDst,t.blendSrcAlpha=e.blendSrcAlpha,t.blendDstAlpha=e.blendDstAlpha),t.blendColorMask!==e.blendColorMask&&(r.colorMask((e.blendColorMask&Zs.R)!==Zs.NONE,(e.blendColorMask&Zs.G)!==Zs.NONE,(e.blendColorMask&Zs.B)!==Zs.NONE,(e.blendColorMask&Zs.A)!==Zs.NONE),t.blendColorMask=e.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){const i=c.glBlocks.length,{dynamicOffsetIndices:o}=t.gpuPipelineLayout;for(let e=0;e<i;e++){const t=c.glBlocks[e],i=n[t.set],l=i&&i.descriptorIndices[t.binding],h=l>=0&&i.gpuDescriptors[l];if(!h||!h.gpuBuffer){d(`Buffer binding '${t.name}' at set ${t.set} binding ${t.binding} is not bounded`);continue}const u=o[t.set],_=u&&u[t.binding];let p=h.gpuBuffer.glOffset;_>=0&&(p+=s[_]),a.glBindUBOs[t.glBinding]===h.gpuBuffer.glBuffer&&a.glBindUBOOffsets[t.glBinding]===p||(p?r.bindBufferRange(r.UNIFORM_BUFFER,t.glBinding,h.gpuBuffer.glBuffer,p,h.gpuBuffer.size):r.bindBufferBase(r.UNIFORM_BUFFER,t.glBinding,h.gpuBuffer.glBuffer),a.glUniformBuffer=a.glBindUBOs[t.glBinding]=h.gpuBuffer.glBuffer,a.glBindUBOOffsets[t.glBinding]=p)}const l=c.glSamplerTextures.length;for(let t=0;t<l;t++){const i=c.glSamplerTextures[t],s=n[i.set];let o=s&&s.descriptorIndices[i.binding],l=o>=0&&s.gpuDescriptors[o];for(let t=0;t<i.units.length;t++){const n=i.units[t],c=a.glTexUnits[n];if(l&&l.gpuTexture&&l.gpuSampler){if(l.gpuTexture&&l.gpuTexture.size>0){const{gpuTexture:t}=l;c.glTexture!==t.glTexture&&(a.texUnit!==n&&(r.activeTexture(r.TEXTURE0+n),a.texUnit=n),t.glTexture?r.bindTexture(t.glTarget,t.glTexture):r.bindTexture(t.glTarget,e.nullTex2D.gpuTexture.glTexture),c.glTexture=t.glTexture);const{gpuSampler:i}=l;a.glSamplerUnits[n]!==i.glSampler&&(r.bindSampler(n,i.glSampler),a.glSamplerUnits[n]=i.glSampler)}l=s.gpuDescriptors[++o]}else d(`Sampler binding '${i.name}' at set ${i.set} binding ${i.binding} index ${t} is not bounded`)}}}if(i&&c&&(l||qL.gpuInputAssembler!==i))if(qL.gpuInputAssembler=i,e.useVAO){let e=i.glVAOs.get(c.glProgram);if(!e){let t;e=r.createVertexArray(),i.glVAOs.set(c.glProgram,e),r.bindVertexArray(e),r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null;for(let e=0;e<c.glInputs.length;e++){const n=c.glInputs[e];t=null;for(let e=0;e<i.glAttribs.length;e++){const s=i.glAttribs[e];if(s.name===n.name){t=s;break}}if(t){a.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),a.glArrayBuffer=t.glBuffer);for(let e=0;e<t.componentCount;++e){const i=n.glLoc+e,s=t.offset+t.size*e;r.enableVertexAttribArray(i),a.glCurrentAttribLocs[i]=!0,r.vertexAttribPointer(i,t.count,t.glType,t.isNormalized,t.stride,s),r.vertexAttribDivisor(i,t.isInstanced?1:0)}}}const n=i.gpuIndexBuffer;n&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n.glBuffer),r.bindVertexArray(null),r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null}a.glVAO!==e&&(r.bindVertexArray(e),a.glVAO=e)}else{for(let t=0;t<e.capabilities.maxVertexAttributes;++t)a.glCurrentAttribLocs[t]=!1;for(let e=0;e<c.glInputs.length;e++){const t=c.glInputs[e];let n=null;for(let e=0;e<i.glAttribs.length;e++){const s=i.glAttribs[e];if(s.name===t.name){n=s;break}}if(n){a.glArrayBuffer!==n.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,n.glBuffer),a.glArrayBuffer=n.glBuffer);for(let e=0;e<n.componentCount;++e){const i=t.glLoc+e,s=n.offset+n.size*e;!a.glEnabledAttribLocs[i]&&i>=0&&(r.enableVertexAttribArray(i),a.glEnabledAttribLocs[i]=!0),a.glCurrentAttribLocs[i]=!0,r.vertexAttribPointer(i,n.count,n.glType,n.isNormalized,n.stride,s),r.vertexAttribDivisor(i,n.isInstanced?1:0)}}}const t=i.gpuIndexBuffer;t&&a.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),a.glElementArrayBuffer=t.glBuffer);for(let t=0;t<e.capabilities.maxVertexAttributes;++t)a.glEnabledAttribLocs[t]!==a.glCurrentAttribLocs[t]&&(r.disableVertexAttribArray(t),a.glEnabledAttribLocs[t]=!1)}if(t&&t.dynamicStates.length){const e=t.dynamicStates.length;for(let i=0;i<e;i++)switch(t.dynamicStates[i]){case lo.VIEWPORT:{const e=o.viewport;a.viewport.left===e.left&&a.viewport.top===e.top&&a.viewport.width===e.width&&a.viewport.height===e.height||(r.viewport(e.left,e.top,e.width,e.height),a.viewport.left=e.left,a.viewport.top=e.top,a.viewport.width=e.width,a.viewport.height=e.height);break}case lo.SCISSOR:{const e=o.scissor;a.scissorRect.x===e.x&&a.scissorRect.y===e.y&&a.scissorRect.width===e.width&&a.scissorRect.height===e.height||(r.scissor(e.x,e.y,e.width,e.height),a.scissorRect.x=e.x,a.scissorRect.y=e.y,a.scissorRect.width=e.width,a.scissorRect.height=e.height);break}case lo.LINE_WIDTH:a.rs.lineWidth!==o.lineWidth&&(r.lineWidth(o.lineWidth),a.rs.lineWidth=o.lineWidth);break;case lo.DEPTH_BIAS:a.rs.depthBias===o.depthBiasConstant&&a.rs.depthBiasSlop===o.depthBiasSlope||(r.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),a.rs.depthBias=o.depthBiasConstant,a.rs.depthBiasSlop=o.depthBiasSlope);break;case lo.BLEND_CONSTANTS:{const e=o.blendConstant;a.bs.blendColor.x===e.x&&a.bs.blendColor.y===e.y&&a.bs.blendColor.z===e.z&&a.bs.blendColor.w===e.w||(r.blendColor(e.x,e.y,e.z,e.w),a.bs.blendColor.copy(e));break}case lo.STENCIL_WRITE_MASK:{const e=o.stencilStatesFront,t=o.stencilStatesBack;a.dss.stencilWriteMaskFront!==e.writeMask&&(r.stencilMaskSeparate(r.FRONT,e.writeMask),a.dss.stencilWriteMaskFront=e.writeMask),a.dss.stencilWriteMaskBack!==t.writeMask&&(r.stencilMaskSeparate(r.BACK,t.writeMask),a.dss.stencilWriteMaskBack=t.writeMask);break}case lo.STENCIL_COMPARE_MASK:{const e=o.stencilStatesFront,t=o.stencilStatesBack;a.dss.stencilRefFront===e.reference&&a.dss.stencilReadMaskFront===e.compareMask||(r.stencilFuncSeparate(r.FRONT,DL[a.dss.stencilFuncFront],e.reference,e.compareMask),a.dss.stencilRefFront=e.reference,a.dss.stencilReadMaskFront=e.compareMask),a.dss.stencilRefBack===t.reference&&a.dss.stencilReadMaskBack===t.compareMask||(r.stencilFuncSeparate(r.BACK,DL[a.dss.stencilFuncBack],t.reference,t.compareMask),a.dss.stencilRefBack=t.reference,a.dss.stencilReadMaskBack=t.compareMask);break}}}}function KL(e,t){const{gl:i}=e,{gpuInputAssembler:n,glPrimitive:s}=qL;if(n)if(n.gpuIndirectBuffer){const{indirects:e}=n.gpuIndirectBuffer;for(let t=0;t<e.length;t++){const o=e[t],r=n.gpuIndexBuffer;if(o.instanceCount)if(r){if(o.indexCount>0){const e=o.firstIndex*r.stride;i.drawElementsInstanced(s,o.indexCount,n.glIndexType,e,o.instanceCount)}}else o.vertexCount>0&&i.drawArraysInstanced(s,o.firstVertex,o.vertexCount,o.instanceCount);else if(r){if(o.indexCount>0){const e=o.firstIndex*r.stride;i.drawElements(s,o.indexCount,n.glIndexType,e)}}else o.vertexCount>0&&i.drawArrays(s,o.firstVertex,o.vertexCount)}}else if(t.instanceCount)if(n.gpuIndexBuffer){if(t.indexCount>0){const e=t.firstIndex*n.gpuIndexBuffer.stride;i.drawElementsInstanced(s,t.indexCount,n.glIndexType,e,t.instanceCount)}}else t.vertexCount>0&&i.drawArraysInstanced(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(n.gpuIndexBuffer){if(t.indexCount>0){const e=t.firstIndex*n.gpuIndexBuffer.stride;i.drawElements(s,t.indexCount,n.glIndexType,e)}}else t.vertexCount>0&&i.drawArrays(s,t.firstVertex,t.vertexCount)}const $L=new Array(zL.COUNT);function QL(e,t){$L.fill(0);for(let i=0;i<t.cmds.length;++i){const n=t.cmds.array[i],s=$L[n]++;switch(n){case zL.BEGIN_RENDER_PASS:{const i=t.beginRenderPassCmds.array[s];XL(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break}case zL.BIND_STATES:{const i=t.bindStatesCmds.array[s];YL(e,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.dynamicStates);break}case zL.DRAW:KL(e,t.drawCmds.array[s].drawInfo);break;case zL.UPDATE_BUFFER:{const i=t.updateBufferCmds.array[s];WL(e,i.gpuBuffer,i.buffer,i.offset,i.size);break}case zL.COPY_BUFFER_TO_TEXTURE:{const i=t.copyBufferToTextureCmds.array[s];ZL(e,i.buffers,i.gpuTexture,i.regions);break}}}}function ZL(e,t,i,n){const{gl:s}=e,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);let r=0,a=1,c=1,l=0;const h=vr[i.format],{isCompressed:u}=h;switch(i.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const o=n[e];a=o.texExtent.width,c=o.texExtent.height;const l=t[r++];u?i.glInternalFmt!==yN.COMPRESSED_RGB_ETC1_WEBGL?s.compressedTexSubImage2D(s.TEXTURE_2D,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,a,c,i.glFormat,l):s.compressedTexImage2D(s.TEXTURE_2D,o.texSubres.mipLevel,i.glInternalFmt,a,c,0,l):s.texSubImage2D(s.TEXTURE_2D,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,a,c,i.glFormat,i.glType,l)}break;case s.TEXTURE_CUBE_MAP:for(let e=0;e<n.length;e++){const o=n[e],h=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(l=o.texSubres.baseArrayLayer;l<h;++l){a=o.texExtent.width,c=o.texExtent.height;const e=t[r++];u?i.glInternalFmt!==yN.COMPRESSED_RGB_ETC1_WEBGL?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,a,c,i.glFormat,e):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,o.texSubres.mipLevel,i.glInternalFmt,a,c,0,e):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,a,c,i.glFormat,i.glType,e)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&js.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}class JL extends zr{constructor(...e){super(...e),this._gpuBuffer=null}get gpuBuffer(){return this._gpuBuffer}initialize(e){if("buffer"in e){this._isBufferView=!0;const t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Fs.INDIRECT&&(this._indirectBuffer=new No),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:[],glTarget:0,glBuffer:null,glOffset:0},e.usage&Fs.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){const{gl:i}=e,n=e.stateCache,s=t.memUsage&ks.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&Fs.VERTEX){t.glTarget=i.ARRAY_BUFFER;const o=i.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=qL.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Fs.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;const o=i.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=qL.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&Fs.UNIFORM){t.glTarget=i.UNIFORM_BUFFER;const n=i.createBuffer();n&&t.size>0&&(t.glBuffer=n,e.stateCache.glUniformBuffer!==t.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,s),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&Fs.INDIRECT||t.usage&Fs.TRANSFER_DST||t.usage&Fs.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=i.NONE}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}destroy(){this._gpuBuffer&&(this._isBufferView||(function(e,t){const{gl:i}=e;if(t.glBuffer){switch(t.glTarget){case i.ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(i.bindVertexArray(null),e.stateCache.glVAO=qL.gpuInputAssembler=null),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(i.bindVertexArray(null),e.stateCache.glVAO=qL.gpuInputAssembler=null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case i.UNIFORM_BUFFER:i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}i.deleteBuffer(t.glBuffer),t.glBuffer=null}}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)}resize(e){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){const{gl:i}=e,n=e.stateCache,s=t.memUsage&ks.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&Fs.VERTEX?(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=qL.gpuInputAssembler=null),n.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,s):i.bufferData(i.ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),n.glArrayBuffer=null):t.usage&Fs.INDEX?(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=qL.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Fs.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,s),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&Fs.INDIRECT||t.usage&Fs.TRANSFER_DST||t.usage&Fs.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e)))}update(e,t){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let i;i=void 0!==t?t:this._usage&Fs.INDIRECT?0:e.byteLength,WL(this._device,this._gpuBuffer,e,0,i)}}class eB{constructor(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new G(t);for(let i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}alloc(e){if(this._freeIdx<0){const t=2*this._frees.length,i=this._frees;this._frees=new Array(t);const n=t-i.length;for(let t=0;t<n;++t)this._frees[t]=new e;for(let e=n,s=0;e<t;++e,++s)this._frees[e]=i[s];this._freeIdx+=n}const t=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++t.refCount,t}free(e){0==--e.refCount&&this._freeCmds.push(e)}freeCmds(e){for(let t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}release(){for(let e=0;e<this._freeCmds.length;++e){const t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}class tB{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new eB(UL,1),this.bindStatesCmdPool=new eB(GL,1),this.drawCmdPool=new eB(kL,1),this.updateBufferCmdPool=new eB(HL,1),this.copyBufferToTextureCmdPool=new eB(VL,1)}clearCmds(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class iB extends Fr{constructor(...e){super(...e),this.cmdPackage=new jL,this._webGLAllocator=null,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUDescriptorSets=[],this._curGPUInputAssembler=null,this._curDynamicOffsets=Array(8).fill(0),this._curDynamicStates=new fr,this._isStateInvalied=!1}initialize(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;const t=this._device.bindingMappingInfo.bufferOffsets.length;for(let e=0;e<t;e++)this._curGPUDescriptorSets.push(null);return!0}destroy(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}begin(e,t=0,i){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(e,t,i,n,s,o){const r=this._webGLAllocator.beginRenderPassCmdPool.alloc(UL);r.gpuRenderPass=e.gpuRenderPass,r.gpuFramebuffer=t.gpuFramebuffer,r.renderArea=i;for(let e=0;e<n.length;++e)r.clearColors[e]=n[e];r.clearDepth=s,r.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(r),this.cmdPackage.cmds.push(zL.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(e){const t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}bindDescriptorSet(e,t,i){const n=t.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=n,this._isStateInvalied=!0),i){var s;const t=null===(s=this._curGPUPipelineState)||void 0===s?void 0:s.gpuPipelineLayout;if(t){const n=this._curDynamicOffsets,s=t.dynamicOffsetOffsets[e];for(let e=0;e<i.length;e++)n[s+e]=i[e];this._isStateInvalied=!0}}}bindInputAssembler(e){const t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}setViewport(e){const t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)}setScissor(e){const t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)}setLineWidth(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)}setDepthBias(e,t,i){const n=this._curDynamicStates;n.depthBiasConstant===e&&n.depthBiasClamp===t&&n.depthBiasSlope===i||(n.depthBiasConstant=e,n.depthBiasClamp=t,n.depthBiasSlope=i,this._isStateInvalied=!0)}setBlendConstants(e){const t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)}setDepthBound(e,t){const i=this._curDynamicStates;i.depthMinBounds===e&&i.depthMaxBounds===t||(i.depthMinBounds=e,i.depthMaxBounds=t,this._isStateInvalied=!0)}setStencilWriteMask(e,t){const i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;e&ho.FRONT&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0),e&ho.BACK&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0)}setStencilCompareMask(e,t,i){const n=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&ho.FRONT&&(n.compareMask===i&&n.reference===t||(n.reference=t,n.compareMask=i,this._isStateInvalied=!0)),e&ho.BACK&&(s.compareMask===i&&s.reference===t||(s.reference=t,s.compareMask=i,this._isStateInvalied=!0))}draw(e){if(this._type===po.PRIMARY&&this._isInRenderPass||this._type===po.SECONDARY){this._isStateInvalied&&this.bindStates();const t=this._webGLAllocator.drawCmdPool.alloc(kL);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(zL.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;const i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(e,t,i){if(this._type===po.PRIMARY&&!this._isInRenderPass||this._type===po.SECONDARY){const n=e.gpuBuffer;if(n){const s=this._webGLAllocator.updateBufferCmdPool.alloc(HL);let o=0,r=null;e.usage&Fs.INDIRECT||(o=void 0!==i?i:t.byteLength),r=t,s.gpuBuffer=n,s.buffer=r,s.offset=0,s.size=o,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(zL.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(e,t,i){if(this._type===po.PRIMARY&&!this._isInRenderPass||this._type===po.SECONDARY){const n=t.gpuTexture;if(n){const t=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(VL);t.gpuTexture=n,t.regions=i,t.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(t),this.cmdPackage.cmds.push(zL.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(e,t){for(let i=0;i<t;++i){const t=e[i];for(let e=0;e<t.cmdPackage.beginRenderPassCmds.length;++e){const i=t.cmdPackage.beginRenderPassCmds.array[e];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(let e=0;e<t.cmdPackage.bindStatesCmds.length;++e){const i=t.cmdPackage.bindStatesCmds.array[e];++i.refCount,this.cmdPackage.bindStatesCmds.push(i)}for(let e=0;e<t.cmdPackage.drawCmds.length;++e){const i=t.cmdPackage.drawCmds.array[e];++i.refCount,this.cmdPackage.drawCmds.push(i)}for(let e=0;e<t.cmdPackage.updateBufferCmds.length;++e){const i=t.cmdPackage.updateBufferCmds.array[e];++i.refCount,this.cmdPackage.updateBufferCmds.push(i)}for(let e=0;e<t.cmdPackage.copyBufferToTextureCmds.length;++e){const i=t.cmdPackage.copyBufferToTextureCmds.array[e];++i.refCount,this.cmdPackage.copyBufferToTextureCmds.push(i)}this.cmdPackage.cmds.concat(t.cmdPackage.cmds.array),this._numDrawCalls+=t._numDrawCalls,this._numInstances+=t._numInstances,this._numTris+=t._numTris}}pipelineBarrier(e,t){}get webGLDevice(){return this._device}bindStates(){const e=this._webGLAllocator.bindStatesCmdPool.alloc(GL);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(zL.BIND_STATES),this._isStateInvalied=!1}}class nB extends Gr{constructor(...e){super(...e),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;const t=[];for(let i=0;i<e.colorTextures.length;i++){const n=e.colorTextures[i];n&&t.push(n.gpuTexture)}let i=null;return e.depthStencilTexture&&(i=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:i,glFramebuffer:null},function(e,t){if(!t.gpuColorTextures.length&&!t.gpuDepthStencilTexture)return;const{gl:i}=e,n=[],s=i.createFramebuffer();if(s){t.glFramebuffer=s,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(let e=0;e<t.gpuColorTextures.length;++e){const s=t.gpuColorTextures[e];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.RENDERBUFFER,s.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+e))}const o=t.gpuDepthStencilTexture;if(o){const e=vr[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,e,o.glTarget,o.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,e,i.RENDERBUFFER,o.glRenderbuffer)}i.drawBuffers(n);const r=i.checkFramebufferStatus(i.FRAMEBUFFER);if(r!==i.FRAMEBUFFER_COMPLETE)switch(r){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(this._device,this._gpuFramebuffer),!0}destroy(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)}}class sB extends jr{constructor(...e){super(...e),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(e){if(0===e.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{const e=this._vertexBuffers[0];this._vertexCount=e.size/e.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;const t=new Array(e.vertexBuffers.length);for(let i=0;i<e.vertexBuffers.length;++i){const n=e.vertexBuffers[i];n.gpuBuffer&&(t[i]=n.gpuBuffer)}let i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Illegal index buffer stride.")}let s=null;return e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:t,gpuIndexBuffer:i,gpuIndirectBuffer:s,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){const{gl:i}=e;t.glAttribs=new Array(t.attributes.length);const n=[0,0,0,0,0,0,0,0];for(let e=0;e<t.attributes.length;++e){const s=t.attributes[e],o=void 0!==s.stream?s.stream:0,r=t.gpuVertexBuffers[o],a=AL(s.format,i),{size:c}=vr[s.format];t.glAttribs[e]={name:s.name,glBuffer:r.glBuffer,glType:a,size:c,count:vr[s.format].count,stride:r.stride,componentCount:OL(a,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[o]},n[o]+=c}}(this._device,this._gpuInputAssembler),!0}destroy(){const e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){const i=t.glVAOs.values();let n=i.next();for(;!n.done;)e.gl.deleteVertexArray(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}}class oB extends Wr{constructor(...e){super(...e),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(e){Array.prototype.push.apply(this._bindings,e.bindings);let t=0,i=-1;const n=[];for(let e=0;e<this._bindings.length;e++){const s=this._bindings[e];n.push(t),t+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);const s=this._descriptorIndices=Array(i+1).fill(-1);for(let e=0;e<this._bindings.length;e++){const t=this._bindings[e];this._bindingIndices[t.binding]=e,s[t.binding]=n[e]}const o=[];for(let e=0;e<this._bindings.length;e++){const t=this._bindings[e];if(t.descriptorType&Sr)for(let e=0;e<t.count;e++)o.push(t.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:o,descriptorIndices:s,descriptorCount:t},!0}destroy(){this._bindings.length=0}}class rB extends qr{constructor(...e){super(...e),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);const t=[],i=[];let n=0;const s=[];for(let e=0;e<this._setLayouts.length;e++){const o=this._setLayouts[e],r=o.gpuDescriptorSetLayout.dynamicBindings,a=Array(o.bindingIndices.length).fill(-1);for(let e=0;e<r.length;e++){const t=r[e];a[t]<0&&(a[t]=n+e)}i.push(o.gpuDescriptorSetLayout),t.push(a),s.push(n),n+=r.length}return this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:t,dynamicOffsetCount:n,dynamicOffsetOffsets:s},!0}destroy(){this._setLayouts.length=0}}const aB=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class cB extends uL{constructor(...e){super(...e),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;const t=this._bs;if(e.blendState){const i=e.blendState,{targets:n}=i;n&&n.forEach(((e,i)=>{t.setTarget(i,e)})),void 0!==i.isA2C&&(t.isA2C=i.isA2C),void 0!==i.isIndepend&&(t.isIndepend=i.isIndepend),void 0!==i.blendColor&&(t.blendColor=i.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;const i=[];for(let e=0;e<31;e++)this._dynamicStates&1<<e&&i.push(1<<e);return this._gpuPipelineState={glPrimitive:aB[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:i},!0}destroy(){this._gpuPipelineState=null}}class lB extends iB{beginRenderPass(e,t,i,n,s,o){XL(this._device,e.gpuRenderPass,t.gpuFramebuffer,i,n,s,o),this._isInRenderPass=!0}draw(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),KL(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;const t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(e,t,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const n=e.gpuBuffer;if(n){let s;s=void 0!==i?i:e.usage&Fs.INDIRECT?0:t.byteLength,WL(this._device,n,t,0,s)}}}copyBuffersToTexture(e,t,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const n=t.gpuTexture;n&&ZL(this._device,e,n,i)}}execute(e,t){for(let i=0;i<t;++i){const t=e[i];QL(this._device,t.cmdPackage),this._numDrawCalls+=t._numDrawCalls,this._numInstances+=t._numInstances,this._numTris+=t._numTris}}bindStates(){YL(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}}class hB extends Xr{constructor(...e){super(...e),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(e){return this._type=e.type,!0}destroy(){}submit(e){if(!this._isAsync)for(let t=0;t<e.length;t++){const i=e[t];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class uB extends Yr{constructor(...e){super(...e),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subpasses&&(this._subpasses=e.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}destroy(){this._gpuRenderPass=null}}class _B extends Kr{constructor(...e){super(...e),this._gpuSampler=null}get gpuSampler(){return this._gpuSampler}initialize(e){return this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._mipLODBias=e.mipLODBias,this._gpuSampler={glSampler:null,minFilter:this._minFilter,magFilter:this._magFilter,mipFilter:this._mipFilter,addressU:this._addressU,addressV:this._addressV,addressW:this._addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},function(e,t){const{gl:i}=e,n=i.createSampler();n&&(t.minFilter===qs.LINEAR||t.minFilter===qs.ANISOTROPIC?t.mipFilter===qs.LINEAR||t.mipFilter===qs.ANISOTROPIC?t.glMinFilter=i.LINEAR_MIPMAP_LINEAR:t.mipFilter===qs.POINT?t.glMinFilter=i.LINEAR_MIPMAP_NEAREST:t.glMinFilter=i.LINEAR:t.mipFilter===qs.LINEAR||t.mipFilter===qs.ANISOTROPIC?t.glMinFilter=i.NEAREST_MIPMAP_LINEAR:t.mipFilter===qs.POINT?t.glMinFilter=i.NEAREST_MIPMAP_NEAREST:t.glMinFilter=i.NEAREST,t.magFilter===qs.LINEAR||t.magFilter===qs.ANISOTROPIC?t.glMagFilter=i.LINEAR:t.glMagFilter=i.NEAREST,t.glWrapS=CL[t.addressU],t.glWrapT=CL[t.addressV],t.glWrapR=CL[t.addressW],t.glSampler=n,i.samplerParameteri(n,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.samplerParameteri(n,i.TEXTURE_MAG_FILTER,t.glMagFilter),i.samplerParameteri(n,i.TEXTURE_WRAP_S,t.glWrapS),i.samplerParameteri(n,i.TEXTURE_WRAP_T,t.glWrapT),i.samplerParameteri(n,i.TEXTURE_WRAP_R,t.glWrapR),i.samplerParameterf(n,i.TEXTURE_MIN_LOD,0),i.samplerParameterf(n,i.TEXTURE_MAX_LOD,1e3))}(this._device,this._gpuSampler),!0}destroy(){var e,t;this._gpuSampler&&(e=this._device,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)}}class pB extends $r{constructor(...e){super(...e),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplerTextures:e.samplerTextures,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let t=0;t<e.stages.length;++t){const i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.stage,source:i.source,glShader:null}}return function(e,t){const{gl:i}=e;for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];let s=0,o="",r=1;switch(n.type){case Js.VERTEX:o="VertexShader",s=i.VERTEX_SHADER;break;case Js.FRAGMENT:o="FragmentShader",s=i.FRAGMENT_SHADER;break;default:return void console.error("Unsupported ShaderType.")}const a=i.createShader(s);if(a&&(n.glShader=a,i.shaderSource(n.glShader,`#version 300 es\n${n.source}`),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(`${o} in '${t.name}' compilation failed.`),console.error("Shader source dump:",n.source.replace(/^|\n/g,(()=>`\n${r++} `))),console.error(i.getShaderInfoLog(n.glShader));for(let n=0;n<t.gpuStages.length;n++){const n=t.gpuStages[e];n.glShader&&(i.deleteShader(n.glShader),n.glShader=null)}return}}const n=i.createProgram();if(!n)return;t.glProgram=n;for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];i.attachShader(t.glProgram,n.glShader)}i.linkProgram(t.glProgram);for(let e=0;e<t.gpuStages.length;e++){const n=t.gpuStages[e];n.glShader&&(i.detachShader(t.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}if(!i.getProgramParameter(t.glProgram,i.LINK_STATUS))return console.error(`Failed to link shader '${t.name}'.`),void console.error(i.getProgramInfoLog(t.glProgram));m(`Shader '${t.name}' compilation succeeded.`);const s=i.getProgramParameter(t.glProgram,i.ACTIVE_ATTRIBUTES);t.glInputs=new Array(s);for(let e=0;e<s;++e){const n=i.getActiveAttrib(t.glProgram,e);if(n){let s;const o=n.name.indexOf("[");s=-1!==o?n.name.substr(0,o):n.name;const r=i.getAttribLocation(t.glProgram,s),a=IL(n.type,i),c=ML(n.type,i);t.glInputs[e]={name:s,type:a,stride:c,count:n.size,size:c*n.size,glType:n.type,glLoc:r}}}const o=i.getProgramParameter(t.glProgram,i.ACTIVE_UNIFORM_BLOCKS);let r,a,c,l;if(o){t.glBlocks=new Array(o);for(let n=0;n<o;++n){r=i.getActiveUniformBlockName(t.glProgram,n);const s=r.indexOf("[");-1!==s&&(r=r.substr(0,s)),l=null;for(let e=0;e<t.blocks.length;e++)if(t.blocks[e].name===r){l=t.blocks[e];break}if(l){a=n,c=i.getActiveUniformBlockParameter(t.glProgram,a,i.UNIFORM_BLOCK_DATA_SIZE);const s=l.binding+(e.bindingMappingInfo.bufferOffsets[l.set]||0);i.uniformBlockBinding(t.glProgram,a,s),t.glBlocks[n]={set:l.set,binding:l.binding,idx:a,name:r,size:c,glBinding:s}}else d(`Block '${r}' does not bound`)}}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(let e=0;e<t.samplerTextures.length;++e){const n=t.samplerTextures[e];t.glSamplerTextures[e]={set:n.set,binding:n.binding,name:n.name,type:n.type,count:n.count,units:[],glUnits:null,glType:RL(n.type,i),glLoc:null}}}const h=[],u=[],_=e.stateCache.texUnitCacheMap;let p=0;for(let i=0;i<t.blocks.length;++i)t.blocks[i].set===e.bindingMappingInfo.flexibleSet&&p++;let f=0;for(let n=0;n<t.samplerTextures.length;++n){const s=t.samplerTextures[n],o=i.getUniformLocation(t.glProgram,s.name);if(null===o||"number"!=typeof o&&-1===o.id||(h.push(t.glSamplerTextures[n]),u.push(o)),void 0===_[s.name]){let t=s.binding+e.bindingMappingInfo.samplerOffsets[s.set]+f;s.set===e.bindingMappingInfo.flexibleSet&&(t-=p),_[s.name]=t%e.capabilities.maxTextureUnits,f+=s.count-1}}if(h.length){const n=[];for(let t=0;t<h.length;++t){const i=h[t];let s=_[i.name];if(void 0!==s){i.glLoc=u[t];for(let t=0;t<i.count;++t){for(;n[s];)s=(s+1)%e.capabilities.maxTextureUnits;i.units.push(s),n[s]=!0}}}let s=0;for(let t=0;t<h.length;++t){const i=h[t];if(!i.glLoc){for(i.glLoc=u[t];n[s];)s++;for(let t=0;t<i.count;++t){for(;n[s];)s=(s+1)%e.capabilities.maxTextureUnits;void 0===_[i.name]&&(_[i.name]=s),i.units.push(s),n[s]=!0}}}e.stateCache.glProgram!==t.glProgram&&i.useProgram(t.glProgram);for(let e=0;e<h.length;e++){const t=h[e];t.glUnits=new Int32Array(t.units),i.uniform1iv(t.glLoc,t.glUnits)}e.stateCache.glProgram!==t.glProgram&&i.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=h}(this._device,this._gpuShader),!0}destroy(){var e,t;this._gpuShader&&(e=this._device,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)}}class dB{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new Ao,this.scissorRect=new xo(0,0,0,0),this.rs=new aL,this.dss=new cL,this.bs=new hL,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(e,t,i){for(let t=0;t<e;++t)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=i,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=i,this.glCurrentAttribLocs.fill(!1)}}class fB extends Qr{constructor(...e){super(...e),this._gpuTexture=null}get gpuTexture(){return this._gpuTexture}initialize(e){return"texture"in e?(console.log("WebGL2 does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=Tr(this._width)&&Tr(this._height),this._size=Cr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){const{gl:i}=e;t.glInternalFmt=function(e,t){switch(e){case Ls.A8:return t.ALPHA;case Ls.L8:return t.LUMINANCE;case Ls.LA8:return t.LUMINANCE_ALPHA;case Ls.R8:return t.R8;case Ls.R8SN:return t.R8_SNORM;case Ls.R8UI:return t.R8UI;case Ls.R8I:return t.R8I;case Ls.RG8:return t.RG8;case Ls.RG8SN:return t.RG8_SNORM;case Ls.RG8UI:return t.RG8UI;case Ls.RG8I:return t.RG8I;case Ls.RGB8:return t.RGB8;case Ls.RGB8SN:return t.RGB8_SNORM;case Ls.RGB8UI:return t.RGB8UI;case Ls.RGB8I:return t.RGB8I;case Ls.BGRA8:case Ls.RGBA8:return t.RGBA8;case Ls.RGBA8SN:return t.RGBA8_SNORM;case Ls.RGBA8UI:return t.RGBA8UI;case Ls.RGBA8I:return t.RGBA8I;case Ls.R16I:return t.R16I;case Ls.R16UI:return t.R16UI;case Ls.R16F:return t.R16F;case Ls.RG16I:return t.RG16I;case Ls.RG16UI:return t.RG16UI;case Ls.RG16F:return t.RG16F;case Ls.RGB16I:return t.RGB16I;case Ls.RGB16UI:return t.RGB16UI;case Ls.RGB16F:return t.RGB16F;case Ls.RGBA16I:return t.RGBA16I;case Ls.RGBA16UI:return t.RGBA16UI;case Ls.RGBA16F:return t.RGBA16F;case Ls.R32I:return t.R32I;case Ls.R32UI:return t.R32UI;case Ls.R32F:return t.R32F;case Ls.RG32I:return t.RG32I;case Ls.RG32UI:return t.RG32UI;case Ls.RG32F:return t.RG32F;case Ls.RGB32I:return t.RGB32I;case Ls.RGB32UI:return t.RGB32UI;case Ls.RGB32F:return t.RGB32F;case Ls.RGBA32I:return t.RGBA32I;case Ls.RGBA32UI:return t.RGBA32UI;case Ls.RGBA32F:return t.RGBA32F;case Ls.R5G6B5:return t.RGB565;case Ls.RGB5A1:return t.RGB5_A1;case Ls.RGBA4:return t.RGBA4;case Ls.SRGB8:return t.SRGB8;case Ls.SRGB8_A8:return t.SRGB8_ALPHA8;case Ls.RGB10A2:return t.RGB10_A2;case Ls.RGB10A2UI:return t.RGB10_A2UI;case Ls.R11G11B10F:return t.R11F_G11F_B10F;case Ls.D16:return t.DEPTH_COMPONENT16;case Ls.D16S8:return t.DEPTH24_STENCIL8;case Ls.D24:return t.DEPTH_COMPONENT24;case Ls.D24S8:return t.DEPTH24_STENCIL8;case Ls.D32F:return t.DEPTH_COMPONENT32F;case Ls.D32F_S8:return t.DEPTH32F_STENCIL8;case Ls.BC1:return yN.COMPRESSED_RGB_S3TC_DXT1_EXT;case Ls.BC1_ALPHA:return yN.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Ls.BC1_SRGB:return yN.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Ls.BC1_SRGB_ALPHA:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Ls.BC2:return yN.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Ls.BC2_SRGB:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Ls.BC3:return yN.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Ls.BC3_SRGB:return yN.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Ls.ETC_RGB8:return yN.COMPRESSED_RGB_ETC1_WEBGL;case Ls.ETC2_RGB8:return yN.COMPRESSED_RGB8_ETC2;case Ls.ETC2_SRGB8:return yN.COMPRESSED_SRGB8_ETC2;case Ls.ETC2_RGB8_A1:return yN.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ls.ETC2_SRGB8_A1:return yN.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Ls.ETC2_RGBA8:return yN.COMPRESSED_RGBA8_ETC2_EAC;case Ls.ETC2_SRGB8_A8:return yN.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Ls.EAC_R11:return yN.COMPRESSED_R11_EAC;case Ls.EAC_R11SN:return yN.COMPRESSED_SIGNED_R11_EAC;case Ls.EAC_RG11:return yN.COMPRESSED_RG11_EAC;case Ls.EAC_RG11SN:return yN.COMPRESSED_SIGNED_RG11_EAC;case Ls.PVRTC_RGB2:return yN.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Ls.PVRTC_RGBA2:return yN.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Ls.PVRTC_RGB4:return yN.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Ls.PVRTC_RGBA4:return yN.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Ls.ASTC_RGBA_4X4:return yN.COMPRESSED_RGBA_ASTC_4x4_KHR;case Ls.ASTC_RGBA_5X4:return yN.COMPRESSED_RGBA_ASTC_5x4_KHR;case Ls.ASTC_RGBA_5X5:return yN.COMPRESSED_RGBA_ASTC_5x5_KHR;case Ls.ASTC_RGBA_6X5:return yN.COMPRESSED_RGBA_ASTC_6x5_KHR;case Ls.ASTC_RGBA_6X6:return yN.COMPRESSED_RGBA_ASTC_6x6_KHR;case Ls.ASTC_RGBA_8X5:return yN.COMPRESSED_RGBA_ASTC_8x5_KHR;case Ls.ASTC_RGBA_8X6:return yN.COMPRESSED_RGBA_ASTC_8x6_KHR;case Ls.ASTC_RGBA_8X8:return yN.COMPRESSED_RGBA_ASTC_8x8_KHR;case Ls.ASTC_RGBA_10X5:return yN.COMPRESSED_RGBA_ASTC_10x5_KHR;case Ls.ASTC_RGBA_10X6:return yN.COMPRESSED_RGBA_ASTC_10x6_KHR;case Ls.ASTC_RGBA_10X8:return yN.COMPRESSED_RGBA_ASTC_10x8_KHR;case Ls.ASTC_RGBA_10X10:return yN.COMPRESSED_RGBA_ASTC_10x10_KHR;case Ls.ASTC_RGBA_12X10:return yN.COMPRESSED_RGBA_ASTC_12x10_KHR;case Ls.ASTC_RGBA_12X12:return yN.COMPRESSED_RGBA_ASTC_12x12_KHR;case Ls.ASTC_SRGBA_4X4:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Ls.ASTC_SRGBA_5X4:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Ls.ASTC_SRGBA_5X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Ls.ASTC_SRGBA_6X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Ls.ASTC_SRGBA_6X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Ls.ASTC_SRGBA_8X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Ls.ASTC_SRGBA_8X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Ls.ASTC_SRGBA_8X8:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Ls.ASTC_SRGBA_10X5:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Ls.ASTC_SRGBA_10X6:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Ls.ASTC_SRGBA_10X8:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Ls.ASTC_SRGBA_10X10:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Ls.ASTC_SRGBA_12X10:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Ls.ASTC_SRGBA_12X12:return yN.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,i),t.glFormat=PL(t.format,i),t.glType=AL(t.format,i);let n=t.width,s=t.height;switch(t.type){case Hs.TEX2D:{t.glTarget=i.TEXTURE_2D;const o=Math.max(n,s);if(o>e.capabilities.maxTextureSize&&C(9100,o,e.capabilities.maxTextureSize),t.samples===Ws.X1){const o=i.createTexture();if(o&&t.size>0){t.glTexture=o;const r=e.stateCache.glTexUnits[e.stateCache.texUnit];if(r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),r.glTexture=t.glTexture),t.glInternalFmt===yN.COMPRESSED_RGB_ETC1_WEBGL){const e=Er(t.format,2,2,1),n=new Uint8Array(e);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternalFmt,2,2,0,n)}else if(t.flags&js.IMMUTABLE)i.texStorage2D(i.TEXTURE_2D,t.mipLevel,t.glInternalFmt,n,s);else if(vr[t.format].isCompressed)for(let e=0;e<t.mipLevel;++e){const o=Er(t.format,n,s,1),r=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,r),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else for(let e=0;e<t.mipLevel;++e)i.texImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else i.deleteTexture(o)}else{const n=i.createRenderbuffer();n&&t.size>0&&(t.glRenderbuffer=n,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height))}break}case Hs.CUBE:{t.glTarget=i.TEXTURE_CUBE_MAP;const o=Math.max(n,s);o>e.capabilities.maxCubeMapTextureSize&&C(9100,o,e.capabilities.maxTextureSize);const r=i.createTexture();if(r&&t.size>0){t.glTexture=r;const o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),o.glTexture=t.glTexture),t.glInternalFmt===yN.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<6;++e){const n=Er(t.format,2,2,1),s=new Uint8Array(n);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,t.glInternalFmt,2,2,0,s)}else if(t.flags&js.IMMUTABLE)i.texStorage2D(i.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,n,s);else if(vr[t.format].isCompressed)for(let e=0;e<t.mipLevel;++e){const o=Er(t.format,n,s,1),r=new Uint8Array(o);for(let o=0;o<6;++o)i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,e,t.glInternalFmt,n,s,0,r);n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else for(let e=0;e<t.mipLevel;++e){for(let o=0;o<6;++o)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null);n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}break}default:console.error("Unsupported TextureType, create texture failed."),t.type=Hs.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}destroy(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}resize(e,t){const i=this._size;this._width=e,this._height=t,this._size=Cr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){const{gl:i}=e;let n=t.width,s=t.height;switch(t.type){case Hs.TEX2D:{t.glTarget=i.TEXTURE_2D;const o=Math.max(n,s);if(o>e.capabilities.maxTextureSize&&C(9100,o,e.capabilities.maxTextureSize),t.samples===Ws.X1){const o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),vr[t.format].isCompressed){if(t.glInternalFmt!==yN.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<t.mipLevel;++e){const o=Er(t.format,n,s,1),r=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,r),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let e=0;e<t.mipLevel;++e)i.texImage2D(i.TEXTURE_2D,e,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else t.glRenderbuffer&&t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break}case Hs.CUBE:{t.type=Hs.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;const o=Math.max(n,s);o>e.capabilities.maxCubeMapTextureSize&&C(9100,o,e.capabilities.maxTextureSize);const r=e.stateCache.glTexUnits[e.stateCache.texUnit];if(r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),r.glTexture=t.glTexture),vr[t.format].isCompressed){if(t.glInternalFmt!==yN.COMPRESSED_RGB_ETC1_WEBGL)for(let e=0;e<6;++e){n=t.width,s=t.height;for(let o=0;o<t.mipLevel;++o){const r=Er(t.format,n,s,1),a=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,o,t.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}}else for(let e=0;e<6;++e){n=t.width,s=t.height;for(let o=0;o<t.mipLevel;++o)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+e,o,t.glInternalFmt,n,s,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported TextureType, create texture failed."),t.type=Hs.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}}const mB="webglcontextlost";class gB extends Ur{constructor(...e){super(...e),this.stateCache=new dB,this.cmdAllocator=new tB,this.nullTex2D=null,this.nullTexCube=null,this._webGL2RC=null,this._isAntialias=!0,this._isPremultipliedAlpha=!0,this._useVAO=!0,this._bindingMappingInfo=new Ro,this._webGLContextLostHandler=null,this._extensions=null,this._EXT_texture_filter_anisotropic=null,this._OES_texture_float_linear=null,this._OES_texture_half_float_linear=null,this._EXT_color_buffer_float=null,this._EXT_disjoint_timer_query_webgl2=null,this._WEBGL_compressed_texture_etc1=null,this._WEBGL_compressed_texture_etc=null,this._WEBGL_compressed_texture_pvrtc=null,this._WEBGL_compressed_texture_astc=null,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._WEBGL_debug_renderer_info=null,this._WEBGL_texture_storage_multisample=null,this._WEBGL_debug_shaders=null,this._WEBGL_lose_context=null}get gl(){return this._webGL2RC}get isAntialias(){return this._isAntialias}get isPremultipliedAlpha(){return this._isPremultipliedAlpha}get useVAO(){return this._useVAO}get bindingMappingInfo(){return this._bindingMappingInfo}get EXT_texture_filter_anisotropic(){return this._EXT_texture_filter_anisotropic}get OES_texture_float_linear(){return this._OES_texture_float_linear}get EXT_color_buffer_float(){return this._EXT_color_buffer_float}get EXT_disjoint_timer_query_webgl2(){return this._EXT_disjoint_timer_query_webgl2}get WEBGL_compressed_texture_etc1(){return this._WEBGL_compressed_texture_etc1}get WEBGL_compressed_texture_etc(){return this._WEBGL_compressed_texture_etc}get WEBGL_compressed_texture_pvrtc(){return this._WEBGL_compressed_texture_pvrtc}get WEBGL_compressed_texture_s3tc(){return this._WEBGL_compressed_texture_s3tc}get WEBGL_compressed_texture_s3tc_srgb(){return this._WEBGL_compressed_texture_s3tc_srgb}get WEBGL_texture_storage_multisample(){return this._WEBGL_texture_storage_multisample}get WEBGL_debug_shaders(){return this._WEBGL_debug_shaders}get WEBGL_lose_context(){return this._WEBGL_lose_context}initialize(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{const e={alpha:Ge.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",e)}catch(e){return console.warn(e),!1}if(!this._webGL2RC)return console.warn("This device does not support WebGL2."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(mB,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=Os.WEBGL2,this._deviceName="WebGL2";const t=this._webGL2RC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=t.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR)),this._version=t.getParameter(t.VERSION),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this._caps.depthBits=t.getParameter(t.DEPTH_BITS),this._caps.stencilBits=t.getParameter(t.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxUniformBufferBindings,this._caps.maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=e.width,this._height=e.height,this._colorFmt=Ls.RGBA8,32===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=Ls.D32F_S8:this._depthStencilFmt=Ls.D32F:24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=Ls.D24S8:this._depthStencilFmt=Ls.D24:8===this._caps.stencilBits?this._depthStencilFmt=Ls.D16S8:this._depthStencilFmt=Ls.D16,this._extensions=t.getSupportedExtensions();let i="";if(this._extensions){for(const e of this._extensions)i+=`${e} `;m(`EXTENSIONS: ${i}`)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=this.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=this.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=this.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[Ns.TEXTURE_FLOAT]=!0,this._features[Ns.TEXTURE_HALF_FLOAT]=!0,this._features[Ns.FORMAT_R11G11B10F]=!0,this._features[Ns.FORMAT_SRGB]=!0,this._features[Ns.FORMAT_RGB8]=!0,this._features[Ns.ELEMENT_INDEX_UINT]=!0,this._features[Ns.INSTANCED_ARRAYS]=!0,this._features[Ns.MULTIPLE_RENDER_TARGETS]=!0,this._features[Ns.BLEND_MINMAX]=!0,this._EXT_color_buffer_float&&(this._features[Ns.COLOR_FLOAT]=!0,this._features[Ns.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Ns.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Ns.TEXTURE_HALF_FLOAT_LINEAR]=!0);let n="";this._WEBGL_compressed_texture_etc1&&(this._features[Ns.FORMAT_ETC1]=!0,n+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Ns.FORMAT_ETC2]=!0,n+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Ns.FORMAT_DXT]=!0,n+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Ns.FORMAT_PVRTC]=!0,n+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Ns.FORMAT_ASTC]=!0,n+="astc "),m(`RENDERER: ${this._renderer}`),m(`VENDOR: ${this._vendor}`),m(`VERSION: ${this._version}`),m(`DPR: ${this._devicePixelRatio}`),m(`SCREEN_SIZE: ${this._width} x ${this._height}`),m(`MAX_VERTEX_ATTRIBS: ${this._caps.maxVertexAttributes}`),m(`MAX_VERTEX_UNIFORM_VECTORS: ${this._caps.maxVertexUniformVectors}`),m(`MAX_FRAGMENT_UNIFORM_VECTORS: ${this._caps.maxFragmentUniformVectors}`),m(`MAX_TEXTURE_IMAGE_UNITS: ${this._caps.maxTextureUnits}`),m(`MAX_VERTEX_TEXTURE_IMAGE_UNITS: ${this._caps.maxVertexTextureUnits}`),m(`MAX_UNIFORM_BUFFER_BINDINGS: ${this._caps.maxUniformBufferBindings}`),m(`MAX_UNIFORM_BLOCK_SIZE: ${this._caps.maxUniformBlockSize}`),m(`DEPTH_BITS: ${this._caps.depthBits}`),m(`STENCIL_BITS: ${this._caps.stencilBits}`),m(`UNIFORM_BUFFER_OFFSET_ALIGNMENT: ${this._caps.uboOffsetAlignment}`),this._EXT_texture_filter_anisotropic&&m(`MAX_TEXTURE_MAX_ANISOTROPY_EXT: ${this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT}`),m(`USE_VAO: ${this._useVAO}`),m(`COMPRESSED_FORMAT: ${n}`),this.initStates(t),this._queue=this.createQueue(new ur(_o.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new hr(this._queue)),this.nullTex2D=this.createTexture(new Lo(Hs.TEX2D,Vs.SAMPLED,Ls.RGBA8,2,2,js.GEN_MIPMAP)),this.nullTexCube=new fB(this),this.nullTexCube.initialize(new Lo(Hs.CUBE,Vs.SAMPLED,Ls.RGBA8,2,2,js.GEN_MIPMAP,6));const s=new wo;s.texExtent.width=2,s.texExtent.height=2;const o=new Uint8Array(this.nullTex2D.size);return o.fill(0),this.copyBuffersToTexture([o],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([o,o,o,o,o,o],this.nullTexCube,[s]),!0}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(mB,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGL2RC=null}resize(e,t){this._width===e&&this._height===t||(m(`Resizing device: ${e}x${t}`),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}flushCommands(e){}acquire(){this.cmdAllocator.releaseCmds()}present(){const e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}createCommandBuffer(e){const t=new(e.type===po.PRIMARY?lB:iB)(this);return t.initialize(e)?t:null}createBuffer(e){const t=new JL(this);return t.initialize(e)?t:null}createTexture(e){const t=new fB(this);return t.initialize(e)?t:null}createSampler(e){const t=new _B(this);return t.initialize(e)?t:null}createDescriptorSet(e){const t=new EL(this);return t.initialize(e)?t:null}createShader(e){const t=new pB(this);return t.initialize(e)?t:null}createInputAssembler(e){const t=new sB(this);return t.initialize(e)?t:null}createRenderPass(e){const t=new uB(this);return t.initialize(e)?t:null}createFramebuffer(e){const t=new nB(this);return t.initialize(e)?t:null}createDescriptorSetLayout(e){const t=new oB(this);return t.initialize(e)?t:null}createPipelineLayout(e){const t=new rB(this);return t.initialize(e)?t:null}createPipelineState(e){const t=new cB(this);return t.initialize(e)?t:null}createQueue(e){const t=new hB(this);return t.initialize(e)?t:null}createGlobalBarrier(e){const t=new Zr(this);return t.initialize(e)?t:null}createTextureBarrier(e){const t=new Jr(this);return t.initialize(e)?t:null}copyBuffersToTexture(e,t,i){ZL(this,e,t.gpuTexture,i)}copyTextureToBuffers(e,t,i){!function(e,t,i,n){const{gl:s}=e,o=e.stateCache,r=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,r);let a=0,c=0,l=1,h=1;switch(t.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const o=n[e];s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,o.texSubres.mipLevel),a=o.texOffset.x,c=o.texOffset.y,l=o.texExtent.width,h=o.texExtent.height,s.readPixels(a,c,l,h,t.glFormat,t.glType,i[e])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}s.bindFramebuffer(s.FRAMEBUFFER,null),o.glFramebuffer=null,s.deleteFramebuffer(r)}(this,e.gpuTexture,t,i)}copyTexImagesToTexture(e,t,i){!function(e,t,i,n){const{gl:s}=e,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);let r=0,a=0;switch(i.glTarget){case s.TEXTURE_2D:for(let e=0;e<n.length;e++){const o=n[e];s.texSubImage2D(s.TEXTURE_2D,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,i.glFormat,i.glType,t[r++])}break;case s.TEXTURE_CUBE_MAP:for(let e=0;e<n.length;e++){const o=n[e],c=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(a=o.texSubres.baseArrayLayer;a<c;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,i.glFormat,i.glType,t[r++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&js.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}copyFramebufferToBuffer(e,t,i){const n=this._webGL2RC,s=e.gpuFramebuffer,o=s.gpuColorTextures[0].format,r=PL(o,n),a=AL(o,n),c=Pr(vr[o]),l=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==s.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,s.glFramebuffer),this.stateCache.glFramebuffer=s.glFramebuffer);const h=new c(t);for(const e of i){const t=e.texExtent.width,i=e.texExtent.height;n.readPixels(e.texOffset.x,e.texOffset.y,t,i,r,a,h)}this.stateCache.glFramebuffer!==l&&(n.bindFramebuffer(n.FRAMEBUFFER,l),this.stateCache.glFramebuffer=l)}blitFramebuffer(e,t,i,n,s){!function(e,t,i,n,s,o){const{gl:r}=e;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(r.bindFramebuffer(r.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);const a=i.glFramebuffer!==e.stateCache.glFramebuffer;a&&r.bindFramebuffer(r.DRAW_FRAMEBUFFER,i.glFramebuffer);let c=0;t.gpuColorTextures.length>0&&(c|=r.COLOR_BUFFER_BIT),t.gpuDepthStencilTexture&&(c|=r.DEPTH_BUFFER_BIT,vr[t.gpuDepthStencilTexture.format].hasStencil&&(c|=r.STENCIL_BUFFER_BIT));const l=o===qs.LINEAR||o===qs.ANISOTROPIC?r.LINEAR:r.NEAREST;r.blitFramebuffer(n.x,n.y,n.x+n.width,n.y+n.height,s.x,s.y,s.x+s.width,s.y+s.height,c,l),a&&r.bindFramebuffer(r.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,i,n,s)}getExtension(e){const t=["","WEBKIT_","MOZ_"];for(let i=0;i<t.length;++i){const n=this.gl.getExtension(t[i]+e);if(n)return n}return null}initStates(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}_onWebGLContextLost(e){T(11e3),p(e)}}var vB,yB,xB,SB,bB;e("WebGL2Device",gB),n.WebGL2Device=gB,function(e){e[e.positions=mo.ATTR_POSITION]="positions",e[e.normals=mo.ATTR_NORMAL]="normals",e[e.uvs=mo.ATTR_TEX_COORD]="uvs",e[e.colors=mo.ATTR_COLOR]="colors"}(vB||(vB={}));class TB{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(e){if(0!==e){const t=this._length%e;if(0!==t){const i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}addBuffer(e){const t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}getLength(){return this._length}getCombined(){const e=new Uint8Array(this._length);let t=0;return this._arrayBufferOrPaddings.forEach((i=>{"number"==typeof i?t+=i:(e.set(new Uint8Array(i),t),t+=i.byteLength)})),e.buffer}}class EB{constructor(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,!this._mesh.struct.morph)return;const i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(let e=0;e<i;++e){const i=this._mesh.struct.morph.subMeshMorphs[e];i&&(i.targets.length>Yd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[e]=new wB(this._mesh,e,this._mesh.struct.morph,t):this._subMeshRenderings[e]=new CB(this._mesh,e,this._mesh.struct.morph,t))}}createInstance(){const e=this._mesh.struct.primitives.length,t=new Array(e);for(let s=0;s<e;++s){var i,n;t[s]=null!==(i=null===(n=this._subMeshRenderings[s])||void 0===n?void 0:n.createInstance())&&void 0!==i?i:null}return{setWeights(e,i){var n;null===(n=t[e])||void 0===n||n.setWeights(i)},requiredPatches:e=>{this._mesh.struct.morph;const i=this._mesh.struct.morph.subMeshMorphs[e],n=t[e];if(null===n)return null;const s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(mo.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(mo.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(mo.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push(...n.requiredPatches()),s},adaptPipelineState:(e,i)=>{var n;null===(n=t[e])||void 0===n||n.adaptPipelineState(i)},destroy:()=>{for(const e of t)null==e||e.destroy()}}}}class CB{constructor(e,t,i,n){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=n;const s=i.subMeshMorphs[t];this._subMeshMorph=s,IB(e,t,n);const o=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=o;const r=s.targets.length,a=RB(n,o*r);this._textureInfo={width:a.width,height:a.height},this._attributes=s.attributes.map(((t,i)=>{const n=a.create(),r=n.valueView;return s.targets.forEach(((t,n)=>{const s=t.displacements[i],a=new Float32Array(e.data.buffer,e.data.byteOffset+s.offset,s.count),c=o*n*4;for(let e=0;e<o;++e)r[c+4*e+0]=a[3*e+0],r[c+4*e+1]=a[3*e+1],r[c+4*e+2]=a[3*e+2]})),n.updatePixels(),{name:t,morphTexture:n}}))}destroy(){for(const e of this._attributes)e.morphTexture.destroy()}createInstance(){const e=new PB(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:t=>{e.setWeights(t),e.commit()},requiredPatches:()=>[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}],adaptPipelineState:t=>{for(const e of this._attributes){let i;switch(e.name){case mo.ATTR_POSITION:i=Zd;break;case mo.ATTR_NORMAL:i=tf;break;case mo.ATTR_TANGENT:i=of;break;default:p("Unexpected attribute!")}void 0!==i&&(t.bindSampler(i,e.morphTexture.sampler),t.bindTexture(i,e.morphTexture.texture))}t.bindBuffer(Yd.BINDING,e.buffer),t.update()},destroy:()=>{}}}}class wB{constructor(e,t,i,n){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=n;const s=i.subMeshMorphs[t];IB(e,t,n),this._attributes=s.attributes.map(((t,i)=>({name:t,targets:s.targets.map((t=>({displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[i].offset,t.displacements[i].count)})))})))}get data(){return this._attributes}createInstance(){return new AB(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)}}class AB{constructor(e,t,i){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new PB(i,0);const n=RB(i,t);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((e=>{const t=n.create();return{attributeName:e.name,morphTexture:t}}))}setWeights(e){for(let t=0;t<this._attributes.length;++t){const i=this._attributes[t],n=i.morphTexture.valueView,s=this._owner.data[t];e.length,s.targets.length;for(let t=0;t<s.targets.length;++t){const i=s.targets[t].displacements,o=e[t],r=i.length/3;if(0===t)for(let e=0;e<r;++e)n[4*e+0]=i[3*e+0]*o,n[4*e+1]=i[3*e+1]*o,n[4*e+2]=i[3*e+2]*o;else if(0!==o)for(let e=0;e<r;++e)n[4*e+0]+=i[3*e+0]*o,n[4*e+1]+=i[3*e+1]*o,n[4*e+2]+=i[3*e+2]*o}i.morphTexture.updatePixels()}}requiredPatches(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]}adaptPipelineState(e){for(const t of this._attributes){let i;switch(t.attributeName){case mo.ATTR_POSITION:i=Zd;break;case mo.ATTR_NORMAL:i=tf;break;case mo.ATTR_TANGENT:i=of;break;default:p("Unexpected attribute!")}void 0!==i&&(e.bindSampler(i,t.morphTexture.sampler),e.bindTexture(i,t.morphTexture.texture))}e.bindBuffer(Yd.BINDING,this._morphUniforms.buffer),e.update()}destroy(){this._morphUniforms.destroy();for(let e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()}}class PB{constructor(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(Yd.SIZE)),this._remoteBuffer=e.createBuffer(new Io(Fs.UNIFORM|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,Yd.SIZE,Yd.SIZE))}destroy(){this._remoteBuffer.destroy()}get buffer(){return this._remoteBuffer}setWeights(e){e.length,this._targetCount;for(let t=0;t<e.length;++t)this._localBuffer.setFloat32(Yd.OFFSET_OF_WEIGHTS+4*t,e[t],n.sys.isLittleEndian)}setMorphTextureInfo(e,t){this._localBuffer.setFloat32(Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,n.sys.isLittleEndian),this._localBuffer.setFloat32(Yd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,n.sys.isLittleEndian)}setVerticesCount(e){this._localBuffer.setFloat32(Yd.OFFSET_OF_VERTICES_COUNT,e,n.sys.isLittleEndian)}commit(){this._remoteBuffer.update(this._localBuffer.buffer)}}function RB(e,t){let i,n,s,o;e.hasFeature(Ns.TEXTURE_FLOAT)?(i=t,s=16,n=wm.PixelFormat.RGBA32F,o=Float32Array):(i=4*t,s=4,n=wm.PixelFormat.RGBA8888,o=Uint8Array);const{width:r,height:a}=function(e){e<5&&(e=5);const t=Kt(Qt(e)),i=t>>1;return{width:1<<(1&t?i+1:i),height:1<<i}}(i);return{width:r,height:a,create:()=>{const t=new ArrayBuffer(r*a*s),i=new Float32Array(t),c=o===Float32Array?i:new o(t),l=new Wf({width:r,height:a,_data:c,_compressed:!1,format:n}),h=new wm;h.setFilters(wm.Filter.NEAREST,wm.Filter.NEAREST),h.setMipFilter(wm.Filter.NONE),h.setWrapMode(wm.WrapMode.CLAMP_TO_EDGE,wm.WrapMode.CLAMP_TO_EDGE,wm.WrapMode.CLAMP_TO_EDGE),h.image=l,h.getGFXTexture()||p("Unexpected: failed to create morph texture?");const u=Qf.getSampler(e,h.getSamplerHash());return{get texture(){return h.getGFXTexture()},get sampler(){return u},get valueView(){return i},destroy(){h.destroy()},updatePixels(){h.uploadData(c)}}}}}function IB(e,t,i){e.renderingSubMeshes[t].enableVertexIdChannel(i)}function MB(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}const OB=new zi,DB=new zi,NB=new Uint8Array;let LB=e("Mesh",Wc("cc.Mesh")((SB=Oc((xB=class extends xh{get _nativeAsset(){return this._data.buffer}set _nativeAsset(e){this._data=new Uint8Array(e)}get subMeshCount(){const e=this.renderingSubMeshes;return e?e.length:0}get minPosition(){return this.struct.minPosition}get maxPosition(){return this.struct.maxPosition}get struct(){return this._struct}get data(){return this._data}get hash(){return this._hash||(this._hash=Vr(this._data,666)),this._hash}get jointBufferIndices(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((e=>e.jointMapIndex||0))}get renderingSubMeshes(){return this.initialize(),this._renderingSubMeshes}constructor(){super(),this.morphRendering=null,Mc(this,"_struct",SB,this),Mc(this,"_hash",bB,this),this._data=NB,this._initialized=!1,this._renderingSubMeshes=null,this._boneSpaceBounds=new Map,this._jointBufferIndices=null}initialize(){if(this._initialized)return;this._initialized=!0;const{buffer:e}=this._data,t=n.director.root.device,i=this._createVertexBuffers(t,e),s=[];for(let n=0;n<this._struct.primitives.length;n++){const o=this._struct.primitives[n];if(0===o.vertexBundelIndices.length)continue;let r=null,a=null;if(o.indexView){const i=o.indexView;let n=i.stride,s=i.length;if(4===n&&!t.hasFeature(Ns.ELEMENT_INDEX_UINT)){const e=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(e>=65536){T(10001,e,65536);continue}n>>=1,s>>=1}r=t.createBuffer(new Io(Fs.INDEX,ks.DEVICE,s,n)),a=new(MB(i.stride))(e,i.offset,i.count),i.stride!==n&&(a=MB(n).from(a)),r.update(a)}const c=o.vertexBundelIndices.map((e=>i[e])),l=[];if(o.vertexBundelIndices.length>0){const e=o.vertexBundelIndices[0],t=this._struct.vertexBundles[e].attributes;for(let e=0;e<t.length;++e){const i=t[e];l[e]=new Xo(i.name,i.format,i.isInstanced,i.stream,i.isInstanced,i.location)}}const h=new cb(c,l,o.primitiveMode,r);h.mesh=this,h.subMeshIdx=n,s.push(h)}this._renderingSubMeshes=s,this._struct.morph&&(this.morphRendering=function(e,t){return new EB(e,t)}(this,t))}destroy(){return this.destroyRenderingMesh(),super.destroy()}destroyRenderingMesh(){if(this._renderingSubMeshes){for(let e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}}assign(e,t){this.reset({struct:e,data:t})}reset(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0}getBoneSpaceBounds(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);const t=[];this._boneSpaceBounds.set(e.hash,t);const i=[],{bindposes:n}=e;for(let e=0;e<n.length;e++)t.push(new xc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);const{primitives:s}=this._struct;for(let e=0;e<s.length;e++){const s=this.readAttribute(e,mo.ATTR_JOINTS),o=this.readAttribute(e,mo.ATTR_WEIGHTS),r=this.readAttribute(e,mo.ATTR_POSITION);if(!s||!o||!r)continue;const a=Math.min(s.length/4,o.length/4,r.length/3);for(let e=0;e<a;e++){zi.set(OB,r[3*e+0],r[3*e+1],r[3*e+2]);for(let r=0;r<4;++r){const a=4*e+r,c=s[a];if(0===o[a]||c>=n.length)continue;zi.transformMat4(DB,OB,n[c]),i[c]=!0;const l=t[c];zi.min(l.center,l.center,DB),zi.max(l.halfExtents,l.halfExtents,DB)}}}for(let e=0;e<n.length;e++){const n=t[e];i[e]?xc.fromPoints(n,n.center,n.halfExtents):t[e]=null}return t}merge(e,t,i){if(i&&!this.validateMergingMesh(e))return!1;const n=new zi,s=t&&new ji,o=t&&new xc;if(s&&t.getRotation(s),!this._initialized){const i=JSON.parse(JSON.stringify(e._struct)),r=e._data.slice();if(t){i.maxPosition&&i.minPosition&&(zi.add(o.center,i.maxPosition,i.minPosition),zi.multiplyScalar(o.center,o.center,.5),zi.subtract(o.halfExtents,i.maxPosition,i.minPosition),zi.multiplyScalar(o.halfExtents,o.halfExtents,.5),xc.transform(o,o,t),zi.add(i.maxPosition,o.center,o.halfExtents),zi.subtract(i.minPosition,o.center,o.halfExtents));for(let e=0;e<i.vertexBundles.length;e++){const o=i.vertexBundles[e];for(let e=0;e<o.attributes.length;e++)if(o.attributes[e].name===mo.ATTR_POSITION||o.attributes[e].name===mo.ATTR_NORMAL){const{format:i}=o.attributes[e],a=new DataView(r.buffer,o.view.offset+BB(o.attributes,e)),c=UB(a,i),l=GB(a,i);if(!c||!l)continue;const h=o.view.count,u=o.view.stride,_=FB(i);for(let i=0;i<h;i++){const r=i*u,a=r+_,h=a+_;switch(n.set(c(r),c(a),c(h)),o.attributes[e].name){case mo.ATTR_POSITION:n.transformMat4(t);break;case mo.ATTR_NORMAL:zi.transformQuat(n,n,s)}l(r,n.x),l(a,n.y),l(h,n.z)}}}}return this.reset({struct:i,data:r}),this.initialize(),!0}const r=new TB;let a,c,l,h,u,_=0,p=0,d=0,f=0,m=0,g=0,v=0,y=0,x=!1;const S=new Array(this._struct.vertexBundles.length);for(let i=0;i<this._struct.vertexBundles.length;++i){const o=this._struct.vertexBundles[i],b=e._struct.vertexBundles[i];d=o.view.offset,f=b.view.offset,p=o.view.stride,_=o.view.count+b.view.count,a=new ArrayBuffer(_*p),c=new Uint8Array(a),l=this._data.subarray(d,d+o.view.length),d+=l.length,h=e._data.subarray(f,f+b.view.length),f+=h.length,c.set(l),m=0;for(const e of o.attributes){v=0,x=!1;for(const t of b.attributes){if(e.name===t.name&&e.format===t.format){x=!0;break}v+=vr[t.format].size}if(x){y=vr[e.format].size,g=o.view.length+m;for(let i=0;i<b.view.count;++i){if(u=h.subarray(v,v+y),c.set(u,g),(e.name===mo.ATTR_POSITION||e.name===mo.ATTR_NORMAL)&&t){const i=new Float32Array(c.buffer,g,3);switch(n.set(i[0],i[1],i[2]),e.name){case mo.ATTR_POSITION:n.transformMat4(t);break;case mo.ATTR_NORMAL:zi.transformQuat(n,n,s)}i[0]=n.x,i[1]=n.y,i[2]=n.z}g+=o.view.stride,v+=b.view.stride}}m+=vr[e.format].size}S[i]={attributes:o.attributes,view:{offset:r.getLength(),length:a.byteLength,count:_,stride:p}},r.addBuffer(a)}let b,T,E,C=0,w=2,A=0;const P=new Array(this._struct.primitives.length);for(let t=0;t<this._struct.primitives.length;++t){const i=this._struct.primitives[t],n=e._struct.primitives[t];P[t]={primitiveMode:i.primitiveMode,vertexBundelIndices:i.vertexBundelIndices};for(const e of i.vertexBundelIndices)A=Math.max(A,this._struct.vertexBundles[e].view.count);if(i.indexView&&n.indexView){C=i.indexView.count,C+=n.indexView.count,d=i.indexView.offset,f=n.indexView.offset,w=C<256?1:C<65536?2:4;const s=new ArrayBuffer(C*w);if(b=2===w?new Uint16Array(s):1===w?new Uint8Array(s):new Uint32Array(s),T=2===i.indexView.stride?new Uint16Array(this._data.buffer,d,i.indexView.count):1===i.indexView.stride?new Uint8Array(this._data.buffer,d,i.indexView.count):new Uint32Array(this._data.buffer,d,i.indexView.count),w===i.indexView.stride)b.set(T);else for(let e=0;e<i.indexView.count;++e)b[e]=T[e];d+=i.indexView.length,E=2===n.indexView.stride?new Uint16Array(e._data.buffer,f,n.indexView.count):1===n.indexView.stride?new Uint8Array(e._data.buffer,f,n.indexView.count):new Uint32Array(e._data.buffer,f,n.indexView.count);for(let e=0;e<n.indexView.count;++e)b[i.indexView.count+e]=A+E[e];f+=n.indexView.length,P[t].indexView={offset:r.getLength(),length:s.byteLength,count:C,stride:w},r.setNextAlignment(w),r.addBuffer(s)}}const R={vertexBundles:S,primitives:P,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return R.minPosition&&e._struct.minPosition&&R.maxPosition&&e._struct.maxPosition&&(t?(zi.add(o.center,e._struct.maxPosition,e._struct.minPosition),zi.multiplyScalar(o.center,o.center,.5),zi.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),zi.multiplyScalar(o.halfExtents,o.halfExtents,.5),xc.transform(o,o,t),zi.add(n,o.center,o.halfExtents),zi.max(R.maxPosition,R.maxPosition,n),zi.subtract(n,o.center,o.halfExtents),zi.min(R.minPosition,R.minPosition,n)):(zi.min(R.minPosition,R.minPosition,e._struct.minPosition),zi.max(R.maxPosition,R.maxPosition,e._struct.maxPosition))),this.reset({struct:R,data:new Uint8Array(r.getCombined())}),this.initialize(),!0}validateMergingMesh(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(let t=0;t<this._struct.vertexBundles.length;++t){const i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(let e=0;e<i.attributes.length;++e)if(i.attributes[e].format!==n.attributes[e].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(let t=0;t<this._struct.primitives.length;++t){const i=this._struct.primitives[t],n=e._struct.primitives[t];if(i.vertexBundelIndices.length!==n.vertexBundelIndices.length)return!1;for(let e=0;e<i.vertexBundelIndices.length;++e)if(i.vertexBundelIndices[e]!==n.vertexBundelIndices[e])return!1;if(i.primitiveMode!==n.primitiveMode)return!1;if(i.indexView){if(void 0===n.indexView)return!1}else if(n.indexView)return!1}return!0}readAttribute(e,t){let i=null;return this._accessAttribute(e,t,((e,t)=>{const n=e.view.count,{format:s}=e.attributes[t],o=Pr(vr[s]);if(0===n)return;const r=new DataView(this._data.buffer,e.view.offset+BB(e.attributes,t)),a=vr[s],c=UB(r,s);if(!o||!c)return;const l=a.count,h=new o(n*l),u=e.view.stride;for(let e=0;e<n;++e)for(let t=0;t<l;++t)h[l*e+t]=c(u*e+h.BYTES_PER_ELEMENT*t);i=h})),i}copyAttribute(e,t,i,n,s){let o=!1;return this._accessAttribute(e,t,((e,t)=>{const r=e.view.count;if(0===r)return void(o=!0);const{format:a}=e.attributes[t],c=new DataView(this._data.buffer,e.view.offset+BB(e.attributes,t)),l=new DataView(i,s),h=vr[a],u=UB(c,a),_=GB(l,a);if(!u||!_)return;const p=h.count,d=e.view.stride,f=FB(a),m=n,g=f;for(let e=0;e<r;++e)for(let t=0;t<p;++t)_(m*e+g*t,u(d*e+f*t));o=!0})),o}readIndices(e){if(e>=this._struct.primitives.length)return null;const t=this._struct.primitives[e];if(!t.indexView)return null;const{stride:i}=t.indexView;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)}copyIndices(e,t){if(e>=this._struct.primitives.length)return!1;const i=this._struct.primitives[e];if(!i.indexView)return!1;const n=i.indexView.count,s=1===i.indexView.stride?Ls.R8UI:2===i.indexView.stride?Ls.R16UI:Ls.R32UI,o=UB(new DataView(this._data.buffer),s);for(let e=0;e<n;++e)t[e]=o(i.indexView.offset+vr[s].size*e);return!0}_accessAttribute(e,t,i){if(e>=this._struct.primitives.length)return;const n=this._struct.primitives[e];for(const e of n.vertexBundelIndices){const n=this._struct.vertexBundles[e],s=n.attributes.findIndex((e=>e.name===t));if(!(s<0)){i(n,s);break}}}_createVertexBuffers(e,t){return this._struct.vertexBundles.map((i=>{const n=e.createBuffer(new Io(Fs.VERTEX,ks.DEVICE,i.view.length,i.view.stride)),s=new Uint8Array(t,i.view.offset,i.view.length);return n.update(s),n}))}initDefault(e){super.initDefault(e),this.reset({struct:{vertexBundles:[],primitives:[]},data:NB})}validate(){return this.renderingSubMeshes.length>0&&this.data.byteLength>0}}).prototype,"_struct",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),bB=Oc(xB.prototype,"_hash",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yB=xB))||yB);function BB(e,t){let i=0;for(let n=0;n<t;++n){const t=e[n];i+=vr[t.format].size}return i}n.Mesh=LB;const{isLittleEndian:zB}=xn;function FB(e){const t=vr[e];return t.size/t.count}function UB(e,t){const i=vr[t],n=i.size/i.count;switch(i.type){case Bs.UNORM:switch(n){case 1:return t=>e.getUint8(t);case 2:return t=>e.getUint16(t,zB);case 4:return t=>e.getUint32(t,zB)}break;case Bs.SNORM:case Bs.INT:switch(n){case 1:return t=>e.getInt8(t);case 2:return t=>e.getInt16(t,zB);case 4:return t=>e.getInt32(t,zB)}break;case Bs.UINT:switch(n){case 1:return t=>e.getUint8(t);case 2:return t=>e.getUint16(t,zB);case 4:return t=>e.getUint32(t,zB)}break;case Bs.FLOAT:return t=>e.getFloat32(t,zB)}return null}function GB(e,t){const i=vr[t],n=i.size/i.count;switch(i.type){case Bs.UNORM:switch(n){case 1:return(t,i)=>e.setUint8(t,i);case 2:return(t,i)=>e.setUint16(t,i,zB);case 4:return(t,i)=>e.setUint32(t,i,zB)}break;case Bs.SNORM:case Bs.INT:switch(n){case 1:return(t,i)=>e.setInt8(t,i);case 2:return(t,i)=>e.setInt16(t,i,zB);case 4:return(t,i)=>e.setInt32(t,i,zB)}break;case Bs.UINT:switch(n){case 1:return(t,i)=>e.setUint8(t,i);case 2:return(t,i)=>e.setUint16(t,i,zB);case 4:return(t,i)=>e.setUint32(t,i,zB)}break;case Bs.FLOAT:return(t,i)=>e.setFloat32(t,i,zB)}return null}const kB=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_NORMAL,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RG32F),new Xo(mo.ATTR_TANGENT,Ls.RGBA32F),new Xo(mo.ATTR_COLOR,Ls.RGBA32F)],HB=new zi;function VB(e,t,i){i=i||{};const n=[];let s=0;const o=[];let r,a=0;const c=e.positions.slice();if(c.length>0){if(r=null,e.attributes)for(const t of e.attributes)if(t.name===mo.ATTR_POSITION){r=t;break}r||(r=kB[0]),n.push(r);const t=vr[r.format];a=Math.max(a,Math.floor(c.length/t.count)),o.push({offset:s,data:c,attribute:r}),s+=t.size}if(e.normals&&e.normals.length>0){if(r=null,e.attributes)for(const t of e.attributes)if(t.name===mo.ATTR_NORMAL){r=t;break}r||(r=kB[1]);const t=vr[r.format];n.push(r),a=Math.max(a,Math.floor(e.normals.length/t.count)),o.push({offset:s,data:e.normals,attribute:r}),s+=t.size}if(e.uvs&&e.uvs.length>0){if(r=null,e.attributes)for(const t of e.attributes)if(t.name===mo.ATTR_TEX_COORD){r=t;break}r||(r=kB[2]);const t=vr[r.format];n.push(r),a=Math.max(a,Math.floor(e.uvs.length/t.count)),o.push({offset:s,data:e.uvs,attribute:r}),s+=t.size}if(e.tangents&&e.tangents.length>0){if(r=null,e.attributes)for(const t of e.attributes)if(t.name===mo.ATTR_TANGENT){r=t;break}r||(r=kB[3]);const t=vr[r.format];n.push(r),a=Math.max(a,Math.floor(e.tangents.length/t.count)),o.push({offset:s,data:e.tangents,attribute:r}),s+=t.size}if(e.colors&&e.colors.length>0){if(r=null,e.attributes)for(const t of e.attributes)if(t.name===mo.ATTR_COLOR){r=t;break}r||(r=kB[4]);const t=vr[r.format];n.push(r),a=Math.max(a,Math.floor(e.colors.length/t.count)),o.push({offset:s,data:e.colors,attribute:r}),s+=t.size}if(e.customAttributes)for(const t of e.customAttributes){const e=vr[t.attr.format];n.push(t.attr),a=Math.max(a,Math.floor(t.values.length/e.count)),o.push({offset:s,data:t.values,attribute:t.attr}),s+=e.size}const l=new TB,h=new ArrayBuffer(a*s),u=new DataView(h);for(const e of o)ob(u,e.data,e.attribute.format,e.offset,s);l.setNextAlignment(0);const _={attributes:n,view:{offset:l.getLength(),length:h.byteLength,count:a,stride:s}};l.addBuffer(h);let p=null,d=0;if(e.indices){const{indices:t}=e;d=t.length,p=new ArrayBuffer(2*d),ob(new DataView(p),t,Ls.R16UI)}const f={primitiveMode:e.primitiveMode||oo.TRIANGLE_LIST,vertexBundelIndices:[0]};p&&(l.setNextAlignment(2),f.indexView={offset:l.getLength(),length:p.byteLength,count:d,stride:2},l.addBuffer(p));let m=e.minPos;if(!m&&i.calculateBounds){m=zi.set(new zi,1/0,1/0,1/0);for(let e=0;e<a;++e)zi.set(HB,c[3*e+0],c[3*e+1],c[3*e+2]),zi.min(m,m,HB)}let g=e.maxPos;if(!g&&i.calculateBounds){g=zi.set(new zi,-1/0,-1/0,-1/0);for(let e=0;e<a;++e)zi.set(HB,c[3*e+0],c[3*e+1],c[3*e+2]),zi.max(g,g,HB)}const v={vertexBundles:[_],primitives:[f]};return m&&(v.minPosition=new zi(m.x,m.y,m.z)),g&&(v.maxPosition=new zi(g.x,g.y,g.z)),t||(t=new LB),t.reset({struct:v,data:new Uint8Array(l.getCombined())}),t}var jB,WB,qB,XB,YB,KB,$B,QB,ZB,JB,ez,tz,iz,nz,sz,oz,rz,az,cz,lz,hz,uz,_z,pz,dz,fz,mz,gz,vz,yz,xz=Object.freeze({__proto__:null,find:JE,toPPM:function(e,t,i){return`P3 ${t} ${i} 255\n${e.filter(((e,t)=>t%4<3)).toString()}\n`},readMesh:function(e,t=0){const i={positions:[]},n=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),s=e.struct,o=s.primitives[t];for(const e of o.vertexBundelIndices){const t=s.vertexBundles[e];let o=t.view.offset;const{length:r,stride:a}=t.view;for(const e of t.attributes){const t=vB[e.name];t&&(i[t]=(i[t]||[]).concat(rb(n,e.format,o,r,a))),o+=vr[e.format].size}}const r=o.indexView;return i.indices=rb(n,Ls[`R${8*r.stride}UI`],r.offset,r.length),i},createMesh:VB,readBuffer:rb,writeBuffer:ob,mapBuffer:ab});e("utils",xz);class Sz extends Tg{constructor(...e){super(...e),this._morphRenderingInstance=null,this._usedMaterials=new Set}getMacroPatches(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):null}initSubModel(e,t,i){return super.initSubModel(e,t,this._launderMaterial(i))}destroy(){super.destroy(),this._morphRenderingInstance=null}setSubModelMaterial(e,t){return super.setSubModelMaterial(e,this._launderMaterial(t))}_updateLocalDescriptors(e,t){super._updateLocalDescriptors(e,t),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,t)}_launderMaterial(e){return e}setMorphRendering(e){this._morphRenderingInstance=e}}const bz=Le({OFF:0,ON:1}),Tz=Le({OFF:0,ON:1});let Ez=(jB=Wc("cc.ModelLightmapSettings"),WB=Zc("_recieveShadow"),jB((YB=Oc((XB=class{constructor(){Mc(this,"texture",YB,this),Mc(this,"uvParam",KB,this),Mc(this,"_bakeable",$B,this),Mc(this,"_castShadow",QB,this),Mc(this,"_receiveShadow",ZB,this),Mc(this,"_lightmapSize",JB,this)}get bakeable(){return this._bakeable}set bakeable(e){this._bakeable=e}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._receiveShadow=e}get lightmapSize(){return this._lightmapSize}set lightmapSize(e){this._lightmapSize=e}}).prototype,"texture",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KB=Oc(XB.prototype,"uvParam",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new an}}),$B=Oc(XB.prototype,"_bakeable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QB=Oc(XB.prototype,"_castShadow",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZB=Oc(XB.prototype,"_receiveShadow",[WB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JB=Oc(XB.prototype,"_lightmapSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Oc(XB.prototype,"bakeable",[cl],Object.getOwnPropertyDescriptor(XB.prototype,"bakeable"),XB.prototype),Oc(XB.prototype,"castShadow",[cl],Object.getOwnPropertyDescriptor(XB.prototype,"castShadow"),XB.prototype),Oc(XB.prototype,"receiveShadow",[cl],Object.getOwnPropertyDescriptor(XB.prototype,"receiveShadow"),XB.prototype),Oc(XB.prototype,"lightmapSize",[cl],Object.getOwnPropertyDescriptor(XB.prototype,"lightmapSize"),XB.prototype),qB=XB))||qB),Cz=function(t){return e({MeshRenderer:t,ModelComponent:t}),t}((ez=Wc("cc.MeshRenderer"),tz=al(),iz=Xc(100),nz=nl(),sz=Al(bz),oz=_l(),rz=Al(Tz),az=_l(),cz=Al(LB),lz=_l(),hz=ll(),ez(uz=tz(uz=iz(uz=nz(uz=il((yz=vz=class extends iI{get shadowCastingMode(){return this._shadowCastingMode}set shadowCastingMode(e){this._shadowCastingMode=e,this._updateCastShadow()}get receiveShadow(){return this._shadowReceivingMode}set receiveShadow(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}get mesh(){return this._mesh}set mesh(e){const t=this._mesh,i=this._mesh=e;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}get model(){return this._model}get enableMorph(){return this._enableMorph}set enableMorph(e){this._enableMorph=e}constructor(){super(),Mc(this,"lightmapSettings",pz,this),Mc(this,"_mesh",dz,this),Mc(this,"_shadowCastingMode",fz,this),Mc(this,"_shadowReceivingMode",mz,this),this._subMeshShapesWeights=[],this._modelType=void 0,this._model=null,this._morphInstance=null,Mc(this,"_enableMorph",gz,this),this._modelType=Tg}onLoad(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onRestore(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onEnable(){this._model||this._updateModels(),this._attachToScene()}onDisable(){this._model&&this._detachFromScene()}onDestroy(){this._model&&(n.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}getWeight(e,t){const{_subMeshShapesWeights:i}=this;i.length;const n=this._subMeshShapesWeights[e];return n.length,n[t]}setWeights(e,t){const{_subMeshShapesWeights:i}=this;t>=i.length||i[t].length===e.length&&(i[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))}setWeight(e,t,i){const{_subMeshShapesWeights:n}=this;if(t>=n.length)return;const s=n[t];i>=s.length||(s[i]=e,this._uploadSubMeshShapesWeights(t))}setInstancedAttribute(e,t){if(!this.model)return;const{attributes:i,views:n}=this.model.instancedAttributes;for(let s=0;s<i.length;s++)if(i[s].name===e){n[s].set(t);break}}_updateLightmap(e,t,i,n,s){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=s,this._onUpdateLightingmap()}_updateModels(){if(!this.enabledInHierarchy||!this._mesh)return;const e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}_createModel(){const e=this._morphInstance&&this._modelType===Tg?Sz:this._modelType,t=this._model=n.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof Sz&&t.setMorphRendering(this._morphInstance)}_attachToScene(){if(!this.node.scene||!this._model)return;const e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}_updateModelParams(){if(!this._mesh||!this._model)return;this.node.hasChangedFlags|=Cg.POSITION,this._model.transform.hasChangedFlags|=Cg.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();const e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(let i=0;i<e;++i){let e=this.getRenderMaterial(i);e&&!e.isValid&&(e=null);const n=t[i];n&&this._model.initSubModel(i,n,e||this._getBuiltinMaterial())}this._model.enabled=!0}_onUpdateLightingmap(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}_onMaterialModified(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}_onRebuildPSO(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())}_onMeshChanged(e){}_clearMaterials(){if(!this._model)return;const e=this._model.subModels;for(let t=0;t<e.length;++t)this._onMaterialModified(t,null)}_getBuiltinMaterial(){return cg.get("missing-material")}_onVisibilityChange(e){this._model&&(this._model.visFlags=e)}_updateCastShadow(){this._model&&(this._shadowCastingMode===bz.OFF?this._model.castShadow=!1:(this._shadowCastingMode,bz.ON,this._shadowCastingMode,this._model.castShadow=!0))}_updateReceiveShadow(){this._model&&(this._shadowReceivingMode===Tz.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}_isBatchingEnabled(){for(let e=0;e<this._materials.length;++e){const t=this._materials[e];if(t)for(let e=0;e<t.passes.length;++e)if(t.passes[e].batchingScheme)return!0}return!1}_watchMorphInMesh(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),!this._enableMorph)return;if(!this._mesh||!this._mesh.struct.morph||!this._mesh.morphRendering)return;this._morphInstance=this._mesh.morphRendering.createInstance();const e=this._mesh.struct.primitives.length;for(let t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof Sz&&this._model.setMorphRendering(this._morphInstance)}_initSubMeshShapesWeights(){const{_mesh:e}=this;if(this._subMeshShapesWeights.length=0,!e)return;const t=e.struct.morph;if(!t)return;const i=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((e=>e?e.weights?e.weights.slice(0):i?(i.length,e.targets.length,i.slice(0)):new Array(e.targets.length).fill(0):[]))}_validateShapeWeights(){const{_mesh:e,_subMeshShapesWeights:t}=this;if(!e||!e.struct.morph)return 0===t.length;const{morph:i}=e.struct;return i.subMeshMorphs.length===t.length&&t.every((({length:e},t)=>{var n,s;return(null!==(n=null===(s=i.subMeshMorphs[t])||void 0===s?void 0:s.targets.length)&&void 0!==n?n:0)===e}))}_uploadSubMeshShapesWeights(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])}},vz.ShadowCastingMode=bz,vz.ShadowReceivingMode=Tz,pz=Oc((_z=yz).prototype,"lightmapSettings",[Qc,cl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ez}}),dz=Oc(_z.prototype,"_mesh",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fz=Oc(_z.prototype,"_shadowCastingMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bz.OFF}}),mz=Oc(_z.prototype,"_shadowReceivingMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tz.ON}}),Oc(_z.prototype,"shadowCastingMode",[sz,oz,bl],Object.getOwnPropertyDescriptor(_z.prototype,"shadowCastingMode"),_z.prototype),Oc(_z.prototype,"receiveShadow",[rz,az,bl],Object.getOwnPropertyDescriptor(_z.prototype,"receiveShadow"),_z.prototype),Oc(_z.prototype,"mesh",[cz,lz],Object.getOwnPropertyDescriptor(_z.prototype,"mesh"),_z.prototype),Oc(_z.prototype,"enableMorph",[hz,bl],Object.getOwnPropertyDescriptor(_z.prototype,"enableMorph"),_z.prototype),gz=Oc(_z.prototype,"_enableMorph",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uz=_z))||uz)||uz)||uz)||uz)||uz));function wz(e,t){const i=e.sharedMaterials.length;if(i!==t.sharedMaterials.length)return!1;for(let n=0;n<i;n++)if(e.getRenderMaterial(n)!==t.getRenderMaterial(n))return!1;return!0}var Az,Pz,Rz,Iz,Mz,Oz,Dz,Nz;e("BatchingUtility",class{static batchStaticModel(e,t){const i=e.getComponentsInChildren(Cz);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(let e=1;e<i.length;e++){if(!i[0].mesh.validateMergingMesh(i[e].mesh))return console.error(`the meshes of ${i[0].node.name} and ${i[e].node.name} can't be merged`),!1;if(!wz(i[0],i[e]))return console.error(`the materials of ${i[0].node.name} and ${i[e].node.name} can't be merged`),!1}const n=new LB,s=new Zi,o=new Zi;e.getWorldMatrix(o),Zi.invert(o,o);for(let e=0;e<i.length;e++){const t=i[e];t.node.getWorldMatrix(s),Zi.multiply(s,o,s),n.merge(i[e].mesh,s),t.enabled=!1}const r=t.addComponent(Cz);return r.mesh=n,r.sharedMaterials=i[0].sharedMaterials,!0}static unbatchStaticModel(e,t){const i=e.getComponentsInChildren(Cz);for(let e=0;e<i.length;e++)i[e].enabled=!0;const n=t.getComponent(Cz);return n&&(n.mesh&&n.mesh.destroyRenderingMesh(),n.destroy()),!0}}),ei(LB.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),ti(LB.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);let Lz=e("Skeleton",(Az=Wc("cc.Skeleton"),Pz=Al([lt]),Rz=Al([Zi]),Az((Oz=Oc((Mz=class extends xh{constructor(...e){super(...e),Mc(this,"_joints",Oz,this),Mc(this,"_bindposes",Dz,this),Mc(this,"_hash",Nz,this),this._invBindposes=null}get joints(){return this._joints}set joints(e){this._joints=e}get bindposes(){return this._bindposes}set bindposes(e){this._bindposes=e}get inverseBindposes(){if(!this._invBindposes){this._invBindposes=[];for(let e=0;e<this._bindposes.length;e++){const t=new Zi;Zi.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}get hash(){if(!this._hash){let e="";for(let t=0;t<this._bindposes.length;t++){const i=this._bindposes[t];e+=`${i.m00.toPrecision(2)} ${i.m01.toPrecision(2)} ${i.m02.toPrecision(2)} ${i.m03.toPrecision(2)} ${i.m04.toPrecision(2)} ${i.m05.toPrecision(2)} ${i.m06.toPrecision(2)} ${i.m07.toPrecision(2)} ${i.m08.toPrecision(2)} ${i.m09.toPrecision(2)} ${i.m10.toPrecision(2)} ${i.m11.toPrecision(2)} ${i.m12.toPrecision(2)} ${i.m13.toPrecision(2)} ${i.m14.toPrecision(2)} ${i.m15.toPrecision(2)}\n`}this._hash=Vr(e,666)}return this._hash}destroy(){var e,t;return null===(e=null===(t=n.director.root)||void 0===t?void 0:t.dataPoolManager)||void 0===e||e.releaseSkeleton(this),super.destroy()}validate(){return this.joints.length>0&&this.bindposes.length>0}}).prototype,"_joints",[Pz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dz=Oc(Mz.prototype,"_bindposes",[Rz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nz=Oc(Mz.prototype,"_hash",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Iz=Mz))||Iz));var Bz,zz,Fz,Uz,Gz,kz,Hz,Vz,jz,Wz,qz,Xz,Yz,Kz,$z,Qz,Zz,Jz,eF,tF;n.Skeleton=Lz,ti(Cz.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),n.ModelComponent=Cz,De.setClassAlias(Cz,"cc.ModelComponent");const iF=Le({LUMINOUS_FLUX:0,LUMINANCE:1}),nF=new zi;let sF=Wc("cc.StaticLightSettings")((Fz=Oc((zz=class{constructor(){Mc(this,"_baked",Fz,this),Mc(this,"_editorOnly",Uz,this),Mc(this,"_bakeable",Gz,this),Mc(this,"_castShadow",kz,this)}get editorOnly(){return this._editorOnly}set editorOnly(e){this._editorOnly=e}get baked(){return this._baked}set baked(e){this._baked=e}get bakeable(){return this._bakeable}set bakeable(e){this._bakeable=e}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e}}).prototype,"_baked",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uz=Oc(zz.prototype,"_editorOnly",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gz=Oc(zz.prototype,"_bakeable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kz=Oc(zz.prototype,"_castShadow",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(zz.prototype,"editorOnly",[cl],Object.getOwnPropertyDescriptor(zz.prototype,"editorOnly"),zz.prototype),Oc(zz.prototype,"bakeable",[cl],Object.getOwnPropertyDescriptor(zz.prototype,"bakeable"),zz.prototype),Oc(zz.prototype,"castShadow",[cl],Object.getOwnPropertyDescriptor(zz.prototype,"castShadow"),zz.prototype),Bz=zz))||Bz,oF=function(t){return e({Light:t,LightComponent:t}),t}((Hz=Wc("cc.Light"),Vz=_l(),jz=_l(),Wz=pl(),qz=_l(),Xz=Al(sF),Hz((tF=eF=class extends Gh{get color(){return this._color}set color(e){this._color=e,this._light&&(nF.x=e.r/255,nF.y=e.g/255,nF.z=e.b/255,this._light.color=nF)}get useColorTemperature(){return this._useColorTemperature}set useColorTemperature(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}get colorTemperature(){return this._colorTemperature}set colorTemperature(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}get staticSettings(){return this._staticSettings}set staticSettings(e){this._staticSettings=e}get type(){return this._type}get baked(){return this.staticSettings.baked}set baked(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}constructor(){super(),Mc(this,"_color",$z,this),Mc(this,"_useColorTemperature",Qz,this),Mc(this,"_colorTemperature",Zz,this),Mc(this,"_staticSettings",Jz,this),this._type=ev.UNKNOWN,this._lightType=void 0,this._light=null,this._lightType=iv}onLoad(){this._createLight()}onEnable(){this._attachToScene()}onDisable(){this._detachFromScene()}onDestroy(){this._destroyLight()}_createLight(){this._light||(this._light=n.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked}_destroyLight(){this._light&&(n.director.root.destroyLight(this),this._light=null)}_attachToScene(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){const e=this._getRenderScene();switch(this._type){case ev.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case ev.SPHERE:e.addSphereLight(this._light);break;case ev.SPOT:e.addSpotLight(this._light)}}}_detachFromScene(){if(this._light&&this._light.scene){const e=this._light.scene;switch(this._type){case ev.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case ev.SPHERE:e.removeSphereLight(this._light);break;case ev.SPOT:e.removeSpotLight(this._light)}}}},eF.Type=ev,eF.PhotometricTerm=iF,$z=Oc((Kz=tF).prototype,"_color",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),Qz=Oc(Kz.prototype,"_useColorTemperature",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zz=Oc(Kz.prototype,"_colorTemperature",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),Jz=Oc(Kz.prototype,"_staticSettings",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new sF}}),Oc(Kz.prototype,"color",[Vz],Object.getOwnPropertyDescriptor(Kz.prototype,"color"),Kz.prototype),Oc(Kz.prototype,"useColorTemperature",[jz],Object.getOwnPropertyDescriptor(Kz.prototype,"useColorTemperature"),Kz.prototype),Oc(Kz.prototype,"colorTemperature",[gl,Wz,qz],Object.getOwnPropertyDescriptor(Kz.prototype,"colorTemperature"),Kz.prototype),Oc(Kz.prototype,"staticSettings",[Xz],Object.getOwnPropertyDescriptor(Kz.prototype,"staticSettings"),Kz.prototype),Yz=Kz))||Yz));var rF,aF,cF,lF,hF,uF,_F,pF;let dF=function(t){return e({DirectionalLight:t,DirectionalLightComponent:t}),t}((rF=Wc("cc.DirectionalLight"),aF=al(),cF=nl(),lF=yl(),hF=_l(),rF(uF=aF(uF=cF(uF=il((pF=Oc((_F=class extends oF{get illuminance(){return this._illuminance}set illuminance(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}constructor(){super(),Mc(this,"_illuminance",pF,this),this._type=ev.DIRECTIONAL,this._light=null,this._lightType=ov}_createLight(){super._createLight(),this._light&&(this.illuminance=this._illuminance)}}).prototype,"_illuminance",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),Oc(_F.prototype,"illuminance",[lF,hF],Object.getOwnPropertyDescriptor(_F.prototype,"illuminance"),_F.prototype),uF=_F))||uF)||uF)||uF)||uF));var fF,mF,gF,vF,yF,xF,SF,bF,TF,EF,CF,wF,AF,PF,RF,IF,MF;let OF=function(t){return e({SphereLight:t,SphereLightComponent:t}),t}((fF=Wc("cc.SphereLight"),mF=al(),gF=nl(),vF=yl(),yF=_l(),xF=yl(),SF=_l(),bF=Al(iF),TF=_l(),EF=_l(),CF=_l(),fF(wF=mF(wF=gF(wF=il((PF=Oc((AF=class extends oF{get luminousFlux(){return this._luminance*tv(this._size)}set luminousFlux(e){this._luminance=e/tv(this._size),this._light&&(this._light.luminance=this._luminance)}get luminance(){return this._luminance}set luminance(e){this._luminance=e,this._light&&(this._light.luminance=e)}get term(){return this._term}set term(e){this._term=e}get size(){return this._size}set size(e){this._size=e,this._light&&(this._light.size=e)}get range(){return this._range}set range(e){this._range=e,this._light&&(this._light.range=e)}constructor(){super(),Mc(this,"_size",PF,this),Mc(this,"_luminance",RF,this),Mc(this,"_term",IF,this),Mc(this,"_range",MF,this),this._type=ev.SPHERE,this._light=null,this._lightType=uv}_createLight(){super._createLight(),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range)}}).prototype,"_size",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),RF=Oc(AF.prototype,"_luminance",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/tv(.15)}}),IF=Oc(AF.prototype,"_term",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iF.LUMINOUS_FLUX}}),MF=Oc(AF.prototype,"_range",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Oc(AF.prototype,"luminousFlux",[vF,yF],Object.getOwnPropertyDescriptor(AF.prototype,"luminousFlux"),AF.prototype),Oc(AF.prototype,"luminance",[xF,SF],Object.getOwnPropertyDescriptor(AF.prototype,"luminance"),AF.prototype),Oc(AF.prototype,"term",[bF,TF],Object.getOwnPropertyDescriptor(AF.prototype,"term"),AF.prototype),Oc(AF.prototype,"size",[EF],Object.getOwnPropertyDescriptor(AF.prototype,"size"),AF.prototype),Oc(AF.prototype,"range",[CF],Object.getOwnPropertyDescriptor(AF.prototype,"range"),AF.prototype),wF=AF))||wF)||wF)||wF)||wF));var DF,NF,LF,BF,zF,FF,UF,GF,kF,HF,VF,jF,WF,qF,XF,YF,KF,$F,QF,ZF;let JF=function(t){return e({SpotLight:t,SpotLightComponent:t}),t}((DF=Wc("cc.SpotLight"),NF=al(),LF=nl(),BF=yl(),zF=_l(),FF=yl(),UF=_l(),GF=Al(iF),kF=_l(),HF=_l(),VF=_l(),jF=pl(),WF=_l(),DF(qF=NF(qF=LF(qF=il((YF=Oc((XF=class extends oF{get luminousFlux(){return this._luminance*tv(this._size)}set luminousFlux(e){this._luminance=e/tv(this._size),this._light&&(this._light.luminance=this._luminance)}get luminance(){return this._luminance}set luminance(e){this._luminance=e,this._light&&(this._light.luminance=e)}get term(){return this._term}set term(e){this._term=e}get size(){return this._size}set size(e){this._size=e,this._light&&(this._light.size=e)}get range(){return this._range}set range(e){this._range=e,this._light&&(this._light.range=e)}get spotAngle(){return this._spotAngle}set spotAngle(e){this._spotAngle=e,this._light&&(this._light.spotAngle=gi(e))}constructor(){super(),Mc(this,"_size",YF,this),Mc(this,"_luminance",KF,this),Mc(this,"_term",$F,this),Mc(this,"_range",QF,this),Mc(this,"_spotAngle",ZF,this),this._type=ev.SPOT,this._light=null,this._lightType=vv}_createLight(){super._createLight(),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle)}}).prototype,"_size",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),KF=Oc(XF.prototype,"_luminance",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/tv(.15)}}),$F=Oc(XF.prototype,"_term",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iF.LUMINOUS_FLUX}}),QF=Oc(XF.prototype,"_range",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ZF=Oc(XF.prototype,"_spotAngle",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Oc(XF.prototype,"luminousFlux",[BF,zF],Object.getOwnPropertyDescriptor(XF.prototype,"luminousFlux"),XF.prototype),Oc(XF.prototype,"luminance",[FF,UF],Object.getOwnPropertyDescriptor(XF.prototype,"luminance"),XF.prototype),Oc(XF.prototype,"term",[GF,kF],Object.getOwnPropertyDescriptor(XF.prototype,"term"),XF.prototype),Oc(XF.prototype,"size",[HF],Object.getOwnPropertyDescriptor(XF.prototype,"size"),XF.prototype),Oc(XF.prototype,"range",[VF],Object.getOwnPropertyDescriptor(XF.prototype,"range"),XF.prototype),Oc(XF.prototype,"spotAngle",[gl,jF,WF],Object.getOwnPropertyDescriptor(XF.prototype,"spotAngle"),XF.prototype),qF=XF))||qF)||qF)||qF)||qF));n.LightComponent=oF,De.setClassAlias(oF,"cc.LightComponent"),n.DirectionalLightComponent=dF,De.setClassAlias(dF,"cc.DirectionalLightComponent"),n.SphereLightComponent=OF,De.setClassAlias(OF,"cc.SphereLightComponent"),n.SpotLightComponent=JF,De.setClassAlias(JF,"cc.SpotLightComponent"),ei(JF.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter(){return this.luminousFlux},customSetter(e){this.luminousFlux=e}}]),ei(OF.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter(){return this.luminousFlux},customSetter(e){this.luminousFlux=e}}]),ei(oF.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);const eU=function(e,t,i){e[t+0]=i.m00,e[t+1]=i.m01,e[t+2]=i.m02,e[t+3]=i.m12,e[t+4]=i.m04,e[t+5]=i.m05,e[t+6]=i.m06,e[t+7]=i.m13,e[t+8]=i.m08,e[t+9]=i.m09,e[t+10]=i.m10,e[t+11]=i.m14};function tU(e,t){const i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*i,e)/12)}new ji,new ji,new zi,new ji,new zi;const iU=$f([qs.POINT,qs.POINT,qs.NONE,Xs.CLAMP,Xs.CLAMP,Xs.CLAMP]),nU=new zi,sU=new zi,oU=new zi,rU=new zi,aU=new Zi,cU=new Zi,lU=new xc,hU=Number.MAX_SAFE_INTEGER;class uU{get pixelsPerJoint(){return this._pixelsPerJoint}constructor(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;const t=function(e){return e.hasFeature(Ns.TEXTURE_FLOAT)?Ls.RGBA32F:Ls.RGBA8}(this._device);this._formatSize=vr[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Ev(e),this._pool.initialize({format:t,roundUpFn:tU}),this._customPool=new Ev(e),this._customPool.initialize({format:t,roundUpFn:tU})}clear(){this._pool.destroy(),this._textureBuffers.clear()}registerCustomTextureLayouts(e){for(let t=0;t<e.length;t++){const i=e[t],n=this._customPool.createChunk(i.textureLength);for(let e=0;e<i.contents.length;e++){const t=i.contents[e],{skeleton:s}=t;this._chunkIdxMap.set(s,n);for(let e=0;e<t.clips.length;e++){const i=t.clips[e];this._chunkIdxMap.set(s^i,n)}}}}getDefaultPoseTexture(e,t,i){const n=0^e.hash;let s=this._textureBuffers.get(n)||null;if(s&&s.bounds.has(t.hash))return s.refCount++,s;const{joints:o,bindposes:r}=e;let a=null,c=!1;const l=o.length;if(s)s.refCount++;else{const t=12*l,i=this._chunkIdxMap.get(n),o=void 0!==i?this._customPool.alloc(t*Float32Array.BYTES_PER_ELEMENT,i):this._pool.alloc(t*Float32Array.BYTES_PER_ELEMENT);if(!o)return s;s={pixelOffset:o.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:o},a=new Float32Array(t),c=!0}zi.set(oU,hU,hU,hU),zi.set(rU,-hU,-hU,-hU);const h=t.getBoneSpaceBounds(e);for(let t=0,n=0;t<l;t++,n+=12){const s=i.getChildByPath(o[t]),l=s?uN(s,i,aU):e.inverseBindposes[t],u=h[t];u&&(xc.transform(lU,u,l),lU.getBoundary(nU,sU),zi.min(oU,oU,nU),zi.max(rU,rU,sU)),c&&(s&&Zi.multiply(l,l,r[t]),eU(a,n,s?l:Zi.IDENTITY))}const u=[new xc];return s.bounds.set(t.hash,u),xc.fromPoints(u[0],oU,rU),c&&(this._pool.update(s.handle,a.buffer),this._textureBuffers.set(n,s)),s}getSequencePoseTexture(e,t,i,n){const s=e.hash^t.hash;let o=this._textureBuffers.get(s)||null;if(o&&o.bounds.has(i.hash))return o.refCount++,o;const{joints:r,bindposes:a}=e,c=HM.getOrExtract(t),{frames:l}=c;let h=null,u=!1;const _=r.length;if(o)o.refCount++;else{const i=12*_*l,r=this._chunkIdxMap.get(s),a=void 0!==r?this._customPool.alloc(i*Float32Array.BYTES_PER_ELEMENT,r):this._pool.alloc(i*Float32Array.BYTES_PER_ELEMENT);if(!a)return null;const c=this._createAnimInfos(e,t,n);o={pixelOffset:a.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:a,animInfos:c},h=new Float32Array(i),u=!0}const p=i.getBoneSpaceBounds(e),d=[];o.bounds.set(i.hash,d);for(let e=0;e<l;e++)d.push(new xc(hU,hU,hU,-hU,-hU,-hU));for(let t=0,i=0;t<l;t++){const n=d[t];for(let s=0;s<_;s++,i+=12){const{curveData:r,downstream:c,bindposeIdx:l,bindposeCorrection:_}=o.animInfos[s];let d,f=!0;r&&c?d=Zi.multiply(aU,r[t],c):r?d=r[t]:c?d=c:(d=e.inverseBindposes[l],f=!1);const m=p[s];if(m){const e=_?Zi.multiply(cU,d,_):d;xc.transform(lU,m,e),lU.getBoundary(nU,sU),zi.min(n.center,n.center,nU),zi.max(n.halfExtents,n.halfExtents,sU)}u&&(f&&Zi.multiply(aU,d,a[l]),eU(h,i,f?aU:Zi.IDENTITY))}xc.fromPoints(n,n.center,n.halfExtents)}return u&&(this._pool.update(o.handle,h.buffer),this._textureBuffers.set(s,o)),o}releaseHandle(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){const t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}}releaseSkeleton(e){const t=this._textureBuffers.values();let i=t.next();for(;!i.done;){const n=i.value;n.skeletonHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}}releaseAnimationClip(e){const t=this._textureBuffers.values();let i=t.next();for(;!i.done;){const n=i.value;n.clipHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}}_createAnimInfos(e,t,i){const n=[],{joints:s,bindposes:o}=e,r=s.length,a=HM.getOrExtract(t);for(let t=0;t<r;t++){let c,l,h=s[t],u=a.joints[h],_=i.getChildByPath(h);for(;!u;){const e=h.lastIndexOf("/");if(h=h.substring(0,e),u=a.joints[h],_?(c||(c=new Zi),Zi.fromRTS(aU,_.rotation,_.position,_.scale),Zi.multiply(c,aU,c),_=_.parent):l=h,e<0)break}let p,d=t;if(void 0!==l&&u){d=t-1;for(let i=0;i<r;i++)if(s[i]===l){d=i,p=new Zi,Zi.multiply(p,o[i],e.inverseBindposes[t]);break}}n.push({curveData:u&&u.transforms,downstream:c,bindposeIdx:d,bindposeCorrection:p})}return n}}class _U{constructor(e){this._pool=new Map,this._device=void 0,this._device=e}getData(e="-1"){const t=this._pool.get(e);if(t)return t;const i=this._device.createBuffer(new Io(Fs.UNIFORM|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,qd.SIZE,qd.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);const s={buffer:i,data:n,dirty:!1};return this._setAnimInfoDirty(s,!1),this._pool.set(e,s),s}destroy(e){const t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))}_setAnimInfoDirty(e,t){e.dirty=t;{const i="nativeDirty",n=t?1:0;if(!e[i])return void Object.defineProperty(e,i,{value:new Uint32Array(1).fill(n),enumerable:!0});e[i].fill(n)}}switchClip(e,t){return e.data[0]=0,e.buffer.update(e.data),this._setAnimInfoDirty(e,!1),e}clear(){for(const e of this._pool.values())e.buffer.destroy();this._pool.clear()}}n.internal.DataPoolManager=class{constructor(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new uU(e),this.jointAnimationInfo=new _U(e)}releaseSkeleton(e){this.jointTexturePool.releaseSkeleton(e)}releaseAnimationClip(e){this.jointTexturePool.releaseAnimationClip(e)}clear(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()}};const pU=[{name:"CC_USE_SKINNING",value:!0}];function dU(e,t,i,n){for(let s=0;s<i.length;s++){const o=i[s];let r=-1;for(let e=0;e<o.length;e++)if(o[e]===n){r=e;break}r>=0&&(t.push(s),e.push(r))}}const fU=new zi,mU=new zi,gU=new zi,vU=new zi,yU=new Zi,xU=new xc;class SU extends Sz{constructor(){super(),this.uploadAnimation=null,this._buffers=[],this._dataArray=[],this._joints=[],this._bufferIndices=null,this.type=xg.SKINNING}_init(){this._nativeObj=new Gn}destroy(){if(this.bindSkeleton(),this._buffers.length){for(let e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}super.destroy()}bindSkeleton(e=null,t=null,i=null){for(let e=0;e<this._joints.length;e++)oN(this._joints[e].target);if(this._bufferIndices=null,this._joints.length=0,!e||!t||!i)return;this.transform=t;const n=i.getBoneSpaceBounds(e),s=i.struct.jointMaps;this._ensureEnoughBuffers(s&&s.length||1),this._bufferIndices=i.jointBufferIndices;const o=[];for(let i=0;i<e.joints.length;i++){const r=n[i],a=t.getChildByPath(e.joints[i]);if(!r||!a)continue;const c=sN(a,t),l=e.bindposes[i],h=[],u=[];s?dU(h,u,s,i):(h.push(i),u.push(0)),this._joints.push({indices:h,buffers:u,bound:r,target:a,bindpose:l,transform:c});{let e=c.parent;const t=[];for(;e;)t.push({node:e.node.native,local:e.local,world:e.local,stamp:e.stamp}),e=e.parent;o.push({indices:h,buffers:u,bound:r.native,target:a.native,bindpose:l,transform:{node:c.node.native,local:c.local,world:c.world,stamp:c.stamp},parents:t})}}this._nativeObj.setIndicesAndJoints(this._bufferIndices,o)}updateTransform(e){const t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0),zi.set(fU,1/0,1/0,1/0),zi.set(mU,-1/0,-1/0,-1/0);for(let t=0;t<this._joints.length;t++){const{bound:i,transform:n}=this._joints[t],s=nN(n,e);xc.transform(xU,i,s),xU.getBoundary(gU,vU),zi.min(fU,fU,gU),zi.max(mU,mU,vU)}const i=this._worldBounds;this._modelBounds&&i&&(xc.fromPoints(this._modelBounds,fU,mU),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())}updateUBOs(e){super.updateUBOs(e);for(let e=0;e<this._joints.length;e++){const{indices:t,buffers:i,transform:n,bindpose:s}=this._joints[e];Zi.multiply(yU,n.world,s);for(let e=0;e<i.length;e++)eU(this._dataArray[i[e]],12*t[e],yU)}for(let e=0;e<this._buffers.length;e++)this._buffers[e].update(this._dataArray[e]);return!0}initSubModel(e,t,i){const n=t.vertexBuffers,s=t.iaInfo;s.vertexBuffers=t.jointMappedBuffers,super.initSubModel(e,t,i),s.vertexBuffers=n}getMacroPatches(e){const t=super.getMacroPatches(e);return t?pU.concat(t):pU}_updateLocalDescriptors(e,t){super._updateLocalDescriptors(e,t),this._nativeObj.updateLocalDescriptors(e,t)}_ensureEnoughBuffers(e){for(let t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new Io(Fs.UNIFORM|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,Xd.SIZE,Xd.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(Xd.COUNT));this._nativeObj.setBuffers(this._buffers)}}const bU=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}];class TU extends Sz{constructor(){super(),this.uploadedAnim=void 0,this._jointsMedium=void 0,this._skeleton=null,this._mesh=null,this._dataPoolManager=void 0,this._instAnimInfoIdx=-1,this.type=xg.BAKED_SKINNING,this._dataPoolManager=n.director.root.dataPoolManager;const e=new Float32Array(4),t=this._dataPoolManager.jointAnimationInfo.getData();this._jointsMedium={buffer:null,jointTextureInfo:e,animInfo:t,texture:null,boundsInfo:null}}_init(){this._nativeObj=new kn}destroy(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),super.destroy()}bindSkeleton(e=null,t=null,i=null){if(this._skeleton=e,this._mesh=i,!e||!t||!i)return;this.transform=t;const n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new Io(Fs.UNIFORM|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,Wd.SIZE,Wd.SIZE)))}updateTransform(e){if(super.updateTransform(e),!this.uploadedAnim)return;const{animInfo:t,boundsInfo:i}=this._jointsMedium,n=i[t.data[0]],s=this._worldBounds;if(s&&n){const e=this.transform;n.transform(e._mat,e._pos,e._rot,e._scale,s)}}updateUBOs(e){super.updateUBOs(e);const t=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=t.data[0]:t.dirty&&(t.buffer.update(t.data),t.dirty=!1),!0}_applyNativeJointMedium(){{const e=[];this._jointsMedium.boundsInfo&&this._jointsMedium.boundsInfo.forEach((t=>{e.push(t.native)}));const t="nativeDirty";this._nativeObj.setJointMedium(!!this.uploadedAnim,{boundsInfo:e,jointTextureInfo:this._jointsMedium.jointTextureInfo.buffer,animInfo:{buffer:this._jointsMedium.animInfo.buffer,data:this._jointsMedium.animInfo.data.buffer,dirty:this._jointsMedium.animInfo[t].buffer},buffer:this._jointsMedium.buffer})}}_updateModelBounds(e){this._modelBounds=e,this._nativeObj.updateModelBounds(e?e.native:null)}uploadAnimation(e){if(!this._skeleton||!this._mesh||this.uploadedAnim===e)return;this.uploadedAnim=e;const t=this._dataPoolManager;let i=null;e?(i=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(i=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(i&&i.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(i),this._applyNativeJointMedium()}_applyJointTexture(e=null){const t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,!e)return;const{buffer:i,jointTextureInfo:n}=this._jointsMedium;n[0]=e.handle.texture.width,n[1]=this._skeleton.joints.length,n[2]=e.pixelOffset+.1,n[3]=1/n[0],this.updateInstancedJointTextureInfo(),i&&i.update(n);const s=e.handle.texture;for(let e=0;e<this._subModels.length;++e)this._subModels[e].descriptorSet.bindTexture(Kd,s)}getMacroPatches(e){const t=super.getMacroPatches(e);return t?t.concat(bU):bU}_updateLocalDescriptors(e,t){super._updateLocalDescriptors(e,t);const{buffer:i,texture:n,animInfo:s}=this._jointsMedium;if(t.bindBuffer(Wd.BINDING,i),t.bindBuffer(qd.BINDING,s.buffer),n){const e=Qf.getSampler(this._device,iU);t.bindTexture(Kd,n.handle.texture),t.bindSampler(Kd,e)}}_setInstAnimInfoIdx(e){this._instAnimInfoIdx=e,this._nativeObj.setAnimInfoIdx(e)}_updateInstancedAttributes(e,t){super._updateInstancedAttributes(e,t),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex("a_jointAnimInfo")),this.updateInstancedJointTextureInfo()}updateInstancedJointTextureInfo(){const{jointTextureInfo:e,animInfo:t}=this._jointsMedium,i=this._instAnimInfoIdx;if(i>=0){const n=this.instancedAttributes.views[i];n[0]=t.data[0],n[1]=e[1],n[2]=e[2]}}}var EU,CU,wU,AU,PU,RU,IU,MU,OU,DU,NU,LU,BU;let zU=function(t){return e({SkinnedMeshRenderer:t,SkinningModelComponent:t}),t}((EU=Wc("cc.SkinnedMeshRenderer"),CU=al(),wU=Xc(100),AU=nl(),PU=Al(Lz),RU=Al(ix),IU=Al(Lz),MU=Al(ix),OU=_l(),EU(DU=CU(DU=wU(DU=il(DU=AU((LU=Oc((NU=class extends Cz{get skeleton(){return this._skeleton}set skeleton(e){e!==this._skeleton&&(this._skeleton=e,this._update())}get skinningRoot(){return this._skinningRoot}set skinningRoot(e){e!==this._skinningRoot&&(this._skinningRoot=e,this._updateModelType(),this._update())}get model(){return this._model}constructor(){super(),Mc(this,"_skeleton",LU,this),Mc(this,"_skinningRoot",BU,this),this._clip=null,this._modelType=TU}__preload(){this._updateModelType()}uploadAnimation(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)}setUseBakedAnimation(e=!0,t=!1){const i=e?TU:SU;(t||this._modelType!==i)&&(this._modelType=i,this._model&&(n.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))}setMaterial(e,t){super.setMaterial(e,t),this._modelType===SU&&this.getMaterialInstance(t)}_updateModelParams(){this._update(),super._updateModelParams()}_updateModelType(){if(!this._skinningRoot)return;const e=this._skinningRoot.getComponent("cc.SkeletalAnimation");e?this.setUseBakedAnimation(e.useBakedAnimation):this.setUseBakedAnimation(!1)}_update(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))}}).prototype,"_skeleton",[PU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BU=Oc(NU.prototype,"_skinningRoot",[RU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(NU.prototype,"skeleton",[IU],Object.getOwnPropertyDescriptor(NU.prototype,"skeleton"),NU.prototype),Oc(NU.prototype,"skinningRoot",[MU,OU],Object.getOwnPropertyDescriptor(NU.prototype,"skinningRoot"),NU.prototype),DU=NU))||DU)||DU)||DU)||DU)||DU));var FU,UU,GU,kU,HU,VU,jU,WU,qU,XU,YU,KU,$U,QU,ZU,JU,eG,tG,iG,nG,sG,oG,rG,aG,cG,lG,hG,uG,_G;const pG=new Xo(mo.ATTR_BATCH_ID,Ls.R32F),dG=new Xo(mo.ATTR_BATCH_UV,Ls.RG32F),fG=vr[pG.format].size+vr[dG.format].size;let mG=function(t){return e({SkinnedMeshUnit:t,SkinningModelUnit:t}),t}((FU=Wc("cc.SkinnedMeshUnit"),UU=Al(LB),GU=Al(Lz),kU=Al(Wg),HU=Al(zU),FU((WU=Oc((jU=class{constructor(){Mc(this,"mesh",WU,this),Mc(this,"skeleton",qU,this),Mc(this,"material",XU,this),Mc(this,"_localTransform",YU,this),Mc(this,"_offset",KU,this),Mc(this,"_size",$U,this)}set offset(e){nn.copy(this._offset,e)}get offset(){return this._offset}set size(e){nn.copy(this._size,e)}get size(){return this._size}set copyFrom(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&uN(e.node,e.skinningRoot,this._localTransform))}get copyFrom(){return null}}).prototype,"mesh",[UU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qU=Oc(jU.prototype,"skeleton",[GU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XU=Oc(jU.prototype,"material",[kU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YU=Oc(jU.prototype,"_localTransform",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zi}}),KU=Oc(jU.prototype,"_offset",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(0,0)}}),$U=Oc(jU.prototype,"_size",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(1,1)}}),Oc(jU.prototype,"offset",[cl],Object.getOwnPropertyDescriptor(jU.prototype,"offset"),jU.prototype),Oc(jU.prototype,"size",[cl],Object.getOwnPropertyDescriptor(jU.prototype,"size"),jU.prototype),Oc(jU.prototype,"copyFrom",[HU],Object.getOwnPropertyDescriptor(jU.prototype,"copyFrom"),jU.prototype),VU=jU))||VU));const gG=new Zi,vG=(new Zi,new zi);let yG=function(t){return e({SkinnedMeshBatchRenderer:t,BatchedSkinningModelComponent:t}),t}((QU=Wc("cc.SkinnedMeshBatchRenderer"),ZU=al(),JU=Xc(100),eG=nl(),tG=_l(),iG=Al([lt]),nG=_l(),sG=Al([mG]),oG=_l(),rG=ll(),aG=ll(),QU(cG=ZU(cG=JU(cG=il(cG=eG((hG=Oc((lG=class extends zU{constructor(...e){super(...e),Mc(this,"atlasSize",hG,this),Mc(this,"batchableTextureNames",uG,this),Mc(this,"units",_G,this),this._textures={},this._batchMaterial=null}get mesh(){return super.mesh}set mesh(e){super.mesh=e}get skeleton(){return super.skeleton}set skeleton(e){super.skeleton=e}onLoad(){super.onLoad(),this.cook()}onDestroy(){for(const e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),super.onDestroy()}_onMaterialModified(e,t){this.cookMaterials(),super._onMaterialModified(e,this.getMaterialInstance(e))}cook(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}cookMaterials(){this._batchMaterial||(this._batchMaterial=this.getMaterial(0));const e=this.getMaterialInstance(0);if(!e||!this._batchMaterial||!this._batchMaterial.effectAsset)return void console.warn("incomplete batch material!");e.copy(this._batchMaterial),this.resizeAtlases();const t=e.effectAsset.techniques[e.technique];for(let i=0;i<t.passes.length;i++){const n=t.passes[i];if(n.properties)for(const t in n.properties)if(n.properties[t].type>=zs.SAMPLER1D){let n=null;this.batchableTextureNames.find((e=>e===t))?(n=this._textures[t],n||(n=this.createTexture(t)),this.cookTextures(n,t,i)):this.units.some((e=>n=e.material&&e.material.getProperty(t,i))),n&&e.setProperty(t,n,i)}else{const n=[];for(let e=0;e<this.units.length;e++){const s=this.units[e];s.material&&n.push(s.material.getProperty(t.slice(0,-3),i))}e.setProperty(t,n,i)}}}cookSkeletons(){if(!this._skinningRoot)return void console.warn("no skinning root specified!");const e=[],t=[];for(let i=0;i<this.units.length;i++){const n=this.units[i];if(!n||!n.skeleton)continue;const s=n.skeleton;Zi.invert(gG,n._localTransform);for(let i=0;i<s.joints.length;i++){const n=s.joints[i];e.findIndex((e=>e===n))>=0||(e.push(n),t.push(Zi.multiply(new Zi,s.bindposes[i]||Zi.IDENTITY,gG)))}}const i=Array.from(Array(e.length).keys()).sort(((t,i)=>e[t]>e[i]?1:e[t]<e[i]?-1:0)),n=new Lz;n.joints=e.map(((e,t,n)=>n[i[t]])),n.bindposes=t.map(((e,t,n)=>n[i[t]])),this._skeleton&&this._skeleton.destroy(),this.skeleton=n}cookMeshes(){let e=!1;for(let t=0;t<this.units.length;t++)if(this.units[t].mesh){e=!0;break}if(!e||!this._skinningRoot)return;this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new LB;let t=0,i=Ls.UNKNOWN,n=0,s=Ls.UNKNOWN,o=0,r=Ls.UNKNOWN,a=0,c=Ls.UNKNOWN,l=0,h=Ls.UNKNOWN;const u=new Array(this.units.length),_=this.units.length;for(let e=0;e<_;e++){const t=this.units[e];t&&t.skeleton&&(u[e]=t.skeleton.joints.map((e=>this._skeleton.joints.findIndex((t=>e===t)))))}for(let e=0;e<_;e++){const _=this.units[e];if(!_||!_.mesh||!_.mesh.data)continue;const p=this._createUnitMesh(e,_.mesh),d=new DataView(p.data.buffer);Zi.inverseTranspose(gG,_._localTransform);const{offset:f}=_,{size:m}=_;for(let g=0;g<p.struct.vertexBundles.length;g++){const v=p.struct.vertexBundles[g];t=v.view.offset,i=Ls.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const n=v.attributes[e];if(n.name===mo.ATTR_POSITION){i=n.format;break}t+=vr[n.format].size}if(i){const e=rb(d,i,t,v.view.length,v.view.stride);for(let t=0;t<e.length;t+=3)zi.fromArray(vG,e,t),zi.transformMat4(vG,vG,_._localTransform),zi.toArray(e,vG,t);ob(d,e,i,t,v.view.stride)}n=v.view.offset,s=Ls.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const t=v.attributes[e];if(t.name===mo.ATTR_NORMAL){s=t.format;break}n+=vr[t.format].size}if(s){const e=rb(d,s,n,v.view.length,v.view.stride);for(let t=0;t<e.length;t+=3)zi.fromArray(vG,e,t),zi.transformMat4Normal(vG,vG,gG),zi.toArray(e,vG,t);ob(d,e,s,n,v.view.stride)}o=v.view.offset,r=Ls.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const t=v.attributes[e];if(t.name===mo.ATTR_TANGENT){r=t.format;break}o+=vr[t.format].size}if(r){const e=rb(d,r,o,v.view.length,v.view.stride);for(let t=0;t<e.length;t+=3)zi.fromArray(vG,e,t),zi.transformMat4Normal(vG,vG,gG),zi.toArray(e,vG,t);ob(d,e,r,o,v.view.stride)}a=v.view.offset,c=Ls.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const t=v.attributes[e];if(t.name===mo.ATTR_BATCH_UV){c=t.format;break}a+=vr[t.format].size}c&&ab(d,((e,t)=>{var i;const n=0===t?"x":"y";return(e=(i=e)-Math.floor(i))*m[n]+f[n]}),c,a,v.view.length,v.view.stride,d);const y=u[e];if(y){l=v.view.offset,h=Ls.UNKNOWN;for(let e=0;e<v.attributes.length;e++){const t=v.attributes[e];if(t.name===mo.ATTR_JOINTS){h=t.format;break}l+=vr[t.format].size}h&&ab(d,(e=>y[e]),h,l,v.view.length,v.view.stride,d)}}this._mesh.merge(p)}this._onMeshChanged(this._mesh),this._updateModels()}cookTextures(e,t,i){const s=[],o=[],r=[],a=[];for(let e=0;e<this.units.length;e++){const n=this.units[e];if(!n.material)continue;const c=n.material.getProperty(t,i);if(c&&c.image&&c.image.data){const e=new wo;e.texOffset.x=n.offset.x*this.atlasSize,e.texOffset.y=n.offset.y*this.atlasSize,e.texExtent.width=n.size.x*this.atlasSize,e.texExtent.height=n.size.y*this.atlasSize;const{data:t}=c.image;ArrayBuffer.isView(t)?(r.push(t),a.push(e)):(s.push(t),o.push(e))}}const c=e.getGFXTexture(),{device:l}=n.director.root;r.length>0&&l.copyBuffersToTexture(r,c,a),s.length>0&&l.copyTexImagesToTexture(s,c,o)}createTexture(e){const t=new wm;return t.setFilters(zf.LINEAR,zf.LINEAR),t.setMipFilter(zf.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:Lf.RGBA8888}),this._textures[e]=t,t}resizeAtlases(){for(const e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:Lf.RGBA8888})}_createUnitMesh(e,t){const i=JSON.parse(JSON.stringify(t.struct)),s={};for(let e=0;e<t.struct.primitives.length;e++){const n=t.struct.primitives[e];let o=0,r=Ls.UNKNOWN,a=0;for(;a<n.vertexBundelIndices.length;a++){const e=t.struct.vertexBundles[n.vertexBundelIndices[a]];o=e.view.offset,r=Ls.UNKNOWN;for(let t=0;t<e.attributes.length;t++){const i=e.attributes[t];if(i.name===mo.ATTR_TEX_COORD){r=i.format;break}o+=vr[i.format].size}if(r)break}if(void 0!==s[a])continue;s[a]=[r,o];const c=i.vertexBundles[a];c.attributes.push(pG),c.attributes.push(dG),c.view.offset=0,c.view.length+=c.view.count*fG,c.view.stride+=fG}let o=0;for(let e=0;e<i.vertexBundles.length;e++)o+=i.vertexBundles[e].view.length;for(let e=0;e<i.primitives.length;e++){const t=i.primitives[e];t.indexView&&(t.indexView.offset=o,o+=t.indexView.length)}const r=new Uint8Array(o),a=t.data,c=new DataView(r.buffer),l=new DataView(a.buffer),{isLittleEndian:h}=n.sys;for(const n in s){const o=i.vertexBundles[n],u=t.struct.vertexBundles[n],[_,p]=s[n],d=rb(l,_,p,u.view.length,u.view.stride),f=u.view,m=o.view,g=f.stride,v=m.stride;let y=f.offset,x=m.offset;for(let t=0;t<m.count;t++){const i=a.subarray(y,y+g);r.set(i,x),c.setFloat32(x+g,e),c.setFloat32(x+g+4,d[2*t],h),c.setFloat32(x+g+8,d[2*t+1],h),x+=v,y+=g}}for(let e=0;e<i.primitives.length;e++){const n=t.struct.primitives[e],s=i.primitives[e];if(n.indexView&&s.indexView){const e=n.indexView.stride,t=s.indexView.stride;let i=n.indexView.offset,o=s.indexView.offset;for(let n=0;n<s.indexView.count;n++){const n=a.subarray(i,i+e);r.set(n,o),o+=t,i+=e}}}const u=new LB;return u.reset({struct:i,data:r}),u}}).prototype,"atlasSize",[Qc,tG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),uG=Oc(lG.prototype,"batchableTextureNames",[iG,Qc,nG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_G=Oc(lG.prototype,"units",[sG,Qc,oG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oc(lG.prototype,"mesh",[Pl,rG],Object.getOwnPropertyDescriptor(lG.prototype,"mesh"),lG.prototype),Oc(lG.prototype,"skeleton",[Pl,aG],Object.getOwnPropertyDescriptor(lG.prototype,"skeleton"),lG.prototype),cG=lG))||cG)||cG)||cG)||cG)||cG));n.SkinningModelComponent=zU,De.setClassAlias(zU,"cc.SkinningModelComponent"),n.SkinningModelUnit=mG,De.setClassAlias(mG,"cc.SkinningModelUnit"),n.BatchedSkinningModelComponent=yG,De.setClassAlias(yG,"cc.BatchedSkinningModelComponent");const xG=new Zi,SG=new Zi;class bG extends PD{constructor(e,t=""){super(e,t),this._frames=1,this._bakedDuration=0,this._animInfo=null,this._sockets=[],this._animInfoMgr=void 0,this._comps=[],this._parent=null,this._curvesInited=!1,this._animInfoMgr=n.director.root.dataPoolManager.jointAnimationInfo}initialize(e){if(this._curveLoaded)return;this._comps.length=0;const t=e.getComponentsInChildren(zU);for(let i=0;i<t.length;++i){const n=t[i];n.skinningRoot===e&&this._comps.push(n)}this._parent=e.getComponent("cc.SkeletalAnimation");const i=this._parent.useBakedAnimation;this._doNotCreateEval=i,super.initialize(e),this._curvesInited=!i;const{frames:n,samples:s}=HM.getOrExtract(this.clip);this._frames=n-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/s}onPlay(){if(super.onPlay(),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip);for(let e=0;e<this._comps.length;++e)this._comps[e].uploadAnimation(this.clip)}else this._sampleCurves=super._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,super.initialize(this._targetNode),this._curvesInited=!0)}rebuildSocketCurves(e){if(this._sockets.length=0,!this._targetNode)return;const t=this._targetNode;for(let i=0;i<e.length;++i){const n=e[i],s=t.getChildByPath(n.path);if(!n.target)continue;const o=HM.getOrExtract(this.clip);let r,a=n.path,c=o.joints[a],l=s;for(;!c;){const e=a.lastIndexOf("/");if(a=a.substring(0,e),c=o.joints[a],l&&(r||(r=Zi.identity(SG)),Zi.fromRTS(xG,l.rotation,l.position,l.scale),Zi.multiply(r,xG,r),l=l.parent),e<0)break}const h=c&&c.transforms,{frames:u}=o,_=[];for(let e=0;e<u;e++){let t;t=h&&r?Zi.multiply(xG,h[e],r):h?h[e]:r||new Zi;const i={pos:new zi,rot:new ji,scale:new zi};Zi.toRTS(t,i.rot,i.pos,i.scale),_.push(i)}this._sockets.push({target:n.target,frames:_})}}_setAnimInfoDirty(e,t){e.dirty=t,e.nativeDirty.fill(t?1:0)}_sampleCurvesBaked(e){const t=e/this.duration,i=this._animInfo,n=t*this._frames+.5|0;if(n!==i.data[0]){i.data[0]=n,this._setAnimInfoDirty(i,!0);for(let e=0;e<this._sockets.length;++e){const{target:t,frames:i}=this._sockets[e],{pos:s,rot:o,scale:r}=i[n];t.setRTS(o,s,r)}}}}var TG,EG,CG,wG,AG,PG,RG,IG,MG,OG,DG,NG,LG,BG,zG,FG,UG,GG,kG,HG;e("SkeletalAnimationState",bG);let VG=e("Socket",(TG=Wc("cc.SkeletalAnimation.Socket"),EG=Al(ix),TG((AG=Oc((wG=class{constructor(e="",t=null){Mc(this,"path",AG,this),Mc(this,"target",PG,this),this.path=e,this.target=t}}).prototype,"path",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),PG=Oc(wG.prototype,"target",[EG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CG=wG))||CG));De.setClassAlias(VG,"cc.SkeletalAnimationComponent.Socket");const jG=new Zi,WG=new Zi;function qG(e,t="",i=[]){for(let n=0;n<e.children.length;n++){const s=e.children[n];if(!s)continue;const o=t?`${t}/${s.name}`:s.name;i.push(o),qG(s,o,i)}return i}let XG=function(t){return e({SkeletalAnimation:t,SkeletalAnimationComponent:t}),t}((RG=Wc("cc.SkeletalAnimation"),IG=al(),MG=Xc(99),OG=nl(),DG=Al([VG]),NG=_l(),LG=_l(),BG=Al([VG]),RG(zG=IG(zG=MG(zG=il(zG=OG((HG=kG=class extends XD{constructor(...e){super(...e),Mc(this,"_useBakedAnimation",UG,this),Mc(this,"_sockets",GG,this)}get sockets(){return this._sockets}set sockets(e){if(!this._useBakedAnimation){const t=n.director.getAnimationManager();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}get useBakedAnimation(){return this._useBakedAnimation}set useBakedAnimation(e){this._useBakedAnimation=e;const t=this.node.getComponentsInChildren(zU);for(let e=0;e<t.length;++e){const i=t[e];i.skinningRoot===this.node&&i.setUseBakedAnimation(this._useBakedAnimation,!0)}this._useBakedAnimation?n.director.getAnimationManager().removeSockets(this.node,this._sockets):n.director.getAnimationManager().addSockets(this.node,this._sockets)}onDestroy(){super.onDestroy(),n.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),n.director.getAnimationManager().removeSockets(this.node,this._sockets)}start(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,super.start()}querySockets(){const e=this._defaultClip&&Object.keys(HM.getOrExtract(this._defaultClip).joints).sort().reduce(((e,t)=>(t.startsWith(e[e.length-1])||e.push(t),e)),[])||[];if(!e.length)return["please specify a valid default animation clip first"];const t=[];for(let i=0;i<e.length;i++){const n=e[i],s=this.node.getChildByPath(n);s&&(t.push(n),qG(s,n,t))}return t}rebuildSocketAnimations(){for(const e of this._sockets){const t=this.node.getChildByPath(e.path),{target:i}=e;t&&i&&(i.name=`${e.path.substring(e.path.lastIndexOf("/")+1)} Socket`,i.parent=this.node,uN(t,this.node,jG),Zi.fromRTS(WG,i.rotation,i.position,i.scale),Zi.equals(WG,jG)||(i.matrix=jG))}for(const e of Object.keys(this._nameToState))this._nameToState[e].rebuildSocketCurves(this._sockets)}createSocket(e){const t=this._sockets.find((t=>t.path===e));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;const i=new ix;return i.parent=this.node,this._sockets.push(new VG(e,i)),this.rebuildSocketAnimations(),i}_createState(e,t){return new bG(e,t)}_doCreateState(e,t){const i=super._doCreateState(e,t);return i.rebuildSocketCurves(this._sockets),i}},kG.Socket=VG,Oc((FG=HG).prototype,"sockets",[DG,NG],Object.getOwnPropertyDescriptor(FG.prototype,"sockets"),FG.prototype),Oc(FG.prototype,"useBakedAnimation",[LG],Object.getOwnPropertyDescriptor(FG.prototype,"useBakedAnimation"),FG.prototype),UG=Oc(FG.prototype,"_useBakedAnimation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GG=Oc(FG.prototype,"_sockets",[BG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zG=FG))||zG)||zG)||zG)||zG)||zG));n.SkeletalAnimationComponent=XG,De.setClassAlias(XG,"cc.SkeletalAnimationComponent"),n.utils=xz;const YG=new zi,KG=new Zi;function $G(e,t,i,n){const s=i.data;let o=t.acquireBufferBatch(),r=o.byteOffset>>2;const a=i.vertexCount;let c=o.indicesOffset,l=o.vertexOffset;o.request(a,i.indicesCount)||(o=t.currBufferBatch,r=0,c=0,l=0);const h=o.vData,u=o.iData;e.getWorldMatrix(KG);for(let e=0;e<a;e++){const t=s[e];zi.set(YG,t.x,t.y,0),zi.transformMat4(YG,YG,KG),h[r++]=YG.x,h[r++]=YG.y,h[r++]=YG.z,h[r++]=t.u,h[r++]=t.v,Di.toArray(h,n,r),r+=4}for(let e=0,t=a/4;e<t;e++){const t=l+4*e;u[c++]=t,u[c++]=t+1,u[c++]=t+2,u[c++]=t+1,u[c++]=t+3,u[c++]=t+2}}class QG{constructor(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;const i=new ZG;i.initWithSize(e,t),this._texture=i,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}insertSpriteFrame(e){const t=e.rect,i=e.texture,s=this._innerTextureInfos[i.getId()];let o=t.x,r=t.y;if(s)o+=s.x,r+=s.y;else{const e=i.width,t=i.height;if(this._x+e+2>this._width&&(this._x=2,this._y=this._nexty),this._y+t+2>this._nexty&&(this._nexty=this._y+t+2),this._nexty>this._height)return null;n.internal.dynamicAtlasManager.textureBleeding&&((e<=8||t<=8)&&(this._texture.drawTextureAt(i.image,this._x-1,this._y-1),this._texture.drawTextureAt(i.image,this._x-1,this._y+1),this._texture.drawTextureAt(i.image,this._x+1,this._y-1),this._texture.drawTextureAt(i.image,this._x+1,this._y+1)),this._texture.drawTextureAt(i.image,this._x-1,this._y),this._texture.drawTextureAt(i.image,this._x+1,this._y),this._texture.drawTextureAt(i.image,this._x,this._y-1),this._texture.drawTextureAt(i.image,this._x,this._y+1)),this._texture.drawTextureAt(i.image,this._x,this._y),this._innerTextureInfos[i.getId()]={x:this._x,y:this._y,texture:i},this._count++,o+=this._x,r+=this._y,this._x+=e+2}const a={x:o,y:r,texture:this._texture};return this._innerSpriteFrames.push(e),a}deleteInnerTexture(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)}isEmpty(){return this._count<=0}reset(){this._x=2,this._y=2,this._nexty=2;const e=this._innerSpriteFrames;for(let t=0,i=e.length;t<i;t++){const i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}destroy(){this.reset(),this._texture.destroy()}}class ZG extends wm{initWithSize(e,t,i=Lf.RGBA8888){this.reset({width:e,height:t,format:i})}drawTextureAt(e,t,i){const n=this.getGFXTexture();if(!e||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const o=new wo;o.texOffset.x=t,o.texOffset.y=i,o.texExtent.width=e.width,o.texExtent.height=e.height,s.copyTexImagesToTexture([e.data],n,[o])}}class JG{constructor(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(e?(this.reset(),n.director.on(n.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),n.director.off(n.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}get maxAtlasCount(){return this._maxAtlasCount}set maxAtlasCount(e){this._maxAtlasCount=e}get atlasCount(){return this._atlases.length}get textureBleeding(){return this._textureBleeding}set textureBleeding(e){this._textureBleeding=e}get textureSize(){return this._textureSize}set textureSize(e){this._textureSize=e}get maxFrameSize(){return this._maxFrameSize}set maxFrameSize(e){this._maxFrameSize=e}newAtlas(){let e=this._atlases[++this._atlasIndex];return e||(e=new QG(this._textureSize,this._textureSize),this._atlases.push(e)),e}beforeSceneLoad(){this.reset()}insertSpriteFrame(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;let t=this._atlases[this._atlasIndex];t||(t=this.newAtlas());const i=t.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(t=this.newAtlas(),t.insertSpriteFrame(e))}reset(){for(let e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1}deleteAtlasSpriteFrame(e){if(!e._original)return;const t=e._original._texture;this.deleteAtlasTexture(t)}deleteAtlasTexture(e){if(e)for(let t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)}packToDynamicAtlas(e,t){if(!t._original&&t.packable){const e=this.insertSpriteFrame(t);e&&t._setDynamicAtlasFrame(e)}}}JG.instance=void 0;const ek=e("dynamicAtlasManager",JG.instance=new JG);var tk;n.internal.dynamicAtlasManager=ek;const ik=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}];let nk=e("SpriteFrame",Wc("cc.SpriteFrame")(tk=class e extends xh{static createWithImage(t){const i=t instanceof Wf?t:new Wf(t),n=new wm;n.image=i;const s=new e;return s.texture=n,s}get insetTop(){return this._capInsets[1]}set insetTop(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}get insetBottom(){return this._capInsets[3]}set insetBottom(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}get insetLeft(){return this._capInsets[0]}set insetLeft(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}get insetRight(){return this._capInsets[2]}set insetRight(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}get rect(){return this._rect}set rect(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}get originalSize(){return this._originalSize}set originalSize(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}get offset(){return this._offset}set offset(e){this._offset.set(e)}get rotated(){return this._rotated}set rotated(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}get texture(){return this._texture}set texture(e){e?this.reset({texture:e},!0):console.warn(`Error Texture in ${this.name}`)}get atlasUuid(){return this._atlasUuid}set atlasUuid(e){this._atlasUuid=e}get width(){return this._texture.width}get height(){return this._texture.height}set _textureSource(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}get flipUVX(){return this._isFlipUVX}set flipUVX(e){this._isFlipUVX=e,this._calculateUV()}get flipUVY(){return this._isFlipUVY}set flipUVY(e){this._isFlipUVY=e,this._calculateUV()}get packable(){return this._packable}set packable(e){this._packable=e}get original(){return this._original}constructor(){super(),this.vertices=null,this.uv=[],this.uvHash=0,this.unbiasUV=[],this.uvSliced=[],this._rect=new _n,this._offset=new nn,this._originalSize=new hn,this._rotated=!1,this._capInsets=[0,0,0,0],this._atlasUuid="",this._texture=void 0,this._isFlipUVY=!1,this._isFlipUVX=!1,this._original=null,this._packable=!0}textureLoaded(){return!!this.texture}isRotated(){return this._rotated}setRotated(e){this.rotated=e}getRect(e){return e?(e.set(this._rect),e):this._rect.clone()}setRect(e){this.rect=e}getOriginalSize(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}setOriginalSize(e){this.originalSize=e}getOffset(e){return e?(e.set(this._offset),e):this._offset.clone()}setOffset(e){this.offset=e}getGFXTexture(){return this._texture.getGFXTexture()}getGFXSampler(){return this._texture.getGFXSampler()}getHash(){return this._texture.getHash()}getSamplerHash(){return this._texture.getSamplerHash()}reset(e,t=!1){let i=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()}checkRect(e){const t=this._rect;let i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(C(3300,`${this.name}/${e.name}`,i,e.width),!1):!(n>e.height&&(C(3301,`${this.name}/${e.name}`,n,e.height),1))}destroy(){return this._packable&&ek&&ek.deleteAtlasSpriteFrame(this),super.destroy()}_calculateSlicedUV(){const e=this._rect,t=this.texture,i=t.width,n=t.height,s=this._capInsets[0],o=this._capInsets[2],r=e.width-s-o,a=this._capInsets[1],c=this._capInsets[3],l=e.height-a-c,h=this.uvSliced;if(h.length=0,this._rotated){ik[0].u=e.x/i,ik[1].u=(e.x+c)/i,ik[2].u=(e.x+c+l)/i,ik[3].u=(e.x+e.height)/i,ik[3].v=e.y/n,ik[2].v=(e.y+s)/n,ik[1].v=(e.y+s+r)/n,ik[0].v=(e.y+e.width)/n;for(let e=0;e<4;++e){const t=ik[e];for(let e=0;e<4;++e){const i=ik[3-e];h.push({u:t.u,v:i.v})}}}else{ik[0].u=e.x/i,ik[1].u=(e.x+s)/i,ik[2].u=(e.x+s+r)/i,ik[3].u=(e.x+e.width)/i,ik[3].v=e.y/n,ik[2].v=(e.y+a)/n,ik[1].v=(e.y+a+l)/n,ik[0].v=(e.y+e.height)/n;for(let e=0;e<4;++e){const t=ik[e];for(let e=0;e<4;++e){const i=ik[e];h.push({u:i.u,v:t.v})}}}}_calculateUV(){const e=this._rect,t=this.uv,i=this.unbiasUV,n=this.texture,s=n.width,o=n.height;if(this._rotated){const n=0===s?0:e.x/s,r=0===s?1:(e.x+e.height)/s,a=0===o?0:e.y/o,c=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=r,t[1]=c,t[2]=r,t[3]=a,t[4]=n,t[5]=c,t[6]=n,t[7]=a):this._isFlipUVX?(t[0]=r,t[1]=a,t[2]=r,t[3]=c,t[4]=n,t[5]=a,t[6]=n,t[7]=c):this._isFlipUVY?(t[0]=n,t[1]=c,t[2]=n,t[3]=a,t[4]=r,t[5]=c,t[6]=r,t[7]=a):(t[0]=n,t[1]=a,t[2]=n,t[3]=c,t[4]=r,t[5]=a,t[6]=r,t[7]=c);const l=0===s?0:e.x/s,h=0===s?1:(e.x+e.height)/s,u=0===o?0:e.y/o,_=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=_,i[2]=h,i[3]=u,i[4]=l,i[5]=_,i[6]=l,i[7]=u):this._isFlipUVX?(i[0]=h,i[1]=u,i[2]=h,i[3]=_,i[4]=l,i[5]=u,i[6]=l,i[7]=_):this._isFlipUVY?(i[0]=l,i[1]=_,i[2]=l,i[3]=u,i[4]=h,i[5]=_,i[6]=h,i[7]=u):(i[0]=l,i[1]=u,i[2]=l,i[3]=_,i[4]=h,i[5]=u,i[6]=h,i[7]=_)}else{const n=0===s?0:e.x/s,r=0===s?1:(e.x+e.width)/s,a=0===o?1:(e.y+e.height)/o,c=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=r,t[1]=c,t[2]=n,t[3]=c,t[4]=r,t[5]=a,t[6]=n,t[7]=a):this._isFlipUVX?(t[0]=r,t[1]=a,t[2]=n,t[3]=a,t[4]=r,t[5]=c,t[6]=n,t[7]=c):this._isFlipUVY?(t[0]=n,t[1]=c,t[2]=r,t[3]=c,t[4]=n,t[5]=a,t[6]=r,t[7]=a):(t[0]=n,t[1]=a,t[2]=r,t[3]=a,t[4]=n,t[5]=c,t[6]=r,t[7]=c);const l=0===s?0:e.x/s,h=0===s?1:(e.x+e.width)/s,u=0===o?1:(e.y+e.height)/o,_=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=_,i[2]=l,i[3]=_,i[4]=h,i[5]=u,i[6]=l,i[7]=u):this._isFlipUVX?(i[0]=h,i[1]=u,i[2]=l,i[3]=u,i[4]=h,i[5]=_,i[6]=l,i[7]=_):this._isFlipUVY?(i[0]=l,i[1]=_,i[2]=h,i[3]=_,i[4]=l,i[5]=u,i[6]=h,i[7]=u):(i[0]=l,i[1]=u,i[2]=h,i[3]=u,i[4]=l,i[5]=_,i[6]=h,i[7]=_)}let r="";for(let e=0;e<t.length;e++)r+=t[e];this.uvHash=Vr(r,666);const a=this.vertices;if(a){a.nu.length=0,a.nv.length=0;for(let e=0;e<a.u.length;e++)a.nu[e]=a.u[e]/s,a.nv[e]=a.v[e]/o}this._calculateSlicedUV()}_setDynamicAtlasFrame(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())}_resetDynamicAtlasFrame(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}_checkPackable(){const e=ek;if(!e)return;const t=this._texture;if(!(t instanceof wm)||t.isCompressed)return void(this._packable=!1);const i=this.width,n=this.height;!t.image||i>e.maxFrameSize||n>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}_serialize(e){return null}_deserialize(e,t){const i=e,n=i.rect;n&&(this._rect=new _n(n.x,n.y,n.width,n.height));const s=i.offset;i.offset&&(this._offset=new nn(s.x,s.y));const o=i.originalSize;i.originalSize&&(this._originalSize=new hn(o.width,o.height)),this._rotated=!!i.rotated,this._name=i.name,this._packable=!!i.packable;const r=i.capInsets;r&&(this._capInsets[0]=r[0],this._capInsets[1]=r[1],this._capInsets[2]=r[2],this._capInsets[3]=r[3]),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}clone(){var t,i,n,s;const o=new e,r=this.vertices;return o.vertices=r?{x:r.x,y:r.y,triangles:r.triangles,nu:null===(t=r.nu)||void 0===t?void 0:t.slice(0),u:null===(i=r.u)||void 0===i?void 0:i.slice(0),nv:null===(n=r.nv)||void 0===n?void 0:n.slice(0),v:null===(s=r.v)||void 0===s?void 0:s.slice(0)}:null,o.uv.splice(0,o.uv.length,...this.uv),o.uvHash=this.uvHash,o.unbiasUV.splice(0,o.unbiasUV.length,...this.unbiasUV),o.uvSliced.splice(0,o.uvSliced.length,...this.uvSliced),o._rect.set(this._rect),o._offset.set(this._offset),o._originalSize.set(this._originalSize),o._rotated=this._rotated,o._capInsets.splice(0,o._capInsets.length,...this._capInsets),o._atlasUuid=this._atlasUuid,o._texture=this._texture,o._isFlipUVX=this._isFlipUVX,o._isFlipUVY=this._isFlipUVY,o}_refreshTexture(e){this._texture=e;const t=this._texture,i={};let n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(i.rect=new _n(0,0,t.width,t.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(i.originalSize=new hn(t.width,t.height),n=!0),n&&(this.reset(i),this.onLoaded()),this._checkPackable()}initDefault(e){super.initDefault(e);const t=new wm;t.initDefault(),this._refreshTexture(t),this._calculateUV()}validate(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height}})||tk);var sk,ok,rk;n.SpriteFrame=nk;let ak=e("SpriteAtlas",Wc("cc.SpriteAtlas")((rk=Oc((ok=class extends xh{constructor(...e){super(...e),Mc(this,"spriteFrames",rk,this)}getTexture(){const e=Object.keys(this.spriteFrames);if(e.length>0){const t=this.spriteFrames[e[0]];return t&&t.texture}return null}getSpriteFrame(e){const t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}getSpriteFrames(){const e=[],t=this.spriteFrames;for(const i of Object.keys(t))e.push(t[i]);return e}_serialize(e){}_deserialize(e,t){const i=e;this._name=i.name;const n=i.spriteFrames;this.spriteFrames=se();for(let e=0;e<n.length;e+=2)t.result.push(this.spriteFrames,n[e],n[e+1],Ie(nk))}}).prototype,"spriteFrames",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return se()}}),sk=ok))||sk);var ck;n.SpriteAtlas=ak;let lk=e("Font",Wc("cc.Font")(ck=class extends xh{})||ck);var hk,uk,_k;n.Font=lk;let pk=e("TTFFont",Wc("cc.TTFFont")((_k=Oc((uk=class extends lk{constructor(...e){super(...e),Mc(this,"_fontFamily",_k,this)}get _nativeAsset(){return this._fontFamily}set _nativeAsset(e){this._fontFamily=e||"Arial"}get _nativeDep(){return{uuid:this._uuid,__nativeName__:this._native,ext:Cn(this._native),__isNative__:!0}}initDefault(e){this._fontFamily="Arial",super.initDefault(e)}}).prototype,"_fontFamily",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(uk.prototype,"_nativeAsset",[Pl,wl],Object.getOwnPropertyDescriptor(uk.prototype,"_nativeAsset"),uk.prototype),Oc(uk.prototype,"_nativeDep",[Pl],Object.getOwnPropertyDescriptor(uk.prototype,"_nativeDep"),uk.prototype),hk=uk))||hk);var dk,fk,mk,gk,vk,yk,xk,Sk;n.TTFFont=pk;class bk{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0}}class Tk{constructor(e){this.letterDefinitions={},this.texture=e}addLetterDefinitions(e,t){this.letterDefinitions[e]=t}cloneLetterDefinition(){const e={};for(const t of Object.keys(this.letterDefinitions)){const i=new bk;fe(i,this.letterDefinitions[t]),e[t]=i}return e}getTexture(){return this.texture}getLetter(e){return this.letterDefinitions[e]}getLetterDefinitionForChar(e,t){const i=e.charCodeAt(0);let n;return n=this.letterDefinitions.hasOwnProperty(i)?this.letterDefinitions[i]:null,n}clear(){this.letterDefinitions={}}}let Ek=e("BitmapFont",(dk=Wc("cc.BitmapFont"),fk=Al(nk),dk((vk=Oc((gk=class extends lk{constructor(...e){super(...e),Mc(this,"fntDataStr",vk,this),Mc(this,"spriteFrame",yk,this),Mc(this,"fontSize",xk,this),Mc(this,"fntConfig",Sk,this)}onLoaded(){const e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new Tk(e.texture));const t=this.fntConfig;if(!t)return void p("The fnt config is not exists!");const i=t.fontDefDictionary;for(const e in i){const t=new bk,n=i[e].rect;t.offsetX=i[e].xOffset,t.offsetY=i[e].yOffset,t.w=n.width,t.h=n.height,t.u=n.x,t.v=n.y,t.textureID=0,t.valid=!0,t.xAdvance=i[e].xAdvance,this.fontDefDictionary.addLetterDefinitions(e,t)}}}).prototype,"fntDataStr",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yk=Oc(gk.prototype,"spriteFrame",[fk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xk=Oc(gk.prototype,"fontSize",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Sk=Oc(gk.prototype,"fntConfig",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mk=gk))||mk));var Ck;n.BitmapFont=Ek;let wk=e("LabelAtlas",Wc("cc.LabelAtlas")(Ck=class extends Ek{})||Ck);n.LabelAtlas=wk;const Ak=e("BASELINE_RATIO",.26),Pk=e("MIDDLE_RATIO",(Ak+1)/2-Ak);const Rk=new Me(2);Rk.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};const Ik=new class{constructor(e){this.count=0,this.limit=0,this.datas={},this.limit=e}moveToHead(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e}put(e,t){const i=Rk.get();if(i.key=e,i.value=t,this.count>=this.limit){const e=this.tail;delete this.datas[e.key],this.count--,this.tail=e.prev,this.tail.next=null,e.prev=null,e.next=null,Rk.put(e)}this.moveToHead(i)}remove(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--}get(e){const t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null}clear(){this.count=0,this.datas={},this.head=null,this.tail=null}has(e){return!!this.datas[e]}delete(e){const t=this.datas[e];this.remove(t)}}(100),Mk=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,Ok=/^[!,.:;'}\]%\?>、‘“》？。，！]/,Dk=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,Nk=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,Lk=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function Bk(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function zk(e){const t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function Fk(e,t,i){const n=`${i||e.font}🎮${t}`,s=Ik.get(n);if(null!==s)return s;const o=e.measureText(t),r=o&&o.width||0;return Ik.put(n,r),r}function Uk(e,t,i){let n=t,s=i;const o=e[t];if(o>="\udc00"&&o<="\udfff"&&n--,void 0!==i)if(i-1!==t){const t=e[i-1];t>="\ud800"&&t<="\udbff"&&s--}else o>="\ud800"&&o<="\udbff"&&s++;return e.substring(n,s)}function Gk(e,t,i,n){const s=[];if(0===e.length||i<0)return s.push(""),s;let o=e;for(;t>i&&o.length>1;){let e=o.length*(i/t)|0,r=Uk(o,e),a=t-n(r),c=r,l=0,h=0;const u=10;for(;a>i&&h++<u;)e*=i/a,e|=0,r=Uk(o,e),a=t-n(r);for(h=0;a<=i&&h++<u;){if(r){const e=Mk.exec(r);l=e?e[0].length:1,c=r}e+=l,r=Uk(o,e),a=t-n(r)}e-=l,0===e?(e=1,c=Uk(o,1)):1===e&&o[0]>="\ud800"&&o[0]<="\udbff"&&(e=2,c=Uk(o,2));let _,p=Uk(o,0,e);Ok.test(c||r)&&(_=Dk.exec(p),e-=_?_[0].length:0,0===e&&(e=1),c=Uk(o,e),p=Uk(o,0,e)),Lk.test(c)&&(_=Nk.exec(p),_&&p!==_[0]&&(e-=_[0].length,c=Uk(o,e),p=Uk(o,0,e))),0===s.length?s.push(p):(p=p.trim(),p.length>0&&s.push(p)),o=c||r,t=n(o)}return 0===s.length?s.push(o):(o=o.trim(),o.length>0&&s.push(o)),s}let kk;class Hk{constructor(){this.pool=[]}static getInstance(){return kk||(kk=new Hk),kk}get(){let e=this.pool.pop();if(!e){const t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}put(e){this.pool.length>=Ge.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)}}e("CanvasPool",Hk);const Vk=Di.WHITE.clone();class jk{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}}const Wk=`rgba(255, 255, 255, ${(1/255).toFixed(3)})`;class qk{constructor(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}updateRenderData(){this._updateProperties(),this._updateTexture()}destroy(){this.image=null}_updateProperties(){if(this.data=Hk.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;const e=Fk(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+Ak)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*Ak/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Wf),this.image.reset(this.canvas)}_updateTexture(){if(!this.context||!this.canvas)return;const e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,i,n),e.fillStyle=Wk,e.fillRect(0,0,i,n),e.font=t.fontDesc;const s=t.fontSize,o=i/2,r=n/2+s*Pk+0*s,a=t.color;if(e.lineJoin="round",e.fillStyle=`rgba(${a.r}, ${a.g}, ${a.b}, 1)`,t.isOutlined){const i=t.out||Vk;e.strokeStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${i.a/255})`,e.lineWidth=2*t.margin,e.strokeText(this.char,o,r)}e.fillText(this.char,o,r)}}class Xk extends wm{initWithSize(e,t,i=Lf.RGBA8888){this.reset({width:e,height:t,format:i})}drawTextureAt(e,t,i){const n=this.getGFXTexture();if(!e||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const o=new wo;o.texOffset.x=t,o.texOffset.y=i,o.texExtent.width=e.width,o.texExtent.height=e.height,s.copyTexImagesToTexture([e.data],n,[o])}}class Yk{get width(){return this._width}get height(){return this._height}constructor(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;const i=new Xk;i.initWithSize(e,t),this.fontDefDictionary=new Tk(i),this._halfBleed=1,this._width=e,this._height=t,Qw.on($w.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}insertLetterTexture(e){const t=e.image,i=Qw.root.device;if(!t||!this.fontDefDictionary||!i)return null;const n=t.width,s=t.height;if(this._x+n+0>this._width&&(this._x=0,this._y=this._nextY),this._y+s>this._nextY&&(this._nextY=this._y+s+0),this._nextY>this._height)return T(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;const o=new jk;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=n+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o}update(){this._dirty&&(this._dirty=!1)}reset(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}destroy(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)}getTexture(){return this.fontDefDictionary.getTexture()}beforeSceneLoad(){this.clearAllCache()}clearAllCache(){this.destroy();const e=new Xk;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e}getLetter(e){return this.fontDefDictionary.letterDefinitions[e]}getLetterDefinitionForChar(e,t){const i=e.charCodeAt(0)+t.hash;let n=this.fontDefDictionary.letterDefinitions[i];if(!n){const i=new qk(e,t);i.updateRenderData(),n=this.insertLetterTexture(i),i.destroy()}return n}}const Kk={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Di.WHITE.clone(),isOutlined:!1,out:Di.WHITE.clone(),margin:0};class $k{constructor(){this.material=null,this.vertexCount=0,this.indicesCount=0}}class Qk extends $k{constructor(...e){super(...e),this.vData=null,this.uvDirty=!0,this.vertDirty=!0,this._data=[],this._indices=[],this._pivotX=0,this._pivotY=0,this._width=0,this._height=0}get dataLength(){return this._data.length}set dataLength(e){const t=this._data;if(t.length!==e){const i=t.length;let n=0;for(n=e;n<i;n++)Jk.free(t[n]);for(n=i;n<e;n++)t[n]=Jk.alloc();t.length=e}}get data(){return this._data}static add(){return eH.add()}static remove(e){const t=eH.data.indexOf(e);-1!==t&&(eH.data[t].clear(),eH.removeAt(t))}updateSizeNPivot(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}clear(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}}class Zk extends $k{constructor(e=9){super(),this.vData=void 0,this.iData=void 0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.byteCount=0,this.lastFilledIndices=0,this.lastFilledVertex=0,this._formatByte=void 0,this._formatByte=e*Float32Array.BYTES_PER_ELEMENT,this.vData=new Float32Array(256*e*Float32Array.BYTES_PER_ELEMENT),this.iData=new Uint16Array(1536)}set formatByte(e){this._formatByte=e}get formatByte(){return this._formatByte}get floatStride(){return this._formatByte>>2}get vDataOffset(){return this.byteCount>>>2}static add(){return tH.add()}static remove(e){const t=tH.data.indexOf(e);-1!==t&&(tH.data[t].reset(),tH.removeAt(t))}request(e,t){const i=this.byteCount+e*this._formatByte;return this.reserve(e,t),this.vertexCount+=e,this.indicesCount+=t,this.byteCount=i,!0}reserve(e,t){const i=this.byteCount+e*this._formatByte,n=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;let s=this.vData.byteLength,o=this.iData.length,r=this.vData.length,a=this.iData.length;if(i>s||n>o){for(;s<i||o<n;)r*=2,a*=2,s=4*r,o=a;this._reallocBuffer(r,a)}return!0}advance(e,t){this.vertexCount+=e,this.indicesCount+=t,this.byteCount+=e*this._formatByte}reset(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.lastFilledIndices=0,this.lastFilledVertex=0}_reallocBuffer(e,t){const i=this.vData;this.vData=new Float32Array(e),this.vData.set(i,0);const n=this.iData;this.iData=new Uint16Array(t),this.iData.set(n,0)}}const Jk=new F((()=>({x:0,y:0,z:0,u:0,v:0,color:Di.WHITE.clone()})),128),eH=new U((()=>new Qk),32),tH=new U((()=>new Zk),32);var iH,nH,sH,oH,rH,aH,cH,lH,hH,uH,_H,pH,dH,fH;const mH=new nn,gH=new nn,vH=new Zi,yH=new Zi,xH=new Zi,SH=new Zi(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),bH=new _n;let TH,EH=function(t){return e({UITransform:t,UITransformComponent:t}),t}((iH=Wc("cc.UITransform"),nH=al(),sH=Xc(110),oH=nl(),rH=vl(),aH=_l(),cH=vl(),lH=_l(),iH(hH=nH(hH=sH(hH=oH(hH=Yc(hH=il((fH=dH=class e extends Gh{constructor(...e){super(...e),this._priority=0,Mc(this,"_contentSize",_H,this),Mc(this,"_anchorPoint",pH,this)}get contentSize(){return this._contentSize}set contentSize(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(cy.SIZE_CHANGED),this._markRenderDataDirty())}get width(){return this._contentSize.width}set width(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(cy.SIZE_CHANGED),this._markRenderDataDirty())}get height(){return this._contentSize.height}set height(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(cy.SIZE_CHANGED),this._markRenderDataDirty())}get anchorPoint(){return this._anchorPoint}set anchorPoint(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(cy.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get anchorX(){return this._anchorPoint.x}set anchorX(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(cy.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get anchorY(){return this._anchorPoint.y}set anchorY(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(cy.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get priority(){return this._priority}set priority(t){this._priority!==t&&(this.node.getComponent("cc.RenderRoot2D")?T(6706):(this._priority=t,this.node.parent&&e.insertChangeMap(this.node.parent)))}get visibility(){const e=Qw.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}get cameraPriority(){const e=Qw.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}__preload(){this.node._uiProps.uiTransformComp=this}onLoad(){this.node.parent&&e.insertChangeMap(this.node.parent)}onEnable(){this.node.on(cy.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()}onDisable(){this.node.off(cy.PARENT_CHANGED,this._parentChanged,this)}onDestroy(){this.node._uiProps.uiTransformComp=null}setContentSize(e,t){const i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;i.width=e,i.height=t}this.node.emit(cy.SIZE_CHANGED),this._markRenderDataDirty()}setAnchorPoint(e,t){const i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(cy.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()}isHit(e,t){const i=this._contentSize.width,n=this._contentSize.height,s=mH,o=gH,r=this._getRenderScene().cameras;for(let a=0;a<r.length;a++){const c=r[a];if(!(c.visibility&this.node.layer))continue;c.node.getWorldRT(vH);const l=vH.m12,h=vH.m13,u=Mw.center;if(vH.m12=u.x-(vH.m00*l+vH.m04*h),vH.m13=u.y-(vH.m01*l+vH.m05*h),Zi.invert(vH,vH),nn.transformMat4(s,e,vH),this.node.getWorldMatrix(xH),Zi.invert(vH,xH),Zi.strictEquals(vH,SH))continue;nn.transformMat4(o,s,vH),o.x+=this._anchorPoint.x*i,o.y+=this._anchorPoint.y*n;let _=!1;if(o.x>=0&&o.y>=0&&o.x<=i&&o.y<=n&&(_=!0,t&&t.mask)){const e=t.mask;let i=this.node;const n=e?e.length:0;for(let t=0,o=0;i&&o<n;++t,i=i.parent){const n=e[o];if(t===n.index){if(i!==n.comp.node){e.length=o;break}{const e=n.comp;if(e&&e._enabled&&!e.isHit(s)){_=!1;break}o++}}else if(t>n.index){e.length=o;break}}}if(_)return!0}return!1}convertToNodeSpaceAR(e,t){return this.node.getWorldMatrix(xH),Zi.invert(vH,xH),t||(t=new zi),zi.transformMat4(t,e,vH)}convertToWorldSpaceAR(e,t){return this.node.getWorldMatrix(xH),t||(t=new zi),zi.transformMat4(t,e,xH)}getBoundingBox(){Zi.fromRTS(yH,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const e=this._contentSize.width,t=this._contentSize.height,i=new _n(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(yH),i}getBoundingBoxToWorld(){return this.node.parent?(this.node.parent.getWorldMatrix(xH),this.getBoundingBoxTo(xH)):this.getBoundingBox()}getBoundingBoxTo(t){Zi.fromRTS(yH,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const i=this._contentSize.width,n=this._contentSize.height,s=new _n(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(Zi.multiply(xH,t,yH),s.transformMat4(xH),!this.node.children)return s;const o=this.node.children;for(const i of o)if(i&&i.active){const n=i.getComponent(e);if(n){const e=n.getBoundingBoxTo(t);e&&_n.union(s,s,e)}}return s}getComputeAABB(e){const t=this._contentSize.width,i=this._contentSize.height;bH.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),bH.transformMat4(this.node.worldMatrix);const n=bH.x+.5*bH.width,s=bH.y+.5*bH.height,o=this.node.worldPosition.z,r=bH.width/2,a=bH.height/2;return null!=e?(xc.set(e,n,s,o,r,a,.001),e):new xc(n,s,o,r,a,.001)}_parentChanged(t){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&e.insertChangeMap(this.node.parent)}_markRenderDataDirty(){const e=this.node._uiProps.uiComp;e&&e.markForUpdateRenderData()}static insertChangeMap(t){const i=t.uuid;e.priorityChangeNodeMap.has(i)||e.priorityChangeNodeMap.set(i,t)}static _sortChildrenSibling(e){const t=e.children;t&&t.sort(((e,t)=>{const i=e._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp,s=(i?i._priority:0)-(n?n._priority:0);return 0===s?e.getSiblingIndex()-t.getSiblingIndex():s}))}static _sortSiblings(){e.priorityChangeNodeMap.forEach((t=>{e._sortChildrenSibling(t),t._updateSiblingIndex(),t.emit("childrenSiblingOrderChanged")})),e.priorityChangeNodeMap.clear()}static _cleanChangeMap(){e.priorityChangeNodeMap.clear()}},dH.EventType=cy,dH.priorityChangeNodeMap=new Map,Oc((uH=fH).prototype,"contentSize",[rH,aH],Object.getOwnPropertyDescriptor(uH.prototype,"contentSize"),uH.prototype),Oc(uH.prototype,"anchorPoint",[cH,lH],Object.getOwnPropertyDescriptor(uH.prototype,"anchorPoint"),uH.prototype),_H=Oc(uH.prototype,"_contentSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hn(100,100)}}),pH=Oc(uH.prototype,"_anchorPoint",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(.5,.5)}}),hH=uH))||hH)||hH)||hH)||hH)||hH)||hH));Qw.on($w.EVENT_AFTER_UPDATE,EH._sortSiblings),Qw.on($w.EVENT_BEFORE_SCENE_LAUNCH,EH._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(TH||(TH={}));class CH{constructor(){this.stage=TH.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Ys.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Ks.KEEP,zFailOp:Ks.KEEP,passOp:Ks.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}get pattern(){return this._stencilPattern}pushMask(e){this._maskStack.push(e)}clear(e){e.stencilStage=e.inverted?TH.CLEAR_INVERTED:TH.CLEAR}enterLevel(e){e.graphics.stencilStage=e.inverted?TH.ENTER_LEVEL_INVERTED:TH.ENTER_LEVEL}enableMask(){this.stage=TH.ENABLED}exitMask(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=TH.DISABLED:this.stage=TH.ENABLED)}getWriteMask(){return 1<<this._maskStack.length-1}getExitWriteMask(){return 1<<this._maskStack.length}getStencilRef(){let e=0;for(let t=0;t<this._maskStack.length;++t)e+=1<<t;return e}reset(){this._maskStack.length=0,this.stage=TH.DISABLED}destroy(){this.stencilStateMap.forEach((e=>{e.destroy()})),this.stencilStateMap.clear()}getStencilStage(e,t){let i=0,n=!1,s=!1,o=Ys.LESS,r=this.stencilStateMap;if(t&&t.passes[0]){const a=t.passes[0].depthStencilState;let c=0,l=0;a.depthTest&&(c=1),a.depthWrite&&(l=1),i=c|l<<1|a.depthFunc<<2|e<<6|this._maskStack.length<<9,n=a.depthTest,s=a.depthWrite,o=a.depthFunc,r=this.stencilStateMapWithDepth}else i=e<<16|this._maskStack.length;if(r&&r.has(i))return r.get(i);this.setStateFromStage(e);const a=new oa(n,s,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return r.set(i,a),a}getStencilHash(e){return e<<8|this._maskStack.length}setStateFromStage(e){const t=this._stencilPattern;e===TH.DISABLED?(t.stencilTest=!1,t.func=Ys.ALWAYS,t.failOp=Ks.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===TH.ENABLED?(t.func=Ys.EQUAL,t.failOp=Ks.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===TH.CLEAR?(t.func=Ys.NEVER,t.failOp=Ks.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===TH.CLEAR_INVERTED||e===TH.ENTER_LEVEL?(t.func=Ys.NEVER,t.failOp=Ks.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===TH.ENTER_LEVEL_INVERTED&&(t.func=Ys.NEVER,t.failOp=Ks.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))}}var wH,AH,PH,RH,IH,MH,OH,DH,NH,LH,BH,zH,FH,UH,GH,kH,HH,VH;let jH;e("StencilManager",CH),CH.sharedManager=null,CH.sharedManager=new CH,Fe($s),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(jH||(jH=e("InstanceMaterialType",{})));let WH=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((wH=Wc("cc.Renderable2D"),AH=qc(EH),PH=ll(),RH=Al(Wg),IH=Al(Wg),MH=vl(),OH=ul(),DH=vl(),NH=_l(),wH(LH=AH(LH=Yc(LH=il((VH=HH=class e extends iI{constructor(...e){super(...e),Mc(this,"_materials",zH,this),Mc(this,"_customMaterial",FH,this),this.stencilStage=TH.DISABLED,Mc(this,"_srcBlendFactor",UH,this),Mc(this,"_dstBlendFactor",GH,this),Mc(this,"_color",kH,this),this._assembler=null,this._postAssembler=null,this._renderData=null,this._renderDataFlag=!0,this._renderFlag=!0,this._delegateSrc=null,this._instanceMaterialType=jH.ADD_COLOR_AND_TEXTURE,this._blendState=new na,this._blendHash=0,this._colorDirty=!0,this._cacheAlpha=1,this._lastParent=null}get sharedMaterials(){return this._materials}set sharedMaterials(e){for(let t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(let t=e.length;t<this._materials.length;t++)this.setMaterial(null,t);this._materials.splice(e.length)}}get customMaterial(){return this._customMaterial}set customMaterial(e){this._customMaterial=e,this.updateMaterial()}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);const e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._updateBlendFunc()}get srcBlendFactor(){return this._customMaterial&&T(12001),this._srcBlendFactor}set srcBlendFactor(e){this._customMaterial?T(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}get dstBlendFactor(){return this._customMaterial&&T(12001),this._dstBlendFactor}set dstBlendFactor(e){this._customMaterial?T(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}get color(){return this._color}set color(e){this._color.equals(e)||(this._color.set(e),this._colorDirty=!0)}get renderData(){return this._renderData}set delegateSrc(e){this._delegateSrc=e}get blendHash(){return this._blendHash}updateBlendHash(){const e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc}__preload(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}onEnable(){this.node.on(cy.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(cy.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()}onRestore(){this.updateMaterial(),this._renderFlag=this._canRender()}onDisable(){this.node.off(cy.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(cy.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}onDestroy(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(let e=0;e<this._materialInstances.length;e++)this._materialInstances[e]&&this._materialInstances[e].destroy();this._renderData=null,this._blendState&&this._blendState.destroy()}markForUpdateRenderData(e=!0){if(this._renderFlag=this._canRender(),e&&this._renderFlag){const t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)}requestRenderData(){const e=Qk.add();return this._renderData=e,e}destroyRenderData(){this._renderData&&(Qk.remove(this._renderData),this._renderData=null)}updateAssembler(e){this._updateColor(),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}postUpdateAssembler(e){this._renderFlag&&this._postRender(e)}_render(e){}_postRender(e){}_checkAndUpdateRenderData(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}_canRender(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this.node._uiProps.opacity>0}_postCanRender(){}_updateColor(){const e=this._cacheAlpha<=0;this._updateWorldAlpha(),this._colorDirty&&this._assembler&&this._assembler.updateColor&&(this._assembler.updateColor(this),e&&(this._renderFlag=this._canRender()),this._colorDirty=!1)}_updateWorldAlpha(){let e=this.color.a/255;1===e&&(e=this.node._uiProps.localOpacity);const t=this.node._uiProps.opacity*e;this.node._uiProps.opacity=t,this._colorDirty=this._colorDirty||t!==this._cacheAlpha,this._cacheAlpha=t}_updateBlendFunc(){let e=this._blendState.targets[0];e||(e=new ia,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=$s.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor),this.updateBlendHash()}getBlendState(){return this._blendState}_nodeStateChange(t){this._renderData&&this.markForUpdateRenderData();for(let t=0;t<this.node.children.length;++t){const i=this.node.children[t].getComponent(e);i&&i.markForUpdateRenderData()}}_updateBuiltinMaterial(){let e;switch(this._instanceMaterialType){case jH.ADD_COLOR:e=cg.get("ui-base-material");break;case jH.GRAYSCALE:e=cg.get("ui-sprite-gray-material");break;case jH.USE_ALPHA_SEPARATED:e=cg.get("ui-sprite-alpha-sep-material");break;case jH.USE_ALPHA_SEPARATED_AND_GRAY:e=cg.get("ui-sprite-gray-alpha-sep-material");break;default:e=cg.get("ui-sprite-material")}return e}_setCacheAlpha(e){this._cacheAlpha=e}},HH.BlendState=$s,HH.Assembler=null,HH.PostAssembler=null,zH=Oc((BH=VH).prototype,"_materials",[Pl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oc(BH.prototype,"sharedMaterials",[Pl,PH],Object.getOwnPropertyDescriptor(BH.prototype,"sharedMaterials"),BH.prototype),FH=Oc(BH.prototype,"_customMaterial",[RH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(BH.prototype,"customMaterial",[IH,MH,OH],Object.getOwnPropertyDescriptor(BH.prototype,"customMaterial"),BH.prototype),Oc(BH.prototype,"color",[DH,NH],Object.getOwnPropertyDescriptor(BH.prototype,"color"),BH.prototype),UH=Oc(BH.prototype,"_srcBlendFactor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $s.SRC_ALPHA}}),GH=Oc(BH.prototype,"_dstBlendFactor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $s.ONE_MINUS_SRC_ALPHA}}),kH=Oc(BH.prototype,"_color",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),LH=BH))||LH)||LH)||LH)||LH));var qH,XH,YH,KH,$H,QH,ZH,JH,eV,tV,iV,nV,sV,oV,rV,aV,cV,lV,hV,uV,_V,pV,dV,fV,mV,gV,vV,yV,xV,SV,bV,TV,EV,CV,wV,AV,PV,RV,IV,MV,OV,DV,NV,LV,BV,zV,FV,UV,GV,kV,HV,VV,jV,WV,qV,XV,YV,KV,$V,QV;let ZV,JV,ej,tj;n.internal.Renderable2D=WH,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(ZV||(ZV=e("HorizontalTextAlignment",{}))),Fe(ZV),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(JV||(JV=e("VerticalTextAlignment",{}))),Fe(JV),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(ej||(ej=e("Overflow",{}))),Fe(ej),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(tj||(tj=e("CacheMode",{}))),Fe(tj);let ij,nj,sj,oj=function(t){return e({Label:t,LabelComponent:t}),t}((qH=Wc("cc.Label"),XH=al(),YH=Xc(110),KH=nl(),$H=vl(),QH=_l(),ZH=Al(ZV),JH=vl(),eV=_l(),tV=Al(JV),iV=vl(),nV=_l(),sV=vl(),oV=_l(),rV=vl(),aV=ll(),cV=_l(),lV=vl(),hV=_l(),uV=Al(ej),_V=vl(),pV=_l(),dV=vl(),fV=_l(),mV=Al(lk),gV=vl(),vV=ll(),yV=_l(),xV=vl(),SV=_l(),bV=Al(tj),TV=vl(),EV=_l(),CV=vl(),wV=_l(),AV=vl(),PV=_l(),RV=vl(),IV=_l(),MV=ll(),qH(OV=XH(OV=YH(OV=KH((QV=$V=class e extends WH{get string(){return this._string}set string(e){e?e+="":e="",this._string!==e&&(this._string=e,this.updateRenderData())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}get verticalAlign(){return this._verticalAlign}set verticalAlign(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}get actualFontSize(){return this._actualFontSize}set actualFontSize(e){this._actualFontSize=e}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}get lineHeight(){return this._lineHeight}set lineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}get overflow(){return this._overflow}set overflow(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}get enableWrapText(){return this._enableWrapText}set enableWrapText(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}get font(){return this._font}set font(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}get cacheMode(){return this._cacheMode}set cacheMode(e){this._cacheMode!==e&&(this._cacheMode!==tj.BITMAP||this._font instanceof Ek||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===tj.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}get spriteFrame(){return this._texture}get ttfSpriteFrame(){return this._ttfSpriteFrame}get isBold(){return this._isBold}set isBold(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}get isItalic(){return this._isItalic}set isItalic(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}get isUnderline(){return this._isUnderline}set isUnderline(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}get underlineHeight(){return this._underlineHeight}set underlineHeight(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}get assemblerData(){return this._assemblerData}get fontAtlas(){return this._fontAtlas}set fontAtlas(e){this._fontAtlas=e}get spacingX(){return this._spacingX}set spacingX(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}get _bmFontOriginalSize(){return this._font instanceof Ek?this._font.fontSize:-1}constructor(){super(),Mc(this,"_string",NV,this),Mc(this,"_horizontalAlign",LV,this),Mc(this,"_verticalAlign",BV,this),Mc(this,"_actualFontSize",zV,this),Mc(this,"_fontSize",FV,this),Mc(this,"_fontFamily",UV,this),Mc(this,"_lineHeight",GV,this),Mc(this,"_overflow",kV,this),Mc(this,"_enableWrapText",HV,this),Mc(this,"_font",VV,this),Mc(this,"_isSystemFontUsed",jV,this),this._spacingX=0,Mc(this,"_isItalic",WV,this),Mc(this,"_isBold",qV,this),Mc(this,"_isUnderline",XV,this),Mc(this,"_underlineHeight",YV,this),Mc(this,"_cacheMode",KV,this),this._N$file=null,this._texture=null,this._ttfSpriteFrame=null,this._userDefinedFont=null,this._assemblerData=null,this._fontAtlas=null,this._letterTexture=null,this._ttfSpriteFrame=null}onEnable(){super.onEnable(),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()}onDisable(){super.onDisable()}onDestroy(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){const e=this._ttfSpriteFrame.texture;if(e&&null===this._ttfSpriteFrame.original){const t=e;t.image&&t.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,super.onDestroy()}updateRenderData(e=!1){this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))}_render(e){e.commitComp(this,this._texture,this._assembler,null)}_updateColor(){this._updateWorldAlpha(),this._colorDirty&&(this.updateRenderData(!1),this._colorDirty=!1)}_canRender(){if(!super._canRender()||!this._string)return!1;const e=this._font;if(e&&e instanceof Ek){const t=e.spriteFrame;if(!t||!t.texture)return!1}return!0}_flushAssembler(){const t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}_applyFontTexture(){this.markForUpdateRenderData();const e=this._font;if(e instanceof Ek){const t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===tj.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new nk,this._assemblerData=this._assembler.getAssemblerData();const e=new Wf(this._assemblerData.canvas),t=new wm;t.image=e,this._ttfSpriteFrame.texture=t}this.cacheMode!==tj.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}}changeMaterialForDefine(){if(!this._texture)return;let e=!1;if(this.cacheMode!==tj.CHAR){const t=this._texture.texture;if(t instanceof um){const i=t.getPixelFormat();e=i===Lf.RGBA_ETC1||i===Lf.RGB_A_PVRTC_4BPPV1||i===Lf.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?jH.USE_ALPHA_SEPARATED:jH.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},$V.HorizontalAlign=ZV,$V.VerticalAlign=JV,$V.Overflow=ej,$V.CacheMode=tj,$V._canvasPool=Hk.getInstance(),Oc((DV=QV).prototype,"string",[$H,QH,Sl],Object.getOwnPropertyDescriptor(DV.prototype,"string"),DV.prototype),Oc(DV.prototype,"horizontalAlign",[ZH,JH,eV],Object.getOwnPropertyDescriptor(DV.prototype,"horizontalAlign"),DV.prototype),Oc(DV.prototype,"verticalAlign",[tV,iV,nV],Object.getOwnPropertyDescriptor(DV.prototype,"verticalAlign"),DV.prototype),Oc(DV.prototype,"fontSize",[sV,oV],Object.getOwnPropertyDescriptor(DV.prototype,"fontSize"),DV.prototype),Oc(DV.prototype,"fontFamily",[rV,aV,cV],Object.getOwnPropertyDescriptor(DV.prototype,"fontFamily"),DV.prototype),Oc(DV.prototype,"lineHeight",[lV,hV],Object.getOwnPropertyDescriptor(DV.prototype,"lineHeight"),DV.prototype),Oc(DV.prototype,"overflow",[uV,_V,pV],Object.getOwnPropertyDescriptor(DV.prototype,"overflow"),DV.prototype),Oc(DV.prototype,"enableWrapText",[dV,fV],Object.getOwnPropertyDescriptor(DV.prototype,"enableWrapText"),DV.prototype),Oc(DV.prototype,"font",[mV,gV,vV,yV],Object.getOwnPropertyDescriptor(DV.prototype,"font"),DV.prototype),Oc(DV.prototype,"useSystemFont",[xV,SV],Object.getOwnPropertyDescriptor(DV.prototype,"useSystemFont"),DV.prototype),Oc(DV.prototype,"cacheMode",[bV,TV,EV],Object.getOwnPropertyDescriptor(DV.prototype,"cacheMode"),DV.prototype),Oc(DV.prototype,"isBold",[CV,wV],Object.getOwnPropertyDescriptor(DV.prototype,"isBold"),DV.prototype),Oc(DV.prototype,"isItalic",[AV,PV],Object.getOwnPropertyDescriptor(DV.prototype,"isItalic"),DV.prototype),Oc(DV.prototype,"isUnderline",[RV,IV],Object.getOwnPropertyDescriptor(DV.prototype,"isUnderline"),DV.prototype),Oc(DV.prototype,"underlineHeight",[MV,cl],Object.getOwnPropertyDescriptor(DV.prototype,"underlineHeight"),DV.prototype),NV=Oc(DV.prototype,"_string",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),LV=Oc(DV.prototype,"_horizontalAlign",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZV.CENTER}}),BV=Oc(DV.prototype,"_verticalAlign",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JV.CENTER}}),zV=Oc(DV.prototype,"_actualFontSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FV=Oc(DV.prototype,"_fontSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),UV=Oc(DV.prototype,"_fontFamily",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),GV=Oc(DV.prototype,"_lineHeight",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),kV=Oc(DV.prototype,"_overflow",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ej.NONE}}),HV=Oc(DV.prototype,"_enableWrapText",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VV=Oc(DV.prototype,"_font",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jV=Oc(DV.prototype,"_isSystemFontUsed",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WV=Oc(DV.prototype,"_isItalic",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qV=Oc(DV.prototype,"_isBold",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),XV=Oc(DV.prototype,"_isUnderline",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YV=Oc(DV.prototype,"_underlineHeight",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),KV=Oc(DV.prototype,"_cacheMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tj.NONE}}),OV=DV))||OV)||OV)||OV)||OV));!function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(ij||(ij={})),Fe(ij),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(nj||(nj={})),Fe(nj),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(sj||(sj={})),Fe(sj);const rj=Math.PI,aj=Math.min,cj=Math.max,lj=Math.cos,hj=Math.sin,uj=Math.abs,_j=Math.sign,pj=.5522847493;function dj(e,t,i,n,s){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+s*pj,t-n*pj,i+s,t,i+s),e.bezierCurveTo(t+n*pj,i+s,t+n,i+s*pj,t+n,i),e.bezierCurveTo(t+n,i-s*pj,t+n*pj,i-s,t,i-s),e.bezierCurveTo(t-n*pj,i-s,t-n,i-s*pj,t-n,i),e.close()}function fj(e,t,i,n,s,o,r,a,c,l,h){let u=0,_=0,p=0,d=0,f=0,m=0,g=0,v=0,y=0,x=0,S=0,b=0,T=0,E=0,C=0,w=0;l>10||(u=.5*(t+n),_=.5*(i+s),p=.5*(n+o),d=.5*(s+r),f=.5*(o+a),m=.5*(r+c),g=.5*(u+p),v=.5*(_+d),T=a-t,E=c-i,C=uj((n-a)*E-(s-c)*T),w=uj((o-a)*E-(r-c)*T),(C+w)*(C+w)<e.tessTol*(T*T+E*E)?e.addPoint(a,c,0===h?h|sj.PT_BEVEL:h):(y=.5*(p+f),x=.5*(d+m),S=.5*(g+y),b=.5*(v+x),fj(e,t,i,u,_,g,v,S,b,l+1,0),fj(e,S,b,y,x,f,m,a,c,l+1,h)))}class mj extends nn{constructor(e,t){super(e,t),this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0,this.reset()}reset(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}class gj{constructor(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}reset(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}class vj{constructor(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Di.WHITE.clone(),this.lineCap=ij.BUTT,this.strokeColor=Di.BLACK.clone(),this.lineJoin=nj.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}moveTo(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,sj.PT_CORNER),this._commandX=e,this._commandY=t}lineTo(e,t){this.addPoint(e,t,sj.PT_CORNER),this._commandX=e,this._commandY=t}bezierCurveTo(e,t,i,n,s,o){const r=this._curPath,a=r.points[r.points.length-1];a&&(a.x!==e||a.y!==t||i!==s||n!==o?(fj(this,a.x,a.y,e,t,i,n,s,o,0,sj.PT_CORNER),this._commandX=s,this._commandY=o):this.lineTo(s,o))}quadraticCurveTo(e,t,i,n){const s=this._commandX,o=this._commandY;this.bezierCurveTo(s+2/3*(e-s),o+2/3*(t-o),i+2/3*(e-i),n+2/3*(t-n),i,n)}arc(e,t,i,n,s,o){!function(e,t,i,n,s,o,r){let a=0,c=0,l=0,h=0,u=0,_=0,p=0,d=0,f=0,m=0,g=0,v=0,y=0,x=0,S=0,b=0;if(c=o-s,r=r||!1)if(uj(c)>=2*rj)c=2*rj;else for(;c<0;)c+=2*rj;else if(uj(c)>=2*rj)c=2*-rj;else for(;c>0;)c-=2*rj;for(b=0|cj(1,aj(uj(c)/(.5*rj)+.5,5)),l=c/b/2,h=uj(4/3*(1-lj(l))/hj(l)),r||(h=-h),S=0;S<=b;S++)a=s+c*(S/b),u=lj(a),_=hj(a),p=t+u*n,d=i+_*n,f=-_*n*h,m=u*n*h,0===S?e.moveTo(p,d):e.bezierCurveTo(g+y,v+x,p-f,d-m,p,d),g=p,v=d,y=f,x=m}(this,e,t,i,n,s,o)}ellipse(e,t,i,n){dj(this,e,t,i,n),this._curPath.complex=!1}circle(e,t,i){dj(this,e,t,i,i),this._curPath.complex=!1}rect(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}roundRect(e,t,i,n,s){!function(e,t,i,n,s,o){if(o<.1)e.rect(t,i,n,s);else{const r=aj(o,.5*uj(n))*_j(n),a=aj(o,.5*uj(s))*_j(s);e.moveTo(t,i+a),e.lineTo(t,i+s-a),e.bezierCurveTo(t,i+s-a*(1-pj),t+r*(1-pj),i+s,t+r,i+s),e.lineTo(t+n-r,i+s),e.bezierCurveTo(t+n-r*(1-pj),i+s,t+n,i+s-a*(1-pj),t+n,i+s-a),e.lineTo(t+n,i+a),e.bezierCurveTo(t+n,i+a*(1-pj),t+n-r*(1-pj),i,t+n-r,i),e.lineTo(t+r,i),e.bezierCurveTo(t+r*(1-pj),i,t,i+a*(1-pj),t,i+a),e.close()}}(this,e,t,i,n,s),this._curPath.complex=!1}clear(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;const e=this._renderDataList;for(let t=0,i=e.length;t<i;t++){const i=e[t];i&&Zk.remove(i)}this._renderDataList.length=0}close(){this._curPath.closed=!0}requestRenderData(){const e=Zk.add();return this._renderDataList.push(e),e}getRenderDataList(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}addPoint(e,t,i){const n=this._curPath;if(!n)return;const s=this._points,o=n.points;let r=s[this.pointsOffset++];r?(r.x=e,r.y=t):(r=new mj(e,t),s.push(r)),r.flags=i,o.push(r)}_addPath(){const e=this.pathLength;let t=this.paths[e];return t?t.reset():(t=new gj,this.paths.push(t)),this.pathLength++,this._curPath=t,t}}const yj=[new Xo(mo.ATTR_POSITION,Ls.RGB32F)],xj=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_COLOR,Ls.RGBA32F)],Sj=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RG32F),new Xo(mo.ATTR_COLOR,Ls.RGBA32F)],bj=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RG32F),new Xo(mo.ATTR_COLOR,Ls.RGBA32F),new Xo(mo.ATTR_COLOR2,Ls.RGBA32F)];function Tj(e){let t=0;for(let i=0;i<e.length;i++){const n=e[i];t+=vr[n.format].count}return t}function Ej(e){let t=0;for(let i=0;i<e.length;i++){const n=e[i];t+=vr[n.format].size}return t}var Cj,wj,Aj,Pj,Rj,Ij,Mj,Oj,Dj,Nj,Lj,Bj,zj,Fj,Uj,Gj,kj,Hj,Vj,jj,Wj,qj;n.internal.vfmtPosUvColor=Sj,n.internal.vfmtPosUvTwoColor=bj,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:yj,vfmtPosColor:xj,vfmtPosUvColor:Sj,vfmtPosUvTwoColor:bj,getComponentPerVertex:Tj,getAttributeStride:Ej}));const Xj=xj.concat([new Xo("a_dist",Ls.R32F)]),Yj=Tj(Xj),Kj=Ej(Xj);let $j=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((Cj=Wc("cc.Graphics"),wj=al(),Aj=Xc(110),Pj=nl(),Rj=Al(nj),Ij=_l(),Mj=Al(ij),Oj=_l(),Dj=_l(),Nj=_l(),Lj=_l(),Bj=ll(),Cj(zj=wj(zj=Aj(zj=Pj((qj=Wj=class e extends WH{get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}get lineJoin(){return this._lineJoin}set lineJoin(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}get lineCap(){return this._lineCap}set lineCap(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}get strokeColor(){return this._strokeColor}set strokeColor(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}get fillColor(){return this._fillColor}set fillColor(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}get miterLimit(){return this._miterLimit}set miterLimit(e){this._miterLimit=e}get color(){return this._color}set color(e){this._color!==e&&this._color.set(e)}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(e){}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(e){}constructor(){super(),this.impl=null,this.model=null,Mc(this,"_lineWidth",Uj,this),Mc(this,"_strokeColor",Gj,this),Mc(this,"_lineJoin",kj,this),Mc(this,"_lineCap",Hj,this),Mc(this,"_fillColor",Vj,this),Mc(this,"_miterLimit",jj,this),this._isDrawing=!1,this._isNeedUploadData=!0,this._graphicsUseSubMeshes=[],this._instanceMaterialType=jH.ADD_COLOR,this.impl=new vj}onRestore(){this.impl||this._flushAssembler()}onLoad(){this.model=Qw.root.createModel(Tg),this.model.node=this.model.transform=this.node,this._flushAssembler()}onEnable(){super.onEnable(),this._updateMtlForGraphics()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._sceneGetter=null,this.model&&(Qw.root.destroyModel(this.model),this.model=null);const e=this._graphicsUseSubMeshes.length;if(e>0){for(let t=0;t<e;++t)this._graphicsUseSubMeshes[t].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)}moveTo(e,t){this.impl&&this.impl.moveTo(e,t)}lineTo(e,t){this.impl&&this.impl.lineTo(e,t)}bezierCurveTo(e,t,i,n,s,o){this.impl&&this.impl.bezierCurveTo(e,t,i,n,s,o)}quadraticCurveTo(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}arc(e,t,i,n,s,o){this.impl&&this.impl.arc(e,t,i,n,s,o)}ellipse(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}circle(e,t,i){this.impl&&this.impl.circle(e,t,i)}rect(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}roundRect(e,t,i,n,s){this.impl&&this.impl.roundRect(e,t,i,n,s)}fillRect(e,t,i,n){this.rect(e,t,i,n),this.fill()}clear(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(let e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}close(){this.impl&&this.impl.close()}stroke(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}fill(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}_updateMtlForGraphics(){let e;this._customMaterial?e=this.getMaterialInstance(0):(e=cg.get("ui-graphics-material"),this.setMaterial(e,0),e=this.getMaterialInstance(0),e.recompileShaders({USE_LOCAL:!0}))}activeSubModel(e){if(this.model){if(this.model.subModels.length<=e){const t=n.director.root.device,i=t.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.DEVICE,65535*Kj,Kj)),s=t.createBuffer(new Io(Fs.INDEX|Fs.TRANSFER_DST,ks.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new cb([i],Xj,oo.TRIANGLE_LIST,s);o.subMeshIdx=0,this.model.initSubModel(e,o,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(o)}}else T(4500,this.node.name)}_uploadData(e){const t=this.impl;if(!t)return;const i=t&&t.getRenderDataList();if(i.length<=0||!this.model)return;const n=this.model.subModels;for(let e=0;e<i.length;e++){const t=i[e],s=n[e].inputAssembler;if(t.lastFilledVertex===t.vertexStart)continue;const o=new Float32Array(t.vData.buffer,0,t.vertexStart*Yj);s.vertexBuffers[0].update(o),s.vertexCount=t.vertexStart;const r=new Uint16Array(t.iData.buffer,0,t.indicesStart);s.indexBuffer.update(r),s.indexCount=t.indicesStart,t.lastFilledVertex=t.vertexStart,t.lastFilledIndices=t.indicesStart}e.removeUploadBuffersFunc(this),this._isNeedUploadData=!1}_render(e){if(this._isNeedUploadData){if(this.impl){const e=this.impl.getRenderDataList(),t=this.model.subModels.length;if(e.length>t)for(let i=t;i<e.length;i++)this.activeSubModel(i)}e.addUploadBuffersFunc(this,this._uploadData)}e.commitModel(this,this.model,this.getMaterialInstance(0))}_flushAssembler(){const t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t)}_canRender(){return!!super._canRender()&&!!this.model&&this._isDrawing}},Wj.LineJoin=nj,Wj.LineCap=ij,Oc((Fj=qj).prototype,"lineWidth",[cl],Object.getOwnPropertyDescriptor(Fj.prototype,"lineWidth"),Fj.prototype),Oc(Fj.prototype,"lineJoin",[Rj,Ij],Object.getOwnPropertyDescriptor(Fj.prototype,"lineJoin"),Fj.prototype),Oc(Fj.prototype,"lineCap",[Mj,Oj],Object.getOwnPropertyDescriptor(Fj.prototype,"lineCap"),Fj.prototype),Oc(Fj.prototype,"strokeColor",[Dj],Object.getOwnPropertyDescriptor(Fj.prototype,"strokeColor"),Fj.prototype),Oc(Fj.prototype,"fillColor",[Nj],Object.getOwnPropertyDescriptor(Fj.prototype,"fillColor"),Fj.prototype),Oc(Fj.prototype,"miterLimit",[Lj],Object.getOwnPropertyDescriptor(Fj.prototype,"miterLimit"),Fj.prototype),Oc(Fj.prototype,"color",[Pl,Bj],Object.getOwnPropertyDescriptor(Fj.prototype,"color"),Fj.prototype),Uj=Oc(Fj.prototype,"_lineWidth",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Gj=Oc(Fj.prototype,"_strokeColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.BLACK.clone()}}),kj=Oc(Fj.prototype,"_lineJoin",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nj.MITER}}),Hj=Oc(Fj.prototype,"_lineCap",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ij.BUTT}}),Vj=Oc(Fj.prototype,"_fillColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),jj=Oc(Fj.prototype,"_miterLimit",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),zj=Fj))||zj)||zj)||zj)||zj));var Qj,Zj,Jj,eW,tW,iW,nW,sW,oW,rW,aW,cW,lW,hW,uW,_W,pW,dW,fW,mW,gW,vW,yW,xW,SW;const bW=new Zi,TW=new nn,EW=new Zi,CW=[];let wW;!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(wW||(wW={})),Fe(wW);let AW=function(t){return e({Mask:t,MaskComponent:t}),t}((Qj=Wc("cc.Mask"),Zj=al(),Jj=Xc(110),eW=nl(),tW=Al(wW),iW=vl(),nW=_l(),sW=vl(),oW=_l(),rW=ll(),aW=Al(nk),cW=ll(),lW=ll(),hW=pl(),uW=ll(),_W=ll(),Qj(pW=Zj(pW=Jj(pW=eW((SW=xW=class e extends WH{get type(){return this._type}set type(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==wW.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}get inverted(){return this._inverted}set inverted(e){this._inverted=e,this.stencilStage=TH.DISABLED,this._graphics&&(this._graphics.stencilStage=TH.DISABLED)}get segments(){return this._segments}set segments(e){this._segments!==e&&(this._segments=di(e,3,1e4),this._updateGraphics())}get spriteFrame(){return this._spriteFrame}set spriteFrame(e){if(this._spriteFrame===e)return;const t=this._spriteFrame;this._spriteFrame=e,this._type===wW.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}get alphaThreshold(){return this._alphaThreshold}set alphaThreshold(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===wW.IMAGE_STENCIL&&this._graphics)&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold)}get graphics(){return this._graphics}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}get color(){return this._color}set color(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}get customMaterial(){return this._customMaterial}set customMaterial(e){}constructor(){super(),this._clearStencilMtl=null,this._clearModel=null,Mc(this,"_type",fW,this),Mc(this,"_inverted",mW,this),Mc(this,"_segments",gW,this),Mc(this,"_spriteFrame",vW,this),Mc(this,"_alphaThreshold",yW,this),this._graphics=null,this._clearModelMesh=null,this._instanceMaterialType=jH.ADD_COLOR}onLoad(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()}onEnable(){super.onEnable(),this._updateGraphics(),this._enableGraphics()}onRestore(){this._createGraphics(),super.updateMaterial(),this._updateGraphics(),this._renderFlag=this._canRender()}onDisable(){super.onDisable(),this._disableGraphics()}onDestroy(){super.onDestroy(),this._clearModel&&this._clearModelMesh&&(Qw.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()}isHit(e){const t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=i.width,s=i.height,o=TW;this.node.getWorldMatrix(bW),Zi.invert(EW,bW),nn.transformMat4(o,e,EW);const r=t.anchorPoint;o.x+=r.x*n,o.y+=r.y*s;let a=!1;if(this.type===wW.RECT||this.type===wW.GRAPHICS_STENCIL)a=o.x>=0&&o.y>=0&&o.x<=n&&o.y<=s;else if(this.type===wW.ELLIPSE){const e=n/2,t=s/2,i=o.x-.5*n,r=o.y-.5*s;a=i*i/(e*e)+r*r/(t*t)<1}return this._inverted&&(a=!a),a}_render(e){e.commitComp(this,null,this._assembler,null)}_postRender(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler,null)}_nodeStateChange(e){super._nodeStateChange(e),this._updateGraphics()}_canRender(){return!!super._canRender()&&null!==this._graphics&&(this._type!==wW.IMAGE_STENCIL||null!==this._spriteFrame)}_flushAssembler(){const t=e.Assembler.getAssembler(this),i=e.PostAssembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._postAssembler!==i&&(this._postAssembler=i),this._useRenderData()}_createGraphics(){if(!this._graphics){const e=this._graphics=new $j;e._objFlags|=Ot.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;const t=Di.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()}_updateGraphics(){if(!this._graphics||this._type!==wW.RECT&&this._type!==wW.ELLIPSE)return;const e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();const i=e.contentSize,n=i.width,s=i.height,o=e.anchorPoint,r=-n*o.x,a=-s*o.y;if(this._type===wW.RECT)t.rect(r,a,n,s);else if(this._type===wW.ELLIPSE){const e=function(e,t,i){CW.length=0;const n=2*Math.PI/i;for(let s=0;s<i;++s)CW.push(new zi(t.x*Math.cos(n*s)+e.x,t.y*Math.sin(n*s)+e.y,0));return CW}(new zi(r+n/2,a+s/2,0),new zi(n/2,s/2,0),this._segments);for(let i=0;i<e.length;++i){const n=e[i];0===i?t.moveTo(n.x,n.y):t.lineTo(n.x,n.y)}t.close()}t.fill()}_createClearModel(){if(!this._clearModel){const e=cg.get("default-clear-stencil");this._clearStencilMtl=new av({parent:e,owner:this,subModelIdx:0}),this._clearModel=Qw.root.createModel(Tg),this._clearModel.node=this._clearModel.transform=this.node;const t=Ej(yj),i=n.director.root.device,s=i.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.DEVICE,4*t,t)),o=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);s.update(o);const r=i.createBuffer(new Io(Fs.INDEX|Fs.TRANSFER_DST,ks.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);r.update(a),this._clearModelMesh=new cb([s],yj,oo.TRIANGLE_LIST,r),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}}_updateMaterial(){if(this._graphics){const e=this._graphics;let t;e.stencilStage=TH.DISABLED,this._type===wW.IMAGE_STENCIL?(t=cg.get("ui-alpha-test-material"),e.setMaterial(t,0),t=e.getMaterialInstance(0),t.setProperty("alphaThreshold",this._alphaThreshold)):(t=cg.get("ui-graphics-material"),e.setMaterial(t,0),e.getMaterialInstance(0))}}_enableGraphics(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())}_disableGraphics(){this._graphics&&this._graphics.onDisable()}_removeGraphics(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)}_useRenderData(){this._type!==wW.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())}},xW.Type=wW,Oc((dW=SW).prototype,"type",[tW,iW,nW],Object.getOwnPropertyDescriptor(dW.prototype,"type"),dW.prototype),Oc(dW.prototype,"inverted",[sW,oW],Object.getOwnPropertyDescriptor(dW.prototype,"inverted"),dW.prototype),Oc(dW.prototype,"segments",[rW],Object.getOwnPropertyDescriptor(dW.prototype,"segments"),dW.prototype),Oc(dW.prototype,"spriteFrame",[aW,cW],Object.getOwnPropertyDescriptor(dW.prototype,"spriteFrame"),dW.prototype),Oc(dW.prototype,"alphaThreshold",[lW,hW,gl],Object.getOwnPropertyDescriptor(dW.prototype,"alphaThreshold"),dW.prototype),Oc(dW.prototype,"color",[Pl,uW],Object.getOwnPropertyDescriptor(dW.prototype,"color"),dW.prototype),Oc(dW.prototype,"customMaterial",[Pl,_W],Object.getOwnPropertyDescriptor(dW.prototype,"customMaterial"),dW.prototype),fW=Oc(dW.prototype,"_type",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wW.RECT}}),mW=Oc(dW.prototype,"_inverted",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gW=Oc(dW.prototype,"_segments",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),vW=Oc(dW.prototype,"_spriteFrame",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yW=Oc(dW.prototype,"_alphaThreshold",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),pW=dW))||pW)||pW)||pW)||pW));Eb._comp=AW,n.Mask=AW;const PW=/^(click)(\s)*=|(param)(\s)*=/,RW=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;class IW{constructor(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}parse(e){this._resultObjectArray.length=0,this._stack.length=0;let t=0;const i=e.length;for(;t<i;){let n=e.indexOf(">",t),s=-1;if(n>=0&&(s=e.lastIndexOf("<",n),s<t-1&&(s=e.indexOf("<",n+1),n=e.indexOf(">",s+1))),s<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{let i=e.substring(t,s);const o=e.substring(s+1,n);""===o&&(i=e.substring(t,n+1)),this._processResult(i),-1===n?n=s:"/"===e.charAt(s+1)?this._stack.pop():this._addToStack(o),t=n+1}}return this._resultObjectArray}_attributeToObject(e){e=e.trim();const t={};let i=/^(color|size)(\s)*=/.exec(e),n="",s=0,o="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(s=e.indexOf(" "),n[0]){case"c":t.color=s>-1?e.substring(0,s).trim():e;break;case"s":t.size=parseInt(e)}return s>-1&&(o=e.substring(s+1).trim(),t.event=this._processEventHandler(o)),t}if(i=/^(br(\s)*\/)/.exec(e),i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("br")&&"/"===n[n.length-1]))return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;i=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e);let r="";if(i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("img")&&"/"===n[n.length-1])){let o;i=RW.exec(e);let a=!1;for(;i;){if(n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),r=e.substring(n.length).trim(),s=r.indexOf(" "),o=s>-1?r.substr(0,s):r,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLowerCase(),e=r.substring(s).trim(),o.endsWith("/")&&(o=o.slice(0,-1)),"src"===n){switch(o.charCodeAt(0)){case 34:case 39:a=!0,o=o.slice(1,-1)}t.isImage=!0,t.src=o}else if("height"===n)t.imageHeight=parseInt(o);else if("width"===n)t.imageWidth=parseInt(o);else if("align"===n){switch(o.charCodeAt(0)){case 34:case 39:o=o.slice(1,-1)}t.imageAlign=o.toLowerCase()}else"offset"===n?t.imageOffset=o:"click"===n&&(t.event=this._processEventHandler(`${n}=${o}`));t.event&&"param"===n&&(t.event[n]=o.replace(/^"|"$/g,"")),i=RW.exec(e)}return a&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=/^(outline(\s)*[^>]*)/.exec(e),i){const o={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){const a=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;let c;for(i=a.exec(e);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),r=e.substring(n.length).trim(),s=r.indexOf(" "),c=s>-1?r.substr(0,s):r,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLowerCase(),e=r.substring(s).trim(),"click"===n?t.event=this._processEventHandler(`${n}=${c}`):"color"===n?o.color=c:"width"===n&&(o.width=parseInt(c)),t.event&&"param"===n&&(t.event[n]=c.replace(/^"|"$/g,"")),i=a.exec(e)}t.outline=o}if(i=/^(on|u|b|i)(\s)*/.exec(e),i&&i[0].length>0){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}_processEventHandler(e){const t={};let i=0,n=!1,s=PW.exec(e);for(;s;){let o=s[0],r="";if(n=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))i=e.indexOf('"',1),i>-1&&(r=e.substring(1,i).trim(),n=!0),i++;else if("'"===e.charAt(0))i=e.indexOf("'",1),i>-1&&(r=e.substring(1,i).trim(),n=!0),i++;else{const t=/(\S)+/.exec(e);r=t?t[0]:"",i=r.length}n&&(o=o.substring(0,o.length-1).trim(),t[o]=r),e=e.substring(i).trim(),s=PW.exec(e)}return t}_addToStack(e){const t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;const e=this._stack[this._stack.length-1];for(const i in e)t[i]||(t[i]=e[i]);this._stack.push(t)}}_processResult(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}_escapeSpecialSymbol(e){for(const t of this._specialSymbolArray){const i=t[0],n=t[1];e=e.replace(i,n)}return e}}var MW,OW,DW,NW,LW,BW,zW,FW,UW,GW,kW;e("HtmlTextParser",IW);let HW=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((MW=Wc("cc.LabelOutline"),OW=al(),DW=Xc(110),NW=nl(),LW=qc(oj),BW=_l(),zW=_l(),MW(FW=OW(FW=DW(FW=NW(FW=LW(FW=il((GW=Oc((UW=class extends Gh{constructor(...e){super(...e),Mc(this,"_color",GW,this),Mc(this,"_width",kW,this)}get color(){return this._color}set color(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}get width(){return this._width}set width(e){this._width!==e&&(this._width=e,this._updateRenderData())}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const e=this.node.getComponent(oj);e&&e.updateRenderData(!0)}}).prototype,"_color",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(0,0,0,255)}}),kW=Oc(UW.prototype,"_width",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Oc(UW.prototype,"color",[BW],Object.getOwnPropertyDescriptor(UW.prototype,"color"),UW.prototype),Oc(UW.prototype,"width",[zW],Object.getOwnPropertyDescriptor(UW.prototype,"width"),UW.prototype),FW=UW))||FW)||FW)||FW)||FW)||FW)||FW));var VW,jW,WW,qW,XW,YW,KW,$W,QW,ZW,JW,eq,tq,iq,nq,sq,oq,rq,aq,cq,lq,hq,uq,_q,pq,dq,fq,mq,gq,vq,yq,xq,Sq,bq,Tq,Eq,Cq,wq,Aq,Pq,Rq,Iq,Mq;!function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(Pq||(Pq={})),Fe(Pq),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(Rq||(Rq={})),Fe(Rq),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(Iq||(Iq={})),Fe(Iq),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(Mq||(Mq={}));let Oq=function(t){return e({Sprite:t,SpriteComponent:t}),t}((VW=Wc("cc.Sprite"),jW=al(),WW=Xc(110),qW=nl(),XW=Al(ak),YW=vl(),KW=_l(),$W=Al(nk),QW=vl(),ZW=_l(),JW=Al(Pq),eq=vl(),tq=_l(),iq=Al(Rq),nq=_l(),sq=_l(),oq=pl(),rq=_l(),aq=pl(),cq=_l(),lq=vl(),hq=_l(),uq=Al(Iq),_q=vl(),pq=_l(),VW(dq=jW(dq=WW(dq=qW((Aq=wq=class e extends WH{constructor(...e){super(...e),Mc(this,"_spriteFrame",mq,this),Mc(this,"_type",gq,this),Mc(this,"_fillType",vq,this),Mc(this,"_sizeMode",yq,this),Mc(this,"_fillCenter",xq,this),Mc(this,"_fillStart",Sq,this),Mc(this,"_fillRange",bq,this),Mc(this,"_isTrimmedMode",Tq,this),Mc(this,"_useGrayscale",Eq,this),Mc(this,"_atlas",Cq,this)}get spriteAtlas(){return this._atlas}set spriteAtlas(e){this._atlas!==e&&(this._atlas=e)}get spriteFrame(){return this._spriteFrame}set spriteFrame(e){if(this._spriteFrame===e)return;const t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}get type(){return this._type}set type(e){this._type!==e&&(this._type=e,this._flushAssembler())}get fillType(){return this._fillType}set fillType(e){this._fillType!==e&&(e===Rq.RADIAL||this._fillType===Rq.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}get fillCenter(){return this._fillCenter}set fillCenter(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===Pq.FILLED&&this._renderData&&this.markForUpdateRenderData()}get fillStart(){return this._fillStart}set fillStart(e){this._fillStart=di(e,-1,1),this._type===Pq.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get fillRange(){return this._fillRange}set fillRange(e){this._fillRange=di(e,-1,1),this._type===Pq.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get trim(){return this._isTrimmedMode}set trim(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===Pq.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}get grayscale(){return this._useGrayscale}set grayscale(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?jH.GRAYSCALE:jH.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}get sizeMode(){return this._sizeMode}set sizeMode(e){this._sizeMode!==e&&(this._sizeMode=e,e!==Iq.CUSTOM&&this._applySpriteSize())}__preload(){this.changeMaterialForDefine(),super.__preload()}onEnable(){super.onEnable(),this._activateMaterial(),this._markForUpdateUvDirty()}onDestroy(){this.destroyRenderData(),super.onDestroy()}changeSpriteFrameFromAtlas(e){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}changeMaterialForDefine(){let e;const t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);let i=!1;if(e instanceof um){const t=e.getPixelFormat();i=t===Lf.RGBA_ETC1||t===Lf.RGB_A_PVRTC_4BPPV1||t===Lf.RGB_A_PVRTC_2BPPV1}i&&this.grayscale?this._instanceMaterialType=jH.USE_ALPHA_SEPARATED_AND_GRAY:i?this._instanceMaterialType=jH.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=jH.GRAYSCALE:this._instanceMaterialType=jH.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let e=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof JS){const t={SAMPLE_FROM_RT:!0,...e.passes[0].defines},i=new Wg;i.initialize({effectAsset:e.effectAsset,defines:t}),e=i}return e}_render(e){e.commitComp(this,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const e=this._spriteFrame;return!(!e||!e.texture)}_flushAssembler(){const t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(Iq.RAW===this._sizeMode){const e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(Iq.TRIMMED===this._sizeMode){const e=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this._activateMaterial()}}_resized(){}_activateMaterial(){const e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)}_applySpriteFrame(e){const t=this._spriteFrame;this._renderData&&(this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty);let i=!1;t&&(e&&e.texture===t.texture||(i=!0),i&&this.changeMaterialForDefine(),this._applySpriteSize())}_markForUpdateUvDirty(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},wq.FillType=Rq,wq.Type=Pq,wq.SizeMode=Iq,wq.EventType=Mq,Oc((fq=Aq).prototype,"spriteAtlas",[XW,YW,KW],Object.getOwnPropertyDescriptor(fq.prototype,"spriteAtlas"),fq.prototype),Oc(fq.prototype,"spriteFrame",[$W,QW,ZW],Object.getOwnPropertyDescriptor(fq.prototype,"spriteFrame"),fq.prototype),Oc(fq.prototype,"type",[JW,eq,tq],Object.getOwnPropertyDescriptor(fq.prototype,"type"),fq.prototype),Oc(fq.prototype,"fillType",[iq,nq],Object.getOwnPropertyDescriptor(fq.prototype,"fillType"),fq.prototype),Oc(fq.prototype,"fillCenter",[sq],Object.getOwnPropertyDescriptor(fq.prototype,"fillCenter"),fq.prototype),Oc(fq.prototype,"fillStart",[oq,rq],Object.getOwnPropertyDescriptor(fq.prototype,"fillStart"),fq.prototype),Oc(fq.prototype,"fillRange",[aq,cq],Object.getOwnPropertyDescriptor(fq.prototype,"fillRange"),fq.prototype),Oc(fq.prototype,"trim",[lq,hq],Object.getOwnPropertyDescriptor(fq.prototype,"trim"),fq.prototype),Oc(fq.prototype,"grayscale",[cl],Object.getOwnPropertyDescriptor(fq.prototype,"grayscale"),fq.prototype),Oc(fq.prototype,"sizeMode",[uq,_q,pq],Object.getOwnPropertyDescriptor(fq.prototype,"sizeMode"),fq.prototype),mq=Oc(fq.prototype,"_spriteFrame",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gq=Oc(fq.prototype,"_type",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pq.SIMPLE}}),vq=Oc(fq.prototype,"_fillType",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rq.HORIZONTAL}}),yq=Oc(fq.prototype,"_sizeMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Iq.TRIMMED}}),xq=Oc(fq.prototype,"_fillCenter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(0,0)}}),Sq=Oc(fq.prototype,"_fillStart",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bq=Oc(fq.prototype,"_fillRange",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tq=Oc(fq.prototype,"_isTrimmedMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Eq=Oc(fq.prototype,"_useGrayscale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cq=Oc(fq.prototype,"_atlas",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dq=fq))||dq)||dq)||dq)||dq));var Dq;let Nq=e("RenderRoot2D",Wc("cc.RenderRoot2D")(Dq=Xc(100)(Dq=nl()(Dq=qc(EH)(Dq=Yc(Dq=il(Dq=class extends Gh{onEnable(){n.director.root.batcher2D.addScreen(this)}onDisable(){n.director.root.batcher2D.removeScreen(this)}onDestroy(){n.director.root.batcher2D.removeScreen(this)}})||Dq)||Dq)||Dq)||Dq)||Dq)||Dq);var Lq,Bq,zq,Fq,Uq,Gq,kq,Hq,Vq,jq,Wq,qq;const Xq=new zi,Yq=Le({OVERLAY:0,INTERSPERSE:1});let Kq=function(t){return e({Canvas:t,CanvasComponent:t}),t}((Lq=Wc("cc.Canvas"),Bq=al(),zq=Xc(100),Fq=nl(),Uq=Al(jR),Gq=_l(),kq=_l(),Hq=Al(jR),Lq(Vq=Bq(Vq=zq(Vq=Fq(Vq=il(Vq=Yc((Oc((jq=class extends Nq{get renderMode(){return this._renderMode}set renderMode(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}get cameraComponent(){return this._cameraComponent}set cameraComponent(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}get alignCanvasWithScreen(){return this._alignCanvasWithScreen}set alignCanvasWithScreen(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}constructor(){super(),Mc(this,"_cameraComponent",Wq,this),Mc(this,"_alignCanvasWithScreen",qq,this),this._thisOnCameraResized=void 0,this._fitDesignResolution=void 0,this._pos=new zi,this._renderMode=Yq.OVERLAY,this._thisOnCameraResized=this._onResizeCamera.bind(this)}__preload(){const e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(jR.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(cy.TRANSFORM_CHANGED,this._thisOnCameraResized)}onEnable(){super.onEnable(),this._cameraComponent&&this._cameraComponent.node.on(jR.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}onDisable(){super.onDisable(),this._cameraComponent&&this._cameraComponent.node.off(jR.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}onDestroy(){super.onDestroy(),this.node.off(cy.TRANSFORM_CHANGED,this._thisOnCameraResized)}_onResizeCamera(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture){const e=this._cameraComponent.targetTexture.window;this._cameraComponent.camera&&this._cameraComponent.camera.setFixedSize(e.width,e.height),this._cameraComponent.orthoHeight=Mw.height/2}else if(Iw.canvas){const e=Iw.canvas;this._cameraComponent.camera&&this._cameraComponent.camera.resize(e.width,e.height),this._cameraComponent.orthoHeight=Iw.canvas.height/Fw.getScaleY()/2}this.node.getWorldPosition(Xq),this._cameraComponent.node.setWorldPosition(Xq.x,Xq.y,1e3)}}_getViewPriority(){if(this._cameraComponent){var e;let t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return t=this._renderMode===Yq.OVERLAY?t|1<<30:t&~(1<<30),t}return 0}}).prototype,"cameraComponent",[Uq,Gq],Object.getOwnPropertyDescriptor(jq.prototype,"cameraComponent"),jq.prototype),Oc(jq.prototype,"alignCanvasWithScreen",[kq],Object.getOwnPropertyDescriptor(jq.prototype,"alignCanvasWithScreen"),jq.prototype),Wq=Oc(jq.prototype,"_cameraComponent",[Hq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qq=Oc(jq.prototype,"_alignCanvasWithScreen",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Vq=jq))||Vq)||Vq)||Vq)||Vq)||Vq)||Vq));var $q;n.Canvas=Kq;let Qq=e("UIComponent",Wc("cc.UIComponent")($q=qc(EH)($q=Xc(110)($q=Yc($q=il($q=class extends Gh{constructor(...e){super(...e),this._lastParent=null,this.stencilStage=TH.DISABLED}__preload(){this.node._uiProps.uiComp=this}onEnable(){}onDisable(){}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}updateAssembler(e){}postUpdateAssembler(e){}markForUpdateRenderData(e=!0){}})||$q)||$q)||$q)||$q)||$q);var Zq,Jq,eX,tX,iX,nX,sX,oX,rX,aX,cX,lX,hX,uX,_X,pX,dX,fX,mX,gX,vX,yX,xX,SX,bX,TX,EX,CX,wX,AX,PX,RX,IX,MX,OX;ti(Qq.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),ei(Kq.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter(){return this._cameraComponent?this._cameraComponent.clearColor:Di.BLACK},customSetter(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),ii(WH.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),ii(EH.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),n.UITransformComponent=EH,De.setClassAlias(EH,"cc.UITransformComponent"),De.setClassAlias(WH,"cc.RenderComponent"),n.CanvasComponent=Kq,De.setClassAlias(Kq,"cc.CanvasComponent");const DX=new IW,NX="RICHTEXT_CHILD",LX="RICHTEXT_Image_CHILD",BX=new Me((e=>{if(!n.isValid(e.node))return!1;{const t=e.node.getComponent(HW);t&&(t.width=0)}return!0}),20),zX=new Me((e=>n.isValid(e.node)),10);function FX(e){return{node:new ix(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function UX(e,t){let i;e===NX?i=BX._get():e===LX&&(i=zX._get()),i=i||FX(e);let n=i.node;return n||(n=new ix(e)),n.hideFlags|=Ot.Flags.DontSave|Ot.Flags.HideInHierarchy,e===LX?(i.comp=n.getComponent(Oq)||n.addComponent(Oq),i.comp.spriteFrame=t,i.comp.type=Oq.Type.SLICED,i.comp.sizeMode=Oq.SizeMode.CUSTOM):(i.comp=n.getComponent(oj)||n.addComponent(oj),i.comp.string=t,i.comp.horizontalAlign=ZV.LEFT,i.comp.verticalAlign=JV.TOP),n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5),i.node=n,i.lineCount=0,i.styleIndex=0,i.imageOffset="",i.clickParam="",i.clickHandler="",i}let GX=function(t){return e({RichText:t,RichTextComponent:t}),t}((Zq=Wc("cc.RichText"),Jq=al(),eX=Xc(110),tX=nl(),iX=_l(),nX=Al(ZV),sX=_l(),oX=_l(),rX=_l(),aX=Al(lk),cX=_l(),lX=_l(),hX=Al(tj),uX=_l(),_X=_l(),pX=_l(),dX=Al(ak),fX=_l(),mX=_l(),Zq(gX=Jq(gX=eX(gX=tX(gX=il((OX=MX=class extends Qq{get string(){return this._string}set string(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}get font(){return this._font}set font(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}get cacheMode(){return this._cacheMode}set cacheMode(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}get lineHeight(){return this._lineHeight}set lineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}get imageAtlas(){return this._imageAtlas}set imageAtlas(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}get handleTouchEvent(){return this._handleTouchEvent}set handleTouchEvent(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}constructor(){super(),Mc(this,"_lineHeight",yX,this),Mc(this,"_string",xX,this),Mc(this,"_horizontalAlign",SX,this),Mc(this,"_fontSize",bX,this),Mc(this,"_maxWidth",TX,this),Mc(this,"_fontFamily",EX,this),Mc(this,"_font",CX,this),Mc(this,"_isSystemFontUsed",wX,this),Mc(this,"_userDefinedFont",AX,this),Mc(this,"_cacheMode",PX,this),Mc(this,"_imageAtlas",RX,this),Mc(this,"_handleTouchEvent",IX,this),this._textArray=[],this._segments=[],this._labelSegmentsCache=[],this._linesWidth=[],this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0,this._lineOffsetX=0,this._updateRichTextStatus=void 0,this._updateRichTextStatus=this._updateRichText}onLoad(){this.node.on(cy.LAYER_CHANGED,this._applyLayer,this)}onEnable(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}onDisable(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}start(){this._onTTFLoaded(),this.node.on(cy.ANCHOR_CHANGED,this._updateRichTextPosition,this)}onRestore(){}onDestroy(){for(const e of this._segments)e.node.removeFromParent(),e.type===NX?BX.put(e):e.type===LX&&zX.put(e);this.node.off(cy.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(cy.LAYER_CHANGED,this._applyLayer,this)}_addEventListeners(){this.node.on(cy.TOUCH_END,this._onTouchEnded,this)}_removeEventListeners(){this.node.off(cy.TOUCH_END,this._onTouchEnded,this)}_updateLabelSegmentTextAttributes(){this._segments.forEach((e=>{this._applyTextAttribute(e)}))}_createFontLabel(e){return UX(NX,e)}_createImage(e){return UX(LX,e)}_onTTFLoaded(){this._font,this._layoutDirty=!0,this._updateRichText()}_measureText(e,t){const i=t=>{let i;return 0===this._labelSegmentsCache.length?(i=this._createFontLabel(t),this._labelSegmentsCache.push(i)):(i=this._labelSegmentsCache[0],i.node.getComponent(oj).string=t),i.styleIndex=e,this._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return t?i(t):i}_onTouchEnded(e){const t=this.node.getComponents(Gh);for(const i of this._segments){const n=i.clickHandler,s=i.clickParam;n&&this._containsTouchLocation(i,e.touch.getUILocation())&&(t.forEach((t=>{const i=t[n];t.enabledInHierarchy&&i&&i.call(t,e,s)})),e.propagationStopped=!0)}}_containsTouchLocation(e,t){const i=e.node.getComponent(EH);return!!i&&i.getBoundingBoxToWorld().contains(t)}_resetState(){const e=this.node.children;for(let t=e.length-1;t>=0;t--){const i=e[t];if(i.name===NX||i.name===LX){i.parent===this.node?i.parent=null:e.splice(t,1);const n=FX(i.name);n.node=i,i.name===NX?(n.comp=i.getComponent(oj),BX.put(n)):(n.comp=i.getComponent(Oq),zX.put(n))}}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}_activateChildren(e){for(let t=this.node.children.length-1;t>=0;t--){const i=this.node.children[t];i.name!==NX&&i.name!==LX||(i.active=e)}}_addLabelSegment(e,t){let i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{i=this._labelSegmentsCache.pop();const t=i.node.getComponent(oj);t&&(t.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),i.node.layer=this.node.layer,this._applyTextAttribute(i),this.node.addChild(i.node),this._segments.push(i),i}_updateRichTextWithMaxWidth(e,t,i){let n,s=t;if(this._lineOffsetX>0&&s+this._lineOffsetX>this._maxWidth){let t=0;for(;this._lineOffsetX<=this._maxWidth;){const n=this._getFirstWordLen(e,t,e.length),o=e.substr(t,n),r=this._measureText(i,o);if(!(this._lineOffsetX+r<=this._maxWidth)){if(t>0){const n=e.substr(0,t);this._addLabelSegment(n,i),e=e.substr(t,e.length),s=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=r,t+=n}}if(s>this._maxWidth){const t=Gk(e,s,this._maxWidth,this._measureText(i));for(let e=0;e<t.length;++e){const s=t[e];n=this._addLabelSegment(s,i);const o=n.node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=o.width,t.length>1&&e<t.length-1&&this._updateLineInfo()}}else this._lineOffsetX+=s,this._addLabelSegment(e,i)}_isLastComponentCR(e){return e.length-1===e.lastIndexOf("\n")}_updateLineInfo(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}_needsUpdateTextLayout(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(let t=0;t<this._textArray.length;t++){const i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;{const e=i.style,t=n.style;if(e){if(t){if(!!t.outline!=!!e.outline)return!0;if(e.size!==t.size||e.italic!==t.italic||e.isImage!==t.isImage)return!0;if(e.src!==t.src||e.imageAlign!==t.imageAlign||e.imageHeight!==t.imageHeight||e.imageWidth!==t.imageWidth||e.imageOffset!==t.imageOffset)return!0}else if(e.size||e.italic||e.isImage||e.outline)return!0}else if(t&&(t.size||t.italic||t.isImage||t.outline))return!0}}return!1}_addRichTextImageElement(e){if(!e.style)return;const t=e.style,i=t.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){const e=this._createImage(n);switch(e.comp,t.imageAlign){case"top":e.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":e.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:e.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.node.layer=this.node.layer,this.node.addChild(e.node),this._segments.push(e);const i=n.rect.clone();let s=1,o=i.width,r=i.height;const a=t.imageWidth||0,c=t.imageHeight||0;c>0?(s=c/r,o*=s,r*=s):(s=this._lineHeight/r,o*=s,r*=s),a>0&&(o=a),this._maxWidth>0?(this._lineOffsetX+o>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=o):(this._lineOffsetX+=o,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),e.node._uiProps.uiTransformComp.setContentSize(o,r),e.lineCount=this._lineCount,e.clickHandler="",e.clickParam="";const l=t.event;l&&(e.clickHandler=l.click,e.clickParam=l.param)}else T(4400)}_updateRichText(){if(!this.enabledInHierarchy)return;const e=DX.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();let t,i=!1;for(let e=0;e<this._textArray.length;++e){const n=this._textArray[e],s=n.text;if(void 0===s)continue;if(""===s){if(n.style&&n.style.isNewLine){this._updateLineInfo();continue}if(n.style&&n.style.isImage&&this._imageAtlas){this._addRichTextImageElement(n);continue}}const o=s.split("\n");for(let n=0;n<o.length;++n){const r=o[n];if(""!==r)if(i=!1,this._maxWidth>0){const t=this._measureText(e,r);this._updateRichTextWithMaxWidth(r,t,e),o.length>1&&n<o.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(r,e),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),o.length>1&&n<o.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&n===o.length-1)continue;this._updateLineInfo(),i=!0}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+Ak)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}_getFirstWordLen(e,t,i){let n=e.charAt(t);if(Bk(n)||zk(n))return 1;let s=1;for(let o=t+1;o<i&&(n=e.charAt(o),!zk(n)&&!Bk(n));++o)s++;return s}_updateRichTextPosition(){let e=0,t=1;const i=this._lineCount,n=this.node._uiProps.uiTransformComp,s=n.anchorX,o=n.anchorY;for(let n=0;n<this._segments.length;++n){const r=this._segments[n],a=r.lineCount;a>t&&(e=0,t=a);let c=this._labelWidth*(.5*this._horizontalAlign-s);switch(this._horizontalAlign){case ZV.LEFT:break;case ZV.CENTER:c-=this._linesWidth[a-1]/2;break;case ZV.RIGHT:c-=this._linesWidth[a-1]}const l=r.node.position;if(r.node.setPosition(e+c,this._lineHeight*(i-a)-this._labelHeight*o,l.z),a===t&&(e+=r.node._uiProps.uiTransformComp.width),r.node.getComponent(Oq)){const e=r.node.position.clone(),t=this._lineHeight,i=this._lineHeight*(1+Ak);switch(r.node._uiProps.uiTransformComp.anchorY){case 1:e.y+=t+(i-t)/2;break;case.5:e.y+=i/2;break;default:e.y+=(i-t)/2}if(r.imageOffset){const t=r.imageOffset.split(",");if(1===t.length&&t[0]){const i=parseFloat(t[0]);Number.isInteger(i)&&(e.y+=i)}else if(2===t.length){const i=parseFloat(t[0]),n=parseFloat(t[1]);Number.isInteger(i)&&(e.x+=i),Number.isInteger(n)&&(e.y+=n)}}r.node.position=e}const h=r.node.getComponent(HW);if(h){const e=r.node.position.clone();e.y-=h.width,r.node.position=e}}}_convertLiteralColorValue(e){const t=e.toUpperCase();return Di[t]?Di[t]:(new Di).fromHEX(e)}_applyTextAttribute(e){const t=e.node.getComponent(oj);if(!t)return;this._resetLabelState(t);const i=e.styleIndex;let n;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){let t=e.node.getComponent(HW);t||(t=e.node.addComponent(HW)),t.color=this._convertLiteralColorValue(n.outline.color),t.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";const i=n.event;i&&(e.clickHandler=i.click||"",e.clickParam=i.param||"")}t.cacheMode=this._cacheMode,this._font instanceof lk&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);const s=t._assembler;s&&s.updateRenderData(t)}_applyLayer(){for(const e of this._segments)e.node.layer=this.node.layer}_resetLabelState(e){e.fontSize=this._fontSize,e.color=Di.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1}},MX.HorizontalAlign=ZV,MX.VerticalAlign=JV,Oc((vX=OX).prototype,"string",[Sl,iX],Object.getOwnPropertyDescriptor(vX.prototype,"string"),vX.prototype),Oc(vX.prototype,"horizontalAlign",[nX,sX],Object.getOwnPropertyDescriptor(vX.prototype,"horizontalAlign"),vX.prototype),Oc(vX.prototype,"fontSize",[oX],Object.getOwnPropertyDescriptor(vX.prototype,"fontSize"),vX.prototype),Oc(vX.prototype,"fontFamily",[rX],Object.getOwnPropertyDescriptor(vX.prototype,"fontFamily"),vX.prototype),Oc(vX.prototype,"font",[aX,cX],Object.getOwnPropertyDescriptor(vX.prototype,"font"),vX.prototype),Oc(vX.prototype,"useSystemFont",[lX],Object.getOwnPropertyDescriptor(vX.prototype,"useSystemFont"),vX.prototype),Oc(vX.prototype,"cacheMode",[hX,uX],Object.getOwnPropertyDescriptor(vX.prototype,"cacheMode"),vX.prototype),Oc(vX.prototype,"maxWidth",[_X],Object.getOwnPropertyDescriptor(vX.prototype,"maxWidth"),vX.prototype),Oc(vX.prototype,"lineHeight",[pX],Object.getOwnPropertyDescriptor(vX.prototype,"lineHeight"),vX.prototype),Oc(vX.prototype,"imageAtlas",[dX,fX],Object.getOwnPropertyDescriptor(vX.prototype,"imageAtlas"),vX.prototype),Oc(vX.prototype,"handleTouchEvent",[mX],Object.getOwnPropertyDescriptor(vX.prototype,"handleTouchEvent"),vX.prototype),yX=Oc(vX.prototype,"_lineHeight",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),xX=Oc(vX.prototype,"_string",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),SX=Oc(vX.prototype,"_horizontalAlign",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZV.LEFT}}),bX=Oc(vX.prototype,"_fontSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),TX=Oc(vX.prototype,"_maxWidth",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EX=Oc(vX.prototype,"_fontFamily",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),CX=Oc(vX.prototype,"_font",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wX=Oc(vX.prototype,"_isSystemFontUsed",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),AX=Oc(vX.prototype,"_userDefinedFont",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PX=Oc(vX.prototype,"_cacheMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tj.NONE}}),RX=Oc(vX.prototype,"_imageAtlas",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IX=Oc(vX.prototype,"_handleTouchEvent",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gX=vX))||gX)||gX)||gX)||gX)||gX));var kX;let HX=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(Wc("cc.UIMeshRenderer")(kX=al()(kX=Xc(110)(kX=nl()(kX=class extends Qq{constructor(...e){super(...e),this._models=null,this._modelComponent=null}get modelComponent(){return this._modelComponent}onLoad(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn(`node '${this.node&&this.node.name}' doesn't have any renderable component`)}onEnable(){super.onEnable()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)}updateAssembler(e){if(this._models){this._modelComponent._detachFromScene();for(const t of this._models)e.commitModel.call(e,this,t,this._modelComponent.material);return!0}return!1}update(){this._fitUIRenderQueue()}_fitUIRenderQueue(){if(!this._modelComponent)return;const e=this._modelComponent.sharedMaterials.length;for(let t=0;t<e;t++){const e=this._modelComponent.getMaterialInstance(t);if(null==e)continue;const i=e.passes,n=i.length;for(let t=0;t<n;t++)i[t]._priority=sd.MAX-11,e.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},t)}}})||kX)||kX)||kX)||kX);class VX{get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(e){this.vData=null,this.iData=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._attributes=null,this._vertexBuffers=[],this._indexBuffer=null,this._iaInfo=null,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=e}get vertexFormatBytes(){return this._vertexFormatBytes}initialize(e,t){this._outOfCallback=t;const i=Tj(e);this._vertexFormatBytes=i*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;const n=Float32Array.BYTES_PER_ELEMENT*i;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,n,n)));const s=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new Io(Fs.INDEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,s,s))),this._attributes=e,this._iaInfo=new Ko(this.attributes,this.vertexBuffers,this.indexBuffer),this.vData&&this.iData||this._reallocBuffer()}request(e=4,t=6){this.lastByteOffset=this.byteOffset;const i=this.byteOffset+e*this._vertexFormatBytes,n=this.indicesOffset+t;if(e+this.vertexOffset>65535)return this._outOfCallback&&this._outOfCallback.call(this._batcher,e,t),!1;let s=this.vData.byteLength,o=this.iData.length;if(i>s||n>o){for(;s<i||o<n;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indicesOffset+=t,this.byteOffset=i,this._dirty=!0,!0}reset(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1}destroy(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(let e=0;e<this._hInputAssemblers.length;e++)this._hInputAssemblers[e].destroy();this._hInputAssemblers.length=0}recordBatch(){const e=this.indicesOffset-this.indicesStart;if(!e)return null;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(this._batcher.device.createInputAssembler(this._iaInfo));const t=this._hInputAssemblers[this._nextFreeIAHandle++];return t.firstIndex=this.indicesStart,t.indexCount=e,t}uploadBuffers(){if(0===this.byteOffset||!this._dirty)return;const e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(e),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(t),this._dirty=!1}_reallocBuffer(){this._reallocVData(!0),this._reallocIData(!0)}_reallocVData(e){let t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e){const e=new Uint8Array(this.vData.buffer);for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}}_reallocIData(e){const t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e){const e=this.iData;for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}}}e("MeshBuffer",VX),VX.OPACITY_OFFSET=8;const jX=id.Enum.NONE|id.Enum.UI_3D;class WX{get native(){return this._nativeObj}get inputAssembler(){return this._inputAssember}set inputAssembler(e){this._inputAssember=e,this._nativeObj.inputAssembler=e}get descriptorSet(){return this._descriptorSet}set descriptorSet(e){this._descriptorSet=e,this._nativeObj.descriptorSet=e}get visFlags(){return this._visFlags}set visFlags(e){this._visFlags=e,this._nativeObj.visFlags=e}get passes(){return this._passes}get shaders(){return this._shaders}constructor(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=jX,this._inputAssember=null,this._descriptorSet=null,this._nativeObj=new Jn,this._nativeObj.visFlags=this._visFlags}destroy(e){this._passes=[],this._nativeObj=null}clear(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=jX,this.renderScene=null}fillPasses(e,t,i,s,o,r){if(e){const a=e.passes;if(!a)return;let c=0,l=!1;this._shaders.length=a.length;for(let e=0;e<a.length;e++){this._passes[e]||(this._passes[e]=new dg(n.director.root));const h=a[e],u=this._passes[e];h.update(),t||(t=h.depthStencilState,i=0),s||(s=h.blendState,o=0),-1===o&&(o=0),c=i<<16|o,u._initPassFromTarget(h,t,s,c),this._shaders[e]=u.getShaderVariant(r),l=!0}if(l){const e=[],t=this._passes;for(let i=0;i<t.length;i++)e.push(t[i].native);this._nativeObj.passes=e,this._nativeObj.shaders=this._shaders}}}}var qX,XX,YX,KX,$X,QX,ZX;e("UIDrawBatch",WX);let JX=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((qX=Wc("cc.UIStaticBatch"),XX=al(),YX=nl(),KX=Xc(110),$X=ll(),qX(QX=XX(QX=YX(QX=KX((Oc((ZX=class extends WH{constructor(...e){super(...e),this._init=!1,this._meshBuffer=null,this._dirty=!0,this._lastMeshBuffer=null,this._uiDrawBatchList=[]}get color(){return this._color}set color(e){this._color!==e&&this._color.set(e)}get drawBatchList(){return this._uiDrawBatchList}onLoad(){const e=this._getBatcher();if(!e)return;const t=Sj,i=new VX(e);i.initialize(t,this._arrivalMaxBuffer.bind(this)),this._meshBuffer=i}onDestroy(){super.onDestroy(),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}updateAssembler(e){e.currIsStatic=!0,this._dirty&&(e.finishMergeBatches(),this._lastMeshBuffer=e.currBufferBatch,e.currBufferBatch=this._meshBuffer,e.currStaticRoot=this),this._init&&(e.finishMergeBatches(),e.commitStaticBatch(this))}postUpdateAssembler(e){this._dirty&&(e.finishMergeBatches(),e.currBufferBatch=this._lastMeshBuffer,e.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadBuffers()),e.currIsStatic=!1}markAsDirty(){this._getBatcher()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}_requireDrawBatch(){const e=new WX;return e.isStatic=!0,this._uiDrawBatchList.push(e),e}_clearData(){if(this._meshBuffer){this._meshBuffer.reset();const e=this._getBatcher();for(let t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1}_getBatcher(){return Qw.root&&Qw.root.batcher2D?Qw.root.batcher2D:(T(9301),null)}_arrivalMaxBuffer(){const e=this._getBatcher();e&&e.autoMergeBatches(),T(9300)}}).prototype,"color",[Pl,$X],Object.getOwnPropertyDescriptor(ZX.prototype,"color"),ZX.prototype),QX=ZX))||QX)||QX)||QX)||QX));var eY,tY,iY,nY,sY,oY,rY,aY,cY,lY,hY,uY,_Y;let pY=e("LabelShadow",(eY=Wc("cc.LabelShadow"),tY=al(),iY=Xc(110),nY=nl(),sY=qc(oj),oY=_l(),rY=_l(),aY=_l(),eY(cY=tY(cY=iY(cY=nY(cY=sY(cY=il((hY=Oc((lY=class extends Gh{constructor(...e){super(...e),Mc(this,"_color",hY,this),Mc(this,"_offset",uY,this),Mc(this,"_blur",_Y,this)}get color(){return this._color}set color(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}get offset(){return this._offset}set offset(e){this._offset=e,this._updateRenderData()}get blur(){return this._blur}set blur(e){this._blur=e,this._updateRenderData()}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const e=this.node.getComponent(oj);e&&e.updateRenderData(!0)}}).prototype,"_color",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(0,0,0,255)}}),uY=Oc(lY.prototype,"_offset",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(2,2)}}),_Y=Oc(lY.prototype,"_blur",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Oc(lY.prototype,"color",[oY],Object.getOwnPropertyDescriptor(lY.prototype,"color"),lY.prototype),Oc(lY.prototype,"offset",[rY],Object.getOwnPropertyDescriptor(lY.prototype,"offset"),lY.prototype),Oc(lY.prototype,"blur",[aY],Object.getOwnPropertyDescriptor(lY.prototype,"blur"),lY.prototype),cY=lY))||cY)||cY)||cY)||cY)||cY)||cY));var dY,fY,mY;let gY=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}(Wc("cc.UIOpacity")(dY=al()(dY=Xc(110)(dY=nl()(dY=il((Oc((fY=class extends Gh{constructor(...e){super(...e),Mc(this,"_opacity",mY,this)}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(e=$e(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}onEnable(){this.node._uiProps.localOpacity=this._opacity/255}onDisable(){this.node._uiProps.localOpacity=1}}).prototype,"opacity",[cl],Object.getOwnPropertyDescriptor(fY.prototype,"opacity"),fY.prototype),mY=Oc(fY.prototype,"_opacity",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),dY=fY))||dY)||dY)||dY)||dY)||dY);n.MaskComponent=AW,De.setClassAlias(AW,"cc.MaskComponent"),n.LabelComponent=oj,De.setClassAlias(oj,"cc.LabelComponent"),n.LabelOutlineComponent=HW,De.setClassAlias(HW,"cc.LabelOutlineComponent"),n.RichTextComponent=GX,De.setClassAlias(GX,"cc.RichTextComponent"),n.SpriteComponent=Oq,De.setClassAlias(Oq,"cc.SpriteComponent"),n.UIModelComponent=HX,De.setClassAlias(HX,"cc.UIModelComponent"),n.GraphicsComponent=$j,De.setClassAlias($j,"cc.GraphicsComponent"),De.setClassAlias(JX,"cc.UIStaticBatchComponent"),De.setClassAlias(gY,"cc.UIOpacityComponent");class vY{constructor(e,t,i){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=i}}function yY(e,t,i,n,s){let o=0,r=null;if(s===function(e,t,i,n){let s=0;for(let o=t,r=i-n;o<i;o+=n)s+=(e[r]-e[o])*(e[o+1]+e[r+1]),r=o;return s}(e,t,i,n)>0)for(o=t;o<i;o+=n)r=zY(o,e[o],e[o+1],r);else for(o=i-n;o>=t;o-=n)r=zY(o,e[o],e[o+1],r);return r&&DY(r,r.next)&&(FY(r),r=r.next),r}function xY(e,t=null){if(!e)return e;t||(t=e);let i=e,n=!1;do{if(n=!1,i.steiner||!DY(i,i.next)&&0!==OY(i.prev,i,i.next))i=i.next;else{if(FY(i),i=t=i.prev,i===i.next)return null;n=!0}}while(n||i!==t);return t}function SY(e,t,i,n,s,o,r=0){if(!e)return;!r&&o&&function(e,t,i,n){let s=e;do{null===s.z&&(s.z=PY(s.x,s.y,t,i,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){let t=0,i=null,n=null,s=null,o=null,r=0,a=0,c=0,l=1;do{for(i=e,e=null,o=null,r=0;i;){for(r++,n=i,a=0,t=0;t<l&&(a++,n=n.nextZ,n);t++);for(c=l;a>0||c>0&&n;)0===a?(s=n,n=n.nextZ,c--):0!==c&&n?i.z<=n.z?(s=i,i=i.nextZ,a--):(s=n,n=n.nextZ,c--):(s=i,i=i.nextZ,a--),o?o.nextZ=s:e=s,s.prevZ=o,o=s;i=n}o.nextZ=null,l*=2}while(r>1)}(s)}(e,n,s,o);let a=e,c=null,l=null;for(;e.prev!==e.next;)if(c=e.prev,l=e.next,o?TY(e,n,s,o):bY(e))t.push(c.i/i),t.push(e.i/i),t.push(l.i/i),FY(e),e=l.next,a=l.next;else if((e=l)===a){r?1===r?SY(e=EY(e,t,i),t,i,n,s,o,2):2===r&&CY(e,t,i,n,s,o):SY(xY(e),t,i,n,s,o,1);break}}function bY(e){const t=e.prev,i=e,n=e.next;if(OY(t,i,n)>=0)return!1;let s=e.next.next;for(;s!==e.prev;){if(IY(t.x,t.y,i.x,i.y,n.x,n.y,s.x,s.y)&&OY(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function TY(e,t,i,n){const s=e.prev,o=e,r=e.next;if(OY(s,o,r)>=0)return!1;const a=s.x<o.x?s.x<r.x?s.x:r.x:o.x<r.x?o.x:r.x,c=s.y<o.y?s.y<r.y?s.y:r.y:o.y<r.y?o.y:r.y,l=s.x>o.x?s.x>r.x?s.x:r.x:o.x>r.x?o.x:r.x,h=s.y>o.y?s.y>r.y?s.y:r.y:o.y>r.y?o.y:r.y,u=PY(a,c,t,i,n),_=PY(l,h,t,i,n);let p=e.nextZ;for(;p&&p.z<=_;){if(p!==e.prev&&p!==e.next&&IY(s.x,s.y,o.x,o.y,r.x,r.y,p.x,p.y)&&OY(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(p=e.prevZ;p&&p.z>=u;){if(p!==e.prev&&p!==e.next&&IY(s.x,s.y,o.x,o.y,r.x,r.y,p.x,p.y)&&OY(p.prev,p,p.next)>=0)return!1;p=p.prevZ}return!0}function EY(e,t,i){let n=e;do{const s=n.prev,o=n.next.next;!DY(s,o)&&NY(s,n,n.next,o)&&LY(s,o)&&LY(o,s)&&(t.push(s.i/i),t.push(n.i/i),t.push(o.i/i),FY(n),FY(n.next),n=e=o),n=n.next}while(n!==e);return n}function CY(e,t,i,n,s,o){let r=e;do{let e=r.next.next;for(;e!==r.prev;){if(r.i!==e.i&&MY(r,e)){let a=BY(r,e);return r=xY(r,r.next),a=xY(a,a.next),SY(r,t,i,n,s,o),void SY(a,t,i,n,s,o)}e=e.next}r=r.next}while(r!==e)}function wY(e,t){return e.x-t.x}function AY(e,t){if(t=function(e,t){let i=t;const n=e.x,s=e.y;let o=-1/0,r=null;do{if(s<=i.y&&s>=i.next.y){const e=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=n&&e>o){if(o=e,e===n){if(s===i.y)return i;if(s===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(n===o)return r.prev;const a=r,c=r.x,l=r.y;let h,u=1/0;for(i=r.next;i!==a;)n>=i.x&&i.x>=c&&IY(s<l?n:o,s,c,l,s<l?o:n,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(n-i.x),(h<u||h===u&&i.x>r.x)&&LY(i,e)&&(r=i,u=h)),i=i.next;return r}(e,t)){const i=BY(t,e);xY(i,i.next)}}function PY(e,t,i,n,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function RY(e){let t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function IY(e,t,i,n,s,o,r,a){return(s-r)*(t-a)-(e-r)*(o-a)>=0&&(e-r)*(n-a)-(i-r)*(t-a)>=0&&(i-r)*(o-a)-(s-r)*(n-a)>=0}function MY(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&NY(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&LY(e,t)&&LY(t,e)&&function(e,t){let i=e,n=!1;const s=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&s<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)}function OY(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function DY(e,t){return e.x===t.x&&e.y===t.y}function NY(e,t,i,n){return!!(DY(e,t)&&DY(i,n)||DY(e,n)&&DY(i,t))||OY(e,t,i)>0!=OY(e,t,n)>0&&OY(i,n,e)>0!=OY(i,n,t)>0}function LY(e,t){return OY(e.prev,e,e.next)<0?OY(e,t,e.next)>=0&&OY(e,e.prev,t)>=0:OY(e,t,e.prev)<0||OY(e,e.next,t)<0}function BY(e,t){const i=new vY(e.i,e.x,e.y),n=new vY(t.i,t.x,t.y),s=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function zY(e,t,i,n){const s=new vY(e,t,i);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function FY(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function UY(e,t,i){i=i||3;const n=t?t.length:0,s=n?t[0]*i:e.length;let o=yY(e,0,s,i,!0);const r=[];if(!o)return r;let a=0,c=0,l=0,h=0,u=0,_=0,p=0;if(n&&(o=function(e,t,i,n){const s=[];let o=0,r=0,a=0,c=0,l=null;for(o=0,r=t.length;o<r;o++)a=t[o]*n,c=o<r-1?t[o+1]*n:e.length,l=yY(e,a,c,n,!1),l&&(l===l.next&&(l.steiner=!0),s.push(RY(l)));if(s.sort(wY),!i)return i;for(o=0;o<s.length;o++)AY(s[o],i),i=xY(i,i.next);return i}(e,t,o,i)),e.length>80*i){a=l=e[0],c=h=e[1];for(let t=i;t<s;t+=i)u=e[t],_=e[t+1],u<a&&(a=u),_<c&&(c=_),u>l&&(l=u),_>h&&(h=_);p=Math.max(l-a,h-c)}return SY(o,r,i,a,c,p),r}const GY=Math.PI,kY=Math.min,HY=Math.max,VY=Math.ceil,jY=Math.acos,WY=Math.cos,qY=Math.sin,XY=Math.atan2;let YY=null,KY=null;const $Y=new Di,QY=[];for(let e=0;e<4;e++)QY.push(new zi);function ZY(e,t,i){return e<t?t:e>i?i:e}const JY={useModel:!0,updateRenderData(e){},fillBuffers(e,t){},renderIA(e,t){},getRenderData(e,t){if(!KY)return null;const i=KY.getRenderDataList();let n=i[KY.dataOffset];if(!n)return null;let s=n;const o=s?s.vertexStart+t:0;return(o>65535||3*o>131070)&&(++KY.dataOffset,KY.dataOffset<i.length?n=i[KY.dataOffset]:(n=KY.requestRenderData(),i[KY.dataOffset]=n),s=n),s&&s.vertexCount<o&&s.request(t,3*t),n},stroke(e){Di.copy($Y,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill(e){Di.copy($Y,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end(e){e.markForUpdateRenderData()},_expandStroke(e){const t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,s=e.miterLimit;if(KY=e.impl,!KY)return;const o=function(e,t,i){const n=2*jY(e/(e+i));return HY(2,VY(t/n))}(t,GY,KY.tessTol);this._calculateJoins(KY,t,n,s);const r=KY.paths;let a=0;for(let e=KY.pathOffset,t=KY.pathLength;e<t;e++){const t=r[e],s=t.points.length;n===nj.ROUND?a+=2*(s+t.bevel*(o+2)+1):a+=2*(s+5*t.bevel+1),t.closed||(i===ij.ROUND?a+=2*(2*o+2):a+=12)}const c=YY=this.getRenderData(e,a);if(!c)return;const l=c.vData,h=c.iData;for(let e=KY.pathOffset,s=KY.pathLength;e<s;e++){const s=r[e],a=s.points,u=a.length,_=c.vertexStart;let p,d,f=0,m=0;const g=s.closed;if(g?(p=a[u-1],d=a[0],f=0,m=u):(p=a[0],d=a[1],f=1,m=u-1),d=d||p,!g){const e=new mj(d.x,d.y);e.subtract(p),e.normalize();const n=e.x,s=e.y;i===ij.BUTT?this._buttCapStart(p,n,s,t,0):i===ij.SQUARE?this._buttCapStart(p,n,s,t,t):i===ij.ROUND&&this._roundCapStart(p,n,s,t,o)}for(let e=f;e<m;++e)n===nj.ROUND?this._roundJoin(p,d,t,t,o):0!=(d.flags&(sj.PT_BEVEL|sj.PT_INNERBEVEL))?this._bevelJoin(p,d,t,t):(this._vSet(d.x+d.dmx*t,d.y+d.dmy*t,1),this._vSet(d.x-d.dmx*t,d.y-d.dmy*t,-1)),p=d,d=a[e+1];if(g){const e=8*_;this._vSet(l[e],l[e+1],1),this._vSet(l[e+8],l[e+8+1],-1)}else{const e=new mj(d.x,d.y);e.subtract(p),e.normalize();const n=e.x,s=e.y;i===ij.BUTT?this._buttCapEnd(d,n,s,t,0):i===ij.SQUARE?this._buttCapEnd(d,n,s,t,t):i===ij.ROUND&&this._roundCapEnd(d,n,s,t,o)}let v=c.indicesStart;for(let e=_+2,t=c.vertexStart;e<t;e++)h[v++]=e-2,h[v++]=e-1,h[v++]=e;c.indicesStart=v}YY=null,KY=null},_expandFill(e){if(KY=e.impl,!KY)return;const t=KY.paths;let i=0;for(let e=KY.pathOffset,n=KY.pathLength;e<n;e++)i+=t[e].points.length;const n=YY=this.getRenderData(e,i);if(!n)return;const s=n,o=s.vData,r=s.iData;for(let e=KY.pathOffset,i=KY.pathLength;e<i;e++){const i=t[e],a=i.points,c=a.length;if(0===c)continue;const l=n.vertexStart;for(let e=0;e<c;++e)this._vSet(a[e].x,a[e].y);let h=n.indicesStart;if(i.complex){const e=[];for(let t=l,i=n.vertexStart;t<i;t++){let i=8*t;e.push(o[i++]),e.push(o[i++]),e.push(o[i++])}const t=UY(e,null,3);if(!t||0===t.length)continue;for(let e=0,i=t.length;e<i;e++)r[h++]=t[e]+l}else{const e=l;for(let t=l+2,i=s.vertexStart;t<i;t++)r[h++]=e,r[h++]=t-1,r[h++]=t}s.indicesStart=h}YY=null,KY=null},_calculateJoins(e,t,i,n){let s=0;t>0&&(s=1/t);const o=e.paths;for(let t=e.pathOffset,r=e.pathLength;t<r;t++){const e=o[t],r=e.points,a=r.length;let c=r[a-1],l=r[0];e.bevel=0;for(let t=0;t<a;t++){let o=0,a=0,h=0;const u=c.dy,_=-c.dx,p=l.dy,d=-l.dx;if(l.dmx=.5*(u+p),l.dmy=.5*(_+d),o=l.dmx*l.dmx+l.dmy*l.dmy,o>1e-6){let e=1/o;e>600&&(e=600),l.dmx*=e,l.dmy*=e}a=l.dx*c.dy-c.dx*l.dy,a>0&&(l.flags|=sj.PT_LEFT),h=HY(11,kY(c.len,l.len)*s),o*h*h<1&&(l.flags|=sj.PT_INNERBEVEL),l.flags&sj.PT_CORNER&&(o*n*n<1||i===nj.BEVEL||i===nj.ROUND)&&(l.flags|=sj.PT_BEVEL),0!=(l.flags&(sj.PT_BEVEL|sj.PT_INNERBEVEL))&&e.bevel++,c=l,l=r[t+1]}}},_flattenPaths(e){const t=e.paths;for(let i=e.pathOffset,n=e.pathLength;i<n;i++){const e=t[i],n=e.points;let s=n[n.length-1],o=n[0];n.length>2&&s.equals(o)&&(e.closed=!0,n.pop(),s=n[n.length-1]);for(let e=0,t=n.length;e<t;e++){const t=new mj(o.x,o.y);t.subtract(s),s.len=t.length(),(t.x||t.y)&&t.normalize(),s.dx=t.x,s.dy=t.y,s=o,o=n[e+1]}}},_chooseBevel(e,t,i,n){const s=i.x,o=i.y;let r=0,a=0,c=0,l=0;return 0!==e?(r=s+t.dy*n,a=o-t.dx*n,c=s+i.dy*n,l=o-i.dx*n):(r=c=s+i.dmx*n,a=l=o+i.dmy*n),[r,a,c,l]},_buttCapStart(e,t,i,n,s){const o=e.x-t*s,r=e.y-i*s,a=i,c=-t;this._vSet(o+a*n,r+c*n,1),this._vSet(o-a*n,r-c*n,-1)},_buttCapEnd(e,t,i,n,s){const o=e.x+t*s,r=e.y+i*s,a=i,c=-t;this._vSet(o+a*n,r+c*n,1),this._vSet(o-a*n,r-c*n,-1)},_roundCapStart(e,t,i,n,s){const o=e.x,r=e.y,a=i,c=-t;for(let e=0;e<s;e++){const l=e/(s-1)*GY,h=WY(l)*n,u=qY(l)*n;this._vSet(o-a*h-t*u,r-c*h-i*u,1),this._vSet(o,r,0)}this._vSet(o+a*n,r+c*n,1),this._vSet(o-a*n,r-c*n,-1)},_roundCapEnd(e,t,i,n,s){const o=e.x,r=e.y,a=i,c=-t;this._vSet(o+a*n,r+c*n,1),this._vSet(o-a*n,r-c*n,-1);for(let e=0;e<s;e++){const l=e/(s-1)*GY,h=WY(l)*n,u=qY(l)*n;this._vSet(o,r,0),this._vSet(o-a*h+t*u,r-c*h+i*u,1)}},_roundJoin(e,t,i,n,s){const o=e.dy,r=-e.dx,a=t.dy,c=-t.dx,l=t.x,h=t.y;if(0!=(t.flags&sj.PT_LEFT)){const u=this._chooseBevel(t.flags&sj.PT_INNERBEVEL,e,t,i),_=u[0],p=u[1],d=u[2],f=u[3],m=XY(-r,-o);let g=XY(-c,-a);g>m&&(g-=2*GY),this._vSet(_,p,1),this._vSet(l-o*n,t.y-r*n,-1);const v=ZY(VY((m-g)/GY)*s,2,s);for(let e=0;e<v;e++){const t=m+e/(v-1)*(g-m),i=l+WY(t)*n,s=h+qY(t)*n;this._vSet(l,h,0),this._vSet(i,s,-1)}this._vSet(d,f,1),this._vSet(l-a*n,h-c*n,-1)}else{const u=this._chooseBevel(t.flags&sj.PT_INNERBEVEL,e,t,-n),_=u[0],p=u[1],d=u[2],f=u[3],m=XY(r,o);let g=XY(c,a);g<m&&(g+=2*GY),this._vSet(l+o*n,h+r*n,1),this._vSet(_,p,-1);const v=ZY(VY((g-m)/GY)*s,2,s);for(let e=0;e<v;e++){const t=m+e/(v-1)*(g-m),n=l+WY(t)*i,s=h+qY(t)*i;this._vSet(n,s,1),this._vSet(l,h,0)}this._vSet(l+a*n,h+c*n,1),this._vSet(d,f,-1)}},_bevelJoin(e,t,i,n){let s=0,o=0,r=0,a=0,c=0,l=0,h=0,u=0;const _=e.dy,p=-e.dx,d=t.dy,f=-t.dx;if(t.flags&sj.PT_LEFT){const s=this._chooseBevel(t.flags&sj.PT_INNERBEVEL,e,t,i);c=s[0],l=s[1],h=s[2],u=s[3],this._vSet(c,l,1),this._vSet(t.x-_*n,t.y-p*n,-1),this._vSet(h,u,1),this._vSet(t.x-d*n,t.y-f*n,-1)}else{const c=this._chooseBevel(t.flags&sj.PT_INNERBEVEL,e,t,-n);s=c[0],o=c[1],r=c[2],a=c[3],this._vSet(t.x+_*i,t.y+p*i,1),this._vSet(s,o,-1),this._vSet(t.x+d*i,t.y+f*i,1),this._vSet(r,a,-1)}},_vSet(e,t,i=0){if(!YY)return;const n=YY;let s=8*n.vertexStart;const o=n.vData;o[s++]=e,o[s++]=t,o[s++]=0,Di.toArray(o,$Y,s),s+=4,o[s++]=i,n.vertexStart++}},eK=e("graphicsAssembler",{getAssembler:()=>JY});$j.Assembler=eK;class tK{constructor(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}}const iK=new _n;let nK=null,sK=null;const oK=[],rK=[],aK=[],cK=[],lK=new hn,hK=new hn,uK=new nn;let _K=null,pK=0,dK=0,fK=0,mK=0,gK=0,vK=1,yK=null,xK="",SK=0,bK=0,TK=0,EK=0,CK=0,wK=0,AK=0,PK=!1,RK=0,IK=0,MK=0;const OK={updateRenderData(e){e.renderData&&e.renderData.vertDirty&&nK!==e&&(nK=e,sK=nK.node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),nK.actualFontSize=SK,sK.setContentSize(hK),nK.renderData.vertDirty=nK.renderData.uvDirty=!1,nK.markForUpdateRenderData(!1),nK=null,this._resetProperties())},_updateFontScale(){vK=SK/bK},_updateFontFamily(e){const t=e.font;yK=t.spriteFrame,_K=t.fntConfig,Kk.fontAtlas=t.fontDefDictionary,ek.packToDynamicAtlas(e,yK)},_updateLabelInfo(e){Kk.hash="",Kk.margin=0},_updateProperties(e){xK=e.string.toString(),SK=e.fontSize,bK=_K?_K.fontSize:e.fontSize,TK=e.horizontalAlign,EK=e.verticalAlign,CK=e.spacingX,AK=e.overflow,wK=e._lineHeight;const t=sK.contentSize;hK.width=t.width,hK.height=t.height,AK===ej.NONE?(PK=!1,hK.width+=2*Kk.margin,hK.height+=2*Kk.margin):AK===ej.RESIZE_HEIGHT?(PK=!0,hK.height+=2*Kk.margin):PK=e.enableWrapText,Kk.lineHeight=wK,Kk.fontSize=SK,this._setupBMFontOverflowMetrics()},_resetProperties(){_K=null,yK=null,Kk.hash="",Kk.margin=0},_updateContent(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText(){const e=xK,t=e.length,i=_K.kerningDict,n=oK;let s=-1;for(let o=0;o<t;++o){const r=e.charCodeAt(o),a=i[s<<16|65535&r]||0;n[o]=o<t-1?a:0,s=r}},_multilineTextWrap(e){const t=xK.length;let i=0,n=0,s=0,o=0,r=0,a=0,c=0,l=null;for(let h=0;h<t;){let u=xK.charAt(h);if("\n"===u){aK.push(r),r=0,i++,n=0,s-=wK*this._getFontScale()+0,this._recordPlaceholderInfo(h,u),h++;continue}const _=e(xK,h,t);let p=a,d=c,f=r,m=n,g=!1;for(let e=0;e<_;++e){const o=h+e;if(u=xK.charAt(o),"\r"===u){this._recordPlaceholderInfo(o,u);continue}if(l=Kk.fontAtlas.getLetterDefinitionForChar(u,Kk),!l){this._recordPlaceholderInfo(o,u),console.log(`Can't find letter definition in texture atlas ${_K.atlasName} for letter:${u}`);continue}const a=m+l.offsetX*vK-Kk.margin;if(PK&&MK>0&&n>0&&a+l.w*vK>MK&&!zk(u)){aK.push(r),r=0,i++,n=0,s-=wK*this._getFontScale()+0,g=!0;break}uK.x=a,uK.y=s-l.offsetY*vK,this._recordLetterInfo(uK,u,o,i),o+1<oK.length&&o<t-1&&(m+=oK[o+1]),m+=l.xAdvance*vK+CK,f=uK.x+l.w*vK,p<uK.y&&(p=uK.y),d>uK.y-l.h*vK&&(d=uK.y-l.h*vK)}g||(n=m,r=f,a<p&&(a=p),c>d&&(c=d),o<r&&(o=r),h+=_)}return aK.push(r),pK=i+1,dK=pK*wK*this._getFontScale(),pK>1&&(dK+=0*(pK-1)),hK.width=RK,hK.height=IK,RK<=0&&(hK.width=parseFloat(o.toFixed(2))+2*Kk.margin),IK<=0&&(hK.height=parseFloat(dK.toFixed(2))+2*Kk.margin),mK=hK.height,gK=0,a>0&&(mK=hK.height+a),c<-dK&&(gK=dK+c),!0},_getFirstCharLen:()=>1,_getFontScale:()=>AK===ej.SHRINK?vK:1,_getFirstWordLen(e,t,i){let n=e.charAt(t);if(Bk(n)||"\n"===n||zk(n))return 1;let s=1,o=Kk.fontAtlas.getLetterDefinitionForChar(n,Kk);if(!o)return s;let r=o.xAdvance*vK+CK,a=0;for(let c=t+1;c<i&&(n=e.charAt(c),o=Kk.fontAtlas.getLetterDefinitionForChar(n,Kk),o);++c){if(a=r+o.offsetX*vK,a+o.w*vK>MK&&!zk(n)&&MK>0)return s;if(r+=o.xAdvance*vK+CK,"\n"===n||zk(n)||Bk(n))break;s++}return s},_multilineTextWrapByWord(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo(e,t){if(e>=rK.length){const e=new tK;rK.push(e)}rK[e].char=t,rK[e].hash=t.charCodeAt(0)+Kk.hash,rK[e].valid=!1},_recordLetterInfo(e,t,i,n){if(i>=rK.length){const e=new tK;rK.push(e)}const s=t.charCodeAt(0)+Kk.hash;rK[i].line=n,rK[i].char=t,rK[i].hash=s,rK[i].valid=Kk.fontAtlas.getLetter(s).valid,rK[i].x=e.x,rK[i].y=e.y},_alignText(){dK=0,aK.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),AK===ej.SHRINK&&SK>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||AK===ej.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown(e){let t=!0;e||(e=.1,t=!1),SK=e,t&&this._updateContent()},_shrinkLabelToContentSize(e){let t=0,i=0|SK,n=0;for(;t<i;){n=t+i+1>>1;const s=n;if(s<=0)break;vK=s/bK,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?i=n-1:t=n}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:()=>dK>hK.height,_isHorizontalClamp(){let e=!1;for(let t=0,i=xK.length;t<i;++t){const i=rK[t];if(i.valid){const t=Kk.fontAtlas.getLetterDefinitionForChar(i.char,Kk);if(!t)continue;const n=i.x+t.w/2*vK,s=i.line;if(RK>0)if(PK){if(aK[s]>hK.width&&(n>hK.width||n<0)){e=!0;break}}else if(n>hK.width){e=!0;break}}}return e},_isHorizontalClamped(e,t){const i=aK[t],n=e>hK.width||e<0;return PK?i>hK.width&&n:n},_updateQuads(){if(!nK)return!1;const e=yK?yK.texture:Kk.fontAtlas.getTexture(),t=nK.renderData;t.dataLength=t.vertexCount=t.indicesCount=0;const i=sK.anchorPoint,n=hK,s=i.x*n.width,o=i.y*n.height;let r=!0;for(let t=0,i=xK.length;t<i;++t){const i=rK[t];if(!i.valid)continue;const n=Kk.fontAtlas.getLetter(i.hash);if(!n){console.warn("Can't find letter in this bitmap-font");continue}iK.height=n.h,iK.width=n.w,iK.x=n.u,iK.y=n.v;let a=i.y+fK;if(IK>0){if(a>mK){const e=a-mK;iK.y+=e,iK.height-=e,a-=e}a-n.h*vK<gK&&AK===ej.CLAMP&&(iK.height=a<gK?0:(a-gK)/vK)}const c=i.line,l=i.x+n.w/2*vK+cK[c];if(RK>0&&this._isHorizontalClamped(l,c))if(AK===ej.CLAMP)iK.width=0;else if(AK===ej.SHRINK){if(hK.width>n.w){r=!1;break}iK.width=0}if(iK.height>0&&iK.width>0){const t=this._determineRect(),n=i.x+cK[i.line];this.appendQuad(nK,e,iK,t,n-s,a-o,vK)}}return r},appendQuad(e,t,i,n,s,o,r){},_determineRect(){const e=yK.isRotated(),t=yK.getOriginalSize(),i=yK.getRect(),n=yK.getOffset(),s=n.x+(t.width-i.width)/2,o=n.y-(t.height-i.height)/2;if(e){const e=iK.x;iK.x=i.x+i.height-iK.y-iK.height-o,iK.y=e+i.y-s,iK.y<0&&(iK.height+=o)}else iK.x+=i.x-s,iK.y+=i.y+o;return e},_computeAlignmentOffset(){switch(cK.length=0,TK){case ZV.LEFT:for(let e=0;e<pK;++e)cK.push(0);break;case ZV.CENTER:for(let e=0,t=aK.length;e<t;e++)cK.push((hK.width-aK[e])/2);break;case ZV.RIGHT:for(let e=0,t=aK.length;e<t;e++)cK.push(hK.width-aK[e])}if(fK=hK.height,EK!==JV.TOP){const e=hK.height-dK+wK*this._getFontScale()-bK*vK;EK===JV.BOTTOM?fK-=e:fK-=e/2}},_setupBMFontOverflowMetrics(){let e=hK.width,t=hK.height;AK===ej.RESIZE_HEIGHT&&(t=0),AK===ej.NONE&&(e=0,t=0),RK=e,IK=t,lK.width=e,lK.height=t,MK=e}},DK=new Di(255,255,255,255),NK={createData:e=>e.requestRenderData(),fillBuffers(e,t){const i=e.node;e._setCacheAlpha(i._uiProps.opacity),DK.set(e.color),DK.a=255*i._uiProps.opacity,$G(i,t,e.renderData,DK)},appendQuad(e,t,i,n,s,o,r){const a=e.renderData;if(!a)return;const c=a.dataLength;a.dataLength+=4,a.vertexCount=a.dataLength,a.indicesCount=a.dataLength/2*3;const l=a.data,h=t.width,u=t.height,_=i.width,p=i.height;let d=0,f=0,m=0,g=0;n?(d=i.x/h,g=(i.x+p)/h,f=(i.y+_)/u,m=i.y/u,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=f,l[c+2].u=g,l[c+2].v=m,l[c+3].u=g,l[c+3].v=f):(d=i.x/h,g=(i.x+_)/h,f=(i.y+p)/u,m=i.y/u,l[c].u=d,l[c].v=f,l[c+1].u=g,l[c+1].v=f,l[c+2].u=d,l[c+2].v=m,l[c+3].u=g,l[c+3].v=m),l[c].x=s,l[c].y=o-p*r,l[c+1].x=s+_*r,l[c+1].y=o-p*r,l[c+2].x=s,l[c+2].y=o,l[c+3].x=s+_*r,l[c+3].y=o}};de(NK,OK);let LK=null;const BK=fe(OK,{getAssemblerData:()=>(LK||(LK=new Yk(1024,1024)),LK.getTexture()),_updateFontFamily(e){Kk.fontAtlas=LK,Kk.fontFamily=this._getFontFamily(e);const t=e.getComponent(HW);t&&t.enabled?(Kk.isOutlined=!0,Kk.margin=t.width,Kk.out=t.color.clone(),Kk.out.a=t.color.a*e.color.a/255):(Kk.isOutlined=!1,Kk.margin=0)},_getFontFamily(e){let t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo(e){Kk.fontDesc=this._getFontDesc(),Kk.color=e.color,Kk.hash=function(e){const t=e.color.toHEX();let i="";return e.isOutlined&&e.margin>0&&(i=i+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+i}(Kk)},_getFontDesc(){let e=`${Kk.fontSize.toString()}px `;return e+=Kk.fontFamily,e},_computeHorizontalKerningForText(){},_determineRect:()=>!1}),zK=new Di(255,255,255,255),FK={createData:e=>e.requestRenderData(),fillBuffers(e,t){if(!e.renderData)return;const i=e.node;e._setCacheAlpha(i._uiProps.opacity),zK.a=255*i._uiProps.opacity,$G(i,t,e.renderData,zK)},appendQuad:NK.appendQuad};de(FK,BK);const UK=oj.Overflow,GK=(1/255).toFixed(3);let kK=null,HK=null,VK=null,jK="",WK="",qK=0,XK=0,YK=[];const KK=new hn;let $K=0,QK=0,ZK=0,JK=new Di,e$=1,t$="",i$=UK.NONE,n$=!1,s$=null;const o$=Di.BLACK.clone();let r$=null;const a$=Di.BLACK.clone(),c$=new _n,l$=hn.ZERO.clone(),h$=hn.ZERO.clone(),u$=nn.ZERO.clone(),_$=nn.ZERO.clone();let p$=0,d$=0,f$=!1,m$=!1,g$=!1;const v$=["left","center","right"],y$={getAssemblerData:()=>oj._canvasPool.get(),resetAssemblerData(e){e&&oj._canvasPool.put(e)},updateRenderData(e){if(!e.renderData||!e.renderData.vertDirty)return;const t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._resetDynamicAtlas(e),this._updateTexture(e),this.updateOpacity(e),e._setCacheAlpha(e$),this._calDynamicAtlas(e),e.actualFontSize=qK,t.setContentSize(KK),this.updateVertexData(e),this.updateUvs(e),e.markForUpdateRenderData(!1),kK=null,HK=null,VK=null},updateVertexData(e){},updateUvs(e){},updateOpacity(e){const t=e.renderData.vData;let i=5;const n=e.node._uiProps.opacity;for(let e=0;e<4;e++)t[i+3]=n,i+=9},_updateFontFamily(e){t$=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties(e,t){const i=e.assemblerData;i&&(kK=i.context,HK=i.canvas,VK=e.spriteFrame,WK=e.string.toString(),qK=e.fontSize,XK=qK,i$=e.overflow,h$.width=KK.width=t.width,h$.height=KK.height=t.height,d$=e.underlineHeight,$K=e.lineHeight,QK=e.horizontalAlign,ZK=e.verticalAlign,JK=e.color,e$=e.node._uiProps.opacity,f$=e.isBold,m$=e.isItalic,g$=e.isUnderline,n$=i$!==UK.NONE&&(i$===UK.RESIZE_HEIGHT||e.enableWrapText),s$=HW&&e.getComponent(HW),s$=s$&&s$.enabled&&s$.width>0?s$:null,s$&&o$.set(s$.color),r$=pY&&e.getComponent(pY),r$=r$&&r$.enabled?r$:null,r$&&a$.set(r$.color),this._updatePaddingRect())},_updatePaddingRect(){let e=0,t=0,i=0,n=0,s=0;if(l$.width=l$.height=0,s$&&(s=s$.width,e=t=i=n=s,l$.width=l$.height=2*s),r$){const o=r$.blur+s,r=r$.offset.x,a=r$.offset.y;i=Math.max(i,-r+o),n=Math.max(n,r+o),e=Math.max(e,a+o),t=Math.max(t,-a+o)}if(m$){const e=XK*Math.tan(.20943951);n+=e,l$.width+=e}c$.x=i,c$.y=e,c$.width=i+n,c$.height=e+t},_calculateFillTextStartPosition(){let e=0;QK===ZV.RIGHT?e=KK.width-c$.width:QK===ZV.CENTER&&(e=(KK.width-c$.width)/2);const t=this._getLineHeight()*(YK.length-1);let i=qK*(1-Ak/2);if(ZK!==JV.TOP){let e=t+c$.height+qK-KK.height;ZK===JV.BOTTOM?(e+=Ak/2*qK,i-=e):i-=e/2}i+=0*qK,u$.set(e+c$.x,i+c$.y)},_updateTexture(e){if(!kK||!HK)return;kK.clearRect(0,0,HK.width,HK.height),kK.font=jK,this._calculateFillTextStartPosition();const t=this._getLineHeight();kK.lineJoin="round",s$?(kK.fillStyle=`rgba(${o$.r}, ${o$.g}, ${o$.b}, ${GK})`,kK.fillRect(0,0,HK.width,HK.height)):e._srcBlendFactor===$s.SRC_ALPHA&&(kK.fillStyle=`rgba(${JK.r}, ${JK.g}, ${JK.b}, ${GK})`,kK.fillRect(0,0,HK.width,HK.height)),kK.fillStyle=`rgb(${JK.r}, ${JK.g}, ${JK.b})`;const i=u$.x;let s=0;this._drawTextEffect(u$,t);for(let e=0;e<YK.length;++e)s=u$.y+e*t,s$&&kK.strokeText(YK[e],i,s),kK.fillText(YK[e],i,s);if(r$&&(kK.shadowColor="transparent"),VK){let e;e=VK instanceof nk?VK.texture:VK,0!==HK.width&&0!==HK.height&&(e.reset({width:HK.width,height:HK.height,mipmapLevel:1}),e.uploadData(HK),VK instanceof nk&&(VK.rect=new _n(0,0,HK.width,HK.height),VK._calculateUV()),n.director.root&&n.director.root.batcher2D&&n.director.root.batcher2D._releaseDescriptorSetCache(e.getHash()))}},_resetDynamicAtlas(e){if(e.cacheMode!==oj.CacheMode.BITMAP)return;const t=e.ttfSpriteFrame;ek.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()},_calDynamicAtlas(e){if(e.cacheMode!==oj.CacheMode.BITMAP)return;const t=e.ttfSpriteFrame;ek.packToDynamicAtlas(e,t),e.renderData.uvDirty=!0},_setupOutline(){kK.strokeStyle=`rgba(${o$.r}, ${o$.g}, ${o$.b}, ${o$.a/255})`,kK.lineWidth=2*s$.width},_setupShadow(){kK.shadowColor=`rgba(${a$.r}, ${a$.g}, ${a$.b}, ${a$.a/255})`,kK.shadowBlur=r$.blur,kK.shadowOffsetX=r$.offset.x,kK.shadowOffsetY=-r$.offset.y},_drawTextEffect(e,t){if(!r$&&!s$&&!g$)return;const i=YK.length>1&&r$,n=this._measureText(kK,jK);let s=0,o=0;r$&&this._setupShadow(),s$&&this._setupOutline();for(let r=0;r<YK.length;++r)s=e.x,o=e.y+r*t,i&&(s$&&kK.strokeText(YK[r],s,o),kK.fillText(YK[r],s,o)),g$&&(p$=n(YK[r]),QK===ZV.RIGHT?_$.x=e.x-p$:QK===ZV.CENTER?_$.x=e.x-p$/2:_$.x=e.x,_$.y=o+XK/8,kK.fillRect(_$.x,_$.y,p$,d$));i&&(kK.shadowColor="transparent")},_updateLabelDimensions(){KK.width=Math.min(KK.width,2048),KK.height=Math.min(KK.height,2048);let e=!1;HK.width!==KK.width&&(HK.width=KK.width,e=!0),HK.height!==KK.height&&(HK.height=KK.height,e=!0),e&&(kK.font=jK),kK.textAlign=v$[QK],kK.textBaseline="alphabetic"},_getFontDesc(){let e=`${qK.toString()}px `;return e+=t$,f$&&(e=`bold ${e}`),m$&&(e=`italic ${e}`),e},_getLineHeight(){let e=$K;return e=0===e?qK:e*qK/XK,0|e},_calculateParagraphLength(e,t){const i=[];for(const n of e){const e=Fk(t,n,jK);i.push(e)}return i},_measureText:(e,t)=>i=>Fk(e,i,t),_calculateShrinkFont(e){if(!kK)return;const t=this._calculateParagraphLength(e,kK);let i=0,n=0,s=0;if(n$){const t=h$.width,s=h$.height;if(t<0||s<0)return;n=s+1;let o=[],r=0,a=0|qK+1,c=0;for(;r<a;){if(c=r+a+1>>1,c<=0){S(4003);break}qK=c,jK=this._getFontDesc(),kK.font=jK;const l=this._getLineHeight();for(n=0,i=0;i<e.length;++i){const s=Fk(kK,e[i],jK);o=Gk(e[i],s,t,this._measureText(kK,jK)),n+=o.length*l}n>s?a=c-1:r=c}0===r?S(4003):(qK=r,jK=this._getFontDesc(),kK.font=jK)}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)s<t[i]&&(s=t[i]);const o=(KK.width-c$.width)/s,r=KK.height/n;qK=XK*Math.min(1,o,r)|0,jK=this._getFontDesc(),kK.font=jK}},_calculateWrapText(e){if(!n$||!kK)return;YK=[];const t=h$.width;for(let i=0;i<e.length;++i){const n=Fk(kK,e[i],jK),s=Gk(e[i],n,t,this._measureText(kK,jK));YK=YK.concat(s)}},_calculateLabelFont(){if(!kK)return;const e=WK.split("\n");switch(YK=e,jK=this._getFontDesc(),kK.font=jK,i$){case UK.NONE:{let t=0,i=0;for(let i=0;i<e.length;++i){const n=Fk(kK,e[i],jK);t=t>n?t:n}i=(YK.length+Ak)*this._getLineHeight();const n=parseFloat(t.toFixed(2)),s=parseFloat(i.toFixed(2));KK.width=n+c$.width,KK.height=s+c$.height,h$.width=n+l$.width,h$.height=s+l$.height;break}case UK.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case UK.CLAMP:this._calculateWrapText(e);break;case UK.RESIZE_HEIGHT:{this._calculateWrapText(e);const t=(YK.length+Ak)*this._getLineHeight();KK.height=t+c$.height,h$.height=t+l$.height;break}}}},x$=Di.WHITE.clone(),S$={createData(e){const t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indicesCount=6;const i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;let n=5;for(let e=0;e<4;e++)Di.toArray(i,x$,n),n+=9;return t},fillBuffers(e,t){const i=e.renderData,n=i.data,s=e.node;let o=t.acquireBufferBatch(),r=o.byteOffset>>2,a=o.indicesOffset,c=o.vertexOffset;o.request()||(o=t.currBufferBatch,a=0,c=0,r=0);const l=o.vData,h=o.iData,u=i.vData,_=n[0],p=n[3];s.updateWorldTransform();const d=s._pos,f=s._rot,m=s._scale,g=_.x*m.x,v=p.x*m.x,y=_.y*m.y,x=p.y*m.y,S=f.x,b=f.y,T=f.z,E=f.w,C=S*b,w=T*E,A=S*S-b*b,P=E*E-T*T,R=P+A,I=2*(C-w),M=P-A,O=2*(C+w),D=d.x,N=d.y;u[0]=R*g+I*y+D,u[1]=M*y+O*g+N,u[9]=R*v+I*y+D,u[10]=M*y+O*v+N,u[18]=R*g+I*x+D,u[19]=M*x+O*g+N,u[27]=R*v+I*x+D,u[28]=M*x+O*v+N,l.set(u,r),h[a++]=c,h[a++]=c+1,h[a++]=c+2,h[a++]=c+2,h[a++]=c+1,h[a++]=c+3},updateVertexData(e){const t=e.renderData;if(!t)return;const i=e.node._uiProps.uiTransformComp,n=i.width,s=i.height,o=i.anchorX*n,r=i.anchorY*s,a=t.data;a[0].x=-o,a[0].y=-r,a[3].x=n-o,a[3].y=s-r},updateUvs(e){const t=e.renderData;if(!t)return;const i=t.vData;if(!i||!t.uvDirty)return;const n=e.ttfSpriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1}};de(S$,y$);const b$=e("labelAssembler",{getAssembler(e){let t=S$;return e.font instanceof Ek?t=NK:e.cacheMode===oj.CacheMode.CHAR&&(t=FK),t}});oj.Assembler=b$;const T$=Oq.FillType,E$=new Zi,C$=new Di(255,255,255,255),w$={useModel:!1,updateRenderData(e){const t=e.spriteFrame;ek.packToDynamicAtlas(e,t);const i=e.renderData;if(i&&t){const t=i.uvDirty,n=i.vertDirty;if(!t&&!n)return;let s=e.fillStart,o=e.fillRange;o<0&&(s+=o,o=-o),o=s+o,s=s>1?1:s,s=s<0?0:s,o=o>1?1:o,o=o<0?0:o,o-=s,o=o<0?0:o;let r=s+o;r=r>1?1:r,t&&this.updateUVs(e,s,r),n&&(this.updateVertexData&&this.updateVertexData(e,s,r),this.updateWorldVertexData(e))}},updateUVs(e,t,i){const n=e.spriteFrame,s=e.renderData,o=s.data,r=n.width,a=n.height,c=n.getRect();let l=0,h=0,u=0,_=0,p=0,d=0,f=0,m=0,g=0,v=0,y=0,x=0;switch(n.isRotated()?(l=c.x/r,h=(c.y+c.width)/a,u=(c.x+c.height)/r,_=c.y/a,p=f=l,g=y=u,m=x=h,d=v=_):(l=c.x/r,h=(c.y+c.height)/a,u=(c.x+c.width)/r,_=c.y/a,p=g=l,f=y=u,d=m=h,v=x=_),e.fillType){case T$.HORIZONTAL:o[0].u=p+(f-p)*t,o[0].v=d+(m-d)*t,o[1].u=p+(f-p)*i,o[1].v=d+(m-d)*i,o[2].u=g+(y-g)*t,o[2].v=v+(x-v)*t,o[3].u=g+(y-g)*i,o[3].v=v+(x-v)*i;break;case T$.VERTICAL:o[0].u=p+(g-p)*t,o[0].v=d+(v-d)*t,o[1].u=f+(y-f)*t,o[1].v=m+(x-m)*t,o[2].u=p+(g-p)*i,o[2].v=d+(v-d)*i,o[3].u=f+(y-f)*i,o[3].v=m+(x-m)*i;break;default:C(2626)}s.uvDirty=!1},updateVertexData(e,t,i){const n=e.renderData,s=n.data,o=e.node._uiProps.uiTransformComp,r=o.width,a=o.height,c=o.anchorX*r,l=o.anchorY*a;let h=-c,u=-l,_=r-c,p=a-l,d=0,f=0;switch(e.fillType){case T$.HORIZONTAL:d=h+(_-h)*t,f=h+(_-h)*i,h=d,_=f;break;case T$.VERTICAL:d=u+(p-u)*t,f=u+(p-u)*i,u=d,p=f;break;default:C(2626)}s[4].x=h,s[4].y=u,s[5].x=_,s[5].y=u,s[6].x=h,s[6].y=p,s[7].x=_,s[7].y=p,n.vertDirty=!1},createData(e){const t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indicesCount=6;const i=t.data;for(const e of i)e.z=0;return t},updateWorldVertexData(e){const t=e.node,i=e.renderData.data;t.getWorldMatrix(E$);for(let e=0;e<4;e++){const t=i[e+4],n=i[e];zi.transformMat4(n,t,E$)}},fillBuffers(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);const i=e.node;C$.set(e.color),C$.a=255*i._uiProps.opacity,function(e,t,i,n){const s=i.data;let o=t.acquireBufferBatch(),r=o.byteOffset>>2;const a=i.vertexCount;let c=o.indicesOffset,l=o.vertexOffset;o.request(a,i.indicesCount)||(o=t.currBufferBatch,r=0,c=0,l=0);const h=o.vData;for(let e=0;e<a;e++){const t=s[e];h[r++]=t.x,h[r++]=t.y,h[r++]=t.z,h[r++]=t.u,h[r++]=t.v,Di.toArray(h,n,r),r+=4}const u=o.iData;u[c++]=l,u[c++]=l+1,u[c++]=l+2,u[c++]=l+1,u[c++]=l+3,u[c++]=l+2}(0,t,e.renderData,C$)},updateColor(e){}},A$=2*Math.PI,P$=1e-6,R$=new Di(255,255,255,255),I$=[new nn,new nn,new nn,new nn],M$=new Array(4),O$=new Array(8),D$=[new nn,new nn,new nn,new nn],N$=[new nn,new nn,new nn,new nn],L$=new nn,B$=[new nn,new nn,new nn,new nn];function z$(e,t,i,n,s,o,r){let a=Math.sin(o);a=Math.abs(a)>P$?a:0;let c=Math.cos(o);c=Math.abs(c)>P$?c:0;let l=0,h=0;if(0!==c){if(l=a/c,(e-s.x)*c>0){const t=s.y+l*(e-s.x);r[0].x=e,r[0].y=t}if((t-s.x)*c>0){const e=s.y+l*(t-s.x);r[2].x=t,r[2].y=e}}if(0!==a){if(h=c/a,(n-s.y)*a>0){const e=s.x+h*(n-s.y);r[3].x=e,r[3].y=n}if((i-s.y)*a>0){const e=s.x+h*(i-s.y);r[1].x=e,r[1].y=i}}}function F$(e,t){const i=t.x-e.x,n=t.y-e.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;{let e=Math.atan(n/i);return i<0&&(e+=Math.PI),e}}function U$(e,t,i,n,s){const o=M$,r=o[0],a=o[1],c=o[2],l=o[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=s.x,e[t+2].y=s.y;let h=0,u=0;h=(i.x-r)/(c-r),u=(i.y-a)/(l-a),G$(h,u,e,t),h=(n.x-r)/(c-r),u=(n.y-a)/(l-a),G$(h,u,e,t+1),h=(s.x-r)/(c-r),u=(s.y-a)/(l-a),G$(h,u,e,t+2)}function G$(e,t,i,n){const s=O$,o=s[0]+(s[2]-s[0])*e,r=s[4]+(s[6]-s[4])*e,a=s[1]+(s[3]-s[1])*e,c=s[5]+(s[7]-s[5])*e,l=i[n];l.u=o+(r-o)*t,l.v=a+(c-a)*t}const k$={useModel:!1,createData:e=>e.requestRenderData(),updateRenderData(e){const t=e.spriteFrame;ek.packToDynamicAtlas(e,t);const i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){const n=i.data;let s=e.fillStart,o=e.fillRange;for(o<0&&(s+=o,o=-o);s>=1;)s-=1;for(;s<0;)s+=1;s*=A$,o*=A$;const r=s+o;!function(e){const t=e.node._uiProps.uiTransformComp,i=t.width,n=t.height,s=t.anchorX*i,o=t.anchorY*n,r=-s,a=-o,c=i-s,l=n-o,h=M$;h[0]=r,h[1]=a,h[2]=c,h[3]=l;const u=e.fillCenter,_=L$.x=Math.min(Math.max(0,u.x),1)*(c-r)+r,p=L$.y=Math.min(Math.max(0,u.y),1)*(l-a)+a;I$[0].x=I$[3].x=r,I$[1].x=I$[2].x=c,I$[0].y=I$[1].y=a,I$[2].y=I$[3].y=l;for(const e of B$)nn.set(e,0,0);_!==h[0]&&nn.set(B$[0],3,0),_!==h[2]&&nn.set(B$[2],1,2),p!==h[1]&&nn.set(B$[1],0,1),p!==h[3]&&nn.set(B$[3],2,3)}(e),function(e){const t=e.width,i=e.height,n=e.getRect();let s=0,o=0,r=0,a=0;const c=O$;e.isRotated()?(s=n.x/t,o=(n.x+n.height)/t,r=n.y/i,a=(n.y+n.width)/i,c[0]=c[2]=s,c[4]=c[6]=o,c[3]=c[7]=a,c[1]=c[5]=r):(s=n.x/t,o=(n.x+n.width)/t,r=n.y/i,a=(n.y+n.height)/i,c[0]=c[4]=s,c[2]=c[6]=o,c[1]=c[3]=a,c[5]=c[7]=r)}(t),z$(M$[0],M$[2],M$[1],M$[3],L$,s,D$),z$(M$[0],M$[2],M$[1],M$[3],L$,s+o,N$);let a=0;for(let e=0;e<4;++e){const t=B$[e];if(!t)continue;if(o>=A$){i.dataLength=a+3,U$(n,a,L$,I$[t.x],I$[t.y]),a+=3;continue}let c=F$(L$,I$[t.x]),l=F$(L$,I$[t.y]);l<c&&(l+=A$),c-=A$,l-=A$;for(let o=0;o<3;++o)c>=r||(c>=s?(i.dataLength=a+3,U$(n,a,L$,I$[t.x],l>=r?N$[e]:I$[t.y]),a+=3):l>s&&(l<=r?(i.dataLength=a+3,U$(n,a,L$,D$[e],I$[t.y]),a+=3):(i.dataLength=a+3,U$(n,a,L$,D$[e],N$[e]),a+=3))),c+=A$,l+=A$}i.indicesCount=i.vertexCount=a,i.vertDirty=i.uvDirty=!1}},fillBuffers(e,t){const i=e.node,n=e.renderData;R$.set(e.color),R$.a=255*i._uiProps.opacity,function(e,t,i,n){const s=i.data;let o=t.acquireBufferBatch(),r=o.byteOffset>>2;const a=i.vertexCount;let c=o.indicesOffset,l=o.vertexOffset;o.request(a,i.indicesCount)||(o=t.currBufferBatch,r=0,c=0,l=0);const h=o.vData;e.getWorldMatrix(KG);for(let e=0;e<a;e++){const t=s[e];zi.set(YG,t.x,t.y,0),zi.transformMat4(YG,YG,KG),h[r++]=YG.x,h[r++]=YG.y,h[r++]=YG.z,h[r++]=t.u,h[r++]=t.v,Di.toArray(h,n,r),r+=4}const u=o.iData;for(let e=0;e<i.dataLength;e++)u[c+e]=l+e}(i,t,n,R$)},updateColor(e){}},H$=[];for(let e=0;e<4;e++)H$.push(new zi);const V$={createData(e){const t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData(e){const t=e.spriteFrame;ek.packToDynamicAtlas(e,t);const i=e.renderData;i&&t&&(i.vertDirty&&this.updateVertexData(e),i.uvDirty&&this.updateUvs(e))},updateWorldVerts(e,t){const i=e.renderData.data,n=e.node,s=i[0],o=i[3],r=n.worldMatrix,a=r.m00,c=r.m01,l=r.m04,h=r.m05,u=1===a&&0===c&&0===l&&1===h,_=r.m12,p=r.m13,d=s.x,f=o.x,m=s.y,g=o.y;if(u){const e=d+_,i=f+_,n=m+p,s=g+p;t[0]=e,t[1]=n,t[9]=i,t[10]=n,t[18]=e,t[19]=s,t[27]=i,t[28]=s}else{const e=a*d,i=a*f,n=c*d,s=c*f,o=l*m+_,r=l*g+_,u=h*m+p,v=h*g+p;t[0]=e+o,t[1]=n+u,t[9]=i+o,t[10]=s+u,t[18]=e+r,t[19]=n+v,t[27]=i+r,t[28]=s+v}n._uiProps.uiTransformDirty=!1},fillBuffers(e,t){if(null===e)return;const i=e.renderData.vData;e.node._uiProps.uiTransformDirty&&this.updateWorldVerts(e,i);let n=t.acquireBufferBatch(),s=n.byteOffset>>2,o=n.indicesOffset,r=n.vertexOffset;n.request()||(n=t.currBufferBatch,s=0,o=0,r=0);const a=n.vData,c=n.iData;a.set(i,s);const l=r,h=r+1,u=r+2,_=r+3;c[o++]=l,c[o++]=h,c[o++]=u,c[o++]=u,c[o++]=h,c[o++]=_},updateVertexData(e){const t=e.renderData;if(!t)return;const i=e.node._uiProps.uiTransformComp,n=t.data,s=i.width,o=i.height,r=i.anchorX*s,a=i.anchorY*o;let c=0,l=0,h=0,u=0;if(e.trim)c=-r,l=-a,h=s-r,u=o-a;else{const t=e.spriteFrame,i=t.getOriginalSize(),n=t.getRect(),_=i.width,p=i.height,d=n.width,f=n.height,m=t.getOffset(),g=s/_,v=o/p,y=m.x+(_-d)/2,x=m.x-(_-d)/2;c=y*g-r,l=(m.y+(p-f)/2)*v-a,h=s+x*g-r,u=o+(m.y-(p-f)/2)*v-a}n[0].x=c,n[0].y=l,n[3].x=h,n[3].y=u,t.vertDirty=!1,this.updateWorldVerts(e,t.vData)},updateUvs(e){const t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor(e){const t=e.renderData.vData;let i=5;const n=e.color,s=n.r/255,o=n.g/255,r=n.b/255,a=e.node._uiProps.opacity;for(let e=0;e<4;e++)t[i]=s,t[i+1]=o,t[i+2]=r,t[i+3]=a,i+=9}},j$=new zi,W$=new Zi,q$={useModel:!1,createData(e){const t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indicesCount=54,t},updateRenderData(e){const t=e.spriteFrame;ek.packToDynamicAtlas(e,t);const i=e.renderData;i&&t&&i.vertDirty&&(this.updateVertexData(e),this.updateWorldVertexData(e))},updateVertexData(e){const t=e.renderData,i=t.data,n=e.node._uiProps.uiTransformComp,s=n.width,o=n.height,r=n.anchorX*s,a=n.anchorY*o,c=e.spriteFrame,l=c.insetLeft,h=c.insetRight,u=c.insetTop,_=c.insetBottom;let p=s-l-h,d=o-u-_,f=s/(l+h),m=o/(u+_);f=Number.isNaN(f)||f>1?1:f,m=Number.isNaN(m)||m>1?1:m,p=p<0?0:p,d=d<0?0:d,i[0].x=-r,i[0].y=-a,i[1].x=l*f-r,i[1].y=_*m-a,i[2].x=i[1].x+p,i[2].y=i[1].y+d,i[3].x=s-r,i[3].y=o-a,t.vertDirty=!1},fillBuffers(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);let i=t.acquireBufferBatch();const n=e.renderData,s=n.data;let o=i.byteOffset>>2;const r=n.vertexCount;let a=i.indicesOffset,c=i.vertexOffset;const l=e.spriteFrame.uvSliced;i.request(r,n.indicesCount)||(i=t.currBufferBatch,o=0,a=0,c=0);const h=i.vData,u=i.iData;for(let e=4;e<20;++e){const t=s[e],i=l[e-4];h[o++]=t.x,h[o++]=t.y,h[o++]=t.z,h[o++]=i.u,h[o++]=i.v,Di.toArray(h,s[e].color,o),o+=4}for(let e=0;e<3;++e)for(let t=0;t<3;++t){const i=c+4*e+t;u[a++]=i,u[a++]=i+1,u[a++]=i+4,u[a++]=i+1,u[a++]=i+5,u[a++]=i+4}},updateWorldVertexData(e){const t=e.node,i=e.renderData.data;t.getWorldMatrix(W$);for(let e=0;e<4;++e){const t=i[e];for(let n=0;n<4;++n){const s=i[n],o=i[4+4*e+n];zi.set(j$,s.x,t.y,0),zi.transformMat4(o,j$,W$)}}},updateColor(e){const t=e.renderData.data,i=e.color,n=i.r,s=i.g,o=i.b,r=255*e.node._uiProps.opacity;for(let e=4;e<20;e++)t[e].color.r=n,t[e].color.g=s,t[e].color.b=o,t[e].color.a=r}},X$=[];for(let e=0;e<4;e++)X$.push(new zi);const Y$={createData:e=>e.requestRenderData(),updateRenderData(e){const t=e.renderData,i=e.spriteFrame;if(!i||!t||!t.uvDirty&&!t.vertDirty)return;const n=e.node._uiProps.uiTransformComp,s=Math.abs(n.width),o=Math.abs(n.height),r=i.getRect(),a=i.insetLeft,c=i.insetRight,l=r.width-a-c,h=i.insetTop,u=i.insetBottom,_=r.height-h-u;let p=s-a-c,d=o-h-u;p=p>0?p:0,d=d>0?d:0;const f=0===l?p:p/l,m=0===_?d:d/_,g=Math.ceil(m+2),v=Math.ceil(f+2);t.dataLength=Math.max(8,g+1,v+1),this.updateVerts(e,p,d,g,v),t.vertexCount=g*v*4,t.indicesCount=g*v*6,t.uvDirty=!1,t.vertDirty=!1,this.updateColor(e)},fillBuffers(e,t){const i=e.node,n=e.node._uiProps.uiTransformComp,s=Math.abs(n.width),o=Math.abs(n.height),r=e.renderData;let a=t.acquireBufferBatch(),c=a.indicesOffset,l=a.byteOffset>>2,h=a.vertexOffset;const u=r.vertexCount,_=r.indicesCount,p=a.vData,d=a.iData;a.request(u,_)||(a=t.currBufferBatch,l=0,c=0,h=0);const f=e.spriteFrame,m=f.isRotated(),g=f.uv,v=e.spriteFrame.uvSliced,y=f.getRect(),x=f.insetLeft,S=f.insetRight,b=y.width-x-S,T=f.insetTop,E=f.insetBottom,C=y.height-T-E;let w=s-x-S,A=o-T-E;w=w>0?w:0,A=A>0?A:0;const P=0===b?w:w/b,R=0===C?A:A/C,I=Math.ceil(R+2),M=Math.ceil(P+2),O=i.worldMatrix,D=r.data;this.fillVertices(p,l,O,I,M,D);let N=0,L=0;const B=[],z=[];for(let e=0,t=I;e<t;++e){L=A>C?A>=e*C?1:R%1:R;for(let t=0,i=M;t<i;++t){N=w>b?w>=t*b?1:P%1:P;const i=l+3,n=i+1;m?(0===e?(B[0]=v[0].u,B[1]=v[0].u,B[2]=v[4].u+(v[8].u-v[4].u)*L):e<I-1?(B[0]=v[4].u,B[1]=v[4].u,B[2]=v[4].u+(v[8].u-v[4].u)*L):e===I-1&&(B[0]=v[8].u,B[1]=v[8].u,B[2]=v[12].u),0===t?(z[0]=v[0].v,z[1]=v[1].v+(v[2].v-v[1].v)*N,z[2]=v[0].v):t<M-1?(z[0]=v[1].v,z[1]=v[1].v+(v[2].v-v[1].v)*N,z[2]=v[1].v):t===M-1&&(z[0]=v[2].v,z[1]=v[3].v,z[2]=v[2].v),B[3]=B[2],z[3]=z[1]):(0===t?(B[0]=v[0].u,B[1]=v[1].u+(v[2].u-v[1].u)*N,B[2]=g[0]):t<M-1?(B[0]=v[1].u,B[1]=v[1].u+(v[2].u-v[1].u)*N,B[2]=v[1].u):t===M-1&&(B[0]=v[2].u,B[1]=v[3].u,B[2]=v[2].u),0===e?(z[0]=v[0].v,z[1]=v[0].v,z[2]=v[4].v+(v[8].v-v[4].v)*L):e<I-1?(z[0]=v[4].v,z[1]=v[4].v,z[2]=v[4].v+(v[8].v-v[4].v)*L):e===I-1&&(z[0]=v[8].v,z[1]=v[8].v,z[2]=v[12].v),B[3]=B[1],z[3]=z[2]),p[i]=B[0],p[n]=z[0],p[i+9]=B[1],p[n+9]=z[1],p[i+18]=B[2],p[n+18]=z[2],p[i+27]=B[3],p[n+27]=z[3],Di.toArray(p,D[0].color,n+1),Di.toArray(p,D[0].color,n+9+1),Di.toArray(p,D[0].color,n+18+1),Di.toArray(p,D[0].color,n+27+1),l+=36}}for(let e=0;e<_;e+=6)d[c++]=h,d[c++]=h+1,d[c++]=h+2,d[c++]=h+1,d[c++]=h+3,d[c++]=h+2,h+=4},fillVertices(e,t,i,n,s,o){let r=0,a=0,c=0,l=0;for(let h=0,u=n;h<u;++h){c=o[h].y,l=o[h+1].y;for(let n=0,h=s;n<h;++n){r=o[n].x,a=o[n+1].x,zi.set(X$[0],r,c,0),zi.set(X$[1],a,c,0),zi.set(X$[2],r,l,0),zi.set(X$[3],a,l,0);for(let n=0;n<4;n++){const s=X$[n];zi.transformMat4(s,s,i);const o=9*n;e[t+o]=s.x,e[t+o+1]=s.y,e[t+o+2]=s.z}t+=36}}},updateVerts(e,t,i,n,s){const o=e.node._uiProps.uiTransformComp,r=e.renderData.data,a=e.spriteFrame,c=a.getRect(),l=Math.abs(o.width),h=Math.abs(o.height),u=o.anchorX*l,_=o.anchorY*h,p=a.insetLeft,d=a.insetRight,f=c.width-p-d,m=a.insetTop,g=a.insetBottom,v=c.height-m-g,y=o.width/(p+d)>1?1:o.width/(p+d),x=o.height/(m+g)>1?1:o.height/(m+g);let S=0,b=0;S=f>0?Math.floor(1e3*t)/1e3%f==0?f:t%f:t,b=v>0?Math.floor(1e3*i)/1e3%v==0?v:i%v:i;for(let e=0;e<=s;e++)0===e?r[e].x=-u:e>0&&e<s?r[e].x=1===e?p*y+Math.min(f,t)-u:f>0?e===s-1?p+S+f*(e-2)-u:p+Math.min(f,t)+f*(e-2)-u:p+t-u:e===s&&(r[e].x=Math.min(p+t+d,l)-u);for(let e=0;e<=n;e++)0===e?r[e].y=-_:e>0&&e<n?r[e].y=1===e?g*x+Math.min(v,i)-_:v>0?e===n-1?g+b+(e-2)*v-_:g+Math.min(v,i)+(e-2)*v-_:g+i-_:e===n&&(r[e].y=Math.min(g+i+m,h)-_)},updateColor(e){const t=e.renderData.data,i=t.length;if(0===i)return;const n=e.color,s=n.r,o=n.g,r=n.b,a=255*e.node._uiProps.opacity;for(let e=0;e<i;e++)t[e].color.r=s,t[e].color.g=o,t[e].color.b=r,t[e].color.a=a}},K$=Oq.Type,$$=Oq.FillType,Q$=e("spriteAssembler",{getAssembler(e){let t=V$;const i=e;switch(i.type){case K$.SLICED:t=q$;break;case K$.TILED:t=Y$;break;case K$.FILLED:t=i.fillType===$$.RADIAL?k$:w$}return t}});Oq.Assembler=Q$;const Z$=CH.sharedManager,J$={createData(e){const t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData(e){e.type===wW.IMAGE_STENCIL&&(V$.updateRenderData(e),V$.updateColor(e))},fillBuffers(e,t){(e.type!==wW.IMAGE_STENCIL||e.spriteFrame)&&(Z$.pushMask(e),t.finishMergeBatches(),function(e,t){Z$.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(Z$.enterLevel(e),e.type===wW.IMAGE_STENCIL){V$.fillBuffers(e,t);const i=e.graphics.getMaterialInstance(0);t.forceMergeBatches(i,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),Z$.enableMask())}},eQ={fillBuffers(e,t){Z$.exitMask()}},tQ={getAssembler:()=>J$},iQ={getAssembler:()=>eQ};AW.Assembler=tQ,AW.PostAssembler=iQ;const nQ=new ar(null),sQ=new Zi;class oQ{get currBufferBatch(){return this._currMeshBuffer||(this._currMeshBuffer=this.acquireBufferBatch()),this._currMeshBuffer}set currBufferBatch(e){e&&(this._currMeshBuffer=e)}get batches(){return this._batches}acquireBufferBatch(e=Sj){const t=e===Sj?36:Ej(e);return this._currMeshBuffer&&this._currMeshBuffer.vertexFormatBytes===t||this._requireBufferBatch(e),this._currMeshBuffer}registerCustomBuffer(e,t){let i;e instanceof VX?i=e:(i=this._bufferBatchPool.add(),i.initialize(e,t||this._recreateMeshBuffer.bind(this,e)));const n=i.vertexFormatBytes;let s=this._customMeshBuffers.get(n);return s||(s=[],this._customMeshBuffers.set(n,s)),s.push(i),i}unRegisterCustomBuffer(e){const t=this._customMeshBuffers.get(e.vertexFormatBytes);if(t)for(let i=0;i<t.length;i++)if(t[i]===e){t.splice(i,1);break}const i=this._bufferBatchPool.data.indexOf(e);-1!==i&&(e.reset(),this._bufferBatchPool.removeAt(i))}set currStaticRoot(e){this._currStaticRoot=e}set currIsStatic(e){this._currIsStatic=e}constructor(e){this.device=void 0,this._screens=[],this._bufferBatchPool=new U((()=>new VX(this)),128),this._drawBatchPool=void 0,this._meshBuffers=new Map,this._customMeshBuffers=new Map,this._meshBufferUseCount=new Map,this._batches=void 0,this._doUploadBuffersCall=new Map,this._emptyMaterial=new Wg,this._currScene=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currBlendTargetHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currOpacity=1,this._descriptorSetCache=new aQ,this._root=e,this.device=e.device,this._batches=new G(64),this._drawBatchPool=new F((()=>new WX),128)}initialize(){return!0}destroy(){for(let e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy();for(const e of this._meshBuffers.keys()){const t=this._meshBuffers.get(e);t&&t.forEach((e=>e.destroy()))}this._drawBatchPool&&this._drawBatchPool.destroy((e=>{e.destroy(this)})),this._descriptorSetCache.destroy(),this._meshBuffers.clear(),CH.sharedManager.destroy()}addScreen(e){this._screens.push(e),this._screens.sort(this._screenSort)}getFirstRenderCamera(e){if(e.scene&&e.scene.renderScene){const t=e.scene.renderScene.cameras;for(let i=0;i<t.length;i++){const n=t[i];if(n.visibility&e.layer)return n}}return null}removeScreen(e){const t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)}sortScreens(){this._screens.sort(this._screenSort)}addUploadBuffersFunc(e,t){this._doUploadBuffersCall.set(e,t)}removeUploadBuffersFunc(e){this._doUploadBuffersCall.delete(e)}update(){const e=this._screens;for(let t=0;t<e.length;++t){const i=e[t];i.enabledInHierarchy&&(this._currOpacity=1,this._recursiveScreenNode(i.node))}let t=0;if(this._batches.length)for(let e=0;e<this._batches.length;++e){const i=this._batches.array[e];if(i.renderScene){if(i.model){const e=i.model.subModels;for(let i=0;i<e.length;i++)e[i].priority=t++}else i.descriptorSet=this._descriptorSetCache.getDescriptorSet(i);i.renderScene.addBatch(i)}}}uploadBuffers(){this._batches.length>0&&(this._doUploadBuffersCall.forEach(((e,t)=>{e.call(t,this)})),this._meshBuffers.forEach((e=>{e.forEach((e=>{e.uploadBuffers(),e.reset()}))})),this._customMeshBuffers.forEach((e=>{e.forEach((e=>{e.uploadBuffers(),e.reset()}))})),this._descriptorSetCache.update())}reset(){for(let e=0;e<this._batches.length;++e){const t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._currLayer=0,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._currScene=null,this._currMeshBuffer=null,this._currOpacity=1,this._meshBufferUseCount.clear(),this._batches.clear(),CH.sharedManager.reset(),this._descriptorSetCache.reset()}commitComp(e,t,i,n){const s=e;let o,r,a=0,c=0;t?(o=t.getGFXTexture(),r=t.getGFXSampler(),a=t.getHash(),c=t.getSamplerHash()):(o=null,r=null);const l=s._getRenderScene(),h=s.getRenderMaterial(0);s.stencilStage=CH.sharedManager.stage;const u=s.blendHash,_=s.stencilStage;this._currScene===l&&this._currLayer===e.node.layer&&this._currMaterial===h&&this._currBlendTargetHash===u&&this._currDepthStencilStateStage===_&&this._currTextureHash===a&&this._currSamplerHash===c&&this._currTransform===n||(this.autoMergeBatches(this._currComponent),this._currScene=l,this._currComponent=s,this._currTransform=n,this._currMaterial=h,this._currTexture=o,this._currSampler=r,this._currTextureHash=a,this._currSamplerHash=c,this._currBlendTargetHash=u,this._currDepthStencilStateStage=_,this._currLayer=e.node.layer),i&&i.fillBuffers(s,this)}commitModel(e,t,i){let s;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);let o=0;i&&(e.stencilStage!==TH.ENABLED&&e.stencilStage!==TH.DISABLED||(e.stencilStage=CH.sharedManager.stage),s=CH.sharedManager.getStencilStage(e.stencilStage,i),o=CH.sharedManager.getStencilHash(e.stencilStage));const r=n.director.getTotalFrames();t&&(t.updateTransform(r),t.updateUBOs(r));for(let n=0;n<t.subModels.length;n++){const r=this._drawBatchPool.alloc(),a=t.subModels[n];r.renderScene=e._getRenderScene(),r.visFlags=e.node.layer,r.model=t,r.bufferBatch=null,r.texture=null,r.sampler=null,r.useLocalData=null,s||(s=null),r.fillPasses(i,s,o,null,0,a.patches),r.descriptorSet=a.descriptorSet,r.inputAssembler=a.inputAssembler,r.model.visFlags=r.visFlags,this._batches.push(r)}this._currMaterial=this._emptyMaterial,this._currScene=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}commitStaticBatch(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()}autoMergeBatches(e){const t=this.currBufferBatch,i=null==t?void 0:t.recordBatch(),n=this._currMaterial;if(!i||!n||!t)return;let s,o,r=0,a=0;e&&(s=-1===e.blendHash?null:e.getBlendState(),a=e.blendHash,o=null!==e.customMaterial?CH.sharedManager.getStencilStage(e.stencilStage,n):CH.sharedManager.getStencilStage(e.stencilStage),r=CH.sharedManager.getStencilHash(e.stencilStage));const c=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();c.renderScene=this._currScene,c.visFlags=this._currLayer,c.bufferBatch=t,c.texture=this._currTexture,c.sampler=this._currSampler,c.inputAssembler=i,c.useLocalData=this._currTransform,c.textureHash=this._currTextureHash,c.samplerHash=this._currSamplerHash,c.fillPasses(n,o,r,s,a,null),this._batches.push(c),t.vertexStart=t.vertexOffset,t.indicesStart=t.indicesOffset,t.byteStart=t.byteOffset,xn.__isWebIOS14OrIPadOS14Env&&!this._currIsStatic&&(this._currMeshBuffer=null)}forceMergeBatches(e,t,i){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=t.getSamplerHash()):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=i.node.layer,this._currScene=i._getRenderScene(),this.autoMergeBatches(i)}finishMergeBatches(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}flushMaterial(e){this._currMaterial=e}walk(e,t=0){const i=e.children.length;if(this._preProcess(e),i>0&&!e._static){const i=e.children;for(let n=0;n<i.length;++n){this._currOpacity=e._uiProps.opacity;const s=i[n];this.walk(s,t)}}this._postProcess(e),t+=1}_preProcess(e){const t=e._uiProps.uiComp,i=e._uiProps.localOpacity;e._uiProps.opacity=this._currOpacity*i,e._uiProps.uiTransformComp&&t&&t.enabledInHierarchy&&t.updateAssembler(this)}_postProcess(e){const t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}_recursiveScreenNode(e){this.walk(e),this.autoMergeBatches(this._currComponent)}_createMeshBuffer(e){const t=this._bufferBatchPool.add();t.initialize(e,this._recreateMeshBuffer.bind(this,e));const i=Ej(e);let n=this._meshBuffers.get(i);return n||(n=[],this._meshBuffers.set(i,n)),n.push(t),t}_recreateMeshBuffer(e,t,i){this.autoMergeBatches(),this._requireBufferBatch(e,t,i)}_requireBufferBatch(e,t,i){const n=Ej(e);let s=this._meshBuffers.get(n);s||(s=[],this._meshBuffers.set(n,s));let o=this._meshBufferUseCount.get(n)||0;(t&&i||xn.__isWebIOS14OrIPadOS14Env)&&o++,this._currMeshBuffer=s[o],this._currMeshBuffer||(this._currMeshBuffer=this._createMeshBuffer(e)),this._meshBufferUseCount.set(n,o),t&&i&&this._currMeshBuffer.request(t,i)}_screenSort(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()}_releaseDescriptorSetCache(e){this._descriptorSetCache.releaseDescriptorSetCache(e)}}e("UI",oQ);class rQ{get descriptorSet(){return this._descriptorSet}constructor(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;const e=n.director.root.device;this._localData=new Float32Array(Hd.COUNT),this._localBuffer=e.createBuffer(new Io(Fs.UNIFORM|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,Hd.SIZE,Hd.SIZE))}initialize(e){const t=n.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,nQ.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(nQ),this._descriptorSet.bindBuffer(Hd.BINDING,this._localBuffer);const i=hd.SAMPLER_SPRITE;this._descriptorSet.bindTexture(i,e.texture),this._descriptorSet.bindSampler(i,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0}updateTransform(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())}updateLocal(){this._transform&&this.uploadLocalData()}equals(e,t,i){return this._transform===e&&this._textureHash===t&&this._samplerHash===i}reset(){this._transform=null,this._textureHash=0,this._samplerHash=0}destroy(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null}uploadLocalData(){const e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&e.updateWorldTransform(),this._transformUpdate){const t=e._mat;Zi.toArray(this._localData,t,Hd.MAT_WORLD_OFFSET),Zi.inverseTranspose(sQ,t),Zi.toArray(this._localData,sQ,Hd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}class aQ{constructor(){this._descriptorSetCache=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new F((()=>new rQ),16)}getDescriptorSet(e){const t=n.director.root;if(e.useLocalData){const t=this._localDescriptorSetCache;for(let i=0,n=t.length;i<n;i++){const n=t[i];if(n.equals(e.useLocalData,e.textureHash,e.samplerHash))return n.descriptorSet}const i=this._localCachePool.alloc();return i.initialize(e),this._localDescriptorSetCache.push(i),i.descriptorSet}{const i=this._descriptorSetCache.get(e.textureHash);if(i&&i.has(e.samplerHash))return i.get(e.samplerHash);{n.director.root.device,nQ.layout=e.passes[0].localSetLayout;const s=t.device.createDescriptorSet(nQ),o=hd.SAMPLER_SPRITE;return s.bindTexture(o,e.texture),s.bindSampler(o,e.sampler),s.update(),i?this._descriptorSetCache.get(e.textureHash).set(e.samplerHash,s):this._descriptorSetCache.set(e.textureHash,new Map([[e.samplerHash,s]])),s}}}update(){this._localDescriptorSetCache.forEach((e=>{e.updateLocal()}))}reset(){this._localDescriptorSetCache.forEach((e=>{this._localCachePool.free(e)})),this._localDescriptorSetCache.length=0}releaseDescriptorSetCache(e){this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).forEach((e=>{e.destroy()})),this._descriptorSetCache.delete(e))}destroy(){this._descriptorSetCache.forEach((e=>{e.forEach((e=>{e.destroy()}))})),this._descriptorSetCache.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy((e=>{e.destroy()}))}}n.internal.Batcher2D=oQ;let cQ=null,lQ=-1;const hQ="BES bswy:->@123丁ぁᄁ",uQ=Object.create(null),_Q=[],pQ=3e3,dQ=(()=>{let e;return()=>{if(void 0===e)if("FontFace"in window){const t=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),i=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);e=t?parseInt(t[1],10)>42:!i}else e=!1;return e}})();function fQ(){let e=!0;const t=Date.now();for(let i=_Q.length-1;i>=0;i--){const n=_Q[i],s=n.fontFamilyName;if(t-n.startTime>pQ){T(4933,s),n.onComplete(null,s),_Q.splice(i,1);continue}const o=n.refWidth,r=`40px ${s}`;cQ.font=r,o!==Fk(cQ,hQ,r)?(_Q.splice(i,1),n.onComplete(null,s)):e=!1}e&&(clearInterval(lQ),lQ=-1)}function mQ(e,t,i){const n=function(e){const t=e.lastIndexOf(".ttf");if(-1===t)return e;const i=e.lastIndexOf("/");let n;return n=-1===i?`${e.substring(0,t)}_LABEL`:`${e.substring(i+1,t)}_LABEL`,-1!==n.indexOf(" ")&&(n=`"${n}"`),n}(e);if(uQ[n])return void i(null,n);if(!cQ){const e=document.createElement("canvas");e.width=100,e.height=100,cQ=e.getContext("2d")}const s=Fk(cQ,hQ,`40px ${n}`),o=document.createElement("style");o.type="text/css";let r="";Number.isNaN(n)?r+=`@font-face { font-family:${n}; src:`:r+=`@font-face { font-family:"${n}"; src:`,r+=`url("${e}");`,o.textContent=`${r}}`,document.body.appendChild(o);const a=document.createElement("div"),c=a.style;if(c.fontFamily=n,a.innerHTML=".",c.position="absolute",c.left="-100px",c.top="-100px",document.body.appendChild(a),dQ())!function(e,t,i){const n=new Promise(((i,n)=>{const s=()=>{Date.now()-e>=pQ?n():document.fonts.load(`40px ${t}`).then((e=>{e.length>=1?i():setTimeout(s,100)}),(()=>{n()}))};s()}));let s=null;const o=new Promise(((e,t)=>{s=setTimeout(t,pQ)}));Promise.race([o,n]).then((()=>{s&&(clearTimeout(s),s=null),i(null,t)}),(()=>{T(4933,t),i(null,t)}))}(Date.now(),n,i);else{const e={fontFamilyName:n,refWidth:s,onComplete:i,startTime:Date.now()};_Q.push(e),-1===lQ&&(lQ=setInterval(fQ,100))}uQ[n]=o}function gQ(e,t,i,n){const s=new pk;s._nativeUrl=e,s._nativeAsset=t,n(null,s)}var vQ,yQ,xQ,SQ,bQ,TQ,EQ,CQ,wQ,AQ,PQ,RQ,IQ,MQ,OQ,DQ,NQ,LQ,BQ,zQ,FQ,UQ,GQ,kQ,HQ,VQ,jQ,WQ,qQ,XQ,YQ,KQ,$Q,QQ,ZQ,JQ,eZ,tZ,iZ,nZ,sZ,oZ,rZ,aZ,cZ,lZ,hZ,uZ,_Z,pZ;OA.register({".font":mQ,".eot":mQ,".ttf":mQ,".woff":mQ,".svg":mQ,".ttc":mQ}),UA.register({".font":gQ,".eot":gQ,".ttf":gQ,".woff":gQ,".svg":gQ,".ttc":gQ}),n.UI={MeshBuffer:VX,spriteAssembler:Q$,graphicsAssembler:eK,labelAssembler:b$};const dZ=new Di;var fZ,mZ;let gZ;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(fZ||(fZ={})),Fe(fZ),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(mZ||(mZ={})),function(e){e.CLICK="click"}(gZ||(gZ={}));let vZ,yZ,xZ,SZ=function(t){return e({Button:t,ButtonComponent:t}),t}((vQ=Wc("cc.Button"),yQ=al(),xQ=Xc(110),SQ=nl(),bQ=qc(EH),TQ=Al(ix),EQ=vl(),CQ=_l(),wQ=vl(),AQ=_l(),PQ=Al(fZ),RQ=vl(),IQ=_l(),MQ=_l(),OQ=_l(),DQ=_l(),NQ=_l(),LQ=dl(),BQ=fl(),zQ=_l(),FQ=_l(),UQ=Al(nk),GQ=_l(),kQ=Al(nk),HQ=_l(),VQ=Al(nk),jQ=_l(),WQ=Al(nk),qQ=_l(),XQ=Al([TP]),YQ=vl(),KQ=_l(),vQ($Q=yQ($Q=xQ($Q=SQ($Q=bQ($Q=il((pZ=_Z=class extends Gh{constructor(...e){super(...e),Mc(this,"clickEvents",ZQ,this),Mc(this,"_interactable",JQ,this),Mc(this,"_transition",eZ,this),Mc(this,"_normalColor",tZ,this),Mc(this,"_hoverColor",iZ,this),Mc(this,"_pressedColor",nZ,this),Mc(this,"_disabledColor",sZ,this),Mc(this,"_normalSprite",oZ,this),Mc(this,"_hoverSprite",rZ,this),Mc(this,"_pressedSprite",aZ,this),Mc(this,"_disabledSprite",cZ,this),Mc(this,"_duration",lZ,this),Mc(this,"_zoomScale",hZ,this),Mc(this,"_target",uZ,this),this._pressed=!1,this._hovered=!1,this._fromColor=new Di,this._toColor=new Di,this._time=0,this._transitionFinished=!0,this._fromScale=new zi,this._toScale=new zi,this._originalScale=null,this._sprite=null,this._targetScale=new zi}get target(){return this._target||this.node}set target(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}get interactable(){return this._interactable}set interactable(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}set _resizeToTarget(e){e&&this._resizeNodeToTargetNode()}get transition(){return this._transition}set transition(e){this._transition!==e&&(this._transition===fZ.COLOR?this._updateColorTransition(mZ.NORMAL):this._transition===fZ.SPRITE&&this._updateSpriteTransition(mZ.NORMAL),this._transition=e,this._updateState())}get normalColor(){return this._normalColor}set normalColor(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}get pressedColor(){return this._pressedColor}set pressedColor(e){this._pressedColor!==e&&this._pressedColor.set(e)}get hoverColor(){return this._hoverColor}set hoverColor(e){this._hoverColor!==e&&this._hoverColor.set(e)}get disabledColor(){return this._disabledColor}set disabledColor(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}get duration(){return this._duration}set duration(e){this._duration!==e&&(this._duration=e)}get zoomScale(){return this._zoomScale}set zoomScale(e){this._zoomScale!==e&&(this._zoomScale=e)}get normalSprite(){return this._normalSprite}set normalSprite(e){if(this._normalSprite===e)return;this._normalSprite=e;const t=this.node.getComponent(Oq);t&&(t.spriteFrame=e),this._updateState()}get pressedSprite(){return this._pressedSprite}set pressedSprite(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}get hoverSprite(){return this._hoverSprite}set hoverSprite(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}get disabledSprite(){return this._disabledSprite}set disabledSprite(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}__preload(){this.target||(this.target=this.node);const e=this.node.getComponent(Oq);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()}onEnable(){this._registerNodeEvent()}onDisable(){this._resetState(),this._unregisterNodeEvent()}onDestroy(){this.target.isValid&&this._unregisterTargetEvent(this.target)}update(e){const t=this.target;if(this._transitionFinished||!t)return;if(this._transition!==fZ.COLOR&&this._transition!==fZ.SCALE)return;this._time+=e;let i=1;if(this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1),this._transition===fZ.COLOR){const e=t._uiProps.uiComp;Di.lerp(dZ,this._fromColor,this._toColor,i),e&&(e.color=dZ)}else this.transition===fZ.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=mi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=mi(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale));1===i&&(this._transitionFinished=!0)}_resizeNodeToTargetNode(){this.target&&this.target._uiProps.uiTransformComp}_resetState(){this._pressed=!1,this._hovered=!1;const e=this.target;if(!e)return;const t=this._transition;if(t===fZ.COLOR&&this._interactable){const t=e.getComponent(WH);t&&(t.color=this._normalColor)}else t===fZ.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}_registerNodeEvent(){this.node.on(cy.TOUCH_START,this._onTouchBegan,this),this.node.on(cy.TOUCH_MOVE,this._onTouchMove,this),this.node.on(cy.TOUCH_END,this._onTouchEnded,this),this.node.on(cy.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(cy.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(cy.MOUSE_LEAVE,this._onMouseMoveOut,this)}_registerTargetEvent(e){e.on(cy.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}_unregisterNodeEvent(){this.node.off(cy.TOUCH_START,this._onTouchBegan,this),this.node.off(cy.TOUCH_MOVE,this._onTouchMove,this),this.node.off(cy.TOUCH_END,this._onTouchEnded,this),this.node.off(cy.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(cy.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(cy.MOUSE_LEAVE,this._onMouseMoveOut,this)}_unregisterTargetEvent(e){e.off(cy.TRANSFORM_CHANGED)}_getTargetSprite(e){let t=null;return e&&(t=e.getComponent(Oq)),t}_applyTarget(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new zi),zi.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))}_onTargetSpriteFrameChanged(e){this._transition===fZ.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)}_setCurrentStateSpriteFrame(e){if(e)switch(this._getButtonState()){case mZ.NORMAL:this._normalSprite=e;break;case mZ.HOVER:this._hoverSprite=e;break;case mZ.PRESSED:this._pressedSprite=e;break;case mZ.DISABLED:this._disabledSprite=e}}_onTargetColorChanged(e){this._transition===fZ.COLOR&&this._setCurrentStateColor(e)}_setCurrentStateColor(e){switch(this._getButtonState()){case mZ.NORMAL:this._normalColor=e;break;case mZ.HOVER:this._hoverColor=e;break;case mZ.PRESSED:this._pressedColor=e;break;case mZ.DISABLED:this._disabledColor=e}}_onTargetTransformChanged(e){e&Cg.SCALE&&this._originalScale&&this._transition===fZ.SCALE&&this._transitionFinished&&zi.copy(this._originalScale,this.target.getScale())}_onTouchBegan(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}_onTouchMove(e){if(!this._interactable||!this.enabledInHierarchy||!this._pressed)return;if(!e)return;const t=e.touch;if(!t)return;const i=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());if(this._transition===fZ.SCALE&&this.target&&this._originalScale)i?(zi.copy(this._fromScale,this._originalScale),zi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale));else{let e;e=i?mZ.PRESSED:mZ.NORMAL,this._applyTransition(e)}e&&(e.propagationStopped=!0)}_onTouchEnded(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(TP.emitEvents(this.clickEvents,e),this.node.emit(gZ.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}_onTouchCancel(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}_onMouseMoveIn(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==fZ.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}_onMouseMoveOut(e){this._hovered&&(this._hovered=!1,this._updateState())}_updateState(){const e=this._getButtonState();this._applyTransition(e)}_getButtonState(){let e=mZ.NORMAL;return this._interactable?this._pressed?e=mZ.PRESSED:this._hovered&&(e=mZ.HOVER):e=mZ.DISABLED,e.toString()}_updateColorTransition(e){var t;const i=this[`${e}Color`],n=null===(t=this.target)||void 0===t?void 0:t.getComponent(WH);n&&(e===mZ.DISABLED?n.color=i:(this._fromColor=n.color.clone(),this._toColor=i,this._time=0,this._transitionFinished=!1))}_updateSpriteTransition(e){const t=this[`${e}Sprite`];this._sprite&&t&&(this._sprite.spriteFrame=t)}_updateScaleTransition(e){this._interactable&&(e===mZ.PRESSED?this._zoomUp():this._zoomBack())}_zoomUp(){this._originalScale&&(zi.copy(this._fromScale,this._originalScale),zi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}_zoomBack(){this.target&&this._originalScale&&(zi.copy(this._fromScale,this.target.getScale()),zi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}_applyTransition(e){const t=this._transition;t===fZ.COLOR?this._updateColorTransition(e):t===fZ.SPRITE?this._updateSpriteTransition(e):t===fZ.SCALE&&this._updateScaleTransition(e)}},_Z.Transition=fZ,_Z.EventType=gZ,Oc((QQ=pZ).prototype,"target",[TQ,EQ,CQ],Object.getOwnPropertyDescriptor(QQ.prototype,"target"),QQ.prototype),Oc(QQ.prototype,"interactable",[wQ,AQ],Object.getOwnPropertyDescriptor(QQ.prototype,"interactable"),QQ.prototype),Oc(QQ.prototype,"transition",[PQ,RQ,IQ],Object.getOwnPropertyDescriptor(QQ.prototype,"transition"),QQ.prototype),Oc(QQ.prototype,"normalColor",[MQ],Object.getOwnPropertyDescriptor(QQ.prototype,"normalColor"),QQ.prototype),Oc(QQ.prototype,"pressedColor",[OQ],Object.getOwnPropertyDescriptor(QQ.prototype,"pressedColor"),QQ.prototype),Oc(QQ.prototype,"hoverColor",[DQ],Object.getOwnPropertyDescriptor(QQ.prototype,"hoverColor"),QQ.prototype),Oc(QQ.prototype,"disabledColor",[NQ],Object.getOwnPropertyDescriptor(QQ.prototype,"disabledColor"),QQ.prototype),Oc(QQ.prototype,"duration",[LQ,BQ,zQ],Object.getOwnPropertyDescriptor(QQ.prototype,"duration"),QQ.prototype),Oc(QQ.prototype,"zoomScale",[FQ],Object.getOwnPropertyDescriptor(QQ.prototype,"zoomScale"),QQ.prototype),Oc(QQ.prototype,"normalSprite",[UQ,GQ],Object.getOwnPropertyDescriptor(QQ.prototype,"normalSprite"),QQ.prototype),Oc(QQ.prototype,"pressedSprite",[kQ,HQ],Object.getOwnPropertyDescriptor(QQ.prototype,"pressedSprite"),QQ.prototype),Oc(QQ.prototype,"hoverSprite",[VQ,jQ],Object.getOwnPropertyDescriptor(QQ.prototype,"hoverSprite"),QQ.prototype),Oc(QQ.prototype,"disabledSprite",[WQ,qQ],Object.getOwnPropertyDescriptor(QQ.prototype,"disabledSprite"),QQ.prototype),ZQ=Oc(QQ.prototype,"clickEvents",[XQ,Qc,YQ,KQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JQ=Oc(QQ.prototype,"_interactable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eZ=Oc(QQ.prototype,"_transition",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fZ.NONE}}),tZ=Oc(QQ.prototype,"_normalColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),iZ=Oc(QQ.prototype,"_hoverColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(211,211,211,255)}}),nZ=Oc(QQ.prototype,"_pressedColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),sZ=Oc(QQ.prototype,"_disabledColor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(124,124,124,255)}}),oZ=Oc(QQ.prototype,"_normalSprite",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rZ=Oc(QQ.prototype,"_hoverSprite",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aZ=Oc(QQ.prototype,"_pressedSprite",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cZ=Oc(QQ.prototype,"_disabledSprite",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lZ=Oc(QQ.prototype,"_duration",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),hZ=Oc(QQ.prototype,"_zoomScale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),uZ=Oc(QQ.prototype,"_target",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$Q=QQ))||$Q)||$Q)||$Q)||$Q)||$Q)||$Q));(function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"})(vZ||(vZ={})),Le(vZ),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(yZ||(yZ={})),Le(yZ),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(xZ||(xZ={})),Le(xZ);var bZ,TZ,EZ,CZ,wZ,AZ,PZ,RZ,IZ,MZ,OZ,DZ,NZ,LZ,BZ,zZ,FZ,UZ,GZ,kZ,HZ,VZ,jZ,WZ,qZ,XZ,YZ,KZ,$Z,QZ,ZZ,JZ,eJ,tJ,iJ,nJ,sJ,oJ,rJ,aJ,cJ,lJ,hJ,uJ,_J,pJ,dJ,fJ,mJ,gJ,vJ,yJ,xJ,SJ,bJ,TJ,EJ,CJ,wJ,AJ,PJ;new Zi,new Zi,new zi,function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(PJ||(PJ={}));let RJ=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((bZ=Wc("cc.EditBox"),TZ=al(),EZ=Xc(110),CZ=nl(),wZ=qc(EH),AZ=vl(),PZ=_l(),RZ=vl(),IZ=_l(),MZ=Al(oj),OZ=vl(),DZ=_l(),NZ=Al(oj),LZ=vl(),BZ=_l(),zZ=Al(nk),FZ=vl(),UZ=_l(),GZ=Al(xZ),kZ=vl(),HZ=_l(),VZ=Al(yZ),jZ=vl(),WZ=_l(),qZ=Al(vZ),XZ=vl(),YZ=_l(),KZ=vl(),$Z=_l(),QZ=vl(),ZZ=_l(),JZ=Al([TP]),eJ=vl(),tJ=_l(),iJ=Al([TP]),nJ=vl(),sJ=_l(),oJ=Al([TP]),rJ=vl(),aJ=_l(),cJ=Al([TP]),lJ=vl(),hJ=_l(),bZ(uJ=TZ(uJ=EZ(uJ=CZ(uJ=wZ(uJ=il((AJ=wJ=class e extends Gh{constructor(...e){super(...e),Mc(this,"editingDidBegan",pJ,this),Mc(this,"textChanged",dJ,this),Mc(this,"editingDidEnded",fJ,this),Mc(this,"editingReturn",mJ,this),this._impl=null,this._background=null,Mc(this,"_textLabel",gJ,this),Mc(this,"_placeholderLabel",vJ,this),Mc(this,"_returnType",yJ,this),Mc(this,"_string",xJ,this),Mc(this,"_tabIndex",SJ,this),Mc(this,"_backgroundImage",bJ,this),Mc(this,"_inputFlag",TJ,this),Mc(this,"_inputMode",EJ,this),Mc(this,"_maxLength",CJ,this),this._isLabelVisible=!1}get string(){return this._string}set string(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}get placeholder(){return this._placeholderLabel?this._placeholderLabel.string:""}set placeholder(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}get textLabel(){return this._textLabel}set textLabel(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}get placeholderLabel(){return this._placeholderLabel}set placeholderLabel(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}get backgroundImage(){return this._backgroundImage}set backgroundImage(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}get inputFlag(){return this._inputFlag}set inputFlag(e){this._inputFlag=e,this._updateString(this._string)}get inputMode(){return this._inputMode}set inputMode(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}get returnType(){return this._returnType}set returnType(e){this._returnType=e}get maxLength(){return this._maxLength}set maxLength(e){this._maxLength=e}get tabIndex(){return this._tabIndex}set tabIndex(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}__preload(){this._init()}onEnable(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()}update(){this._impl&&this._impl.update()}onDisable(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()}onDestroy(){this._impl&&this._impl.clear()}setFocus(){this._impl&&this._impl.setFocus(!0)}focus(){this._impl&&this._impl.setFocus(!0)}blur(){this._impl&&this._impl.setFocus(!1)}isFocused(){return!!this._impl&&this._impl.isFocused()}_editBoxEditingDidBegan(){TP.emitEvents(this.editingDidBegan,this),this.node.emit(PJ.EDITING_DID_BEGAN,this)}_editBoxEditingDidEnded(){TP.emitEvents(this.editingDidEnded,this),this.node.emit(PJ.EDITING_DID_ENDED,this)}_editBoxTextChanged(e){e=this._updateLabelStringStyle(e,!0),this.string=e,TP.emitEvents(this.textChanged,e,this),this.node.emit(PJ.TEXT_CHANGED,this)}_editBoxEditingReturn(){TP.emitEvents(this.editingReturn,this),this.node.emit(PJ.EDITING_RETURN,this)}_showLabels(){this._isLabelVisible=!0,this._updateLabels()}_hideLabels(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}_onTouchBegan(e){e.propagationStopped=!0}_onTouchCancel(e){e.propagationStopped=!0}_onTouchEnded(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0}_init(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(cy.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new e._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}_ensureBackgroundSprite(){if(!this._background){let e=this.node.getComponent(Oq);e||(e=this.node.addComponent(Oq)),e!==this._background&&(e.type=Oq.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}}_updateTextLabel(){let e=this._textLabel;if(!e){let t=this.node.getChildByName("TEXT_LABEL");t||(t=new ix("TEXT_LABEL")),e=t.getComponent(oj),e||(e=t.addComponent(oj)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=oj.Overflow.CLAMP,this._inputMode===yZ.ANY?(e.verticalAlign=JV.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)}_updatePlaceholderLabel(){let e=this._placeholderLabel;if(!e){let t=this.node.getChildByName("PLACEHOLDER_LABEL");t||(t=new ix("PLACEHOLDER_LABEL")),e=t.getComponent(oj),e||(e=t.addComponent(oj)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=oj.Overflow.CLAMP,this._inputMode===yZ.ANY?(e.verticalAlign=JV.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this.placeholder}_syncSize(){const e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){const i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=e.anchorPoint,i.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)}_updateLabels(){if(this._isLabelVisible){const e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}_updateString(e){const t=this._textLabel;if(!t)return;let i=e;i&&(i=this._updateLabelStringStyle(i)),t.string=i,this._updateLabels()}_updateLabelStringStyle(e,t=!1){const i=this._inputFlag;if(t||i!==xZ.PASSWORD)i===xZ.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===xZ.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(e=>e.toUpperCase())):i===xZ.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{let t="";const i=e.length;for(let e=0;e<i;++e)t+="●";e=t}var n;return e}_registerEvent(){this.node.on(cy.TOUCH_START,this._onTouchBegan,this),this.node.on(cy.TOUCH_END,this._onTouchEnded,this)}_unregisterEvent(){this.node.off(cy.TOUCH_START,this._onTouchBegan,this),this.node.off(cy.TOUCH_END,this._onTouchEnded,this)}_onBackgroundSpriteFrameChanged(){this._background&&(this.backgroundImage=this._background.spriteFrame)}_registerBackgroundEvent(){const e=this._background&&this._background.node;null==e||e.on(Oq.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)}_unregisterBackgroundEvent(){const e=this._background&&this._background.node;null==e||e.off(Oq.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)}_updateLabelPosition(e){const t=this.node._uiProps.uiTransformComp,i=-t.anchorX*t.width,n=-t.anchorY*t.height,s=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(i+2,n+e.height,o.node.position.z),this._inputMode===yZ.ANY&&(o.verticalAlign=JV.TOP),o.enableWrapText=this._inputMode===yZ.ANY),s&&(s.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),s.lineHeight=e.height,s.node.setPosition(i+2,n+e.height,s.node.position.z),this._inputMode===yZ.ANY&&(s.verticalAlign=JV.TOP),s.enableWrapText=this._inputMode===yZ.ANY)}_resizeChildNodes(){const e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));const i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.setPosition(-e.width/2,e.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(e.contentSize));const n=this._background&&this._background.node;n&&n._uiProps.uiTransformComp.setContentSize(e.contentSize)}},wJ._EditBoxImpl=class{constructor(){this._editing=!1,this._delegate=null}init(e){}onEnable(){}update(){}onDisable(){this._editing&&this.endEditing()}clear(){this._delegate=null}setTabIndex(e){}setSize(e,t){}setFocus(e){e?this.beginEditing():this.endEditing()}isFocused(){return this._editing}beginEditing(){}endEditing(){}},wJ.KeyboardReturnType=vZ,wJ.InputFlag=xZ,wJ.InputMode=yZ,wJ.EventType=PJ,Oc((_J=AJ).prototype,"string",[AZ,PZ],Object.getOwnPropertyDescriptor(_J.prototype,"string"),_J.prototype),Oc(_J.prototype,"placeholder",[RZ,IZ],Object.getOwnPropertyDescriptor(_J.prototype,"placeholder"),_J.prototype),Oc(_J.prototype,"textLabel",[MZ,OZ,DZ],Object.getOwnPropertyDescriptor(_J.prototype,"textLabel"),_J.prototype),Oc(_J.prototype,"placeholderLabel",[NZ,LZ,BZ],Object.getOwnPropertyDescriptor(_J.prototype,"placeholderLabel"),_J.prototype),Oc(_J.prototype,"backgroundImage",[zZ,FZ,UZ],Object.getOwnPropertyDescriptor(_J.prototype,"backgroundImage"),_J.prototype),Oc(_J.prototype,"inputFlag",[GZ,kZ,HZ],Object.getOwnPropertyDescriptor(_J.prototype,"inputFlag"),_J.prototype),Oc(_J.prototype,"inputMode",[VZ,jZ,WZ],Object.getOwnPropertyDescriptor(_J.prototype,"inputMode"),_J.prototype),Oc(_J.prototype,"returnType",[qZ,XZ,YZ],Object.getOwnPropertyDescriptor(_J.prototype,"returnType"),_J.prototype),Oc(_J.prototype,"maxLength",[KZ,$Z],Object.getOwnPropertyDescriptor(_J.prototype,"maxLength"),_J.prototype),Oc(_J.prototype,"tabIndex",[QZ,ZZ],Object.getOwnPropertyDescriptor(_J.prototype,"tabIndex"),_J.prototype),pJ=Oc(_J.prototype,"editingDidBegan",[JZ,Qc,eJ,tJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dJ=Oc(_J.prototype,"textChanged",[iJ,Qc,nJ,sJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fJ=Oc(_J.prototype,"editingDidEnded",[oJ,Qc,rJ,aJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mJ=Oc(_J.prototype,"editingReturn",[cJ,Qc,lJ,hJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gJ=Oc(_J.prototype,"_textLabel",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vJ=Oc(_J.prototype,"_placeholderLabel",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yJ=Oc(_J.prototype,"_returnType",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vZ.DEFAULT}}),xJ=Oc(_J.prototype,"_string",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SJ=Oc(_J.prototype,"_tabIndex",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bJ=Oc(_J.prototype,"_backgroundImage",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TJ=Oc(_J.prototype,"_inputFlag",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xZ.DEFAULT}}),EJ=Oc(_J.prototype,"_inputMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yZ.ANY}}),CJ=Oc(_J.prototype,"_maxLength",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),uJ=_J))||uJ)||uJ)||uJ)||uJ)||uJ)||uJ));var IJ,MJ,OJ,DJ,NJ,LJ,BJ,zJ,FJ,UJ,GJ,kJ,HJ,VJ,jJ,WJ,qJ,XJ,YJ,KJ,$J,QJ,ZJ,JJ,e0,t0,i0,n0,s0,o0,r0,a0,c0,l0,h0,u0,_0,p0,d0,f0,m0,g0,v0,y0,x0,S0,b0,T0,E0,C0,w0,A0,P0,R0,I0,M0,O0,D0,N0,L0;(function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"})(I0||(I0={})),Fe(I0),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(M0||(M0={})),Fe(M0),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(O0||(O0={})),Fe(O0),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(D0||(D0={})),Fe(D0),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(N0||(N0={})),Fe(N0),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(L0||(L0={})),Fe(L0);const B0=new zi;let z0=function(t){return e({Layout:t,LayoutComponent:t}),t}((IJ=Wc("cc.Layout"),MJ=al(),OJ=Xc(110),DJ=nl(),NJ=qc(EH),LJ=ll(),BJ=_l(),zJ=ll(),FJ=_l(),UJ=Al(I0),GJ=_l(),kJ=Al(M0),HJ=ll(),VJ=_l(),jJ=ll(),WJ=_l(),qJ=Al(O0),XJ=_l(),YJ=_l(),KJ=_l(),$J=_l(),QJ=_l(),ZJ=_l(),JJ=_l(),e0=Al(D0),t0=_l(),i0=Al(N0),n0=_l(),s0=Al(L0),o0=ll(),r0=_l(),a0=ll(),c0=_l(),l0=_l(),IJ(h0=MJ(h0=OJ(h0=DJ(h0=NJ(h0=il((R0=P0=class extends Gh{constructor(...e){super(...e),Mc(this,"_resizeMode",_0,this),Mc(this,"_layoutType",p0,this),Mc(this,"_cellSize",d0,this),Mc(this,"_startAxis",f0,this),Mc(this,"_paddingLeft",m0,this),Mc(this,"_paddingRight",g0,this),Mc(this,"_paddingTop",v0,this),Mc(this,"_paddingBottom",y0,this),Mc(this,"_spacingX",x0,this),Mc(this,"_spacingY",S0,this),Mc(this,"_verticalDirection",b0,this),Mc(this,"_horizontalDirection",T0,this),Mc(this,"_constraint",E0,this),Mc(this,"_constraintNum",C0,this),Mc(this,"_affectedByScale",w0,this),Mc(this,"_isAlign",A0,this),this._layoutSize=new hn(300,200),this._layoutDirty=!0,this._childrenDirty=!1,this._usefulLayoutObj=[],this._init=!1}get alignHorizontal(){return this._isAlign}set alignHorizontal(e){this._layoutType===I0.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}get alignVertical(){return this._isAlign}set alignVertical(e){this._layoutType===I0.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}get type(){return this._layoutType}set type(e){this._layoutType=e,this._doLayoutDirty()}get resizeMode(){return this._resizeMode}set resizeMode(e){this._layoutType!==I0.NONE&&(this._resizeMode=e,this._doLayoutDirty())}get cellSize(){return this._cellSize}set cellSize(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}get startAxis(){return this._startAxis}set startAxis(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}get paddingLeft(){return this._paddingLeft}set paddingLeft(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}get paddingRight(){return this._paddingRight}set paddingRight(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}get paddingTop(){return this._paddingTop}set paddingTop(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}get paddingBottom(){return this._paddingBottom}set paddingBottom(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}get spacingX(){return this._spacingX}set spacingX(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}get spacingY(){return this._spacingY}set spacingY(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}get verticalDirection(){return this._verticalDirection}set verticalDirection(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}get horizontalDirection(){return this._horizontalDirection}set horizontalDirection(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}get padding(){return this._paddingLeft}set padding(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}get constraint(){return this._constraint}set constraint(e){this._layoutType!==I0.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}get constraintNum(){return this._constraintNum}set constraintNum(e){this._constraint!==L0.NONE&&this._constraintNum!==e&&(e<=0&&p("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}get affectedByScale(){return this._affectedByScale}set affectedByScale(e){this._affectedByScale=e,this._doLayoutDirty()}updateLayout(e=!1){(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}onEnable(){this._addEventListeners();const e=this.node._uiProps.uiTransformComp;e.contentSize.equals(hn.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()}onDisable(){this._usefulLayoutObj.length=0,this._removeEventListeners()}_checkUsefulObj(){this._usefulLayoutObj.length=0;const e=this.node.children;for(let t=0;t<e.length;++t){const i=e[t],n=i._uiProps.uiTransformComp;i.activeInHierarchy&&n&&this._usefulLayoutObj.push(n)}}_addEventListeners(){Qw.on($w.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(cy.SIZE_CHANGED,this._resized,this),this.node.on(cy.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(cy.CHILD_ADDED,this._childAdded,this),this.node.on(cy.CHILD_REMOVED,this._childRemoved,this),this.node.on(cy.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()}_removeEventListeners(){Qw.off($w.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(cy.SIZE_CHANGED,this._resized,this),this.node.off(cy.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(cy.CHILD_ADDED,this._childAdded,this),this.node.off(cy.CHILD_REMOVED,this._childRemoved,this),this.node.off(cy.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()}_addChildrenEventListeners(){const e=this.node.children;for(let t=0;t<e.length;++t){const i=e[t];i.on(cy.SIZE_CHANGED,this._doLayoutDirty,this),i.on(cy.TRANSFORM_CHANGED,this._transformDirty,this),i.on(cy.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on("active-in-hierarchy-changed",this._childrenChanged,this)}}_removeChildrenEventListeners(){const e=this.node.children;for(let t=0;t<e.length;++t){const i=e[t];i.off(cy.SIZE_CHANGED,this._doLayoutDirty,this),i.off(cy.TRANSFORM_CHANGED,this._transformDirty,this),i.off(cy.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off("active-in-hierarchy-changed",this._childrenChanged,this)}}_childAdded(e){e.on(cy.SIZE_CHANGED,this._doLayoutDirty,this),e.on(cy.TRANSFORM_CHANGED,this._transformDirty,this),e.on(cy.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_childRemoved(e){e.off(cy.SIZE_CHANGED,this._doLayoutDirty,this),e.off(cy.TRANSFORM_CHANGED,this._transformDirty,this),e.off(cy.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_resized(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}_doLayoutHorizontally(e,t,i,n){const s=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum();let r=1,a=this._paddingLeft;this._horizontalDirection===N0.RIGHT_TO_LEFT&&(r=-1,a=this._paddingRight);const c=(this._horizontalDirection-s.x)*e+r*a;let l=c-r*this._spacingX,h=0,u=0,_=0,p=0,d=!1;const f=this._usefulLayoutObj.length;let m=this._cellSize.width;const g=this._getPaddingH();this._layoutType!==I0.GRID&&this._resizeMode===M0.CHILDREN&&(m=(e-g-(f-1)*this._spacingX)/f);const v=this._usefulLayoutObj;for(let a=0;a<v.length;++a){const f=v[a],y=f.node,x=y.scale,S=this._getUsedScaleValue(x.x),b=this._getUsedScaleValue(x.y);this._resizeMode===M0.CHILDREN&&(f.width=m/S,this._layoutType===I0.GRID&&(f.height=this._cellSize.height/b));const T=Math.abs(this._horizontalDirection-f.anchorX),E=f.width*S,C=f.height*b;C>_&&(p=Math.max(_,p),u=_||C,_=C),l+=r*(T*E+this._spacingX);const w=r*(1-T)*E;if(t){if(o>0)d=a/o>0&&a%o==0,d&&(u=_>C?_:u);else if(E>e-g)l>c+r*T*E&&(d=!0);else{const t=(1-this._horizontalDirection-s.x)*e,i=l+w+r*(r>0?this._paddingRight:this._paddingLeft);d=Math.abs(i)>Math.abs(t)}d&&(l=c+r*T*E,C!==_&&(u=_),h+=u+this._spacingY,u=_=C)}const A=i(y,f,h);n&&y.setPosition(l,A),l+=w}return u=Math.max(u,_),Math.max(p,h+u)+this._getPaddingV()}_doLayoutVertically(e,t,i,n){const s=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum();let r=1,a=this._paddingBottom;this._verticalDirection===D0.TOP_TO_BOTTOM&&(r=-1,a=this._paddingTop);const c=(this._verticalDirection-s.y)*e+r*a;let l=c-r*this._spacingY,h=0,u=0,_=0,p=0,d=!1;const f=this._usefulLayoutObj.length;let m=this._cellSize.height;const g=this._getPaddingV();this._layoutType!==I0.GRID&&this._resizeMode===M0.CHILDREN&&(m=(e-g-(f-1)*this._spacingY)/f);const v=this._usefulLayoutObj;for(let a=0;a<v.length;++a){const f=v[a],y=f.node,x=y.scale,S=this._getUsedScaleValue(x.x),b=this._getUsedScaleValue(x.y);this._resizeMode===M0.CHILDREN&&(f.height=m/b,this._layoutType===I0.GRID&&(f.width=this._cellSize.width/S));const T=Math.abs(this._verticalDirection-f.anchorY),E=f.width*S,C=f.height*b;E>h&&(u=Math.max(h,u),_=h||E,h=E),l+=r*(T*C+this._spacingY);const w=r*(1-T)*C;if(t){if(o>0)d=a/o>0&&a%o==0,d&&(_=h>C?h:_);else if(C>e-g)l>c+r*T*C&&(d=!0);else{const t=(1-this._verticalDirection-s.y)*e,i=l+w+r*(r>0?this._paddingTop:this._paddingBottom);d=Math.abs(i)>Math.abs(t)}d&&(l=c+r*T*C,E!==h&&(_=h),p+=_+this._spacingX,_=h=E)}const A=i(y,f,p);n&&(y.getPosition(B0),y.setPosition(A,l,B0.z)),l+=w}return _=Math.max(_,h),Math.max(u,p+_)+this._getPaddingH()}_doLayoutGridAxisHorizontal(e,t){const i=t.width;let n=1,s=-e.y*t.height,o=this._paddingBottom;this._verticalDirection===D0.TOP_TO_BOTTOM&&(n=-1,s=(1-e.y)*t.height,o=this._paddingTop);const r=(e,t,i)=>s+n*(i+(1-t.anchorY)*t.height*this._getUsedScaleValue(e.scale.y)+o);let a=0;this._resizeMode===M0.CONTAINER&&(a=this._doLayoutHorizontally(i,!0,r,!1),s=-e.y*a,this._verticalDirection===D0.TOP_TO_BOTTOM&&(n=-1,s=(1-e.y)*a)),this._doLayoutHorizontally(i,!0,r,!0),this._resizeMode===M0.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,a)}_doLayoutGridAxisVertical(e,t){const i=t.height;let n=1,s=-e.x*t.width,o=this._paddingLeft;this._horizontalDirection===N0.RIGHT_TO_LEFT&&(n=-1,s=(1-e.x)*t.width,o=this._paddingRight);const r=(e,t,i)=>s+n*(i+(1-t.anchorX)*t.width*this._getUsedScaleValue(e.scale.x)+o);let a=0;this._resizeMode===M0.CONTAINER&&(a=this._doLayoutVertically(i,!0,r,!1),s=-e.x*a,this._horizontalDirection===N0.RIGHT_TO_LEFT&&(n=-1,s=(1-e.x)*a)),this._doLayoutVertically(i,!0,r,!0),this._resizeMode===M0.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(a,i)}_doLayoutGrid(){const e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,i=e.contentSize;this.startAxis===O0.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,i):this.startAxis===O0.VERTICAL&&this._doLayoutGridAxisVertical(t,i)}_getHorizontalBaseWidth(e=!0){const t=this._usefulLayoutObj;let i=0;const n=t.length;if(this._resizeMode===M0.CONTAINER){for(let e=0;e<t.length;++e){const n=t[e],s=n.node.scale;i+=n.width*this._getUsedScaleValue(s.x)}i+=(n-1)*this._spacingX+this._getPaddingH()}else i=this.node._uiProps.uiTransformComp.width;return i}_getVerticalBaseHeight(){const e=this._usefulLayoutObj;let t=0;const i=e.length;if(this._resizeMode===M0.CONTAINER){for(let i=0;i<e.length;++i){const n=e[i],s=n.node.scale;t+=n.height*this._getUsedScaleValue(s.y)}t+=(i-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t}_doLayout(){if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===I0.HORIZONTAL){const e=this._getHorizontalBaseWidth(),t=e=>(this._isAlign?zi.ZERO:e.position).y;this._doLayoutHorizontally(e,!1,t,!0),this.node._uiProps.uiTransformComp.width=e}else if(this._layoutType===I0.VERTICAL){const e=this._getVerticalBaseHeight(),t=e=>(this._isAlign?zi.ZERO:e.position).x;this._doLayoutVertically(e,!1,t,!0),this.node._uiProps.uiTransformComp.height=e}else this._layoutType===I0.GRID&&this._doLayoutGrid()}_getUsedScaleValue(e){return this._affectedByScale?Math.abs(e):1}_transformDirty(e){e&Cg.SCALE&&e&Cg.POSITION&&this._affectedByScale&&this._doLayoutDirty()}_doLayoutDirty(){this._layoutDirty=!0}_childrenChanged(){this._childrenDirty=!0,this._doLayoutDirty()}_getPaddingH(){return this._paddingLeft+this._paddingRight}_getPaddingV(){return this._paddingTop+this._paddingBottom}_getFixedBreakingNum(){if(this._layoutType!==I0.GRID||this._constraint===L0.NONE||this._constraintNum<=0)return 0;let e=this._constraint===L0.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===O0.VERTICAL&&(e=this._constraint===L0.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e}},P0.Type=I0,P0.VerticalDirection=D0,P0.HorizontalDirection=N0,P0.ResizeMode=M0,P0.AxisDirection=O0,P0.Constraint=L0,Oc((u0=R0).prototype,"alignHorizontal",[LJ,BJ],Object.getOwnPropertyDescriptor(u0.prototype,"alignHorizontal"),u0.prototype),Oc(u0.prototype,"alignVertical",[zJ,FJ],Object.getOwnPropertyDescriptor(u0.prototype,"alignVertical"),u0.prototype),Oc(u0.prototype,"type",[UJ,GJ],Object.getOwnPropertyDescriptor(u0.prototype,"type"),u0.prototype),Oc(u0.prototype,"resizeMode",[kJ,HJ,VJ],Object.getOwnPropertyDescriptor(u0.prototype,"resizeMode"),u0.prototype),Oc(u0.prototype,"cellSize",[jJ,WJ],Object.getOwnPropertyDescriptor(u0.prototype,"cellSize"),u0.prototype),Oc(u0.prototype,"startAxis",[qJ,XJ],Object.getOwnPropertyDescriptor(u0.prototype,"startAxis"),u0.prototype),Oc(u0.prototype,"paddingLeft",[YJ],Object.getOwnPropertyDescriptor(u0.prototype,"paddingLeft"),u0.prototype),Oc(u0.prototype,"paddingRight",[KJ],Object.getOwnPropertyDescriptor(u0.prototype,"paddingRight"),u0.prototype),Oc(u0.prototype,"paddingTop",[$J],Object.getOwnPropertyDescriptor(u0.prototype,"paddingTop"),u0.prototype),Oc(u0.prototype,"paddingBottom",[QJ],Object.getOwnPropertyDescriptor(u0.prototype,"paddingBottom"),u0.prototype),Oc(u0.prototype,"spacingX",[ZJ],Object.getOwnPropertyDescriptor(u0.prototype,"spacingX"),u0.prototype),Oc(u0.prototype,"spacingY",[JJ],Object.getOwnPropertyDescriptor(u0.prototype,"spacingY"),u0.prototype),Oc(u0.prototype,"verticalDirection",[e0,t0],Object.getOwnPropertyDescriptor(u0.prototype,"verticalDirection"),u0.prototype),Oc(u0.prototype,"horizontalDirection",[i0,n0],Object.getOwnPropertyDescriptor(u0.prototype,"horizontalDirection"),u0.prototype),Oc(u0.prototype,"constraint",[s0,o0,r0],Object.getOwnPropertyDescriptor(u0.prototype,"constraint"),u0.prototype),Oc(u0.prototype,"constraintNum",[a0,c0],Object.getOwnPropertyDescriptor(u0.prototype,"constraintNum"),u0.prototype),Oc(u0.prototype,"affectedByScale",[l0],Object.getOwnPropertyDescriptor(u0.prototype,"affectedByScale"),u0.prototype),_0=Oc(u0.prototype,"_resizeMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M0.NONE}}),p0=Oc(u0.prototype,"_layoutType",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return I0.NONE}}),d0=Oc(u0.prototype,"_cellSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hn(40,40)}}),f0=Oc(u0.prototype,"_startAxis",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O0.HORIZONTAL}}),m0=Oc(u0.prototype,"_paddingLeft",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g0=Oc(u0.prototype,"_paddingRight",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v0=Oc(u0.prototype,"_paddingTop",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y0=Oc(u0.prototype,"_paddingBottom",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x0=Oc(u0.prototype,"_spacingX",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S0=Oc(u0.prototype,"_spacingY",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b0=Oc(u0.prototype,"_verticalDirection",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D0.TOP_TO_BOTTOM}}),T0=Oc(u0.prototype,"_horizontalDirection",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N0.LEFT_TO_RIGHT}}),E0=Oc(u0.prototype,"_constraint",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L0.NONE}}),C0=Oc(u0.prototype,"_constraintNum",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),w0=Oc(u0.prototype,"_affectedByScale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),A0=Oc(u0.prototype,"_isAlign",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h0=u0))||h0)||h0)||h0)||h0)||h0)||h0));var F0,U0,G0,k0,H0,V0,j0,W0,q0,X0,Y0,K0,$0,Q0,Z0,J0,e1,t1,i1,n1,s1,o1,r1;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(r1||(r1={})),Le(r1);let a1=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((F0=Wc("cc.ProgressBar"),U0=al(),G0=Xc(110),k0=nl(),H0=qc(EH),V0=Al(Oq),j0=_l(),W0=Al(r1),q0=_l(),X0=_l(),Y0=pl(),K0=_l(),$0=_l(),F0(Q0=U0(Q0=G0(Q0=k0(Q0=H0((o1=s1=class extends Gh{constructor(...e){super(...e),Mc(this,"_barSprite",J0,this),Mc(this,"_mode",e1,this),Mc(this,"_totalLength",t1,this),Mc(this,"_progress",i1,this),Mc(this,"_reverse",n1,this)}get barSprite(){return this._barSprite}set barSprite(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}get mode(){return this._mode}set mode(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){const e=this._barSprite.node;if(!e)return;const t=e._uiProps.uiTransformComp.contentSize;this._mode===r1.HORIZONTAL?this.totalLength=t.width:this._mode===r1.VERTICAL?this.totalLength=t.height:this._mode===r1.FILLED&&(this.totalLength=this._barSprite.fillRange)}}get totalLength(){return this._totalLength}set totalLength(e){this._mode===r1.FILLED&&(e=fi(e)),this._totalLength=e,this._updateBarStatus()}get progress(){return this._progress}set progress(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}get reverse(){return this._reverse}set reverse(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}_initBarSprite(){if(this._barSprite){const e=this._barSprite.node;if(!e)return;const t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint,s=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===Oq.FillType.RADIAL&&(this._mode=r1.FILLED),this._mode===r1.HORIZONTAL?this.totalLength=s.width:this._mode===r1.VERTICAL?this.totalLength=s.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){const t=-i.width*n.x;e.setPosition(t,0,0)}}}_updateBarStatus(){if(this._barSprite){const e=this._barSprite.node;if(!e)return;const t=e._uiProps.uiTransformComp,i=t.anchorPoint,n=t.contentSize,s=e.getPosition();let o=new nn(0,.5);const r=fi(this._progress);let a=this._totalLength*r,c=n,l=0,h=0;switch(this._mode){case r1.HORIZONTAL:this._reverse&&(o=new nn(1,.5)),c=new hn(a,n.height),l=this._totalLength,h=n.height;break;case r1.VERTICAL:o=this._reverse?new nn(.5,1):new nn(.5,0),c=new hn(n.width,a),l=n.width,h=this._totalLength}if(this._mode===r1.FILLED)this._barSprite.type!==Oq.Type.FILLED?p("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(a*=-1),this._barSprite.fillRange=a);else if(this._barSprite.type!==Oq.Type.FILLED){const n=o.x-i.x,r=o.y-i.y,a=new zi(l*n,h*r,0);e.setPosition(s.x+a.x,s.y+a.y,s.z),t.setAnchorPoint(o),t.setContentSize(c)}else p("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},s1.Mode=r1,Oc((Z0=o1).prototype,"barSprite",[V0,j0],Object.getOwnPropertyDescriptor(Z0.prototype,"barSprite"),Z0.prototype),Oc(Z0.prototype,"mode",[W0,q0],Object.getOwnPropertyDescriptor(Z0.prototype,"mode"),Z0.prototype),Oc(Z0.prototype,"totalLength",[X0],Object.getOwnPropertyDescriptor(Z0.prototype,"totalLength"),Z0.prototype),Oc(Z0.prototype,"progress",[Y0,gl,K0],Object.getOwnPropertyDescriptor(Z0.prototype,"progress"),Z0.prototype),Oc(Z0.prototype,"reverse",[$0],Object.getOwnPropertyDescriptor(Z0.prototype,"reverse"),Z0.prototype),J0=Oc(Z0.prototype,"_barSprite",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e1=Oc(Z0.prototype,"_mode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return r1.HORIZONTAL}}),t1=Oc(Z0.prototype,"_totalLength",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),i1=Oc(Z0.prototype,"_progress",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),n1=Oc(Z0.prototype,"_reverse",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Q0=Z0))||Q0)||Q0)||Q0)||Q0)||Q0));var c1,l1,h1,u1,_1,p1,d1,f1,m1,g1,v1,y1,x1,S1,b1,T1,E1,C1,w1,A1,P1,R1,I1,M1;const O1=new zi,D1=new zi,N1=new zi,L1=new nn,B1=new Di,z1=new nn;var F1;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(F1||(F1={})),Fe(F1);let U1=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((c1=Wc("cc.ScrollBar"),l1=al(),h1=Xc(110),u1=nl(),_1=qc(EH),p1=Al(Oq),d1=vl(),f1=_l(),m1=Al(F1),g1=vl(),v1=_l(),y1=vl(),x1=_l(),S1=vl(),b1=_l(),c1(T1=l1(T1=h1(T1=u1(T1=_1((M1=I1=class extends Gh{constructor(...e){super(...e),Mc(this,"_scrollView",C1,this),Mc(this,"_handle",w1,this),Mc(this,"_direction",A1,this),Mc(this,"_enableAutoHide",P1,this),Mc(this,"_autoHideTime",R1,this),this._touching=!1,this._opacity=255,this._autoHideRemainingTime=0}get handle(){return this._handle}set handle(e){this._handle!==e&&(this._handle=e,this.onScroll(nn.ZERO))}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e,this.onScroll(nn.ZERO))}get enableAutoHide(){return this._enableAutoHide}set enableAutoHide(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}get autoHideTime(){return this._autoHideTime}set autoHideTime(e){this._autoHideTime!==e&&(this._autoHideTime=e)}hide(){this._autoHideRemainingTime=0,this._setOpacity(0)}show(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}onScroll(e){if(!this._scrollView)return;const t=this._scrollView.content;if(!t)return;const i=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize,s=this.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(i,n))return;this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));let o=0,r=0,a=0,c=0,l=0;const h=z1;h.set(0,0),this._direction===F1.HORIZONTAL?(o=i.width,r=n.width,l=s.width,a=e.x,this._convertToScrollViewSpace(h,t),c=-h.x):this._direction===F1.VERTICAL&&(o=i.height,r=n.height,l=s.height,a=e.y,this._convertToScrollViewSpace(h,t),c=-h.y);const u=this._calculateLength(o,r,l,a),_=z1;this._calculatePosition(_,o,r,l,c,a,u),this._updateLength(u),this._updateHandlerPosition(_)}setScrollView(e){this._scrollView=e}onTouchBegan(){this._enableAutoHide&&(this._touching=!0)}onTouchEnded(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){const e=this._scrollView.content;if(e){const t=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}onEnable(){const e=this.node.getComponent(Oq);e&&(this._opacity=e.color.a)}start(){this._enableAutoHide&&this._setOpacity(0)}update(e){this._processAutoHide(e)}_convertToScrollViewSpace(e,t){const i=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp;if(i&&n){O1.set(-n.anchorX*n.width,-n.anchorY*n.height,0),n.convertToWorldSpaceAR(O1,D1);const t=i.convertToNodeSpaceAR(D1);t.x+=i.anchorX*i.width,t.y+=i.anchorY*i.height,e.set(t.x,t.y)}else e.set(nn.ZERO)}_setOpacity(e){if(this._handle){let t=this.node.getComponent(Oq);t&&(B1.set(t.color),B1.a=e,t.color=B1),t=this._handle.getComponent(Oq),t&&(B1.set(t.color),B1.a=e,t.color=B1)}}_updateHandlerPosition(e){if(this._handle){const t=N1;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}_fixupHandlerPosition(e){const t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint,s=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;zi.set(O1,-i.width*n.x,-i.height*n.y,0);const r=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(O1,D1),a=e;a.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(r,a),this.direction===F1.HORIZONTAL?a.set(a.x,a.y+(i.height-s.height)/2,a.z):this.direction===F1.VERTICAL&&a.set(a.x+(i.width-s.width)/2,a.y,a.z),this.handle.node.setPosition(a)}_conditionalDisableScrollBar(e,t){return e.width<=t.width&&this._direction===F1.HORIZONTAL||e.height<=t.height&&this._direction===F1.VERTICAL}_calculateLength(e,t,i,n){let s=e;return n&&(s+=20*(n>0?n:-n)),i*(t/s)}_calculatePosition(e,t,i,n,s,o,r){let a=t-i;o&&(a+=Math.abs(o));let c=0;a&&(c=s/a,c=fi(c));const l=(n-r)*c;this._direction===F1.VERTICAL?e.set(0,l):e.set(l,0)}_updateLength(e){if(this._handle){const t=this._handle.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint;n.x===L1.x&&n.y===L1.y||t.setAnchorPoint(L1),this._direction===F1.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}_processAutoHide(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);const e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(e)}}},I1.Direction=F1,Oc((E1=M1).prototype,"handle",[p1,d1,f1],Object.getOwnPropertyDescriptor(E1.prototype,"handle"),E1.prototype),Oc(E1.prototype,"direction",[m1,g1,v1],Object.getOwnPropertyDescriptor(E1.prototype,"direction"),E1.prototype),Oc(E1.prototype,"enableAutoHide",[y1,x1],Object.getOwnPropertyDescriptor(E1.prototype,"enableAutoHide"),E1.prototype),Oc(E1.prototype,"autoHideTime",[S1,b1],Object.getOwnPropertyDescriptor(E1.prototype,"autoHideTime"),E1.prototype),C1=Oc(E1.prototype,"_scrollView",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),w1=Oc(E1.prototype,"_handle",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A1=Oc(E1.prototype,"_direction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return F1.HORIZONTAL}}),P1=Oc(E1.prototype,"_enableAutoHide",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),R1=Oc(E1.prototype,"_autoHideTime",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),T1=E1))||T1)||T1)||T1)||T1)||T1));var G1;let k1=e("ViewGroup",Wc("cc.ViewGroup")(G1=Xc(110)(G1=class extends Gh{})||G1)||G1);var H1,V1,j1,W1,q1,X1,Y1,K1,$1,Q1,Z1,J1,e2,t2,i2,n2,s2,o2,r2,a2,c2,l2,h2,u2,_2,p2,d2,f2,m2,g2,v2,y2,x2,S2,b2,T2,E2,C2,w2,A2,P2,R2,I2,M2,O2,D2,N2,L2;n.ViewGroup=k1;const B2=1e-4,z2=new zi,F2=new zi,U2=new nn,G2=new nn,k2=()=>(new Date).getMilliseconds(),H2={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};let V2;!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(V2||(V2={}));let j2=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((H1=Wc("cc.ScrollView"),V1=al(),j1=Xc(110),W1=nl(),q1=qc(EH),X1=pl(),Y1=vl(),K1=_l(),$1=pl(),Q1=vl(),Z1=_l(),J1=vl(),e2=_l(),t2=vl(),i2=_l(),n2=Al(ix),s2=vl(),o2=_l(),r2=vl(),a2=_l(),c2=Al(U1),l2=vl(),h2=_l(),u2=vl(),_2=_l(),p2=Al(U1),d2=vl(),f2=_l(),m2=vl(),g2=_l(),v2=Al([TP]),y2=vl(),x2=_l(),H1(S2=V1(S2=j1(S2=W1(S2=q1((L2=N2=class extends k1{constructor(...e){super(...e),Mc(this,"bounceDuration",T2,this),Mc(this,"brake",E2,this),Mc(this,"elastic",C2,this),Mc(this,"inertia",w2,this),Mc(this,"horizontal",A2,this),Mc(this,"vertical",P2,this),Mc(this,"cancelInnerEvents",R2,this),Mc(this,"scrollEvents",I2,this),this._autoScrolling=!1,this._scrolling=!1,Mc(this,"_content",M2,this),Mc(this,"_horizontalScrollBar",O2,this),Mc(this,"_verticalScrollBar",D2,this),this._topBoundary=0,this._bottomBoundary=0,this._leftBoundary=0,this._rightBoundary=0,this._touchMoveDisplacements=[],this._touchMoveTimeDeltas=[],this._touchMovePreviousTimestamp=0,this._touchMoved=!1,this._autoScrollAttenuate=!1,this._autoScrollStartPosition=new zi,this._autoScrollTargetDelta=new zi,this._autoScrollTotalTime=0,this._autoScrollAccumulatedTime=0,this._autoScrollCurrentlyOutOfBoundary=!1,this._autoScrollBraking=!1,this._autoScrollBrakingStartPosition=new zi,this._outOfBoundaryAmount=new zi,this._outOfBoundaryAmountDirty=!0,this._stopMouseWheel=!1,this._mouseWheelEventElapsedTime=0,this._isScrollEndedWithThresholdEventFired=!1,this._scrollEventEmitMask=0,this._isBouncing=!1,this._contentPos=new zi,this._deltaPos=new zi}get content(){return this._content}set content(e){if(this._content===e)return;const t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):S(4302)}get horizontalScrollBar(){return this._horizontalScrollBar}set horizontalScrollBar(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(nn.ZERO)))}get verticalScrollBar(){return this._verticalScrollBar}set verticalScrollBar(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(nn.ZERO)))}get view(){const e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}scrollToBottom(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new nn(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}scrollToTop(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new nn(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToLeft(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new nn(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToRight(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new nn(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToTopLeft(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new nn(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToTopRight(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new nn(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToBottomLeft(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new nn(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToBottomRight(e,t=!0){const i=this._calculateMovePercentDelta({anchor:new nn(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}scrollToOffset(e,t,i=!0){const n=this.getMaxScrollOffset(),s=new nn(0,0);0===n.x?s.x=0:s.x=e.x/n.x,0===n.y?s.y=1:s.y=(n.y-e.y)/n.y,this.scrollTo(s,t,i)}getScrollOffset(){const e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new nn(t,e)}getMaxScrollOffset(){if(!this._content||!this.view)return nn.ZERO;const e=this._content._uiProps.uiTransformComp.contentSize;let t=e.width-this.view.width,i=e.height-this.view.height;return t=t>=0?t:0,i=i>=0?i:0,new nn(t,i)}scrollToPercentHorizontal(e,t,i){const n=this._calculateMovePercentDelta({anchor:new nn(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}scrollTo(e,t,i){const n=this._calculateMovePercentDelta({anchor:new nn(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}scrollToPercentVertical(e,t,i){const n=this._calculateMovePercentDelta({anchor:new nn(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}stopAutoScroll(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}setContentPosition(e){this._setContentPosition(e)}_setContentPosition(e){if(!this._content)return;const t=this._getContentPosition();Math.abs(e.x-t.x)<B2&&Math.abs(e.y-t.y)<B2||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}getContentPosition(){return this._getContentPosition()}_getContentPosition(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):zi.ZERO.clone()}isScrolling(){return this._scrolling}isAutoScrolling(){return this._autoScrolling}getScrollEndedEventTiming(){return B2}start(){this._calculateBoundary(),this._content&&Qw.once($w.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}onEnable(){this._registerEvent(),this._content&&(this._content.on(cy.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(cy.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(cy.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(cy.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}update(e){this._autoScrolling&&this._processAutoScrolling(e)}onDisable(){this._unregisterEvent(),this._content&&(this._content.off(cy.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(cy.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(cy.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(cy.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}_registerEvent(){this.node.on(cy.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(cy.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(cy.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(cy.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(cy.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_unregisterEvent(){this.node.off(cy.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(cy.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(cy.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(cy.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(cy.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_onMouseWheel(e,t){if(!this.enabledInHierarchy)return;if(this._hasNestedViewGroup(e,t))return;const i=new zi,n=e.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}_onTouchBegan(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}_onTouchMoved(e,t){if(!this.enabledInHierarchy||!this._content)return;if(this._hasNestedViewGroup(e,t))return;const i=e.touch;if(this._handleMoveLogic(i),!this.cancelInnerEvents)return;const n=i.getUILocation(U2);if(n.subtract(i.getUIStartLocation(G2)),n.length()>7&&!this._touchMoved&&e.target!==this.node){const t=new pw(e.getTouches(),e.bubbles,Yv.TOUCH_CANCEL);t.touch=e.touch,t.simulate=!0,e.target.dispatchEvent(t),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}_onTouchEnded(e,t){if(!this.enabledInHierarchy||!this._content||!e)return;if(this._hasNestedViewGroup(e,t))return;this._dispatchEvent(V2.TOUCH_UP);const i=e.touch;this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}_onTouchCancelled(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){const t=e.touch;this._handleReleaseLogic(t)}this._stopPropagationIfTargetIsMe(e)}}_calculateBoundary(){if(this._content&&this.view){const e=this._content.getComponent(z0);e&&e.enabledInHierarchy&&e.updateLayout();const t=this.view,i=t.width*t.anchorX,n=t.height*t.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}}_hasNestedViewGroup(e,t){if(!e||e.eventPhase!==_h.CAPTURING_PHASE)return!1;if(t)for(const i of t){const t=i;if(this.node===t)return!(!e.target||!e.target.getComponent(k1));if(t.getComponent(k1))return!0}return!1}_startInertiaScroll(e){const t=new zi(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}_calculateAttenuatedFactor(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}_startAttenuatingAutoScroll(e,t){const i=e.clone();if(i.normalize(),this._content&&this.view){const e=this._content._uiProps.uiTransformComp.contentSize,t=this.view.contentSize,n=e.width-t.width,s=e.height-t.height,o=this._calculateAttenuatedFactor(n),r=this._calculateAttenuatedFactor(s);i.x=i.x*n*(1-this.brake)*o,i.y=i.y*s*r*(1-this.brake),i.z=0}const n=e.length();let s=i.length()/n;if(i.add(e),this.brake>0&&s>7){s=Math.sqrt(s);const t=e.clone();t.multiplyScalar(s),i.set(t),i.add(e)}let o=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&s>3&&(s=3,o*=s),0===this.brake&&s>1&&(o*=s),this._startAutoScroll(i,o,!0)}_calculateAutoScrollTimeByInitialSpeed(e){return Math.sqrt(Math.sqrt(e/5))}_startAutoScroll(e,t,i=!1){const n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,zi.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(zi.ZERO,B2)||(this._autoScrollCurrentlyOutOfBoundary=!0)}_calculateTouchMoveVelocity(){const e=new zi;let t=0;if(t=this._touchMoveTimeDeltas.reduce(((e,t)=>e+t),t),t<=0||t>=.5)e.set(zi.ZERO);else{let i=new zi;i=this._touchMoveDisplacements.reduce(((e,t)=>(e.add(t),e)),i),e.set(i.x*(1-this.brake)/t,i.y*(1-this.brake)/t,i.z)}return e}_flattenVectorByDirection(e){const t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}_moveContent(e,t){const i=this._flattenVectorByDirection(e);z2.set(this._getContentPosition()),z2.add(i),z2.set(Math.floor(1e4*z2.x)*B2,Math.floor(1e4*z2.y)*B2,z2.z),this._setContentPosition(z2);const n=this._getHowMuchOutOfBoundary();U2.set(n.x,n.y),this._updateScrollBar(U2),this.elastic&&t&&this._startBounceBackIfNeeded()}_getContentLeftBoundary(){if(!this._content)return-1;const e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width}_getContentRightBoundary(){if(!this._content)return-1;const e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width}_getContentTopBoundary(){if(!this._content)return-1;const e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height}_getContentBottomBoundary(){if(!this._content)return-1;const e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height}_getHowMuchOutOfBoundary(e){if((e=e||new zi).equals(zi.ZERO,B2)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;const t=new zi;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(zi.ZERO,B2)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t}_updateScrollBar(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}_onScrollBarTouchBegan(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}_onScrollBarTouchEnded(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}_dispatchEvent(e){if(e===V2.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===V2.SCROLL_TO_TOP||e===V2.SCROLL_TO_BOTTOM||e===V2.SCROLL_TO_LEFT||e===V2.SCROLL_TO_RIGHT){const t=1<<H2[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}TP.emitEvents(this.scrollEvents,this,H2[e]),this.node.emit(e,this)}_adjustContentOutOfBoundary(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){const e=this._getHowMuchOutOfBoundary();z2.set(this._getContentPosition()),z2.add(e),this._content.setPosition(z2),this._updateScrollBar(nn.ZERO)}}_hideScrollBar(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}_updateScrollBarState(){if(!this._content||!this.view)return;const e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}_stopPropagationIfTargetIsMe(e){e.eventPhase===_h.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}_processDeltaMove(e){this._scrollChildren(e),this._gatherTouchMove(e)}_handleMoveLogic(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)}_handleReleaseLogic(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(V2.SCROLL_ENDED))}_getLocalAxisAlignDelta(e,t){const i=this.node._uiProps.uiTransformComp,n=new zi;i&&(t.getUILocation(U2),t.getUIPreviousLocation(G2),z2.set(U2.x,U2.y,0),F2.set(G2.x,G2.y,0),i.convertToNodeSpaceAR(z2,z2),i.convertToNodeSpaceAR(F2,F2),zi.subtract(n,z2,F2)),e.set(n)}_scrollChildren(e){this._clampDelta(e);const t=e;let i,n;if(this.elastic&&(i=this._getHowMuchOutOfBoundary(),t.x*=0===i.x?1:.5,t.y*=0===i.y?1:.5),this.elastic||(i=this._getHowMuchOutOfBoundary(t),t.add(i)),this._content){const{anchorX:e,anchorY:i,width:s,height:o}=this._content._uiProps.uiTransformComp,r=this._content.position||zi.ZERO;t.y>0?r.y-i*o+t.y>=this._bottomBoundary&&(n=V2.SCROLL_TO_BOTTOM):t.y<0&&r.y-i*o+o+t.y<=this._topBoundary&&(n=V2.SCROLL_TO_TOP),t.x<0?r.x-e*s+s+t.x<=this._rightBoundary&&(n=V2.SCROLL_TO_RIGHT):t.x>0&&r.x-e*s+t.x>=this._leftBoundary&&(n=V2.SCROLL_TO_LEFT)}this._moveContent(t,!1),0===t.x&&0===t.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(V2.SCROLL_BEGAN)),this._dispatchEvent(V2.SCROLLING)),n&&n.length>0&&this._dispatchEvent(n)}_handlePressLogic(){this._autoScrolling&&this._dispatchEvent(V2.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=k2(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}_clampDelta(e){if(this._content&&this.view){const t=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<t.width&&(e.x=0),i.height<t.height&&(e.y=0)}}_gatherTouchMove(e){const t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);const i=k2();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}_startBounceBackIfNeeded(){if(!this.elastic)return!1;const e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(zi.ZERO,B2))return!1;const t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(V2.BOUNCE_TOP),e.y<0&&this._dispatchEvent(V2.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(V2.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(V2.BOUNCE_LEFT),this._isBouncing=!0),!0}_processInertiaScroll(){if(!this._startBounceBackIfNeeded()&&this.inertia){const e=this._calculateTouchMoveVelocity();!e.equals(z2,B2)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}_isOutOfBoundary(){return!this._getHowMuchOutOfBoundary().equals(zi.ZERO,B2)}_isNecessaryAutoScrollBrake(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}_processAutoScrolling(e){const t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);let n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);var s;this._autoScrollAttenuate&&(s=n,n=(s-=1)*s*s*s*s+1);const o=this._autoScrollTargetDelta.clone();o.multiplyScalar(n);const r=this._autoScrollStartPosition.clone();r.add(o);let a=Math.abs(n-1)<=B2;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(V2.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){const e=r.clone();e.subtract(this._autoScrollBrakingStartPosition),t&&e.multiplyScalar(i),r.set(this._autoScrollBrakingStartPosition),r.add(e)}else{const e=r.clone();e.subtract(this.getContentPosition());const t=this._getHowMuchOutOfBoundary(e);t.equals(zi.ZERO,B2)||(r.add(t),a=!0)}a&&(this._autoScrolling=!1);const c=r.clone();c.subtract(this._getContentPosition()),this._clampDelta(c),this._moveContent(c,a),this._dispatchEvent(V2.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(V2.SCROLL_ENDED))}_checkMouseWheel(e){if(!this._getHowMuchOutOfBoundary().equals(zi.ZERO,B2))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(V2.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(V2.SCROLL_ENDED),this._stopMouseWheel=!1)}_calculateMovePercentDelta(e){const t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(nn.ZERO,nn.ONE);let s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;let o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;const r=new zi;if(this._content&&this.view){let e=0;const a=this._content._uiProps.uiTransformComp.contentSize,c=this.view.contentSize;i&&(e=a.width-c.width,r.x=o-e*t.x),n&&(e=a.height-c.height,r.y=s-e*t.y)}return r}_moveContentToTopLeft(e){let t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;const i=new zi;let n=0,s=this._getContentLeftBoundary()-this._leftBoundary;if(s=-s,this._content){const o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(n=o.height-e.height,i.y=t-n),o.width<e.width&&(n=o.width-e.width,i.x=s)}this._updateScrollBarState(),this._moveContent(i),this._adjustContentOutOfBoundary()}_scaleChanged(e){e===Cg.SCALE&&this._calculateBoundary()}},N2.EventType=V2,T2=Oc((b2=L2).prototype,"bounceDuration",[Qc,X1,Y1,K1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),E2=Oc(b2.prototype,"brake",[Qc,$1,Q1,Z1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),C2=Oc(b2.prototype,"elastic",[Qc,J1,e2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),w2=Oc(b2.prototype,"inertia",[Qc,t2,i2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Oc(b2.prototype,"content",[n2,s2,o2],Object.getOwnPropertyDescriptor(b2.prototype,"content"),b2.prototype),A2=Oc(b2.prototype,"horizontal",[Qc,r2,a2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Oc(b2.prototype,"horizontalScrollBar",[c2,l2,h2],Object.getOwnPropertyDescriptor(b2.prototype,"horizontalScrollBar"),b2.prototype),P2=Oc(b2.prototype,"vertical",[Qc,u2,_2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Oc(b2.prototype,"verticalScrollBar",[p2,d2,f2],Object.getOwnPropertyDescriptor(b2.prototype,"verticalScrollBar"),b2.prototype),R2=Oc(b2.prototype,"cancelInnerEvents",[Qc,m2,g2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I2=Oc(b2.prototype,"scrollEvents",[v2,Qc,y2,x2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),M2=Oc(b2.prototype,"_content",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),O2=Oc(b2.prototype,"_horizontalScrollBar",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D2=Oc(b2.prototype,"_verticalScrollBar",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S2=b2))||S2)||S2)||S2)||S2)||S2));var W2,q2,X2,Y2,K2,$2,Q2,Z2,J2,e4,t4,i4,n4,s4,o4,r4,a4,c4,l4,h4,u4;const _4=new zi;var p4;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(p4||(p4={})),Fe(p4);let d4=function(t){return e({Slider:t,SliderComponent:t}),t}((W2=Wc("cc.Slider"),q2=al(),X2=Xc(110),Y2=nl(),K2=qc(EH),$2=Al(Oq),Q2=_l(),Z2=Al(p4),J2=_l(),e4=pl(),t4=_l(),i4=Al([TP]),n4=_l(),W2(s4=q2(s4=X2(s4=Y2(s4=K2((u4=h4=class extends Gh{constructor(...e){super(...e),Mc(this,"slideEvents",r4,this),Mc(this,"_handle",a4,this),Mc(this,"_direction",c4,this),Mc(this,"_progress",l4,this),this._offset=new zi,this._dragging=!1,this._touchHandle=!1,this._handleLocalPos=new zi,this._touchPos=new zi}get handle(){return this._handle}set handle(e){this._handle!==e&&(this._handle=e)}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e,this._changeLayout())}get progress(){return this._progress}set progress(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}__preload(){this._updateHandlePosition()}onEnable(){this._updateHandlePosition(),this.node.on(cy.TOUCH_START,this._onTouchBegan,this),this.node.on(cy.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(cy.TOUCH_END,this._onTouchEnded,this),this.node.on(cy.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(cy.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(cy.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(cy.TOUCH_END,this._onTouchEnded,this))}onDisable(){this.node.off(cy.TOUCH_START,this._onTouchBegan,this),this.node.off(cy.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(cy.TOUCH_END,this._onTouchEnded,this),this.node.off(cy.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(cy.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(cy.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(cy.TOUCH_END,this._onTouchEnded,this))}_onHandleDragStart(e){if(!e||!this._handle||!this._handle.node._uiProps.uiTransformComp)return;this._dragging=!0,this._touchHandle=!0;const t=e.touch.getUILocation();zi.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}_onTouchBegan(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}_onTouchMoved(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}_onTouchEnded(e){this._dragging=!1,this._touchHandle=!1,this._offset=new zi,e&&(e.propagationStopped=!0)}_onTouchCancelled(e){this._dragging=!1,e&&(e.propagationStopped=!0)}_handleSliderLogic(e){this._updateProgress(e),this._emitSlideEvent()}_emitSlideEvent(){TP.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}_updateProgress(e){if(!this._handle||!e)return;const t=e.getUILocation();zi.set(this._touchPos,t.x,t.y,0);const i=this.node._uiProps.uiTransformComp,n=i.convertToNodeSpaceAR(this._touchPos,_4);this.direction===p4.Horizontal?this.progress=fi(.5+(n.x-this._offset.x)/i.width):this.progress=fi(.5+(n.y-this._offset.y)/i.height)}_updateHandlePosition(){if(!this._handle)return;this._handleLocalPos.set(this._handle.node.getPosition());const e=this.node._uiProps.uiTransformComp;this._direction===p4.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}_changeLayout(){const e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){const e=this._handle.node.position;this._direction===p4.Horizontal?this._handle.node.setPosition(e.x,0,e.z):this._handle.node.setPosition(0,e.y,e.z),this._updateHandlePosition()}}},h4.Direction=p4,Oc((o4=u4).prototype,"handle",[$2,Q2],Object.getOwnPropertyDescriptor(o4.prototype,"handle"),o4.prototype),Oc(o4.prototype,"direction",[Z2,J2],Object.getOwnPropertyDescriptor(o4.prototype,"direction"),o4.prototype),Oc(o4.prototype,"progress",[gl,e4,t4],Object.getOwnPropertyDescriptor(o4.prototype,"progress"),o4.prototype),r4=Oc(o4.prototype,"slideEvents",[i4,Qc,n4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a4=Oc(o4.prototype,"_handle",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c4=Oc(o4.prototype,"_direction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return p4.Horizontal}}),l4=Oc(o4.prototype,"_progress",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),s4=o4))||s4)||s4)||s4)||s4)||s4));function f4(...e){return Object.assign({},...e)}var m4,g4,v4,y4,x4,S4,b4,T4,E4,C4,w4,A4,P4,R4,I4,M4,O4,D4,N4,L4;!function(e){e.TOGGLE="toggle"}(L4||(L4={}));let B4=function(t){return e({Toggle:t,ToggleComponent:t}),t}((m4=Wc("cc.Toggle"),g4=al(),v4=Xc(110),y4=nl(),x4=qc(EH),S4=vl(),b4=_l(),T4=Al(Oq),E4=vl(),C4=_l(),w4=Al([TP]),A4=_l(),m4(P4=g4(P4=v4(P4=y4(P4=x4((N4=D4=class e extends SZ{constructor(...e){super(...e),Mc(this,"checkEvents",I4,this),Mc(this,"_isChecked",M4,this),Mc(this,"_checkMark",O4,this)}get isChecked(){return this._isChecked}set isChecked(e){this._set(e)}get checkMark(){return this._checkMark}set checkMark(e){this._checkMark!==e&&(this._checkMark=e)}set _resizeToTarget(e){e&&this._resizeNodeToTargetNode()}get _toggleContainer(){const e=this.node.parent;return n.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}_internalToggle(){this.isChecked=!this.isChecked}_set(e,t=!0){if(this._isChecked==e)return;this._isChecked=e;const i=this._toggleContainer;i&&i.enabled&&this.enabled&&(e||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}playEffect(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}setIsCheckedWithoutNotify(e){this._set(e,!1)}onEnable(){super.onEnable(),this.playEffect(),this.node.on(e.EventType.CLICK,this._internalToggle,this)}onDisable(){super.onDisable(),this.node.off(e.EventType.CLICK,this._internalToggle,this)}OnDestroy(){const e=this._toggleContainer;e&&e.ensureValidState()}_emitToggleEvents(){this.node.emit(e.EventType.TOGGLE,this),this.checkEvents&&TP.emitEvents(this.checkEvents,this)}},D4.EventType=f4(L4,gZ),Oc((R4=N4).prototype,"isChecked",[S4,b4],Object.getOwnPropertyDescriptor(R4.prototype,"isChecked"),R4.prototype),Oc(R4.prototype,"checkMark",[T4,E4,C4],Object.getOwnPropertyDescriptor(R4.prototype,"checkMark"),R4.prototype),I4=Oc(R4.prototype,"checkEvents",[w4,Qc,A4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),M4=Oc(R4.prototype,"_isChecked",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),O4=Oc(R4.prototype,"_checkMark",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),P4=R4))||P4)||P4)||P4)||P4)||P4));var z4,F4,U4,G4,k4,H4,V4,j4,W4,q4,X4;let Y4=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((z4=Wc("cc.ToggleContainer"),F4=al(),U4=Xc(110),G4=nl(),k4=_l(),H4=Al([TP]),V4=_l(),z4(j4=F4(j4=U4(j4=G4(j4=il((q4=Oc((W4=class extends Gh{constructor(...e){super(...e),Mc(this,"_allowSwitchOff",q4,this),Mc(this,"checkEvents",X4,this)}get allowSwitchOff(){return this._allowSwitchOff}set allowSwitchOff(e){this._allowSwitchOff=e}get toggleItems(){return this.node.children.map((e=>{const t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}onEnable(){this.ensureValidState(),this.node.on(cy.CHILD_ADDED,this.ensureValidState,this),this.node.on(cy.CHILD_REMOVED,this.ensureValidState,this)}onDisable(){this.node.off(cy.CHILD_ADDED,this.ensureValidState,this),this.node.off(cy.CHILD_REMOVED,this.ensureValidState,this)}activeToggles(){return this.toggleItems.filter((e=>e.isChecked))}anyTogglesChecked(){return!!this.toggleItems.find((e=>e.isChecked))}notifyToggleCheck(e,t=!0){if(this.enabledInHierarchy){for(let i=0;i<this.toggleItems.length;i++){const n=this.toggleItems[i];n!==e&&(t?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&n.Component.EventHandler.emitEvents(this.checkEvents,e)}}ensureValidState(){const e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){const t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}const t=this.activeToggles();if(t.length>1){const e=t[0];for(let i=0;i<t.length;++i){const n=t[i];n!==e&&(n.isChecked=!1)}}}}).prototype,"_allowSwitchOff",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(W4.prototype,"allowSwitchOff",[k4],Object.getOwnPropertyDescriptor(W4.prototype,"allowSwitchOff"),W4.prototype),X4=Oc(W4.prototype,"checkEvents",[H4,Qc,V4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),j4=W4))||j4)||j4)||j4)||j4)||j4));var K4,$4,Q4,Z4,J4,e3,t3,i3,n3,s3,o3,r3,a3,c3,l3,h3,u3,_3,p3,d3,f3,m3,g3,v3,y3,x3,S3,b3,T3,E3,C3,w3,A3,P3,R3,I3,M3,O3,D3,N3,L3,B3,z3,F3,U3;const G3=new nn;function k3(e){return e instanceof ZE?Mw:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:hn.ZERO}function H3(e,t,i,n){e.parent?G3.set(e.parent.getScale().x,e.parent.getScale().y):G3.set(0,0);let s=G3.x,o=G3.y,r=0,a=0;for(let c=e.parent;;){if(!c)return i.x=i.y=0,void(n.x=n.y=1);const e=c.getPosition();if(r+=e.x,a+=e.y,c=c.parent,c===t)break;{c?G3.set(c.getScale().x,c.getScale().y):G3.set(0,0);const e=G3.x,t=G3.y;r*=e,a*=t,s*=e,o*=t}}n.x=0!==s?1/s:1,n.y=0!==o?1/o:1,i.x=-r,i.y=-a}let V3,j3;!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(V3||(V3={})),Fe(V3),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(j3||(j3={}));const W3=j3.TOP|j3.BOT,q3=j3.LEFT|j3.RIGHT;let X3=function(t){return e({Widget:t,WidgetComponent:t}),t}((K4=Wc("cc.Widget"),$4=al(),Q4=Xc(110),Z4=nl(),J4=qc(EH),e3=Al(ix),t3=_l(),i3=_l(),n3=_l(),s3=_l(),o3=_l(),r3=_l(),a3=_l(),c3=ll(),l3=ll(),h3=_l(),u3=_l(),_3=_l(),p3=_l(),d3=_l(),f3=_l(),m3=Al(V3),g3=_l(),K4(v3=$4(v3=Q4(v3=Z4(v3=J4(v3=il((U3=F3=class extends Gh{constructor(...e){super(...e),this._lastPos=new zi,this._lastSize=new hn,this._dirty=!0,this._hadAlignOnce=!1,Mc(this,"_alignFlags",x3,this),Mc(this,"_target",S3,this),Mc(this,"_left",b3,this),Mc(this,"_right",T3,this),Mc(this,"_top",E3,this),Mc(this,"_bottom",C3,this),Mc(this,"_horizontalCenter",w3,this),Mc(this,"_verticalCenter",A3,this),Mc(this,"_isAbsLeft",P3,this),Mc(this,"_isAbsRight",R3,this),Mc(this,"_isAbsTop",I3,this),Mc(this,"_isAbsBottom",M3,this),Mc(this,"_isAbsHorizontalCenter",O3,this),Mc(this,"_isAbsVerticalCenter",D3,this),Mc(this,"_originalWidth",N3,this),Mc(this,"_originalHeight",L3,this),Mc(this,"_alignMode",B3,this),Mc(this,"_lockFlags",z3,this)}get target(){return this._target}set target(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}get isAlignTop(){return(this._alignFlags&j3.TOP)>0}set isAlignTop(e){this._setAlign(j3.TOP,e),this._recursiveDirty()}get isAlignBottom(){return(this._alignFlags&j3.BOT)>0}set isAlignBottom(e){this._setAlign(j3.BOT,e),this._recursiveDirty()}get isAlignLeft(){return(this._alignFlags&j3.LEFT)>0}set isAlignLeft(e){this._setAlign(j3.LEFT,e),this._recursiveDirty()}get isAlignRight(){return(this._alignFlags&j3.RIGHT)>0}set isAlignRight(e){this._setAlign(j3.RIGHT,e),this._recursiveDirty()}get isAlignVerticalCenter(){return(this._alignFlags&j3.MID)>0}set isAlignVerticalCenter(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=j3.MID):this._alignFlags&=~j3.MID,this._recursiveDirty()}get isAlignHorizontalCenter(){return(this._alignFlags&j3.CENTER)>0}set isAlignHorizontalCenter(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=j3.CENTER):this._alignFlags&=~j3.CENTER,this._recursiveDirty()}get isStretchWidth(){return(this._alignFlags&q3)===q3}get isStretchHeight(){return(this._alignFlags&W3)===W3}get top(){return this._top}set top(e){this._top=e,this._recursiveDirty()}get editorTop(){return this._isAbsTop?this._top:100*this._top}set editorTop(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}get bottom(){return this._bottom}set bottom(e){this._bottom=e,this._recursiveDirty()}get editorBottom(){return this._isAbsBottom?this._bottom:100*this._bottom}set editorBottom(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}get left(){return this._left}set left(e){this._left=e,this._recursiveDirty()}get editorLeft(){return this._isAbsLeft?this._left:100*this._left}set editorLeft(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}get right(){return this._right}set right(e){this._right=e,this._recursiveDirty()}get editorRight(){return this._isAbsRight?this._right:100*this._right}set editorRight(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}get horizontalCenter(){return this._horizontalCenter}set horizontalCenter(e){this._horizontalCenter=e,this._recursiveDirty()}get editorHorizontalCenter(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter}set editorHorizontalCenter(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}get verticalCenter(){return this._verticalCenter}set verticalCenter(e){this._verticalCenter=e,this._recursiveDirty()}get editorVerticalCenter(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter}set editorVerticalCenter(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}get isAbsoluteTop(){return this._isAbsTop}set isAbsoluteTop(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(j3.TOP,this._isAbsTop))}get isAbsoluteBottom(){return this._isAbsBottom}set isAbsoluteBottom(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(j3.BOT,this._isAbsBottom))}get isAbsoluteLeft(){return this._isAbsLeft}set isAbsoluteLeft(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(j3.LEFT,this._isAbsLeft))}get isAbsoluteRight(){return this._isAbsRight}set isAbsoluteRight(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(j3.RIGHT,this._isAbsRight))}get isAbsoluteHorizontalCenter(){return this._isAbsHorizontalCenter}set isAbsoluteHorizontalCenter(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(j3.CENTER,this._isAbsHorizontalCenter))}get isAbsoluteVerticalCenter(){return this._isAbsVerticalCenter}set isAbsoluteVerticalCenter(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(j3.MID,this._isAbsVerticalCenter))}get alignMode(){return this._alignMode}set alignMode(e){this._alignMode=e,this._recursiveDirty()}get alignFlags(){return this._alignFlags}set alignFlags(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}updateAlignment(){n._widgetManager.updateAlignment(this.node)}_validateTargetInDEV(){}setDirty(){this._recursiveDirty()}onEnable(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),n._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()}onDisable(){n._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}onDestroy(){this._removeParentEvent()}_adjustWidgetToAllowMovingInEditor(e){}_adjustWidgetToAllowResizingInEditor(){}_adjustWidgetToAnchorChanged(){this.setDirty()}_adjustTargetToParentChanged(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()}_registerEvent(){this.node.on(cy.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(cy.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(cy.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(cy.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_unregisterEvent(){this.node.off(cy.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(cy.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(cy.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}_removeParentEvent(){this.node.off(cy.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_autoChangedValue(e,t){if(!((this._alignFlags&e)>0))return;const i=this.node.parent&&this.node.parent._uiProps,n=i&&i.uiTransformComp,s=n?n.contentSize:Mw;this.isAlignLeft&&e===j3.LEFT?this._left=t?this._left*s.width:this._left/s.width:this.isAlignRight&&e===j3.RIGHT?this._right=t?this._right*s.width:this._right/s.width:this.isAlignHorizontalCenter&&e===j3.CENTER?this._horizontalCenter=t?this._horizontalCenter*s.width:this._horizontalCenter/s.width:this.isAlignTop&&e===j3.TOP?this._top=t?this._top*s.height:this._top/s.height:this.isAlignBottom&&e===j3.BOT?this._bottom=t?this._bottom*s.height:this._bottom/s.height:this.isAbsoluteVerticalCenter&&e===j3.MID&&(this._verticalCenter=this._verticalCenter/s.height),this._recursiveDirty()}_registerTargetEvents(){const e=this._target||this.node.parent;e&&e.getComponent(EH)&&(e.on(cy.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(cy.SIZE_CHANGED,this._setDirtyByMode,this),e.on(cy.ANCHOR_CHANGED,this._setDirtyByMode,this))}_unregisterTargetEvents(){const e=this._target||this.node.parent;e&&(e.off(cy.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(cy.SIZE_CHANGED,this._setDirtyByMode,this),e.off(cy.ANCHOR_CHANGED,this._setDirtyByMode,this))}_unregisterOldParentEvents(e){const t=this._target||e;t&&(t.off(cy.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(cy.SIZE_CHANGED,this._setDirtyByMode,this))}_setDirtyByMode(){this.alignMode===V3.ALWAYS&&this._recursiveDirty()}_setAlign(e,t){if(t===(this._alignFlags&e)>0)return;const i=(e&q3)>0,n=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~e)}_recursiveDirty(){this._dirty||(this._dirty=!0)}},F3.AlignMode=V3,Oc((y3=U3).prototype,"target",[e3,t3],Object.getOwnPropertyDescriptor(y3.prototype,"target"),y3.prototype),Oc(y3.prototype,"isAlignTop",[i3],Object.getOwnPropertyDescriptor(y3.prototype,"isAlignTop"),y3.prototype),Oc(y3.prototype,"isAlignBottom",[n3],Object.getOwnPropertyDescriptor(y3.prototype,"isAlignBottom"),y3.prototype),Oc(y3.prototype,"isAlignLeft",[s3],Object.getOwnPropertyDescriptor(y3.prototype,"isAlignLeft"),y3.prototype),Oc(y3.prototype,"isAlignRight",[o3],Object.getOwnPropertyDescriptor(y3.prototype,"isAlignRight"),y3.prototype),Oc(y3.prototype,"isAlignVerticalCenter",[r3],Object.getOwnPropertyDescriptor(y3.prototype,"isAlignVerticalCenter"),y3.prototype),Oc(y3.prototype,"isAlignHorizontalCenter",[a3],Object.getOwnPropertyDescriptor(y3.prototype,"isAlignHorizontalCenter"),y3.prototype),Oc(y3.prototype,"isStretchWidth",[c3],Object.getOwnPropertyDescriptor(y3.prototype,"isStretchWidth"),y3.prototype),Oc(y3.prototype,"isStretchHeight",[l3],Object.getOwnPropertyDescriptor(y3.prototype,"isStretchHeight"),y3.prototype),Oc(y3.prototype,"top",[h3],Object.getOwnPropertyDescriptor(y3.prototype,"top"),y3.prototype),Oc(y3.prototype,"editorTop",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"editorTop"),y3.prototype),Oc(y3.prototype,"bottom",[u3],Object.getOwnPropertyDescriptor(y3.prototype,"bottom"),y3.prototype),Oc(y3.prototype,"editorBottom",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"editorBottom"),y3.prototype),Oc(y3.prototype,"left",[_3],Object.getOwnPropertyDescriptor(y3.prototype,"left"),y3.prototype),Oc(y3.prototype,"editorLeft",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"editorLeft"),y3.prototype),Oc(y3.prototype,"right",[p3],Object.getOwnPropertyDescriptor(y3.prototype,"right"),y3.prototype),Oc(y3.prototype,"editorRight",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"editorRight"),y3.prototype),Oc(y3.prototype,"horizontalCenter",[d3],Object.getOwnPropertyDescriptor(y3.prototype,"horizontalCenter"),y3.prototype),Oc(y3.prototype,"editorHorizontalCenter",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"editorHorizontalCenter"),y3.prototype),Oc(y3.prototype,"verticalCenter",[f3],Object.getOwnPropertyDescriptor(y3.prototype,"verticalCenter"),y3.prototype),Oc(y3.prototype,"editorVerticalCenter",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"editorVerticalCenter"),y3.prototype),Oc(y3.prototype,"isAbsoluteTop",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"isAbsoluteTop"),y3.prototype),Oc(y3.prototype,"isAbsoluteBottom",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"isAbsoluteBottom"),y3.prototype),Oc(y3.prototype,"isAbsoluteLeft",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"isAbsoluteLeft"),y3.prototype),Oc(y3.prototype,"isAbsoluteRight",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"isAbsoluteRight"),y3.prototype),Oc(y3.prototype,"isAbsoluteHorizontalCenter",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"isAbsoluteHorizontalCenter"),y3.prototype),Oc(y3.prototype,"isAbsoluteVerticalCenter",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"isAbsoluteVerticalCenter"),y3.prototype),Oc(y3.prototype,"alignMode",[m3,g3],Object.getOwnPropertyDescriptor(y3.prototype,"alignMode"),y3.prototype),Oc(y3.prototype,"alignFlags",[cl],Object.getOwnPropertyDescriptor(y3.prototype,"alignFlags"),y3.prototype),x3=Oc(y3.prototype,"_alignFlags",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S3=Oc(y3.prototype,"_target",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b3=Oc(y3.prototype,"_left",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T3=Oc(y3.prototype,"_right",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),E3=Oc(y3.prototype,"_top",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C3=Oc(y3.prototype,"_bottom",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w3=Oc(y3.prototype,"_horizontalCenter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A3=Oc(y3.prototype,"_verticalCenter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),P3=Oc(y3.prototype,"_isAbsLeft",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),R3=Oc(y3.prototype,"_isAbsRight",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I3=Oc(y3.prototype,"_isAbsTop",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),M3=Oc(y3.prototype,"_isAbsBottom",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),O3=Oc(y3.prototype,"_isAbsHorizontalCenter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),D3=Oc(y3.prototype,"_isAbsVerticalCenter",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N3=Oc(y3.prototype,"_originalWidth",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L3=Oc(y3.prototype,"_originalHeight",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B3=Oc(y3.prototype,"_alignMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return V3.ON_WINDOW_RESIZE}}),z3=Oc(y3.prototype,"_lockFlags",[Qc,Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v3=y3))||v3)||v3)||v3)||v3)||v3)||v3));var Y3,K3,$3,Q3,Z3,J3,e5,t5,i5,n5,s5,o5,r5,a5,c5,l5,h5,u5,_5;n.internal.computeInverseTransForTarget=H3,n.internal.getReadonlyNodeSize=k3;const p5=new Di;var d5;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(d5||(d5={})),Fe(d5);let f5=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((Y3=Wc("cc.PageViewIndicator"),K3=al(),$3=Xc(110),Q3=nl(),Z3=Al(nk),J3=_l(),e5=Al(d5),t5=_l(),i5=Al(hn),n5=_l(),s5=_l(),Y3(o5=K3(o5=$3(o5=Q3((_5=u5=class extends Gh{constructor(...e){super(...e),Mc(this,"spacing",a5,this),Mc(this,"_spriteFrame",c5,this),Mc(this,"_direction",l5,this),Mc(this,"_cellSize",h5,this),this._layout=null,this._pageView=null,this._indicators=[]}get spriteFrame(){return this._spriteFrame}set spriteFrame(e){this._spriteFrame!==e&&(this._spriteFrame=e)}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e)}get cellSize(){return this._cellSize}set cellSize(e){this._cellSize!==e&&(this._cellSize=e)}onLoad(){this._updateLayout()}setPageView(e){this._pageView=e,this._refresh()}_updateLayout(){this._layout=this.getComponent(z0),this._layout||(this._layout=this.addComponent(z0));const e=this._layout;this.direction===d5.HORIZONTAL?(e.type=z0.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===d5.VERTICAL&&(e.type=z0.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=z0.ResizeMode.CONTAINER}_createIndicator(){const e=new ix;e.layer=this.node.layer;const t=e.addComponent(Oq);return t.spriteFrame=this.spriteFrame,t.sizeMode=Oq.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e}_changedState(){const e=this._indicators;if(0===e.length||!this._pageView)return;const t=this._pageView.curPageIdx;if(!(t>=e.length)){for(let t=0;t<e.length;++t){const i=e[t];if(!i._uiProps.uiComp)continue;const n=i._uiProps.uiComp;p5.set(n.color),p5.a=127.5,n.color=p5}if(e[t]._uiProps.uiComp){const i=e[t]._uiProps.uiComp;p5.set(i.color),p5.a=255,i.color=p5}}}_refresh(){if(!this._pageView)return;const e=this._indicators,t=this._pageView.getPages();if(t.length===e.length)return;let i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;i>0;--i){const t=e[i-1];this.node.removeChild(t),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}},u5.Direction=d5,Oc((r5=_5).prototype,"spriteFrame",[Z3,J3],Object.getOwnPropertyDescriptor(r5.prototype,"spriteFrame"),r5.prototype),Oc(r5.prototype,"direction",[e5,t5],Object.getOwnPropertyDescriptor(r5.prototype,"direction"),r5.prototype),Oc(r5.prototype,"cellSize",[i5,n5],Object.getOwnPropertyDescriptor(r5.prototype,"cellSize"),r5.prototype),a5=Oc(r5.prototype,"spacing",[Qc,s5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c5=Oc(r5.prototype,"_spriteFrame",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l5=Oc(r5.prototype,"_direction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return d5.HORIZONTAL}}),h5=Oc(r5.prototype,"_cellSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hn(20,20)}}),o5=r5))||o5)||o5)||o5)||o5));var m5,g5,v5,y5,x5,S5,b5,T5,E5,C5,w5,A5,P5,R5,I5,M5,O5,D5,N5,L5,B5,z5,F5,U5,G5,k5,H5,V5,j5,W5,q5,X5,Y5,K5,$5,Q5,Z5,J5,e6,t6,i6,n6;const s6=new nn;var o6,r6,a6;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(o6||(o6={})),Fe(o6),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(r6||(r6={})),Fe(r6),function(e){e.PAGE_TURNING="page-turning"}(a6||(a6={}));let c6=function(t){return e({PageView:t,PageViewComponent:t}),t}((m5=Wc("cc.PageView"),g5=al(),v5=Xc(110),y5=nl(),x5=Al(o6),S5=_l(),b5=Al(r6),T5=_l(),E5=pl(),C5=_l(),w5=pl(),A5=_l(),P5=Al(f5),R5=_l(),I5=_l(),M5=Al(U1),O5=ll(),D5=Al(U1),N5=ll(),L5=ll(),B5=ll(),z5=ll(),F5=Al([TP]),U5=ll(),G5=Al([TP]),k5=_l(),m5(H5=g5(H5=v5(H5=y5((n6=i6=class e extends j2{constructor(...e){super(...e),Mc(this,"autoPageTurningThreshold",j5,this),Mc(this,"horizontal",W5,this),Mc(this,"vertical",q5,this),Mc(this,"cancelInnerEvents",X5,this),Mc(this,"scrollEvents",Y5,this),Mc(this,"pageTurningSpeed",K5,this),Mc(this,"pageEvents",$5,this),Mc(this,"_sizeMode",Q5,this),Mc(this,"_direction",Z5,this),Mc(this,"_scrollThreshold",J5,this),Mc(this,"_pageTurningEventTiming",e6,this),Mc(this,"_indicator",t6,this),this._curPageIdx=0,this._lastPageIdx=0,this._pages=[],this._initContentPos=new zi,this._scrollCenterOffsetX=[],this._scrollCenterOffsetY=[],this._touchBeganPosition=new nn,this._touchEndPosition=new nn}get sizeMode(){return this._sizeMode}set sizeMode(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}get direction(){return this._direction}set direction(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}get scrollThreshold(){return this._scrollThreshold}set scrollThreshold(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}get pageTurningEventTiming(){return this._pageTurningEventTiming}set pageTurningEventTiming(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}get indicator(){return this._indicator}set indicator(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}get curPageIdx(){return this._curPageIdx}get verticalScrollBar(){return super.verticalScrollBar}set verticalScrollBar(e){super.verticalScrollBar=e}get horizontalScrollBar(){return super.horizontalScrollBar}set horizontalScrollBar(e){super.horizontalScrollBar=e}onEnable(){super.onEnable(),this.node.on(cy.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onDisable(){super.onDisable(),this.node.off(cy.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onLoad(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}getCurrentPageIndex(){return this._curPageIdx}setCurrentPageIndex(e){this.scrollToPage(e,1)}getPages(){return this._pages}addPage(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):S(4301))}insertPage(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void S(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}}removePage(e){if(!e||!this.content)return;const t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):T(4300,e.name)}removePageAtIndex(e){const t=this._pages;if(e<0||e>=t.length)return;const i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}removeAllPages(){if(!this.content)return;const e=this._pages;for(let t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}scrollToPage(e,t=.3){e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())}getScrollEndedEventTiming(){return this.pageTurningEventTiming}_updatePageView(){if(!this.content)return;const e=this.content.getComponent(z0);e&&e.enabled&&e.updateLayout();const t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);const i=this._initContentPos;for(let e=0;e<t;++e){const t=this._pages[e].position;this.direction===r6.Horizontal?this._scrollCenterOffsetX[e]=Math.abs(i.x+t.x):this._scrollCenterOffsetY[e]=Math.abs(i.y+t.y)}this.indicator&&this.indicator._refresh()}_updateAllPagesSize(){const e=this.view;if(!this.content||!e)return;if(this._sizeMode!==o6.Unified)return;const t=this._pages,i=e.contentSize;for(let e=0,n=t.length;e<n;e++)t[e]._uiProps.uiTransformComp.setContentSize(i)}_handleReleaseLogic(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(e.EventType.SCROLL_ENDED))}_onTouchBegan(e,t){e.touch.getUILocation(s6),nn.set(this._touchBeganPosition,s6.x,s6.y),super._onTouchBegan(e,t)}_onTouchMoved(e,t){super._onTouchMoved(e,t)}_onTouchEnded(e,t){e.touch.getUILocation(s6),nn.set(this._touchEndPosition,s6.x,s6.y),super._onTouchEnded(e,t)}_onTouchCancelled(e,t){e.touch.getUILocation(s6),nn.set(this._touchEndPosition,s6.x,s6.y),super._onTouchCancelled(e,t)}_onMouseWheel(){}_syncScrollDirection(){this.horizontal=this.direction===r6.Horizontal,this.vertical=this.direction===r6.Vertical}_syncSizeMode(){const e=this.view;if(!this.content||!e)return;const t=this.content.getComponent(z0);if(t){if(this._sizeMode===o6.Free&&this._pages.length>0){const i=this._pages[0]._uiProps.uiTransformComp,n=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===r6.Horizontal?(t.paddingLeft=(e.width-i.width)/2,t.paddingRight=(e.width-n.width)/2):this.direction===r6.Vertical&&(t.paddingTop=(e.height-i.height)/2,t.paddingBottom=(e.height-n.height)/2)}t.updateLayout()}}_initPages(){if(!this.content)return;this._initContentPos=this.content.position;const e=this.content.children;for(let t=0;t<e.length;++t){const i=e[t];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}_dispatchPageTurningEvent(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,TP.emitEvents(this.pageEvents,this,a6.PAGE_TURNING),this.node.emit(a6.PAGE_TURNING,this))}_isQuicklyScrollable(e){if(this.direction===r6.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===r6.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}_moveOffsetValue(e){const t=new nn;if(this._sizeMode===o6.Free)this.direction===r6.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===r6.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{const i=this.view;if(!i)return t;this.direction===r6.Horizontal?t.x=e*i.width:this.direction===r6.Vertical&&(t.y=e*i.height)}return t}_getDragDirection(e){return this._direction===r6.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1}_isScrollable(e,t,i){if(this._sizeMode===o6.Free){let n=0,s=0;if(this.direction===r6.Horizontal)return n=this._scrollCenterOffsetX[t],s=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-s)*this.scrollThreshold;if(this.direction===r6.Vertical)return n=this._scrollCenterOffsetY[t],s=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-s)*this.scrollThreshold}else{const t=this.view;if(!t)return!1;if(this.direction===r6.Horizontal)return Math.abs(e.x)>=t.width*this.scrollThreshold;if(this.direction===r6.Vertical)return Math.abs(e.y)>=t.height*this.scrollThreshold}return!1}_autoScrollToPage(){if(this._startBounceBackIfNeeded()){const e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{const e=new nn;nn.subtract(e,this._touchBeganPosition,this._touchEndPosition);const t=this._curPageIdx,i=t+this._getDragDirection(e),n=this.pageTurningSpeed*Math.abs(t-i);if(i<this._pages.length){if(this._isScrollable(e,t,i))return void this.scrollToPage(i,n);{const e=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(e))return void this.scrollToPage(i,n)}}this.scrollToPage(t,n)}}},i6.SizeMode=o6,i6.Direction=r6,i6.EventType=f4(a6,V2),Oc((V5=n6).prototype,"sizeMode",[x5,S5],Object.getOwnPropertyDescriptor(V5.prototype,"sizeMode"),V5.prototype),Oc(V5.prototype,"direction",[b5,T5],Object.getOwnPropertyDescriptor(V5.prototype,"direction"),V5.prototype),Oc(V5.prototype,"scrollThreshold",[gl,E5,C5],Object.getOwnPropertyDescriptor(V5.prototype,"scrollThreshold"),V5.prototype),Oc(V5.prototype,"pageTurningEventTiming",[gl,w5,A5],Object.getOwnPropertyDescriptor(V5.prototype,"pageTurningEventTiming"),V5.prototype),Oc(V5.prototype,"indicator",[P5,R5],Object.getOwnPropertyDescriptor(V5.prototype,"indicator"),V5.prototype),j5=Oc(V5.prototype,"autoPageTurningThreshold",[Qc,I5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Oc(V5.prototype,"verticalScrollBar",[M5,Pl,O5],Object.getOwnPropertyDescriptor(V5.prototype,"verticalScrollBar"),V5.prototype),Oc(V5.prototype,"horizontalScrollBar",[D5,Pl,N5],Object.getOwnPropertyDescriptor(V5.prototype,"horizontalScrollBar"),V5.prototype),W5=Oc(V5.prototype,"horizontal",[Pl,Qc,L5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),q5=Oc(V5.prototype,"vertical",[Pl,Qc,B5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X5=Oc(V5.prototype,"cancelInnerEvents",[Pl,Qc,z5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y5=Oc(V5.prototype,"scrollEvents",[F5,Qc,Pl,U5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),K5=Oc(V5.prototype,"pageTurningSpeed",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),$5=Oc(V5.prototype,"pageEvents",[G5,Qc,k5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Q5=Oc(V5.prototype,"_sizeMode",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return o6.Unified}}),Z5=Oc(V5.prototype,"_direction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return r6.Horizontal}}),J5=Oc(V5.prototype,"_scrollThreshold",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),e6=Oc(V5.prototype,"_pageTurningEventTiming",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),t6=Oc(V5.prototype,"_indicator",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H5=V5))||H5)||H5)||H5)||H5));const l6=new zi,h6=new nn,u6=new nn,_6=new nn(1,1),p6=new nn,d6=new nn;function f6(e,t){if(t._hadAlignOnce)return;t.alignMode===V3.ONCE&&(t._hadAlignOnce=!0);const i=t.target;let n;const s=u6,o=_6;i?(n=i,H3(e,n,s,o)):n=e.parent;const r=k3(n),a=n instanceof ZE||!n.getComponent(EH),c=a?h6:n.getComponent(EH).anchorPoint,l=a;e.getPosition(l6);const h=e._uiProps.uiTransformComp;let u=l6.x,_=l6.y;const p=h.anchorPoint,d=e.getScale();if(t.alignFlags&j3.HORIZONTAL){let e=0,n=0;const a=r.width;l?(e=Mw.left.x,n=Mw.right.x):(e=-c.x*a,n=e+a),e+=t.isAbsoluteLeft?t.left:t.left*a,n-=t.isAbsoluteRight?t.right:t.right*a,i&&(e+=s.x,e*=o.x,n+=s.x,n*=o.x);let _=0,f=p.x,m=d.x;if(m<0&&(f=1-f,m=-m),t.isStretchWidth)_=n-e,0!==m&&(h.width=_/m),u=e+f*_;else if(_=h.width*m,t.isAlignHorizontalCenter){let e=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*a,n=(.5-c.x)*r.width;i&&(e*=o.x,n+=s.x,n*=o.x),u=n+(f-.5)*_+e}else u=t.isAlignLeft?e+f*_:n+(f-1)*_;t._lastSize.width=_}if(t.alignFlags&j3.VERTICAL){let e=0,n=0;const a=r.height;l?(n=Mw.bottom.y,e=Mw.top.y):(n=-c.y*a,e=n+a),n+=t.isAbsoluteBottom?t.bottom:t.bottom*a,e-=t.isAbsoluteTop?t.top:t.top*a,i&&(n+=s.y,n*=o.y,e+=s.y,e*=o.y);let u=0,f=p.y,m=d.y;if(m<0&&(f=1-f,m=-m),t.isStretchHeight)u=e-n,0!==m&&(h.height=u/m),_=n+f*u;else if(u=h.height*m,t.isAlignVerticalCenter){let e=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*a,n=(.5-c.y)*r.height;i&&(e*=o.y,n+=s.y,n*=o.y),_=n+(f-.5)*u+e}else _=t.isAlignBottom?n+f*u:e+(f-1)*u;t._lastSize.height=u}e.setPosition(u,_,l6.z),zi.set(t._lastPos,u,_,l6.z)}function m6(e){const t=e.getComponent(X3);if(t&&t.enabled){if(!n.isValid(e,!0))return;v6.push(t)}const i=e.children;for(const e of i)e.active&&m6(e)}function g6(){const e=Qw.getScene();if(e){y6.isAligning=!0,y6._nodesOrderDirty&&(v6.length=0,m6(e),y6._nodesOrderDirty=!1);let t=null;const i=y6._activeWidgetsIterator;for(i.i=0;i.i<v6.length;++i.i)t=v6[i.i],t._dirty&&(f6(t.node,t),t._dirty=!1);y6.isAligning=!1}}const v6=[],y6=e("widgetManager",n._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Oe.MutableForwardIterator(v6),animationState:null,init(){Qw.on($w.EVENT_AFTER_SCENE_LAUNCH,g6),Qw.on($w.EVENT_AFTER_UPDATE,g6),Nw.instance.on("design-resolution-changed",this.onResized,this);{const e=this.onResized.bind(this);Nw.instance.on("canvas-resize",e),gn.on("orientation-change",e)}},add(e){this._nodesOrderDirty=!0},remove(e){this._activeWidgetsIterator.remove(e)},onResized(){const e=Qw.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized(e){const t=ix.isNode(e)&&e.getComponent(X3);t&&t.enabled&&(t.alignMode===V3.ON_WINDOW_RESIZE||t.alignMode===V3.ALWAYS)&&t.setDirty();const i=e.children;for(const e of i)this.refreshWidgetOnResized(e)},updateOffsetsToStayPut(e,t){function i(e,t){return Math.abs(e-t)>1e-10?t:e}const n=e.node;let s=n.parent;if(s){const o=p6;o.set(0,0);const r=d6;if(r.set(1,1),e.target&&(s=e.target,H3(n,s,o,r)),!t)return;const a=s._uiProps&&s._uiProps.uiTransformComp,c=a?a.anchorPoint:h6,l=n._uiProps.uiTransformComp,h=k3(s),u=l.anchorPoint,_=n.getPosition(),p=j3,d=n.getScale();let f=0;if(t&p.LEFT){let t=-c.x*h.width;t+=o.x,t*=r.x,f=_.x-u.x*l.width*d.x-t,e.isAbsoluteLeft||(f/=h.width),f/=r.x,e.left=i(e.left,f)}if(t&p.RIGHT){let t=(1-c.x)*h.width;t+=o.x,f=(t*=r.x)-(_.x+(1-u.x)*l.width*d.x),e.isAbsoluteRight||(f/=h.width),f/=r.x,e.right=i(e.right,f)}if(t&p.TOP){let t=(1-c.y)*h.height;t+=o.y,f=(t*=r.y)-(_.y+(1-u.y)*l.height*d.y),e.isAbsoluteTop||(f/=h.height),f/=r.y,e.top=i(e.top,f)}if(t&p.BOT){let t=-c.y*h.height;t+=o.y,t*=r.y,f=_.y-u.y*l.height*d.y-t,e.isAbsoluteBottom||(f/=h.height),f/=r.y,e.bottom=i(e.bottom,f)}}},updateAlignment:function e(t){const i=t.parent;i&&ix.isNode(i)&&e(i);const n=t.getComponent(X3);n&&i&&f6(t,n)},AlignMode:V3,AlignFlags:j3});var x6;Qw.on($w.EVENT_INIT,(()=>{y6.init()}));let S6=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(Wc("cc.SafeArea")(x6=al()(x6=Xc(110)(x6=il(x6=nl()(x6=qc(X3)(x6=class extends Gh{onEnable(){this.updateArea(),gn.on("window-resize",this.updateArea,this),gn.on("orientation-change",this.updateArea,this)}onDisable(){gn.off("window-resize",this.updateArea,this),gn.off("orientation-change",this.updateArea,this)}updateArea(){const e=this.node.getComponent(X3),t=this.node.getComponent(EH);if(!e||!t)return;e.updateAlignment();const i=this.node.position.clone(),n=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;const s=Fw.getVisibleSize(),o=s.width,r=s.height,a=xn.getSafeAreaRect();e.top=r-a.y-a.height,e.bottom=a.y,e.left=a.x,e.right=o-a.x-a.width,e.updateAlignment();const c=this.node.position.clone(),l=n.x-(c.x-i.x)/t.width,h=n.y-(c.y-i.y)/t.height;t.setAnchorPoint(l,h),y6.add(e)}})||x6)||x6)||x6)||x6)||x6)||x6);var b6,T6,E6,C6,w6,A6,P6,R6,I6,M6,O6,D6,N6,L6,B6,z6,F6,U6,G6;let k6=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((b6=Wc("cc.UICoordinateTracker"),T6=al(),E6=nl(),C6=Xc(110),w6=Al(ix),A6=_l(),P6=Al(jR),R6=_l(),I6=_l(),M6=_l(),O6=Al([TP]),D6=_l(),b6(N6=T6(N6=E6(N6=C6((Oc((L6=class extends Gh{constructor(...e){super(...e),Mc(this,"syncEvents",B6,this),Mc(this,"_target",z6,this),Mc(this,"_camera",F6,this),Mc(this,"_useScale",U6,this),Mc(this,"_distance",G6,this),this._transformPos=new zi,this._viewPos=new zi,this._canMove=!0,this._lastWPos=new zi,this._lastCameraPos=new zi}get target(){return this._target}set target(e){this._target!==e&&(this._target=e,this._checkCanMove())}get camera(){return this._camera}set camera(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}get useScale(){return this._useScale}set useScale(e){this._useScale!==e&&(this._useScale=e)}get distance(){return this._distance}set distance(e){this._distance!==e&&(this._distance=e)}onEnable(){this._checkCanMove()}update(){const e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&zi.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){const e=this._distance/Math.abs(this._viewPos.z);TP.emitEvents(this.syncEvents,this._transformPos,e)}}_checkCanMove(){this._canMove=!(!this._camera||!this._target)}}).prototype,"target",[w6,A6],Object.getOwnPropertyDescriptor(L6.prototype,"target"),L6.prototype),Oc(L6.prototype,"camera",[P6,R6],Object.getOwnPropertyDescriptor(L6.prototype,"camera"),L6.prototype),Oc(L6.prototype,"useScale",[I6],Object.getOwnPropertyDescriptor(L6.prototype,"useScale"),L6.prototype),Oc(L6.prototype,"distance",[M6],Object.getOwnPropertyDescriptor(L6.prototype,"distance"),L6.prototype),B6=Oc(L6.prototype,"syncEvents",[O6,Qc,D6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z6=Oc(L6.prototype,"_target",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F6=Oc(L6.prototype,"_camera",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U6=Oc(L6.prototype,"_useScale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),G6=Oc(L6.prototype,"_distance",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),N6=L6))||N6)||N6)||N6)||N6));var H6;const V6=[cy.TOUCH_START,cy.TOUCH_END,cy.TOUCH_MOVE,cy.MOUSE_DOWN,cy.MOUSE_MOVE,cy.MOUSE_UP,cy.MOUSE_ENTER,cy.MOUSE_LEAVE,cy.MOUSE_WHEEL];function j6(e){e.propagationStopped=!0}let W6=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(Wc("cc.BlockInputEvents")(H6=al()(H6=nl()(H6=class extends Gh{onEnable(){for(let e=0;e<V6.length;e++)this.node.on(V6[e],j6,this)}onDisable(){for(let e=0;e<V6.length;e++)this.node.off(V6[e],j6,this)}})||H6)||H6)||H6);const q6={};var X6,Y6,K6,$6,Q6,Z6,J6,e8,t8,i8,n8;let s8=e("SubContextView",(X6=Wc("cc.SubContextView"),Y6=al(),K6=Xc(110),$6=qc(EH),Q6=nl(),Z6=_l(),J6=_l(),X6(e8=Y6(e8=K6(e8=$6(e8=Q6((Oc((t8=class extends Gh{get designResolutionSize(){return this._designResolutionSize}set designResolutionSize(e){}get fps(){return this._fps}set fps(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}constructor(){super(),Mc(this,"_fps",i8,this),this._sprite=void 0,this._imageAsset=void 0,this._texture=void 0,this._updatedTime=0,this._updateInterval=0,this._openDataContext=void 0,this._content=void 0,Mc(this,"_designResolutionSize",n8,this),this._content=new ix("content"),this._content.hideFlags|=Ot.Flags.DontSave|Ot.Flags.HideInHierarchy,this._sprite=null,this._imageAsset=new Wf,this._openDataContext=null,this._updatedTime=performance.now(),this._texture=new wm}onLoad(){q6.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=q6.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1}onEnable(){this._registerNodeEvent()}onDisable(){this._unregisterNodeEvent()}_initSharedCanvas(){if(this._openDataContext){const e=this._openDataContext.canvas;e.width=this._designResolutionSize.width,e.height=this._designResolutionSize.height}}_initContentNode(){if(this._openDataContext){const e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(Oq),this._sprite||(this._sprite=this._content.addComponent(Oq)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{const e=new nk;e.texture=this._texture,this._sprite.spriteFrame=e}this._content.parent=this.node}}_updateSubContextView(){if(!this._openDataContext)return;const e=this.node.getComponent(EH),t=this._content.getComponent(EH),i=e.width/t.width,n=e.height/t.height,s=i>n?n:i;t.width*=s,t.height*=s;const o=Fw.getViewportRect(),r=t.getBoundingBoxToWorld(),a=Fw.getVisibleSize(),c=Fw.getDevicePixelRatio(),l=(o.width*(r.x/a.width)+o.x)/c,h=(o.height*(r.y/a.height)+o.y)/c,u=o.width*(r.width/a.width)/c,_=o.height*(r.height/a.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:h,width:u,height:_})}_updateSubContextTexture(){const e=this._imageAsset;if(!e||!this._openDataContext)return;if(e.width<=0||e.height<=0)return;const t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}_registerNodeEvent(){this.node.on(cy.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(cy.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(cy.LAYER_CHANGED,this._updateContentLayer,this)}_unregisterNodeEvent(){this.node.off(cy.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(cy.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(cy.LAYER_CHANGED,this._updateContentLayer,this)}_updateContentLayer(){this._content.layer=this.node.layer}update(e){void 0!==e?performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture()):this._updateSubContextTexture()}onDestroy(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null}}).prototype,"designResolutionSize",[Z6],Object.getOwnPropertyDescriptor(t8.prototype,"designResolutionSize"),t8.prototype),Oc(t8.prototype,"fps",[J6],Object.getOwnPropertyDescriptor(t8.prototype,"fps"),t8.prototype),i8=Oc(t8.prototype,"_fps",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),n8=Oc(t8.prototype,"_designResolutionSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hn(640,960)}}),e8=t8))||e8)||e8)||e8)||e8)||e8));var o8;n.SubContextView=s8;let r8=e("UIReorderComponent",Wc("cc.UIReorderComponent")(o8=class{constructor(){T(1408,"UIReorderComponent")}})||o8);var a8,c8,l8,h8,u8,_8,p8,d8,f8,m8,g8,v8,y8,x8,S8;n.UIReorderComponent=r8,n.ButtonComponent=SZ,De.setClassAlias(SZ,"cc.ButtonComponent"),n.EditBoxComponent=RJ,De.setClassAlias(RJ,"cc.EditBoxComponent"),n.LayoutComponent=z0,De.setClassAlias(z0,"cc.LayoutComponent"),n.ProgressBarComponent=a1,De.setClassAlias(a1,"cc.ProgressBarComponent"),n.ScrollViewComponent=j2,De.setClassAlias(j2,"cc.ScrollViewComponent"),n.ScrollBarComponent=U1,De.setClassAlias(U1,"cc.ScrollBarComponent"),n.SliderComponent=d4,De.setClassAlias(d4,"cc.SliderComponent"),n.ToggleComponent=B4,De.setClassAlias(B4,"cc.ToggleComponent"),n.ToggleContainerComponent=Y4,De.setClassAlias(Y4,"cc.ToggleContainerComponent"),n.WidgetComponent=X3,De.setClassAlias(X3,"cc.WidgetComponent"),n.PageViewComponent=c6,De.setClassAlias(c6,"cc.PageViewComponent"),n.PageViewIndicatorComponent=f5,De.setClassAlias(f5,"cc.PageViewIndicatorComponent"),n.SafeAreaComponent=S6,De.setClassAlias(S6,"cc.SafeAreaComponent"),De.setClassAlias(k6,"cc.UICoordinateTrackerComponent"),n.BlockInputEventsComponent=W6,De.setClassAlias(W6,"cc.BlockInputEventsComponent");let b8=function(t){return e({Billboard:t,BillboardComponent:t}),t}((a8=Wc("cc.Billboard"),c8=al(),l8=nl(),h8=Al(wm),u8=Al(wm),_8=_l(),p8=_l(),d8=_l(),f8=_l(),a8(m8=c8(m8=l8(m8=il((v8=Oc((g8=class extends Gh{get texture(){return this._texture}set texture(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}get height(){return this._height}set height(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}get width(){return this._width}set width(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}get rotation(){return Math.round(100*vi(this._rotation))/100}set rotation(e){this._rotation=gi(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}constructor(){super(),Mc(this,"_texture",v8,this),Mc(this,"_height",y8,this),Mc(this,"_width",x8,this),Mc(this,"_rotation",S8,this),this._model=null,this._mesh=null,this._material=null,this._uniform=new an(1,1,0,0)}onLoad(){this.createModel()}onEnable(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}onDisable(){this.detachFromScene()}attachToScene(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}createModel(){this._mesh=VB({primitiveMode:oo.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[Di.WHITE.r,Di.WHITE.g,Di.WHITE.b,Di.WHITE.a,Di.WHITE.r,Di.WHITE.g,Di.WHITE.b,Di.WHITE.a,Di.WHITE.r,Di.WHITE.g,Di.WHITE.b,Di.WHITE.a,Di.WHITE.r,Di.WHITE.g,Di.WHITE.b,Di.WHITE.a],attributes:[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RG32F),new Xo(mo.ATTR_COLOR,Ls.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});const e=this._model=n.director.root.createModel(Tg,this.node);e.node=e.transform=this.node,null==this._material&&(this._material=new Wg,this._material.copy(cg.get("default-billboard-material"))),e.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)}}).prototype,"_texture",[h8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(g8.prototype,"texture",[u8,_8],Object.getOwnPropertyDescriptor(g8.prototype,"texture"),g8.prototype),y8=Oc(g8.prototype,"_height",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oc(g8.prototype,"height",[p8],Object.getOwnPropertyDescriptor(g8.prototype,"height"),g8.prototype),x8=Oc(g8.prototype,"_width",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oc(g8.prototype,"width",[d8],Object.getOwnPropertyDescriptor(g8.prototype,"width"),g8.prototype),S8=Oc(g8.prototype,"_rotation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oc(g8.prototype,"rotation",[f8],Object.getOwnPropertyDescriptor(g8.prototype,"rotation"),g8.prototype),m8=g8))||m8)||m8)||m8)||m8));const T8=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RGBA32F),new Xo(mo.ATTR_TEX_COORD1,Ls.RGB32F),new Xo(mo.ATTR_COLOR,Ls.RGBA8,!0)],E8=new zi,C8=new zi;class w8 extends Tg{constructor(){super(),this._capacity=void 0,this._vertSize=0,this._vBuffer=null,this._vertAttrsFloatCount=0,this._vdataF32=null,this._vdataUint32=null,this._iaInfo=void 0,this._iaInfoBuffer=void 0,this._subMeshData=null,this._vertCount=0,this._indexCount=0,this._material=null,this.type=xg.LINE,this._capacity=100,this._iaInfo=new No([new Oo]),this._iaInfoBuffer=this._device.createBuffer(new Io(Fs.INDIRECT,ks.HOST|ks.DEVICE,br,br))}setCapacity(e){this._capacity=e,this.createBuffer()}createBuffer(){this._vertSize=0;for(const e of T8)e.offset=this._vertSize,this._vertSize+=vr[e.format].size;this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}updateMaterial(e){this._material=e,super.setSubModelMaterial(0,e)}createSubMeshData(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;const e=this._device.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);const i=new Uint16Array((this._capacity-1)*this._indexCount);let n=0;for(let e=0;e<this._capacity-1;++e){const t=2*e;i[n++]=t,i[n++]=t+1,i[n++]=t+2,i[n++]=t+3,i[n++]=t+2,i[n++]=t+1}const s=this._device.createBuffer(new Io(Fs.INDEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return s.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new cb([e],T8,oo.TRIANGLE_LIST,s,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t}addLineVertexData(e,t,i){if(e.length>1){let n=0;zi.subtract(E8,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=E8.x,this._vdataF32[n++]=E8.y,this._vdataF32[n++]=E8.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=E8.x,this._vdataF32[n++]=E8.y,this._vdataF32[n++]=E8.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(let s=1;s<e.length-1;s++){zi.subtract(E8,e[s-1],e[s]),zi.subtract(C8,e[s+1],e[s]),zi.subtract(C8,C8,E8);const o=s/e.length;this._vdataF32[n++]=e[s].x,this._vdataF32[n++]=e[s].y,this._vdataF32[n++]=e[s].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(o,1),this._vdataF32[n++]=o,this._vdataF32[n++]=0,this._vdataF32[n++]=C8.x,this._vdataF32[n++]=C8.y,this._vdataF32[n++]=C8.z,this._vdataUint32[n++]=i.evaluate(o,1)._val,this._vdataF32[n++]=e[s].x,this._vdataF32[n++]=e[s].y,this._vdataF32[n++]=e[s].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(o,1),this._vdataF32[n++]=o,this._vdataF32[n++]=1,this._vdataF32[n++]=C8.x,this._vdataF32[n++]=C8.y,this._vdataF32[n++]=C8.z,this._vdataUint32[n++]=i.evaluate(o,1)._val}zi.subtract(E8,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=E8.x,this._vdataF32[n++]=E8.y,this._vdataF32[n++]=E8.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=E8.x,this._vdataF32[n++]=E8.y,this._vdataF32[n++]=E8.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}updateIA(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)}destroySubMeshData(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}var A8,P8,R8,I8,M8,O8,D8,N8,L8,B8,z8,F8,U8,G8,k8,H8,V8;const j8=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],W8=Le({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3});let q8=e("CurveRange",(A8=Wc("cc.CurveRange"),P8=Al(W8),R8=Al(q_),I8=Al(q_),M8=Al(q_),A8((V8=H8=class{get curve(){return this._curve}set curve(e){this._curve=e,this.spline=e._internalCurve}get curveMin(){return this._curveMin}set curveMin(e){this._curveMin=e,this.splineMin=e._internalCurve}get curveMax(){return this._curveMax}set curveMax(e){this._curveMax=e,this.splineMax=e._internalCurve}constructor(){Mc(this,"mode",N8,this),Mc(this,"spline",L8,this),Mc(this,"splineMin",B8,this),Mc(this,"splineMax",z8,this),Mc(this,"constant",F8,this),Mc(this,"constantMin",U8,this),Mc(this,"constantMax",G8,this),Mc(this,"multiplier",k8,this),this._curve=new Kp(this.spline),this._curveMin=new Kp(this.splineMin),this._curveMax=new Kp(this.splineMax)}evaluate(e,t){switch(this.mode){default:case W8.Constant:return this.constant;case W8.Curve:return this.spline.evaluate(e)*this.multiplier;case W8.TwoCurves:return mi(this.splineMin.evaluate(e),this.splineMax.evaluate(e),t)*this.multiplier;case W8.TwoConstants:return mi(this.constantMin,this.constantMax,t)}}getMax(){switch(this.mode){default:case W8.Constant:return this.constant;case W8.Curve:return this.multiplier;case W8.TwoConstants:return this.constantMax;case W8.TwoCurves:return this.multiplier}}_onBeforeSerialize(e){return j8[this.mode]}},H8.Mode=W8,N8=Oc((D8=V8).prototype,"mode",[P8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W8.Constant}}),L8=Oc(D8.prototype,"spline",[R8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zp()}}),B8=Oc(D8.prototype,"splineMin",[I8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zp()}}),z8=Oc(D8.prototype,"splineMax",[M8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zp()}}),F8=Oc(D8.prototype,"constant",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),U8=Oc(D8.prototype,"constantMin",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G8=Oc(D8.prototype,"constantMax",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),k8=Oc(D8.prototype,"multiplier",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),O8=D8))||O8));function X8(e,t,i){switch(e.mode){case W8.Constant:return e.constant;case W8.Curve:return e.spline.evaluate(t)*e.multiplier;case W8.TwoCurves:return 0===i?e.splineMin.evaluate(t)*e.multiplier:e.splineMax.evaluate(t)*e.multiplier;case W8.TwoConstants:return 0===i?e.constantMin:e.constantMax;default:return 0}}function Y8(e){switch(e.mode){case W8.TwoConstants:case W8.TwoCurves:return 2;default:return 1}}function K8(e,t,i){const n=new Wf({width:t,height:i,_data:e,_compressed:!1,format:Lf.RGBA32F}),s=new wm;return s.setFilters(zf.NEAREST,zf.NEAREST),s.setMipFilter(zf.NONE),s.setWrapMode(Bf.CLAMP_TO_EDGE,Bf.CLAMP_TO_EDGE,Bf.CLAMP_TO_EDGE),s.image=n,s}function $8(e,t,i,n,s){const o=Math.max(Y8(t),Y8(i),Y8(n)),r=new Float32Array(e*o*4),a=[t,i,n],c=1/(e-1);for(let t=0;t<o;t++)for(let i=0;i<3;i++){const n=a[i];let o=0,l=0;for(let a=0;a<e;a++){const e=X8(n,c*a,t);s?l=e:(o+=e,l=o/(a+1)),r[4*a+i]=l}}return K8(r,e,o)}var Q8,Z8,J8,e7,t7,i7,n7,s7,o7,r7,a7,c7,l7,h7,u7;const _7=Le({Blend:0,Fixed:1});e("ColorKey",Wc("cc.ColorKey")((J8=Oc((Z8=class{constructor(){Mc(this,"color",J8,this),Mc(this,"time",e7,this)}}).prototype,"color",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),e7=Oc(Z8.prototype,"time",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q8=Z8))||Q8),e("AlphaKey",Wc("cc.AlphaKey")((n7=Oc((i7=class{constructor(){Mc(this,"alpha",n7,this),Mc(this,"time",s7,this)}}).prototype,"alpha",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),s7=Oc(i7.prototype,"time",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),t7=i7))||t7);let p7=e("Gradient",Wc("cc.Gradient")((u7=h7=class{constructor(){Mc(this,"colorKeys",a7,this),Mc(this,"alphaKeys",c7,this),Mc(this,"mode",l7,this),this._color=void 0,this._color=Di.WHITE.clone()}setKeys(e,t){this.colorKeys=e,this.alphaKeys=t}sortKeys(){this.colorKeys.length>1&&this.colorKeys.sort(((e,t)=>e.time-t.time)),this.alphaKeys.length>1&&this.alphaKeys.sort(((e,t)=>e.time-t.time))}evaluate(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}randomColor(){const e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}getRGB(e){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(Di.WHITE),this._color);{e=wi(e,1);for(let t=1;t<this.colorKeys.length;++t){const i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(e>=i&&e<n){if(this.mode===_7.Fixed)return this.colorKeys[t].color;const s=(e-i)/(n-i);return Di.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,s),this._color}}const t=this.colorKeys.length-1;e<this.colorKeys[0].time?Di.lerp(this._color,Di.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[t].time&&Di.lerp(this._color,this.colorKeys[t].color,Di.BLACK,(e-this.colorKeys[t].time)/(1-this.colorKeys[t].time))}}getAlpha(e){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;{e=wi(e,1);for(let t=1;t<this.alphaKeys.length;++t){const i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(e>=i&&e<n){if(this.mode===_7.Fixed)return this.alphaKeys[t].alpha;const s=(e-i)/(n-i);return mi(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,s)}}const t=this.alphaKeys.length-1;if(e<this.alphaKeys[0].time)return mi(0,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time);if(e>this.alphaKeys[t].time)return mi(this.alphaKeys[t].alpha,0,(e-this.alphaKeys[t].time)/(1-this.alphaKeys[t].time))}}},h7.Mode=_7,a7=Oc((r7=u7).prototype,"colorKeys",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),c7=Oc(r7.prototype,"alphaKeys",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),l7=Oc(r7.prototype,"mode",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _7.Blend}}),o7=r7))||o7);var d7,f7,m7,g7,v7,y7,x7,S7,b7,T7,E7,C7,w7,A7,P7,R7,I7;const M7=Le({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4});let O7=e("GradientRange",(d7=Wc("cc.GradientRange"),f7=Al(M7),m7=Al(p7),g7=Al(p7),v7=Al(p7),y7=Al(M7),d7((I7=R7=class{constructor(){Mc(this,"color",b7,this),Mc(this,"colorMin",T7,this),Mc(this,"colorMax",E7,this),Mc(this,"gradient",C7,this),Mc(this,"gradientMin",w7,this),Mc(this,"gradientMax",A7,this),Mc(this,"_mode",P7,this),this._color=Di.WHITE.clone()}get mode(){return this._mode}set mode(e){this._mode=e}evaluate(e,t){switch(this._mode){case M7.Color:return this.color;case M7.TwoColors:return Di.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case M7.RandomColor:return this.gradient.randomColor();case M7.Gradient:return this.gradient.evaluate(e);case M7.TwoGradients:return Di.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}}_onBeforeSerialize(e){return(!1)[this._mode]}},R7.Mode=M7,Oc((S7=I7).prototype,"mode",[f7],Object.getOwnPropertyDescriptor(S7.prototype,"mode"),S7.prototype),b7=Oc(S7.prototype,"color",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),T7=Oc(S7.prototype,"colorMin",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),E7=Oc(S7.prototype,"colorMax",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.WHITE.clone()}}),C7=Oc(S7.prototype,"gradient",[m7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p7}}),w7=Oc(S7.prototype,"gradientMin",[g7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p7}}),A7=Oc(S7.prototype,"gradientMax",[v7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p7}}),P7=Oc(S7.prototype,"_mode",[y7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M7.Color}}),x7=S7))||x7));function D7(e,t,i){switch(e.mode){case M7.Color:return e.color;case M7.TwoColors:return 0===i?e.colorMin:e.colorMax;case M7.RandomColor:return e.gradient.randomColor();case M7.Gradient:return e.gradient.evaluate(t);case M7.TwoGradients:return 0===i?e.gradientMin.evaluate(t):e.gradientMax.evaluate(t);default:return e.color}}var N7,L7,B7,z7,F7,U7,G7,k7,H7,V7,j7,W7,q7,X7,Y7,K7,$7,Q7,Z7,J7,e9,t9,i9,n9,s9,o9,r9,a9,c9,l9,h9,u9,_9,p9,d9,f9,m9,g9;const v9={parent:null,owner:null,subModelIdx:0},y9={CC_USE_WORLD_SPACE:!1};let x9=function(t){return e({Line:t,LineComponent:t}),t}((N7=Wc("cc.Line"),L7=al(),B7=nl(),z7=Al(wm),F7=Al(wm),U7=vl(),G7=_l(),k7=vl(),H7=_l(),V7=Al([zi]),j7=Al([zi]),W7=vl(),q7=_l(),X7=Al(q8),Y7=pl(),K7=Al(q8),$7=pl(),Q7=vl(),Z7=_l(),J7=Al(nn),e9=vl(),t9=_l(),i9=Al(nn),n9=vl(),s9=_l(),o9=Al(O7),r9=Al(O7),a9=vl(),c9=_l(),N7(l9=L7(l9=B7(l9=il((u9=Oc((h9=class extends Gh{get texture(){return this._texture}set texture(e){this._texture=e,this._materialInstance&&this._materialInstance.setProperty("mainTexture",e)}get worldSpace(){return this._worldSpace}set worldSpace(e){this._worldSpace=e,this._materialInstance&&(y9.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(y9),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}get positions(){return this._positions}set positions(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}get width(){return this._width}set width(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}get tile(){return this._tile}set tile(e){this._tile.set(e),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}get offset(){return this._offset}set offset(e){this._offset.set(e),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}get color(){return this._color}set color(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}constructor(){super(),Mc(this,"_texture",u9,this),this._material=null,this._materialInstance=null,Mc(this,"_worldSpace",_9,this),Mc(this,"_positions",p9,this),Mc(this,"_width",d9,this),Mc(this,"_tile",f9,this),Mc(this,"_offset",m9,this),Mc(this,"_color",g9,this),this._model=null,this._tile_offset=new an}onLoad(){const e=this._model=n.director.root.createModel(w8);e.node=e.transform=this.node,null===this._material&&(this._material=new Wg,this._material.copy(cg.get("default-trail-material")),y9.CC_USE_WORLD_SPACE=this.worldSpace,v9.parent=this._material,v9.subModelIdx=0,this._materialInstance=new av(v9),v9.parent=null,v9.subModelIdx=0,this._materialInstance.recompileShaders(y9)),e.updateMaterial(this._materialInstance),e.setCapacity(100)}onEnable(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))}onDisable(){this._model&&this._detachFromScene()}_attachToScene(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}}).prototype,"_texture",[z7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(h9.prototype,"texture",[F7,U7,G7],Object.getOwnPropertyDescriptor(h9.prototype,"texture"),h9.prototype),_9=Oc(h9.prototype,"_worldSpace",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(h9.prototype,"worldSpace",[k7,H7],Object.getOwnPropertyDescriptor(h9.prototype,"worldSpace"),h9.prototype),p9=Oc(h9.prototype,"_positions",[V7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oc(h9.prototype,"positions",[j7,W7,q7],Object.getOwnPropertyDescriptor(h9.prototype,"positions"),h9.prototype),d9=Oc(h9.prototype,"_width",[X7,Y7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Oc(h9.prototype,"width",[K7,$7,Q7,Z7],Object.getOwnPropertyDescriptor(h9.prototype,"width"),h9.prototype),f9=Oc(h9.prototype,"_tile",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(1,1)}}),Oc(h9.prototype,"tile",[J7,e9,t9],Object.getOwnPropertyDescriptor(h9.prototype,"tile"),h9.prototype),m9=Oc(h9.prototype,"_offset",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(0,0)}}),Oc(h9.prototype,"offset",[i9,n9,s9],Object.getOwnPropertyDescriptor(h9.prototype,"offset"),h9.prototype),g9=Oc(h9.prototype,"_color",[o9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new O7}}),Oc(h9.prototype,"color",[r9,a9,c9],Object.getOwnPropertyDescriptor(h9.prototype,"color"),h9.prototype),l9=h9))||l9)||l9)||l9)||l9));class S9{constructor(e){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new zi(0,0,0),this.velocity=new zi(0,0,0),this.animatedVelocity=new zi(0,0,0),this.ultimateVelocity=new zi(0,0,0),this.angularVelocity=new zi(0,0,0),this.axisOfRotation=new zi(0,0,0),this.rotation=new zi(0,0,0),this.startEuler=new zi(0,0,0),this.startRotation=new ji,this.deltaQuat=new ji,this.deltaMat=new Zi,this.localMat=new Zi,this.startSize=new zi(0,0,0),this.size=new zi(0,0,0),this.startColor=Di.WHITE.clone(),this.color=Di.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}reset(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()}}S9.INDENTIFY_NEG_QUAT=10,S9.R2D=180/Math.PI;const b9=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],T9=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"];class E9{constructor(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}bindTarget(e){this.target=e}update(e,t){}}const C9=Le({World:0,Local:1,Custom:2}),w9=Le({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),A9=Le({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),P9=Le({Base:0,Edge:1,Shell:2,Volume:3}),R9=Le({Random:0,Loop:1,PingPong:2}),I9=Le({Particles:0}),M9=Le({Stretch:0});var O9,D9,N9,L9,B9,z9,F9,U9;let G9=(O9=Wc("cc.ColorOvertimeModule"),D9=vl(),N9=Al(O7),L9=vl(),O9((F9=Oc((z9=class extends E9{constructor(...e){super(...e),Mc(this,"_enable",F9,this),Mc(this,"color",U9,this),this.name="colorModule"}get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}animate(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,bi(e.randomSeed+91041)))}}).prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(z9.prototype,"enable",[D9],Object.getOwnPropertyDescriptor(z9.prototype,"enable"),z9.prototype),U9=Oc(z9.prototype,"color",[N9,Qc,L9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new O7}}),B9=z9))||B9);const k9=new zi(0,0,-1);function H9(e,t,i,n){return t!==e?(e===C9.World||Zi.invert(i,i),Zi.getRotation(n,i),!0):(ji.set(n,0,0,0,1),!1)}function V9(e,t){nn.set(e,Math.cos(t),Math.sin(t))}function j9(e){const t=xi(-1,1),i=xi(0,2*Math.PI),n=Math.sqrt(1-t*t),s=n*Math.cos(i),o=n*Math.sin(i);zi.set(e,s,o,t)}function W9(e,t,i){j9(e),zi.multiplyScalar(e,e,t+(i-t)*yi())}function q9(e,t,i,n){V9(e,n),e.z=0,zi.multiplyScalar(e,e,t+(i-t)*yi())}function X9(e){for(let t=0;t<e.length;t++){const i=t+Si(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function Y9(){let e=xi(-1,1);return 0===e&&e++,Yt(e)}var K9,$9,Q9,Z9,J9,eee,tee,iee,nee,see,oee,ree,aee,cee,lee,hee,uee,_ee,pee,dee,fee,mee,gee,vee;const yee=212165,xee=new zi;let See=(K9=Wc("cc.ForceOvertimeModule"),$9=vl(),Q9=Al(q8),Z9=pl(),J9=vl(),eee=_l(),tee=Al(q8),iee=pl(),nee=vl(),see=_l(),oee=Al(q8),ree=pl(),aee=vl(),cee=_l(),lee=Al(C9),hee=vl(),uee=_l(),K9((dee=Oc((pee=class extends E9{get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}constructor(){super(),Mc(this,"_enable",dee,this),Mc(this,"x",fee,this),Mc(this,"y",mee,this),Mc(this,"z",gee,this),Mc(this,"space",vee,this),this.randomized=!1,this.rotation=void 0,this.needTransform=void 0,this.name="forceModule",this.rotation=new ji,this.needTransform=!1,this.needUpdate=!0}update(e,t){this.needTransform=H9(e,this.space,t,this.rotation)}animate(e,t){const i=1-e.remainingLifetime/e.startLifetime,n=zi.set(xee,this.x.evaluate(i,bi(e.randomSeed+yee)),this.y.evaluate(i,bi(e.randomSeed+yee)),this.z.evaluate(i,bi(e.randomSeed+yee)));this.needTransform&&zi.transformQuat(n,n,this.rotation),zi.scaleAndAdd(e.velocity,e.velocity,n,t),zi.copy(e.ultimateVelocity,e.velocity)}}).prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(pee.prototype,"enable",[$9],Object.getOwnPropertyDescriptor(pee.prototype,"enable"),pee.prototype),fee=Oc(pee.prototype,"x",[Q9,Qc,Z9,J9,eee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),mee=Oc(pee.prototype,"y",[tee,Qc,iee,nee,see],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),gee=Oc(pee.prototype,"z",[oee,Qc,ree,aee,cee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),vee=Oc(pee.prototype,"space",[lee,Qc,hee,uee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C9.Local}}),_ee=pee))||_ee);var bee,Tee,Eee,Cee,wee,Aee,Pee,Ree,Iee,Mee,Oee,Dee,Nee,Lee,Bee,zee,Fee,Uee,Gee,kee,Hee,Vee,jee,Wee,qee,Xee,Yee,Kee,$ee,Qee,Zee,Jee,ete,tte,ite;const nte=23541,ste=new zi,ote=new zi;let rte=(bee=Wc("cc.LimitVelocityOvertimeModule"),Tee=vl(),Eee=Al(q8),Cee=pl(),wee=vl(),Aee=_l(),Pee=Al(q8),Ree=pl(),Iee=vl(),Mee=_l(),Oee=Al(q8),Dee=pl(),Nee=vl(),Lee=_l(),Bee=Al(q8),zee=pl(),Fee=vl(),Uee=_l(),Gee=vl(),kee=_l(),Hee=vl(),Vee=_l(),jee=Al(C9),Wee=vl(),qee=_l(),bee((Kee=Oc((Yee=class extends E9{get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}constructor(){super(),Mc(this,"_enable",Kee,this),Mc(this,"limitX",$ee,this),Mc(this,"limitY",Qee,this),Mc(this,"limitZ",Zee,this),Mc(this,"limit",Jee,this),Mc(this,"dampen",ete,this),Mc(this,"separateAxes",tte,this),Mc(this,"space",ite,this),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1,this.name="limitModule",this.rotation=void 0,this.needTransform=void 0,this.rotation=new ji,this.needTransform=!1,this.needUpdate=!0}update(e,t){this.needTransform=H9(e,this.space,t,this.rotation)}animate(e,t){const i=1-e.remainingLifetime/e.startLifetime,n=ste;this.separateAxes?(zi.set(ote,this.limitX.evaluate(i,bi(e.randomSeed+nte)),this.limitY.evaluate(i,bi(e.randomSeed+nte)),this.limitZ.evaluate(i,bi(e.randomSeed+nte))),this.needTransform&&zi.transformQuat(ote,ote,this.rotation),zi.set(n,ate(e.ultimateVelocity.x,ote.x,this.dampen),ate(e.ultimateVelocity.y,ote.y,this.dampen),ate(e.ultimateVelocity.z,ote.z,this.dampen))):(zi.normalize(n,e.ultimateVelocity),zi.multiplyScalar(n,n,ate(e.ultimateVelocity.length(),this.limit.evaluate(i,bi(e.randomSeed+nte)),this.dampen))),zi.copy(e.ultimateVelocity,n)}}).prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(Yee.prototype,"enable",[Tee],Object.getOwnPropertyDescriptor(Yee.prototype,"enable"),Yee.prototype),$ee=Oc(Yee.prototype,"limitX",[Eee,Qc,Cee,wee,Aee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Qee=Oc(Yee.prototype,"limitY",[Pee,Qc,Ree,Iee,Mee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Zee=Oc(Yee.prototype,"limitZ",[Oee,Qc,Dee,Nee,Lee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Jee=Oc(Yee.prototype,"limit",[Bee,Qc,zee,Fee,Uee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),ete=Oc(Yee.prototype,"dampen",[Qc,Gee,kee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),tte=Oc(Yee.prototype,"separateAxes",[Qc,Hee,Vee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ite=Oc(Yee.prototype,"space",[jee,Qc,Wee,qee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C9.Local}}),Xee=Yee))||Xee);function ate(e,t,i){const n=Math.sign(e);let s=Math.abs(e);return s>t&&(s=mi(s,t,i)),s*n}var cte,lte,hte,ute,_te,pte,dte,fte,mte,gte,vte,yte,xte,Ste,bte,Tte,Ete,Cte,wte,Ate,Pte,Rte,Ite;let Mte=(cte=Wc("cc.RotationOvertimeModule"),lte=vl(),hte=vl(),ute=_l(),_te=Al(q8),pte=pl(),dte=vl(),fte=_l(),mte=Al(q8),gte=pl(),vte=vl(),yte=_l(),xte=Al(q8),Ste=pl(),bte=vl(),Tte=_l(),cte((wte=Oc((Cte=class extends E9{constructor(...e){super(...e),Mc(this,"_enable",wte,this),Mc(this,"_separateAxes",Ate,this),Mc(this,"x",Pte,this),Mc(this,"y",Rte,this),Mc(this,"z",Ite,this),this.name="rotationModule",this._startMat=new Zi,this._matRot=new Zi,this._quatRot=new ji,this._otherEuler=new zi}get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}get separateAxes(){return this._separateAxes}set separateAxes(e){this._separateAxes=e}_processRotation(e,t){const i=e.particleSystem.processor.getInfo().renderMode;i!==w9.Mesh&&i===w9.StrecthedBillboard&&this._quatRot.set(0,0,0,1),ji.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=S9.INDENTIFY_NEG_QUAT)}animate(e,t){const i=1-e.remainingLifetime/e.startLifetime,n=bi(e.randomSeed+125292),s=e.particleSystem.processor.getInfo().renderMode;this._separateAxes&&s!==w9.VerticalBillboard&&s!==w9.HorizontalBillboard?ji.fromEuler(e.deltaQuat,this.x.evaluate(i,n)*t*S9.R2D,this.y.evaluate(i,n)*t*S9.R2D,this.z.evaluate(i,n)*t*S9.R2D):ji.fromEuler(e.deltaQuat,0,0,this.z.evaluate(i,n)*t*S9.R2D),e.deltaMat=Zi.fromQuat(e.deltaMat,e.deltaQuat),e.localMat=e.localMat.multiply(e.deltaMat),this._startMat=Zi.fromQuat(this._startMat,e.startRotation),this._matRot=this._startMat.multiply(e.localMat),Zi.getRotation(this._quatRot,this._matRot),this._processRotation(e,S9.R2D),e.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)}}).prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(Cte.prototype,"enable",[lte],Object.getOwnPropertyDescriptor(Cte.prototype,"enable"),Cte.prototype),Ate=Oc(Cte.prototype,"_separateAxes",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(Cte.prototype,"separateAxes",[hte,ute],Object.getOwnPropertyDescriptor(Cte.prototype,"separateAxes"),Cte.prototype),Pte=Oc(Cte.prototype,"x",[_te,Qc,pte,xl,dte,fte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Rte=Oc(Cte.prototype,"y",[mte,Qc,gte,xl,vte,yte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Ite=Oc(Cte.prototype,"z",[xte,Qc,Ste,xl,bte,Tte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Ete=Cte))||Ete);var Ote,Dte,Nte,Lte,Bte,zte,Fte,Ute,Gte,kte,Hte,Vte,jte,Wte,qte,Xte,Yte,Kte,$te,Qte,Zte,Jte,eie,tie,iie,nie,sie,oie;let rie=(Ote=Wc("cc.SizeOvertimeModule"),Dte=vl(),Nte=vl(),Lte=_l(),Bte=Al(q8),zte=pl(),Fte=vl(),Ute=_l(),Gte=Al(q8),kte=pl(),Hte=vl(),Vte=_l(),jte=Al(q8),Wte=pl(),qte=vl(),Xte=_l(),Yte=Al(q8),Kte=pl(),$te=vl(),Qte=_l(),Ote((eie=Oc((Jte=class extends E9{constructor(...e){super(...e),Mc(this,"_enable",eie,this),Mc(this,"separateAxes",tie,this),Mc(this,"size",iie,this),Mc(this,"x",nie,this),Mc(this,"y",sie,this),Mc(this,"z",oie,this),this.name="sizeModule"}get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}animate(e,t){if(this.separateAxes){const t=1-e.remainingLifetime/e.startLifetime,i=bi(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,i),e.size.y=e.startSize.y*this.y.evaluate(t,i),e.size.z=e.startSize.z*this.z.evaluate(t,i)}else zi.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,bi(e.randomSeed+39825)))}}).prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(Jte.prototype,"enable",[Dte],Object.getOwnPropertyDescriptor(Jte.prototype,"enable"),Jte.prototype),tie=Oc(Jte.prototype,"separateAxes",[Qc,Nte,Lte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),iie=Oc(Jte.prototype,"size",[Bte,Qc,zte,Fte,Ute],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),nie=Oc(Jte.prototype,"x",[Gte,Qc,kte,Hte,Vte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),sie=Oc(Jte.prototype,"y",[jte,Qc,Wte,qte,Xte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),oie=Oc(Jte.prototype,"z",[Yte,Qc,Kte,$te,Qte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Zte=Jte))||Zte);var aie,cie,lie,hie,uie,_ie,pie,die,fie,mie,gie,vie,yie,xie,Sie,bie,Tie,Eie,Cie,wie,Aie,Pie,Rie,Iie,Mie,Oie,Die,Nie,Lie,Bie,zie,Fie,Uie,Gie,kie,Hie,Vie,jie,Wie,qie,Xie,Yie,Kie,$ie;const Qie=90794,Zie=Le({Grid:0}),Jie=Le({WholeSheet:0,SingleRow:1});let ene=(aie=Wc("cc.TextureAnimationModule"),cie=Zc("numTilesX"),lie=Zc("numTilesY"),hie=vl(),uie=Al(Zie),_ie=Al(Zie),pie=vl(),die=_l(),fie=vl(),mie=_l(),gie=vl(),vie=_l(),yie=Al(Jie),xie=vl(),Sie=_l(),bie=Al(q8),Tie=pl(),Eie=vl(),Cie=_l(),wie=Al(q8),Aie=pl(),Pie=vl(),Rie=_l(),Iie=vl(),Mie=_l(),Oie=vl(),Die=_l(),Nie=vl(),Lie=_l(),aie((Fie=Oc((zie=class extends E9{constructor(...e){super(...e),Mc(this,"_enable",Fie,this),Mc(this,"_numTilesX",Uie,this),Mc(this,"_numTilesY",Gie,this),Mc(this,"_mode",kie,this),Mc(this,"animation",Hie,this),Mc(this,"frameOverTime",Vie,this),Mc(this,"startFrame",jie,this),Mc(this,"cycleCount",Wie,this),Mc(this,"_flipU",qie,this),Mc(this,"_flipV",Xie,this),Mc(this,"_uvChannelMask",Yie,this),Mc(this,"randomRow",Kie,this),Mc(this,"rowIndex",$ie,this),this.name="textureModule"}get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}get mode(){return this._mode}set mode(e){e!==Zie.Grid&&console.error("particle texture animation's sprites is not supported!")}get numTilesX(){return this._numTilesX}set numTilesX(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}get numTilesY(){return this._numTilesY}set numTilesY(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}get flipU(){return this._flipU}set flipU(e){console.error("particle texture animation's flipU is not supported!")}get flipV(){return this._flipV}set flipV(e){console.error("particle texture animation's flipV is not supported!")}get uvChannelMask(){return this._uvChannelMask}set uvChannelMask(e){console.error("particle texture animation's uvChannelMask is not supported!")}init(e){e.startRow=Math.floor(Math.random()*this.numTilesY)}animate(e,t){const i=1-e.remainingLifetime/e.startLifetime,n=this.startFrame.evaluate(i,bi(e.randomSeed+Qie))/(this.numTilesX*this.numTilesY);if(this.animation===Jie.WholeSheet)e.frameIndex=wi(this.cycleCount*(this.frameOverTime.evaluate(i,bi(e.randomSeed+Qie))+n),1);else if(this.animation===Jie.SingleRow){const t=1/this.numTilesY;if(this.randomRow){const s=wi(this.cycleCount*(this.frameOverTime.evaluate(i,bi(e.randomSeed+Qie))+n),1),o=e.startRow*t,r=o+t;e.frameIndex=mi(o,r,s)}else{const s=this.rowIndex*t,o=s+t;e.frameIndex=mi(s,o,wi(this.cycleCount*(this.frameOverTime.evaluate(i,bi(e.randomSeed+Qie))+n),1))}}}}).prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uie=Oc(zie.prototype,"_numTilesX",[cie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gie=Oc(zie.prototype,"_numTilesY",[lie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oc(zie.prototype,"enable",[hie],Object.getOwnPropertyDescriptor(zie.prototype,"enable"),zie.prototype),kie=Oc(zie.prototype,"_mode",[uie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zie.Grid}}),Oc(zie.prototype,"mode",[_ie,pie,die],Object.getOwnPropertyDescriptor(zie.prototype,"mode"),zie.prototype),Oc(zie.prototype,"numTilesX",[fie,mie],Object.getOwnPropertyDescriptor(zie.prototype,"numTilesX"),zie.prototype),Oc(zie.prototype,"numTilesY",[gie,vie],Object.getOwnPropertyDescriptor(zie.prototype,"numTilesY"),zie.prototype),Hie=Oc(zie.prototype,"animation",[yie,Qc,xie,Sie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jie.WholeSheet}}),Vie=Oc(zie.prototype,"frameOverTime",[bie,Qc,Tie,Eie,Cie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),jie=Oc(zie.prototype,"startFrame",[wie,Qc,Aie,Pie,Rie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Wie=Oc(zie.prototype,"cycleCount",[Qc,Iie,Mie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qie=Oc(zie.prototype,"_flipU",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xie=Oc(zie.prototype,"_flipV",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yie=Oc(zie.prototype,"_uvChannelMask",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Kie=Oc(zie.prototype,"randomRow",[Qc,Oie,Die],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$ie=Oc(zie.prototype,"rowIndex",[Qc,Nie,Lie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bie=zie))||Bie);var tne,ine,nne,sne,one,rne,ane,cne,lne,hne,une,_ne,pne,dne,fne,mne,gne,vne,yne,xne,Sne,bne,Tne,Ene,Cne,wne,Ane,Pne,Rne;const Ine=197866,Mne=new zi;let One=(tne=Wc("cc.VelocityOvertimeModule"),ine=vl(),nne=Al(q8),sne=pl(),one=vl(),rne=_l(),ane=Al(q8),cne=pl(),lne=vl(),hne=_l(),une=Al(q8),_ne=pl(),pne=vl(),dne=_l(),fne=Al(q8),mne=pl(),gne=vl(),vne=_l(),yne=Al(C9),xne=vl(),Sne=_l(),tne((Ene=Oc((Tne=class extends E9{get enable(){return this._enable}set enable(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}constructor(){super(),Mc(this,"_enable",Ene,this),Mc(this,"x",Cne,this),Mc(this,"y",wne,this),Mc(this,"z",Ane,this),Mc(this,"speedModifier",Pne,this),Mc(this,"space",Rne,this),this.rotation=void 0,this.needTransform=void 0,this.name="velocityModule",this.rotation=new ji,this.speedModifier.constant=1,this.needTransform=!1,this.needUpdate=!0}update(e,t){this.needTransform=H9(e,this.space,t,this.rotation)}animate(e,t){const i=1-e.remainingLifetime/e.startLifetime,n=zi.set(Mne,this.x.evaluate(i,bi(e.randomSeed^Ine)),this.y.evaluate(i,bi(156497^e.randomSeed)),this.z.evaluate(i,bi(984136^e.randomSeed)));this.needTransform&&zi.transformQuat(n,n,this.rotation),zi.add(e.animatedVelocity,e.animatedVelocity,n),zi.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),zi.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,bi(e.randomSeed+Ine)))}}).prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(Tne.prototype,"enable",[ine],Object.getOwnPropertyDescriptor(Tne.prototype,"enable"),Tne.prototype),Cne=Oc(Tne.prototype,"x",[nne,Qc,sne,one,rne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),wne=Oc(Tne.prototype,"y",[ane,Qc,cne,lne,hne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Ane=Oc(Tne.prototype,"z",[une,Qc,_ne,pne,dne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Pne=Oc(Tne.prototype,"speedModifier",[fne,Qc,mne,gne,vne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Rne=Oc(Tne.prototype,"space",[yne,Qc,xne,Sne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C9.Local}}),bne=Tne))||bne);var Dne,Nne,Lne,Bne,zne,Fne,Une,Gne,kne;let Hne=e("Burst",(Dne=Wc("cc.Burst"),Nne=Al(q8),Lne=pl(),Dne((Fne=Oc((zne=class{get time(){return this._time}set time(e){this._time=e,this._curTime=e}get repeatCount(){return this._repeatCount}set repeatCount(e){this._repeatCount=e,this._remainingCount=e}constructor(){Mc(this,"_time",Fne,this),Mc(this,"_repeatCount",Une,this),Mc(this,"repeatInterval",Gne,this),Mc(this,"count",kne,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}update(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){let i=wi(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=i>0?i:0;const n=wi(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}getMaxCount(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}).prototype,"_time",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oc(zne.prototype,"time",[cl],Object.getOwnPropertyDescriptor(zne.prototype,"time"),zne.prototype),Une=Oc(zne.prototype,"_repeatCount",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Oc(zne.prototype,"repeatCount",[cl],Object.getOwnPropertyDescriptor(zne.prototype,"repeatCount"),zne.prototype),Gne=Oc(zne.prototype,"repeatInterval",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kne=Oc(zne.prototype,"count",[Nne,Qc,Lne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Bne=zne))||Bne));var Vne,jne,Wne,qne,Xne,Yne,Kne,$ne,Qne,Zne,Jne,ese,tse,ise,nse,sse,ose,rse,ase,cse,lse,hse,use,_se,pse,dse,fse,mse,gse,vse,yse,xse,Sse,bse,Tse,Ese,Cse,wse,Ase,Pse,Rse,Ise,Mse,Ose,Dse,Nse,Lse,Bse,zse,Fse,Use,Gse,kse,Hse,Vse,jse,Wse,qse,Xse,Yse,Kse,$se,Qse,Zse,Jse,eoe,toe,ioe;const noe=new zi(0,0,0),soe=[],ooe=new zi(.5,.5,.5);let roe=(Vne=Wc("cc.ShapeModule"),jne=vl(),Wne=_l(),qne=vl(),Xne=_l(),Yne=vl(),Kne=_l(),$ne=vl(),Qne=_l(),Zne=vl(),Jne=_l(),ese=vl(),tse=Al(A9),ise=Zc("shapeType"),nse=vl(),sse=Al(A9),ose=_l(),rse=Al(P9),ase=vl(),cse=_l(),lse=vl(),hse=_l(),use=vl(),_se=_l(),pse=vl(),dse=_l(),fse=vl(),mse=_l(),gse=vl(),vse=_l(),yse=vl(),xse=_l(),Sse=Al(R9),bse=vl(),Tse=_l(),Ese=ll(),Cse=vl(),wse=_l(),Ase=Al(q8),Pse=ll(),Rse=pl(),Ise=vl(),Mse=_l(),Ose=vl(),Dse=_l(),Nse=vl(),Lse=_l(),Vne((Oc((zse=class{get position(){return this._position}set position(e){this._position=e,this.constructMat()}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this.constructMat()}get scale(){return this._scale}set scale(e){this._scale=e,this.constructMat()}get arc(){return vi(this._arc)}set arc(e){this._arc=gi(e)}get angle(){return Math.round(100*vi(this._angle))/100}set angle(e){this._angle=gi(e)}get enable(){return this._enable}set enable(e){this._enable=e}get shapeType(){return this._shapeType}set shapeType(e){switch(this._shapeType=e,this._shapeType){case A9.Box:this.emitFrom===P9.Base&&(this.emitFrom=P9.Volume);break;case A9.Cone:this.emitFrom===P9.Edge&&(this.emitFrom=P9.Base);break;case A9.Sphere:case A9.Hemisphere:this.emitFrom!==P9.Base&&this.emitFrom!==P9.Edge||(this.emitFrom=P9.Volume)}}constructor(){Mc(this,"_enable",Fse,this),Mc(this,"_shapeType",Use,this),Mc(this,"emitFrom",Gse,this),Mc(this,"alignToDirection",kse,this),Mc(this,"randomDirectionAmount",Hse,this),Mc(this,"sphericalDirectionAmount",Vse,this),Mc(this,"randomPositionAmount",jse,this),Mc(this,"radius",Wse,this),Mc(this,"radiusThickness",qse,this),Mc(this,"arcMode",Xse,this),Mc(this,"arcSpread",Yse,this),Mc(this,"arcSpeed",Kse,this),Mc(this,"length",$se,this),Mc(this,"boxThickness",Qse,this),Mc(this,"_position",Zse,this),Mc(this,"_rotation",Jse,this),Mc(this,"_scale",eoe,this),Mc(this,"_arc",toe,this),Mc(this,"_angle",ioe,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Zi,this.quat=new ji,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}onInit(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}emit(e){switch(this.shapeType){case A9.Box:!function(e,t,i,n){switch(e){case P9.Volume:s=i,o=ooe,zi.set(s,xi(-o.x,o.x),xi(-o.y,o.y),xi(-o.z,o.z));break;case P9.Shell:soe.splice(0,soe.length),soe.push(xi(-.5,.5)),soe.push(xi(-.5,.5)),soe.push(.5*Y9()),X9(soe),aoe(soe,t),zi.set(i,soe[0],soe[1],soe[2]);break;case P9.Edge:soe.splice(0,soe.length),soe.push(xi(-.5,.5)),soe.push(.5*Y9()),soe.push(.5*Y9()),X9(soe),aoe(soe,t),zi.set(i,soe[0],soe[1],soe[2]);break;default:console.warn(`${e} is not supported for box emitter.`)}var s,o;zi.copy(n,k9)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case A9.Circle:!function(e,t,i,n,s){q9(n,e*(1-t),e,i),zi.normalize(s,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case A9.Cone:!function(e,t,i,n,s,o,r,a){switch(e){case P9.Base:q9(r,t*(1-i),t,n),nn.multiplyScalar(a,r,Math.sin(s)),a.z=-Math.cos(s)*t,zi.normalize(a,a),r.z=0;break;case P9.Shell:V9(r,n),nn.multiplyScalar(a,r,Math.sin(s)),a.z=-Math.cos(s),zi.normalize(a,a),nn.multiplyScalar(r,r,t),r.z=0;break;case P9.Volume:q9(r,t*(1-i),t,n),nn.multiplyScalar(a,r,Math.sin(s)),a.z=-Math.cos(s)*t,zi.normalize(a,a),r.z=0,zi.add(r,r,zi.multiplyScalar(noe,a,o*yi()/-a.z));break;default:console.warn(`${e} is not supported for cone emitter.`)}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case A9.Sphere:!function(e,t,i,n,s){switch(e){case P9.Volume:W9(n,t*(1-i),t),zi.normalize(s,n);break;case P9.Shell:j9(n),zi.multiplyScalar(n,n,t),zi.normalize(s,n);break;default:console.warn(`${e} is not supported for sphere emitter.`)}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case A9.Hemisphere:!function(e,t,i,n,s){switch(e){case P9.Volume:W9(n,t*(1-i),t),n.z>0&&(n.z*=-1),zi.normalize(s,n);break;case P9.Shell:j9(n),zi.multiplyScalar(n,n,t),n.z>0&&(n.z*=-1),zi.normalize(s,n);break;default:console.warn(`${e} is not supported for hemisphere emitter.`)}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(`${this.shapeType} shapeType is not supported by ShapeModule.`)}if(this.randomPositionAmount>0&&(e.position.x+=xi(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=xi(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=xi(-this.randomPositionAmount,this.randomPositionAmount)),zi.transformQuat(e.velocity,e.velocity,this.quat),zi.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){const t=zi.normalize(noe,e.position);zi.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}constructMat(){ji.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Zi.fromRTS(this.mat,this.quat,this._position,this._scale)}generateArcAngle(){if(this.arcMode===R9.Random)return xi(0,this._arc);let e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case R9.Loop:return wi(e,this._arc);case R9.PingPong:return Ai(e,this._arc);default:return wi(e,this._arc)}}}).prototype,"position",[jne,Wne],Object.getOwnPropertyDescriptor(zse.prototype,"position"),zse.prototype),Oc(zse.prototype,"rotation",[qne,Xne],Object.getOwnPropertyDescriptor(zse.prototype,"rotation"),zse.prototype),Oc(zse.prototype,"scale",[Yne,Kne],Object.getOwnPropertyDescriptor(zse.prototype,"scale"),zse.prototype),Oc(zse.prototype,"arc",[$ne,Qne],Object.getOwnPropertyDescriptor(zse.prototype,"arc"),zse.prototype),Oc(zse.prototype,"angle",[Zne,Jne],Object.getOwnPropertyDescriptor(zse.prototype,"angle"),zse.prototype),Fse=Oc(zse.prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(zse.prototype,"enable",[ese],Object.getOwnPropertyDescriptor(zse.prototype,"enable"),zse.prototype),Use=Oc(zse.prototype,"_shapeType",[tse,ise,nse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return A9.Cone}}),Oc(zse.prototype,"shapeType",[sse,ose],Object.getOwnPropertyDescriptor(zse.prototype,"shapeType"),zse.prototype),Gse=Oc(zse.prototype,"emitFrom",[rse,Qc,ase,cse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return P9.Volume}}),kse=Oc(zse.prototype,"alignToDirection",[Qc,lse,hse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hse=Oc(zse.prototype,"randomDirectionAmount",[Qc,use,_se],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vse=Oc(zse.prototype,"sphericalDirectionAmount",[Qc,pse,dse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jse=Oc(zse.prototype,"randomPositionAmount",[Qc,fse,mse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wse=Oc(zse.prototype,"radius",[Qc,gse,vse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qse=Oc(zse.prototype,"radiusThickness",[Qc,yse,xse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Xse=Oc(zse.prototype,"arcMode",[Sse,Qc,bse,Tse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return R9.Random}}),Yse=Oc(zse.prototype,"arcSpread",[Ese,Qc,Cse,wse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kse=Oc(zse.prototype,"arcSpeed",[Ase,Pse,Rse,Qc,Ise,Mse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),$se=Oc(zse.prototype,"length",[Qc,Ose,Dse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Qse=Oc(zse.prototype,"boxThickness",[Qc,Nse,Lse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0,0)}}),Zse=Oc(zse.prototype,"_position",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0,0)}}),Jse=Oc(zse.prototype,"_rotation",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0,0)}}),eoe=Oc(zse.prototype,"_scale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1,1)}}),toe=Oc(zse.prototype,"_arc",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gi(360)}}),ioe=Oc(zse.prototype,"_angle",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gi(25)}}),Bse=zse))||Bse);function aoe(e,t){t.x>0&&(e[0]+=.5*xi(-t.x,t.x),e[0]=di(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*xi(-t.y,t.y),e[1]=di(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*xi(-t.z,t.z),e[2]=di(e[2],-.5,.5))}const coe=[0,0,1,0,0,1,1,1];class loe extends Tg{constructor(){super(),this._capacity=void 0,this._vertAttrs=void 0,this._vertSize=void 0,this._vBuffer=void 0,this._vertAttrsFloatCount=void 0,this._vdataF32=void 0,this._vdataUint32=void 0,this._iaInfo=void 0,this._iaInfoBuffer=void 0,this._subMeshData=void 0,this._mesh=void 0,this._vertCount=0,this._indexCount=0,this._startTimeOffset=0,this._lifeTimeOffset=0,this._material=null,this.type=xg.PARTICLE_BATCH,this._capacity=0,this._vertAttrs=null,this._vertSize=0,this._vBuffer=null,this._vertAttrsFloatCount=0,this._vdataF32=null,this._vdataUint32=null,this._iaInfo=new No([new Oo]),this._iaInfoBuffer=this._device.createBuffer(new Io(Fs.INDIRECT,ks.HOST|ks.DEVICE,br,br)),this._subMeshData=null,this._mesh=null}setCapacity(e){const t=this._capacity!==e;this._capacity=e,this._subMeshData&&t&&this.rebuild()}setVertexAttributes(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(const e of this._vertAttrs)e.offset=this._vertSize,this._vertSize+=vr[e.format].size;this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}}createSubMeshData(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);const e=this._device.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){let e=this._vertAttrs[this._vertAttrs.findIndex((e=>e.name===mo.ATTR_TEX_COORD))].offset;this._mesh.copyAttribute(0,mo.ATTR_TEX_COORD,t,this._vertSize,e);let i=this._vertAttrs.findIndex((e=>e.name===mo.ATTR_TEX_COORD3));if(e=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,mo.ATTR_POSITION,t,this._vertSize,e),e=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,mo.ATTR_NORMAL,t,this._vertSize,e),e=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,mo.ATTR_COLOR,t,this._vertSize,e)){const i=new Uint32Array(t);for(let t=0;t<this._vertCount;++t)i[t*this._vertAttrsFloatCount+e/4]=Di.WHITE._val}const n=new Float32Array(t);for(let e=1;e<this._capacity;e++)n.copyWithin(e*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);const i=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,i);for(let e=1;e<this._capacity;e++)for(let t=0;t<this._indexCount;t++)i[e*this._indexCount+t]=i[t]+e*this._vertCount}else{let e=0;for(let t=0;t<this._capacity;++t){const n=4*t;i[e++]=n,i[e++]=n+1,i[e++]=n+2,i[e++]=n+3,i[e++]=n+2,i[e++]=n+1}}const n=this._device.createBuffer(new Io(Fs.INDEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return n.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new Io(Fs.INDIRECT,ks.HOST|ks.DEVICE,br,br))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new cb([e],this._vertAttrs,oo.TRIANGLE_LIST,n,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t}updateMaterial(e){this._material=e,this.setSubModelMaterial(0,e)}addParticleVertexData(e,t){if(this._mesh)for(let i=0;i<this._vertCount;i++){let n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4]}else{let i=e*this._vertAttrsFloatCount;this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,this._vdataF32[i++]=t[1].x,this._vdataF32[i++]=t[1].y,this._vdataF32[i++]=t[1].z,this._vdataF32[i++]=t[2].x,this._vdataF32[i++]=t[2].y,this._vdataF32[i++]=t[2].z,this._vdataF32[i++]=t[3].x,this._vdataF32[i++]=t[3].y,this._vdataF32[i++]=t[3].z,this._vdataUint32[i++]=t[4],t[5]&&(this._vdataF32[i++]=t[5].x,this._vdataF32[i++]=t[5].y,this._vdataF32[i++]=t[5].z)}}addGPUParticleVertexData(e,t,i){let n=t*this._vertAttrsFloatCount*this._vertCount;for(let t=0;t<this._vertCount;t++){let s=n;this._vdataF32[s++]=e.position.x,this._vdataF32[s++]=e.position.y,this._vdataF32[s++]=e.position.z,this._vdataF32[s++]=i,this._vdataF32[s++]=e.startSize.x,this._vdataF32[s++]=e.startSize.y,this._vdataF32[s++]=e.startSize.z,this._vdataF32[s++]=coe[2*t],this._vdataF32[s++]=e.rotation.x,this._vdataF32[s++]=e.rotation.y,this._vdataF32[s++]=e.rotation.z,this._vdataF32[s++]=coe[2*t+1],this._vdataF32[s++]=e.startColor.r/255,this._vdataF32[s++]=e.startColor.g/255,this._vdataF32[s++]=e.startColor.b/255,this._vdataF32[s++]=e.startColor.a/255,this._vdataF32[s++]=e.velocity.x,this._vdataF32[s++]=e.velocity.y,this._vdataF32[s++]=e.velocity.z,this._vdataF32[s++]=e.startLifetime,this._vdataF32[s++]=e.randomSeed,n+=this._vertAttrsFloatCount}}updateGPUParticles(e,t,i){const n=this._vertAttrsFloatCount*this._vertCount;let s=0,o=0,r=0,a=0,c=0;for(let l=0;l<e;++l)s=l*n,o=this._vdataF32[s+this._startTimeOffset],r=this._vdataF32[s+this._lifeTimeOffset],c=t-o,r-c<i&&(a=--e*n,this._vdataF32.copyWithin(s,a,a+n),l--);return e}constructAttributeIndex(){if(!this._vertAttrs)return;let e=this._vertAttrs.findIndex((e=>"a_position_starttime"===e.name)),t=this._vertAttrs[e].offset;this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex((e=>"a_dir_life"===e.name)),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3}updateIA(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)}clear(){this._subModels[0].inputAssembler.indexCount=0}destroy(){super.destroy(),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)}rebuild(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}destroySubMeshData(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)}}class hoe{constructor(e){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=e}getInfo(){return this._renderInfo}onInit(e){this._particleSystem=e}onEnable(){if(!this._particleSystem)return;this.attachToScene();const e=this._model;e&&(e.node=e.transform=this._particleSystem.node,e.enabled=this._particleSystem.enabledInHierarchy)}onDisable(){this.detachFromScene()}onDestroy(){this._model&&(n.director.root.destroyModel(this._model),this._model=null)}attachToScene(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))}detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}setVertexAttributes(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===w9.Mesh?this._renderInfo.mesh:null,this._vertAttrs)}clear(){this._model&&(this._model.enabled=!1)}_initModel(){this._model||(this._model=n.director.root.createModel(loe),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)}updateTrailMaterial(){}getDefaultTrailMaterial(){return null}}const uoe=new zi,_oe=new Zi,poe=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],doe=[0,0,1,0,0,1,1,1],foe=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD1,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD2,Ls.RGB32F),new Xo(mo.ATTR_COLOR,Ls.RGBA8,!0)],moe=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD1,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD2,Ls.RGB32F),new Xo(mo.ATTR_COLOR,Ls.RGBA8,!0),new Xo(mo.ATTR_COLOR1,Ls.RGB32F)],goe=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD1,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD2,Ls.RGB32F),new Xo(mo.ATTR_COLOR,Ls.RGBA8,!0),new Xo(mo.ATTR_TEX_COORD3,Ls.RGB32F),new Xo(mo.ATTR_NORMAL,Ls.RGB32F),new Xo(mo.ATTR_COLOR1,Ls.RGBA8,!0)],voe={parent:null,owner:null,subModelIdx:0};class yoe extends hoe{constructor(e){super(e),this._defines=void 0,this._trailDefines=void 0,this._frameTile_velLenScale=void 0,this._tmp_velLenScale=void 0,this._defaultMat=null,this._node_scale=void 0,this._attrs=void 0,this._particles=null,this._defaultTrailMat=null,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._fillDataFunc=null,this._uScaleHandle=0,this._uLenHandle=0,this._inited=!1,this._localMat=new Zi,this._gravity=new an,this._model=null,this._frameTile_velLenScale=new an(1,1,0,0),this._tmp_velLenScale=this._frameTile_velLenScale.clone(),this._node_scale=new an,this._attrs=new Array(5),this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}onInit(e){super.onInit(e),this._particles=new U((()=>new S9(this)),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0}clear(){super.clear(),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1}updateRenderMode(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()}getFreeParticle(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}getDefaultTrailMaterial(){return this._defaultTrailMat}setNewParticle(e){}_initModuleList(){poe.forEach((e=>{const t=this._particleSystem[e];t&&t.enable&&(t.needUpdate&&(this._updateList[t.name]=t),t.needAnimate&&(this._animateList[t.name]=t))})),this._runAnimateList.length=0;for(let e=0,t=b9.length;e<t;e++){const t=this._animateList[b9[e]];t&&this._runAnimateList.push(t)}}enableModule(e,t,i){t?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[e],delete this._updateList[e]),this._runAnimateList.length=0;for(let e=0,t=b9.length;e<t;e++){const t=this._animateList[b9[e]];t&&this._runAnimateList.push(t)}}updateParticles(e){const t=this._particleSystem;if(!t)return this._particles.length;switch(t.node.getWorldMatrix(_oe),t.scaleSpace){case C9.Local:t.node.getScale(this._node_scale);break;case C9.World:t.node.getWorldScale(this._node_scale)}(t.getMaterialInstance(0)||this._defaultMat).passes[0].setUniform(this._uScaleHandle,this._node_scale),this._updateList.forEach((e=>{e.update(t._simulationSpace,_oe)}));const i=t._trailModule,n=i&&i.enable;if(n&&i.update(),t.simulationSpace===C9.Local){const e=t.node.getRotation();Zi.fromQuat(this._localMat,e),this._localMat.transpose()}for(let s=0;s<this._particles.length;++s){const o=this._particles.data[s];if(o.remainingLifetime-=e,zi.set(o.animatedVelocity,0,0,0),o.remainingLifetime<0)n&&i.removeParticle(o),this._particles.removeAt(s),--s;else{if(t.simulationSpace===C9.Local){const i=9.8*-t.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,bi(o.randomSeed))*e;this._gravity.x=0,this._gravity.y=i,this._gravity.z=0,this._gravity.w=1,this._gravity=this._gravity.transformMat4(this._localMat),o.velocity.x+=this._gravity.x,o.velocity.y+=this._gravity.y,o.velocity.z+=this._gravity.z}else o.velocity.y-=9.8*t.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,bi(o.randomSeed))*e;zi.copy(o.ultimateVelocity,o.velocity),this._runAnimateList.forEach((t=>{t.animate(o,e)})),zi.scaleAndAdd(o.position,o.position,o.ultimateVelocity,e),n&&i.animate(o,e)}}return this._model.enabled=this._particles.length>0,this._particles.length}updateRenderData(){let e=0;for(let t=0;t<this._particles.length;++t){const i=this._particles.data[t];let n=0;const s=this._particleSystem._textureAnimationModule;s&&s.enable&&(n=i.frameIndex),e=4*t,this._fillDataFunc(i,e,n)}}beforeRender(){this._model.updateIA(this._particles.length)}getParticleCount(){return this._particles.length}onMaterialModified(e,t){this._inited&&(0===e?this.updateMaterialParams():this.updateTrailMaterial())}onRebuildPSO(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);const i=this._particleSystem._trailModule;i&&i._trailModel&&1===e&&i._trailModel.setSubModelMaterial(0,t)}_setFillFunc(){this._renderInfo.renderMode===w9.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===w9.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData}_fillMeshData(e,t,i){const n=t/4;this._attrs[0]=e.position,uoe.z=i,this._attrs[1]=uoe,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._model.addParticleVertexData(n,this._attrs)}_fillStrecthedData(e,t,i){for(let n=0;n<4;++n)this._attrs[0]=e.position,uoe.x=doe[2*n],uoe.y=doe[2*n+1],uoe.z=i,this._attrs[1]=uoe,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=e.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(t++,this._attrs)}_fillNormalData(e,t,i){for(let n=0;n<4;++n)this._attrs[0]=e.position,uoe.x=doe[2*n],uoe.y=doe[2*n+1],uoe.z=i,this._attrs[1]=uoe,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=null,this._model.addParticleVertexData(t++,this._attrs)}_setVertexAttrib(){switch(this._renderInfo.renderMode){case w9.StrecthedBillboard:this._vertAttrs=moe.slice();break;case w9.Mesh:this._vertAttrs=goe.slice();break;default:this._vertAttrs=foe.slice()}}updateMaterialParams(){if(!this._particleSystem)return;const e=this._particleSystem,t=e.sharedMaterial;if(null!=t){const i=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1!==i.indexOf("particle")&&-1===i.indexOf("particle-gpu")||e.setMaterial(null,0)}null==e.sharedMaterial&&null==this._defaultMat&&(voe.parent=cg.get("default-particle-material"),voe.owner=this._particleSystem,voe.subModelIdx=0,this._defaultMat=new av(voe),voe.parent=null,voe.owner=null,voe.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));const i=e.getMaterialInstance(0)||this._defaultMat;e._simulationSpace===C9.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;const n=i.passes[0];this._uScaleHandle=n.getHandle("scale"),this._uLenHandle=n.getHandle("frameTile_velLenScale");const s=this._renderInfo.renderMode,o=this._frameTile_velLenScale;s===w9.Billboard?this._defines.CC_RENDER_MODE=0:s===w9.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,o.z=this._renderInfo.velocityScale,o.w=this._renderInfo.lengthScale):s===w9.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:s===w9.VerticalBillboard?this._defines.CC_RENDER_MODE=3:s===w9.Mesh?this._defines.CC_RENDER_MODE=4:console.warn(`particle system renderMode ${s} not support.`);const r=e._textureAnimationModule;r&&r.enable?(an.copy(this._tmp_velLenScale,o),nn.set(this._tmp_velLenScale,r.numTilesX,r.numTilesY),n.setUniform(this._uLenHandle,this._tmp_velLenScale)):n.setUniform(this._uLenHandle,o),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}updateTrailMaterial(){if(!this._particleSystem)return;const e=this._particleSystem,t=e._trailModule;if(t&&t.enable){e.simulationSpace===C9.World||t.space===C9.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;let i=e.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(voe.parent=cg.get("default-trail-material"),voe.owner=this._particleSystem,voe.subModelIdx=1,this._defaultTrailMat=new av(voe),voe.parent=null,voe.owner=null,voe.subModelIdx=0),i=i||this._defaultTrailMat,i.recompileShaders(this._trailDefines),t.updateMaterial()}}}const xoe=new Zi,Soe=new an,boe=new ji,Toe=32,Eoe="a_position_starttime",Coe="a_size_uv",woe="a_rotation_uv",Aoe="a_color",Poe="a_dir_life",Roe="a_rndSeed",Ioe=[new Xo(Eoe,Ls.RGBA32F),new Xo(Coe,Ls.RGBA32F),new Xo(woe,Ls.RGBA32F),new Xo(Aoe,Ls.RGBA32F),new Xo(Poe,Ls.RGBA32F),new Xo(Roe,Ls.R32F)],Moe=[new Xo(Eoe,Ls.RGBA32F),new Xo(Coe,Ls.RGBA32F),new Xo(woe,Ls.RGBA32F),new Xo(Aoe,Ls.RGBA32F),new Xo(Poe,Ls.RGBA32F),new Xo(Roe,Ls.R32F),new Xo(mo.ATTR_TEX_COORD,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD3,Ls.RGB32F),new Xo(mo.ATTR_NORMAL,Ls.RGB32F),new Xo(mo.ATTR_COLOR1,Ls.RGBA8,!0)],Ooe={parent:null,owner:null,subModelIdx:0};class Doe extends hoe{constructor(e){super(e),this._defines=void 0,this._frameTile_velLenScale=void 0,this._unifrom_velLenScale=void 0,this._tmp_velLenScale=void 0,this._node_scale=void 0,this._vertAttrs=[],this._defaultMat=null,this._particleNum=0,this._tempParticle=null,this._colorTexture=null,this._forceTexture=null,this._velocityTexture=null,this._rotationTexture=null,this._sizeTexture=null,this._animTexture=null,this._uTimeHandle=0,this._uRotHandle=0,this._inited=!1,this._frameTile_velLenScale=new an(1,1,0,0),this._unifrom_velLenScale=this._frameTile_velLenScale.clone(),this._tmp_velLenScale=this._frameTile_velLenScale.clone(),this._node_scale=new an,this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},this._tempParticle=new S9(null),this._particleNum=0}onInit(e){super.onInit(e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0}updateRenderMode(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()}setVertexAttributes(){super.setVertexAttributes(),this._model.constructAttributeIndex()}clear(){super.clear(),this._particleNum=0,this.updateRenderData()}onDestroy(){super.onDestroy(),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()}enableModule(e,t,i){const n=this._particleSystem.getMaterialInstance(0)||this._defaultMat;n&&(this.initShaderUniform(n),n.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,n))}getFreeParticle(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle}setNewParticle(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++}updateParticles(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._model.enabled=this._particleNum>0,this._particleNum}updateRenderData(){}beforeRender(){this._model.updateIA(this._particleNum)}updateShaderUniform(e){const t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(!t)return;const i=t.passes[0];Soe.x=this._particleSystem._time,Soe.y=e,i.setUniform(this._uTimeHandle,Soe),this._particleSystem.node.getWorldRotation(boe),i.setUniform(this._uRotHandle,boe)}initShaderUniform(e){const t=e.passes[0];this._uTimeHandle=t.getHandle("u_timeDelta"),this._uRotHandle=t.getHandle("u_worldRot"),t.setUniform(t.getHandle("scale"),this._node_scale),t.setUniform(t.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),Soe.x=Toe,Soe.y=.03125,t.setUniform(t.getHandle("u_sampleInfo"),Soe);let i=!1;const n=this._particleSystem._forceOvertimeModule;if(i=n&&n.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=i,i){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=$8(Toe,n.x,n.y,n.z);const e=t.getHandle("force_over_time_tex0"),i=dg.getBindingFromHandle(e);t.bindSampler(i,this._forceTexture.getGFXSampler()),t.bindTexture(i,this._forceTexture.getGFXTexture());const s=t.getHandle("u_force_space");t.setUniform(s,n.space);const o=t.getHandle("u_force_mode");t.setUniform(o,this._forceTexture.height)}const s=this._particleSystem._velocityOvertimeModule;if(i=s&&s.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=i,i){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,i,n,s){const o=Math.max(Y8(t),Y8(i),Y8(n),Y8(s)),r=new Float32Array(128*o),a=[t,i,n,s];for(let e=0;e<o;e++)for(let t=0;t<4;t++){const i=a[t];let n=0,s=0;for(let o=0;o<32;o++){const a=X8(i,.03225806451612903*o,e);n+=a,s=n/(o+1),r[4*o+t]=s}}return K8(r,32,o)}(0,s.x,s.y,s.z,s.speedModifier);const e=t.getHandle("velocity_over_time_tex0"),i=dg.getBindingFromHandle(e);t.bindSampler(i,this._velocityTexture.getGFXSampler()),t.bindTexture(i,this._velocityTexture.getGFXTexture());const n=t.getHandle("u_velocity_space");t.setUniform(n,s.space);const o=t.getHandle("u_velocity_mode");t.setUniform(o,this._velocityTexture.height)}const o=this._particleSystem._colorOverLifetimeModule;if(i=o&&o.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=i,i){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(e,t){const i=function(e){switch(e.mode){case M7.TwoColors:case M7.TwoGradients:return 2;default:return 1}}(t),n=new Uint8Array(e*i*4),s=1/(e-1);let o=0;for(let r=0;r<i;r++)for(let i=0;i<e;i++){const e=D7(t,s*i,r);n[o]=e.r,n[o+1]=e.g,n[o+2]=e.b,n[o+3]=e.a,o+=4}const r=new wm;return r.create(e,i,Lf.RGBA8888),r.setFilters(zf.LINEAR,zf.LINEAR),r.setWrapMode(Bf.CLAMP_TO_EDGE,Bf.CLAMP_TO_EDGE),r.uploadData(n),r}(Toe,o.color);const e=t.getHandle("color_over_time_tex0"),i=dg.getBindingFromHandle(e);t.bindSampler(i,this._colorTexture.getGFXSampler()),t.bindTexture(i,this._colorTexture.getGFXTexture());const n=t.getHandle("u_color_mode");t.setUniform(n,this._colorTexture.height)}const r=this._particleSystem._rotationOvertimeModule;if(i=r&&r.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=i,i){this._rotationTexture&&this._rotationTexture.destroy(),r.separateAxes?this._rotationTexture=$8(Toe,r.x,r.y,r.z):this._rotationTexture=function(e,t){const i=Y8(t),n=new Float32Array(128*i);let s=0;for(let e=0;e<i;e++)for(let i=0;i<32;i++){const o=X8(t,.03225806451612903*i,e);n[s+2]=o,s+=4}return K8(n,32,i)}(0,r.z);const e=t.getHandle("rotation_over_time_tex0"),i=dg.getBindingFromHandle(e);t.bindSampler(i,this._rotationTexture.getGFXSampler()),t.bindTexture(i,this._rotationTexture.getGFXTexture());const n=t.getHandle("u_rotation_mode");t.setUniform(n,this._rotationTexture.height)}const a=this._particleSystem._sizeOvertimeModule;if(i=a&&a.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=i,i){this._sizeTexture&&this._sizeTexture.destroy(),a.separateAxes?this._sizeTexture=$8(Toe,a.x,a.y,a.z,!0):this._sizeTexture=function(e,t){const i=Y8(t),n=new Float32Array(128*i);let s=0,o=0,r=0;for(let e=0;e<i;e++){s=0;for(let i=0;i<32;i++){const s=X8(t,.03225806451612903*i,e);o=s,n[r]=o,n[r+1]=o,n[r+2]=o,r+=4}}return K8(n,32,i)}(0,a.size);const e=t.getHandle("size_over_time_tex0"),i=dg.getBindingFromHandle(e);t.bindSampler(i,this._sizeTexture.getGFXSampler()),t.bindTexture(i,this._sizeTexture.getGFXTexture());const n=t.getHandle("u_size_mode");t.setUniform(n,this._sizeTexture.height)}const c=this._particleSystem._textureAnimationModule;if(i=c&&c.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=i,i){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t,i){const n=Math.max(Y8(t),Y8(i)),s=new Float32Array(128*n),o=[t,i];for(let e=0;e<n;e++)for(let t=0;t<2;t++){const i=o[t];let n=0,r=0;for(let o=0;o<32;o++){const a=X8(i,.03225806451612903*o,e);n+=a,r=n/(o+1),s[4*o+t]=r}}return K8(s,32,n)}(0,c.startFrame,c.frameOverTime);const e=t.getHandle("texture_animation_tex0"),i=dg.getBindingFromHandle(e);t.bindSampler(i,this._animTexture.getGFXSampler()),t.bindTexture(i,this._animTexture.getGFXTexture());const n=t.getHandle("u_anim_info");Soe.x=this._animTexture.height,Soe.y=c.numTilesX*c.numTilesY,Soe.z=c.cycleCount,t.setUniform(n,Soe)}}getParticleCount(){return this._particleNum}onMaterialModified(e,t){this._inited&&this.updateMaterialParams()}onRebuildPSO(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)}_setVertexAttrib(){switch(this._renderInfo.renderMode){case w9.StrecthedBillboard:this._vertAttrs=Ioe.slice();break;case w9.Mesh:this._vertAttrs=Moe.slice();break;default:this._vertAttrs=Ioe.slice()}}updateMaterialParams(){if(!this._particleSystem)return;const e=this._particleSystem,t=e.sharedMaterial;if(null!==t){const e=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1===e.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=t.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==e.sharedMaterial&&null==this._defaultMat&&(Ooe.parent=cg.get("default-particle-gpu-material"),Ooe.owner=e,Ooe.subModelIdx=0,this._defaultMat=new av(Ooe),Ooe.parent=null,Ooe.owner=null,Ooe.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));const i=e.getMaterialInstance(0)||this._defaultMat;switch(e.node.getWorldMatrix(xoe),e.scaleSpace){case C9.Local:e.node.getScale(this._node_scale);break;case C9.World:e.node.getWorldScale(this._node_scale)}e._simulationSpace===C9.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;const n=this._renderInfo.renderMode;n===w9.Billboard?this._defines.CC_RENDER_MODE=0:n===w9.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):n===w9.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:n===w9.VerticalBillboard?this._defines.CC_RENDER_MODE=3:n===w9.Mesh?this._defines.CC_RENDER_MODE=4:console.warn(`particle system renderMode ${n} not support.`);const s=e._textureAnimationModule;s&&s.enable?(nn.set(this._frameTile_velLenScale,s.numTilesX,s.numTilesY),an.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,an.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}}var Noe,Loe,Boe,zoe,Foe,Uoe,Goe,koe,Hoe,Voe,joe,Woe,qoe,Xoe,Yoe,Koe,$oe,Qoe,Zoe,Joe,ere,tre,ire,nre,sre,ore,rre,are;function cre(){const e=Qw.root.device;return!!(e.capabilities.maxVertexTextureUnits>=8&&e.hasFeature(Ns.TEXTURE_FLOAT))||(n.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}let lre=(Noe=Wc("cc.ParticleSystemRenderer"),Loe=Al(w9),Boe=vl(),zoe=_l(),Foe=vl(),Uoe=_l(),Goe=vl(),koe=_l(),Hoe=Al(w9),Voe=Al(LB),joe=vl(),Woe=_l(),qoe=Al(Wg),Xoe=vl(),Yoe=_l(),Koe=Al(Wg),$oe=vl(),Qoe=_l(),Zoe=vl(),Joe=_l(),Noe((Oc((tre=class{constructor(){Mc(this,"_renderMode",ire,this),Mc(this,"_velocityScale",nre,this),Mc(this,"_lengthScale",sre,this),Mc(this,"_mesh",ore,this),Mc(this,"_mainTexture",rre,this),Mc(this,"_useGPU",are,this),this._particleSystem=null}get renderMode(){return this._renderMode}set renderMode(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}get velocityScale(){return this._velocityScale}set velocityScale(e){this._velocityScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}get lengthScale(){return this._lengthScale}set lengthScale(e){this._lengthScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}get mesh(){return this._mesh}set mesh(e){this._mesh=e,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}get particleMaterial(){return this._particleSystem?this._particleSystem.getMaterial(0):null}set particleMaterial(e){this._particleSystem&&this._particleSystem.setMaterial(e,0)}get trailMaterial(){return this._particleSystem?this._particleSystem.getMaterial(1):null}set trailMaterial(e){this._particleSystem&&this._particleSystem.setMaterial(e,1)}get mainTexture(){return this._mainTexture}set mainTexture(e){this._mainTexture=e}get useGPU(){return this._useGPU}set useGPU(e){this._useGPU!==e&&(cre()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}create(e){null===this._particleSystem?this._particleSystem=e:this._particleSystem!==e&&C(6033)}onInit(e){if(this.create(e),this._particleSystem.processor)C(6034);else{const t=this._useGPU&&cre();this._particleSystem.processor=t?new Doe(this):new yoe(this),this._particleSystem.processor.onInit(e)}}_switchProcessor(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new Doe(this):new yoe(this),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())}}).prototype,"renderMode",[Loe,Boe,zoe],Object.getOwnPropertyDescriptor(tre.prototype,"renderMode"),tre.prototype),Oc(tre.prototype,"velocityScale",[Foe,Uoe],Object.getOwnPropertyDescriptor(tre.prototype,"velocityScale"),tre.prototype),Oc(tre.prototype,"lengthScale",[Goe,koe],Object.getOwnPropertyDescriptor(tre.prototype,"lengthScale"),tre.prototype),ire=Oc(tre.prototype,"_renderMode",[Hoe,Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w9.Billboard}}),nre=Oc(tre.prototype,"_velocityScale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sre=Oc(tre.prototype,"_lengthScale",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ore=Oc(tre.prototype,"_mesh",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(tre.prototype,"mesh",[Voe,joe,Woe],Object.getOwnPropertyDescriptor(tre.prototype,"mesh"),tre.prototype),Oc(tre.prototype,"particleMaterial",[qoe,Xoe,Yoe],Object.getOwnPropertyDescriptor(tre.prototype,"particleMaterial"),tre.prototype),Oc(tre.prototype,"trailMaterial",[Koe,$oe,Qoe],Object.getOwnPropertyDescriptor(tre.prototype,"trailMaterial"),tre.prototype),rre=Oc(tre.prototype,"_mainTexture",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),are=Oc(tre.prototype,"_useGPU",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oc(tre.prototype,"useGPU",[Zoe,Joe],Object.getOwnPropertyDescriptor(tre.prototype,"useGPU"),tre.prototype),ere=tre))||ere);var hre,ure,_re,pre,dre,fre,mre,gre,vre,yre,xre,Sre,bre,Tre,Ere,Cre,wre,Are,Pre,Rre,Ire,Mre,Ore,Dre,Nre,Lre,Bre,zre,Fre,Ure,Gre,kre,Hre,Vre,jre,Wre,qre,Xre,Yre,Kre,$re,Qre,Zre,Jre,eae,tae,iae;const nae=Math.cos(gi(100)),sae={position:new zi,velocity:new zi},oae=new ji,rae=new Zi,aae=new zi,cae=new zi,lae=new Di;class hae{constructor(e){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new zi,lifetime:0,width:0,velocity:new zi,direction:0,color:new Di})}getElement(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}addElement(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new zi,lifetime:0,width:0,velocity:new zi,direction:0,color:new Di}),this.start++,this.start%=this.trailElements.length);const e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}iterateElement(e,t,i,n){const s=this.start>=this.end?this.end+this.trailElements.length:this.end;for(let o=this.start;o<s;o++)t(e,this.trailElements[o%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===s&&(this.start=-1,this.end=-1)}count(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}clear(){this.start=-1,this.end=-1}}let uae=(hre=Wc("cc.TrailModule"),ure=vl(),_re=Al(I9),pre=vl(),dre=_l(),fre=Al(q8),mre=pl(),gre=vl(),vre=_l(),yre=vl(),xre=_l(),Sre=Al(C9),bre=vl(),Tre=_l(),Ere=Al(M9),Cre=vl(),wre=_l(),Are=vl(),Pre=_l(),Rre=Al(q8),Ire=pl(),Mre=vl(),Ore=_l(),Dre=vl(),Nre=_l(),Lre=Al(O7),Bre=vl(),zre=_l(),Fre=Al(O7),Ure=vl(),Gre=_l(),kre=Al(C9),hre((Oc((Vre=class{get enable(){return this._enable}set enable(e){e===this._enable&&this._trailModel||(e&&!this._enable&&(this._enable=e,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),e&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}get minParticleDistance(){return this._minParticleDistance}set minParticleDistance(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}get space(){return this._space}set space(e){this._space=e;const t=this._particleSystem;t&&t.processor&&t.processor.updateTrailMaterial()}constructor(){Mc(this,"_enable",jre,this),Mc(this,"mode",Wre,this),Mc(this,"lifeTime",qre,this),Mc(this,"_minParticleDistance",Xre,this),Mc(this,"existWithParticles",Yre,this),Mc(this,"textureMode",Kre,this),Mc(this,"widthFromParticle",$re,this),Mc(this,"widthRatio",Qre,this),Mc(this,"colorFromParticle",Zre,this),Mc(this,"colorOverTrail",Jre,this),Mc(this,"colorOvertime",eae,this),Mc(this,"_space",tae,this),Mc(this,"_particleSystem",iae,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new No([new Oo]),this._vertAttrs=[new Xo(mo.ATTR_POSITION,Ls.RGB32F),new Xo(mo.ATTR_TEX_COORD,Ls.RGBA32F),new Xo(mo.ATTR_TEX_COORD1,Ls.RGB32F),new Xo(mo.ATTR_COLOR,Ls.RGBA8,!0)],this._vertSize=0;for(const e of this._vertAttrs)this._vertSize+=vr[e.format].size;this._particleTrail=new Map}onInit(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;let t=0;const i=e.startLifetime.getMax(),n=e.rateOverTime.getMax(),s=e.duration;for(let n=0,o=e.bursts.length;n<o;n++)t+=e.bursts[n].getMaxCount(e)*Math.ceil(i/s);this._trailNum=Math.ceil(i*this.lifeTime.getMax()*60*(n*s+t)),this._trailSegments=new F((()=>new hae(10)),Math.ceil(n*s)),this._enable&&(this.enable=this._enable)}onEnable(){this._attachToScene()}onDisable(){this._particleTrail.clear(),this._detachFromScene()}_attachToScene(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))}_detachFromScene(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)}destroy(){this.destroySubMeshData(),this._trailModel&&(Qw.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy((e=>{e.trailElements.length=0})),this._trailSegments=null)}play(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)}clear(){if(this.enable){const e=this._particleTrail.values();let t=e.next();for(;!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}}updateMaterial(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))}update(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===C9.World&&this._particleSystem._simulationSpace===C9.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(rae),this._particleSystem.node.getWorldRotation(oae)):this._needTransform=!1}animate(e,t){if(!this._trailSegments)return;if(e.loopCount>e.lastLoop)return void(e.trailDelay>1?(e.lastLoop=e.loopCount,e.trailDelay=0):e.trailDelay++);let i=this._particleTrail.get(e);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(e,i);let n=i.getElement(i.end-1);if(this._needTransform?zi.transformMat4(aae,e.position,rae):zi.copy(aae,e.position),n&&(i.iterateElement(this,this._updateTrailElement,e,t),zi.squaredDistance(n.position,aae)<this._minSquaredDistance))return;if(n=i.addElement(),!n)return;zi.copy(n.position,aae),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);const s=i.count();if(2===s){const e=i.getElement(i.end-2);zi.subtract(e.velocity,n.position,e.position)}else if(s>2){const e=i.getElement(i.end-2),t=i.getElement(i.end-3);zi.subtract(aae,t.position,e.position),zi.subtract(cae,n.position,e.position),zi.subtract(e.velocity,cae,aae),zi.equals(zi.ZERO,e.velocity)&&zi.copy(e.velocity,aae),zi.normalize(e.velocity,e.velocity),this._checkDirectionReverse(e,t)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}removeParticle(e){const t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}updateRenderData(){this.vbOffset=0,this.ibOffset=0;for(const e of this._particleTrail.keys()){const t=this._particleTrail.get(e);if(-1===t.start)continue;const i=4*this.vbOffset/this._vertSize,n=t.start>=t.end?t.end+t.trailElements.length:t.end,s=n-t.start,o=1/s,r=t.trailElements[t.start];this._fillVertexBuffer(r,this.colorOverTrail.evaluate(1,1),i,1,0,4);for(let e=t.start+1;e<n;e++){const n=t.trailElements[e%t.trailElements.length],r=e-t.start;this._fillVertexBuffer(n,this.colorOverTrail.evaluate(1-r/s,1),i,1-r*o,r,5)}this._needTransform?zi.transformMat4(sae.position,e.position,rae):zi.copy(sae.position,e.position);const a=this._trailModel;if(a&&a.node.invalidateChildren(Cg.POSITION),1===s||2===s){const e=t.getElement(t.end-1);zi.subtract(e.velocity,sae.position,e.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=e.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=e.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=e.velocity.z,this._vbF32[this.vbOffset-4]=e.velocity.x,this._vbF32[this.vbOffset-3]=e.velocity.y,this._vbF32[this.vbOffset-2]=e.velocity.z,zi.subtract(sae.velocity,sae.position,e.position),this._checkDirectionReverse(sae,e)}else if(s>2){const e=t.getElement(t.end-1),n=t.getElement(t.end-2);zi.subtract(aae,n.position,e.position),zi.subtract(cae,sae.position,e.position),zi.normalize(aae,aae),zi.normalize(cae,cae),zi.subtract(e.velocity,cae,aae),zi.normalize(e.velocity,e.velocity),this._checkDirectionReverse(e,n),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(e,this.colorOverTrail.evaluate(o,1),i,o,s-1,5),zi.subtract(sae.velocity,sae.position,e.position),zi.normalize(sae.velocity,sae.velocity),this._checkDirectionReverse(sae,e)}this.widthFromParticle?sae.width=e.size.x*this.widthRatio.evaluate(0,1):sae.width=this.widthRatio.evaluate(0,1),sae.color=e.color,zi.equals(sae.velocity,zi.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(sae,this.colorOverTrail.evaluate(0,1),i,0,s,1)}this._trailModel.enabled=this.ibOffset>0}updateIA(e){const t=this._trailModel&&this._trailModel.subModels;if(t&&t.length>0){const i=t[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=e,this._iaInfoBuffer.update(this._iaInfo)}}beforeRender(){this.updateIA(this.ibOffset)}_createModel(){this._trailModel||(this._trailModel=n.director.root.createModel(Tg))}rebuild(){const e=Qw.root.device,t=e.createBuffer(new Io(Fs.VERTEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);const n=e.createBuffer(new Io(Fs.INDEX|Fs.TRANSFER_DST,ks.HOST|ks.DEVICE,6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer(new Io(Fs.INDIRECT,ks.HOST|ks.DEVICE,br,br)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new cb([t],this._vertAttrs,oo.TRIANGLE_LIST,n,this._iaInfoBuffer);const s=this._trailModel;s&&(s.node=s.transform=this._particleSystem.node,s.visFlags=this._particleSystem.visibility,s.initSubModel(0,this._subMeshData,this._material),s.enabled=!0)}_updateTrailElement(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}_fillVertexBuffer(e,t,i,n,s,o){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,lae.set(e.color),lae.multiply(t),this._vbUint32[this.vbOffset++]=lae._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=lae._val,1&o&&(this._iBuffer[this.ibOffset++]=i+2*s,this._iBuffer[this.ibOffset++]=i+2*s-1,this._iBuffer[this.ibOffset++]=i+2*s+1),4&o&&(this._iBuffer[this.ibOffset++]=i+2*s,this._iBuffer[this.ibOffset++]=i+2*s+1,this._iBuffer[this.ibOffset++]=i+2*s+2)}_checkDirectionReverse(e,t){zi.dot(e.velocity,t.velocity)<nae?e.direction=1-t.direction:e.direction=t.direction}destroySubMeshData(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}).prototype,"enable",[ure],Object.getOwnPropertyDescriptor(Vre.prototype,"enable"),Vre.prototype),jre=Oc(Vre.prototype,"_enable",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wre=Oc(Vre.prototype,"mode",[_re,Qc,pre,dre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return I9.Particles}}),qre=Oc(Vre.prototype,"lifeTime",[fre,Qc,mre,gre,vre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Xre=Oc(Vre.prototype,"_minParticleDistance",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Oc(Vre.prototype,"minParticleDistance",[yre,xre],Object.getOwnPropertyDescriptor(Vre.prototype,"minParticleDistance"),Vre.prototype),Oc(Vre.prototype,"space",[Sre,bre,Tre],Object.getOwnPropertyDescriptor(Vre.prototype,"space"),Vre.prototype),Yre=Oc(Vre.prototype,"existWithParticles",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kre=Oc(Vre.prototype,"textureMode",[Ere,Qc,Cre,wre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M9.Stretch}}),$re=Oc(Vre.prototype,"widthFromParticle",[Qc,Are,Pre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Qre=Oc(Vre.prototype,"widthRatio",[Rre,Qc,Ire,Mre,Ore],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Zre=Oc(Vre.prototype,"colorFromParticle",[Qc,Dre,Nre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jre=Oc(Vre.prototype,"colorOverTrail",[Lre,Qc,Bre,zre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new O7}}),eae=Oc(Vre.prototype,"colorOvertime",[Fre,Qc,Ure,Gre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new O7}}),tae=Oc(Vre.prototype,"_space",[kre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C9.World}}),iae=Oc(Vre.prototype,"_particleSystem",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hre=Vre))||Hre);var _ae,pae,dae,fae,mae,gae,vae,yae,xae,Sae,bae,Tae,Eae,Cae,wae,Aae,Pae,Rae,Iae,Mae,Oae,Dae,Nae,Lae,Bae,zae,Fae,Uae,Gae,kae,Hae,Vae,jae,Wae,qae,Xae,Yae,Kae,$ae,Qae,Zae,Jae,ece,tce,ice,nce,sce,oce,rce,ace,cce,lce,hce,uce,_ce,pce,dce,fce,mce,gce,vce,yce,xce,Sce,bce,Tce,Ece,Cce,wce,Ace,Pce,Rce,Ice,Mce,Oce,Dce,Nce,Lce,Bce,zce,Fce,Uce,Gce,kce,Hce,Vce,jce,Wce,qce,Xce,Yce,Kce,$ce,Qce,Zce,Jce,ele,tle,ile,nle,sle,ole,rle,ale,cle,lle,hle,ule,_le,ple,dle,fle,mle,gle,vle,yle,xle,Sle,ble,Tle,Ele,Cle,wle,Ale,Ple,Rle,Ile,Mle,Ole,Dle,Nle,Lle,Ble,zle,Fle,Ule,Gle,kle,Hle,Vle,jle,Wle,qle,Xle,Yle,Kle,$le,Qle,Zle,Jle,ehe,the,ihe,nhe,she,ohe,rhe,ahe,che,lhe,hhe,uhe,_he;const phe=new Zi,dhe=new ji,fhe=Object.getOwnPropertyDescriptor(iI.prototype,"sharedMaterials");let mhe=function(t){return e({ParticleSystem:t,ParticleSystemComponent:t}),t}((_ae=Wc("cc.ParticleSystem"),pae=al(),dae=nl(),fae=Xc(99),mae=vl(),gae=_l(),vae=Al(O7),yae=vl(),xae=_l(),Sae=Al(C9),bae=vl(),Tae=_l(),Eae=vl(),Cae=_l(),wae=Zc("startSize"),Aae=pl(),Pae=Al(q8),Rae=vl(),Iae=_l(),Mae=Al(q8),Oae=pl(),Dae=vl(),Nae=_l(),Lae=Al(q8),Bae=pl(),zae=vl(),Fae=_l(),Uae=Al(q8),Gae=pl(),kae=vl(),Hae=_l(),Vae=vl(),jae=_l(),Wae=Al(q8),qae=pl(),Xae=vl(),Yae=_l(),Kae=Al(q8),$ae=pl(),Qae=vl(),Zae=_l(),Jae=Al(q8),ece=Zc("startRotation"),tce=pl(),ice=vl(),nce=_l(),sce=Al(q8),oce=pl(),rce=vl(),ace=_l(),cce=Al(q8),lce=pl(),hce=vl(),uce=_l(),_ce=vl(),pce=_l(),dce=vl(),fce=_l(),mce=vl(),gce=_l(),vce=Al(C9),yce=vl(),xce=_l(),Sce=vl(),bce=_l(),Tce=vl(),Ece=_l(),Cce=Al(q8),wce=pl(),Ace=vl(),Pce=_l(),Rce=Al(q8),Ice=pl(),Mce=vl(),Oce=_l(),Dce=Al(q8),Nce=pl(),Lce=vl(),Bce=_l(),zce=Al([Hne]),Fce=vl(),Uce=_l(),Gce=ll(),kce=Al(Wg),Hce=ul(),Vce=Al(G9),jce=Al(G9),Wce=vl(),qce=_l(),Xce=Al(roe),Yce=Al(roe),Kce=vl(),$ce=_l(),Qce=Al(rie),Zce=Al(rie),Jce=vl(),ele=_l(),tle=Al(One),ile=Al(One),nle=vl(),sle=_l(),ole=Al(See),rle=Al(See),ale=vl(),cle=_l(),lle=Al(rte),hle=Al(rte),ule=vl(),_le=_l(),ple=Al(Mte),dle=Al(Mte),fle=vl(),mle=_l(),gle=Al(ene),vle=Al(ene),yle=vl(),xle=_l(),Sle=Al(uae),ble=Al(uae),Tle=vl(),Ele=_l(),Cle=Al(lre),wle=vl(),Ale=_l(),Ple=vl(),Rle=_l(),_ae(Ile=pae(Ile=dae(Ile=fae(Ile=il((Oc((Mle=class extends iI{get capacity(){return this._capacity}set capacity(e){this._capacity=Math.floor(e),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}get prewarm(){return this._prewarm}set prewarm(e){!0===e&&this.loop,this._prewarm=e}get simulationSpace(){return this._simulationSpace}set simulationSpace(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}get sharedMaterials(){return fhe.get.call(this)}set sharedMaterials(e){fhe.set.call(this,e)}get colorOverLifetimeModule(){return this._colorOverLifetimeModule}set colorOverLifetimeModule(e){e&&(this._colorOverLifetimeModule=e)}get shapeModule(){return this._shapeModule}set shapeModule(e){e&&(this._shapeModule=e)}get sizeOvertimeModule(){return this._sizeOvertimeModule}set sizeOvertimeModule(e){e&&(this._sizeOvertimeModule=e)}get velocityOvertimeModule(){return this._velocityOvertimeModule}set velocityOvertimeModule(e){e&&(this._velocityOvertimeModule=e)}get forceOvertimeModule(){return this._forceOvertimeModule}set forceOvertimeModule(e){e&&(this._forceOvertimeModule=e)}get limitVelocityOvertimeModule(){return this._limitVelocityOvertimeModule}set limitVelocityOvertimeModule(e){e&&(this._limitVelocityOvertimeModule=e)}get rotationOvertimeModule(){return this._rotationOvertimeModule}set rotationOvertimeModule(e){e&&(this._rotationOvertimeModule=e)}get textureAnimationModule(){return this._textureAnimationModule}set textureAnimationModule(e){e&&(this._textureAnimationModule=e)}get trailModule(){return this._trailModule}set trailModule(e){e&&(this._trailModule=e)}constructor(){super(),Mc(this,"startColor",Ole,this),Mc(this,"scaleSpace",Dle,this),Mc(this,"startSize3D",Nle,this),Mc(this,"startSizeX",Lle,this),Mc(this,"startSizeY",Ble,this),Mc(this,"startSizeZ",zle,this),Mc(this,"startSpeed",Fle,this),Mc(this,"startRotation3D",Ule,this),Mc(this,"startRotationX",Gle,this),Mc(this,"startRotationY",kle,this),Mc(this,"startRotationZ",Hle,this),Mc(this,"startDelay",Vle,this),Mc(this,"startLifetime",jle,this),Mc(this,"duration",Wle,this),Mc(this,"loop",qle,this),Mc(this,"simulationSpeed",Xle,this),Mc(this,"playOnAwake",Yle,this),Mc(this,"gravityModifier",Kle,this),Mc(this,"rateOverTime",$le,this),Mc(this,"rateOverDistance",Qle,this),Mc(this,"bursts",Zle,this),Mc(this,"_colorOverLifetimeModule",Jle,this),Mc(this,"_shapeModule",ehe,this),Mc(this,"_sizeOvertimeModule",the,this),Mc(this,"_velocityOvertimeModule",ihe,this),Mc(this,"_forceOvertimeModule",nhe,this),Mc(this,"_limitVelocityOvertimeModule",she,this),Mc(this,"_rotationOvertimeModule",ohe,this),Mc(this,"_textureAnimationModule",rhe,this),Mc(this,"_trailModule",ahe,this),Mc(this,"renderer",che,this),Mc(this,"enableCulling",lhe,this),this._isPlaying=void 0,this._isPaused=void 0,this._isStopped=void 0,this._isEmitting=void 0,this._needRefresh=void 0,this._time=void 0,this._emitRateTimeCounter=void 0,this._emitRateDistanceCounter=void 0,this._oldWPos=void 0,this._curWPos=void 0,this._customData1=void 0,this._customData2=void 0,this._subEmitters=void 0,Mc(this,"_prewarm",hhe,this),Mc(this,"_capacity",uhe,this),Mc(this,"_simulationSpace",_he,this),this.processor=null,this.rateOverTime.constant=10,this.startLifetime.constant=5,this.startSizeX.constant=1,this.startSpeed.constant=5,this._isPlaying=!1,this._isPaused=!1,this._isStopped=!0,this._isEmitting=!1,this._needRefresh=!0,this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._oldWPos=new zi,this._curWPos=new zi,this._customData1=new nn,this._customData2=new nn,this._subEmitters=[]}onFocusInEditor(){this.renderer.create(this)}onLoad(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()}_onMaterialModified(e,t){null!==this.processor&&this.processor.onMaterialModified(e,t)}_onRebuildPSO(e,t){this.processor.onRebuildPSO(e,t)}_collectModels(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models}_attachToScene(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()}_detachFromScene(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()}bindModule(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)}play(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play()}pause(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}stop(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0}clear(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear())}getParticleCount(){return this.processor.getParticleCount()}setCustomData1(e,t){nn.set(this._customData1,e,t)}setCustomData2(e,t){nn.set(this._customData2,e,t)}onDestroy(){n.director.off(n.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy()}onEnable(){n.director.on(n.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()}onDisable(){n.director.off(n.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable()}update(e){const t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.processor.updateParticles(t)||this._isEmitting||this.stop()),this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()}beforeRender(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())}_onVisibilityChange(e){this.processor._model&&(this.processor._model.visFlags=e)}_processRotation(e){const t=this.processor.getInfo().renderMode;t!==w9.Mesh&&(t===w9.StrecthedBillboard?e.startEuler.set(0,0,0):t!==w9.Billboard&&e.startEuler.set(0,0,e.startEuler.z)),ji.fromEuler(e.startRotation,e.startEuler.x*S9.R2D,e.startEuler.y*S9.R2D,e.startEuler.z*S9.R2D),e.startRotation=ji.normalize(e.startRotation,e.startRotation),e.startRotation.w<0&&(e.startRotation.x+=S9.INDENTIFY_NEG_QUAT)}emit(e,t){const i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(Cg.POSITION),this._needRefresh=!1),this._simulationSpace===C9.World&&(this.node.getWorldMatrix(phe),this.node.getWorldRotation(dhe));for(let n=0;n<e;++n){const e=this.processor.getFreeParticle();if(null===e)return;e.particleSystem=this,e.reset();const n=bi(Si(0,Xt));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(e):(zi.set(e.position,0,0,0),zi.copy(e.velocity,k9)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(e);const s=this.startSpeed.evaluate(i,n);zi.multiplyScalar(e.velocity,e.velocity,s),this._simulationSpace===C9.World&&(zi.transformMat4(e.position,e.position,phe),zi.transformQuat(e.velocity,e.velocity,dhe)),zi.copy(e.ultimateVelocity,e.velocity),this.startRotation3D?e.startEuler.set(this.startRotationX.evaluate(i,n),this.startRotationY.evaluate(i,n),this.startRotationZ.evaluate(i,n)):e.startEuler.set(0,0,this.startRotationZ.evaluate(i,n)),this._processRotation(e),zi.set(e.rotation,e.startRotation.x,e.startRotation.y,e.startRotation.z),this.startSize3D?zi.set(e.startSize,this.startSizeX.evaluate(i,n),this.startSizeY.evaluate(i,n),this.startSizeZ.evaluate(i,n)):(zi.set(e.startSize,this.startSizeX.evaluate(i,n),1,1),e.startSize.y=e.startSize.x),zi.copy(e.size,e.startSize),e.startColor.set(this.startColor.evaluate(i,n)),e.color.set(e.startColor),e.startLifetime=this.startLifetime.evaluate(i,n)+t,e.remainingLifetime=e.startLifetime,e.randomSeed=Si(0,233280),e.loopCount++,this.processor.setNewParticle(e)}}_prewarmSystem(){this.startDelay.mode=W8.Constant,this.startDelay.constant=0;const e=this.duration/1;for(let t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)}_emit(e){const t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){const t=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=t,this.emit(t,e)}this.node.getWorldPosition(this._curWPos);const i=zi.distance(this._curWPos,this._oldWPos);if(zi.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=i*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){const t=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=t,this.emit(t,e)}for(const t of this.bursts)t.update(this,e)}}_resetPosition(){this.node.getWorldPosition(this._oldWPos),zi.copy(this._curWPos,this._oldWPos)}addSubEmitter(e){this._subEmitters.push(e)}removeSubEmitter(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}addBurst(e){this.bursts.push(e)}removeBurst(e){this.bursts.splice(this.bursts.indexOf(e),1)}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isStopped(){return this._isStopped}get isEmitting(){return this._isEmitting}get time(){return this._time}_onBeforeSerialize(e){return this.enableCulling?e.filter((e=>!T9.includes(e)||this[e]&&this[e].enable)):e}}).prototype,"capacity",[mae,gae],Object.getOwnPropertyDescriptor(Mle.prototype,"capacity"),Mle.prototype),Ole=Oc(Mle.prototype,"startColor",[vae,Qc,yae,xae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new O7}}),Dle=Oc(Mle.prototype,"scaleSpace",[Sae,Qc,bae,Tae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C9.Local}}),Nle=Oc(Mle.prototype,"startSize3D",[Qc,Eae,Cae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lle=Oc(Mle.prototype,"startSizeX",[wae,Aae,Pae,Rae,Iae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Ble=Oc(Mle.prototype,"startSizeY",[Mae,Qc,Oae,Dae,Nae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),zle=Oc(Mle.prototype,"startSizeZ",[Lae,Qc,Bae,zae,Fae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Fle=Oc(Mle.prototype,"startSpeed",[Uae,Qc,Gae,kae,Hae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Ule=Oc(Mle.prototype,"startRotation3D",[Qc,Vae,jae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gle=Oc(Mle.prototype,"startRotationX",[Wae,Qc,qae,xl,Xae,Yae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),kle=Oc(Mle.prototype,"startRotationY",[Kae,Qc,$ae,xl,Qae,Zae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Hle=Oc(Mle.prototype,"startRotationZ",[Jae,ece,tce,xl,ice,nce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Vle=Oc(Mle.prototype,"startDelay",[sce,Qc,oce,rce,ace],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),jle=Oc(Mle.prototype,"startLifetime",[cce,Qc,lce,hce,uce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Wle=Oc(Mle.prototype,"duration",[Qc,_ce,pce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),qle=Oc(Mle.prototype,"loop",[Qc,dce,fce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Oc(Mle.prototype,"prewarm",[mce,gce],Object.getOwnPropertyDescriptor(Mle.prototype,"prewarm"),Mle.prototype),Oc(Mle.prototype,"simulationSpace",[vce,Qc,yce,xce],Object.getOwnPropertyDescriptor(Mle.prototype,"simulationSpace"),Mle.prototype),Xle=Oc(Mle.prototype,"simulationSpeed",[Qc,Sce,bce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Yle=Oc(Mle.prototype,"playOnAwake",[Qc,Tce,Ece],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kle=Oc(Mle.prototype,"gravityModifier",[Cce,Qc,wce,Ace,Pce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),$le=Oc(Mle.prototype,"rateOverTime",[Rce,Qc,Ice,Mce,Oce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Qle=Oc(Mle.prototype,"rateOverDistance",[Dce,Qc,Nce,Lce,Bce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q8}}),Zle=Oc(Mle.prototype,"bursts",[zce,Qc,Fce,Uce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oc(Mle.prototype,"sharedMaterials",[Pl,Gce,kce,Qc,Hce],Object.getOwnPropertyDescriptor(Mle.prototype,"sharedMaterials"),Mle.prototype),Jle=Oc(Mle.prototype,"_colorOverLifetimeModule",[Vce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"colorOverLifetimeModule",[jce,Wce,qce],Object.getOwnPropertyDescriptor(Mle.prototype,"colorOverLifetimeModule"),Mle.prototype),ehe=Oc(Mle.prototype,"_shapeModule",[Xce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"shapeModule",[Yce,Kce,$ce],Object.getOwnPropertyDescriptor(Mle.prototype,"shapeModule"),Mle.prototype),the=Oc(Mle.prototype,"_sizeOvertimeModule",[Qce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"sizeOvertimeModule",[Zce,Jce,ele],Object.getOwnPropertyDescriptor(Mle.prototype,"sizeOvertimeModule"),Mle.prototype),ihe=Oc(Mle.prototype,"_velocityOvertimeModule",[tle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"velocityOvertimeModule",[ile,nle,sle],Object.getOwnPropertyDescriptor(Mle.prototype,"velocityOvertimeModule"),Mle.prototype),nhe=Oc(Mle.prototype,"_forceOvertimeModule",[ole],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"forceOvertimeModule",[rle,ale,cle],Object.getOwnPropertyDescriptor(Mle.prototype,"forceOvertimeModule"),Mle.prototype),she=Oc(Mle.prototype,"_limitVelocityOvertimeModule",[lle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"limitVelocityOvertimeModule",[hle,ule,_le],Object.getOwnPropertyDescriptor(Mle.prototype,"limitVelocityOvertimeModule"),Mle.prototype),ohe=Oc(Mle.prototype,"_rotationOvertimeModule",[ple],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"rotationOvertimeModule",[dle,fle,mle],Object.getOwnPropertyDescriptor(Mle.prototype,"rotationOvertimeModule"),Mle.prototype),rhe=Oc(Mle.prototype,"_textureAnimationModule",[gle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"textureAnimationModule",[vle,yle,xle],Object.getOwnPropertyDescriptor(Mle.prototype,"textureAnimationModule"),Mle.prototype),ahe=Oc(Mle.prototype,"_trailModule",[Sle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oc(Mle.prototype,"trailModule",[ble,Tle,Ele],Object.getOwnPropertyDescriptor(Mle.prototype,"trailModule"),Mle.prototype),che=Oc(Mle.prototype,"renderer",[Cle,Qc,wle,Ale],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new lre}}),lhe=Oc(Mle.prototype,"enableCulling",[Qc,Ple,Rle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hhe=Oc(Mle.prototype,"_prewarm",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uhe=Oc(Mle.prototype,"_capacity",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),_he=Oc(Mle.prototype,"_simulationSpace",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C9.Local}}),Ile=Mle))||Ile)||Ile)||Ile)||Ile)||Ile));class ghe{static instantiate(e){return this.registeredSceneEvent||(Qw.on($w.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new F((()=>Eu(e)||new ix),1)),this.particleSystemPool.get(e._uuid).alloc()}static destroy(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}static play(e){for(const t of e.getComponentsInChildren(mhe))t.play()}static stop(e){for(const t of e.getComponentsInChildren(mhe))t.stop()}static onSceneUnload(){this.particleSystemPool.forEach((e=>{e.destroy((e=>{e.destroy()}))})),this.particleSystemPool.clear()}}function vhe(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}e("ParticleUtils",ghe),ghe.particleSystemPool=new Map,ghe.registeredSceneEvent=!1,ti(Hne.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),n.ParticleSystemComponent=mhe,De.setClassAlias(mhe,"cc.ParticleSystemComponent"),n.BillboardComponent=b8,De.setClassAlias(b8,"cc.BillboardComponent"),n.LineComponent=x9,De.setClassAlias(x9,"cc.LineComponent"),n.ParticleUtils=ghe;var yhe=function(e,t){return function(e){e.exports=function e(t,i,n){function s(r,a){if(!i[r]){if(!t[r]){if(!a&&vhe)return vhe();if(o)return o(r,!0);throw new Error("Cannot find module '"+r+"'")}var c=i[r]={exports:{}};t[r][0].call(c.exports,(function(e){return s(t[r][1][e]||e)}),c,c.exports,e,t,i,n)}return i[r].exports}for(var o=vhe,r=0;r<n.length;r++)s(n[r]);return s}({1:[function(e,t){t.exports={name:"@cocos/cannon",version:"1.2.8",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon.js","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -c -m",postpublish:"cnpm sync @cocos/cannon"},main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World"),Octree:e("./utils/Octree")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Octree":51,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t){var i=e("../math/Vec3");function n(e){e=e||{},this.lowerBound=new i,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new i,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=n;var s=new i;n.prototype.setFromPoints=function(e,t,i,n){var o=this.lowerBound,r=this.upperBound,a=i;o.copy(e[0]),a&&a.vmult(o,o),r.copy(o);for(var c=1;c<e.length;c++){var l=e[c];a&&(a.vmult(l,s),l=s),l.x>r.x&&(r.x=l.x),l.x<o.x&&(o.x=l.x),l.y>r.y&&(r.y=l.y),l.y<o.y&&(o.y=l.y),l.z>r.z&&(r.z=l.z),l.z<o.z&&(o.z=l.z)}return t&&(t.vadd(o,o),t.vadd(r,r)),n&&(o.x-=n,o.y-=n,o.z-=n,r.x+=n,r.y+=n,r.z+=n),this},n.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},n.prototype.clone=function(){return(new n).copy(this)},n.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},n.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,s=e.upperBound,o=n.x<=i.x&&i.x<=s.x||t.x<=s.x&&s.x<=i.x,r=n.y<=i.y&&i.y<=s.y||t.y<=s.y&&s.y<=i.y,a=n.z<=i.z&&i.z<=s.z||t.z<=s.z&&s.z<=i.z;return o&&r&&a},n.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},n.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,s=e.upperBound;return t.x<=n.x&&i.x>=s.x&&t.y<=n.y&&i.y>=s.y&&t.z<=n.z&&i.z>=s.z},n.prototype.getCorners=function(e,t,i,n,s,o,r,a){var c=this.lowerBound,l=this.upperBound;e.copy(c),t.set(l.x,c.y,c.z),i.set(l.x,l.y,c.z),n.set(c.x,l.y,l.z),s.set(l.x,c.y,l.z),o.set(c.x,l.y,c.z),r.set(c.x,c.y,l.z),a.copy(l)};var o=[new i,new i,new i,new i,new i,new i,new i,new i];n.prototype.toLocalFrame=function(e,t){var i=o,n=i[0],s=i[1],r=i[2],a=i[3],c=i[4],l=i[5],h=i[6],u=i[7];this.getCorners(n,s,r,a,c,l,h,u);for(var _=0;8!==_;_++){var p=i[_];e.pointToLocal(p,p)}return t.setFromPoints(i)},n.prototype.toWorldFrame=function(e,t){var i=o,n=i[0],s=i[1],r=i[2],a=i[3],c=i[4],l=i[5],h=i[6],u=i[7];this.getCorners(n,s,r,a,c,l,h,u);for(var _=0;8!==_;_++){var p=i[_];e.pointToWorld(p,p)}return t.setFromPoints(i)},n.prototype.overlapsRay=function(e){var t=1/e._direction.x,i=1/e._direction.y,n=1/e._direction.z,s=(this.lowerBound.x-e.from.x)*t,o=(this.upperBound.x-e.from.x)*t,r=(this.lowerBound.y-e.from.y)*i,a=(this.upperBound.y-e.from.y)*i,c=(this.lowerBound.z-e.from.z)*n,l=(this.upperBound.z-e.from.z)*n,h=Math.max(Math.max(Math.min(s,o),Math.min(r,a)),Math.min(c,l)),u=Math.min(Math.min(Math.max(s,o),Math.max(r,a)),Math.max(c,l));return!(u<0||h>u)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t){function i(){this.matrix=[]}t.exports=i,i.prototype.get=function(e,t){if(e=e.index,(t=t.index)>e){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},i.prototype.set=function(e,t,i){if(e=e.index,(t=t.index)>e){var n=t;t=e,e=n}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},i.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},i.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t){var i=e("../objects/Body"),n=e("../math/Vec3"),s=e("../math/Quaternion");function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),t.exports=o,o.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")},o.prototype.needBroadphaseCollision=function(e,t){if(0==(e.collisionFilterGroup&t.collisionFilterMask)||0==(t.collisionFilterGroup&e.collisionFilterMask))return!1;var n=0!=(e.type&i.STATIC),s=0!=(t.type&i.STATIC);return!(n&&s||!e.hasTrigger&&!t.hasTrigger&&e.sleepState===i.SLEEPING&&t.sleepState===i.SLEEPING)},o.prototype.intersectionTest=function(e,t,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,n):this.doBoundingSphereBroadphase(e,t,i,n)};var r=new n;new n,new s,new n,o.prototype.doBoundingSphereBroadphase=function(e,t,i,n){var s=r;t.position.vsub(e.position,s);var o=Math.pow(e.boundingRadius+t.boundingRadius,2);s.norm2()<o&&(i.push(e),n.push(t))},o.prototype.doBoundingBoxBroadphase=function(e,t,i,n){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),n.push(t))};var a={keys:[]},c=[],l=[];o.prototype.makePairsUnique=function(e,t){for(var i=a,n=c,s=l,o=e.length,r=0;r!==o;r++)n[r]=e[r],s[r]=t[r];for(e.length=0,t.length=0,r=0;r!==o;r++){var h=n[r].id,u=s[r].id;i[_=h<u?h+","+u:u+","+h]=r,i.keys.push(_)}for(r=0;r!==i.keys.length;r++){var _=i.keys.pop(),p=i[_];e.push(n[p]),t.push(s[p]),delete i[_]}},o.prototype.setWorld=function(){};var h=new n;o.boundingSphereCheck=function(e,t){var i=h;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},o.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t){t.exports=o;var i=e("./Broadphase"),n=e("../math/Vec3"),s=e("../shapes/Shape");function o(e,t,s,o,r){i.apply(this),this.nx=s||10,this.ny=o||10,this.nz=r||10,this.aabbMin=e||new n(100,100,100),this.aabbMax=t||new n(-100,-100,-100);var a=this.nx*this.ny*this.nz;if(a<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=a,this.binLengths.length=a;for(var c=0;c<a;c++)this.bins[c]=[],this.binLengths[c]=0}o.prototype=new i,o.prototype.constructor=o;var r=new n;new n,o.prototype.collisionPairs=function(e,t,i){for(var n=e.numObjects(),o=e.bodies,a=this.aabbMax,c=this.aabbMin,l=this.nx,h=this.ny,u=this.nz,_=h*u,p=u,d=1,f=a.x,m=a.y,g=a.z,v=c.x,y=c.y,x=c.z,S=l/(f-v),b=h/(m-y),T=u/(g-x),E=(f-v)/l,C=(m-y)/h,w=(g-x)/u,A=.5*Math.sqrt(E*E+C*C+w*w),P=s.types,R=P.SPHERE,I=P.PLANE,M=(P.BOX,P.COMPOUND,P.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,D=this.bins.length,N=0;N!==D;N++)O[N]=0;var L=Math.ceil;function B(e,t,i,n,s,o,r){var a=(e-v)*S|0,c=(t-y)*b|0,f=(i-x)*T|0,m=L((n-v)*S),g=L((s-y)*b),E=L((o-x)*T);a<0?a=0:a>=l&&(a=l-1),c<0?c=0:c>=h&&(c=h-1),f<0?f=0:f>=u&&(f=u-1),m<0?m=0:m>=l&&(m=l-1),g<0?g=0:g>=h&&(g=h-1),E<0?E=0:E>=u&&(E=u-1),c*=p,f*=d,m*=_,g*=p,E*=d;for(var C=a*=_;C<=m;C+=_)for(var w=c;w<=g;w+=p)for(var A=f;A<=E;A+=d){var P=C+w+A;M[P][O[P]++]=r}}for(c=Math.min,a=Math.max,N=0;N!==n;N++){var z=(ie=o[N]).shape;switch(z.type){case R:var F=ie.position.x,U=ie.position.y,G=ie.position.z,k=z.radius;B(F-k,U-k,G-k,F+k,U+k,G+k,ie);break;case I:z.worldNormalNeedsUpdate&&z.computeWorldNormal(ie.quaternion);var H=z.worldNormal,V=v+.5*E-ie.position.x,j=y+.5*C-ie.position.y,W=x+.5*w-ie.position.z,q=r;q.set(V,j,W);for(var X=0,Y=0;X!==l;X++,Y+=_,q.y=j,q.x+=E)for(var K=0,$=0;K!==h;K++,$+=p,q.z=W,q.y+=C)for(var Q=0,Z=0;Q!==u;Q++,Z+=d,q.z+=w)if(q.dot(H)<A){var J=Y+$+Z;M[J][O[J]++]=ie}break;default:ie.aabbNeedsUpdate&&ie.computeAABB(),B(ie.aabb.lowerBound.x,ie.aabb.lowerBound.y,ie.aabb.lowerBound.z,ie.aabb.upperBound.x,ie.aabb.upperBound.y,ie.aabb.upperBound.z,ie)}}for(N=0;N!==D;N++){var ee=O[N];if(ee>1){var te=M[N];for(X=0;X!==ee;X++){var ie=te[X];for(K=0;K!==X;K++){var ne=te[K];this.needBroadphaseCollision(ie,ne)&&this.intersectionTest(ie,ne,t,i)}}}}this.makePairsUnique(t,i)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t){t.exports=s;var i=e("./Broadphase"),n=e("./AABB");function s(){i.apply(this)}s.prototype=new i,s.prototype.constructor=s,s.prototype.collisionPairs=function(e,t,i){var n,s,o,r,a=e.bodies,c=a.length;for(n=0;n!==c;n++)for(s=0;s!==n;s++)o=a[n],r=a[s],this.needBroadphaseCollision(o,r)&&this.intersectionTest(o,r,t,i)},new n,s.prototype.aabbQuery=function(e,t,i){i=i||[];for(var n=0;n<e.bodies.length;n++){var s=e.bodies[n];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&i.push(s)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t){function i(){this.matrix={}}t.exports=i,i.prototype.get=function(e,t){if(e=e.id,(t=t.id)>e){var i=t;t=e,e=i}return e+"-"+t in this.matrix},i.prototype.set=function(e,t,i){if(e=e.id,(t=t.id)>e){var n=t;t=e,e=n}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},i.prototype.reset=function(){this.matrix={}},i.prototype.setNumObjects=function(){}},{}],9:[function(e,t){function i(){this.current=[],this.previous=[]}function n(e,t){e.push((4294901760&t)>>16,65535&t)}t.exports=i,i.prototype.getKey=function(e,t){if(t<e){var i=t;t=e,e=i}return e<<16|t},i.prototype.set=function(e,t){for(var i=this.getKey(e,t),n=this.current,s=0;i>n[s];)s++;if(i!==n[s]){for(t=n.length-1;t>=s;t--)n[t+1]=n[t];n[s]=i}},i.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},i.prototype.getDiff=function(e,t){for(var i=this.current,s=this.previous,o=i.length,r=s.length,a=0,c=0;c<o;c++){for(var l=i[c];l>s[a];)a++;l===s[a]||n(e,l)}for(a=0,c=0;c<r;c++){for(var h=s[c];h>i[a];)a++;i[a]===h||n(t,h)}}},{}],10:[function(e,t){t.exports=c;var i=e("../math/Vec3"),n=e("../math/Quaternion"),s=e("../math/Transform"),o=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),r=e("../shapes/Shape"),a=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new i,this.to=t?t.clone():new i,this._direction=new i,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new o,this.hasHit=!1,this.callback=function(){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var l=new a,h=[];c.prototype.intersectWorld=function(e,t){return this.mode=t.mode||c.ANY,this.result=t.result||new o,this.skipBackfaces=!!t.skipBackfaces,this.checkCollisionResponse=!!t.checkCollisionResponse,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(l),h.length=0,e.broadphase.aabbQuery(e,l,h),this.intersectBodies(h),this.hasHit};var u=new i,_=new i;function p(e,t,i,n){n.vsub(t,B),i.vsub(t,u),e.vsub(t,_);var s,o,r=B.dot(B),a=B.dot(u),c=B.dot(_),l=u.dot(u),h=u.dot(_);return(s=l*c-a*h)>=0&&(o=r*h-a*c)>=0&&s+o<r*l-a*a}c.pointInTriangle=p;var d=new i,f=new n;c.prototype.intersectBody=function(e,t){if(t&&(this.result=t,this._updateDirection()),(!this.checkCollisionResponse||e.collisionResponse)&&c.perBodyFilter(this,e))for(var i=d,n=f,s=0,o=e.shapes.length;s<o;s++){var r=e.shapes[s];if(c.perShapeFilter(this,r)&&(e.quaternion.mult(e.shapeOrientations[s],n),e.quaternion.vmult(e.shapeOffsets[s],i),i.vadd(e.position,i),this.intersectShape(r,n,i,e),this.result._shouldStop))break}},c.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,n=e.length;!this.result._shouldStop&&i<n;i++)this.intersectBody(e[i])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(e,t,i,n){if(!(F(this.from,this._direction,i)>e.boundingSphereRadius)){var s=this[e.type];s&&s.call(this,e,t,i,n,e)}},new i,new i;var m=new i,g=new i,v=new i,y=new i;new i,new o,c.prototype.intersectBox=function(e,t,i,n,s){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,n,s)},c.prototype[r.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(e,t,n,s,o){var r=this.from,a=this.to,c=this._direction,l=new i(0,0,1);t.vmult(l,l);var h=new i;r.vsub(n,h);var u=h.dot(l);if(a.vsub(n,h),!(u*h.dot(l)>0||r.distanceTo(a)<u)){var _=l.dot(c);if(!(Math.abs(_)<this.precision)){var p=new i,d=new i,f=new i;r.vsub(n,p);var m=-l.dot(p)/_;c.scale(m,d),r.vadd(d,f),this.reportIntersection(l,f,o,s,-1)}}},c.prototype[r.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var x={faceList:[0]},S=new i,b=new c,T=[];c.prototype.intersectHeightfield=function(e,t,i,n,o){e.data,e.elementSize;var r=b;r.from.copy(this.from),r.to.copy(this.to),s.pointToLocalFrame(i,t,r.from,r.from),s.pointToLocalFrame(i,t,r.to,r.to),r._updateDirection();var c,l,h,u,_=T;c=l=0,h=u=e.data.length-1;var p=new a;r.getAABB(p),e.getIndexOfPosition(p.lowerBound.x,p.lowerBound.y,_,!0),c=Math.max(c,_[0]),l=Math.max(l,_[1]),e.getIndexOfPosition(p.upperBound.x,p.upperBound.y,_,!0),h=Math.min(h,_[0]+1),u=Math.min(u,_[1]+1);for(var d=c;d<h;d++)for(var f=l;f<u;f++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(d,f,p),p.overlapsRay(r)){if(e.getConvexTrianglePillar(d,f,!1),s.pointToWorldFrame(i,t,e.pillarOffset,S),this.intersectConvex(e.pillarConvex,t,S,n,o,x),this.result._shouldStop)return;e.getConvexTrianglePillar(d,f,!0),s.pointToWorldFrame(i,t,e.pillarOffset,S),this.intersectConvex(e.pillarConvex,t,S,n,o,x)}}},c.prototype[r.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var E=new i,C=new i;c.prototype.intersectSphere=function(e,t,i,n,s){var o=this.from,r=this.to,a=e.radius,c=Math.pow(r.x-o.x,2)+Math.pow(r.y-o.y,2)+Math.pow(r.z-o.z,2),l=2*((r.x-o.x)*(o.x-i.x)+(r.y-o.y)*(o.y-i.y)+(r.z-o.z)*(o.z-i.z)),h=Math.pow(o.x-i.x,2)+Math.pow(o.y-i.y,2)+Math.pow(o.z-i.z,2)-Math.pow(a,2),u=Math.pow(l,2)-4*c*h,_=E,p=C;if(!(u<0))if(0===u)o.lerp(r,u,_),_.vsub(i,p),p.normalize(),this.reportIntersection(p,_,s,n,-1);else{var d=(-l-Math.sqrt(u))/(2*c),f=(-l+Math.sqrt(u))/(2*c);if(d>=0&&d<=1&&(o.lerp(r,d,_),_.vsub(i,p),p.normalize(),this.reportIntersection(p,_,s,n,-1)),this.result._shouldStop)return;f>=0&&f<=1&&(o.lerp(r,f,_),_.vsub(i,p),p.normalize(),this.reportIntersection(p,_,s,n,-1))}},c.prototype[r.types.SPHERE]=c.prototype.intersectSphere;var w=new i,A=(new i,new i,new i);c.prototype.intersectConvex=function(e,t,i,n,s,o){for(var r=w,a=A,c=o&&o.faceList||null,l=e.faces,h=e.vertices,u=e.faceNormals,_=this._direction,d=this.from,f=this.to,x=d.distanceTo(f),S=c?c.length:l.length,b=this.result,T=0;!b._shouldStop&&T<S;T++){var E=c?c[T]:T,C=l[E],P=u[E],R=t,I=i;a.copy(h[C[0]]),R.vmult(a,a),a.vadd(I,a),a.vsub(d,a),R.vmult(P,r);var M=_.dot(r);if(!(Math.abs(M)<this.precision)){var O=r.dot(a)/M;if(!(O<0)){_.mult(O,m),m.vadd(d,m),g.copy(h[C[0]]),R.vmult(g,g),I.vadd(g,g);for(var D=1;!b._shouldStop&&D<C.length-1;D++){v.copy(h[C[D]]),y.copy(h[C[D+1]]),R.vmult(v,v),R.vmult(y,y),I.vadd(v,v),I.vadd(y,y);var N=m.distanceTo(d);!p(m,g,v,y)&&!p(m,v,g,y)||N>x||this.reportIntersection(r,m,s,n,E)}}}}},c.prototype[r.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var P=new i,R=new i,I=new i,M=new i,O=new i,D=new i,N=(new a,[]),L=new s;c.prototype.intersectTrimesh=function(e,t,i,n,o,r){var a=P,c=N,l=L,h=A,u=R,_=I,d=M,f=D,x=O,S=(r&&r.faceList,e.indices),b=(e.vertices,e.faceNormals,this.from),T=this.to,E=this._direction;l.position.copy(i),l.quaternion.copy(t),s.vectorToLocalFrame(i,t,E,u),s.pointToLocalFrame(i,t,b,_),s.pointToLocalFrame(i,t,T,d),d.x*=e.scale.x,d.y*=e.scale.y,d.z*=e.scale.z,_.x*=e.scale.x,_.y*=e.scale.y,_.z*=e.scale.z,d.vsub(_,u),u.normalize();var C=_.distanceSquared(d);e.tree.rayQuery(this,l,c);for(var w=0,B=c.length;!this.result._shouldStop&&w!==B;w++){var z=c[w];e.getNormal(z,a),e.getVertex(S[3*z],g),g.vsub(_,h);var F=u.dot(a),U=a.dot(h)/F;if(!(U<0)){u.scale(U,m),m.vadd(_,m),e.getVertex(S[3*z+1],v),e.getVertex(S[3*z+2],y);var G=m.distanceSquared(_);!p(m,v,g,y)&&!p(m,g,v,y)||G>C||(s.vectorToWorldFrame(t,a,x),s.pointToWorldFrame(i,t,m,f),this.reportIntersection(x,f,o,n,z))}}c.length=0},c.prototype[r.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(e,t,i,n,s){var o=this.from,r=this.to,a=o.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(l.hitFaceIndex=void 0!==s?s:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(o,r,e,t,i,n,a),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(a<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(o,r,e,t,i,n,a));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(o,r,e,t,i,n,a),l._shouldStop=!0}};var B=new i,z=new i;function F(e,t,i){i.vsub(e,B);var n=B.dot(t);return t.mult(n,z),z.vadd(e,z),i.distanceTo(z)}c.perBodyFilter=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)},c.perShapeFilter=function(e,t){return!(e.checkCollisionResponse&&!t.collisionResponse)}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t){var i=e("../math/Vec3");function n(){this.rayFromWorld=new i,this.rayToWorld=new i,this.hitNormalWorld=new i,this.hitPointWorld=new i,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}t.exports=n,n.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},n.prototype.abort=function(){this._shouldStop=!0},n.prototype.set=function(e,t,i,n,s,o,r){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=s,this.body=o,this.distance=r}},{"../math/Vec3":31}],12:[function(e,t){e("../shapes/Shape");var i=e("../collision/Broadphase");function n(e){i.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){var i=t.indexOf(e.body);-1!==i&&t.splice(i,1)},e&&this.setWorld(e)}t.exports=n,n.prototype=new i,n.prototype.setWorld=function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},n.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.x<=n.aabb.lowerBound.x);s--)e[s+1]=e[s];e[s+1]=n}return e},n.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.y<=n.aabb.lowerBound.y);s--)e[s+1]=e[s];e[s+1]=n}return e},n.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],s=t-1;s>=0&&!(e[s].aabb.lowerBound.z<=n.aabb.lowerBound.z);s--)e[s+1]=e[s];e[s+1]=n}return e},n.prototype.collisionPairs=function(e,t,i){var s,o,r=this.axisList,a=r.length,c=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),s=0;s!==a;s++){var l=r[s];for(o=s+1;o<a;o++){var h=r[o];if(this.needBroadphaseCollision(l,h)){if(!n.checkBounds(l,h,c))break;this.intersectionTest(l,h,t,i)}}}},n.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,s=0;s!==i;s++){var o=e[s];o.aabbNeedsUpdate&&o.computeAABB()}0===t?n.insertionSortX(e):1===t?n.insertionSortY(e):2===t&&n.insertionSortZ(e)},n.checkBounds=function(e,t,i){var n,s;0===i?(n=e.position.x,s=t.position.x):1===i?(n=e.position.y,s=t.position.y):2===i&&(n=e.position.z,s=t.position.z);var o=e.boundingRadius;return s-t.boundingRadius<n+o},n.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,n=0,s=0,o=0,r=this.axisList,a=r.length,c=1/a,l=0;l!==a;l++){var h=r[l],u=h.position.x;e+=u,t+=u*u;var _=h.position.y;i+=_,n+=_*_;var p=h.position.z;s+=p,o+=p*p}var d=t-e*e*c,f=n-i*i*c,m=o-s*s*c;this.axisIndex=d>f?d>m?0:2:f>m?1:2},n.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,s="x";1===n&&(s="y"),2===n&&(s="z");for(var o=this.axisList,r=(t.lowerBound[s],t.upperBound[s],0);r<o.length;r++){var a=o[r];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(t)&&i.push(a)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t){t.exports=r,e("./Constraint");var i=e("./PointToPointConstraint"),n=e("../equations/ConeEquation"),s=e("../equations/RotationalEquation"),o=(e("../equations/ContactEquation"),e("../math/Vec3"));function r(e,t,r){var a=void 0!==(r=r||{}).maxForce?r.maxForce:1e6,c=r.pivotA?r.pivotA.clone():new o,l=r.pivotB?r.pivotB.clone():new o;this.axisA=r.axisA?r.axisA.clone():new o,this.axisB=r.axisB?r.axisB.clone():new o,i.call(this,e,c,t,l,a),this.collideConnected=!!r.collideConnected,this.angle=void 0!==r.angle?r.angle:0;var h=this.coneEquation=new n(e,t,r),u=this.twistEquation=new s(e,t,r);this.twistAngle=void 0!==r.twistAngle?r.twistAngle:0,h.maxForce=0,h.minForce=-a,u.maxForce=0,u.minForce=-a,this.equations.push(h,u)}r.prototype=new i,r.constructor=r,new o,new o,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.coneEquation,s=this.twistEquation;i.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,n.axisA),t.vectorToWorldFrame(this.axisB,n.axisB),this.axisA.tangents(s.axisA,s.axisA),e.vectorToWorldFrame(s.axisA,s.axisA),this.axisB.tangents(s.axisB,s.axisB),t.vectorToWorldFrame(s.axisB,s.axisB),n.angle=this.angle,s.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t){t.exports=n;var i=e("../utils/Utils");function n(e,t,s){s=i.defaults(s,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=n.idCounter++,this.collideConnected=s.collideConnected,s.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}n.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},n.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},n.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},n.idCounter=0},{"../utils/Utils":54}],15:[function(e,t){t.exports=s;var i=e("./Constraint"),n=e("../equations/ContactEquation");function s(e,t,s,o){i.call(this,e,t),void 0===s&&(s=e.position.distanceTo(t.position)),void 0===o&&(o=1e6),this.distance=s;var r=this.distanceEquation=new n(e,t);this.equations.push(r),r.minForce=-o,r.maxForce=o}s.prototype=new i,s.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,n=.5*this.distance,s=i.ni;t.position.vsub(e.position,s),s.normalize(),s.mult(n,i.ri),s.mult(-n,i.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t){t.exports=r,e("./Constraint");var i=e("./PointToPointConstraint"),n=e("../equations/RotationalEquation"),s=e("../equations/RotationalMotorEquation"),o=(e("../equations/ContactEquation"),e("../math/Vec3"));function r(e,t,r){var a=void 0!==(r=r||{}).maxForce?r.maxForce:1e6,c=r.pivotA?r.pivotA.clone():new o,l=r.pivotB?r.pivotB.clone():new o;i.call(this,e,c,t,l,a),(this.axisA=r.axisA?r.axisA.clone():new o(1,0,0)).normalize(),(this.axisB=r.axisB?r.axisB.clone():new o(1,0,0)).normalize();var h=this.rotationalEquation1=new n(e,t,r),u=this.rotationalEquation2=new n(e,t,r),_=this.motorEquation=new s(e,t,a);_.enabled=!1,this.equations.push(h,u,_)}r.prototype=new i,r.constructor=r,r.prototype.enableMotor=function(){this.motorEquation.enabled=!0},r.prototype.disableMotor=function(){this.motorEquation.enabled=!1},r.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},r.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var a=new o,c=new o;r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.motorEquation,s=this.rotationalEquation1,o=this.rotationalEquation2,r=a,l=c,h=this.axisA,u=this.axisB;i.prototype.update.call(this),e.quaternion.vmult(h,r),t.quaternion.vmult(u,l),r.tangents(s.axisA,o.axisA),s.axisB.copy(l),o.axisB.copy(l),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,n.axisA),t.quaternion.vmult(this.axisB,n.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t){t.exports=o,e("./Constraint");var i=e("./PointToPointConstraint"),n=e("../equations/RotationalEquation"),s=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function o(e,t,o){var r=void 0!==(o=o||{}).maxForce?o.maxForce:1e6,a=new s,c=new s,l=new s;e.position.vadd(t.position,l),l.scale(.5,l),t.pointToLocalFrame(l,c),e.pointToLocalFrame(l,a),i.call(this,e,a,t,c,r),this.xA=e.vectorToLocalFrame(s.UNIT_X),this.xB=t.vectorToLocalFrame(s.UNIT_X),this.yA=e.vectorToLocalFrame(s.UNIT_Y),this.yB=t.vectorToLocalFrame(s.UNIT_Y),this.zA=e.vectorToLocalFrame(s.UNIT_Z),this.zB=t.vectorToLocalFrame(s.UNIT_Z);var h=this.rotationalEquation1=new n(e,t,o),u=this.rotationalEquation2=new n(e,t,o),_=this.rotationalEquation3=new n(e,t,o);this.equations.push(h,u,_)}o.prototype=new i,o.constructor=o,new s,new s,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=(this.motorEquation,this.rotationalEquation1),s=this.rotationalEquation2,o=this.rotationalEquation3;i.prototype.update.call(this),e.vectorToWorldFrame(this.xA,n.axisA),t.vectorToWorldFrame(this.yB,n.axisB),e.vectorToWorldFrame(this.yA,s.axisA),t.vectorToWorldFrame(this.zB,s.axisB),e.vectorToWorldFrame(this.zA,o.axisA),t.vectorToWorldFrame(this.xB,o.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t){t.exports=o;var i=e("./Constraint"),n=e("../equations/ContactEquation"),s=e("../math/Vec3");function o(e,t,o,r,a){i.call(this,e,o),a=void 0!==a?a:1e6,this.pivotA=t?t.clone():new s,this.pivotB=r?r.clone():new s;var c=this.equationX=new n(e,o),l=this.equationY=new n(e,o),h=this.equationZ=new n(e,o);this.equations.push(c,l,h),c.minForce=l.minForce=h.minForce=-a,c.maxForce=l.maxForce=h.maxForce=a,c.ni.set(1,0,0),l.ni.set(0,1,0),h.ni.set(0,0,1)}o.prototype=new i,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,n=this.equationY,s=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),s.ri.copy(i.ri),s.rj.copy(i.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t){t.exports=s;var i=e("../math/Vec3"),n=(e("../math/Mat3"),e("./Equation"));function s(e,t,s){var o=void 0!==(s=s||{}).maxForce?s.maxForce:1e6;n.call(this,e,t,-o,o),this.axisA=s.axisA?s.axisA.clone():new i(1,0,0),this.axisB=s.axisB?s.axisB.clone():new i(0,1,0),this.angle=void 0!==s.angle?s.angle:0}s.prototype=new n,s.prototype.constructor=s;var o=new i,r=new i;s.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,s=this.axisB,a=o,c=r,l=this.jacobianElementA,h=this.jacobianElementB;return n.cross(s,a),s.cross(n,c),l.rotational.copy(c),h.rotational.copy(a),-(Math.cos(this.angle)-n.dot(s))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t){t.exports=s;var i=e("./Equation"),n=e("../math/Vec3");function s(e,t,s){s=void 0!==s?s:1e6,i.call(this,e,t,0,s),this.si=null,this.sj=null,this.restitution=0,this.ri=new n,this.rj=new n,this.ni=new n}e("../math/Mat3"),s.prototype=new i,s.prototype.constructor=s;var o=new n,r=new n,a=new n;s.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.bi,s=this.bj,c=this.ri,l=this.rj,h=o,u=r,_=n.velocity,p=n.angularVelocity,d=(n.force,n.torque,s.velocity),f=s.angularVelocity,m=(s.force,s.torque,a),g=this.jacobianElementA,v=this.jacobianElementB,y=this.ni;c.cross(y,h),l.cross(y,u),y.negate(g.spatial),h.negate(g.rotational),v.spatial.copy(y),v.rotational.copy(u),m.copy(s.position),m.vadd(l,m),m.vsub(n.position,m),m.vsub(c,m);var x=y.dot(m),S=this.restitution+1;return-x*t-(S*d.dot(y)-S*_.dot(y)+f.dot(u)-p.dot(h))*i-e*this.computeGiMf()};var c=new n,l=new n,h=new n,u=new n,_=new n;s.prototype.getImpactVelocityAlongNormal=function(){var e=c,t=l,i=h,n=u,s=_;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(n,t),e.vsub(t,s),this.ni.dot(s)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t){t.exports=s;var i=e("../math/JacobianElement"),n=e("../math/Vec3");function s(e,t,n,o){this.id=s.id++,this.minForce=void 0===n?-1e6:n,this.maxForce=void 0===o?1e6:o,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new i,this.jacobianElementB=new i,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}s.prototype.constructor=s,s.id=0,s.prototype.setSpookParams=function(e,t,i){var n=t,s=e,o=i;this.a=4/(o*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(o*o*s*(1+4*n))},s.prototype.computeB=function(e,t,i){var n=this.computeGW();return-this.computeGq()*e-n*t-this.computeGiMf()*i},s.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,s=i.position,o=n.position;return e.spatial.dot(s)+t.spatial.dot(o)},new n,s.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,s=i.velocity,o=n.velocity,r=i.angularVelocity,a=n.angularVelocity;return e.multiplyVectors(s,r)+t.multiplyVectors(o,a)},s.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,s=i.vlambda,o=n.vlambda,r=i.wlambda,a=n.wlambda;return e.multiplyVectors(s,r)+t.multiplyVectors(o,a)};var o=new n,r=new n,a=new n,c=new n;s.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,s=i.force,l=i.torque,h=n.force,u=n.torque,_=i.invMassSolve,p=n.invMassSolve;return s.scale(_,o),h.scale(p,r),i.invInertiaWorldSolve.vmult(l,a),n.invInertiaWorldSolve.vmult(u,c),e.multiplyVectors(o,a)+t.multiplyVectors(r,c)};var l=new n;s.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,s=i.invMassSolve,o=n.invMassSolve,r=i.invInertiaWorldSolve,a=n.invInertiaWorldSolve,c=s+o;return r.vmult(e.rotational,l),c+=l.dot(e.rotational),a.vmult(t.rotational,l),c+l.dot(t.rotational)};var h=new n;new n,new n,new n,new n,new n,s.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,s=this.bj,o=h;n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),s.vlambda.addScaledVector(s.invMassSolve*e,i.spatial,s.vlambda),n.invInertiaWorldSolve.vmult(t.rotational,o),n.wlambda.addScaledVector(e,o,n.wlambda),s.invInertiaWorldSolve.vmult(i.rotational,o),s.wlambda.addScaledVector(e,o,s.wlambda)},s.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t){t.exports=s;var i=e("./Equation"),n=e("../math/Vec3");function s(e,t,s){i.call(this,e,t,-s,s),this.ri=new n,this.rj=new n,this.t=new n}e("../math/Mat3"),s.prototype=new i,s.prototype.constructor=s;var o=new n,r=new n;s.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,s=o,a=r,c=this.t;i.cross(c,s),n.cross(c,a);var l=this.jacobianElementA,h=this.jacobianElementB;return c.negate(l.spatial),s.negate(l.rotational),h.spatial.copy(c),h.rotational.copy(a),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t){t.exports=s;var i=e("../math/Vec3"),n=(e("../math/Mat3"),e("./Equation"));function s(e,t,s){var o=void 0!==(s=s||{}).maxForce?s.maxForce:1e6;n.call(this,e,t,-o,o),this.axisA=s.axisA?s.axisA.clone():new i(1,0,0),this.axisB=s.axisB?s.axisB.clone():new i(0,1,0),this.maxAngle=Math.PI/2}s.prototype=new n,s.prototype.constructor=s;var o=new i,r=new i;s.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,s=this.axisB,a=o,c=r,l=this.jacobianElementA,h=this.jacobianElementB;return n.cross(s,a),s.cross(n,c),l.rotational.copy(c),h.rotational.copy(a),-(Math.cos(this.maxAngle)-n.dot(s))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t){t.exports=s;var i=e("../math/Vec3"),n=(e("../math/Mat3"),e("./Equation"));function s(e,t,s){s=void 0!==s?s:1e6,n.call(this,e,t,-s,s),this.axisA=new i,this.axisB=new i,this.targetVelocity=0}s.prototype=new n,s.prototype.constructor=s,s.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,s=this.jacobianElementA,o=this.jacobianElementB;return s.rotational.copy(i),n.negate(o.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t){var i=e("../utils/Utils");function n(e,t,s){s=i.defaults(s,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=n.idCounter++,this.materials=[e,t],this.friction=s.friction,this.restitution=s.restitution,this.contactEquationStiffness=s.contactEquationStiffness,this.contactEquationRelaxation=s.contactEquationRelaxation,this.frictionEquationStiffness=s.frictionEquationStiffness,this.frictionEquationRelaxation=s.frictionEquationRelaxation}t.exports=n,n.idCounter=0},{"../utils/Utils":54}],26:[function(e,t){function i(e){var t="";"string"==typeof(e=e||{})?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=i.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1,this.correctInelastic=0}t.exports=i,i.idCounter=0},{}],27:[function(e,t){t.exports=n;var i=e("./Vec3");function n(){this.spatial=new i,this.rotational=new i}n.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},n.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t){t.exports=n;var i=e("./Vec3");function n(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}n.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},n.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},n.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},n.prototype.getTrace=function(e){e=e||new i;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},n.prototype.vmult=function(e,t){t=t||new i;var n=this.elements,s=e.x,o=e.y,r=e.z;return t.x=n[0]*s+n[1]*o+n[2]*r,t.y=n[3]*s+n[4]*o+n[5]*r,t.z=n[6]*s+n[7]*o+n[8]*r,t},n.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},n.prototype.mmult=function(e,t){for(var i=t||new n,s=0;s<3;s++)for(var o=0;o<3;o++){for(var r=0,a=0;a<3;a++)r+=e.elements[s+3*a]*this.elements[a+3*o];i.elements[s+3*o]=r}return i},n.prototype.scale=function(e,t){t=t||new n;for(var i=this.elements,s=t.elements,o=0;3!==o;o++)s[3*o+0]=e.x*i[3*o+0],s[3*o+1]=e.y*i[3*o+1],s[3*o+2]=e.z*i[3*o+2];return t},n.prototype.solve=function(e,t){t=t||new i;for(var n,s=3,o=4,r=[],a=0;a<s*o;a++)r.push(0);for(a=0;a<3;a++)for(n=0;n<3;n++)r[a+o*n]=this.elements[a+3*n];r[3]=e.x,r[7]=e.y,r[11]=e.z;var c,l,h=3,u=h,_=4;do{if(0===r[(a=u-h)+o*a])for(n=a+1;n<u;n++)if(0!==r[a+o*n]){c=_;do{r[(l=_-c)+o*a]+=r[l+o*n]}while(--c);break}if(0!==r[a+o*a])for(n=a+1;n<u;n++){var p=r[a+o*n]/r[a+o*a];c=_;do{r[(l=_-c)+o*n]=l<=a?0:r[l+o*n]-r[l+o*a]*p}while(--c)}}while(--h);if(t.z=r[2*o+3]/r[2*o+2],t.y=(r[1*o+3]-r[1*o+2]*t.z)/r[1*o+1],t.x=(r[0*o+3]-r[0*o+2]*t.z-r[0*o+1]*t.y)/r[0*o+0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},n.prototype.e=function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},n.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},n.prototype.toString=function(){for(var e="",t=",",i=0;i<9;i++)e+=this.elements[i]+t;return e},n.prototype.reverse=function(e){e=e||new n;for(var t,i=3,s=6,o=[],r=0;r<i*s;r++)o.push(0);for(r=0;r<3;r++)for(t=0;t<3;t++)o[r+s*t]=this.elements[r+3*t];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var a,c,l=3,h=l,u=s;do{if(0===o[(r=h-l)+s*r])for(t=r+1;t<h;t++)if(0!==o[r+s*t]){a=u;do{o[(c=u-a)+s*r]+=o[c+s*t]}while(--a);break}if(0!==o[r+s*r])for(t=r+1;t<h;t++){var _=o[r+s*t]/o[r+s*r];a=u;do{o[(c=u-a)+s*t]=c<=r?0:o[c+s*t]-o[c+s*r]*_}while(--a)}}while(--l);r=2;do{t=r-1;do{_=o[r+s*t]/o[r+s*r],a=s;do{o[(c=s-a)+s*t]=o[c+s*t]-o[c+s*r]*_}while(--a)}while(t--)}while(--r);r=2;do{_=1/o[r+s*r],a=s;do{o[(c=s-a)+s*r]=o[c+s*r]*_}while(--a)}while(r--);r=2;do{t=2;do{if(c=o[i+t+s*r],isNaN(c)||c===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(r,t,c)}while(t--)}while(r--);return e},n.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,n=e.z,s=e.w,o=t+t,r=i+i,a=n+n,c=t*o,l=t*r,h=t*a,u=i*r,_=i*a,p=n*a,d=s*o,f=s*r,m=s*a,g=this.elements;return g[0]=1-(u+p),g[1]=l-m,g[2]=h+f,g[3]=l+m,g[4]=1-(c+p),g[5]=_-d,g[6]=h-f,g[7]=_+d,g[8]=1-(c+u),this},n.prototype.transpose=function(e){for(var t=(e=e||new n).elements,i=this.elements,s=0;3!==s;s++)for(var o=0;3!==o;o++)t[3*s+o]=i[3*o+s];return e}},{"./Vec3":31}],29:[function(e,t){t.exports=n;var i=e("./Vec3");function n(e,t,i,n){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}n.prototype.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},n.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},n.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},n.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t),this},n.prototype.toAxisAngle=function(e){e=e||new i,this.normalize();var t=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return n<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,t]};var s=new i,o=new i;n.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=s,n=o;e.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var r=e.cross(t);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new i,new i,new i,n.prototype.mult=function(e,t){t=t||new n;var i=this.x,s=this.y,o=this.z,r=this.w,a=e.x,c=e.y,l=e.z,h=e.w;return t.x=i*h+r*a+s*l-o*c,t.y=s*h+r*c+o*a-i*l,t.z=o*h+r*l+i*c-s*a,t.w=r*h-i*a-s*c-o*l,t},n.prototype.inverse=function(e){var t=this.x,i=this.y,s=this.z,o=this.w;e=e||new n,this.conjugate(e);var r=1/(t*t+i*i+s*s+o*o);return e.x*=r,e.y*=r,e.z*=r,e.w*=r,e},n.prototype.conjugate=function(e){return(e=e||new n).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},n.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},n.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},n.prototype.vmult=function(e,t){t=t||new i;var n=e.x,s=e.y,o=e.z,r=this.x,a=this.y,c=this.z,l=this.w,h=l*n+a*o-c*s,u=l*s+c*n-r*o,_=l*o+r*s-a*n,p=-r*n-a*s-c*o;return t.x=h*l+p*-r+u*-c-_*-a,t.y=u*l+p*-a+_*-r-h*-c,t.z=_*l+p*-c+h*-a-u*-r,t},n.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},n.prototype.toEuler=function(e,t){var i,n,s;t=t||"YZX";var o=this.x,r=this.y,a=this.z,c=this.w;switch(t){case"YZX":var l=o*r+a*c;if(l>.499&&(i=2*Math.atan2(o,c),n=Math.PI/2,s=0),l<-.499&&(i=-2*Math.atan2(o,c),n=-Math.PI/2,s=0),isNaN(i)){var h=o*o,u=r*r,_=a*a;i=Math.atan2(2*r*c-2*o*a,1-2*u-2*_),n=Math.asin(2*l),s=Math.atan2(2*o*c-2*r*a,1-2*h-2*_)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=n,e.x=s},n.prototype.setFromEuler=function(e,t,i,n){n=n||"XYZ";var s=Math.cos(e/2),o=Math.cos(t/2),r=Math.cos(i/2),a=Math.sin(e/2),c=Math.sin(t/2),l=Math.sin(i/2);return"XYZ"===n?(this.x=a*o*r+s*c*l,this.y=s*c*r-a*o*l,this.z=s*o*l+a*c*r,this.w=s*o*r-a*c*l):"YXZ"===n?(this.x=a*o*r+s*c*l,this.y=s*c*r-a*o*l,this.z=s*o*l-a*c*r,this.w=s*o*r+a*c*l):"ZXY"===n?(this.x=a*o*r-s*c*l,this.y=s*c*r+a*o*l,this.z=s*o*l+a*c*r,this.w=s*o*r-a*c*l):"ZYX"===n?(this.x=a*o*r-s*c*l,this.y=s*c*r+a*o*l,this.z=s*o*l-a*c*r,this.w=s*o*r+a*c*l):"YZX"===n?(this.x=a*o*r+s*c*l,this.y=s*c*r+a*o*l,this.z=s*o*l-a*c*r,this.w=s*o*r-a*c*l):"XZY"===n&&(this.x=a*o*r-s*c*l,this.y=s*c*r-a*o*l,this.z=s*o*l+a*c*r,this.w=s*o*r+a*c*l),this},n.prototype.clone=function(){return new n(this.x,this.y,this.z,this.w)},n.prototype.slerp=function(e,t,i){i=i||new n;var s,o,r,a,c,l=this.x,h=this.y,u=this.z,_=this.w,p=e.x,d=e.y,f=e.z,m=e.w;return(o=l*p+h*d+u*f+_*m)<0&&(o=-o,p=-p,d=-d,f=-f,m=-m),1-o>1e-6?(s=Math.acos(o),r=Math.sin(s),a=Math.sin((1-t)*s)/r,c=Math.sin(t*s)/r):(a=1-t,c=t),i.x=a*l+c*p,i.y=a*h+c*d,i.z=a*u+c*f,i.w=a*_+c*m,i},n.prototype.integrate=function(e,t,i,s){s=s||new n;var o=e.x*i.x,r=e.y*i.y,a=e.z*i.z,c=this.x,l=this.y,h=this.z,u=this.w,_=.5*t;return s.x+=_*(o*u+r*h-a*l),s.y+=_*(r*u+a*c-o*h),s.z+=_*(a*u+o*l-r*c),s.w+=_*(-o*c-r*l-a*h),s},n.prototype.euqals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{"./Vec3":31}],30:[function(e,t){var i=e("./Vec3"),n=e("./Quaternion");function s(e){e=e||{},this.position=new i,e.position&&this.position.copy(e.position),this.quaternion=new n,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=s;var o=new n;s.pointToLocalFrame=function(e,t,n,s){return s=s||new i,n.vsub(e,s),t.conjugate(o),o.vmult(s,s),s},s.prototype.pointToLocal=function(e,t){return s.pointToLocalFrame(this.position,this.quaternion,e,t)},s.pointToWorldFrame=function(e,t,n,s){return s=s||new i,t.vmult(n,s),s.vadd(e,s),s},s.prototype.pointToWorld=function(e,t){return s.pointToWorldFrame(this.position,this.quaternion,e,t)},s.prototype.vectorToWorldFrame=function(e,t){return t=t||new i,this.quaternion.vmult(e,t),t},s.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},s.vectorToLocalFrame=function(e,t,n,s){return s=s||new i,t.w*=-1,t.vmult(n,s),t.w*=-1,s}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t){t.exports=n;var i=e("./Mat3");function n(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}n.ZERO=new n(0,0,0),n.UNIT_X=new n(1,0,0),n.UNIT_Y=new n(0,1,0),n.UNIT_Z=new n(0,0,1),n.prototype.cross=function(e,t){var i=e.x,s=e.y,o=e.z,r=this.x,a=this.y,c=this.z;return(t=t||new n).x=a*o-c*s,t.y=c*i-r*o,t.z=r*s-a*i,t},n.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},n.prototype.setZero=function(){this.x=this.y=this.z=0},n.prototype.vadd=function(e,t){if(!t)return new n(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},n.prototype.vsub=function(e,t){if(!t)return new n(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},n.prototype.crossmat=function(){return new i([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},n.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,n=Math.sqrt(e*e+t*t+i*i);if(n>0){var s=1/n;this.x*=s,this.y*=s,this.z*=s}else this.x=0,this.y=0,this.z=0;return n},n.prototype.unit=function(e){e=e||new n;var t=this.x,i=this.y,s=this.z,o=Math.sqrt(t*t+i*i+s*s);return o>0?(o=1/o,e.x=t*o,e.y=i*o,e.z=s*o):(e.x=1,e.y=0,e.z=0),e},n.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},n.prototype.length=n.prototype.norm,n.prototype.norm2=function(){return this.dot(this)},n.prototype.lengthSquared=n.prototype.norm2,n.prototype.distanceTo=function(e){var t=this.x,i=this.y,n=this.z,s=e.x,o=e.y,r=e.z;return Math.sqrt((s-t)*(s-t)+(o-i)*(o-i)+(r-n)*(r-n))},n.prototype.distanceSquared=function(e){var t=this.x,i=this.y,n=this.z,s=e.x,o=e.y,r=e.z;return(s-t)*(s-t)+(o-i)*(o-i)+(r-n)*(r-n)},n.prototype.mult=function(e,t){t=t||new n;var i=this.x,s=this.y,o=this.z;return t.x=e*i,t.y=e*s,t.z=e*o,t},n.prototype.vmul=function(e,t){return(t=t||new n).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},n.prototype.scale=n.prototype.mult,n.prototype.addScaledVector=function(e,t,i){return(i=i||new n).x=this.x+e*t.x,i.y=this.y+e*t.y,i.z=this.z+e*t.z,i},n.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},n.prototype.negate=function(e){return(e=e||new n).x=-this.x,e.y=-this.y,e.z=-this.z,e};var s=new n,o=new n;n.prototype.tangents=function(e,t){var i=this.norm();if(i>0){var n=s,r=1/i;n.set(this.x*r,this.y*r,this.z*r);var a=o;Math.abs(n.x)<.9?(a.set(1,0,0),n.cross(a,e)):(a.set(0,1,0),n.cross(a,e)),n.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},n.prototype.toString=function(){return this.x+","+this.y+","+this.z},n.prototype.toArray=function(){return[this.x,this.y,this.z]},n.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},n.prototype.lerp=function(e,t,i){var n=this.x,s=this.y,o=this.z;i.x=n+(e.x-n)*t,i.y=s+(e.y-s)*t,i.z=o+(e.z-o)*t},n.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},n.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var r=new n;n.prototype.isAntiparallelTo=function(e,t){return this.negate(r),r.almostEquals(e,t)},n.prototype.clone=function(){return new n(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t){t.exports=u;var i=e("../utils/EventTarget"),n=e("../shapes/Shape"),s=e("../math/Vec3"),o=e("../math/Mat3"),r=e("../math/Quaternion"),a=(e("../material/Material"),e("../collision/AABB")),c=e("../shapes/Box"),l=e("../collision/RaycastResult"),h=e("../world/World");function u(e){e=e||{},i.apply(this),this.id=u.idCounter++,this.world=null,this.preStep=null,this.ccdSpeedThreshold=void 0!==e.ccdSpeedThreshold?e.ccdSpeedThreshold:-1,this.ccdIterations=void 0!==e.ccdIterations?e.ccdIterations:5,this.postStep=null,this.vlambda=new s,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new s,this.previousPosition=new s,this.interpolatedPosition=new s,this.initPosition=new s,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new s,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new s,this.force=new s;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=t>0?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?u.STATIC:u.DYNAMIC,typeof e.type==typeof u.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new s,this.quaternion=new r,this.initQuaternion=new r,this.previousQuaternion=new r,this.interpolatedQuaternion=new r,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new s,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new s,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new s,this.invInertia=new s,this.invInertiaWorld=new o,this.invMassSolve=0,this.invInertiaSolve=new s,this.invInertiaWorldSolve=new o,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new s(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new s(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new a,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new s,e.shape&&this.addShape(e.shape),this.hasTrigger=!0,this.updateMassProperties()}u.prototype=new i,u.prototype.constructor=u,u.COLLIDE_EVENT_NAME="collide",u.DYNAMIC=1,u.STATIC=2,u.KINEMATIC=4,u.AWAKE=0,u.SLEEPY=1,u.SLEEPING=2,u.idCounter=0,u.wakeupEvent={type:"wakeup"},u.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===u.SLEEPING&&this.dispatchEvent(u.wakeupEvent)},u.prototype.sleep=function(){this.sleepState=u.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},u.sleepyEvent={type:"sleepy"},u.sleepEvent={type:"sleep"},u.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);t===u.AWAKE&&i<n?(this.sleepState=u.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(u.sleepyEvent)):t===u.SLEEPY&&i>n?this.wakeUp():t===u.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(u.sleepEvent))}},u.prototype.updateSolveMassProperties=function(){this.sleepState===u.SLEEPING||this.type===u.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},u.prototype.pointToLocalFrame=function(e,t){return t=t||new s,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},u.prototype.vectorToLocalFrame=function(e,t){return t=t||new s,this.quaternion.conjugate().vmult(e,t),t},u.prototype.pointToWorldFrame=function(e,t){return t=t||new s,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},u.prototype.vectorToWorldFrame=function(e,t){return t=t||new s,this.quaternion.vmult(e,t),t};var _=new s,p=new r;u.prototype.addShape=function(e,t,i){var n=new s,o=new r;return t&&n.copy(t),i&&o.copy(i),this.shapes.push(e),this.shapeOffsets.push(n),this.shapeOrientations.push(o),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger(),h.idToShapeMap[e.id]=e,e.body=this,this},u.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger())},u.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,n=0,s=0;s!==i;s++){var o=e[s];o.updateBoundingSphereRadius();var r=t[s].norm(),a=o.boundingSphereRadius;r+a>n&&(n=r+a)}this.boundingRadius=n};var d=new a;u.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,n=e.length,s=_,o=p,r=this.quaternion,a=this.aabb,c=d,l=0;l!==n;l++){var h=e[l];r.vmult(t[l],s),s.vadd(this.position,s),i[l].mult(r,o),h.calculateWorldAABB(s,o,c.lowerBound,c.upperBound),0===l?a.copy(c):a.extend(c)}this.aabbNeedsUpdate=!1};var f=new o,m=new o;new o,u.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=f,n=m;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(t,i),i.mmult(n,this.invInertiaWorld)}},new s;var g=new s;u.prototype.applyForce=function(e,t){if(this.type===u.DYNAMIC){var i=g;t.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var v=new s,y=new s;u.prototype.applyLocalForce=function(e,t){if(this.type===u.DYNAMIC){var i=v,n=y;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyForce(i,n)}},new s;var x=new s,S=new s;u.prototype.applyImpulse=function(e,t){if(this.type===u.DYNAMIC){var i=t,n=x;n.copy(e),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var s=S;i.cross(e,s),this.invInertiaWorld.vmult(s,s),this.angularVelocity.vadd(s,this.angularVelocity)}};var b=new s,T=new s;u.prototype.applyLocalImpulse=function(e,t){if(this.type===u.DYNAMIC){var i=b,n=T;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyImpulse(i,n)}};var E=new s;u.prototype.updateMassProperties=function(){var e=E;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),c.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!i?1/t.x:0,t.y>0&&!i?1/t.y:0,t.z>0&&!i?1/t.z:0),this.updateInertiaWorld(!0)},u.prototype.getVelocityAtWorldPoint=function(e,t){var i=new s;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t},new s,new s;var C=new s,w=(new r,new r);u.prototype.integrate=function(e,t,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===u.DYNAMIC||h.integrateKinematic&&this.type===u.KINEMATIC)&&this.sleepState!==u.SLEEPING){var n=this.velocity,s=this.angularVelocity,o=this.position,r=this.force,a=this.torque,c=this.quaternion,l=this.invMass,_=this.invInertiaWorld,p=this.linearFactor,d=l*e;n.x+=r.x*d*p.x,n.y+=r.y*d*p.y,n.z+=r.z*d*p.z;var f=_.elements,m=this.angularFactor,g=a.x*m.x,v=a.y*m.y,y=a.z*m.z;s.x+=e*(f[0]*g+f[1]*v+f[2]*y),s.y+=e*(f[3]*g+f[4]*v+f[5]*y),s.z+=e*(f[6]*g+f[7]*v+f[8]*y),c.integrate(this.angularVelocity,e,this.angularFactor,c),t&&(i?c.normalizeFast():c.normalize()),this.type===u.DYNAMIC&&this.ccdSpeedThreshold>0&&this.velocity.length()>=Math.pow(this.ccdSpeedThreshold,2)&&this.integrateToTimeOfImpact(e)||(n.mult(e,C),o.vadd(C,o)),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},u.prototype.updateKinematic=function(e){if(this.type===u.KINEMATIC&&0!==e){this.velocity.setZero(),this.angularVelocity.setZero();var t=1/e;this.previousPosition.almostEquals(this.position)||(this.position.vsub(this.previousPosition,this.velocity),this.velocity.mult(t,this.velocity),this.aabbNeedsUpdate=!0),this.previousQuaternion.euqals(this.quaternion)||(this.previousQuaternion.conjugate(w),w.mult(this.quaternion,w),w.toEuler(this.angularVelocity),this.angularVelocity.mult(t,this.angularVelocity),this.aabbNeedsUpdate=!0)}},u.prototype.applyGravity=function(e){if(this.type===u.DYNAMIC){if(1==this.linearDamping)this.force.setZero();else if(this.useGravity){var t=e.x,i=e.y,n=e.z,s=this.force,o=this.mass;s.x+=o*t,s.y+=o*i,s.z+=o*n}1==this.angularDamping&&this.torque.setZero()}};var A=new s,P=new s,R=new s,I=new s,M=new s,O=new s,D=new l,N=new l,L=new l,B=new s,z=new s,F=new s,U=new o;u.prototype.integrateToTimeOfImpact=function(e){A.copy(this.velocity),A.normalize(),this.velocity.mult(e,R),R.vadd(this.position,P),P.vsub(this.position,M);var t,i=M.length(),s=this.collisionFilterGroup;this.collisionFilterGroup=0;for(var o=1,r=0;r<this.shapes.length;r++){var a=this.shapes[r],c={collisionFilterMask:a.collisionFilterMask,collisionFilterGroup:a.collisionFilterGroup,skipBackfaces:!0};if(B.copy(this.position),B.vadd(M,z),u.DrawLine(B,z),this.world.raycastClosest(B,z,c,D),t=D.body,a.type===n.types.SPHERE&&(o=a.radius,h.ccdSphereAdvance)){if(F.copy(this.velocity),F.y=0,F.normalize(),B.copy(F),U.identity(),U.elements[0]=B.x,U.elements[1]=-B.z,U.elements[3]=B.z,U.elements[4]=B.x,I.set(0,a.radius,0),U.vmult(I,I),I.z=I.y,I.y=0,I.vadd(this.position,B),R.vadd(B,z),u.DrawLine(B,z),this.world.raycastClosest(B,z,c,N),I.negate(I),I.vadd(this.position,B),R.vadd(B,z),u.DrawLine(B,z),this.world.raycastClosest(B,z,c,L),N.hasHit){N.hitPointWorld.vsub(this.position,B);var l=A.dot(B);(!D.hasHit||D.distance>l)&&(D.hasHit=!0,D.distance=l,t=N.body,A.mult(l,B),B.vadd(this.position,D.hitPointWorld))}L.hasHit&&(L.hitPointWorld.vsub(this.position,B),l=A.dot(B),(!D.hasHit||D.distance>l)&&(D.hasHit=!0,D.distance=l,t=L.body,A.mult(l,B),B.vadd(this.position,D.hitPointWorld)))}if(t)break}if(this.collisionFilterGroup=s,!t)return!1;D.hasHit&&u.DrawSphere(D.hitPointWorld,.05),N.hasHit&&u.DrawSphere(N.hitPointWorld,.05),L.hasHit&&u.DrawSphere(L.hitPointWorld,.05);var _=1;(P=D.hitPointWorld).vsub(this.position,M),_=D.distance/i,O.copy(this.position);for(var p=0,d=0,f=_,m=1;m>=d&&p<this.ccdIterations;){p++,f=(m+d)/2,M.mult(f,C),O.vadd(C,this.position),this.computeAABB(),u.DrawSphere(this.position,o);var g=this.aabb.overlaps(t.aabb);if(g){var v=[];this.world.narrowphase.getContacts([this],[t],this.world,v,[],[],[]),g=v.length>0}g?m=f:d=f}return _=m,this.position.copy(O),M.mult(_,C),this.position.vadd(C,this.position),!0},u.DrawSphere=u.DrawLine=function(){},u.prototype.isSleeping=function(){return this.sleepState===u.SLEEPING},u.prototype.isSleepy=function(){return this.sleepState===u.SLEEPY},u.prototype.isAwake=function(){return this.sleepState===u.AWAKE},u.prototype.updateHasTrigger=function(){for(var e=this.shapes.length;e--&&(this.hasTrigger=!this.shapes[e].collisionResponse,!this.hasTrigger););}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t){e("./Body");var i=e("../math/Vec3"),n=e("../math/Quaternion"),s=(e("../collision/RaycastResult"),e("../collision/Ray")),o=e("../objects/WheelInfo");function r(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=r,new i,new i,new i;var a=new i,c=new i,l=new i;new s,r.prototype.addWheel=function(e){var t=new o(e=e||{}),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},r.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new i,r.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},r.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},r.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},r.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},r.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,n=t.length,s=this.chassisBody,o=0;o<n;o++)this.updateWheelTransform(o);this.currentVehicleSpeedKmHour=3.6*s.velocity.norm();var r=new i;for(this.getVehicleAxisWorld(this.indexForwardAxis,r),r.dot(s.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),o=0;o<n;o++)this.castRay(t[o]);this.updateSuspension(e);var a=new i,c=new i;for(o=0;o<n;o++){var l=(p=t[o]).suspensionForce;l>p.maxSuspensionForce&&(l=p.maxSuspensionForce),p.raycastResult.hitNormalWorld.scale(l*e,a),p.raycastResult.hitPointWorld.vsub(s.position,c),s.applyImpulse(a,c)}this.updateFriction(e);var h=new i,u=new i,_=new i;for(o=0;o<n;o++){var p=t[o];s.getVelocityAtWorldPoint(p.chassisConnectionPointWorld,_);var d=1;switch(this.indexUpAxis){case 1:d=-1}if(p.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var f=u.dot(p.raycastResult.hitNormalWorld);p.raycastResult.hitNormalWorld.scale(f,h),u.vsub(h,u);var m=u.dot(_);p.deltaRotation=d*m*e/p.radius}!p.sliding&&p.isInContact||0===p.engineForce||!p.useCustomSlidingRotationalSpeed||(p.deltaRotation=(p.engineForce>0?1:-1)*p.customSlidingRotationalSpeed*e),Math.abs(p.brake)>Math.abs(p.engineForce)&&(p.deltaRotation=0),p.rotation+=p.deltaRotation,p.deltaRotation*=.99}},r.prototype.updateSuspension=function(){for(var e=this.chassisBody.mass,t=this.wheelInfos,i=t.length,n=0;n<i;n++){var s=t[n];if(s.isInContact){var o,r=s.suspensionRestLength-s.suspensionLength;o=s.suspensionStiffness*r*s.clippedInvContactDotSuspension;var a=s.suspensionRelativeVelocity;o-=(a<0?s.dampingCompression:s.dampingRelaxation)*a,s.suspensionForce=o*e,s.suspensionForce<0&&(s.suspensionForce=0)}else s.suspensionForce=0}},r.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var h=new i,u=new i;r.prototype.castRay=function(e){var t=h,n=u;this.updateWheelTransformWorld(e);var s=this.chassisBody,o=-1,r=e.suspensionRestLength+e.radius;e.directionWorld.scale(r,t);var a=e.chassisConnectionPointWorld;a.vadd(t,n);var c=e.raycastResult;c.reset();var l=s.collisionResponse;s.collisionResponse=!1,this.world.rayTest(a,n,c),s.collisionResponse=l;var _=c.body;if(e.raycastResult.groundObject=0,_){o=c.distance,e.raycastResult.hitNormalWorld=c.hitNormalWorld,e.isInContact=!0;var p=c.distance;e.suspensionLength=p-e.radius;var d=e.suspensionRestLength-e.maxSuspensionTravel,f=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<d&&(e.suspensionLength=d),e.suspensionLength>f&&(e.suspensionLength=f,e.raycastResult.reset());var m=e.raycastResult.hitNormalWorld.dot(e.directionWorld),g=new i;s.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,g);var v=e.raycastResult.hitNormalWorld.dot(g);if(m>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var y=-1/m;e.suspensionRelativeVelocity=v*y,e.clippedInvContactDotSuspension=y}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return o},r.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},r.prototype.updateWheelTransform=function(e){var t=a,i=c,s=l,o=this.wheelInfos[e];this.updateWheelTransformWorld(o),o.directionLocal.scale(-1,t),i.copy(o.axleLocal),t.cross(i,s),s.normalize(),i.normalize();var r=o.steering,h=new n;h.setFromAxisAngle(t,r);var u=new n;u.setFromAxisAngle(i,o.rotation);var _=o.worldTransform.quaternion;this.chassisBody.quaternion.mult(h,_),_.mult(u,_),_.normalize();var p=o.worldTransform.position;p.copy(o.directionWorld),p.scale(o.suspensionLength,p),p.vadd(o.chassisConnectionPointWorld,p)};var _=[new i(1,0,0),new i(0,1,0),new i(0,0,1)];r.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var p=new i,d=[],f=[],m=1;r.prototype.updateFriction=function(e){for(var t=p,n=this.wheelInfos,s=n.length,o=this.chassisBody,r=f,a=d,c=0;c<s;c++){var l=(M=n[c]).raycastResult.body;M.sideImpulse=0,M.forwardImpulse=0,r[c]||(r[c]=new i),a[c]||(a[c]=new i)}for(c=0;c<s;c++)if(l=(M=n[c]).raycastResult.body){var h=a[c];this.getWheelTransformWorld(c).vectorToWorldFrame(_[this.indexRightAxis],h);var u=M.raycastResult.hitNormalWorld,g=h.dot(u);u.scale(g,t),h.vsub(t,h),h.normalize(),u.cross(h,r[c]),r[c].normalize(),M.sideImpulse=R(o,M.raycastResult.hitPointWorld,l,M.raycastResult.hitPointWorld,h),M.sideImpulse*=m}var v=1,y=.5;for(this.sliding=!1,c=0;c<s;c++){l=(M=n[c]).raycastResult.body;var S=0;if(M.slipInfo=1,l){var b=0,T=M.brake?M.brake:b;S=x(o,l,M.raycastResult.hitPointWorld,r[c],T);var E=T/(S+=M.engineForce*e);M.slipInfo*=E}if(M.forwardImpulse=0,M.skidInfo=1,l){M.skidInfo=1;var C=M.suspensionForce*e*M.frictionSlip,w=C*C;M.forwardImpulse=S;var A=M.forwardImpulse*y,P=M.sideImpulse*v,I=A*A+P*P;M.sliding=!1,I>w&&(this.sliding=!0,M.sliding=!0,E=C/Math.sqrt(I),M.skidInfo*=E)}}if(this.sliding)for(c=0;c<s;c++)0!==(M=n[c]).sideImpulse&&M.skidInfo<1&&(M.forwardImpulse*=M.skidInfo,M.sideImpulse*=M.skidInfo);for(c=0;c<s;c++){var M=n[c],O=new i;if(M.raycastResult.hitPointWorld.vsub(o.position,O),0!==M.forwardImpulse){var D=new i;r[c].scale(M.forwardImpulse,D),o.applyImpulse(D,O)}if(0!==M.sideImpulse){l=M.raycastResult.body;var N=new i;M.raycastResult.hitPointWorld.vsub(l.position,N);var L=new i;a[c].scale(M.sideImpulse,L),o.vectorToLocalFrame(O,O),O["xyz"[this.indexUpAxis]]*=M.rollInfluence,o.vectorToWorldFrame(O,O),o.applyImpulse(L,O),L.scale(-1,L),l.applyImpulse(L,N)}}};var g=new i,v=new i,y=new i;function x(e,t,i,n,s){var o=0,r=i,a=g,c=v,l=y;return e.getVelocityAtWorldPoint(r,a),t.getVelocityAtWorldPoint(r,c),a.vsub(c,l),s<(o=-n.dot(l)*(1/(C(e,i,n)+C(t,i,n))))&&(o=s),o<-s&&(o=-s),o}var S=new i,b=new i,T=new i,E=new i;function C(e,t,i){var n=S,s=b,o=T,r=E;return t.vsub(e.position,n),n.cross(i,s),e.invInertiaWorld.vmult(s,r),r.cross(n,o),e.invMass+i.dot(o)}var w=new i,A=new i,P=new i;function R(e,t,i,n,s){if(s.norm2()>1.1)return 0;var o=w,r=A,a=P;return e.getVelocityAtWorldPoint(t,o),i.getVelocityAtWorldPoint(n,r),o.vsub(r,a),-.2*s.dot(a)*(1/(e.invMass+i.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t){var i=e("./Body"),n=e("../shapes/Sphere"),s=e("../shapes/Box"),o=e("../math/Vec3"),r=e("../constraints/HingeConstraint");function a(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new o(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new s(new o(5,2,.5));this.chassisBody=new i(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}t.exports=a,a.prototype.addWheel=function(e){var t=(e=e||{}).body;t||(t=new i(1,new n(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0),new o;var s=void 0!==e.position?e.position.clone():new o,a=new o;this.chassisBody.pointToWorldFrame(s,a),t.position.set(a.x,a.y,a.z);var c=void 0!==e.axis?e.axis.clone():new o(0,1,0);this.wheelAxes.push(c);var l=new r(this.chassisBody,t,{pivotA:s,axisA:c,pivotB:o.ZERO,axisB:c,collideConnected:!1});return this.constraints.push(l),this.wheelBodies.length-1},a.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],n=Math.cos(e),s=Math.sin(e),o=i.x,r=i.y;this.constraints[t].axisA.set(n*o-s*r,s*o+n*r,0)},a.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},a.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var c=new o;a.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},a.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],n=this.wheelBodies[t],s=n.torque;i.scale(e,c),n.vectorToWorldFrame(c,c),s.vadd(c,s)},a.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.addBody(i[n]);for(n=0;n<t.length;n++)e.addConstraint(t[n]);e.addEventListener("preStep",this._update.bind(this))},a.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},a.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.remove(i[n]);for(n=0;n<t.length;n++)e.removeConstraint(t[n])};var l=new o;a.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,l),i.dot(l)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t){t.exports=n,e("../shapes/Shape");var i=e("../math/Vec3");function n(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),n.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},n.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var s=new i;n.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,n=e.id,o=this.smoothingRadius*this.smoothingRadius,r=s,a=0;a!==i;a++){var c=this.particles[a];c.position.vsub(e.position,r),n!==c.id&&r.norm2()<o&&t.push(c)}};var o=new i,r=new i,a=new i,c=new i,l=new i,h=new i;n.prototype.update=function(){for(var e=this.particles.length,t=o,i=this.speedOfSound,n=this.eps,s=0;s!==e;s++){var u=this.particles[s];(E=this.neighbors[s]).length=0,this.getNeighbors(u,E),E.push(this.particles[s]);for(var _=E.length,p=0,d=0;d!==_;d++){u.position.vsub(E[d].position,t);var f=t.norm(),m=this.w(f);p+=E[d].mass*m}this.densities[s]=p,this.pressures[s]=i*i*(this.densities[s]-this.density)}var g=r,v=a,y=c,x=l,S=h;for(s=0;s!==e;s++){var b,T,E,C=this.particles[s];for(g.set(0,0,0),v.set(0,0,0),_=(E=this.neighbors[s]).length,d=0;d!==_;d++){var w=E[d];C.position.vsub(w.position,x);var A=x.norm();b=-w.mass*(this.pressures[s]/(this.densities[s]*this.densities[s]+n)+this.pressures[d]/(this.densities[d]*this.densities[d]+n)),this.gradw(x,y),y.mult(b,y),g.vadd(y,g),w.velocity.vsub(C.velocity,S),S.mult(1/(1e-4+this.densities[s]*this.densities[d])*this.viscosity*w.mass,S),T=this.nablaw(A),S.mult(T,S),v.vadd(S,v)}v.mult(C.mass,v),g.mult(C.mass,g),C.force.vadd(v,C.force),C.force.vadd(g,C.force)}},n.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},n.prototype.gradw=function(e,t){var i=e.norm(),n=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),t)},n.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t){var i=e("../math/Vec3");function n(e,t,n){n=n||{},this.restLength="number"==typeof n.restLength?n.restLength:1,this.stiffness=n.stiffness||100,this.damping=n.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new i,this.localAnchorB=new i,n.localAnchorA&&this.localAnchorA.copy(n.localAnchorA),n.localAnchorB&&this.localAnchorB.copy(n.localAnchorB),n.worldAnchorA&&this.setWorldAnchorA(n.worldAnchorA),n.worldAnchorB&&this.setWorldAnchorB(n.worldAnchorB)}t.exports=n,n.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},n.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},n.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},n.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var s=new i,o=new i,r=new i,a=new i,c=new i,l=new i,h=new i,u=new i,_=new i,p=new i,d=new i;n.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,n=this.bodyA,f=this.bodyB,m=s,g=o,v=r,y=a,x=d,S=c,b=l,T=h,E=u,C=_,w=p;this.getWorldAnchorA(S),this.getWorldAnchorB(b),S.vsub(n.position,T),b.vsub(f.position,E),b.vsub(S,m);var A=m.norm();g.copy(m),g.normalize(),f.velocity.vsub(n.velocity,v),f.angularVelocity.cross(E,x),v.vadd(x,v),n.angularVelocity.cross(T,x),v.vsub(x,v),g.mult(-e*(A-i)-t*v.dot(g),y),n.force.vsub(y,n.force),f.force.vadd(y,f.force),T.cross(y,C),E.cross(y,w),n.torque.vsub(C,n.torque),f.torque.vadd(w,f.torque)}},{"../math/Vec3":31}],37:[function(e,t){var i=e("../math/Vec3"),n=e("../math/Transform"),s=e("../collision/RaycastResult"),o=e("../utils/Utils");function r(e){e=o.defaults(e,{chassisConnectionPointLocal:new i,chassisConnectionPointWorld:new i,directionLocal:new i,directionWorld:new i,axleLocal:new i,axleWorld:new i,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new s,this.worldTransform=new n,this.isInContact=!1}t.exports=r;var a=new i,c=new i;a=new i,r.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,a);var n=t.hitNormalWorld.dot(a);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var s=-1/i;this.suspensionRelativeVelocity=n*s,this.clippedInvContactDotSuspension=s}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t){t.exports=o;var i=e("./Shape"),n=e("../math/Vec3"),s=e("./ConvexPolyhedron");function o(e){i.call(this,{type:i.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}o.prototype=new i,o.prototype.constructor=o,o.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,o=n,r=[new o(-e,-t,-i),new o(e,-t,-i),new o(e,t,-i),new o(-e,t,-i),new o(-e,-t,i),new o(e,-t,i),new o(e,t,i),new o(-e,t,i)],a=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],c=(new o(0,0,1),new o(0,1,0),new o(1,0,0),new s(r,a));this.convexPolyhedronRepresentation=c,c.material=this.material},o.prototype.calculateLocalInertia=function(e,t){return t=t||new n,o.calculateInertia(this.halfExtents,e,t),t},o.calculateInertia=function(e,t,i){var n=e;n.isZero()?(i.x=2/12*t,i.y=2/12*t,i.z=2/12*t):(i.x=1/12*t*(4*n.y*n.y+4*n.z*n.z),i.y=1/12*t*(4*n.x*n.x+4*n.z*n.z),i.z=1/12*t*(4*n.y*n.y+4*n.x*n.x))},o.prototype.getSideNormals=function(e,t){var i=e,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==t)for(var s=0;s!==i.length;s++)t.vmult(i[s],i[s]);return i},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var r=new n;new n,o.prototype.forEachWorldCorner=function(e,t,i){for(var n=this.halfExtents,s=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],o=0;o<s.length;o++)r.set(s[o][0],s[o][1],s[o][2]),t.vmult(r,r),e.vadd(r,r),i(r.x,r.y,r.z)};var a=[new n,new n,new n,new n,new n,new n,new n,new n];o.prototype.calculateWorldAABB=function(e,t,i,n){var s=this.halfExtents;a[0].set(s.x,s.y,s.z),a[1].set(-s.x,s.y,s.z),a[2].set(-s.x,-s.y,s.z),a[3].set(-s.x,-s.y,-s.z),a[4].set(s.x,-s.y,-s.z),a[5].set(s.x,s.y,-s.z),a[6].set(-s.x,s.y,-s.z),a[7].set(s.x,-s.y,s.z);var o=a[0];t.vmult(o,o),e.vadd(o,o),n.copy(o),i.copy(o);for(var r=1;r<8;r++){o=a[r],t.vmult(o,o),e.vadd(o,o);var c=o.x,l=o.y,h=o.z;c>n.x&&(n.x=c),l>n.y&&(n.y=l),h>n.z&&(n.z=h),c<i.x&&(i.x=c),l<i.y&&(i.y=l),h<i.z&&(i.z=h)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t){t.exports=o;var i=e("./Shape"),n=e("../math/Vec3"),s=(e("../math/Quaternion"),e("../math/Transform"));function o(e,t,n){i.call(this,{type:i.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=n?n.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}o.prototype=new i,o.prototype.constructor=o;var r=new n;o.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var n=r,s=0;s!==e.length;s++)for(var o=e[s],a=o.length,c=0;c!==a;c++){var l=(c+1)%a;t[o[c]].vsub(t[o[l]],n),n.normalize();for(var h=!1,u=0;u!==i.length;u++)if(i[u].almostEquals(n)||i[u].almostEquals(n)){h=!0;break}h||i.push(n.clone())}},o.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new n;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i}};var a=new n,c=new n;o.computeNormal=function(e,t,i,n){t.vsub(e,c),i.vsub(t,a),a.cross(c,n),n.isZero()||n.normalize()},o.prototype.getFaceNormal=function(e,t){var i=this.faces[e],n=this.vertices[i[0]],s=this.vertices[i[1]],r=this.vertices[i[2]];return o.computeNormal(n,s,r,t)};var l=new n;o.prototype.clipAgainstHull=function(e,t,i,s,o,r,a,c,h){for(var u=l,_=-1,p=-Number.MAX_VALUE,d=0;d<i.faces.length;d++){u.copy(i.faceNormals[d]),o.vmult(u,u);var f=u.dot(r);f>p&&(p=f,_=d)}for(var m=[],g=i.faces[_],v=g.length,y=0;y<v;y++){var x=i.vertices[g[y]],S=new n;S.copy(x),o.vmult(S,S),s.vadd(S,S),m.push(S)}_>=0&&this.clipFaceAgainstHull(r,e,t,m,a,c,h)};var h=new n,u=new n,_=new n,p=new n,d=new n,f=new n;o.prototype.findSeparatingAxis=function(e,t,i,n,s,o,r,a){var c=h,l=u,m=_,g=p,v=d,y=f,x=Number.MAX_VALUE,S=this;if(S.uniqueAxes)for(T=0;T!==S.uniqueAxes.length;T++){if(i.vmult(S.uniqueAxes[T],c),!1===(w=S.testSepAxis(c,e,t,i,n,s)))return!1;w<x&&(x=w,o.copy(c))}else for(var b=r?r.length:S.faces.length,T=0;T<b;T++){var E=r?r[T]:T;if(c.copy(S.faceNormals[E]),i.vmult(c,c),!1===(w=S.testSepAxis(c,e,t,i,n,s)))return!1;w<x&&(x=w,o.copy(c))}if(e.uniqueAxes)for(T=0;T!==e.uniqueAxes.length;T++){if(s.vmult(e.uniqueAxes[T],l),!1===(w=S.testSepAxis(l,e,t,i,n,s)))return!1;w<x&&(x=w,o.copy(l))}else{var C=a?a.length:e.faces.length;for(T=0;T<C;T++){var w;if(E=a?a[T]:T,l.copy(e.faceNormals[E]),s.vmult(l,l),!1===(w=S.testSepAxis(l,e,t,i,n,s)))return!1;w<x&&(x=w,o.copy(l))}}for(var A=0;A!==S.uniqueEdges.length;A++){i.vmult(S.uniqueEdges[A],g);for(var P=0;P!==e.uniqueEdges.length;P++)if(s.vmult(e.uniqueEdges[P],v),g.cross(v,y),!y.almostZero()){y.normalize();var R=S.testSepAxis(y,e,t,i,n,s);if(!1===R)return!1;R<x&&(x=R,o.copy(y))}}return n.vsub(t,m),m.dot(o)>0&&o.negate(o),!0};var m=[],g=[];o.prototype.testSepAxis=function(e,t,i,n,s,r){var a=this;o.project(a,e,i,n,m),o.project(t,e,s,r,g);var c=m[0],l=m[1],h=g[0],u=g[1];if(c<u||h<l)return!1;var _=c-u,p=h-l;return _<p?_:p};var v=new n,y=new n;o.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(v,y);var i=y.x-v.x,n=y.y-v.y,s=y.z-v.z;t.x=1/12*e*(4*n*n+4*s*s),t.y=1/12*e*(4*i*i+4*s*s),t.z=1/12*e*(4*n*n+4*i*i)},o.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],n=this.vertices[t[0]];return-i.dot(n)};var x=new n,S=new n,b=new n,T=new n,E=new n,C=new n,w=new n,A=new n;o.prototype.clipFaceAgainstHull=function(e,t,i,n,s,o,r){for(var a=x,c=S,l=b,h=T,u=E,_=C,p=w,d=A,f=this,m=n,g=[],v=-1,y=Number.MAX_VALUE,P=0;P<f.faces.length;P++){a.copy(f.faceNormals[P]),i.vmult(a,a);var R=a.dot(e);R<y&&(y=R,v=P)}if(!(v<0)){var I=f.faces[v];I.connectedFaces=[];for(var M=0;M<f.faces.length;M++)for(var O=0;O<f.faces[M].length;O++)-1!==I.indexOf(f.faces[M][O])&&M!==v&&-1===I.connectedFaces.indexOf(M)&&I.connectedFaces.push(M);m.length;for(var D=I.length,N=0;N<D;N++){var L=f.vertices[I[N]],B=f.vertices[I[(N+1)%D]];L.vsub(B,c),l.copy(c),i.vmult(l,l),t.vadd(l,l),h.copy(this.faceNormals[v]),i.vmult(h,h),t.vadd(h,h),l.cross(h,u),u.negate(u),_.copy(L),i.vmult(_,_),t.vadd(_,_),_.dot(u);var z=I.connectedFaces[N];p.copy(this.faceNormals[z]);var F=this.getPlaneConstantOfFace(z);d.copy(p),i.vmult(d,d);var U=F-d.dot(t);for(this.clipFaceAgainstPlane(m,g,d,U);m.length;)m.shift();for(;g.length;)m.push(g.shift())}for(p.copy(this.faceNormals[v]),F=this.getPlaneConstantOfFace(v),d.copy(p),i.vmult(d,d),U=F-d.dot(t),M=0;M<m.length;M++){var G=d.dot(m[M])+U;if(G<=s&&(G=s),G<=o){var k=m[M];if(G<=0){var H={point:k,normal:d,depth:G};r.push(H)}}}}},o.prototype.clipFaceAgainstPlane=function(e,t,i,s){var o,r,a=e.length;if(a<2)return t;var c=e[e.length-1],l=e[0];o=i.dot(c)+s;for(var h=0;h<a;h++){if(l=e[h],r=i.dot(l)+s,o<0)if(r<0)(u=new n).copy(l),t.push(u);else{var u=new n;c.lerp(l,o/(o-r),u),t.push(u)}else r<0&&(u=new n,c.lerp(l,o/(o-r),u),t.push(u),t.push(l));c=l,o=r}return t},o.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new n);for(var s=this.vertices,o=this.worldVertices,r=0;r!==i;r++)t.vmult(s[r],o[r]),e.vadd(o[r],o[r]);this.worldVerticesNeedsUpdate=!1},new n,o.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var s=0;s<i;s++){var o=n[s];o.x<e.x?e.x=o.x:o.x>t.x&&(t.x=o.x),o.y<e.y?e.y=o.y:o.y>t.y&&(t.y=o.y),o.z<e.z?e.z=o.z:o.z>t.z&&(t.z=o.z)}},o.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new n);for(var i=this.faceNormals,s=this.worldFaceNormals,o=0;o!==t;o++)e.vmult(i[o],s[o]);this.worldFaceNormalsNeedsUpdate=!1},o.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,n=t.length;i!==n;i++){var s=t[i].norm2();s>e&&(e=s)}this.boundingSphereRadius=Math.sqrt(e)};var P=new n;o.prototype.calculateWorldAABB=function(e,t,i,n){for(var s,o,r,a,c,l,h=this.vertices.length,u=this.vertices,_=0;_<h;_++){P.copy(u[_]),t.vmult(P,P),e.vadd(P,P);var p=P;(p.x<s||void 0===s)&&(s=p.x),(p.x>a||void 0===a)&&(a=p.x),(p.y<o||void 0===o)&&(o=p.y),(p.y>c||void 0===c)&&(c=p.y),(p.z<r||void 0===r)&&(r=p.z),(p.z>l||void 0===l)&&(l=p.z)}i.set(s,o,r),n.set(a,c,l)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.prototype.getAveragePointLocal=function(e){e=e||new n;for(var t=this.vertices.length,i=this.vertices,s=0;s<t;s++)e.vadd(i[s],e);return e.mult(1/t,e),e},o.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,n=this.vertices;if(t){for(var s=0;s<i;s++){var o=n[s];t.vmult(o,o)}for(s=0;s<this.faceNormals.length;s++)o=this.faceNormals[s],t.vmult(o,o)}if(e)for(s=0;s<i;s++)(o=n[s]).vadd(e,o)};var R=new n,I=new n,M=new n;o.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,n=this.faces,s=this.faceNormals,o=this.faces.length,r=R;this.getAveragePointLocal(r);for(var a=0;a<o;a++){this.faces[a].length,t=s[a];var c=i[n[a][0]],l=I;e.vsub(c,l);var h=t.dot(l),u=M;r.vsub(c,u);var _=t.dot(u);if(h<0&&_>0||h>0&&_<0)return!1}return-1},new n;var O=new n,D=new n;o.project=function(e,t,i,n,o){var r=e.vertices.length,a=O,c=0,l=0,h=D,u=e.vertices;h.setZero(),s.vectorToLocalFrame(i,n,t,a),s.pointToLocalFrame(i,n,h,h);var _=h.dot(a);l=c=u[0].dot(a);for(var p=1;p<r;p++){var d=u[p].dot(a);d>c&&(c=d),d<l&&(l=d)}if((l-=_)>(c-=_)){var f=l;l=c,c=f}o[0]=c,o[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t){t.exports=s,e("./Shape");var i=e("../math/Vec3"),n=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function s(e,t,s,o,r){if(r){for(var a=o,c=Math.cos,l=Math.sin,h=s/2,u=[],_=[],p=[0],d=[1],f=[],m=2*Math.PI/a,g=0;g<a;g++)u.push(new i(e*c(m*g),h,e*l(m*g))),u.push(new i(e*c(m*g),-h,e*l(m*g))),g<a-1?(_.push([2*g+2,2*g+3,2*g+1,2*g]),p.push(2*g+2),d.push(2*g+3)):_.push([0,1,2*g+1,2*g]),(a%2==1||g<a/2)&&f.push(new i(c(m*(g+.5)),0,l(m*(g+.5))));_.push(d);var v=[];for(g=0;g<p.length;g++)v.push(p[p.length-g-1]);return _.push(v),f.push(new i(0,1,0)),void n.call(this,u,_,f)}a=o;var y=[],x=(f=[],[]),S=[],b=[];for(c=Math.cos,l=Math.sin,y.push(new i(t*c(0),t*l(0),.5*-s)),S.push(0),y.push(new i(e*c(0),e*l(0),.5*s)),b.push(1),g=0;g<a;g++){m=2*Math.PI/a*(g+1);var T=2*Math.PI/a*(g+.5);g<a-1?(y.push(new i(t*c(m),t*l(m),.5*-s)),S.push(2*g+2),y.push(new i(e*c(m),e*l(m),.5*s)),b.push(2*g+3),x.push([2*g+2,2*g+3,2*g+1,2*g])):x.push([0,1,2*g+1,2*g]),(a%2==1||g<a/2)&&f.push(new i(c(T),l(T),0))}for(x.push(b),f.push(new i(0,0,1)),v=[],g=0;g<S.length;g++)v.push(S[S.length-g-1]);x.push(v),n.call(this,y,x,f)}s.prototype=new n},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t){var i=e("./Shape"),n=e("./ConvexPolyhedron"),s=e("../math/Vec3"),o=e("../utils/Utils");function r(e,t){t=o.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,i.call(this,{type:i.types.HEIGHTFIELD}),this.pillarConvex=new n,this.pillarOffset=new s,this.updateBoundingSphereRadius(),this._cachedPillars={}}t.exports=r,r.prototype=new i,r.prototype.update=function(){this._cachedPillars={}},r.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var s=e[i][n];s<t&&(t=s)}this.minValue=t},r.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var s=e[i][n];s>t&&(t=s)}this.maxValue=t},r.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),t>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},r.prototype.getRectMinMax=function(e,t,i,n,s){s=s||[];for(var o=this.data,r=this.minValue,a=e;a<=i;a++)for(var c=t;c<=n;c++){var l=o[a][c];l>r&&(r=l)}s[0]=this.minValue,s[1]=r},r.prototype.getIndexOfPosition=function(e,t,i,n){var s=this.elementSize,o=this.data,r=Math.floor(e/s),a=Math.floor(t/s);return i[0]=r,i[1]=a,n&&(r<0&&(r=0),a<0&&(a=0),r>=o.length-1&&(r=o.length-1),a>=o[0].length-1&&(a=o[0].length-1)),!(r<0||a<0||r>=o.length-1||a>=o[0].length-1)};var a=[],c=new s,l=new s,h=new s,u=new s;r.prototype.getTriangleAt=function(e,t,i,n,s,o){var r=a;this.getIndexOfPosition(e,t,r,i);var c=r[0],l=r[1],h=this.data;i&&(c=Math.min(h.length-2,Math.max(0,c)),l=Math.min(h[0].length-2,Math.max(0,l)));var u=this.elementSize,_=Math.pow(e/u-c,2)+Math.pow(t/u-l,2)>Math.pow(e/u-(c+1),2)+Math.pow(t/u-(l+1),2);return this.getTriangle(c,l,_,n,s,o),_};var _=new s,p=new s,d=new s,f=new s,m=new s;function g(e,t,i,n,s,o,r,a,c){c.x=((o-a)*(e-r)+(r-s)*(t-a))/((o-a)*(i-r)+(r-s)*(n-a)),c.y=((a-n)*(e-r)+(i-r)*(t-a))/((o-a)*(i-r)+(r-s)*(n-a)),c.z=1-c.x-c.y}r.prototype.getNormalAt=function(e,t,i,n){var s=_,o=p,r=d,a=f,c=m;this.getTriangleAt(e,t,i,s,o,r),o.vsub(s,a),r.vsub(s,c),a.cross(c,n),n.normalize()},r.prototype.getAabbAtIndex=function(e,t,i){var n=this.data,s=this.elementSize;i.lowerBound.set(e*s,t*s,n[e][t]),i.upperBound.set((e+1)*s,(t+1)*s,n[e+1][t+1])},r.prototype.getHeightAt=function(e,t,i){var n=this.data,s=l,o=h,r=u,_=a;this.getIndexOfPosition(e,t,_,i);var p=_[0],d=_[1];i&&(p=Math.min(n.length-2,Math.max(0,p)),d=Math.min(n[0].length-2,Math.max(0,d)));var f=this.getTriangleAt(e,t,i,s,o,r);g(e,t,s.x,s.y,o.x,o.y,r.x,r.y,c);var m=c;return f?n[p+1][d+1]*m.x+n[p][d+1]*m.y+n[p+1][d]*m.z:n[p][d]*m.x+n[p+1][d]*m.y+n[p][d+1]*m.z},r.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},r.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},r.prototype.setCachedConvexTrianglePillar=function(e,t,i,n,s){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:n,offset:s}},r.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},r.prototype.getTriangle=function(e,t,i,n,s,o){var r=this.data,a=this.elementSize;i?(n.set((e+1)*a,(t+1)*a,r[e+1][t+1]),s.set(e*a,(t+1)*a,r[e][t+1]),o.set((e+1)*a,t*a,r[e+1][t])):(n.set(e*a,t*a,r[e][t]),s.set((e+1)*a,t*a,r[e+1][t]),o.set(e*a,(t+1)*a,r[e][t+1]))},r.prototype.getConvexTrianglePillar=function(e,t,i){var o=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){if(a=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=a.convex,void(this.pillarOffset=a.offset);o=new n,r=new s,this.pillarConvex=o,this.pillarOffset=r}var a=this.data,c=this.elementSize,l=o.faces;o.vertices.length=6;for(var h=0;h<6;h++)o.vertices[h]||(o.vertices[h]=new s);for(l.length=5,h=0;h<5;h++)l[h]||(l[h]=[]);var u=o.vertices,_=(Math.min(a[e][t],a[e+1][t],a[e][t+1],a[e+1][t+1])-this.minValue)/2+this.minValue;i?(r.set((e+.75)*c,(t+.75)*c,_),u[0].set(.25*c,.25*c,a[e+1][t+1]-_),u[1].set(-.75*c,.25*c,a[e][t+1]-_),u[2].set(.25*c,-.75*c,a[e+1][t]-_),u[3].set(.25*c,.25*c,-_-1),u[4].set(-.75*c,.25*c,-_-1),u[5].set(.25*c,-.75*c,-_-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(r.set((e+.25)*c,(t+.25)*c,_),u[0].set(-.25*c,-.25*c,a[e][t]-_),u[1].set(.75*c,-.25*c,a[e+1][t]-_),u[2].set(-.25*c,.75*c,a[e][t+1]-_),u[3].set(-.25*c,-.25*c,-_-1),u[4].set(.75*c,-.25*c,-_-1),u[5].set(-.25*c,.75*c,-_-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,o,r)},r.prototype.calculateLocalInertia=function(e,t){return(t=t||new s).set(0,0,0),t},r.prototype.volume=function(){return Number.MAX_VALUE},r.prototype.calculateWorldAABB=function(e,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},r.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new s(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},r.prototype.setHeightsFromImage=function(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var n=i.getContext("2d");n.drawImage(e,0,0);var s=n.getImageData(0,0,e.width,e.height),o=this.data;o.length=0,this.elementSize=Math.abs(t.x)/s.width;for(var r=0;r<s.height;r++){for(var a=[],c=0;c<s.width;c++){var l=(s.data[4*(r*s.height+c)]+s.data[4*(r*s.height+c)+1]+s.data[4*(r*s.height+c)+2])/4/255*t.z;t.x<0?a.push(l):a.unshift(l)}t.y<0?o.unshift(a):o.push(a)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t){t.exports=s;var i=e("./Shape"),n=e("../math/Vec3");function s(){i.call(this,{type:i.types.PARTICLE})}s.prototype=new i,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(e,t){return(t=t||new n).set(0,0,0),t},s.prototype.volume=function(){return 0},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},s.prototype.calculateWorldAABB=function(e,t,i,n){i.copy(e),n.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t){t.exports=s;var i=e("./Shape"),n=e("../math/Vec3");function s(){i.call(this,{type:i.types.PLANE}),this.worldNormal=new n,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}s.prototype=new i,s.prototype.constructor=s,s.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},s.prototype.calculateLocalInertia=function(e,t){return t||new n},s.prototype.volume=function(){return Number.MAX_VALUE};var o=new n;s.prototype.calculateWorldAABB=function(e,t,i,n){o.set(0,0,1),t.vmult(o,o);var s=Number.MAX_VALUE;i.set(-s,-s,-s),n.set(s,s,s),1===o.x&&(n.x=e.x),1===o.y&&(n.y=e.y),1===o.z&&(n.z=e.z),-1===o.x&&(i.x=e.x),-1===o.y&&(i.y=e.y),-1===o.z&&(i.z=e.z)},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t){t.exports=n;var i=e("../utils/EventTarget"),n=e("./Shape");function n(e){e=e||{},i.apply(this),this.id=n.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),n.prototype=new i,n.prototype.constructor=n,n.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},n.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},n.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},n.idCounter=0,n.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t){t.exports=s;var i=e("./Shape"),n=e("../math/Vec3");function s(e){if(i.call(this,{type:i.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}s.prototype=new i,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(e,t){t=t||new n;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},s.prototype.volume=function(){return 4*Math.PI*this.radius/3},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},s.prototype.calculateWorldAABB=function(e,t,i,n){for(var s=this.radius,o=["x","y","z"],r=0;r<o.length;r++){var a=o[r];i[a]=e[a]-s,n[a]=e[a]+s}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t){t.exports=a;var i=e("./Shape"),n=e("../math/Vec3"),s=(e("../math/Quaternion"),e("../math/Transform")),o=e("../collision/AABB"),r=e("../utils/Octree");function a(e,t){i.call(this,{type:i.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new o,this.edges=null,this.scale=new n(1,1,1),this.tree=new r,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}a.prototype=new i,a.prototype.constructor=a;var c=new n;a.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new o,s=new n,r=new n,a=new n,c=[s,r,a],l=0;l<this.indices.length/3;l++){var h=3*l;this._getUnscaledVertex(this.indices[h],s),this._getUnscaledVertex(this.indices[h+1],r),this._getUnscaledVertex(this.indices[h+2],a),i.setFromPoints(c),e.insert(i,l)}e.removeEmptyNodes()};var l=new o;a.prototype.getTrianglesInAABB=function(e,t){l.copy(e);var i=this.scale,n=i.x,s=i.y,o=i.z,r=l.lowerBound,a=l.upperBound;return r.x/=n,r.y/=s,r.z/=o,a.x/=n,a.y/=s,a.z/=o,this.tree.aabbQuery(l,t)},a.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},a.prototype.updateNormals=function(){for(var e=c,t=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,s=this.indices[n],o=this.indices[n+1],r=this.indices[n+2];this.getVertex(s,d),this.getVertex(o,f),this.getVertex(r,m),a.computeNormal(f,d,m,e),t[n]=e.x,t[n+1]=e.y,t[n+2]=e.z}},a.prototype.updateEdges=function(){for(var e={},t=function(){e[s<o?s+"_"+o:o+"_"+s]=!0},i=0;i<this.indices.length/3;i++){var n=3*i,s=this.indices[n],o=this.indices[n+1];this.indices[n+2],t(),t(),t()}var r=Object.keys(e);for(this.edges=new Int16Array(2*r.length),i=0;i<r.length;i++){var a=r[i].split("_");this.edges[2*i]=parseInt(a[0],10),this.edges[2*i+1]=parseInt(a[1],10)}},a.prototype.getEdgeVertex=function(e,t,i){var n=this.edges[2*e+(t?1:0)];this.getVertex(n,i)};var h=new n,u=new n;a.prototype.getEdgeVector=function(e,t){var i=h,n=u;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,n),n.vsub(i,t)};var _=new n,p=new n;a.computeNormal=function(e,t,i,n){t.vsub(e,p),i.vsub(t,_),_.cross(p,n),n.isZero()||n.normalize()};var d=new n,f=new n,m=new n;a.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},a.prototype._getUnscaledVertex=function(e,t){var i=3*e,n=this.vertices;return t.set(n[i],n[i+1],n[i+2])},a.prototype.getWorldVertex=function(e,t,i,n){return this.getVertex(e,n),s.pointToWorldFrame(t,i,n,n),n},a.prototype.getTriangleVertices=function(e,t,i,n){var s=3*e;this.getVertex(this.indices[s],t),this.getVertex(this.indices[s+1],i),this.getVertex(this.indices[s+2],n)},a.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[i+1],this.normals[i+2])};var g=new o;a.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(g);var i=g.upperBound.x-g.lowerBound.x,n=g.upperBound.y-g.lowerBound.y,s=g.upperBound.z-g.lowerBound.z;return t.set(1/12*e*(4*n*n+4*s*s),1/12*e*(4*i*i+4*s*s),1/12*e*(4*n*n+4*i*i))};var v=new n;a.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,n=this.vertices.length/3,s=v;if(0!==n){this.getVertex(0,s),t.copy(s),i.copy(s);for(var o=0;o!==n;o++)this.getVertex(o,s),s.x<t.x?t.x=s.x:s.x>i.x&&(i.x=s.x),s.y<t.y?t.y=s.y:s.y>i.y&&(i.y=s.y),s.z<t.z?t.z=s.z:s.z>i.z&&(i.z=s.z)}},a.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},a.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new n,s=0,o=t.length/3;s!==o;s++){this.getVertex(s,i);var r=i.norm2();r>e&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)},new n;var y=new s,x=new o;a.prototype.calculateWorldAABB=function(e,t,i,n){var s=y,o=x;s.position=e,s.quaternion=t,this.aabb.toWorldFrame(s,o),i.copy(o.lowerBound),n.copy(o.upperBound)},a.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},a.createTorus=function(e,t,i,n,s){e=e||1,t=t||.5,i=i||8,n=n||6,s=s||2*Math.PI;for(var o=[],r=[],c=0;c<=i;c++)for(var l=0;l<=n;l++){var h=l/n*s,u=c/i*Math.PI*2,_=(e+t*Math.cos(u))*Math.cos(h),p=(e+t*Math.cos(u))*Math.sin(h),d=t*Math.sin(u);o.push(_,p,d)}for(c=1;c<=i;c++)for(l=1;l<=n;l++){var f=(n+1)*c+l-1,m=(n+1)*(c-1)+l-1,g=(n+1)*(c-1)+l,v=(n+1)*c+l;r.push(f,m,v),r.push(m,g,v)}return new a(o,r)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t){t.exports=n,e("../math/Vec3"),e("../math/Quaternion");var i=e("./Solver");function n(){i.call(this),this.iterations=10,this.tolerance=1e-7}n.prototype=new i;var s=[],o=[],r=[];n.prototype.solve=function(e,t){var i,n,a,c,l,h=0,u=this.iterations,_=this.tolerance*this.tolerance,p=this.equations,d=p.length,f=t.bodies,m=f.length,g=e;if(0!==d)for(var v=0;v!==m;v++)f[v].updateSolveMassProperties();var y=o,x=r,S=s;for(y.length=d,x.length=d,S.length=d,v=0;v!==d;v++){var b=p[v];S[v]=0,x[v]=b.computeB(g),y[v]=1/b.computeC()}if(0!==d){for(v=0;v!==m;v++){var T=(w=f[v]).vlambda,E=w.wlambda;T.set(0,0,0),E.set(0,0,0)}for(h=0;h!==u;h++){c=0;for(var C=0;C!==d;C++)b=p[C],i=x[C],n=y[C],(l=S[C])+(a=n*(i-b.computeGWlambda()-b.eps*l))<b.minForce?a=b.minForce-l:l+a>b.maxForce&&(a=b.maxForce-l),S[C]+=a,c+=a>0?a:-a,b.addToWlambda(a);if(c*c<_)break}for(v=0;v!==m;v++){var w,A=(w=f[v]).velocity,P=w.angularVelocity;w.vlambda.vmul(w.linearFactor,w.vlambda),A.vadd(w.vlambda,A),w.wlambda.vmul(w.angularFactor,w.wlambda),P.vadd(w.wlambda,P)}for(var R=p.length,I=1/g;R--;)p[R].multiplier=S[R]*I}return h}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t){function i(){this.equations=[]}t.exports=i,i.prototype.solve=function(){return 0},i.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},i.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)},i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t){t.exports=s,e("../math/Vec3"),e("../math/Quaternion");var i=e("./Solver"),n=e("../objects/Body");function s(e){for(i.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}s.prototype=new i;var o=[],r=[],a={bodies:[]},c=n.STATIC;function l(e){for(var t=e.length,i=0;i!==t;i++){var n=e[i];if(!(n.visited||n.body.type&c))return n}return!1}var h=[];function u(e,t,i,n){for(h.push(e),e.visited=!0,t(e,i,n);h.length;)for(var s,o=h.pop();s=l(o.children);)s.visited=!0,t(s,i,n),h.push(s)}function _(e,t,i){t.push(e.body);for(var n=e.eqs.length,s=0;s!==n;s++){var o=e.eqs[s];-1===i.indexOf(o)&&i.push(o)}}function p(e,t){return t.id-e.id}s.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},s.prototype.solve=function(e,t){for(var i=o,n=this.nodePool,s=t.bodies,c=this.equations,h=c.length,d=s.length,f=this.subsolver;n.length<d;)n.push(this.createNode());i.length=d;for(var m=0;m<d;m++)i[m]=n[m];for(m=0;m!==d;m++){var g=i[m];g.body=s[m],g.children.length=0,g.eqs.length=0,g.visited=!1}for(var v=0;v!==h;v++){var y=c[v],x=(m=s.indexOf(y.bi),s.indexOf(y.bj)),S=i[m],b=i[x];S.children.push(b),S.eqs.push(y),b.children.push(S),b.eqs.push(y)}var T,E=0,C=r;f.tolerance=this.tolerance,f.iterations=this.iterations;for(var w=a;T=l(i);){C.length=0,w.bodies.length=0,u(T,_,w.bodies,C);var A=C.length;for(C=C.sort(p),m=0;m!==A;m++)f.addEquation(C[m]);f.solve(e,w),f.removeAllEquations(),E++}return E}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t){var i=function(){};t.exports=i,i.prototype={constructor:i,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var n=i[e].indexOf(t);return-1!==n&&i[e].splice(n,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,n=t.length;i<n;i++)t[i].call(this,e)}return this}}},{}],51:[function(e,t){var i=e("../collision/AABB"),n=e("../math/Vec3");function s(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new i,this.data=[],this.children=[]}function o(e,t){(t=t||{}).root=null,t.aabb=e,s.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}t.exports=o,o.prototype=new s,s.prototype.reset=function(){this.children.length=this.data.length=0},s.prototype.insert=function(e,t,i){var n=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var s=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var o=!1;s.length||(this.subdivide(),o=!0);for(var r=0;8!==r;r++)if(s[r].insert(e,t,i+1))return!0;o&&(s.length=0)}return n.push(t),!0};var r=new n;s.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,o=e.upperBound,a=this.children;a.push(new s({aabb:new i({lowerBound:new n(0,0,0)})}),new s({aabb:new i({lowerBound:new n(1,0,0)})}),new s({aabb:new i({lowerBound:new n(1,1,0)})}),new s({aabb:new i({lowerBound:new n(1,1,1)})}),new s({aabb:new i({lowerBound:new n(0,1,1)})}),new s({aabb:new i({lowerBound:new n(0,0,1)})}),new s({aabb:new i({lowerBound:new n(1,0,1)})}),new s({aabb:new i({lowerBound:new n(0,1,0)})})),o.vsub(t,r),r.scale(.5,r);for(var c=this.root||this,l=0;8!==l;l++){var h=a[l];h.root=c;var u=h.aabb.lowerBound;u.x*=r.x,u.y*=r.y,u.z*=r.z,u.vadd(t,u),u.vadd(r,h.aabb.upperBound)}},s.prototype.aabbQuery=function(e,t){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(e)&&Array.prototype.push.apply(t,n.data),Array.prototype.push.apply(i,n.children)}return t};var a=new i;s.prototype.rayQuery=function(e,t,i){return e.getAABB(a),a.toLocalFrame(t,a),this.aabbQuery(a,i),i},s.prototype.removeEmptyNodes=function(){for(var e=this.children.length-1;e>=0;e--)this.children[e].removeEmptyNodes(),this.children[e].children.length||this.children[e].data.length||this.children.splice(e,1)}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t){function i(){this.objects=[],this.type=Object}t.exports=i,i.prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},i.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},i.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},i.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t){function i(){this.data={keys:[]}}t.exports=i,i.prototype.get=function(e,t){if(e>t){var i=t;t=e,e=i}return this.data[e+"-"+t]},i.prototype.set=function(e,t,i){if(e>t){var n=t;t=e,e=n}var s=e+"-"+t;return this.get(e,t)||this.data.keys.push(s),this.data[s]=i,this.data[s]},i.prototype.del=function(e,t){if(e>t){var i=t;t=e,e=i}var n=e+"-"+t,s=this.data.keys.indexOf(n);return s>=0&&(this.data.keys.splice(s,1),delete this.data[n],!0)},i.prototype.reset=function(){this.data={keys:[]}},i.prototype.getLength=function(){return this.data.keys.length},i.prototype.getKeyByIndex=function(e){return this.data.keys[e]},i.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t){function i(){}t.exports=i,i.defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],55:[function(e,t){t.exports=s;var i=e("../math/Vec3"),n=e("./Pool");function s(){n.call(this),this.type=i}s.prototype=new n,s.prototype.constructObject=function(){return new i}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t){t.exports=u;var i=e("../collision/AABB"),n=(e("../objects/Body"),e("../shapes/Shape")),s=e("../collision/Ray"),o=e("../math/Vec3"),r=e("../math/Transform"),a=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),c=(e("../solver/Solver"),e("../utils/Vec3Pool")),l=e("../equations/ContactEquation"),h=e("../equations/FrictionEquation");function u(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}u.prototype.createContactEquation=function(e,t,i,n,s,o){var r;this.contactPointPool.length?((r=this.contactPointPool.pop()).bi=e,r.bj=t):r=new l(e,t),r.enabled=e.collisionResponse&&t.collisionResponse&&i.collisionResponse&&n.collisionResponse;var a=this.currentContactMaterial,c=a.contactEquationRelaxation;r.restitution=a.restitution;var h=i.material||e.material,u=n.material||t.material;if(h&&u){h.restitution>=0&&u.restitution>=0&&(r.restitution=h.restitution*u.restitution);var _=h.correctInelastic||u.correctInelastic;_&&(c*=_)}return r.setSpookParams(a.contactEquationStiffness,c,this.world.dt),r.si=s||i,r.sj=o||n,r},u.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,n=e.bj,s=e.si,o=e.sj,r=this.world,a=this.currentContactMaterial,c=a.friction,l=s.material||i.material,u=o.material||n.material;if(l&&u&&l.friction>=0&&u.friction>=0&&(c=l.friction*u.friction),c>0){var _=c*r.gravity.length(),p=i.invMass+n.invMass;p>0&&(p=1/p);var d=this.frictionEquationPool,f=d.length?d.pop():new h(i,n,_*p),m=d.length?d.pop():new h(i,n,_*p);return f.bi=m.bi=i,f.bj=m.bj=n,f.minForce=m.minForce=-_*p,f.maxForce=m.maxForce=_*p,f.ri.copy(e.ri),f.rj.copy(e.rj),m.ri.copy(e.ri),m.rj.copy(e.rj),e.ni.tangents(f.t,m.t),f.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),m.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),f.enabled=m.enabled=e.enabled,t.push(f,m),!0}return!1};var _=new o,p=new o,d=new o;u.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];_.setZero(),p.setZero(),d.setZero();for(var s=t.bi,o=(t.bj,0);o!==e;o++)(t=this.result[this.result.length-1-o]).bodyA!==s?(_.vadd(t.ni,_),p.vadd(t.ri,p),d.vadd(t.rj,d)):(_.vsub(t.ni,_),p.vadd(t.rj,p),d.vadd(t.ri,d));var r=1/e;p.scale(r,i.ri),d.scale(r,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),_.normalize(),_.tangents(i.t,n.t)}};var f=new o,m=new o,g=new a,v=new a;u.prototype.getContacts=function(e,t,i,n,s,o,r){this.contactPointPool=s,this.frictionEquationPool=r,this.result=n,this.frictionResult=o;for(var a=g,c=v,l=f,h=m,u=0,_=e.length;u!==_;u++){var p=e[u],d=t[u],y=null;p.material&&d.material&&(y=i.getContactMaterial(p.material,d.material)||null);for(var x=0==p.collisionResponse||0==d.collisionResponse,S=0;S<p.shapes.length;S++){p.quaternion.mult(p.shapeOrientations[S],a),p.quaternion.vmult(p.shapeOffsets[S],l),l.vadd(p.position,l);for(var b=p.shapes[S],T=0;T<d.shapes.length;T++){d.quaternion.mult(d.shapeOrientations[T],c),d.quaternion.vmult(d.shapeOffsets[T],h),h.vadd(d.position,h);var E=d.shapes[T];if(b.collisionFilterMask&E.collisionFilterGroup&&E.collisionFilterMask&b.collisionFilterGroup&&!(l.distanceTo(h)>b.boundingSphereRadius+E.boundingSphereRadius)){x|=0==b.collisionResponse||0==E.collisionResponse;var C=null;b.material&&E.material&&(C=i.getContactMaterial(b.material,E.material)||null),this.currentContactMaterial=C||y||i.defaultContactMaterial;var w=this[b.type|E.type];if(w&&(b.type<E.type?w.call(this,b,E,l,h,a,c,p,d,b,E,x):w.call(this,E,b,h,l,c,a,d,p,b,E,x))&&x){i.shapeOverlapKeeper.set(b.id,E.id),i.bodyOverlapKeeper.set(p.id,d.id);var A={si:b,sj:E};i.triggerDic.set(b.id,E.id,A),i.oldTriggerDic.set(b.id,E.id,A)}}}}}},u.prototype[n.types.BOX|n.types.BOX]=u.prototype.boxBox=function(e,t,i,n,s,o,r,a,c,l,h){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,n,s,o,r,a,e,t,h)},u.prototype[n.types.BOX|n.types.CONVEXPOLYHEDRON]=u.prototype.boxConvex=function(e,t,i,n,s,o,r,a,c,l,h){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,n,s,o,r,a,e,t,h)},u.prototype[n.types.BOX|n.types.PARTICLE]=u.prototype.boxParticle=function(e,t,i,n,s,o,r,a,c,l,h){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,n,s,o,r,a,e,t,h)},u.prototype[n.types.SPHERE]=u.prototype.sphereSphere=function(e,t,i,n,s,o,r,a,c,l,h){if(h)return i.distanceSquared(n)<Math.pow(e.radius+t.radius,2);var u=this.createContactEquation(r,a,e,t,c,l);n.vsub(i,u.ni),u.ni.normalize(),u.ri.copy(u.ni),u.rj.copy(u.ni),u.ri.mult(e.radius,u.ri),u.rj.mult(-t.radius,u.rj),u.ri.vadd(i,u.ri),u.ri.vsub(r.position,u.ri),u.rj.vadd(n,u.rj),u.rj.vsub(a.position,u.rj),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)};var y=new o,x=new o,S=new o;u.prototype[n.types.PLANE|n.types.TRIMESH]=u.prototype.planeTrimesh=function(e,t,i,n,s,a,c,l,h,u,_){var p=new o,d=y;d.set(0,0,1),s.vmult(d,d);for(var f=0;f<t.vertices.length/3;f++){t.getVertex(f,p);var m=new o;m.copy(p),r.pointToWorldFrame(n,a,m,p);var g=x;if(p.vsub(i,g),d.dot(g)<=0){if(_)return!0;var v=this.createContactEquation(c,l,e,t,h,u);v.ni.copy(d);var b=S;d.scale(g.dot(d),b),p.vsub(b,b),v.ri.copy(b),v.ri.vsub(c.position,v.ri),v.rj.copy(p),v.rj.vsub(l.position,v.rj),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}};var b=new o,T=new o,E=(new o,new o),C=new o,w=new o,A=new o,P=new o,R=new o,I=new o,M=new o,O=new o,D=new o,N=new o,L=new i,B=[];u.prototype[n.types.SPHERE|n.types.TRIMESH]=u.prototype.sphereTrimesh=function(e,t,i,n,o,a,c,l,h,u,_){var p=w,d=A,f=P,m=R,g=I,v=M,y=L,x=C,S=T,z=B;r.pointToLocalFrame(n,a,i,g);var F=e.radius;y.lowerBound.set(g.x-F,g.y-F,g.z-F),y.upperBound.set(g.x+F,g.y+F,g.z+F),t.getTrianglesInAABB(y,z);for(var U=E,G=e.radius*e.radius,k=0;k<z.length;k++)for(var H=0;H<3;H++)if(t.getVertex(t.indices[3*z[k]+H],U),U.vsub(g,S),S.norm2()<=G){if(x.copy(U),r.pointToWorldFrame(n,a,x,U),U.vsub(i,S),_)return!0;(W=this.createContactEquation(c,l,e,t,h,u)).ni.copy(S),W.ni.normalize(),W.ri.copy(W.ni),W.ri.scale(e.radius,W.ri),W.ri.vadd(i,W.ri),W.ri.vsub(c.position,W.ri),W.rj.copy(U),W.rj.vsub(l.position,W.rj),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}for(k=0;k<z.length;k++)for(H=0;H<3;H++){t.getVertex(t.indices[3*z[k]+H],p),t.getVertex(t.indices[3*z[k]+(H+1)%3],d),d.vsub(p,f),g.vsub(d,v);var V=v.dot(f);g.vsub(p,v);var j=v.dot(f);if(j>0&&V<0&&(g.vsub(p,v),m.copy(f),m.normalize(),j=v.dot(m),m.scale(j,v),v.vadd(p,v),(Q=v.distanceTo(g))<e.radius)){if(_)return!0;var W=this.createContactEquation(c,l,e,t,h,u);v.vsub(g,W.ni),W.ni.normalize(),W.ni.scale(e.radius,W.ri),r.pointToWorldFrame(n,a,v,v),v.vsub(l.position,W.rj),r.vectorToWorldFrame(a,W.ni,W.ni),r.vectorToWorldFrame(a,W.ri,W.ri),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}}for(var q=O,X=D,Y=N,K=b,$=(k=0,z.length);k!==$;k++){t.getTriangleVertices(z[k],q,X,Y),t.getNormal(z[k],K),g.vsub(q,v);var Q=v.dot(K);if(K.scale(Q,v),g.vsub(v,v),Q=v.distanceTo(g),s.pointInTriangle(v,q,X,Y)&&Q<e.radius){if(_)return!0;W=this.createContactEquation(c,l,e,t,h,u),v.vsub(g,W.ni),W.ni.normalize(),W.ni.scale(e.radius,W.ri),r.pointToWorldFrame(n,a,v,v),v.vsub(l.position,W.rj),r.vectorToWorldFrame(a,W.ni,W.ni),r.vectorToWorldFrame(a,W.ri,W.ri),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}}z.length=0};var z=new o,F=new o,U=new o,G=new o,k=new o;u.prototype[n.types.SPHERE|n.types.PLANE]=u.prototype.spherePlane=function(e,t,i,n,s,o,r,a,c,l,h){if(U.set(0,0,1),o.vmult(U,U),U.negate(U),U.normalize(),U.mult(e.radius,G),i.vsub(n,z),U.mult(U.dot(z),F),z.vsub(F,k),-z.dot(U)<=e.radius){if(h)return!0;var u=this.createContactEquation(r,a,e,t,c,l);u.ni.copy(U),u.ri.copy(G),u.rj.copy(k);var _=u.ri,p=u.rj;_.vadd(i,_),_.vsub(r.position,_),p.vadd(n,p),p.vsub(a.position,p),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}return!1};var H=new o,V=new o,j=new o;function W(e,t,i){for(var n=null,s=e.length,o=0;o!==s;o++){var r=e[o],a=H;e[(o+1)%s].vsub(r,a);var c=V;a.cross(t,c);var l=j;i.vsub(r,l);var h=c.dot(l);if(!(null===n||h>0&&!0===n||h<=0&&!1===n))return!1;null===n&&(n=h>0)}return!0}var q=new o,X=new o,Y=new o,K=new o,$=[new o,new o,new o,new o,new o,new o],Q=new o,Z=new o,J=new o,ee=new o;u.prototype[n.types.SPHERE|n.types.BOX]=u.prototype.sphereBox=function(e,t,i,n,s,o,r,a,c,l,h){var u=this.v3pool,_=$;i.vsub(n,q),t.getSideNormals(_,o);for(var p=e.radius,d=!1,f=Z,m=J,g=ee,v=null,y=0,x=0,S=0,b=null,T=0,E=_.length;T!==E&&!1===d;T++){var C=X;C.copy(_[T]);var w=C.norm();C.normalize();var A=q.dot(C);if(A<w+p&&A>0){var P=Y,R=K;P.copy(_[(T+1)%3]),R.copy(_[(T+2)%3]);var I=P.norm(),M=R.norm();P.normalize(),R.normalize();var O=q.dot(P),D=q.dot(R);if(O<I&&O>-I&&D<M&&D>-M){var N=Math.abs(A-w-p);if((null===b||N<b)&&(b=N,x=O,S=D,v=w,f.copy(C),m.copy(P),g.copy(R),y++,h))return!0}}}if(y){d=!0;var L=this.createContactEquation(r,a,e,t,c,l);f.mult(-p,L.ri),L.ni.copy(f),L.ni.negate(L.ni),f.mult(v,f),m.mult(x,m),f.vadd(m,f),g.mult(S,g),f.vadd(g,L.rj),L.ri.vadd(i,L.ri),L.ri.vsub(r.position,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(a.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var B=u.get(),z=Q,F=0;2!==F&&!d;F++)for(var U=0;2!==U&&!d;U++)for(var G=0;2!==G&&!d;G++)if(B.set(0,0,0),F?B.vadd(_[0],B):B.vsub(_[0],B),U?B.vadd(_[1],B):B.vsub(_[1],B),G?B.vadd(_[2],B):B.vsub(_[2],B),n.vadd(B,z),z.vsub(i,z),z.norm2()<p*p){if(h)return!0;d=!0,(L=this.createContactEquation(r,a,e,t,c,l)).ri.copy(z),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(p,L.ri),L.rj.copy(B),L.ri.vadd(i,L.ri),L.ri.vsub(r.position,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(a.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}u.release(B),B=null;var k=u.get(),H=u.get(),V=(L=u.get(),u.get()),j=(N=u.get(),_.length);for(F=0;F!==j&&!d;F++)for(U=0;U!==j&&!d;U++)if(F%3!=U%3){_[U].cross(_[F],k),k.normalize(),_[F].vadd(_[U],H),L.copy(i),L.vsub(H,L),L.vsub(n,L);var W=L.dot(k);for(k.mult(W,V),G=0;G===F%3||G===U%3;)G++;N.copy(i),N.vsub(V,N),N.vsub(H,N),N.vsub(n,N);var te=Math.abs(W),ie=N.norm();if(te<_[G].norm()&&ie<p){if(h)return!0;d=!0;var ne=this.createContactEquation(r,a,e,t,c,l);H.vadd(V,ne.rj),ne.rj.copy(ne.rj),N.negate(ne.ni),ne.ni.normalize(),ne.ri.copy(ne.rj),ne.ri.vadd(n,ne.ri),ne.ri.vsub(i,ne.ri),ne.ri.normalize(),ne.ri.mult(p,ne.ri),ne.ri.vadd(i,ne.ri),ne.ri.vsub(r.position,ne.ri),ne.rj.vadd(n,ne.rj),ne.rj.vsub(a.position,ne.rj),this.result.push(ne),this.createFrictionEquationsFromContact(ne,this.frictionResult)}}u.release(k,H,L,V,N)};var te=new o,ie=new o,ne=new o,se=new o,oe=new o,re=new o,ae=new o,ce=new o,le=new o,he=new o;u.prototype[n.types.SPHERE|n.types.CONVEXPOLYHEDRON]=u.prototype.sphereConvex=function(e,t,i,n,s,o,r,a,c,l,h){var u=this.v3pool;i.vsub(n,te);for(var _=t.faceNormals,p=t.faces,d=t.vertices,f=e.radius,m=0;m!==d.length;m++){var g=d[m],v=oe;o.vmult(g,v),n.vadd(v,v);var y=se;if(v.vsub(i,y),y.norm2()<f*f)return!!h||(x=!0,(N=this.createContactEquation(r,a,e,t,c,l)).ri.copy(y),N.ri.normalize(),N.ni.copy(N.ri),N.ri.mult(f,N.ri),v.vsub(n,N.rj),N.ri.vadd(i,N.ri),N.ri.vsub(r.position,N.ri),N.rj.vadd(n,N.rj),N.rj.vsub(a.position,N.rj),this.result.push(N),void this.createFrictionEquationsFromContact(N,this.frictionResult))}for(var x=!1,S=(m=0,p.length);m!==S&&!1===x;m++){var b=_[m],T=p[m],E=re;o.vmult(b,E);var C=ae;o.vmult(d[T[0]],C),C.vadd(n,C);var w=ce;E.mult(-f,w),i.vadd(w,w);var A=le;w.vsub(C,A);var P=A.dot(E),R=he;if(i.vsub(C,R),P<0&&R.dot(E)>0){for(var I=[],M=0,O=T.length;M!==O;M++){var D=u.get();o.vmult(d[T[M]],D),n.vadd(D,D),I.push(D)}if(W(I,E,i)){if(h)return!0;x=!0;var N=this.createContactEquation(r,a,e,t,c,l);E.mult(-f,N.ri),E.negate(N.ni);var L=u.get();E.mult(-P,L);var B=u.get();E.mult(-f,B),i.vsub(n,N.rj),N.rj.vadd(B,N.rj),N.rj.vadd(L,N.rj),N.rj.vadd(n,N.rj),N.rj.vsub(a.position,N.rj),N.ri.vadd(i,N.ri),N.ri.vsub(r.position,N.ri),u.release(L),u.release(B),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),M=0;for(var z=I.length;M!==z;M++)u.release(I[M]);return}for(M=0;M!==T.length;M++){var F=u.get(),U=u.get();o.vmult(d[T[(M+1)%T.length]],F),o.vmult(d[T[(M+2)%T.length]],U),n.vadd(F,F),n.vadd(U,U);var G=ie;U.vsub(F,G);var k=ne;G.unit(k);var H=u.get(),V=u.get();i.vsub(F,V);var j=V.dot(k);k.mult(j,H),H.vadd(F,H);var q=u.get();if(H.vsub(i,q),j>0&&j*j<G.norm2()&&q.norm2()<f*f){if(h)return!0;for(N=this.createContactEquation(r,a,e,t,c,l),H.vsub(n,N.rj),H.vsub(i,N.ni),N.ni.normalize(),N.ni.mult(f,N.ri),N.rj.vadd(n,N.rj),N.rj.vsub(a.position,N.rj),N.ri.vadd(i,N.ri),N.ri.vsub(r.position,N.ri),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),M=0,z=I.length;M!==z;M++)u.release(I[M]);return u.release(F),u.release(U),u.release(H),u.release(q),void u.release(V)}u.release(F),u.release(U),u.release(H),u.release(q),u.release(V)}for(M=0,z=I.length;M!==z;M++)u.release(I[M])}}},new o,new o,u.prototype[n.types.PLANE|n.types.BOX]=u.prototype.planeBox=function(e,t,i,n,s,o,r,a,c,l,h){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,n,s,o,r,a,e,t,h)};var ue=new o,_e=new o,pe=new o,de=new o;u.prototype[n.types.PLANE|n.types.CONVEXPOLYHEDRON]=u.prototype.planeConvex=function(e,t,i,n,s,o,r,a,c,l,h){var u=ue,_=_e;_.set(0,0,1),s.vmult(_,_);for(var p=0,d=pe,f=0;f!==t.vertices.length;f++)if(u.copy(t.vertices[f]),o.vmult(u,u),n.vadd(u,u),u.vsub(i,d),_.dot(d)<=0){if(h)return!0;var m=this.createContactEquation(r,a,e,t,c,l),g=de;_.mult(_.dot(d),g),u.vsub(g,g),g.vsub(i,m.ri),m.ni.copy(_),u.vsub(n,m.rj),m.ri.vadd(i,m.ri),m.ri.vsub(r.position,m.ri),m.rj.vadd(n,m.rj),m.rj.vsub(a.position,m.rj),this.result.push(m),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)};var fe=new o,me=new o;u.prototype[n.types.CONVEXPOLYHEDRON]=u.prototype.convexConvex=function(e,t,i,n,s,o,r,a,c,l,h,u,_){var p=fe;if(!(i.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,s,n,o,p,u,_)){var d=[],f=me;e.clipAgainstHull(i,s,t,n,o,p,-100,100,d);for(var m=0,g=0;g!==d.length;g++){if(h)return!0;var v=this.createContactEquation(r,a,e,t,c,l),y=v.ri,x=v.rj;p.negate(v.ni),d[g].normal.negate(f),f.mult(d[g].depth,f),d[g].point.vadd(f,y),x.copy(d[g].point),y.vsub(i,y),x.vsub(n,x),y.vadd(i,y),y.vsub(r.position,y),x.vadd(n,x),x.vsub(a.position,x),this.result.push(v),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}};var ge=new o,ve=new o,ye=new o;u.prototype[n.types.PLANE|n.types.PARTICLE]=u.prototype.planeParticle=function(e,t,i,n,s,o,r,a,c,l,h){var u=ge;u.set(0,0,1),r.quaternion.vmult(u,u);var _=ve;if(n.vsub(r.position,_),u.dot(_)<=0){if(h)return!0;var p=this.createContactEquation(a,r,t,e,c,l);p.ni.copy(u),p.ni.negate(p.ni),p.ri.set(0,0,0);var d=ye;u.mult(u.dot(n),d),n.vsub(d,d),p.rj.copy(d),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}};var xe=new o;u.prototype[n.types.PARTICLE|n.types.SPHERE]=u.prototype.sphereParticle=function(e,t,i,n,s,o,r,a,c,l,h){var u=xe;if(u.set(0,0,1),n.vsub(i,u),u.norm2()<=e.radius*e.radius){if(h)return!0;var _=this.createContactEquation(a,r,t,e,c,l);u.normalize(),_.rj.copy(u),_.rj.mult(e.radius,_.rj),_.ni.copy(u),_.ni.negate(_.ni),_.ri.set(0,0,0),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}};var Se=new a,be=new o,Te=(new o,new o),Ee=new o,Ce=new o;u.prototype[n.types.PARTICLE|n.types.CONVEXPOLYHEDRON]=u.prototype.convexParticle=function(e,t,i,n,s,o,r,a,c,l,h){var u=-1,_=Te,p=Ce,d=null,f=be;if(f.copy(n),f.vsub(i,f),s.conjugate(Se),Se.vmult(f,f),e.pointIsInside(f)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,s),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(s);for(var m=0,g=e.faces.length;m!==g;m++){var v=[e.worldVertices[e.faces[m][0]]],y=e.worldFaceNormals[m];n.vsub(v[0],Ee);var x=-y.dot(Ee);if(null===d||Math.abs(x)<Math.abs(d)){if(h)return!0;d=x,u=m,_.copy(y)}}if(-1!==u){var S=this.createContactEquation(a,r,t,e,c,l);_.mult(d,p),p.vadd(n,p),p.vsub(i,p),S.rj.copy(p),_.negate(S.ni),S.ri.set(0,0,0);var b=S.ri,T=S.rj;b.vadd(n,b),b.vsub(a.position,b),T.vadd(i,T),T.vsub(r.position,T),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},u.prototype[n.types.BOX|n.types.HEIGHTFIELD]=u.prototype.boxHeightfield=function(e,t,i,n,s,o,r,a,c,l,h){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,n,s,o,r,a,e,t,h)};var we=new o,Ae=new o,Pe=[0];u.prototype[n.types.CONVEXPOLYHEDRON|n.types.HEIGHTFIELD]=u.prototype.convexHeightfield=function(e,t,i,n,s,o,a,c,l,h,u){var _=t.data,p=t.elementSize,d=e.boundingSphereRadius,f=Ae,m=Pe,g=we;r.pointToLocalFrame(n,o,i,g);var v=Math.floor((g.x-d)/p)-1,y=Math.ceil((g.x+d)/p)+1,x=Math.floor((g.y-d)/p)-1,S=Math.ceil((g.y+d)/p)+1;if(!(y<0||S<0||v>_.length||x>_[0].length)){v<0&&(v=0),y<0&&(y=0),x<0&&(x=0),S<0&&(S=0),v>=_.length&&(v=_.length-1),y>=_.length&&(y=_.length-1),S>=_[0].length&&(S=_[0].length-1),x>=_[0].length&&(x=_[0].length-1);var b=[];t.getRectMinMax(v,x,y,S,b);var T=b[0],E=b[1];if(!(g.z-d>E||g.z+d<T))for(var C=v;C<y;C++)for(var w=x;w<S;w++){var A=!1;if(t.getConvexTrianglePillar(C,w,!1),r.pointToWorldFrame(n,o,t.pillarOffset,f),i.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.convexConvex(e,t.pillarConvex,i,f,s,o,a,c,l,h,u,m,null)),u&&A)return!0;if(t.getConvexTrianglePillar(C,w,!0),r.pointToWorldFrame(n,o,t.pillarOffset,f),i.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.convexConvex(e,t.pillarConvex,i,f,s,o,a,c,l,h,u,m,null)),u&&A)return!0}}};var Re=new o,Ie=new o;u.prototype[n.types.SPHERE|n.types.HEIGHTFIELD]=u.prototype.sphereHeightfield=function(e,t,i,n,s,o,a,c,l,h,u){var _=t.data,p=e.radius,d=t.elementSize,f=Ie,m=Re;r.pointToLocalFrame(n,o,i,m);var g=Math.floor((m.x-p)/d)-1,v=Math.ceil((m.x+p)/d)+1,y=Math.floor((m.y-p)/d)-1,x=Math.ceil((m.y+p)/d)+1;if(!(v<0||x<0||g>_.length||y>_[0].length)){g<0&&(g=0),v<0&&(v=0),y<0&&(y=0),x<0&&(x=0),g>=_.length&&(g=_.length-1),v>=_.length&&(v=_.length-1),x>=_[0].length&&(x=_[0].length-1),y>=_[0].length&&(y=_[0].length-1);var S=[];t.getRectMinMax(g,y,v,x,S);var b=S[0],T=S[1];if(!(m.z-p>T||m.z+p<b))for(var E=this.result,C=g;C<v;C++)for(var w=y;w<x;w++){var A=E.length,P=!1;if(t.getConvexTrianglePillar(C,w,!1),r.pointToWorldFrame(n,o,t.pillarOffset,f),i.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(P=this.sphereConvex(e,t.pillarConvex,i,f,s,o,a,c,e,t,u)),u&&P)return!0;if(t.getConvexTrianglePillar(C,w,!0),r.pointToWorldFrame(n,o,t.pillarOffset,f),i.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(P=this.sphereConvex(e,t.pillarConvex,i,f,s,o,a,c,e,t,u)),u&&P)return!0;if(E.length-A>2)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(e,t){t.exports=v,e("../shapes/Shape");var i=e("../math/Vec3"),n=e("../math/Quaternion"),s=e("../solver/GSSolver"),o=(e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),r=e("../utils/EventTarget"),a=e("../collision/ArrayCollisionMatrix"),c=e("../collision/ObjectCollisionMatrix"),l=e("../collision/OverlapKeeper"),h=e("../material/Material"),u=e("../material/ContactMaterial"),_=e("../objects/Body"),p=e("../utils/TupleDictionary"),d=e("../collision/RaycastResult"),f=e("../collision/AABB"),m=e("../collision/Ray"),g=e("../collision/NaiveBroadphase");function v(e){e=e||{},r.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new i,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new g,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new s,this.constraints=[],this.narrowphase=new o(this),this.collisionMatrix=new a,this.collisionMatrixPrevious=new a,this.bodyOverlapKeeper=new l,this.shapeOverlapKeeper=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new p,this.defaultMaterial=new h("default"),this.defaultContactMaterial=new u(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this),this.substeps=0,this.cm=new c,this.tm=new c,this.triggerDic=new p,this.oldTriggerDic=new p,this.contactsDic=new p,this.oldContactsDic=new p}v.idToBodyMap={},v.idToShapeMap={},v.integrateKinematic=!1,v.ccdSphereAdvance=!1,v.prototype=new r,new f;var y=new m;if(v.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},v.prototype.numObjects=function(){return this.bodies.length},v.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},v.prototype.add=v.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof _&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.cm.setNumObjects(this.bodies.length),v.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},v.prototype.addConstraint=function(e){this.constraints.push(e)},v.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},v.prototype.rayTest=function(e,t,i){i instanceof d?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},v.prototype.raycastAll=function(e,t,i,n){return i.mode=m.ALL,i.from=e,i.to=t,i.callback=n,y.intersectWorld(this,i)},v.prototype.raycastAny=function(e,t,i,n){return i.mode=m.ANY,i.from=e,i.to=t,i.result=n,y.intersectWorld(this,i)},v.prototype.raycastClosest=function(e,t,i,n){return i.mode=m.CLOSEST,i.from=e,i.to=t,i.result=n,y.intersectWorld(this,i)},v.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,n=i.indexOf(e);if(-1!==n){i.splice(n,1);for(var s=0;s!==i.length;s++)i[s].index=s;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete v.idToBodyMap[e.id],this.cm.setNumObjects(t),this.dispatchEvent(this.removeBodyEvent)}},v.prototype.removeBody=v.prototype.remove,v.prototype.getBodyById=function(e){return v.idToBodyMap[e]},v.prototype.getShapeById=function(e){return v.idToShapeMap[e]},v.prototype.addMaterial=function(e){this.materials.push(e)},v.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var x=Date.now();performance.timing&&performance.timing.navigationStart&&(x=performance.timing.navigationStart),performance.now=function(){return Date.now()-x}}v.prototype.saveKinematicAndApplyGravity=function(e){for(var t=this.bodies,i=this.bodies.length,n=0;n!==i;n++){var s=t[n];s.type===_.DYNAMIC?s.applyGravity(this.gravity):s.type===_.KINEMATIC&&s.updateKinematic(e)}},v.prototype.step=function(e,t,i){if(i=i||10,0===(t=t||0))this.saveKinematicAndApplyGravity(e),this.internalStep(e),this.time+=e,this.substeps=1;else{for(this.saveKinematicAndApplyGravity(t),this.accumulator+=t,this.substeps=0;this.accumulator>=e&&this.substeps<i;)this.internalStep(e),this.accumulator-=e,this.substeps++;for(var n=this.accumulator%e/e,s=0;s!==this.bodies.length;s++){var o=this.bodies[s];o.previousPosition.lerp(o.position,n,o.interpolatedPosition),o.previousQuaternion.slerp(o.quaternion,n,o.interpolatedQuaternion),o.previousQuaternion.normalize()}this.time+=t}this.clearForces()};var S,b,T,E,C,w,A={type:"postStep"},P={type:"preStep"},R={type:"collide",body:null,contact:null},I=[],M=[],O=[],D=[];new i,new i,new i,new i,new i,new i,new i,new i,new i,new n,new n,new n,new i,v.prototype.internalStep=function(e){this.dt=e;var t,i=this.contacts,n=O,s=D,o=this.numObjects(),r=this.bodies,a=this.solver,c=this.doProfiling,l=this.profile,h=_.DYNAMIC,u=this.constraints,p=M,d=0;c&&(t=performance.now()),d=0;for(var f=this.subsystems.length;d!==f;d++)this.subsystems[d].update();c&&(t=performance.now()),n.length=0,s.length=0,this.broadphase.collisionPairs(this,n,s),c&&(l.broadphase=performance.now()-t);var m=u.length;for(d=0;d!==m;d++)if(!(N=u[d]).collideConnected)for(var g=n.length-1;g>=0;g-=1)(N.bodyA===n[g]&&N.bodyB===s[g]||N.bodyB===n[g]&&N.bodyA===s[g])&&(n.splice(g,1),s.splice(g,1));this.collisionMatrixTick(),c&&(t=performance.now());var v=I,y=i.length;for(d=0;d!==y;d++)v.push(i[d]);i.length=0;var x=this.frictionEquations.length;for(d=0;d!==x;d++)p.push(this.frictionEquations[d]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(n,s,this,i,v,this.frictionEquations,p),c&&(l.narrowphase=performance.now()-t),c&&(t=performance.now()),d=0;d<this.frictionEquations.length;d++)a.addEquation(this.frictionEquations[d]);for(var S=i.length,b=0;b!==S;b++){var T=(N=i[b]).bi,E=N.bj,C=N.si,w=N.sj;C.material&&w.material?C.material.restitution>=0&&w.material.restitution>=0&&(N.restitution=C.material.restitution*w.material.restitution):T.material&&E.material&&T.material.restitution>=0&&E.material.restitution>=0&&(N.restitution=T.material.restitution*E.material.restitution),a.addEquation(N),T.allowSleep&&T.type===_.DYNAMIC&&T.sleepState===_.SLEEPING&&E.sleepState===_.AWAKE&&E.type!==_.STATIC&&E.velocity.norm2()+E.angularVelocity.norm2()>=2*Math.pow(E.sleepSpeedLimit,2)&&(T._wakeUpAfterNarrowphase=!0),E.allowSleep&&E.type===_.DYNAMIC&&E.sleepState===_.SLEEPING&&T.sleepState===_.AWAKE&&T.type!==_.STATIC&&T.velocity.norm2()+T.angularVelocity.norm2()>=2*Math.pow(T.sleepSpeedLimit,2)&&(E._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(T,E,!0),this.collisionMatrixPrevious.get(T,E)||(R.body=E,R.contact=N,T.dispatchEvent(R),R.body=T,E.dispatchEvent(R)),this.bodyOverlapKeeper.set(T.id,E.id),this.shapeOverlapKeeper.set(C.id,w.id)}for(this.emitContactEvents(),c&&(l.makeContactConstraints=performance.now()-t,t=performance.now()),d=0;d!==o;d++)(T=r[d])._wakeUpAfterNarrowphase&&(T.wakeUp(),T._wakeUpAfterNarrowphase=!1);for(m=u.length,d=0;d!==m;d++){var N;(N=u[d]).update(),g=0;for(var L=N.equations.length;g!==L;g++){var B=N.equations[g];a.addEquation(B)}}for(a.solve(e,this),c&&(l.solve=performance.now()-t),a.removeAllEquations(),this.dispatchEvent(P),d=0;d!==o;d++)(T=r[d]).preStep&&T.preStep.call(T);c&&(t=performance.now());var z=this.stepnumber%(this.quatNormalizeSkip+1)==0,F=this.quatNormalizeFast;for(d=0;d!==o;d++)r[d].integrate(e,z,F);var U=Math.pow;for(d=0;d!==o;d++)if((T=r[d]).type&h){var G=U(1-T.linearDamping,e),k=T.velocity;k.mult(G,k);var H=T.angularVelocity;if(H){var V=U(1-T.angularDamping,e);H.mult(V,H)}}for(this.broadphase.dirty=!0,c&&(l.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(A),d=0;d!==o;d++){var j=(T=r[d]).postStep;j&&j.call(T)}if(this.allowSleep)for(d=0;d!==o;d++)r[d].sleepTick(this.time)},v.prototype.emitContactEvents=(S=[],b=[],T={type:"beginContact",bodyA:null,bodyB:null},E={type:"endContact",bodyA:null,bodyB:null},C={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},w={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var e=this.hasAnyEventListener("beginContact"),t=this.hasAnyEventListener("endContact");if((e||t)&&this.bodyOverlapKeeper.getDiff(S,b),e){for(var i=0,n=S.length;i<n;i+=2)T.bodyA=this.getBodyById(S[i]),T.bodyB=this.getBodyById(S[i+1]),this.dispatchEvent(T);T.bodyA=T.bodyB=null}if(t){for(i=0,n=b.length;i<n;i+=2)E.bodyA=this.getBodyById(b[i]),E.bodyB=this.getBodyById(b[i+1]),this.dispatchEvent(E);E.bodyA=E.bodyB=null}S.length=b.length=0;var s=this.hasAnyEventListener("beginShapeContact"),o=this.hasAnyEventListener("endShapeContact");if((s||o)&&this.shapeOverlapKeeper.getDiff(S,b),s){for(i=0,n=S.length;i<n;i+=2){var r=this.getShapeById(S[i]),a=this.getShapeById(S[i+1]);C.shapeA=r,C.shapeB=a,C.bodyA=r.body,C.bodyB=a.body,this.dispatchEvent(C)}C.bodyA=C.bodyB=C.shapeA=C.shapeB=null}if(o){for(i=0,n=b.length;i<n;i+=2)r=this.getShapeById(b[i]),a=this.getShapeById(b[i+1]),w.shapeA=r,w.shapeB=a,w.bodyA=r.body,w.bodyB=a.body,this.dispatchEvent(w);w.bodyA=w.bodyB=w.shapeA=w.shapeB=null}}),v.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var n=e[i];n.force,n.torque,n.force.set(0,0,0),n.torque.set(0,0,0)}};var N={type:"cc-trigger",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null},L={type:"cc-collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},B=[];v.prototype.emitTriggeredEvents=function(){if(0!=this.substeps){for(var e,t,i=this.triggerDic.getLength();i--;)if(e=this.triggerDic.getKeyByIndex(i),null!=(t=this.triggerDic.getDataByKey(e))){var n=t.si,s=t.sj;this.tm.get(n,s)?N.event="onTriggerStay":(this.tm.set(n,s,!0),N.event="onTriggerEnter"),N.selfShape=n,N.otherShape=s,N.selfBody=n.body,N.otherBody=s.body,n.dispatchEvent(N),N.selfShape=s,N.otherShape=n,N.selfBody=s.body,N.otherBody=n.body,s.dispatchEvent(N)}for(i=this.oldTriggerDic.getLength();i>0;)i--,e=this.oldTriggerDic.getKeyByIndex(i),null==this.triggerDic.getDataByKey(e)&&null!=(t=this.oldTriggerDic.getDataByKey(e))&&(n=t.si,s=t.sj,this.tm.set(n,s,!1),this.oldTriggerDic.del(n.id,s.id)&&i--,N.event="onTriggerExit",N.selfShape=n,N.otherShape=s,N.selfBody=n.body,N.otherBody=s.body,n.dispatchEvent(N),N.selfShape=s,N.otherShape=n,N.selfBody=s.body,N.otherBody=n.body,s.dispatchEvent(N));this.triggerDic.reset()}},v.prototype.emitCollisionEvents=function(){if(0!=this.substeps){for(var e,t,i=this.contacts,n=this.contacts.length;n--;){var s=(h=i[n]).si,o=h.sj,r=this.contactsDic.get(s.id,o.id);null==r&&(r=this.contactsDic.set(s.id,o.id,[])),r.push(h)}for(n=this.contactsDic.getLength();n--;)if(e=this.contactsDic.getKeyByIndex(n),null!=(t=this.contactsDic.getDataByKey(e))){s=t[0].si,o=t[0].sj;var a=s.body,c=o.body;this.cm.get(a,c)?L.event="onCollisionStay":(this.cm.set(a,c,!0),L.event="onCollisionEnter"),L.bi=a,L.contact=t[0],L.contacts=t,L.body=c,L.selfShape=s,L.otherShape=o,a.dispatchEvent(L),L.body=a,L.selfShape=o,L.otherShape=s,c.dispatchEvent(L)}var l=B;for(n=l.length;n--;){var h;s=(h=l[n]).si,o=h.sj,null==this.oldContactsDic.get(s.id,o.id)&&this.oldContactsDic.set(s.id,o.id,h)}for(n=this.oldContactsDic.getLength();n--;)e=this.oldContactsDic.getKeyByIndex(n),null==this.contactsDic.getDataByKey(e)&&(s=(t=this.oldContactsDic.getDataByKey(e)).si,o=t.sj,a=s.body,c=o.body,this.cm.get(a,c)&&(a.isSleeping()&&c.isSleeping()||(this.cm.set(a,c,!1),L.bi=a,L.contact=t,L.event="onCollisionExit",L.body=c,L.selfShape=s,L.otherShape=o,L.contacts.length=0,L.contacts.push(t),a.dispatchEvent(L),L.body=a,L.selfShape=o,L.otherShape=s,c.dispatchEvent(L))));this.contactsDic.reset(),this.oldContactsDic.reset(),I=B,B=this.contacts.slice(),this.contacts.length=0}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)}(t={exports:{}}),t.exports}();let xhe,She,bhe,The,Ehe,Che,whe;function Ahe(e){n._global.CC_PHYSICS_BUILTIN="builtin"===e,n._global.CC_PHYSICS_CANNON="cannon.js"===e,n._global.CC_PHYSICS_AMMO="ammo.js"===e}!function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(xhe||(xhe=e("ERigidBodyType",{}))),Le(xhe),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(She||(She=e("EAxisDirection",{}))),Le(She),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(bhe||(bhe={})),Le(bhe),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}(The||(The={})),Le(The),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST"}(Ehe||(Ehe={})),Le(Ehe),function(e){e[e.DEFAULT=1]="DEFAULT"}(Che||(Che={})),Le(Che);const Phe={id:"",switchTo:function(e){if(!Phe.runInEditor)return;const t=Phe;if(Phe.physicsWorld&&e!==Phe.id&&null!=Phe.backend[e]?(Phe.physicsWorld.destroy(),console.info(`[PHYSICS]: switch from ${Phe.id} to ${e}.`),Ahe(e),t.id=e,t.wrapper=Phe.backend[e],t.physicsWorld=Dhe()):(console.info(`[PHYSICS]: using ${e}.`),t.physicsWorld=Dhe()),whe){const e=t.physicsWorld;e.setGravity(whe.gravity),e.setAllowSleep(whe.allowSleep),e.setDefaultMaterial(whe.defaultMaterial)}},register:function(e,t){if(console.info(`[PHYSICS]: register ${e}.`),Phe.backend[e]=t,!Phe.physicsWorld||Phe.id===e){Ahe(e);const i=Phe;i.id=e,i.wrapper=t}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},Rhe=()=>0,Ihe={impl:null,setGravity:Rhe,setAllowSleep:Rhe,setDefaultMaterial:Rhe,step:Rhe,syncAfterEvents:Rhe,syncSceneToPhysics:Rhe,raycast:Rhe,raycastClosest:Rhe,emitEvents:Rhe,destroy:Rhe};var Mhe;function Ohe(e,t){return null==e&&(Phe.id?p(`${Phe.id} physics does not support ${Mhe[t]}`):C(9600),!0)}function Dhe(){return Ohe(Phe.wrapper.PhysicsWorld,Mhe.World)?Ihe:new Phe.wrapper.PhysicsWorld}!function(e){e[e.World=0]="World",e[e.RigidBody=1]="RigidBody",e[e.BoxCollider=2]="BoxCollider",e[e.SphereCollider=3]="SphereCollider",e[e.CapsuleCollider=4]="CapsuleCollider",e[e.MeshCollider=5]="MeshCollider",e[e.CylinderCollider=6]="CylinderCollider",e[e.ConeCollider=7]="ConeCollider",e[e.TerrainCollider=8]="TerrainCollider",e[e.SimplexCollider=9]="SimplexCollider",e[e.PlaneCollider=10]="PlaneCollider",e[e.PointToPointConstraint=11]="PointToPointConstraint",e[e.HingeConstraint=12]="HingeConstraint",e[e.ConeTwistConstraint=13]="ConeTwistConstraint"}(Mhe||(Mhe={}));const Nhe={impl:null,rigidBody:null,isAwake:!1,isSleepy:!1,isSleeping:!1,initialize:Rhe,onEnable:Rhe,onDisable:Rhe,onDestroy:Rhe,setType:Rhe,setMass:Rhe,setLinearDamping:Rhe,setAngularDamping:Rhe,useGravity:Rhe,setLinearFactor:Rhe,setAngularFactor:Rhe,setAllowSleep:Rhe,wakeUp:Rhe,sleep:Rhe,clearState:Rhe,clearForces:Rhe,clearVelocity:Rhe,setSleepThreshold:Rhe,getSleepThreshold:Rhe,getLinearVelocity:Rhe,setLinearVelocity:Rhe,getAngularVelocity:Rhe,setAngularVelocity:Rhe,applyForce:Rhe,applyLocalForce:Rhe,applyImpulse:Rhe,applyLocalImpulse:Rhe,applyTorque:Rhe,applyLocalTorque:Rhe,setGroup:Rhe,getGroup:Rhe,addGroup:Rhe,removeGroup:Rhe,setMask:Rhe,getMask:Rhe,addMask:Rhe,removeMask:Rhe,isUsingCCD:Rhe,useCCD:Rhe},Lhe={INITED:!1},Bhe={impl:null,collider:null,attachedRigidBody:null,initialize:Rhe,onLoad:Rhe,onEnable:Rhe,onDisable:Rhe,onDestroy:Rhe,setGroup:Rhe,getGroup:Rhe,addGroup:Rhe,removeGroup:Rhe,setMask:Rhe,getMask:Rhe,addMask:Rhe,removeMask:Rhe,setMaterial:Rhe,setAsTrigger:Rhe,setCenter:Rhe,getAABB:Rhe,getBoundingSphere:Rhe,updateSize:Rhe,updateRadius:Rhe,setRadius:Rhe,setCylinderHeight:Rhe,setDirection:Rhe,setHeight:Rhe,setShapeType:Rhe,setVertices:Rhe,setMesh:Rhe,setTerrain:Rhe,setNormal:Rhe,setConstant:Rhe,updateEventListener:Rhe};const zhe={INITED:!1},Fhe={impl:null,initialize:Rhe,onLoad:Rhe,onEnable:Rhe,onDisable:Rhe,onDestroy:Rhe,setEnableCollision:Rhe,setConnectedBody:Rhe,setPivotA:Rhe,setPivotB:Rhe,setAxis:Rhe};var Uhe,Ghe,khe,Hhe,Vhe,jhe,Whe,qhe;let Xhe=function(t){return e({PhysicsMaterial:t,PhysicMaterial:t}),t}(Wc("cc.PhysicsMaterial")((qhe=Whe=class e extends xh{get friction(){return this._friction}set friction(t){_i(this._friction,t)||(this._friction=t,this.emit(e.EVENT_UPDATE))}get rollingFriction(){return this._rollingFriction}set rollingFriction(t){_i(this._rollingFriction,t)||(this._rollingFriction=t,this.emit(e.EVENT_UPDATE))}get spinningFriction(){return this._spinningFriction}set spinningFriction(t){_i(this._spinningFriction,t)||(this._spinningFriction=t,this.emit(e.EVENT_UPDATE))}get restitution(){return this._restitution}set restitution(t){_i(this._restitution,t)||(this._restitution=t,this.emit(e.EVENT_UPDATE))}constructor(){super(),this.id=void 0,Mc(this,"_friction",khe,this),Mc(this,"_rollingFriction",Hhe,this),Mc(this,"_spinningFriction",Vhe,this),Mc(this,"_restitution",jhe,this),e.allMaterials.push(this),this.id=e._idCounter++,this._uuid||(this._uuid=`pm_${this.id}`)}clone(){const t=new e;return t._friction=this._friction,t._restitution=this._restitution,t._rollingFriction=this._rollingFriction,t._spinningFriction=this._spinningFriction,t}destroy(){if(super.destroy()){const t=e.allMaterials.indexOf(this);return t>=0&&e.allMaterials.splice(t,1),!0}return!1}setValues(t,i,n,s){const o=this._friction!==t||this._rollingFriction!==i||this._spinningFriction!==n||this._restitution!==s;this._friction=t,this._rollingFriction=i,this._spinningFriction=n,this._restitution=s,o&&this.emit(e.EVENT_UPDATE)}},Whe.allMaterials=[],Whe.EVENT_UPDATE="event_update",Whe._idCounter=0,Oc((Ghe=qhe).prototype,"friction",[cl],Object.getOwnPropertyDescriptor(Ghe.prototype,"friction"),Ghe.prototype),Oc(Ghe.prototype,"rollingFriction",[cl],Object.getOwnPropertyDescriptor(Ghe.prototype,"rollingFriction"),Ghe.prototype),Oc(Ghe.prototype,"spinningFriction",[cl],Object.getOwnPropertyDescriptor(Ghe.prototype,"spinningFriction"),Ghe.prototype),Oc(Ghe.prototype,"restitution",[cl],Object.getOwnPropertyDescriptor(Ghe.prototype,"restitution"),Ghe.prototype),khe=Oc(Ghe.prototype,"_friction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.6}}),Hhe=Oc(Ghe.prototype,"_rollingFriction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Vhe=Oc(Ghe.prototype,"_spinningFriction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),jhe=Oc(Ghe.prototype,"_restitution",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uhe=Ghe))||Uhe);class Yhe{constructor(){this._hitPoint=new zi,this._hitNormal=new zi,this._distance=0,this._collider=null}get hitPoint(){return this._hitPoint}get distance(){return this._distance}get collider(){return this._collider}get hitNormal(){return this._hitNormal}_assign(e,t,i,n){zi.copy(this._hitPoint,e),zi.copy(this._hitNormal,n),this._distance=t,this._collider=i}clone(){const e=new Yhe;return zi.copy(e._hitPoint,this._hitPoint),zi.copy(e._hitNormal,this._hitNormal),e._distance=this._distance,e._collider=this._collider,e}}e("PhysicsRayResult",Yhe);class Khe{constructor(e){if(1===e){const e=this;for(let t=0;t<32;t++){const i="_"+(1<<t);e[i]=0,e.updateArray=[],Object.defineProperty(e,1<<t,{get(){return this[i]},set(e){this[i]!==e&&(this[i]=e,this.updateArray.indexOf(t)<0&&this.updateArray.push(t))}})}this._1=Che.DEFAULT}else{for(let e=0;e<32;e++)this[""+(1<<e)]=0;this[1]=Che.DEFAULT}}}n.internal.PhysicsGroup=Che;class $he extends kw{static get PHYSICS_NONE(){return!Phe.id}static get PHYSICS_BUILTIN(){return"builtin"===Phe.id}static get PHYSICS_CANNON(){return"cannon.js"===Phe.id}static get PHYSICS_AMMO(){return"ammo.js"===Phe.id}static get PHYSICS_PHYSX(){return"physx"===Phe.id}static get PhysicsGroup(){return Che}static get instance(){return $he._instance}get enable(){return this._enable}set enable(e){this._enable=e}get allowSleep(){return this._allowSleep}set allowSleep(e){this._allowSleep=e,this.physicsWorld&&this.physicsWorld.setAllowSleep(e)}get maxSubSteps(){return this._maxSubSteps}set maxSubSteps(e){this._maxSubSteps=e}get fixedTimeStep(){return this._fixedTimeStep}set fixedTimeStep(e){this._fixedTimeStep=e}get gravity(){return this._gravity}set gravity(e){this._gravity.set(e),this.physicsWorld&&this.physicsWorld.setGravity(e)}get sleepThreshold(){return this._sleepThreshold}set sleepThreshold(e){this._sleepThreshold=e}get autoSimulation(){return this._autoSimulation}set autoSimulation(e){this._autoSimulation=e}get defaultMaterial(){return this._material}get physicsWorld(){return Phe.physicsWorld}constructor(){super(),this.raycastClosestResult=new Yhe,this.raycastResults=[],this.collisionMatrix=new Khe(1),this.minVolumeSize=1e-5,this.useNodeChains=!1,this._enable=!0,this._allowSleep=!0,this._maxSubSteps=1,this._subStepCount=0,this._fixedTimeStep=1/60,this._autoSimulation=!0,this._accumulator=0,this._sleepThreshold=.1,this._gravity=new zi(0,-10,0),this._material=new Xhe,this.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},this.raycastResultPool=new U((()=>new Yhe),1),this._material.on(Xhe.EVENT_UPDATE,this._updateMaterial,this)}postUpdate(e){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=e,Qw.emit($w.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}Qw.emit($w.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()}resetConfiguration(e){const t=e||(Iw.config?Iw.config.physics:null);if(t){if("boolean"==typeof t.allowSleep&&(this._allowSleep=t.allowSleep),"number"==typeof t.fixedTimeStep&&(this._fixedTimeStep=t.fixedTimeStep),"number"==typeof t.maxSubSteps&&(this._maxSubSteps=t.maxSubSteps),"number"==typeof t.sleepThreshold&&(this._sleepThreshold=t.sleepThreshold),"boolean"==typeof t.autoSimulation&&(this.autoSimulation=t.autoSimulation),t.gravity&&zi.copy(this._gravity,t.gravity),t.defaultMaterial&&this._material.setValues(t.defaultMaterial.friction,t.defaultMaterial.rollingFriction,t.defaultMaterial.spinningFriction,t.defaultMaterial.restitution),t.collisionMatrix)for(const e in t.collisionMatrix)this.collisionMatrix[""+(1<<parseInt(e))]=t.collisionMatrix[e];if(t.collisionGroups){const e=t.collisionGroups;e instanceof Array&&(e.forEach((e=>{Che[e.name]=1<<e.index})),Le.update(Che))}}this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep),this.physicsWorld.setDefaultMaterial(this._material))}resetAccumulator(e=0){this._accumulator=e}step(e,t,i){this.physicsWorld&&this.physicsWorld.step(e,t,i)}syncSceneToPhysics(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()}emitEvents(){this.physicsWorld&&this.physicsWorld.emitEvents()}raycast(e,t=4294967295,i=1e7,n=!0){return!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=n,this.physicsWorld.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults))}raycastClosest(e,t=4294967295,i=1e7,n=!0){return!!this.physicsWorld&&(this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=n,this.physicsWorld.raycastClosest(e,this.raycastOptions,this.raycastClosestResult))}_updateMaterial(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)}static constructAndRegister(){if(!$he._instance){const e=new $he;e.resetConfiguration(),function(e){if(whe||(whe=e),Phe.runInEditor&&!Phe.physicsWorld){console.info(`[PHYSICS]: using ${Phe.id}.`);const e=Phe.physicsWorld=Dhe();e.setGravity(whe.gravity),e.setAllowSleep(whe.allowSleep),e.setDefaultMaterial(whe.defaultMaterial)}}(e),$he._instance=e,Qw.registerSystem($he.ID,e,e.priority)}}}var Qhe,Zhe,Jhe,eue,tue,iue,nue,sue,oue,rue,aue,cue,lue,hue,uue,_ue,pue,due,fue,mue,gue,vue,yue,xue,Sue,bue,Tue,Eue,Cue,wue,Aue,Pue,Rue,Iue,Mue,Oue,Due,Nue,Lue,Bue,zue,Fue,Uue,Gue;e("PhysicsSystem",$he),$he.ID="PHYSICS",$he._instance=null,Qw.once($w.EVENT_INIT,(()=>{$he.constructAndRegister()}));let kue=function(t){return e({RigidBody:t,RigidBodyComponent:t}),t}((Qhe=Wc("cc.RigidBody"),Zhe=al(),Jhe=nl(),eue=Xc(-1),tue=Al($he.PhysicsGroup),iue=vl(),nue=_l(),sue=Al(xhe),oue=vl(),rue=_l(),aue=ll(),cue=vl(),lue=_l(),hue=ll(),uue=vl(),_ue=_l(),pue=ll(),due=vl(),fue=_l(),mue=ll(),gue=vl(),vue=_l(),yue=ll(),xue=vl(),Sue=_l(),bue=ll(),Tue=vl(),Eue=_l(),Cue=ll(),wue=vl(),Aue=_l(),Qhe(Pue=Zhe(Pue=Jhe(Pue=il(Pue=Yc(Pue=eue((Gue=Uue=class extends Gh{constructor(...e){super(...e),this._body=null,Mc(this,"_group",Iue,this),Mc(this,"_type",Mue,this),Mc(this,"_mass",Oue,this),Mc(this,"_allowSleep",Due,this),Mc(this,"_linearDamping",Nue,this),Mc(this,"_angularDamping",Lue,this),Mc(this,"_useGravity",Bue,this),Mc(this,"_linearFactor",zue,this),Mc(this,"_angularFactor",Fue,this)}get group(){return this._group}set group(e){this._group=e,this._body&&this._body.getGroup()!==e&&this._body.setGroup(e)}get type(){return this._type}set type(e){this._type!==e&&(this._type=e,this._body&&this._body.setType(e))}get mass(){return this._mass}set mass(e){this._mass!==e&&(e=e<=0?1e-4:e,this._mass=e,this._body&&this._body.setMass(e))}get allowSleep(){return this._allowSleep}set allowSleep(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}get linearDamping(){return this._linearDamping}set linearDamping(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}get angularDamping(){return this._angularDamping}set angularDamping(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}get useGravity(){return this._useGravity}set useGravity(e){this._useGravity=e,this._body&&this._body.useGravity(e)}get linearFactor(){return this._linearFactor}set linearFactor(e){zi.copy(this._linearFactor,e),this._body&&this._body.setLinearFactor(this._linearFactor)}get angularFactor(){return this._angularFactor}set angularFactor(e){zi.copy(this._angularFactor,e),this._body&&this._body.setAngularFactor(this._angularFactor)}get sleepThreshold(){return this._isInitialized?this._body.getSleepThreshold():.1}set sleepThreshold(e){this._isInitialized&&this._body.setSleepThreshold(e)}get useCCD(){return!!this._isInitialized&&this._body.isUsingCCD()}set useCCD(e){this._isInitialized&&this._body.useCCD(e)}get isAwake(){return!!this._isInitialized&&this._body.isAwake}get isSleepy(){return!!this._isInitialized&&this._body.isSleepy}get isSleeping(){return!!this._isInitialized&&this._body.isSleeping}get isStatic(){return this._type===xhe.STATIC}set isStatic(e){e&&this.isStatic||!e&&!this.isStatic||(this.type=e?xhe.STATIC:xhe.DYNAMIC)}get isDynamic(){return this._type===xhe.DYNAMIC}set isDynamic(e){e&&this.isDynamic||!e&&!this.isDynamic||(this.type=e?xhe.DYNAMIC:xhe.KINEMATIC)}get isKinematic(){return this._type===xhe.KINEMATIC}set isKinematic(e){e&&this.isKinematic||!e&&!this.isKinematic||(this.type=e?xhe.KINEMATIC:xhe.DYNAMIC)}get body(){return this._body}get _isInitialized(){const e=null===this._body;return e&&d("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}onLoad(){Phe.runInEditor&&(this._body=Ohe(Phe.wrapper.RigidBody,Mhe.RigidBody)?Nhe:new Phe.wrapper.RigidBody,this._body.initialize(this))}onEnable(){this._body&&this._body.onEnable()}onDisable(){this._body&&this._body.onDisable()}onDestroy(){this._body&&this._body.onDestroy()}applyForce(e,t){this._isInitialized&&this._body.applyForce(e,t)}applyLocalForce(e,t){this._isInitialized&&this._body.applyLocalForce(e,t)}applyImpulse(e,t){this._isInitialized&&this._body.applyImpulse(e,t)}applyLocalImpulse(e,t){this._isInitialized&&this._body.applyLocalImpulse(e,t)}applyTorque(e){this._isInitialized&&this._body.applyTorque(e)}applyLocalTorque(e){this._isInitialized&&this._body.applyLocalTorque(e)}wakeUp(){this._isInitialized&&this._body.wakeUp()}sleep(){this._isInitialized&&this._body.sleep()}clearState(){this._isInitialized&&this._body.clearState()}clearForces(){this._isInitialized&&this._body.clearForces()}clearVelocity(){this._isInitialized&&this._body.clearVelocity()}getLinearVelocity(e){this._isInitialized&&this._body.getLinearVelocity(e)}setLinearVelocity(e){this._isInitialized&&this._body.setLinearVelocity(e)}getAngularVelocity(e){this._isInitialized&&this._body.getAngularVelocity(e)}setAngularVelocity(e){this._isInitialized&&this._body.setAngularVelocity(e)}getGroup(){return this._isInitialized?this._body.getGroup():0}setGroup(e){this._isInitialized&&this._body.setGroup(e)}addGroup(e){this._isInitialized&&this._body.addGroup(e)}removeGroup(e){this._isInitialized&&this._body.removeGroup(e)}getMask(){return this._isInitialized?this._body.getMask():0}setMask(e){this._isInitialized&&this._body.setMask(e)}addMask(e){this._isInitialized&&this._body.addMask(e)}removeMask(e){this._isInitialized&&this._body.removeMask(e)}},Uue.Type=xhe,Oc((Rue=Gue).prototype,"group",[tue,iue,nue],Object.getOwnPropertyDescriptor(Rue.prototype,"group"),Rue.prototype),Oc(Rue.prototype,"type",[sue,oue,rue],Object.getOwnPropertyDescriptor(Rue.prototype,"type"),Rue.prototype),Oc(Rue.prototype,"mass",[aue,cue,lue],Object.getOwnPropertyDescriptor(Rue.prototype,"mass"),Rue.prototype),Oc(Rue.prototype,"allowSleep",[hue,uue,_ue],Object.getOwnPropertyDescriptor(Rue.prototype,"allowSleep"),Rue.prototype),Oc(Rue.prototype,"linearDamping",[pue,due,fue],Object.getOwnPropertyDescriptor(Rue.prototype,"linearDamping"),Rue.prototype),Oc(Rue.prototype,"angularDamping",[mue,gue,vue],Object.getOwnPropertyDescriptor(Rue.prototype,"angularDamping"),Rue.prototype),Oc(Rue.prototype,"useGravity",[yue,xue,Sue],Object.getOwnPropertyDescriptor(Rue.prototype,"useGravity"),Rue.prototype),Oc(Rue.prototype,"linearFactor",[bue,Tue,Eue],Object.getOwnPropertyDescriptor(Rue.prototype,"linearFactor"),Rue.prototype),Oc(Rue.prototype,"angularFactor",[Cue,wue,Aue],Object.getOwnPropertyDescriptor(Rue.prototype,"angularFactor"),Rue.prototype),Iue=Oc(Rue.prototype,"_group",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $he.PhysicsGroup.DEFAULT}}),Mue=Oc(Rue.prototype,"_type",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xhe.DYNAMIC}}),Oue=Oc(Rue.prototype,"_mass",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Due=Oc(Rue.prototype,"_allowSleep",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Nue=Oc(Rue.prototype,"_linearDamping",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Lue=Oc(Rue.prototype,"_angularDamping",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Bue=Oc(Rue.prototype,"_useGravity",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zue=Oc(Rue.prototype,"_linearFactor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1,1)}}),Fue=Oc(Rue.prototype,"_angularFactor",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1,1)}}),Pue=Rue))||Pue)||Pue)||Pue)||Pue)||Pue)||Pue));var Hue,Vue,jue,Wue,que,Xue,Yue,Kue,$ue,Que,Zue,Jue,e_e,t_e,i_e,n_e,s_e,o_e,r_e,a_e,c_e,l_e;kue||(kue=function(t){return e({RigidBody:t,RigidBodyComponent:t}),t}({}));let h_e=function(t){return e({Collider:t,ColliderComponent:t}),t}((Hue=Wc("cc.Collider"),Vue=Al(kue),jue=ul(),Wue=vl(),que=_l(),Xue=Al(Xhe),Yue=ul(),Kue=vl(),$ue=_l(),Que=vl(),Zue=_l(),Jue=Al(zi),e_e=vl(),t_e=_l(),i_e=Al(Xhe),Hue((l_e=c_e=class extends(Ht(Gh)){get attachedRigidBody(){return function(e){const t=e.getComponent(kue);return t&&t.isValid?t:null}(this.node)}get sharedMaterial(){return this._material}set sharedMaterial(e){this.material=e}get material(){return this._isSharedMaterial&&this._material&&(this._material.off(Xhe.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on(Xhe.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material}set material(e){this._shape?(e&&this._material?this._material.id!==e.id&&(this._material.off(Xhe.EVENT_UPDATE,this._updateMaterial,this),e.on(Xhe.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):e&&!this._material?(e.on(Xhe.EVENT_UPDATE,this._updateMaterial,this),this._material=e):!e&&this._material&&(this._material.off(Xhe.EVENT_UPDATE,this._updateMaterial,this),this._material=e),this._updateMaterial()):this._material=e}get isTrigger(){return this._isTrigger}set isTrigger(e){this._isTrigger=e,this._shape&&this._shape.setAsTrigger(this._isTrigger)}get center(){return this._center}set center(e){zi.copy(this._center,e),this._shape&&this._shape.setCenter(this._center)}get shape(){return this._shape}get worldBounds(){return null==this._aabb&&(this._aabb=new xc),this._shape&&this._shape.getAABB(this._aabb),this._aabb}get boundingSphere(){return null==this._boundingSphere&&(this._boundingSphere=new As),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}get needTriggerEvent(){return this._needTriggerEvent}get needCollisionEvent(){return this._needCollisionEvent}get _isInitialized(){const e=null===this._shape;return e&&d("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}constructor(e){super(),this.type=void 0,this._shape=null,this._aabb=null,this._boundingSphere=null,this._isSharedMaterial=!0,this._needTriggerEvent=!1,this._needCollisionEvent=!1,Mc(this,"_material",o_e,this),Mc(this,"_isTrigger",r_e,this),Mc(this,"_center",a_e,this),this.type=e}on(e,t,i,n){const s=super.on(e,t,i,n);return this._updateNeedEvent(e),s}off(e,t,i){super.off(e,t,i),this._updateNeedEvent()}once(e,t,i){const n=super.once(e,t,i);return this._updateNeedEvent(e),n}removeAll(e){super.removeAll(e),this._updateNeedEvent()}getGroup(){return this._isInitialized?this._shape.getGroup():0}setGroup(e){this._isInitialized&&this._shape.setGroup(e)}addGroup(e){this._isInitialized&&this._shape.addGroup(e)}removeGroup(e){this._isInitialized&&this._shape.removeGroup(e)}getMask(){return this._isInitialized?this._shape.getMask():0}setMask(e){this._isInitialized&&this._shape.setMask(e)}addMask(e){this._isInitialized&&this._shape.addMask(e)}removeMask(e){this._isInitialized&&this._shape.removeMask(e)}onLoad(){Phe.runInEditor&&(this.sharedMaterial=null==this._material?$he.instance.defaultMaterial:this._material,this._shape=function(e){return Lhe.INITED||(Lhe.INITED=!0,Lhe[The.BOX]=function(){return Ohe(Phe.wrapper.BoxShape,Mhe.BoxCollider)?Bhe:new Phe.wrapper.BoxShape},Lhe[The.SPHERE]=function(){return Ohe(Phe.wrapper.SphereShape,Mhe.SphereCollider)?Bhe:new Phe.wrapper.SphereShape},Lhe[The.CAPSULE]=function(){return Ohe(Phe.wrapper.CapsuleShape,Mhe.CapsuleCollider)?Bhe:new Phe.wrapper.CapsuleShape},Lhe[The.CYLINDER]=function(){return Ohe(Phe.wrapper.CylinderShape,Mhe.CylinderCollider)?Bhe:new Phe.wrapper.CylinderShape},Lhe[The.CONE]=function(){return Ohe(Phe.wrapper.ConeShape,Mhe.ConeCollider)?Bhe:new Phe.wrapper.ConeShape},Lhe[The.MESH]=function(){return Ohe(Phe.wrapper.TrimeshShape,Mhe.MeshCollider)?Bhe:new Phe.wrapper.TrimeshShape},Lhe[The.TERRAIN]=function(){return Ohe(Phe.wrapper.TerrainShape,Mhe.TerrainCollider)?Bhe:new Phe.wrapper.TerrainShape},Lhe[The.SIMPLEX]=function(){return Ohe(Phe.wrapper.SimplexShape,Mhe.SimplexCollider)?Bhe:new Phe.wrapper.SimplexShape},Lhe[The.PLANE]=function(){return Ohe(Phe.wrapper.PlaneShape,Mhe.PlaneCollider)?Bhe:new Phe.wrapper.PlaneShape}),Lhe[e]()}(this.type),this._shape.initialize(this),this._shape.onLoad())}onEnable(){this._shape&&this._shape.onEnable()}onDisable(){this._shape&&this._shape.onDisable()}onDestroy(){this._shape&&(this._material&&this._material.off(Xhe.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()}_updateMaterial(){this._shape&&this._shape.setMaterial(this._material)}_updateNeedEvent(e){this.isValid&&(void 0!==e?("onCollisionEnter"!==e&&"onCollisionStay"!==e&&"onCollisionExit"!==e||(this._needCollisionEvent=!0),"onTriggerEnter"!==e&&"onTriggerStay"!==e&&"onTriggerExit"!==e||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())}},c_e.Type=The,c_e.Axis=She,Oc((s_e=l_e).prototype,"attachedRigidBody",[Vue,hl,jue,Wue,que],Object.getOwnPropertyDescriptor(s_e.prototype,"attachedRigidBody"),s_e.prototype),Oc(s_e.prototype,"sharedMaterial",[Xue,Yue,Kue,$ue],Object.getOwnPropertyDescriptor(s_e.prototype,"sharedMaterial"),s_e.prototype),Oc(s_e.prototype,"isTrigger",[Que,Zue],Object.getOwnPropertyDescriptor(s_e.prototype,"isTrigger"),s_e.prototype),Oc(s_e.prototype,"center",[Jue,e_e,t_e],Object.getOwnPropertyDescriptor(s_e.prototype,"center"),s_e.prototype),o_e=Oc(s_e.prototype,"_material",[i_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r_e=Oc(s_e.prototype,"_isTrigger",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a_e=Oc(s_e.prototype,"_center",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),n_e=s_e))||n_e));function u_e(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}h_e||(h_e=function(t){return e({Collider:t,ColliderComponent:t}),t}({}));const __e=new zi,p_e=new zi,d_e=new zi,f_e=new zi,m_e=new zi,g_e=new zi,v_e=new zi,y_e=new zi,x_e=new zi,S_e=new zi,b_e=new zi,T_e=new zi,E_e=new zi(0,0,0),C_e=new zi(0,0,0);function w_e(e=.5,t=.5,i=2,n={}){const s=.5*i,o=n.radialSegments||32,r=n.heightSegments||1,a=void 0===n.capped||n.capped,c=n.arc||2*Math.PI;let l=0;a||(e>0&&l++,t>0&&l++);let h=(o+1)*(r+1);a&&(h+=(o+1)*l+o*l);let u=o*r*6;a&&(u+=o*l*3);const _=new Array(u),p=new Array(3*h),d=new Array(3*h),f=new Array(2*h),m=Math.max(e,t),g=new zi(-m,-s,-m),v=new zi(m,s,m),y=Math.sqrt(m*m+s*s);let x=0,S=0;return function(){const n=[],a=e-t,l=a*a/i*Math.sign(a);for(let e=0;e<=r;e++){const h=[],u=e/r,_=u*a+t;for(let e=0;e<=o;++e){const t=e/o,n=t*c,r=Math.sin(n),a=Math.cos(n);p[3*x]=_*r,p[3*x+1]=u*i-s,p[3*x+2]=_*a,zi.normalize(E_e,zi.set(C_e,r,-l,a)),d[3*x]=E_e.x,d[3*x+1]=E_e.y,d[3*x+2]=E_e.z,f[2*x]=2*(1-t)%1,f[2*x+1]=u,h.push(x),++x}n.push(h)}for(let e=0;e<r;++e)for(let t=0;t<o;++t){const i=n[e][t],s=n[e+1][t],o=n[e+1][t+1],r=n[e][t+1];_[S]=i,++S,_[S]=r,++S,_[S]=s,++S,_[S]=r,++S,_[S]=o,++S,_[S]=s,++S}}(),a&&(t>0&&b(!1),e>0&&b(!0)),{positions:p,normals:d,uvs:f,indices:_,minPos:g,maxPos:v,boundingRadius:y};function b(i){const n=i?e:t,r=i?1:-1,a=x;for(let e=1;e<=o;++e)p[3*x]=0,p[3*x+1]=s*r,p[3*x+2]=0,d[3*x]=0,d[3*x+1]=r,d[3*x+2]=0,f[2*x]=.5,f[2*x+1]=.5,++x;const l=x;for(let e=0;e<=o;++e){const t=e/o*c,i=Math.cos(t),a=Math.sin(t);p[3*x]=n*a,p[3*x+1]=s*r,p[3*x+2]=n*i,d[3*x]=0,d[3*x+1]=r,d[3*x+2]=0,f[2*x]=.5-.5*a*r,f[2*x+1]=.5+.5*i,++x}for(let e=0;e<o;++e){const t=a+e,n=l+e;i?(_[S]=n+1,++S,_[S]=t,++S,_[S]=n,++S):(_[S]=t,++S,_[S]=n+1,++S,_[S]=n,++S)}}}const A_e=new zi(0,0,0),P_e=new zi(0,0,0),R_e=new zi(0,0,0),I_e=new zi(0,0,0),M_e=new zi(0,0,0),O_e=new zi(0,0,0),D_e=new zi(0,0,0),N_e=new zi(0,0,0),L_e=new zi(0,0,0);var B_e=Object.freeze({__proto__:null,box:function(e){const t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,s=(e.width||1)/2,o=(e.height||1)/2,r=(e.length||1)/2,a=[zi.set(m_e,-s,-o,r),zi.set(g_e,s,-o,r),zi.set(v_e,s,o,r),zi.set(y_e,-s,o,r),zi.set(x_e,s,-o,-r),zi.set(S_e,-s,-o,-r),zi.set(b_e,-s,o,-r),zi.set(T_e,s,o,-r)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],h=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],u=[],_=[],p=[],d=[],f=[],m=new zi(-s,-o,-r),g=new zi(s,o,r),v=Math.sqrt(s*s+o*o+r*r);function y(e,t,i){let n,s,o,r;const m=u.length/3,g=c[e],v=l[e],y=h[e];for(r=0;r<=i;r++)for(o=0;o<=t;o++)if(n=o/t,s=r/i,zi.lerp(__e,a[g[0]],a[g[1]],n),zi.lerp(p_e,a[g[0]],a[g[2]],s),zi.subtract(d_e,p_e,a[g[0]]),zi.add(f_e,__e,d_e),u.push(f_e.x,f_e.y,f_e.z),_.push(v[0],v[1],v[2]),p.push(n,s),d.push(y[0],y[1],y[2],y[3]),o<t&&r<i){const e=t+1,i=o+r*e,n=o+(r+1)*e,s=o+1+(r+1)*e,a=o+1+r*e;f.push(m+i,m+a,m+n),f.push(m+n,m+a,m+s)}}return y(0,t,i),y(4,n,i),y(1,t,i),y(5,n,i),y(3,t,n),y(2,t,n),{positions:u,normals:_,uvs:p,tangents:d,indices:f,minPos:m,maxPos:g,boundingRadius:v}},cone:function(e=.5,t=1,i={}){return w_e(0,e,t,i)},cylinder:w_e,plane:function(e){const t=function(e){return(e=u_e(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),{width:i,length:n,widthSegments:s,lengthSegments:o}=t,r=.5*i,a=.5*n,c=[],l=[],h=[],u=new zi(-r,0,-a),_=new zi(r,0,a),p=Math.sqrt(i*i+n*n);zi.set(M_e,-r,0,a),zi.set(O_e,r,0,a),zi.set(D_e,-r,0,-a);for(let e=0;e<=o;e++)for(let i=0;i<=s;i++){const n=i/s,r=e/o;if(zi.lerp(A_e,M_e,O_e,n),zi.lerp(P_e,M_e,D_e,r),zi.subtract(R_e,P_e,M_e),zi.add(I_e,A_e,R_e),c.push(I_e.x,I_e.y,I_e.z),t.includeUV&&l.push(n,r),i<s&&e<o){const t=s+1,n=i+e*t,o=i+(e+1)*t,r=i+1+(e+1)*t,a=i+1+e*t;h.push(n,a,o),h.push(a,r,o)}}const d={positions:c,indices:h,minPos:u,maxPos:_,boundingRadius:p};if(t.includeNormal){const e=(o+1)*(s+1),t=new Array(3*e);d.normals=t;for(let i=0;i<e;++i)t[3*i+0]=0,t[3*i+1]=1,t[3*i+2]=0}return t.includeUV&&(d.uvs=l),d},quad:function(e){const t=u_e(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(e=.5,t={}){const i=void 0!==t.segments?t.segments:32,n=[],s=[],o=[],r=[],a=new zi(-e,-e,-e),c=new zi(e,e,e),l=e;for(let t=0;t<=i;++t){const a=t*Math.PI/i,c=Math.sin(a),l=-Math.cos(a);for(let a=0;a<=i;++a){const h=2*a*Math.PI/i-Math.PI/2,u=Math.sin(h)*c,_=l,p=Math.cos(h)*c,d=a/i,f=t/i;if(n.push(u*e,_*e,p*e),s.push(u,_,p),o.push(d,f),t<i&&a<i){const e=i+1,n=e*t+a,s=e*(t+1)+a,o=e*(t+1)+a+1,c=e*t+a+1;r.push(n,c,s),r.push(c,o,s)}}}return{positions:n,indices:r,normals:s,uvs:o,minPos:a,maxPos:c,boundingRadius:l}},torus:function(e=.4,t=.1,i={}){const n=i.radialSegments||32,s=i.tubularSegments||32,o=i.arc||2*Math.PI,r=[],a=[],c=[],l=[],h=new zi(-e-t,-t,-e-t),u=new zi(e+t,t,e+t),_=e+t;for(let i=0;i<=n;i++)for(let h=0;h<=s;h++){const u=h/s,_=i/n,p=u*o,d=_*Math.PI*2,f=(e+t*Math.cos(d))*Math.sin(p),m=t*Math.sin(d),g=(e+t*Math.cos(d))*Math.cos(p),v=Math.sin(p)*Math.cos(d),y=Math.sin(d),x=Math.cos(p)*Math.cos(d);if(r.push(f,m,g),a.push(v,y,x),c.push(u,_),h<s&&i<n){const e=s+1,t=e*i+h,n=e*(i+1)+h,o=e*(i+1)+h+1,r=e*i+h+1;l.push(t,r,n),l.push(r,o,n)}}return{positions:r,normals:a,uvs:c,indices:l,minPos:h,maxPos:u,boundingRadius:_}},capsule:function(e=.5,t=.5,i=2,n={}){const s=i-e-t,o=n.sides||32,r=n.heightSegments||32,a=t/i,c=s/i,l=e/i,h=Math.floor(r*a),u=Math.floor(r*l),_=Math.floor(r*c),p=s+t-i/2,d=t-i/2,f=t-i/2,m=n.arc||2*Math.PI,g=[],v=[],y=[],x=[],S=Math.max(e,t),b=new zi(-S,-i/2,-S),T=new zi(S,i/2,S),E=i/2;let C=0;const w=[];return function(){for(let e=0;e<=h;++e){const i=e*Math.PI/h/2,n=Math.sin(i),s=-Math.cos(i);for(let i=0;i<=o;++i){const a=2*i*Math.PI/o-Math.PI/2,c=Math.sin(a)*n,l=s,u=Math.cos(a)*n,_=i/o,p=e/r;if(g.push(c*t,l*t+f,u*t),v.push(c,l,u),y.push(_,p),e<h&&i<o){const t=o+1,n=t*e+i,s=t*(e+1)+i,r=t*(e+1)+i+1,a=t*e+i+1;x.push(n,a,s),x.push(a,r,s)}++C}}}(),function(){const i=(e-t)/s;for(let n=0;n<=_;n++){const r=[],l=n/_,h=l*(e-t)+t;for(let e=0;e<=o;++e){const t=e/o,n=l*c+a,u=t*m-m/4,_=Math.sin(u),p=Math.cos(u);g.push(h*_),g.push(l*s+d),g.push(h*p),zi.normalize(N_e,zi.set(L_e,_,-i,p)),v.push(N_e.x),v.push(N_e.y),v.push(N_e.z),y.push(t,n),r.push(C),++C}w.push(r)}for(let e=0;e<_;++e)for(let t=0;t<o;++t){const i=w[e][t],n=w[e+1][t],s=w[e+1][t+1],o=w[e][t+1];x.push(i),x.push(o),x.push(n),x.push(o),x.push(s),x.push(n)}}(),function(){for(let t=0;t<=u;++t){const i=t*Math.PI/u/2+Math.PI/2,n=Math.sin(i),s=-Math.cos(i);for(let i=0;i<=o;++i){const a=2*i*Math.PI/o-Math.PI/2,c=Math.sin(a)*n,h=s,d=Math.cos(a)*n,f=i/o,m=t/r+(1-l);if(g.push(c*e,h*e+p,d*e),v.push(c,h,d),y.push(f,m),t<u&&i<o){const e=o+1,n=e*t+i+w[_][o]+1,s=e*(t+1)+i+w[_][o]+1,r=e*(t+1)+i+1+w[_][o]+1,a=e*t+i+1+w[_][o]+1;x.push(n,a,s),x.push(a,r,s)}}}}(),{positions:g,normals:v,uvs:y,indices:x,minPos:b,maxPos:T,boundingRadius:E}},circle:function(e){const t=function(e){return(e=u_e(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;const n=new Array(1+2*t);n[0]=0;const s=2*Math.PI/t;for(let e=0;e<t;++e){const t=s*e,o=Math.cos(t),r=Math.sin(t),a=3*(e+1);i[a+0]=o,i[a+1]=r,i[a+2]=0;const c=2*e;n[1+c]=e+1,n[1+(c+1)]=e+2}return t>0&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:oo.TRIANGLE_FAN}},translate:function(e,t){const i=t.x||0,n=t.y||0,s=t.z||0,o=Math.floor(e.positions.length/3);for(let t=0;t<o;++t){const o=3*t,r=3*t+1,a=3*t+2;e.positions[o]+=i,e.positions[r]+=n,e.positions[a]+=s}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=s),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=s),e},scale:function(e,t){const i=t.x||0,n=t.y||0,s=t.z||0,o=Math.floor(e.positions.length/3);for(let t=0;t<o;++t){const o=3*t,r=3*t+1,a=3*t+2;e.positions[o]*=i,e.positions[r]*=n,e.positions[a]*=s}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=s),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=s),e.boundingRadius=Math.max(Math.max(i,n),s),e},wireframed:function(e){const{indices:t}=e;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==oo.TRIANGLE_LIST)return e;const i=[[0,1],[1,2],[2,0]],n=[],s={};for(let e=0;e<t.length;e+=3)for(let o=0;o<3;++o){const r=t[e+i[o][0]],a=t[e+i[o][1]],c=r>a?a<<16|r:r<<16|a;void 0===s[c]&&(s[c]=0,n.push(r,a))}return e.indices=n,e.primitiveMode=oo.LINE_LIST,e},wireframe:function(e){const t=[[0,1],[1,2],[2,0]],i=[],n={};for(let s=0;s<e.length;s+=3)for(let o=0;o<3;++o){const r=e[s+t[o][0]],a=e[s+t[o][1]],c=r>a?a<<16|r:r<<16|a;void 0===n[c]&&(n[c]=0,i.push(r,a))}return i},invWinding:function(e){const t=[];for(let i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e,t=1){if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==oo.TRIANGLE_LIST)return"";const i=e.positions,n=e.uvs,s=e.normals,o=e.indices,r=e=>`${o[e]+1}/${o[e]+1}/${o[e]+1}`;let a="";for(let e=0;e<i.length;e+=3)a+=`v ${i[e]*t} ${i[e+1]*t} ${i[e+2]*t}\n`;for(let e=0;e<n.length;e+=2)a+=`vt ${n[e]} ${n[e+1]}\n`;for(let e=0;e<s.length;e+=3)a+=`vn ${s[e]} ${s[e+1]} ${s[e+2]}\n`;for(let e=0;e<o.length;e+=3)a+=`f ${r(e)} ${r(e+1)} ${r(e+2)}\n`;return a},normals:function(e,t,i=1){const n=new Array(2*e.length);for(let s=0;s<e.length/3;++s){const o=3*s,r=6*s;n[r+0]=e[o+0],n[r+1]=e[o+1],n[r+2]=e[o+2],n[r+3]=e[o+0]+t[o+0]*i,n[r+4]=e[o+1]+t[o+1]*i,n[r+5]=e[o+2]+t[o+2]*i}return n},applyDefaultGeometryOptions:u_e});function z_e(e,t){e.__cc_wrapper__=t}function F_e(e){return e.__cc_wrapper__}e("primitives",B_e);const U_e=new zi;function G_e(e){return e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e}var k_e,H_e,V_e,j_e,W_e,q_e,X_e,Y_e,K_e=Object.freeze({__proto__:null,setWrap:z_e,getWrap:F_e,maxComponent:function(e){return Math.max(e.x,Math.max(e.y,e.z))},VEC3_0:U_e,TriggerEventObject:{type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},CollisionEventObject:{type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},shrinkPositions:function(e){const t=[];if(e.length>=3){t[0]=e[0],t[1]=e[1],t[2]=e[2];const i=e.length;for(let n=3;n<i;n+=3){const i=e[n],s=e[n+1],o=e[n+2],r=t.length;let a=!0;for(let e=0;e<r;e+=3)if(_i(i,t[e])&&_i(s,t[e+1])&&_i(o,t[e+2])){a=!1;break}a&&(t.push(i),t.push(s),t.push(o))}}return t},absolute:G_e,cylinder:w_e});let $_e=function(t){return e({BoxCollider:t,BoxColliderComponent:t}),t}((k_e=Wc("cc.BoxCollider"),H_e=al(),V_e=nl(),j_e=Al(zi),W_e=_l(),k_e(q_e=H_e(q_e=V_e(q_e=il((Oc((X_e=class extends h_e{get size(){return this._size}set size(e){zi.strictEquals(this._size,e)||(zi.copy(this._size,e),G_e(this._size),this._shape&&this.shape.updateSize())}get shape(){return this._shape}constructor(){super(The.BOX),Mc(this,"_size",Y_e,this)}}).prototype,"size",[j_e,W_e],Object.getOwnPropertyDescriptor(X_e.prototype,"size"),X_e.prototype),Y_e=Oc(X_e.prototype,"_size",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1,1)}}),q_e=X_e))||q_e)||q_e)||q_e)||q_e));var Q_e,Z_e,J_e,epe,tpe,ipe,npe;let spe=function(t){return e({SphereCollider:t,SphereColliderComponent:t}),t}((Q_e=Wc("cc.SphereCollider"),Z_e=al(),J_e=nl(),epe=_l(),Q_e(tpe=Z_e(tpe=J_e(tpe=il((Oc((ipe=class extends h_e{get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.updateRadius())}get shape(){return this._shape}constructor(){super(The.SPHERE),Mc(this,"_radius",npe,this)}}).prototype,"radius",[epe],Object.getOwnPropertyDescriptor(ipe.prototype,"radius"),ipe.prototype),npe=Oc(ipe.prototype,"_radius",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),tpe=ipe))||tpe)||tpe)||tpe)||tpe));var ope,rpe,ape,cpe,lpe,hpe,upe,_pe,ppe,dpe,fpe,mpe;let gpe=function(t){return e({CapsuleCollider:t,CapsuleColliderComponent:t}),t}((ope=Wc("cc.CapsuleCollider"),rpe=al(),ape=nl(),cpe=_l(),lpe=_l(),hpe=Al(She),upe=_l(),ope(_pe=rpe(_pe=ape(_pe=il((Oc((ppe=class extends h_e{get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}get cylinderHeight(){return this._cylinderHeight}set cylinderHeight(e){this._cylinderHeight!==e&&(this._cylinderHeight=Math.abs(e),this._shape&&this.shape.setCylinderHeight(e))}get direction(){return this._direction}set direction(e){(e=Math.floor(e))<She.X_AXIS||e>She.Z_AXIS||this._direction!==e&&(this._direction=e,this._shape&&this.shape.setDirection(e))}get height(){return 2*this._radius+this._cylinderHeight}set height(e){let t=e-2*this._radius;t<0&&(t=0),this.cylinderHeight=t}get worldHeight(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}get shape(){return this._shape}constructor(){super(The.CAPSULE),Mc(this,"_radius",dpe,this),Mc(this,"_cylinderHeight",fpe,this),Mc(this,"_direction",mpe,this)}_getRadiusScale(){if(null==this.node)return 1;const e=this.node.worldScale;return this._direction===She.Y_AXIS?Math.abs(Ii(e.x,e.z)):this._direction===She.X_AXIS?Math.abs(Ii(e.y,e.z)):Math.abs(Ii(e.x,e.y))}_getHeightScale(){if(null==this.node)return 1;const e=this.node.worldScale;return this._direction===She.Y_AXIS?Math.abs(e.y):this._direction===She.X_AXIS?Math.abs(e.x):Math.abs(e.z)}}).prototype,"radius",[cpe],Object.getOwnPropertyDescriptor(ppe.prototype,"radius"),ppe.prototype),Oc(ppe.prototype,"cylinderHeight",[lpe],Object.getOwnPropertyDescriptor(ppe.prototype,"cylinderHeight"),ppe.prototype),Oc(ppe.prototype,"direction",[hpe,upe],Object.getOwnPropertyDescriptor(ppe.prototype,"direction"),ppe.prototype),dpe=Oc(ppe.prototype,"_radius",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),fpe=Oc(ppe.prototype,"_cylinderHeight",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mpe=Oc(ppe.prototype,"_direction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return She.Y_AXIS}}),_pe=ppe))||_pe)||_pe)||_pe)||_pe));var vpe,ype,xpe,Spe,bpe,Tpe,Epe,Cpe,wpe,Ape,Ppe,Rpe;let Ipe=function(t){return e({CylinderCollider:t,CylinderColliderComponent:t}),t}((vpe=Wc("cc.CylinderCollider"),ype=al(),xpe=nl(),Spe=_l(),bpe=_l(),Tpe=Al(She),Epe=_l(),vpe(Cpe=ype(Cpe=xpe(Cpe=il((Oc((wpe=class extends h_e{get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}get height(){return this._height}set height(e){this._height!==e&&(this._height=Math.abs(e),this._shape&&this.shape.setHeight(e))}get direction(){return this._direction}set direction(e){this._direction!==e&&(e<She.X_AXIS||e>She.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}get shape(){return this._shape}constructor(){super(The.CYLINDER),Mc(this,"_radius",Ape,this),Mc(this,"_height",Ppe,this),Mc(this,"_direction",Rpe,this)}}).prototype,"radius",[Spe],Object.getOwnPropertyDescriptor(wpe.prototype,"radius"),wpe.prototype),Oc(wpe.prototype,"height",[bpe],Object.getOwnPropertyDescriptor(wpe.prototype,"height"),wpe.prototype),Oc(wpe.prototype,"direction",[Tpe,Epe],Object.getOwnPropertyDescriptor(wpe.prototype,"direction"),wpe.prototype),Ape=Oc(wpe.prototype,"_radius",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Ppe=Oc(wpe.prototype,"_height",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Rpe=Oc(wpe.prototype,"_direction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return She.Y_AXIS}}),Cpe=wpe))||Cpe)||Cpe)||Cpe)||Cpe));var Mpe,Ope,Dpe,Npe,Lpe,Bpe,zpe,Fpe,Upe,Gpe,kpe,Hpe;let Vpe=e("ConeCollider",(Mpe=Wc("cc.ConeCollider"),Ope=al(),Dpe=nl(),Npe=_l(),Lpe=_l(),Bpe=Al(She),zpe=_l(),Mpe(Fpe=Ope(Fpe=Dpe(Fpe=il((Oc((Upe=class extends h_e{get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}get height(){return this._height}set height(e){this._height!==e&&(e<0&&(e=0),this._height=e,this._shape&&this.shape.setHeight(e))}get direction(){return this._direction}set direction(e){this._direction!==e&&(e<She.X_AXIS||e>She.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}get shape(){return this._shape}constructor(){super(The.CONE),Mc(this,"_radius",Gpe,this),Mc(this,"_height",kpe,this),Mc(this,"_direction",Hpe,this)}}).prototype,"radius",[Npe],Object.getOwnPropertyDescriptor(Upe.prototype,"radius"),Upe.prototype),Oc(Upe.prototype,"height",[Lpe],Object.getOwnPropertyDescriptor(Upe.prototype,"height"),Upe.prototype),Oc(Upe.prototype,"direction",[Bpe,zpe],Object.getOwnPropertyDescriptor(Upe.prototype,"direction"),Upe.prototype),Gpe=Oc(Upe.prototype,"_radius",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),kpe=Oc(Upe.prototype,"_height",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Hpe=Oc(Upe.prototype,"_direction",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return She.Y_AXIS}}),Fpe=Upe))||Fpe)||Fpe)||Fpe)||Fpe));var jpe,Wpe,qpe,Xpe,Ype,Kpe,$pe,Qpe,Zpe,Jpe;let ede=function(t){return e({MeshCollider:t,MeshColliderComponent:t}),t}((jpe=Wc("cc.MeshCollider"),Wpe=al(),qpe=nl(),Xpe=Al(LB),Ype=_l(),Kpe=_l(),jpe($pe=Wpe($pe=qpe($pe=il((Oc((Qpe=class extends h_e{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,this._shape&&this.shape.setMesh(this._mesh))}get convex(){return this._convex}set convex(e){this._convex!==e&&(this._convex=e)}get shape(){return this._shape}constructor(){super(The.MESH),Mc(this,"_mesh",Zpe,this),Mc(this,"_convex",Jpe,this)}}).prototype,"mesh",[Xpe,Ype],Object.getOwnPropertyDescriptor(Qpe.prototype,"mesh"),Qpe.prototype),Oc(Qpe.prototype,"convex",[cl,Kpe],Object.getOwnPropertyDescriptor(Qpe.prototype,"convex"),Qpe.prototype),Zpe=Oc(Qpe.prototype,"_mesh",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jpe=Oc(Qpe.prototype,"_convex",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$pe=Qpe))||$pe)||$pe)||$pe)||$pe));var tde,ide,nde,sde,ode,rde,ade,cde,lde,hde,ude,_de,pde,dde,fde,mde,gde,vde;let yde=e("ConstantForce",(tde=Wc("cc.ConstantForce"),ide=al(),nde=qc(kue),sde=nl(),ode=vl(),rde=_l(),ade=vl(),cde=_l(),lde=vl(),hde=_l(),ude=vl(),_de=_l(),tde(pde=ide(pde=nde(pde=sde(pde=Yc(pde=il((fde=Oc((dde=class extends Gh{constructor(...e){super(...e),this._rigidBody=null,Mc(this,"_force",fde,this),Mc(this,"_localForce",mde,this),Mc(this,"_torque",gde,this),Mc(this,"_localTorque",vde,this),this._mask=0}get force(){return this._force}set force(e){zi.copy(this._force,e),this._maskUpdate(this._force,1)}get localForce(){return this._localForce}set localForce(e){zi.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}get torque(){return this._torque}set torque(e){zi.copy(this._torque,e),this._maskUpdate(this._torque,4)}get localTorque(){return this._localTorque}set localTorque(e){zi.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}onLoad(){this._rigidBody=this.node.getComponent(kue),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)}lateUpdate(e){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))}_maskUpdate(e,t){e.strictEquals(zi.ZERO)?this._mask&=~t:this._mask|=t}}).prototype,"_force",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),mde=Oc(dde.prototype,"_localForce",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),gde=Oc(dde.prototype,"_torque",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),vde=Oc(dde.prototype,"_localTorque",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),Oc(dde.prototype,"force",[ode,rde],Object.getOwnPropertyDescriptor(dde.prototype,"force"),dde.prototype),Oc(dde.prototype,"localForce",[ade,cde],Object.getOwnPropertyDescriptor(dde.prototype,"localForce"),dde.prototype),Oc(dde.prototype,"torque",[lde,hde],Object.getOwnPropertyDescriptor(dde.prototype,"torque"),dde.prototype),Oc(dde.prototype,"localTorque",[ude,_de],Object.getOwnPropertyDescriptor(dde.prototype,"localTorque"),dde.prototype),pde=dde))||pde)||pde)||pde)||pde)||pde)||pde));var xde,Sde,bde,Tde,Ede,Cde,wde,Ade,Pde,Rde,Ide;const Mde=16842754,Ode=16842755,Dde=16842756,Nde=16842757,Lde=16843025;class Bde{constructor(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}reserve(e){if(this.buffer.byteLength>e)return;let t=this.buffer.byteLength;for(;t<e;)t+=t;const i=new Uint8Array(t);for(let e=0;e<this.length;++e)i[e]=this.buffer[e];this.buffer=i,this._buffView=new DataView(this.buffer.buffer)}assign(e){this.buffer=e,this.length=e.length,this._seekPos=e.byteOffset,this._buffView=new DataView(e.buffer)}writeInt8(e){this.reserve(this.length+1),this._buffView.setInt8(this.length,e),this.length+=1}writeInt16(e){this.reserve(this.length+2),this._buffView.setInt16(this.length,e,!0),this.length+=2}writeInt32(e){this.reserve(this.length+4),this._buffView.setInt32(this.length,e,!0),this.length+=4}writeIntArray(e){this.reserve(this.length+4*e.length);for(let t=0;t<e.length;++t)this._buffView.setInt32(this.length+4*t,e[t],!0);this.length+=4*e.length}writeFloat(e){this.reserve(this.length+4),this._buffView.setFloat32(this.length,e,!0),this.length+=4}writeFloatArray(e){this.reserve(this.length+4*e.length);for(let t=0;t<e.length;++t)this._buffView.setFloat32(this.length+4*t,e[t],!0);this.length+=4*e.length}writeString(e){this.reserve(this.length+e.length+4),this._buffView.setInt32(this.length,e.length,!0);for(let t=0;t<e.length;++t)this._buffView.setInt8(this.length+4+t,e.charCodeAt(t));this.length+=e.length+4}readInt8(){const e=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,e}readInt16(){const e=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,e}readInt(){const e=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,e}readIntArray(e){for(let t=0;t<e.length;++t)e[t]=this._buffView.getInt32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e}readFloat(){const e=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,e}readFloatArray(e){for(let t=0;t<e.length;++t)e[t]=this._buffView.getFloat32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e}readString(){const e=this.readInt();let t="";for(let i=0;i<e;++i)t+=String.fromCharCode(this.readInt8());return t}}Wc("cc.TerrainLayerInfo")((Sde=Oc((xde=class{constructor(){Mc(this,"slot",Sde,this),Mc(this,"tileSize",bde,this),Mc(this,"detailMap",Tde,this),Mc(this,"normalMap",Ede,this),Mc(this,"roughness",Cde,this),Mc(this,"metallic",wde,this)}}).prototype,"slot",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bde=Oc(xde.prototype,"tileSize",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Tde=Oc(xde.prototype,"detailMap",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ede=Oc(xde.prototype,"normalMap",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cde=Oc(xde.prototype,"roughness",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wde=Oc(xde.prototype,"metallic",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xde));let zde=Wc("cc.TerrainLayerBinaryInfo")(Ade=class{constructor(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""}})||Ade,Fde=Wc("cc.TerrainAsset")((Ide=Oc((Rde=class extends xh{constructor(){super(),this._version=0,this._data=null,this._tileSize=1,this._blockCount=[1,1],this._weightMapSize=128,this._lightMapSize=128,this._heights=new Uint16Array,this._weights=new Uint8Array,this._layerBuffer=[-1,-1,-1,-1],this._layerBinaryInfos=[],Mc(this,"_layerInfos",Ide,this)}get _nativeAsset(){return this._data.buffer}set _nativeAsset(e){this._data&&this._data.byteLength===e.byteLength?this._data.set(new Uint8Array(e)):this._data=new Uint8Array(e),this._loadNativeData(this._data)}get version(){return this._version}set tileSize(e){this._tileSize=e}get tileSize(){return this._tileSize}set blockCount(e){this._blockCount=e}get blockCount(){return this._blockCount}set lightMapSize(e){this._lightMapSize=e}get lightMapSize(){return this._lightMapSize}set weightMapSize(e){this._weightMapSize=e}get weightMapSize(){return this._weightMapSize}set heights(e){this._heights=e}get heights(){return this._heights}set weights(e){this._weights=e}get weights(){return this._weights}set layerBuffer(e){this._layerBuffer=e}get layerBuffer(){return this._layerBuffer}set layerInfos(e){this._layerInfos=e}get layerInfos(){return this._layerInfos}get layerBinaryInfos(){return this._layerBinaryInfos}getLayer(e,t,i){const n=4*(t*this.blockCount[0]+e)+i;return e<this.blockCount[0]&&t<this.blockCount[1]&&n<this._layerBuffer.length?this._layerBuffer[n]:-1}getHeight(e,t){const i=32*this._blockCount[0]+1;return.001953125*(this._heights[t*i+e]-32768)}getVertexCountI(){return this._blockCount.length<1?0:32*this._blockCount[0]+1}getVertexCountJ(){return this._blockCount.length<2?0:32*this._blockCount[1]+1}_setNativeData(e){this._data=e}_loadNativeData(e){if(!e||0===e.length)return!1;const t=new Bde;if(t.assign(e),this._version=t.readInt(),this._version===Lde)return!0;if(16842753!==this._version&&this._version!==Mde&&this._version!==Ode&&this._version!==Dde&&this._version!==Nde)return!1;this.tileSize=t.readFloat(),t.readIntArray(this._blockCount),this.weightMapSize=t.readInt16(),this.lightMapSize=t.readInt16();const i=t.readInt();this.heights=new Uint16Array(i);for(let e=0;e<this.heights.length;++e)this.heights[e]=t.readInt16();const n=t.readInt();this.weights=new Uint8Array(n);for(let e=0;e<this.weights.length;++e)this.weights[e]=t.readInt8();if(this._version>=Mde){const e=t.readInt();this.layerBuffer=new Array(e);for(let e=0;e<this.layerBuffer.length;++e)this.layerBuffer[e]=t.readInt16()}if(this._version>=Ode){const e=t.readInt();this._layerBinaryInfos=new Array(e);for(let e=0;e<this._layerBinaryInfos.length;++e)this._layerBinaryInfos[e]=new zde,this._layerBinaryInfos[e].slot=t.readInt(),this._layerBinaryInfos[e].tileSize=t.readFloat(),this._layerBinaryInfos[e].detailMapId=t.readString(),this._version>=Dde&&(this._layerBinaryInfos[e].normalMapId=t.readString(),this._layerBinaryInfos[e].roughness=t.readFloat(),this._layerBinaryInfos[e].metallic=t.readFloat())}return!0}_exportNativeData(){const e=new Bde;e.writeInt32(Nde),e.writeFloat(this.tileSize),e.writeIntArray(this._blockCount),e.writeInt16(this.weightMapSize),e.writeInt16(this.lightMapSize),e.writeInt32(this.heights.length);for(let t=0;t<this.heights.length;++t)e.writeInt16(this.heights[t]);e.writeInt32(this.weights.length);for(let t=0;t<this.weights.length;++t)e.writeInt8(this.weights[t]);e.writeInt32(this.layerBuffer.length);for(let t=0;t<this.layerBuffer.length;++t)e.writeInt16(this.layerBuffer[t]);const t=[];t.length=this.layerInfos.length;for(let e=0;e<t.length;++e){const i=this.layerInfos[e],n=new zde;n.slot=e,n.tileSize=i.tileSize,n.detailMapId=i.detailMap?i.detailMap._uuid:"",n.normalMapId=i.normalMap?i.normalMap._uuid:"",n.metallic=i.metallic,n.roughness=i.roughness,t[e]=n}e.writeInt32(t.length);for(let i=0;i<t.length;++i)e.writeInt32(t[i].slot),e.writeFloat(t[i].tileSize),e.writeString(t[i].detailMapId),e.writeString(t[i].normalMapId),e.writeFloat(t[i].roughness),e.writeFloat(t[i].metallic);return e.buffer}_exportDefaultNativeData(){const e=new Bde;return e.writeInt32(Lde),e.buffer}}).prototype,"_layerInfos",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pde=Rde))||Pde;var Ude,Gde,kde,Hde,Vde,jde,Wde,qde;let Xde=e("TerrainCollider",(Ude=Wc("cc.TerrainCollider"),Gde=al(),kde=nl(),Hde=Al(Fde),Vde=_l(),Ude(jde=Gde(jde=kde(jde=il((Oc((Wde=class extends h_e{get terrain(){return this._terrain}set terrain(e){this._terrain=e,this._shape&&this.shape.setTerrain(this._terrain)}get shape(){return this._shape}constructor(){super(The.TERRAIN),Mc(this,"_terrain",qde,this)}}).prototype,"terrain",[Hde,Vde],Object.getOwnPropertyDescriptor(Wde.prototype,"terrain"),Wde.prototype),qde=Oc(Wde.prototype,"_terrain",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jde=Wde))||jde)||jde)||jde)||jde));var Yde,Kde,$de,Qde,Zde,Jde,efe,tfe,ife,nfe,sfe,ofe,rfe,afe,cfe,lfe,hfe,ufe;let _fe=e("SimplexCollider",(Yde=Wc("cc.SimplexCollider"),Kde=al(),$de=nl(),Qde=Al(bhe),Zde=_l(),Jde=_l(),efe=ll(),tfe=_l(),ife=ll(),nfe=_l(),sfe=ll(),ofe=_l(),Yde(rfe=Kde(rfe=$de(rfe=il((ufe=hfe=class extends h_e{get shapeType(){return this._shapeType}set shapeType(e){this._shapeType=e,this._shape&&this.shape.setShapeType(e)}get vertex0(){return this._vertices[0]}set vertex0(e){zi.copy(this._vertices[0],e),this.updateVertices()}get vertex1(){return this._vertices[1]}set vertex1(e){zi.copy(this._vertices[1],e),this.updateVertices()}get vertex2(){return this._vertices[2]}set vertex2(e){zi.copy(this._vertices[2],e),this.updateVertices()}get vertex3(){return this._vertices[3]}set vertex3(e){zi.copy(this._vertices[3],e),this.updateVertices()}get shape(){return this._shape}get vertices(){return this._vertices}constructor(){super(The.SIMPLEX),Mc(this,"_shapeType",cfe,this),Mc(this,"_vertices",lfe,this)}updateVertices(){this._shape&&this.shape.setVertices(this._vertices)}},hfe.ESimplexType=bhe,Oc((afe=ufe).prototype,"shapeType",[Qde,Zde],Object.getOwnPropertyDescriptor(afe.prototype,"shapeType"),afe.prototype),Oc(afe.prototype,"vertex0",[cl,Jde],Object.getOwnPropertyDescriptor(afe.prototype,"vertex0"),afe.prototype),Oc(afe.prototype,"vertex1",[efe,tfe],Object.getOwnPropertyDescriptor(afe.prototype,"vertex1"),afe.prototype),Oc(afe.prototype,"vertex2",[ife,nfe],Object.getOwnPropertyDescriptor(afe.prototype,"vertex2"),afe.prototype),Oc(afe.prototype,"vertex3",[sfe,ofe],Object.getOwnPropertyDescriptor(afe.prototype,"vertex3"),afe.prototype),cfe=Oc(afe.prototype,"_shapeType",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bhe.TETRAHEDRON}}),lfe=Oc(afe.prototype,"_vertices",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new zi(0,0,0),new zi(0,0,1),new zi(1,0,0),new zi(0,1,0)]}}),rfe=afe))||rfe)||rfe)||rfe)||rfe));var pfe,dfe,ffe,mfe,gfe,vfe,yfe,xfe,Sfe,bfe;_fe||(_fe=e("SimplexCollider",{}));let Tfe=e("PlaneCollider",(pfe=Wc("cc.PlaneCollider"),dfe=al(),ffe=nl(),mfe=Al(zi),gfe=_l(),vfe=_l(),pfe(yfe=dfe(yfe=ffe(yfe=il((Oc((xfe=class extends h_e{get normal(){return this._normal}set normal(e){zi.strictEquals(this._normal,e)||(zi.copy(this._normal,e),this._shape&&this.shape.setNormal(this._normal))}get constant(){return this._constant}set constant(e){this._constant!==e&&(this._constant=e,this._shape&&this.shape.setConstant(this._constant))}get shape(){return this._shape}constructor(){super(The.PLANE),Mc(this,"_normal",Sfe,this),Mc(this,"_constant",bfe,this)}}).prototype,"normal",[mfe,gfe],Object.getOwnPropertyDescriptor(xfe.prototype,"normal"),xfe.prototype),Oc(xfe.prototype,"constant",[cl,vfe],Object.getOwnPropertyDescriptor(xfe.prototype,"constant"),xfe.prototype),Sfe=Oc(xfe.prototype,"_normal",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,1,0)}}),bfe=Oc(xfe.prototype,"_constant",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yfe=xfe))||yfe)||yfe)||yfe)||yfe));var Efe,Cfe,wfe,Afe,Pfe,Rfe,Ife,Mfe,Ofe,Dfe,Nfe,Lfe,Bfe,zfe;let Ffe=e("Constraint",(Efe=Wc("cc.Constraint"),Cfe=qc(kue),wfe=Al(kue),Afe=vl(),Pfe=Al(kue),Rfe=vl(),Ife=vl(),Mfe=Al(kue),Efe(Ofe=Cfe((zfe=Bfe=class extends(Ht(Gh)){get attachedBody(){return this.getComponent(kue)}get connectedBody(){return this._connectedBody}set connectedBody(e){this._connectedBody=e,this._constraint&&this._constraint.setConnectedBody(e)}get enableCollision(){return this._enableCollision}set enableCollision(e){this._enableCollision=e,this._constraint&&this._constraint.setEnableCollision(e)}constructor(e){super(),this.TYPE=void 0,Mc(this,"_enableCollision",Nfe,this),Mc(this,"_connectedBody",Lfe,this),this._constraint=null,this.TYPE=e}onLoad(){Phe.runInEditor&&(this._constraint=function(e){return zhe.INITED||(zhe.INITED=!0,zhe[Ehe.POINT_TO_POINT]=function(){return Ohe(Phe.wrapper.PointToPointConstraint,Mhe.PointToPointConstraint)?Fhe:new Phe.wrapper.PointToPointConstraint},zhe[Ehe.HINGE]=function(){return Ohe(Phe.wrapper.HingeConstraint,Mhe.HingeConstraint)?Fhe:new Phe.wrapper.HingeConstraint},zhe[Ehe.CONE_TWIST]=function(){return Ohe(Phe.wrapper.ConeTwistConstraint,Mhe.ConeTwistConstraint)?Fhe:new Phe.wrapper.ConeTwistConstraint}),zhe[e]()}(this.TYPE),this._constraint.initialize(this))}onEnable(){this._constraint&&this._constraint.onEnable()}onDisable(){this._constraint&&this._constraint.onDisable()}onDestroy(){this._constraint&&this._constraint.onDestroy()}},Bfe.Type=Ehe,Oc((Dfe=zfe).prototype,"attachedBody",[wfe,hl,Afe],Object.getOwnPropertyDescriptor(Dfe.prototype,"attachedBody"),Dfe.prototype),Oc(Dfe.prototype,"connectedBody",[Pfe,Rfe],Object.getOwnPropertyDescriptor(Dfe.prototype,"connectedBody"),Dfe.prototype),Oc(Dfe.prototype,"enableCollision",[Ife],Object.getOwnPropertyDescriptor(Dfe.prototype,"enableCollision"),Dfe.prototype),Nfe=Oc(Dfe.prototype,"_enableCollision",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Lfe=Oc(Dfe.prototype,"_connectedBody",[Mfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ofe=Dfe))||Ofe)||Ofe));var Ufe,Gfe,kfe,Hfe,Vfe,jfe,Wfe,qfe,Xfe,Yfe,Kfe,$fe,Qfe,Zfe;Ffe||(Ffe=e("Constraint",{}));let Jfe=e("HingeConstraint",(Ufe=Wc("cc.HingeConstraint"),Gfe=al(),kfe=nl(),Hfe=Al(zi),Vfe=Al(zi),jfe=Al(zi),Wfe=Zc("axisA"),qfe=Zc("pivotA"),Xfe=Zc("pivotB"),Ufe(Yfe=Gfe(Yfe=kfe((Oc((Kfe=class extends Ffe{get pivotA(){return this._pivotA}set pivotA(e){zi.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}get pivotB(){return this._pivotB}set pivotB(e){zi.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}get axis(){return this._axis}set axis(e){zi.copy(this._axis,e),this.constraint.setAxis(this._axis)}get constraint(){return this._constraint}constructor(){super(Ehe.HINGE),Mc(this,"_axis",$fe,this),Mc(this,"_pivotA",Qfe,this),Mc(this,"_pivotB",Zfe,this)}}).prototype,"pivotA",[Hfe],Object.getOwnPropertyDescriptor(Kfe.prototype,"pivotA"),Kfe.prototype),Oc(Kfe.prototype,"pivotB",[Vfe],Object.getOwnPropertyDescriptor(Kfe.prototype,"pivotB"),Kfe.prototype),Oc(Kfe.prototype,"axis",[jfe],Object.getOwnPropertyDescriptor(Kfe.prototype,"axis"),Kfe.prototype),$fe=Oc(Kfe.prototype,"_axis",[Qc,Wfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),Qfe=Oc(Kfe.prototype,"_pivotA",[Qc,qfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),Zfe=Oc(Kfe.prototype,"_pivotB",[Qc,Xfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),Yfe=Kfe))||Yfe)||Yfe)||Yfe));var eme,tme,ime,nme,sme,ome,rme,ame,cme;let lme=e("PointToPointConstraint",(eme=Wc("cc.PointToPointConstraint"),tme=al(),ime=nl(),nme=Al(zi),sme=Al(zi),eme(ome=tme(ome=ime((Oc((rme=class extends Ffe{get pivotA(){return this._pivotA}set pivotA(e){zi.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}get pivotB(){return this._pivotB}set pivotB(e){zi.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}get constraint(){return this._constraint}constructor(){super(Ehe.POINT_TO_POINT),Mc(this,"_pivotA",ame,this),Mc(this,"_pivotB",cme,this)}}).prototype,"pivotA",[nme],Object.getOwnPropertyDescriptor(rme.prototype,"pivotA"),rme.prototype),Oc(rme.prototype,"pivotB",[sme],Object.getOwnPropertyDescriptor(rme.prototype,"pivotB"),rme.prototype),ame=Oc(rme.prototype,"_pivotA",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),cme=Oc(rme.prototype,"_pivotB",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),ome=rme))||ome)||ome)||ome));n.PhysicsSystem=$he,n.PhysicsMaterial=Xhe,n.PhysicsRayResult=Yhe,n.ConstantForce=yde;var hme=Object.freeze({__proto__:null,PhysicsSystem:$he,PhysicsRayResult:Yhe,get Collider(){return h_e},BoxCollider:$_e,SphereCollider:spe,CapsuleCollider:gpe,MeshCollider:ede,CylinderCollider:Ipe,ConeCollider:Vpe,TerrainCollider:Xde,get SimplexCollider(){return _fe},PlaneCollider:Tfe,get Constraint(){return Ffe},HingeConstraint:Jfe,PointToPointConstraint:lme,get RigidBody(){return kue},PhysicsMaterial:Xhe,ConstantForce:yde,selector:Phe,utils:K_e,get ERigidBodyType(){return xhe},get EAxisDirection(){return She},get ESimplexType(){return bhe},get EColliderType(){return The},get EConstraintType(){return Ehe},get PhysicsGroup(){return Che}});e("physics",hme);const ume=new yhe.Vec3,_me=new yhe.Vec3;function pme(e,t){e.checkCollisionResponse=!t.queryTrigger,e.collisionFilterGroup=-1,e.collisionFilterMask=t.mask}function dme(e,t){e._assign(t.hitPointWorld,t.distance,F_e(t.shape).collider,t.hitNormalWorld)}function fme(e){e.aabbNeedsUpdate=!0,e.updateMassProperties(),e.updateBoundingRadius()}const mme={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},gme=new yhe.Quaternion,vme=new yhe.Vec3,yme=new yhe.Vec3;class xme{constructor(){this._offset=new yhe.Vec3,this._orient=new yhe.Quaternion,this._index=-1,this.onTriggerListener=this._onTrigger.bind(this),this._isBinding=!1}updateEventListener(){}get impl(){return this._shape}get collider(){return this._collider}get attachedRigidBody(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}get sharedBody(){return this._sharedBody}setMaterial(e){if(null==e)this._shape.material=null;else{null==xme.idToMaterial[e.id]&&(xme.idToMaterial[e.id]=new yhe.Material(e.id)),this._shape.material=xme.idToMaterial[e.id];const t=this._shape.material;t.friction=e.friction,t.restitution=e.restitution;const i=yhe.CC_CONFIG.correctInelastic;t.correctInelastic=0===t.restitution?i:0}}setAsTrigger(e){this._shape.collisionResponse=!e,this._index>=0&&this._body.updateHasTrigger()}setCenter(e){this._setCenter(e),this._index>=0&&fme(this._body)}setAttachedBody(e){if(e){if(this._sharedBody){if(this._sharedBody.wrappedBody===e.body)return;this._sharedBody.reference=!1}this._sharedBody=$he.instance.physicsWorld.getSharedBody(e.node),this._sharedBody.reference=!0}else this._sharedBody&&(this._sharedBody.reference=!1),this._sharedBody=$he.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0}getAABB(e){ji.copy(gme,this._collider.node.worldRotation),this._shape.calculateWorldAABB(yhe.Vec3.ZERO,gme,vme,yme),zi.subtract(e.halfExtents,yme,vme),zi.multiplyScalar(e.halfExtents,e.halfExtents,.5),zi.add(e.center,this._collider.node.worldPosition,this._collider.center)}getBoundingSphere(e){e.radius=this._shape.boundingSphereRadius,zi.add(e.center,this._collider.node.worldPosition,this._collider.center)}get _body(){return this._sharedBody.body}initialize(e){this._collider=e,this._isBinding=!0,this._sharedBody=$he.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),z_e(this._shape,this),this._shape.addEventListener("cc-trigger",this.onTriggerListener)}onComponentSet(){}onLoad(){this.setMaterial(this._collider.sharedMaterial),this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)}onEnable(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0}onDisable(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1}onDestroy(){this._sharedBody.reference=!1,this._shape.removeEventListener("cc-trigger",this.onTriggerListener),delete yhe.World.idToShapeMap[this._shape.id],this._sharedBody=null,z_e(this._shape,null),this._offset=null,this._orient=null,this._shape=null,this._collider=null,this.onTriggerListener=null}getGroup(){return this._body.collisionFilterGroup}setGroup(e){this._body.collisionFilterGroup=e,this._body.isAwake()||this._body.wakeUp()}addGroup(e){this._body.collisionFilterGroup|=e,this._body.isAwake()||this._body.wakeUp()}removeGroup(e){this._body.collisionFilterGroup&=~e,this._body.isAwake()||this._body.wakeUp()}getMask(){return this._body.collisionFilterMask}setMask(e){this._body.collisionFilterMask=e,this._body.isAwake()||this._body.wakeUp()}addMask(e){this._body.collisionFilterMask|=e,this._body.isAwake()||this._body.wakeUp()}removeMask(e){this._body.collisionFilterMask&=~e,this._body.isAwake()||this._body.wakeUp()}setScale(e){this._setCenter(this._collider.center)}setIndex(e){this._index=e}setOffsetAndOrient(e,t){zi.copy(e,this._offset),ji.copy(t,this._orient),this._offset=e,this._orient=t}_setCenter(e){const t=this._offset;zi.subtract(t,this._sharedBody.node.worldPosition,this._collider.node.worldPosition),zi.add(t,t,e),zi.multiply(t,t,this._collider.node.worldScale)}_onTrigger(e){mme.type=e.event;const t=F_e(e.selfShape),i=F_e(e.otherShape);t&&t.collider.needTriggerEvent&&(mme.selfCollider=t.collider,mme.otherCollider=i?i.collider:null,mme.impl=e,this._collider.emit(mme.type,mme))}}xme.idToMaterial={},ei($he,"PhysicsSystem",[{name:"ins",newName:"instance"}]),ei($he.prototype,"PhysicsSystem.prototype",[{name:"deltaTime",newName:"fixedTimeStep"},{name:"maxSubStep",newName:"maxSubSteps"}]),ti($he.prototype,"PhysicsSystem.prototype",[{name:"useFixedTime"},{name:"useCollisionMatrix"},{name:"updateCollisionMatrix"},{name:"resetCollisionMatrix"},{name:"isCollisionGroup"},{name:"setCollisionGroup"}]),ei(h_e.prototype,"Collider.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"},{name:"TYPE",newName:"type"}]),ei(h_e,"Collider",[{name:"EColliderType",newName:"Type"},{name:"EAxisDirection",newName:"Axis"}]),ei(Ffe,"Constraint",[{name:"EConstraintType",newName:"Type"}]),ei($_e.prototype,"BoxCollider.prototype",[{name:"boxShape",newName:"shape"}]),ei(spe.prototype,"SphereCollider.prototype",[{name:"sphereShape",newName:"shape"}]),ei(gpe.prototype,"CapsuleCollider.prototype",[{name:"capsuleShape",newName:"shape"}]),ei(kue.prototype,"RigidBody.prototype",[{name:"rigidBody",newName:"body"}]),ei(kue,"RigidBody",[{name:"ERigidBodyType",newName:"Type"}]),ti(kue.prototype,"RigidBody.prototype",[{name:"fixedRotation"}]),n.RigidBodyComponent=kue,De.setClassAlias(kue,"cc.RigidBodyComponent"),n.ColliderComponent=h_e,De.setClassAlias(h_e,"cc.ColliderComponent"),n.BoxColliderComponent=$_e,De.setClassAlias($_e,"cc.BoxColliderComponent"),n.SphereColliderComponent=spe,De.setClassAlias(spe,"cc.SphereColliderComponent"),De.setClassAlias(gpe,"cc.CapsuleColliderComponent"),De.setClassAlias(ede,"cc.MeshColliderComponent"),De.setClassAlias(Ipe,"cc.CylinderColliderComponent"),n.PhysicMaterial=Xhe,De.setClassAlias(Xhe,"cc.PhysicMaterial"),n.physics=hme;const Sme=new ji;class bme{get isBodyA(){if(this.impl){const e=this.event.selfCollider.shape.impl,t=this.impl.bj;return e.body.id===t.id}return!1}constructor(e){this.impl=null,this.event=void 0,this.event=e}getLocalPointOnA(e){this.impl&&zi.copy(e,this.impl.rj)}getLocalPointOnB(e){this.impl&&zi.copy(e,this.impl.ri)}getWorldPointOnA(e){this.impl&&zi.add(e,this.impl.rj,this.impl.bj.position)}getWorldPointOnB(e){this.impl&&zi.add(e,this.impl.ri,this.impl.bi.position)}getLocalNormalOnA(e){this.impl&&(this.getWorldNormalOnA(e),ji.conjugate(Sme,this.impl.bi.quaternion),zi.transformQuat(e,e,Sme))}getLocalNormalOnB(e){this.impl&&(ji.conjugate(Sme,this.impl.bj.quaternion),zi.transformQuat(e,this.impl.ni,Sme))}getWorldNormalOnA(e){this.impl&&(this.getWorldNormalOnB(e),this.isBodyA||zi.negate(e,e))}getWorldNormalOnB(e){this.impl&&zi.copy(e,this.impl.ni)}}const Tme=new zi,Eme=new ji,Cme=[],wme={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null};class Ame{static getSharedBody(e,t,i){const n=e.uuid;let s;if(Ame.sharedBodesMap.has(n))s=Ame.sharedBodesMap.get(n);else{s=new Ame(e,t);const i=Che.DEFAULT,n=$he.instance.collisionMatrix[i];s.body.collisionFilterGroup=i,s.body.collisionFilterMask=n,Ame.sharedBodesMap.set(e.uuid,s)}if(i){s.wrappedBody=i;const e=i.rigidBody.group,t=$he.instance.collisionMatrix[e];s.body.collisionFilterGroup=e,s.body.collisionFilterMask=t}return s}set enabled(e){e?this.index<0&&(this.index=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitial()):this.index>=0&&(0===this.wrappedShapes.length&&null==this.wrappedBody||0===this.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled)&&(this.body.sleep(),this.index=-1,this.wrappedWorld.removeSharedBody(this))}set reference(e){e?this.ref++:this.ref--,0===this.ref&&this.destroy()}constructor(e,t){this.node=void 0,this.wrappedWorld=void 0,this.body=void 0,this.wrappedShapes=[],this.wrappedJoints0=[],this.wrappedJoints1=[],this.wrappedBody=null,this.index=-1,this.ref=0,this.onCollidedListener=this.onCollided.bind(this),this.wrappedWorld=t,this.node=e,this.body=new yhe.Body,z_e(this.body,this),this.body.collisionFilterGroup=$he.PhysicsGroup.DEFAULT,this.body.sleepSpeedLimit=$he.instance.sleepThreshold,this.body.material=this.wrappedWorld.impl.defaultMaterial,this.body.addEventListener("cc-collide",this.onCollidedListener)}addShape(e){if(this.wrappedShapes.indexOf(e)<0){const t=this.body.shapes.length;this.body.addShape(e.impl),this.wrappedShapes.push(e),e.setIndex(t);const i=this.body.shapeOffsets[t],n=this.body.shapeOrientations[t];e.setOffsetAndOrient(i,n),this.body.isSleeping()&&this.body.wakeUp()}}removeShape(e){const t=this.wrappedShapes.indexOf(e);t>=0&&(V(this.wrappedShapes,t),this.body.removeShape(e.impl),e.setIndex(-1),this.body.isSleeping()&&this.body.wakeUp())}addJoint(e,t){t?this.wrappedJoints1.indexOf(e)<0&&this.wrappedJoints1.push(e):this.wrappedJoints0.indexOf(e)<0&&this.wrappedJoints0.push(e)}removeJoint(e,t){if(t){const t=this.wrappedJoints1.indexOf(e);t>=0&&V(this.wrappedJoints1,t)}else{const t=this.wrappedJoints0.indexOf(e);t>=0&&V(this.wrappedJoints0,t)}}syncSceneToPhysics(){const e=this.node,t=this.body;e.hasChangedFlags&&(t.isSleeping()&&t.wakeUp(),zi.copy(t.position,e.worldPosition),ji.copy(t.quaternion,e.worldRotation),t.aabbNeedsUpdate=!0,e.hasChangedFlags&Cg.SCALE&&this.syncScale())}syncPhysicsToScene(){const e=this.node,t=this.body;t.type===xhe.DYNAMIC&&(t.isSleeping()||(zi.copy(Tme,t.position),ji.copy(Eme,t.quaternion),e.worldPosition=Tme,e.worldRotation=Eme))}syncInitial(){const e=this.node,t=this.body;zi.copy(t.position,e.worldPosition),ji.copy(t.quaternion,e.worldRotation),zi.copy(t.previousPosition,e.worldPosition),ji.copy(t.previousQuaternion,e.worldRotation),t.aabbNeedsUpdate=!0,this.syncScale(),t.isSleeping()&&t.wakeUp()}syncScale(){for(let e=0;e<this.wrappedShapes.length;e++)this.wrappedShapes[e].setScale(this.node.worldScale);for(let e=0;e<this.wrappedJoints0.length;e++)this.wrappedJoints0[e].updateScale0();for(let e=0;e<this.wrappedJoints1.length;e++)this.wrappedJoints1[e].updateScale1();fme(this.body)}destroy(){z_e(this.body,null),this.body.removeEventListener("cc-collide",this.onCollidedListener),Ame.sharedBodesMap.delete(this.node.uuid),delete yhe.World.idToBodyMap[this.body.id],this.node=null,this.wrappedWorld=null,this.body=null,this.wrappedShapes=null,this.wrappedJoints0=null,this.wrappedJoints1=null,this.onCollidedListener=null}onCollided(e){wme.type=e.event;const t=F_e(e.selfShape),i=F_e(e.otherShape);if(t&&t.collider.needCollisionEvent){Cme.push.apply(Cme,wme.contacts),wme.contacts.length=0,wme.impl=e,wme.selfCollider=t.collider,wme.otherCollider=i?i.collider:null;let n=0;if("onCollisionExit"!==wme.type)for(n=0;n<e.contacts.length;n++){const t=e.contacts[n];if(Cme.length>0){const e=Cme.pop();e.impl=t,wme.contacts.push(e)}else{const e=new bme(wme);e.impl=t,wme.contacts.push(e)}}for(n=0;n<this.wrappedShapes.length;n++)this.wrappedShapes[n].collider.emit(wme.type,wme)}}}Ame.sharedBodesMap=new Map;class Pme{get impl(){return this._world}setDefaultMaterial(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=xme.idToMaterial[e.id]&&(xme.idToMaterial[e.id]=this._world.defaultMaterial)}setAllowSleep(e){this._world.allowSleep=e}setGravity(e){zi.copy(this._world.gravity,e)}constructor(){this.bodies=[],this.constraints=[],this._world=void 0,this._world=new yhe.World,this._world.broadphase=new yhe.NaiveBroadphase,this._world.solver.iterations=10,this._world.solver.tolerance=1e-4,this._world.defaultContactMaterial.contactEquationStiffness=1e6,this._world.defaultContactMaterial.frictionEquationStiffness=1e6,this._world.defaultContactMaterial.contactEquationRelaxation=3,this._world.defaultContactMaterial.frictionEquationRelaxation=3}destroy(){(this.constraints.length||this.bodies.length)&&d("You should destroy all physics component first."),this._world.broadphase=null,this._world=null}emitEvents(){this._world.emitTriggeredEvents(),this._world.emitCollisionEvents()}syncSceneToPhysics(){for(let e=0;e<this.bodies.length;e++)this.bodies[e].syncSceneToPhysics()}syncAfterEvents(){this.syncSceneToPhysics()}step(e,t,i){if(0!==this.bodies.length){this._world.step(e,t,i);for(let e=0;e<this.bodies.length;e++)this.bodies[e].syncPhysicsToScene()}}raycastClosest(e,t,i){Mme(e,t.maxDistance),pme(Ome,t);const n=this._world.raycastClosest(Rme,Ime,Ome,Pme.rayResult);return n&&dme(i,Pme.rayResult),n}raycast(e,t,i,n){return Mme(e,t.maxDistance),pme(Ome,t),this._world.raycastAll(Rme,Ime,Ome,(e=>{const t=i.add();dme(t,e),n.push(t)}))}getSharedBody(e,t){return Ame.getSharedBody(e,this,t)}addSharedBody(e){this.bodies.indexOf(e)<0&&(this.bodies.push(e),this._world.addBody(e.body))}removeSharedBody(e){const t=this.bodies.indexOf(e);t>=0&&(V(this.bodies,t),this._world.remove(e.body))}addConstraint(e){this.constraints.indexOf(e)<0&&(this.constraints.push(e),this._world.addConstraint(e.impl))}removeConstraint(e){const t=this.constraints.indexOf(e);t>=0&&(V(this.constraints,t),this._world.removeConstraint(e.impl))}}Pme.rayResult=new yhe.RaycastResult;const Rme=new yhe.Vec3,Ime=new yhe.Vec3;function Mme(e,t){zi.copy(Rme,e.o),e.computeHit(Ime,t)}const Ome={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackfaces:!0},Dme=new yhe.Vec3,Nme=new zi,Lme=new zi,Bme=new yhe.AABB,zme=new yhe.AABB,Fme=new yhe.Transform;yhe.Heightfield.prototype.calculateWorldAABB=function(e,t,i,n){const s=Fme,o=zme;zi.copy(s.position,e),ji.copy(s.quaternion,t);const r=this.elementSize,a=this.data;Bme.lowerBound.set(0,0,this.minValue),Bme.upperBound.set((a.length-1)*r,(a[0].length-1)*r,this.maxValue),Bme.toWorldFrame(s,o),i.copy(o.lowerBound),n.copy(o.upperBound)};const Ume=function(){const e=[[0,3,2],[0,1,3],[0,2,1],[1,2,3]];return function(t){return new yhe.ConvexPolyhedron(t,e)}}();yhe.World.staticBody=new yhe.Body,yhe.World.idToConstraintMap={};class Gme{setConnectedBody(e){const t=F_e(this.impl.bodyB);t&&t.removeJoint(this,1),e?(this._impl.bodyB=e.body.impl,e.body.sharedBody.addJoint(this,1)):this._impl.bodyB=yhe.World.staticBody;const i=this._impl.bodyB;this._impl.equations.forEach((e=>{e.bj=i}))}setEnableCollision(e){this._impl.collideConnected=e}get impl(){return this._impl}get constraint(){return this._com}initialize(e){this._com=e,this._rigidBody=e.attachedBody,this.onComponentSet(),this.setEnableCollision(e.enableCollision),yhe.World.idToConstraintMap[this._impl.id]=this._impl}onComponentSet(){}updateScale0(){}updateScale1(){}onEnable(){const e=this._rigidBody.body.sharedBody;e.wrappedWorld.addConstraint(this),e.addJoint(this,0);const t=this.constraint.connectedBody;t&&t.body.sharedBody.addJoint(this,1)}onDisable(){const e=this._rigidBody.body.sharedBody;e.wrappedWorld.removeConstraint(this),e.removeJoint(this,0);const t=this.constraint.connectedBody;t&&t.body.sharedBody.removeJoint(this,1)}onDestroy(){delete yhe.World.idToConstraintMap[this._impl.id],this._com=null,this._rigidBody=null,this._impl=null}}const kme=new zi,Hme=new zi;var Vme,jme,Wme,qme,Xme,Yme,Kme,$me,Qme;Phe.register("cannon.js",{PhysicsWorld:Pme,RigidBody:class{constructor(){this._isEnabled=!1}get isAwake(){return this.impl.isAwake()}get isSleepy(){return this.impl.isSleepy()}get isSleeping(){return this.impl.isSleeping()}setAllowSleep(e){this.impl.type===yhe.Body.DYNAMIC&&(this.impl.allowSleep=e,this._wakeUpIfSleep())}setMass(e){this.impl.type===yhe.Body.DYNAMIC&&(this.impl.mass=e,this.impl.updateMassProperties(),this._wakeUpIfSleep())}setType(e){switch(e){case xhe.DYNAMIC:this.impl.type=yhe.Body.DYNAMIC,this.impl.allowSleep=this._rigidBody.allowSleep,this.setMass(this._rigidBody.mass);break;case xhe.KINEMATIC:this.impl.type=yhe.Body.KINEMATIC,this.impl.mass=0,this.impl.allowSleep=!1,this.impl.sleepState=yhe.Body.AWAKE,this.impl.updateMassProperties();break;case xhe.STATIC:default:this.impl.type=yhe.Body.STATIC,this.impl.mass=0,this.impl.allowSleep=!0,this.impl.updateMassProperties(),this.clearState()}}setLinearDamping(e){this.impl.linearDamping=e}setAngularDamping(e){this.impl.angularDamping=e}useGravity(e){this.impl.useGravity=e,this._wakeUpIfSleep()}useCCD(e){this.impl.ccdSpeedThreshold=e?.01:-1}isUsingCCD(){return-1!==this.impl.ccdSpeedThreshold}setLinearFactor(e){zi.copy(this.impl.linearFactor,e),this._wakeUpIfSleep()}setAngularFactor(e){zi.copy(this.impl.angularFactor,e);const t=zi.equals(this.impl.angularFactor,zi.ZERO);t!==this.impl.fixedRotation&&(this.impl.fixedRotation=t,this.impl.updateMassProperties()),this._wakeUpIfSleep()}get impl(){return this._sharedBody.body}get rigidBody(){return this._rigidBody}get sharedBody(){return this._sharedBody}get isEnabled(){return this._isEnabled}initialize(e){this._rigidBody=e,this._sharedBody=$he.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0,this._sharedBody.wrappedBody=this}onLoad(){}onEnable(){this._isEnabled=!0,this.setType(this._rigidBody.type),this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.useGravity(this._rigidBody.useGravity),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this._sharedBody.enabled=!0}onDisable(){this._isEnabled=!1,this._sharedBody.enabled=!1}onDestroy(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null}clearVelocity(){this.impl.velocity.setZero(),this.impl.angularVelocity.setZero()}clearForces(){this.impl.force.setZero(),this.impl.torque.setZero()}clearState(){this.clearVelocity(),this.clearForces()}wakeUp(){return this.impl.wakeUp()}sleep(){return this.impl.sleep()}setSleepThreshold(e){this.impl.sleepSpeedLimit=e,this._wakeUpIfSleep()}getSleepThreshold(){return this.impl.sleepSpeedLimit}getLinearVelocity(e){return zi.copy(e,this.impl.velocity),e}setLinearVelocity(e){this._wakeUpIfSleep(),zi.copy(this.impl.velocity,e)}getAngularVelocity(e){return zi.copy(e,this.impl.angularVelocity),e}setAngularVelocity(e){this._wakeUpIfSleep(),zi.copy(this.impl.angularVelocity,e)}applyForce(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=zi.ZERO),this.impl.applyForce(zi.copy(ume,e),zi.copy(_me,t))}applyImpulse(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=zi.ZERO),this.impl.applyImpulse(zi.copy(ume,e),zi.copy(_me,t))}applyLocalForce(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=zi.ZERO),this.impl.applyLocalForce(zi.copy(ume,e),zi.copy(_me,t))}applyLocalImpulse(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=zi.ZERO),this.impl.applyLocalImpulse(zi.copy(ume,e),zi.copy(_me,t))}applyTorque(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),zi.add(this.impl.torque,this.impl.torque,e)}applyLocalTorque(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),zi.copy(ume,e),this.impl.vectorToWorldFrame(ume,ume),zi.add(this.impl.torque,this.impl.torque,ume)}getGroup(){return this.impl.collisionFilterGroup}setGroup(e){this.impl.collisionFilterGroup=e,this._wakeUpIfSleep()}addGroup(e){this.impl.collisionFilterGroup|=e,this._wakeUpIfSleep()}removeGroup(e){this.impl.collisionFilterGroup&=~e,this._wakeUpIfSleep()}getMask(){return this.impl.collisionFilterMask}setMask(e){this.impl.collisionFilterMask=e,this._wakeUpIfSleep()}addMask(e){this.impl.collisionFilterMask|=e,this._wakeUpIfSleep()}removeMask(e){this.impl.collisionFilterMask&=~e,this._wakeUpIfSleep()}_wakeUpIfSleep(){this.impl.isAwake()||this.impl.wakeUp()}},BoxShape:class extends xme{get collider(){return this._collider}get impl(){return this._shape}constructor(){super(),this.halfExtent=void 0,this.halfExtent=new yhe.Vec3(.5,.5,.5),this._shape=new yhe.Box(this.halfExtent.clone())}updateSize(){zi.multiplyScalar(this.halfExtent,this.collider.size,.5);const e=G_e(U_e.set(this.collider.node.worldScale)),t=this.halfExtent.x*e.x,i=this.halfExtent.y*e.y,n=this.halfExtent.z*e.z,s=$he.instance.minVolumeSize;this.impl.halfExtents.x=di(t,s,Number.MAX_VALUE),this.impl.halfExtents.y=di(i,s,Number.MAX_VALUE),this.impl.halfExtents.z=di(n,s,Number.MAX_VALUE),this.impl.updateConvexPolyhedronRepresentation(),-1!==this._index&&fme(this._body)}onLoad(){super.onLoad(),this.updateSize()}setScale(e){super.setScale(e),this.updateSize()}},SphereShape:class extends xme{get collider(){return this._collider}get impl(){return this._shape}updateRadius(){const e=Math.abs(Ri(this.collider.node.worldScale));this.impl.radius=di(this.collider.radius*Math.abs(e),$he.instance.minVolumeSize,Number.MAX_VALUE),this.impl.updateBoundingSphereRadius(),-1!==this._index&&fme(this._body)}constructor(e=.5){super(),this._shape=new yhe.Sphere(e)}onLoad(){super.onLoad(),this.updateRadius()}setScale(e){super.setScale(e),this.updateRadius()}},TrimeshShape:class extends xme{get collider(){return this._collider}get impl(){return this._shape}setMesh(e){if(!this._isBinding)return;const t=e;if(null!=this._shape)if(t&&t.renderingSubMeshes.length>0){const e=t.renderingSubMeshes[0].geometricInfo.positions,i=t.renderingSubMeshes[0].geometricInfo.indices;this.updateProperties(e,i)}else this.updateProperties(new Float32Array,new Uint16Array);else if(t&&t.renderingSubMeshes.length>0){const e=t.renderingSubMeshes[0].geometricInfo.positions,i=t.renderingSubMeshes[0].geometricInfo.indices;this._shape=new yhe.Trimesh(e,i)}else this._shape=new yhe.Trimesh(new Float32Array,new Uint16Array)}onComponentSet(){this.setMesh(this.collider.mesh)}onLoad(){super.onLoad(),this.setMesh(this.collider.mesh)}setScale(e){super.setScale(e),zi.copy(Dme,e),this.impl.setScale(Dme)}updateProperties(e,t){this.impl.vertices=new Float32Array(e),this.impl.indices=new Int16Array(t),this.impl.normals=new Float32Array(t.length),this.impl.aabb=new yhe.AABB,this.impl.edges=[],this.impl.tree=new yhe.Octree(new yhe.AABB),this.impl.updateEdges(),this.impl.updateNormals(),this.impl.updateAABB(),this.impl.updateBoundingSphereRadius(),this.impl.updateTree(),this.impl.setScale(this.impl.scale),this._index>=0&&fme(this._body)}},CylinderShape:class extends xme{get collider(){return this._collider}get impl(){return this._shape}setRadius(e){this.updateProperties(this.collider.radius,this.collider.height,yhe.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&fme(this._body)}setHeight(e){this.updateProperties(this.collider.radius,this.collider.height,yhe.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&fme(this._body)}setDirection(e){this.updateProperties(this.collider.radius,this.collider.height,yhe.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&fme(this._body)}constructor(e=.5,t=2,i=She.Y_AXIS){super(),this._shape=new yhe.Cylinder(e,e,t,yhe.CC_CONFIG.numSegmentsCylinder,i===She.Y_AXIS)}onLoad(){super.onLoad(),this.setRadius(this.collider.radius)}setScale(e){super.setScale(e),this.setRadius(this.collider.radius)}updateProperties(e,t,i,n,s){let o=t,r=e;const a=Math.cos,c=Math.sin,l=Math.abs,h=Math.max;1===n?(o=l(s.y)*t,r=h(l(s.x),l(s.z))*e):2===n?(o=l(s.z)*t,r=h(l(s.x),l(s.y))*e):(o=l(s.x)*t,r=h(l(s.y),l(s.z))*e);const u=i,_=o/2,p=[],d=[],f=[],m=2*Math.PI/u;if(1===n){const e=[1],t=[0];for(let i=0;i<u;i++){const n=r*a(m*i),s=r*c(m*i);p.push(new yhe.Vec3(n,_,s)),p.push(new yhe.Vec3(n,-_,s)),i<u-1?(d.push([2*i+2,2*i+3,2*i+1,2*i]),t.push(2*i+2),e.push(2*i+3)):d.push([0,1,2*i+1,2*i]),(u%2==1||i<u/2)&&f.push(new yhe.Vec3(a(m*(i+.5)),0,c(m*(i+.5))))}d.push(e);const i=[];for(let e=0;e<t.length;e++)i.push(t[t.length-e-1]);d.push(i),f.push(new yhe.Vec3(0,1,0))}else if(2===n){const e=[0],t=[1];for(let i=0;i<u;i++){const n=r*a(m*i),s=r*c(m*i);p.push(new yhe.Vec3(n,s,_)),p.push(new yhe.Vec3(n,s,-_)),i<u-1?(d.push([2*i,2*i+1,2*i+3,2*i+2]),e.push(2*i+2),t.push(2*i+3)):d.push([2*i,2*i+1,0,1]),(u%2==1||i<u/2)&&f.push(new yhe.Vec3(a(m*(i+.5)),c(m*(i+.5)),0))}d.push(e);const i=[];for(let e=0;e<t.length;e++)i.push(t[t.length-e-1]);d.push(i),f.push(new yhe.Vec3(0,0,1))}else{const e=[0],t=[1];for(let i=0;i<u;i++){const n=r*a(m*i),s=r*c(m*i);p.push(new yhe.Vec3(_,n,s)),p.push(new yhe.Vec3(-_,n,s)),i<u-1?(d.push([2*i,2*i+1,2*i+3,2*i+2]),e.push(2*i+2),t.push(2*i+3)):d.push([2*i,2*i+1,0,1]),(u%2==1||i<u/2)&&f.push(new yhe.Vec3(0,a(m*(i+.5)),c(m*(i+.5))))}d.push(e);const i=[];for(let e=0;e<t.length;e++)i.push(t[t.length-e-1]);d.push(i),f.push(new yhe.Vec3(1,0,0))}this.impl.vertices=p,this.impl.faces=d,this.impl.uniqueAxes=f,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()}},ConeShape:class extends xme{get collider(){return this._collider}get impl(){return this._shape}setRadius(e){this.updateProperties(this.collider.radius,this.collider.height,yhe.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&fme(this._body)}setHeight(e){this.updateProperties(this.collider.radius,this.collider.height,yhe.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&fme(this._body)}setDirection(e){this.updateProperties(this.collider.radius,this.collider.height,yhe.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&fme(this._body)}constructor(e=.5,t=1,i=She.Y_AXIS){super(),this._shape=new yhe.Cylinder(0,e,t,yhe.CC_CONFIG.numSegmentsCone,i===She.Y_AXIS)}onLoad(){super.onLoad(),this.setRadius(this.collider.radius)}setScale(e){super.setScale(e),this.setRadius(this.collider.radius)}updateProperties(e,t,i,n,s){let o=t,r=e;const a=Math.cos,c=Math.sin,l=Math.abs,h=Math.max;1===n?(o=l(s.y)*t,r=h(l(s.x),l(s.z))*e):2===n?(o=l(s.z)*t,r=h(l(s.x),l(s.y))*e):(o=l(s.x)*t,r=h(l(s.y),l(s.z))*e);const u=i,_=o/2,p=[],d=[],f=[],m=2*Math.PI/u;if(1===n){const e=[];d.push(e),p.push(new yhe.Vec3(0,_,0));for(let e=0;e<u;e++){const t=r*a(m*e),i=r*c(m*e);p.push(new yhe.Vec3(t,-_,i))}for(let t=0;t<u;t++){let i;0!==t&&e.push(t),i=t<u-1?[0,t+2,t+1]:[0,1,t+1],d.push(i),zi.subtract(Nme,p[0],p[i[1]]),zi.subtract(Lme,p[i[2]],p[i[1]]),zi.cross(Nme,Lme,Nme),Nme.normalize(),f.push(new yhe.Vec3(Nme.x,Nme.y,Nme.z))}f.push(new yhe.Vec3(0,-1,0))}else if(2===n){const e=[];d.push(e),p.push(new yhe.Vec3(0,0,_));for(let e=0;e<u;e++){const t=r*a(m*e),i=r*c(m*e);p.push(new yhe.Vec3(t,i,-_))}for(let t=0;t<u;t++){let i;0!==t&&e.push(u-t),i=t<u-1?[0,t+1,t+2]:[0,t+1,1],d.push(i),zi.subtract(Nme,p[0],p[i[1]]),zi.subtract(Lme,p[i[2]],p[i[1]]),zi.cross(Nme,Nme,Lme),Nme.normalize(),f.push(new yhe.Vec3(Nme.x,Nme.y,Nme.z))}f.push(new yhe.Vec3(0,0,-1))}else{const e=[];d.push(e),p.push(new yhe.Vec3(_,0,0));for(let e=0;e<u;e++){const t=r*a(m*e),i=r*c(m*e);p.push(new yhe.Vec3(-_,t,i))}for(let t=0;t<u;t++){let i;0!==t&&e.push(u-t),i=t<u-1?[0,t+1,t+2]:[0,t+1,1],d.push(i),zi.subtract(Nme,p[0],p[i[1]]),zi.subtract(Lme,p[i[2]],p[i[1]]),zi.cross(Nme,Nme,Lme),Nme.normalize(),f.push(new yhe.Vec3(Nme.x,Nme.y,Nme.z))}f.push(new yhe.Vec3(-1,0,0))}this.impl.vertices=p,this.impl.faces=d,this.impl.uniqueAxes=f,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()}},TerrainShape:class extends xme{get collider(){return this._collider}get impl(){return this._shape}setTerrain(e){if(e){if(this._terrainID!==e._uuid){const t=e,i=t.getVertexCountI(),n=t.getVertexCountJ();this._terrainID=t._uuid,this.data.length=i-1;for(let e=0;e<i;e++){null==this.data[e]&&(this.data[e]=[]),this.data[e].length=n-1;for(let i=0;i<n;i++)this.data[e][i]=t.getHeight(e,n-1-i)}this.options.elementSize=t.tileSize,this.updateProperties(this.data,this.options.elementSize)}}else""!==this._terrainID&&(this._terrainID="",this.data.length=1,this.data[0]=this.data[0]||[],this.data[0].length=0,this.options.elementSize=0,this.updateProperties(this.data,this.options.elementSize))}constructor(){super(),this.data=void 0,this.options=void 0,this._terrainID=void 0,this.data=[[]],this.options={elementSize:0},this._terrainID=""}onComponentSet(){const e=this.collider.terrain;if(e){const t=e.getVertexCountI(),i=e.getVertexCountJ();for(let n=0;n<t;n++){null==this.data[n]&&(this.data[n]=[]);for(let t=0;t<i;t++)this.data[n][t]=e.getHeight(n,i-1-t)}this.options.elementSize=e.tileSize,this._terrainID=e._uuid}this._shape=new yhe.Heightfield(this.data,this.options)}onLoad(){super.onLoad(),this.setTerrain(this.collider.terrain)}updateProperties(e,t){const i=this.impl;i.data=e,i.elementSize=t,i.updateMinValue(),i.updateMaxValue(),i.updateBoundingSphereRadius(),i.update(),this._index>=0&&fme(this._body)}_setCenter(e){const t=this.collider.terrain;if(t){ji.fromEuler(this._orient,-90,0,0);const i=this._offset;zi.set(i,0,0,(t.getVertexCountJ()-1)*t.tileSize),zi.add(i,i,e)}}},SimplexShape:class extends xme{constructor(...e){super(...e),this.vertices=[]}setShapeType(e){this._isBinding}setVertices(e){const t=this.vertices.length;if(4===t){const i=this._collider.node.worldScale;for(let n=0;n<t;n++)zi.multiply(this.vertices[n],i,e[n]);const n=this.impl;n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius()}-1!==this._index&&fme(this._body)}get collider(){return this._collider}get impl(){return this._shape}onComponentSet(){if(this.collider.shapeType===_fe.ESimplexType.TETRAHEDRON){for(let e=0;e<4;e++)this.vertices[e]=new yhe.Vec3(0,0,0);this._shape=Ume(this.vertices)}else _fe.ESimplexType.VERTEX,this._shape=new yhe.Particle}onLoad(){super.onLoad(),this.collider.updateVertices()}setScale(e){super.setScale(e),this.collider.updateVertices()}},PlaneShape:class extends xme{get collider(){return this._collider}get impl(){return this._shape}constructor(){super(),this._shape=new yhe.Plane}setNormal(e){ji.rotationTo(this._orient,zi.UNIT_Z,e),-1!==this._index&&fme(this._body)}setConstant(e){zi.scaleAndAdd(this._offset,this._collider.center,this.collider.normal,e)}onLoad(){super.onLoad(),this.setConstant(this.collider.constant),this.setNormal(this.collider.normal)}_setCenter(e){super._setCenter(e),this.setConstant(this.collider.constant)}},PointToPointConstraint:class extends Gme{get impl(){return this._impl}get constraint(){return this._com}setPivotA(e){const t=this.constraint;zi.multiply(this.impl.pivotA,t.node.worldScale,t.pivotA),t.connectedBody||this.setPivotB(t.pivotB)}setPivotB(e){const t=this.constraint,i=t.connectedBody;if(i)zi.multiply(this.impl.pivotB,i.node.worldScale,t.pivotB);else{const e=t.node;zi.multiply(kme,e.worldScale,t.pivotA),zi.add(kme,kme,e.worldPosition),zi.add(kme,kme,t.pivotB),zi.copy(this.impl.pivotB,kme)}}onComponentSet(){const e=this._rigidBody.body.impl,t=this.constraint.connectedBody;let i=yhe.World.staticBody;t&&(i=t.body.impl),this._impl=new yhe.PointToPointConstraint(e,null,i),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)}updateScale0(){this.setPivotA(this.constraint.pivotA)}updateScale1(){this.setPivotB(this.constraint.pivotB)}},HingeConstraint:class extends Gme{get impl(){return this._impl}get constraint(){return this._com}setPivotA(e){const t=this.constraint;zi.multiply(this.impl.pivotA,this.constraint.node.worldScale,t.pivotA),t.connectedBody||this.setPivotB(t.pivotB)}setPivotB(e){const t=this.constraint,i=t.connectedBody;if(i)zi.multiply(this.impl.pivotB,i.node.worldScale,t.pivotB);else{const e=this.constraint.node;zi.multiply(Hme,e.worldScale,t.pivotA),zi.add(Hme,Hme,e.worldPosition),zi.add(Hme,Hme,t.pivotB),zi.copy(this.impl.pivotB,Hme)}}setAxis(e){zi.copy(this.impl.axisA,e),zi.copy(this.impl.equations[3].axisA,e),zi.copy(this.impl.equations[4].axisA,e),zi.copy(this.impl.equations[5].axisA,e),this.constraint.connectedBody?(zi.copy(this.impl.axisB,e),zi.copy(this.impl.equations[3].axisB,e),zi.copy(this.impl.equations[4].axisB,e),zi.copy(this.impl.equations[5].axisB,e)):(zi.transformQuat(this.impl.axisB,e,this.constraint.node.worldRotation),zi.copy(this.impl.equations[3].axisB,this.impl.axisB),zi.copy(this.impl.equations[4].axisB,this.impl.axisB),zi.copy(this.impl.equations[5].axisB,this.impl.axisB))}onComponentSet(){const e=this._rigidBody.body.impl,t=this.constraint.connectedBody;let i=yhe.World.staticBody;t&&(i=t.body.impl),this._impl=new yhe.HingeConstraint(e,i),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.setAxis(this.constraint.axis)}updateScale0(){this.setPivotA(this.constraint.pivotA)}updateScale1(){this.setPivotB(this.constraint.pivotB)}}}),window&&(window.CANNON=yhe),yhe.CC_CONFIG={numSegmentsCone:12,numSegmentsCylinder:12,ignoreSelfBody:!0,correctInelastic:3},yhe.ArrayCollisionMatrix.prototype.reset=function(){for(const e in this.matrix)delete this.matrix[e]},yhe.Ray.perBodyFilter=function(e,t){return 0!=(e.collisionFilterMask&t.collisionFilterGroup)},function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(Qme||(Qme={})),Fe(Qme);let Zme=e("Primitive",(Vme=Wc("cc.Primitive"),jme=Al(Qme),Vme(($me=Kme=class extends LB{constructor(e=Qme.BOX){super(),Mc(this,"type",Xme,this),Mc(this,"info",Yme,this),this.type=e}onLoaded(){VB(B_e[Qme[this.type].toLowerCase()](this.info),this)}},Kme.PrimitiveType=Qme,Xme=Oc((qme=$me).prototype,"type",[jme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qme.BOX}}),Yme=Oc(qme.prototype,"info",[Qc,cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),Wme=qme))||Wme));var Jme;n.Primitive=Zme,n.primitives=B_e;let ege=Wc("cc.PerfCounter")(Jme=class extends class{get value(){return this._value}set value(e){this._value=e}constructor(e,t,i){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=i}sample(e){this._average(this._value,e)}human(){const{average:e,isInteger:t}=this._opts,i=e?this._averageValue:this._value;return t?Math.round(i):Math.round(100*i)/100}alarm(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}_average(e,t=0){if(this._opts.average){this._accumValue+=e,++this._accumSamples;const i=t;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}{constructor(e,t,i){super(e,t,i),this._time=void 0,this._time=i}start(e=0){this._time=e}end(e=0){this._value=e-this._time,this._average(this._value)}tick(){this.end(),this.start()}frame(e){const t=e,i=t-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}})||Jme;const tge="0123456789. ",ige=500,nge={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},sge={fps:{desc:"Framerate (FPS)",below:30,average:ige,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:ige},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:ige,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:ige},render:{desc:"Renderer (ms)",min:0,max:50,average:ige,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},oge={fontSize:23,quadHeight:.4,segmentsPerLine:8,textureWidth:256,textureHeight:256};class rge{constructor(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new wo,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=oge.textureHeight/(Object.keys(sge).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}isShowingStats(){return this._showFPS}hideStats(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),n.game.off(n.Game.EVENT_RESTART,this.generateNode,this),n.director.off(n.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),n.director.off(n.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),n.director.off(n.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),n.director.off(n.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),n.director.off(n.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),n.director.off(n.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,n.game.config.showFPS=!1)}showStats(){this._showFPS||(this._device||(this._device=n.director.root.device),this.generateCanvas(),this.generateStats(),n.game.once(n.Game.EVENT_ENGINE_INITED,this.generateNode,this),n.game.on(n.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),n.director.on(n.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),n.director.on(n.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),n.director.on(n.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),n.director.on(n.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),n.director.on(n.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),n.director.on(n.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,n.game.config.showFPS=!0)}generateCanvas(){if(this._canvasDone)return;const{textureWidth:e,textureHeight:t}=oge;this._ctx&&this._canvas&&(this._canvas.width=e,this._canvas.height=t,this._canvas.style.width=`${this._canvas.width}`,this._canvas.style.height=`${this._canvas.height}`,this._ctx.font=`${oge.fontSize}px Arial`,this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Lo(Hs.TEX2D,Vs.SAMPLED|Vs.TRANSFER_DST,Ls.RGBA8,e,t)),this._region.texExtent.width=e,this._region.texExtent.height=t)}generateStats(){if(this._statsDone||!this._ctx||!this._canvas)return;this._stats=null;const e=performance.now();this._ctx.textAlign="left";let t=0;for(const i in sge){const n=sge[i];this._ctx.fillText(n.desc,0,t*this._lineHeight),n.counter=new ege(i,n,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(let e=0;e<tge.length;++e){const t=this._ctx.measureText(tge[e]).width;this._eachNumWidth=Math.max(this._eachNumWidth,t)}for(let e=0;e<tge.length;++e)this._ctx.fillText(tge[e],e*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=sge,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}generateNode(){if(this._rootNode&&this._rootNode.isValid)return;this._rootNode=new ix("PROFILER_NODE"),n.game.addPersistRootNode(this._rootNode);const e=new ix("Profiler_Camera");e.setPosition(0,0,1.5),e.parent=this._rootNode;const t=e.addComponent("cc.Camera");t.projection=jR.ProjectionType.ORTHO,t.orthoHeight=1,t.near=1,t.far=2,t.visibility=id.BitMask.PROFILER,t.clearFlags=fo.NONE,t.priority=4294967295;const i=new ix("Profiler_Root");i.parent=this._rootNode;const s=oge.quadHeight,o=s/this._totalLines,r=s/this._wordHeight,a=o/oge.fontSize,c=this._eachNumWidth*this._canvas.width*a,l=[0,s,0,r,s,0,r,0,0,0,0,0],h=[0,2,1,0,3,2],u=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0];let _=0;for(let e=0;e<this._totalLines;e++)for(let t=0;t<oge.segmentsPerLine;t++){l.push(r+t*c,s-e*o,0),l.push(r+(t+1)*c,s-e*o,0),l.push(r+(t+1)*c,s-(e+1)*o,0),l.push(r+t*c,s-(e+1)*o,0),_=4*(e*oge.segmentsPerLine+t+1),h.push(0+_,2+_,1+_,0+_,3+_,2+_);const i=e*oge.segmentsPerLine+t,n=Math.floor(i/4),a=i-4*n;u.push(0,this._wordHeight,n,a),u.push(this._eachNumWidth,this._wordHeight,n,a),u.push(this._eachNumWidth,1,n,a),u.push(0,1,n,a)}const p=i.addComponent(Cz);p.mesh=VB({positions:l,indices:h,colors:u});const d=new Wg;d.initialize({effectName:"profiler"});const f=this.pass=d.passes[0],m=f.getBinding("mainTexture"),g=f.getBinding("digits"),v=f.getBinding("offset");f.bindTexture(m,this._texture),this.digitsData=f.blocks[g],this.offsetData=f.blocks[v],this.offsetData[3]=-1,p.material=d,p.node.layer=id.Enum.PROFILER,this._inited=!0}beforeUpdate(){if(!this._stats)return;const e=performance.now();this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}afterUpdate(){if(!this._stats)return;const e=performance.now();n.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}beforePhysics(){if(!this._stats)return;const e=performance.now();this._stats.physics.counter.start(e)}afterPhysics(){if(!this._stats)return;const e=performance.now();this._stats.physics.counter.end(e)}beforeDraw(){if(!this._stats)return;{const e=this._device.surfaceTransform,t=this._device.capabilities.clipSpaceSignY;if(e!==this.offsetData[3]){const i=Qi[e],n=-.9,s=-.9*t;this.offsetData[0]=n*i[0]+s*i[2],this.offsetData[1]=n*i[1]+s*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=e}this.pass._setRootBufferDirty(!0)}const e=performance.now();this._stats.render.counter.start(e)}afterDraw(){if(!this._stats||!this._inited)return;const e=performance.now();if(this._stats.frame.counter.end(e),this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),e-this.lastTime<ige)return;this.lastTime=e;const t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;let i=0;{const t=this.digitsData;for(const n in this._stats){const s=this._stats[n];s.counter.sample(e);const o=s.counter.human().toString();for(let e=oge.segmentsPerLine-1;e>=0;e--){const n=i*oge.segmentsPerLine+e,s=o[o.length-(oge.segmentsPerLine-e)];let r=nge[s];void 0===r&&(r=11),t[n]=r}i++}}}}e("Profiler",rge);const age=e("profiler",new rge);let cge,lge,hge;n.profiler=age,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(cge||(cge={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(lge||(lge={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(hge||(hge={}));let uge=0;function _ge(e,t){t.invoking||(t.invoking=!0,t.func.call(e,...t.args).then((()=>{t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());const i=e._operationQueue[0];i&&_ge(e,i)})).catch((()=>{})))}function pge(e,t,i){const n=i.value;i.value=function(...e){return new Promise((t=>{const i=uge++,s=this;s._operationQueue.push({id:i,func:n,args:e,invoking:!1}),s._eventTarget.once(i.toString(),t),_ge(s,s._operationQueue[0])}))}}var dge,fge,mge;const gge={},vge=jsb.AudioEngine,yge=-1;class xge{get onPlay(){return this._onPlayCb}set onPlay(e){this._onPlayCb=e}get onEnd(){return this._onEndCb}set onEnd(e){this._onEndCb=e}constructor(e,t){this._id=yge,this._url=void 0,this._volume=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._url=e,this._volume=t}play(){var e;this._id=jsb.AudioEngine.play2d(this._url,!1,this._volume),jsb.AudioEngine.setFinishCallback(this._id,(()=>{var e;null===(e=this.onEnd)||void 0===e||e.call(this)})),null===(e=this.onPlay)||void 0===e||e.call(this)}stop(){this._id!==yge&&jsb.AudioEngine.stop(this._id)}}let Sge=(mge=fge=class e{constructor(e){this._url=void 0,this._id=yge,this._state=hge.INIT,this._eventTarget=new Vt,this._operationQueue=[],this._cachedState={duration:1,loop:!1,currentTime:0,volume:1},this._url=e,qt.on("hide",this._onHide,this),qt.on("show",this._onShow,this)}destroy(){qt.on("hide",this._onHide,this),qt.on("show",this._onShow,this),--gge[this._url]<=0&&vge.uncache(this._url)}_onHide(){this._state===hge.PLAYING&&this.pause().then((()=>{this._state=hge.INTERRUPTED,this._eventTarget.emit(cge.INTERRUPTION_BEGIN)})).catch((()=>{}))}_onShow(){this._state===hge.INTERRUPTED&&this.play().then((()=>{this._eventTarget.emit(cge.INTERRUPTION_END)})).catch((()=>{}))}static load(t){return new Promise(((i,n)=>{e.loadNative(t).then((t=>{i(new e(t))})).catch((e=>n(e)))}))}static loadNative(e){return new Promise(((t,i)=>{qt.platform===z.WIN32?t(e):vge.preload(e,(n=>{n?t(e):i(new Error("load audio failed"))}))}))}static loadOneShotAudio(t,i){return new Promise(((n,s)=>{e.loadNative(t).then((e=>{n(new xge(e,i))})).catch(s)}))}get _isValid(){return this._id!==yge}get src(){return this._url}get type(){return lge.NATIVE_AUDIO}get state(){return this._state}get loop(){return this._isValid?vge.isLoop(this._id):this._cachedState.loop}set loop(e){this._isValid&&vge.setLoop(this._id,e),this._cachedState.loop=e}get volume(){return this._isValid?vge.getVolume(this._id):this._cachedState.volume}set volume(e){e=fi(e),this._isValid&&vge.setVolume(this._id,e),this._cachedState.volume=e}get duration(){return this._isValid?vge.getDuration(this._id):this._cachedState.duration}get currentTime(){return this._isValid?vge.getCurrentTime(this._id):this._cachedState.currentTime}seek(e){return new Promise((t=>(this._isValid&&vge.setCurrentTime(this._id,e),this._cachedState.currentTime=e,t())))}play(){return new Promise((e=>{this._isValid?this._state===hge.PAUSED||this._state===hge.INTERRUPTED?vge.resume(this._id):this._state===hge.PLAYING&&(vge.pause(this._id),vge.setCurrentTime(this._id,0),vge.resume(this._id)):(this._id=vge.play2d(this._url,this._cachedState.loop,this._cachedState.volume),this._isValid&&(0!==this._cachedState.currentTime&&(vge.setCurrentTime(this._id,this._cachedState.currentTime),this._cachedState.currentTime=0),vge.setFinishCallback(this._id,(()=>{this._id=yge,this._state=hge.INIT,this._eventTarget.emit(cge.ENDED)})))),this._state=hge.PLAYING,e()}))}pause(){return new Promise((e=>{this._isValid&&vge.pause(this._id),this._state=hge.PAUSED,e()}))}stop(){return new Promise((e=>{this._isValid&&vge.stop(this._id),this._state=hge.STOPPED,this._id=yge,e()}))}onInterruptionBegin(e){this._eventTarget.on(cge.INTERRUPTION_BEGIN,e)}offInterruptionBegin(e){this._eventTarget.off(cge.INTERRUPTION_BEGIN,e)}onInterruptionEnd(e){this._eventTarget.on(cge.INTERRUPTION_END,e)}offInterruptionEnd(e){this._eventTarget.off(cge.INTERRUPTION_END,e)}onEnded(e){this._eventTarget.on(cge.ENDED,e)}offEnded(e){this._eventTarget.off(cge.ENDED,e)}},fge.maxAudioChannel=vge.getMaxAudioInstance(),Oc((dge=mge).prototype,"seek",[pge],Object.getOwnPropertyDescriptor(dge.prototype,"seek"),dge.prototype),Oc(dge.prototype,"play",[pge],Object.getOwnPropertyDescriptor(dge.prototype,"play"),dge.prototype),Oc(dge.prototype,"pause",[pge],Object.getOwnPropertyDescriptor(dge.prototype,"pause"),dge.prototype),Oc(dge.prototype,"stop",[pge],Object.getOwnPropertyDescriptor(dge.prototype,"stop"),dge.prototype),dge);var bge,Tge,Ege,Cge,wge;n.AudioPlayer=Sge;let Age=e("AudioClip",Wc("cc.AudioClip")((wge=Cge=class extends xh{constructor(){super(),Mc(this,"_duration",Ege,this),this._loadMode=lge.UNKNOWN_AUDIO,this._meta=null,this._player=void 0}destroy(){var e;const t=super.destroy();return null===(e=this._player)||void 0===e||e.destroy(),t}set _nativeAsset(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=lge.UNKNOWN_AUDIO,this._duration=0)}get _nativeAsset(){return this._meta}get _nativeDep(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}get loadMode(){return this._loadMode}validate(){return!!this._meta}getDuration(){return this._duration?this._duration:this._meta?this._meta.duration:0}get state(){return this._player?this._player.state:hge.INIT}getCurrentTime(){return this._player?this._player.currentTime:0}getVolume(){return this._player?this._player.volume:0}getLoop(){return!!this._player&&this._player.loop}setCurrentTime(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((()=>{}))}setVolume(e){this._player&&(this._player.volume=e)}setLoop(e){this._player&&(this._player.loop=e)}play(){var e;null===(e=this._player)||void 0===e||e.play().catch((()=>{}))}pause(){var e;null===(e=this._player)||void 0===e||e.pause().catch((()=>{}))}stop(){var e;null===(e=this._player)||void 0===e||e.stop().catch((()=>{}))}playOneShot(e=1){this._nativeAsset&&Sge.loadOneShotAudio(this._nativeAsset.url,e).then((e=>{e.play()})).catch((()=>{}))}},Cge.AudioType=lge,Ege=Oc((Tge=wge).prototype,"_duration",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oc(Tge.prototype,"_nativeDep",[Pl],Object.getOwnPropertyDescriptor(Tge.prototype,"_nativeDep"),Tge.prototype),bge=Tge))||bge);function Pge(e,t,i){Sge.load(e,{audioLoadMode:t.audioLoadMode}).then((t=>{const n={player:t,url:e,duration:t.duration,type:t.type};i(null,n)})).catch((e=>{i(e)}))}function Rge(e,t,i,n){const s=new Age;s._nativeUrl=e,s._nativeAsset=t,s._duration=t.duration,n(null,s)}n.AudioClip=Age,OA.register({".mp3":Pge,".ogg":Pge,".wav":Pge,".m4a":Pge}),UA.register({".mp3":Rge,".ogg":Rge,".wav":Rge,".m4a":Rge});const Ige=new class{constructor(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}_findIndex(e,t){return e.findIndex((e=>e.audio===t))}_tryAddPlaying(e,t){const i=this._findIndex(e,t);return i>-1?(e[i].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)}addPlaying(e){if(e instanceof Sge){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)}_tryRemovePlaying(e,t){const i=this._findIndex(e,t);return-1!==i&&(V(e,i),!0)}removePlaying(e){if(e instanceof Sge){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)}discardOnePlayingIfNeeded(){if(this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<Sge.maxAudioChannel)return;let e;this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((t=>{(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((t=>{(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio))}};var Mge,Oge,Dge,Nge,Lge,Bge,zge,Fge,Uge,Gge,kge,Hge,Vge,jge,Wge,qge,Xge,Yge,Kge;!function(e){e.STARTED="started",e.ENDED="ended"}(Kge||(Kge={}));let $ge=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((Mge=Wc("cc.AudioSource"),Oge=al(),Dge=nl(),Nge=Al(Age),Lge=Al(Age),Bge=_l(),zge=_l(),Fge=_l(),Uge=pl(),Gge=_l(),Mge(kge=Oge(kge=Dge((Yge=Xge=class e extends Gh{constructor(...e){super(...e),Mc(this,"_clip",Vge,this),this._player=null,Mc(this,"_loop",jge,this),Mc(this,"_playOnAwake",Wge,this),Mc(this,"_volume",qge,this),this._cachedCurrentTime=0,this._operationsBeforeLoading=[],this._isLoaded=!1,this._lastSetClip=void 0}static get maxAudioChannel(){return Sge.maxAudioChannel}set clip(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}get clip(){return this._clip}_syncPlayer(){const e=this._clip;this._isLoaded=!1,e&&this._lastSetClip!==e&&(e._nativeAsset?(this._lastSetClip=e,Sge.load(e._nativeAsset.url,{audioLoadMode:e.loadMode}).then((t=>{this._lastSetClip===e&&(this._isLoaded=!0,this._player&&(this._player.offEnded(),this._player.offInterruptionBegin(),this._player.offInterruptionEnd(),this._player.destroy()),this._player=t,t.onEnded((()=>{Ige.removePlaying(t),this.node.emit(Kge.ENDED,this)})),t.onInterruptionBegin((()=>{Ige.removePlaying(t)})),t.onInterruptionEnd((()=>{Ige.addPlaying(t)})),this._syncStates())})).catch((()=>{}))):console.error("Invalid audio clip"))}set loop(e){this._loop=e,this._player&&(this._player.loop=e)}get loop(){return this._loop}set playOnAwake(e){this._playOnAwake=e}get playOnAwake(){return this._playOnAwake}set volume(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=di(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}get volume(){return this._volume}onLoad(){this._syncPlayer()}onEnable(){this._playOnAwake&&!this.playing&&this.play()}onDisable(){const e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()}onDestroy(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy()}_getRootNode(){var e,t;let i=this.node,n=null===(e=i)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;for(;n;){var s,o,r;i=null===(s=i)||void 0===s?void 0:s.parent,n=null===(o=i)||void 0===o||null===(r=o.parent)||void 0===r?void 0:r.parent}return i}play(){var e,t;this._isLoaded?(Ige.discardOnePlayingIfNeeded(),this.state===hge.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((()=>{}))),null===(e=this._player)||void 0===e||e.play().then((()=>{Ige.addPlaying(this._player),this.node.emit(Kge.STARTED,this)})).catch((()=>{}))):this._operationsBeforeLoading.push("play")}pause(){var e;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((()=>{Ige.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("pause")}stop(){var e;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((()=>{Ige.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("stop")}playOneShot(e,t=1){e._nativeAsset?Sge.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((e=>{Ige.discardOnePlayingIfNeeded(),e.onPlay=()=>{Ige.addPlaying(e)},e.onEnd=()=>{Ige.removePlaying(e)},e.play()})).catch((()=>{})):console.error("Invalid audio clip")}_syncStates(){this._player&&this._player.seek(this._cachedCurrentTime).then((()=>{this._player&&(this._player.loop=this._loop,this._player.volume=this._volume,this._operationsBeforeLoading.forEach((e=>{var t;null===(t=this[e])||void 0===t||t.call(this)})),this._operationsBeforeLoading.length=0)})).catch((()=>{}))}set currentTime(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=di(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((()=>{})))}get currentTime(){return this._player?this._player.currentTime:this._cachedCurrentTime}get duration(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.currentTime:0}get state(){return this._player?this._player.state:hge.INIT}get playing(){return this.state===e.AudioState.PLAYING}},Xge.AudioState=hge,Xge.EventType=Kge,Vge=Oc((Hge=Yge).prototype,"_clip",[Nge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jge=Oc(Hge.prototype,"_loop",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wge=Oc(Hge.prototype,"_playOnAwake",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qge=Oc(Hge.prototype,"_volume",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Oc(Hge.prototype,"clip",[Lge,Bge],Object.getOwnPropertyDescriptor(Hge.prototype,"clip"),Hge.prototype),Oc(Hge.prototype,"loop",[zge],Object.getOwnPropertyDescriptor(Hge.prototype,"loop"),Hge.prototype),Oc(Hge.prototype,"playOnAwake",[Fge],Object.getOwnPropertyDescriptor(Hge.prototype,"playOnAwake"),Hge.prototype),Oc(Hge.prototype,"volume",[Uge,Gge],Object.getOwnPropertyDescriptor(Hge.prototype,"volume"),Hge.prototype),kge=Hge))||kge)||kge)||kge));ei(Age,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:$ge,targetName:"AudioSource"}]),ii(Age.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((e=>({name:e,suggest:`please use AudioSource.prototype.${e} instead`})))),n.AudioSourceComponent=$ge,De.setClassAlias($ge,"cc.AudioSourceComponent");class Qge{constructor(){this.originalTarget=null,this.target=null,this.tag=Qge.TAG_INVALID}clone(){const e=new Qge;return e.originalTarget=null,e.target=null,e.tag=this.tag,e}isDone(){return!0}startWithTarget(e){this.originalTarget=e,this.target=e}stop(){this.target=null}step(e){S(1006)}update(e){S(1007)}getTarget(){return this.target}setTarget(e){this.target=e}getOriginalTarget(){return this.originalTarget}setOriginalTarget(e){this.originalTarget=e}getTag(){return this.tag}setTag(e){this.tag=e}reverse(){return S(1008),null}retain(){}release(){}}Qge.TAG_INVALID=-1;class Zge extends Qge{constructor(...e){super(...e),this._duration=0,this._timesForRepeat=1}getDuration(){return this._duration*(this._timesForRepeat||1)}setDuration(e){this._duration=e}clone(){return new Zge}}let Jge=0;class eve{constructor(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1}}class tve{constructor(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}_searchElementByTarget(e,t){for(let i=0;i<e.length;i++)if(t===e[i].target)return e[i];return null}_getElement(e,t){let i=this._elementPool.pop();return i||(i=new eve),i.target=e,i.paused=!!t,i}_putElement(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)}addAction(e,t,i){if(!e||!t)return void C(1e3);null==t.uuid&&(t.uuid="_TWEEN_UUID_"+Jge++);let n=this._hashTargets.get(t);n?n.actions||(n.actions=[]):(n=this._getElement(t,i),this._hashTargets.set(t,n),this._arrayTargets.push(n)),n.target=t,n.actions.push(e),e.startWithTarget(t)}removeAllActions(){const e=this._arrayTargets;for(let t=0;t<e.length;t++){const i=e[t];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=new Map}removeAllActionsFromTarget(e){if(null==e)return;const t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}removeAction(e){if(null==e)return;const t=e.getOriginalTarget(),i=this._hashTargets.get(t);if(i)for(let t=0;t<i.actions.length;t++)if(i.actions[t]===e){i.actions.splice(t,1),i.actionIndex>=t&&i.actionIndex--;break}}_removeActionByTag(e,t,i){for(let n=0,s=t.actions.length;n<s;++n){const s=t.actions[n];if(s&&s.getTag()===e){if(i&&s.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,t);break}}}removeActionByTag(e,t){e===Qge.TAG_INVALID&&S(1002);const i=this._hashTargets;if(t){const n=i.get(t);n&&this._removeActionByTag(e,n,t)}else i.forEach((t=>{this._removeActionByTag(e,t)}))}getActionByTag(e,t){e===Qge.TAG_INVALID&&S(1004);const i=this._hashTargets.get(t);if(i){if(null!=i.actions)for(let t=0;t<i.actions.length;++t){const n=i.actions[t];if(n&&n.getTag()===e)return n}S(1005,e)}return null}getNumberOfRunningActionsInTarget(e){const t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0}pauseTarget(e){const t=this._hashTargets.get(e);t&&(t.paused=!0)}resumeTarget(e){const t=this._hashTargets.get(e);t&&(t.paused=!1)}pauseAllRunningActions(){const e=[],t=this._arrayTargets;for(let i=0;i<t.length;i++){const n=t[i];n&&!n.paused&&(n.paused=!0,e.push(n.target))}return e}resumeTargets(e){if(e)for(let t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])}pauseTargets(e){if(e)for(let t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])}purgeSharedManager(){n.director.getScheduler().unscheduleUpdate(this)}_removeActionAtIndex(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)}_deleteHashElement(e){let t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);const i=this._arrayTargets;for(let t=0,n=i.length;t<n;t++)if(i[t]===e){i.splice(t,1);break}this._putElement(e),t=!0}return t}update(e){const t=this._arrayTargets;let i;for(let n=0;n<t.length;n++){this._currentTarget=t[n],i=this._currentTarget;const s=i.target;if(s instanceof Ot&&!s.isValid)this.removeAllActionsFromTarget(s),n--;else{if(!i.paused&&i.actions){for(i.lock=!0,i.actionIndex=0;i.actionIndex<i.actions.length;i.actionIndex++)if(i.currentAction=i.actions[i.actionIndex],i.currentAction){if(i.currentAction.step(e*(i.currentAction._speedMethod?i.currentAction._speed:1)),i.currentAction&&i.currentAction.isDone()){i.currentAction.stop();const e=i.currentAction;i.currentAction=null,this.removeAction(e)}i.currentAction=null}i.lock=!1}0===i.actions.length&&this._deleteHashElement(i)&&n--}}}}class ive extends kw{constructor(...e){super(...e),this.actionMgr=new tve}get ActionManager(){return this.actionMgr}update(e){this.actionMgr.update(e)}}e("TweenSystem",ive),ive.ID="TWEEN",ive.instance=void 0,Qw.on($w.EVENT_INIT,(()=>{const e=new ive;ive.instance=e,Qw.registerSystem(ive.ID,e,kw.Priority.MEDIUM)}));class nve extends Zge{isDone(){return!0}step(e){this.update(1)}update(e){}reverse(){return this.clone()}clone(){return new nve}}class sve extends nve{update(e){const t=this.target.getComponentsInChildren(iI);for(let e=0;e<t.length;++e)t[e].enabled=!0}reverse(){return new ove}clone(){return new sve}}class ove extends nve{update(e){const t=this.target.getComponentsInChildren(iI);for(let e=0;e<t.length;++e)t[e].enabled=!1}reverse(){return new sve}clone(){return new ove}}class rve extends nve{constructor(e){super(),this._isNeedCleanUp=!0,void 0!==e&&this.init(e)}update(e){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}init(e){return this._isNeedCleanUp=e,!0}reverse(){return new rve(this._isNeedCleanUp)}clone(){return new rve(this._isNeedCleanUp)}}class ave extends nve{constructor(e,t,i){super(),this._selectorTarget=null,this._function=null,this._data=null,this.initWithFunction(e,t,i)}initWithFunction(e,t,i){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==i&&(this._data=i),!0}execute(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}update(e){this.execute()}getTargetCallback(){return this._selectorTarget}setTargetCallback(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)}clone(){const e=new ave;return e.initWithFunction(this._function,this._selectorTarget,this._data),e}}class cve extends Zge{constructor(e){super(),this.MAX_VALUE=2,this._elapsed=0,this._firstTick=!1,this._easeList=[],this._speed=1,this._repeatForever=!1,this._repeatMethod=!1,this._speedMethod=!1,void 0===e||isNaN(e)||this.initWithDuration(e)}getElapsed(){return this._elapsed}initWithDuration(e){return this._duration=0===e?Ge.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0}isDone(){return this._elapsed>=this._duration}_cloneDecoration(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod}_reverseEaseList(e){if(this._easeList){e._easeList=[];for(let t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}}clone(){const e=new cve(this._duration);return this._cloneDecoration(e),e}easing(e){this._easeList?this._easeList.length=0:this._easeList=[];for(let e=0;e<arguments.length;e++)this._easeList.push(arguments[e]);return this}_computeEaseTime(e){return e}step(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;let t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}startWithTarget(e){Qge.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0}reverse(){return S(1010),this}setAmplitudeRate(e){S(1011)}getAmplitudeRate(){return S(1012),0}speed(e){return e<=0?(S(1013),this):(this._speedMethod=!0,this._speed*=e,this)}getSpeed(){return this._speed}setSpeed(e){return this._speed=e,this}repeat(e){return e=Math.round(e),isNaN(e)||e<1?(S(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)}repeatForever(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}class lve extends cve{constructor(e){super(),this._actions=[],this._split=0,this._last=0,this._reversed=!1;const t=e instanceof Array?e:arguments;if(1===t.length)return void C(1019);const i=t.length-1;if(i>=0&&null==t[i]&&S(1015),i>=0){let e,n=t[0];for(let s=1;s<i;s++)t[s]&&(e=n,n=lve._actionOneTwo(e,t[s]));this.initWithTwoActions(n,t[i])}}initWithTwoActions(e,t){if(!e||!t)return C(1025),!1;let i=e._duration,n=t._duration;i*=e._repeatMethod?e._timesForRepeat:1,n*=t._repeatMethod?t._timesForRepeat:1;const s=i+n;return this.initWithDuration(s),this._actions[0]=e,this._actions[1]=t,!0}clone(){const e=new lve;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e}startWithTarget(e){cve.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}stop(){-1!==this._last&&this._actions[this._last].stop(),Qge.prototype.stop.call(this)}update(e){let t,i=0;const n=this._split,s=this._actions,o=this._last;let r;(e=this._computeEaseTime(e))<n?(t=0!==n?e/n:1,0===i&&1===o&&this._reversed&&(s[1].update(0),s[1].stop())):(i=1,t=1===n?1:(e-n)/(1-n),-1===o&&(s[0].startWithTarget(this.target),s[0].update(1),s[0].stop()),0===o&&(s[0].update(1),s[0].stop())),r=s[i],o===i&&r.isDone()||(o!==i&&r.startWithTarget(this.target),t*=r._timesForRepeat,r.update(t>1?t%1:t),this._last=i)}reverse(){const e=lve._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e}}function hve(e){const t=e instanceof Array?e:arguments;if(1===t.length)return C(1019),null;const i=t.length-1;i>=0&&null==t[i]&&S(1015);let n=null;if(i>=0){n=t[0];for(let e=1;e<=i;e++)t[e]&&(n=lve._actionOneTwo(n,t[e]))}return n}lve._actionOneTwo=function(e,t){const i=new lve;return i.initWithTwoActions(e,t),i};class uve extends cve{constructor(e,t){super(),this._times=0,this._total=0,this._nextDt=0,this._actionInstant=!1,this._innerAction=null,void 0!==t&&this.initWithAction(e,t)}initWithAction(e,t){const i=e._duration*t;return!!this.initWithDuration(i)&&(this._times=t,this._innerAction=e,e instanceof nve&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}clone(){const e=new uve;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e}startWithTarget(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,cve.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}stop(){this._innerAction.stop(),Qge.prototype.stop.call(this)}update(e){e=this._computeEaseTime(e);const t=this._innerAction,i=this._duration,n=this._times;let s=this._nextDt;if(e>=s){for(;e>s&&this._total<n;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),s+=t._duration/i,this._nextDt=s>1?1:s;e>=1&&this._total<n&&(t.update(1),this._total++),this._actionInstant||(this._total===n?t.stop():t.update(e-(s-t._duration/i)))}else t.update(e*n%1)}isDone(){return this._total===this._times}reverse(){const e=new uve(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e}setInnerAction(e){this._innerAction!==e&&(this._innerAction=e)}getInnerAction(){return this._innerAction}}class _ve extends cve{constructor(e){super(),this._innerAction=null,e&&this.initWithAction(e)}initWithAction(e){return e?(this._innerAction=e,!0):(C(1026),!1)}clone(){const e=new _ve;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e}startWithTarget(e){cve.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}step(e){const t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))}isDone(){return!1}reverse(){const e=new _ve(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}setInnerAction(e){this._innerAction!==e&&(this._innerAction=e)}getInnerAction(){return this._innerAction}}class pve extends cve{constructor(e){super(),this._one=null,this._two=null;const t=e instanceof Array?e:arguments;if(1===t.length)return void C(1020);const i=t.length-1;if(i>=0&&null==t[i]&&S(1015),i>=0){let e,n=t[0];for(let s=1;s<i;s++)t[s]&&(e=n,n=pve._actionOneTwo(e,t[s]));this.initWithTwoActions(n,t[i])}}initWithTwoActions(e,t){if(!e||!t)return C(1027),!1;let i=!1;const n=e._duration,s=t._duration;return this.initWithDuration(Math.max(n,s))&&(this._one=e,this._two=t,n>s?this._two=lve._actionOneTwo(t,mve(n-s)):n<s&&(this._one=lve._actionOneTwo(e,mve(s-n))),i=!0),i}clone(){const e=new pve;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e}startWithTarget(e){cve.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)}stop(){this._one.stop(),this._two.stop(),Qge.prototype.stop.call(this)}update(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)}reverse(){const e=pve._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}}function dve(e){const t=e instanceof Array?e:arguments;if(1===t.length)return C(1020),null;t.length>0&&null==t[t.length-1]&&S(1015);let i=t[0];for(let e=1;e<t.length;e++)null!=t[e]&&(i=pve._actionOneTwo(i,t[e]));return i}pve._actionOneTwo=function(e,t){const i=new pve;return i.initWithTwoActions(e,t),i};class fve extends cve{update(e){}reverse(){const e=new fve(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e}clone(){const e=new fve;return this._cloneDecoration(e),e.initWithDuration(this._duration),e}}function mve(e){return new fve(e)}class gve extends cve{constructor(e){super(),this._other=null,e&&this.initWithAction(e)}initWithAction(e){return e?e===this._other?(C(1029),!1):!!cve.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(C(1028),!1)}clone(){const e=new gve;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e}startWithTarget(e){cve.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)}update(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)}reverse(){return this._other.clone()}stop(){this._other.stop(),Qge.prototype.stop.call(this)}}class vve extends cve{constructor(e,t,i){if(super(),this._opts=void 0,this._props=void 0,this._originProps=void 0,null==i)i=Object.create(null);else if(function(e){const t=" [Tween:] ",i=` option is not support in v + ${s}`,n=e;n.delay&&p(`${t}delay${i}`),n.repeat&&p(`${t}repeat${i}`),n.repeatDelay&&p(`${t}repeatDelay${i}`),n.interpolation&&p(`${t}interpolation${i}`),n.onStop&&p(`${t}onStop${i}`)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){const t=e.charAt(0);if(/[A-Z]/.test(t)){const i=(e=e.replace(t,t.toLowerCase())).split("-");if(2===i.length){const t=i[0];if("linear"===t)e="linear";else{const n=i[1];switch(t){case"quadratic":e=`quad${n}`;break;case"quartic":e=`quart${n}`;break;case"quintic":e=`quint${n}`;break;case"sinusoidal":e=`sine${n}`;break;case"exponential":e=`expo${n}`;break;case"circular":e=`circ${n}`;break;default:e=t+n}}}}return e}(i.easing)),i.progress||(i.progress=this.progress),i.easing&&"string"==typeof i.easing){const e=i.easing;i.easing=D_[e],i.easing||T(1031,e)}this._opts=i,this._props=Object.create(null);for(const e in t){if(!t.hasOwnProperty(e))continue;let i,n,s=t[e];if("function"==typeof s&&(s=s()),null==s||"string"==typeof s)continue;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(i=D_[s.easing],i||T(1031,s.easing)):i=s.easing,n=s.progress,s=s.value);const o=Object.create(null);o.value=s,o.easing=i,o.progress=n,this._props[e]=o}this._originProps=t,this.initWithDuration(e)}clone(){const e=new vve(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e}startWithTarget(e){cve.prototype.startWithTarget.call(this,e);const t=!!this._opts.relative,i=this._props;for(const n in i){const s=e[n];if(void 0===s)continue;const o=i[n],r=o.value;if("number"==typeof s)o.start=s,o.current=s,o.end=t?s+r:r;else if("object"==typeof s){null==o.start&&(o.start={},o.current={},o.end={});for(const e in r)isNaN(s[e])||(o.start[e]=s[e],o.current[e]=s[e],o.end[e]=t?s[e]+r[e]:r[e])}}this._opts.onStart&&this._opts.onStart(this.target)}update(e){const t=this.target;if(!t)return;const i=this._props,n=this._opts;let s=e;n.easing&&(s=n.easing(e));const o=n.progress;for(const n in i){const r=i[n],a=r.easing?r.easing(e):s,c=r.progress?r.progress:o,l=r.start,h=r.end;if("number"==typeof l)r.current=c(l,h,r.current,a);else if("object"==typeof l)for(const e in l)r.current[e]=c(l[e],h[e],r.current[e],a);t[n]=r.current}n.onUpdate&&n.onUpdate(this.target,e),1===e&&n.onComplete&&n.onComplete(this.target)}progress(e,t,i,n){return e+(t-e)*n}}class yve extends nve{constructor(e){super(),this._props=void 0,this._props={},void 0!==e&&this.init(e)}init(e){for(const t in e)this._props[t]=e[t];return!0}update(){const e=this._props,t=this.target;for(const i in e)t[i]=e[i]}clone(){const e=new yve;return e.init(this._props),e}}class xve{constructor(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=Qge.TAG_INVALID,this._target=void 0===e?null:e}tag(e){return this._tag=e,this}then(e){return e instanceof Qge?this._actions.push(e.clone()):this._actions.push(e._union()),this}target(e){return this._target=e,this}start(){return this._target?(this._finalAction&&ive.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),ive.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(p("Please set target to tween first"),this)}stop(){return this._finalAction&&ive.instance.ActionManager.removeAction(this._finalAction),this}clone(e){const t=this._union();return Sve(e).then(t.clone())}union(){const e=this._union();return this._actions.length=0,this._actions.push(e),this}to(e,t,i){(i=i||Object.create(null)).relative=!1;const n=new vve(e,t,i);return this._actions.push(n),this}by(e,t,i){(i=i||Object.create(null)).relative=!0;const n=new vve(e,t,i);return this._actions.push(n),this}set(e){const t=new yve(e);return this._actions.push(t),this}delay(e){const t=mve(e);return this._actions.push(t),this}call(e){const t=function(e){return new ave(e,void 0,void 0)}(e);return this._actions.push(t),this}sequence(...e){const t=xve._wrappedSequence(...e);return this._actions.push(t),this}parallel(...e){const t=xve._wrappedParallel(...e);return this._actions.push(t),this}repeat(e,t){if(e==1/0)return this.repeatForever(t);const i=this._actions;let n;return n=t instanceof xve?t._union():i.pop(),i.push(function(e,t){return new uve(e,t)}(n,e)),this}repeatForever(e){const t=this._actions;let i;return i=e instanceof xve?e._union():t.pop(),t.push(function(e){return new _ve(e)}(i)),this}reverseTime(e){const t=this._actions;let i;return i=e instanceof xve?e._union():t.pop(),t.push(function(e){return new gve(e)}(i)),this}hide(){const e=new ove;return this._actions.push(e),this}show(){const e=new sve;return this._actions.push(e),this}removeSelf(){const e=new rve(!1);return this._actions.push(e),this}static stopAll(){ive.instance.ActionManager.removeAllActions()}static stopAllByTag(e,t){ive.instance.ActionManager.removeActionByTag(e,t)}static stopAllByTarget(e){ive.instance.ActionManager.removeAllActionsFromTarget(e)}_union(){const e=this._actions;let t;return t=1===e.length?e[0]:hve(e),t}_destroy(){this.stop()}static _wrappedSequence(...e){const t=xve._tmp_args;t.length=0;for(let i=e.length,n=0;n<i;n++){const i=t[n]=e[n];i instanceof xve&&(t[n]=i._union())}return hve.apply(hve,t)}static _wrappedParallel(...e){const t=xve._tmp_args;t.length=0;for(let i=e.length,n=0;n<i;n++){const i=t[n]=e[n];i instanceof xve&&(t[n]=i._union())}return dve.apply(dve,t)}}function Sve(e){return new xve(e)}function bve(e){return p("tweenUtil' is deprecated, please use 'tween' instead "),new xve(e)}e("Tween",xve),xve._tmp_args=[],n.Tween=xve,n.tween=Sve,n.tweenUtil=bve}}}));
